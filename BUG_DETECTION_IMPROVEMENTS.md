## שיפורי איתור באגים לבוט – הצעה תמציתית

### מטרות
- לצמצם MTTR (זמן זיהוי ותיקון) לתקלות ייצור
- להעלות את שיעור השגיאות עם הקשר פעולה שמיש (actionable)
- להפחית ריצות מבחן מתנודדות (flaky) ושגיאות לא משוחזרות

### עקרונות מנחים
- כיסוי מוקדם: לעצור תקלות קרוב למקורן (guards + invariants)
- תצפיות עשירות: לוגים עקביים + מטא־דאטה (trace_id, user, feature)
- שחזור מהיר: לאפשר replay חממה לקלטים בעייתיים
- פרטיות: השחרה אוטומטית לערכים רגישים לפני לוגים/דוחות

### הצעות שיפור ממוקדות

1) מיפוי שגיאות היררכי ואחיד
- הגדרה של טקסונומיית חריגות: `OperationalError` (רשת/תלויות), `UserError` (קלט), `ProgrammingError` (באג לוגי)
- לוגים אחידים לפי סוג השגיאה, עם שדות חובה: `request_id`, `context`, `input_fingerprint`
- יצוא מדדים לפי סוג שגיאה (Prometheus): שיעור, שכיחות, השפעה

2) Invariants ו-Guards במסלולי ליבה
- בדיקות תנאים מפורשות לפני/אחרי שלבים רגישים (DB, GitHub API, Telegram)
- דוגמה: אימות ש-
  - הזדהות לערוץ צד שלישי קיימת ותקפה
  - אובייקט עסקי לא `None` לפני גישה
  - זמן ריצה/כמות פריטים עומדים בסף סביר (rate limiting פנימי)

3) Breadcrumbs לטלמטריה וללוגים
- הוספת breadcrumb בכל שינוי־מצב ומהלך החלטה ("קיבלתי פקודת /triage", "נמצאו 12 תוצאות")
- צירוף breadcrumb ל-exception הסופי כדי לאפשר שחזור מסלול

4) Hash/פינגרפרינט לקלט בעייתי
- יצירת `input_fingerprint` (hash מבוקר, ללא מידע רגיש) לכל בקשה
- מאפשר אשכול (clustering) של תקלות זהות והפניה מהירה ל-replay

5) מנגנון Replay בחממה (Sandbox)
- שמירת דוגמית מינימלית של קלטים שנכשלו (לאחר השחרה) בתיקיית tmp מאובטחת
- כלי CLI/ChatOps: `/replay <request_id>` שמריץ את ה-flow מול סביבות דמה (mocks)

6) זיהוי Flaky Tests אוטומטי
- הרצה כפולה אקראית לטסטים נופלים ב-CI ואיסוף סטטיסטיקות חוסר יציבות
- תיוג טסט כ-flaky ופתיחת Issue אוטומטי עם נתוני זרעים/סביבות

7) Property-based testing לנקודות עיבוד טקסט/JSON
- שילוב Hypothesis בטסטים לפונקציות שמקבלות קלטים "לא נקיים"
- כיסוי מקרי קצה (Unicode, שדות חסרים/מיותרים, גדלים חריגים)

8) Fuzzing ממוקד ל-parsers והמרות
- Fuzzing מבוקר (Atheris/boofuzz) על Parserים מרכזיים עם תקציב זמן קטן ב-CI נפרד

9) מדיניות השחרת נתונים (PII/Sec)
- עטיפת לוגים ב-redactor: כרטיסי אשראי, מיילים, אסימוני OAuth
- בדיקות יחידה למדיניות השחרה

10) שילוב ChatOps לאבחון מהיר
- פקודות: `/status`, `/errors recent`, `/replay <request_id>`, `/predict risk`
- הבוט מקור אמת בזמן אמת – מתועד במדיניות הפרויקט

11) שיפור קונפיג סטטי וכללי SAST
- הקשחת Bandit: פרופיל כשל על ממצאים בדרגת Medium+ בקוד רגיש
- ריצה דיפרנציאלית ב-PR והפניה לפרגמנטי קוד בעייתיים

12) Rate limiting והגנה מפני cascading failures
- ניתור קצבי כשל לפי תלות חיצונית, מעגלי־ניתוק (circuit breakers) חוזרים
- Backoff גיאומטרי ו-timeouts עקביים ב-HTTP/DB

### תכנית הטמעה בשלבים (30–45 יום)
- שבוע 1: טקסונומיית שגיאות + Breadcrumbs + Fingerprint
- שבוע 2: Guards במסלולי ליבה + Redaction בלוגים
- שבוע 3: Replay CLI/ChatOps + מדדי שגיאות ב-Prometheus
- שבוע 4: Flaky detector ב-CI + Property-based tests
- שבוע 5: Fuzzing ממוקד + כוונון Rate limiting/CB

### מדדי הצלחה (KPIs)
- ↓ 30% MTTR בתקלות ייצור נפוצות
- ↑ 40% תקלות עם הקשר פעולה מלא (breadcrumbs + fingerprint)
- ↓ 50% Flaky tests בתוך חודש
- ≥ 90% שגיאות ממופות לטקסונומיה אחידה

### סיכוני פרטיות/אבטחה ומיתון
- השחרה מובנית + בדיקות יחידה
- שמירת דוגמיות Replay רק ב-tmp, עם TTL קצר והרשאות מצומצמות
- אין לוג של סודות – שימוש ב-ENV/Secret Manager בלבד

### הערות יישום בפרויקט הנוכחי
- להתאים לסטנדרטים הקיימים (לוגים, מדדים, `bandit.yaml`, ChatOps)
- לשמור על נקיון imports בבילד של Sphinx/Docs
- לעדכן README/Docs עם פקודות ChatOps חדשות

למידע נוסף ומדיניות מחייבת, יש לעיין ב‑[CodeBot – Project Docs](https://amirbiron.github.io/CodeBot/).