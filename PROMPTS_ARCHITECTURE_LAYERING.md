אתה פועל כ-Software Architect מנוסה שמתמחה בארכיטקטורה שכבתית (Layered Architecture) בפרויקטי Python, בוטי Telegram.

המטרה: ליצור מדריך מפורט ומעשי לפיצול מיטבי של הריפו שלי לשכבות ברורות, בלי לגעת עדיין בקוד בפועל, אלא לתכנן ארכיטקטורה ומפת דרכים. (בלי הWebApp)

הקשר על הפרויקט:
- הריפו הוא פרויקט פייתון שמכיל:
  - בוט/ים של Telegram (python-telegram-bot 20+ או דומה, עם handlers ו-conversation handlers)
  - לוגיקה עסקית (business logic) מפוזרת בקבצי handlers, לעיתים מעורבבת עם גישה לדאטה
  - מסד הנתונים בפועל הוא MongoDB דרך PyMongo; יש תיקיית database/ עם Repository
  - utilities שונים (helpers, formatters, validators, וכו') מפוזרים
- כיום הרבה קבצים "עושים הכל": גם מקבלים בקשות (update/HTTP), גם לוגיקה עסקית וגם DB calls.

מה אני רוצה לקבל ממך:

1. סריקה ראשונית של הריפו:
   - תתאר בקצרה את המבנה הנוכחי: תיקיות עיקריות, סוגי קבצים, היכן נמצאים:
     - handlers של הבוט
     - קוד Web/REST (אם קיים)
     - גישה למסד נתונים
     - utilities / helpers
   - תזהה "ריחות קוד" שקשורים לערבוב שכבות (handlers עם לוגיקה כבדה, DB בתוך ה-handler, וכו').

2. הצעת ארכיטקטורה שכבתית מותאמת לריפו:
    (- דוגמה קונקרטית לערבוב שכבות: handlers/save_flow.py      שמבצע גם I/O עם המשתמש, גם נורמליזציה וגם קריאות DB
     - קובץ utils.py מרכז פונקציות רבות (Normalization, Telegram helpers, File IO) וצריך לפרק אותו.)
  - תציע חלוקה לשכבות, לדוגמה:
   - presentation / interface layer
     - Telegram handlers (פקודות, callbacks, inline)
   - application / services layer
     - תרחישי שימוש (use cases), לוגיקה עסקית
     - orchestration בין domain ל-infrastructure
   - domain layer
     - מודלים לוגיים (Entities / Value Objects)
     - חוקים עסקיים שלא תלויים במסגרת (לא ב-Telegram ולא ב-DB ספציפי)
   - infrastructure / data access layer
     - גישה ל-DB (repositories, models של ORM)
     - אינטגרציות חיצוניות (APIs, אחסון קבצים, וכו')
   - shared / utils
     - utilities, formatters, validators, common helpers

   תציג:
   - עץ תיקיות מוצע מפורט (בצורת tree) עם שמות תיקיות/מודולים שמתאימים לפרויקט שלי.
   - הסבר קצר לכל שכבה: מה מותר לה לעשות, מה אסור לה לעשות, ולמי מותר לה לקרוא.

3. מיפוי מהריפו הקיים לשכבות:
   - טבלה / רשימה שבה:
     - בכל שורה: קובץ/מודול קיים -> לאיזה שכבה הוא צריך לעבור, ומה התפקיד החדש שלו.
   - לציין במיוחד:
     - קבצי handlers
     - קבצי DB / models
     - helpers חשובים
     - קבצי config / settings

4. כללים ברורים להפרדת שכבות:
   - תגדיר חוקים בסגנון:
     - "handlers לא מדברים ישירות עם DB, אלא רק עם services"
     - "services לא יודעים שיש Telegram – הם מקבלים ומחזירים אובייקטים פשוטים / DTOs"
     - "domain לא מכיר frameworks, רק פייתון טהור"
   - תצרף דוגמאות קטנות בקוד (לפני/אחרי) שמתאימות לסגנון הקיים בריפו.

5. מפת דרכים (Roadmap) לרפקטור בשלבים:
   אני רוצה תוכנית עבודה הדרגתית, אפשר ליישום ב-PRים קטנים:
   - שלב 1: סידור תיקיות בסיסי והזזת קבצים בלי לשנות לוגיקה
   - שלב 2: הוצאת לוגיקה עסקית מ-handlers ל-services עבור זרם אחד (למשל: ניהול שיעורים / טודואים / קבצים)
   - שלב 3: יצירת שכבת repositories מסודרת ל-DB, והחלפת הקריאות הישירות
   - שלב 4: ריכוז utilities, Validators ו-Formatters למקום אחיד
   - שלב 5: חיזוק הגבולות (למשל: מניעת circular imports, הכנסת interfaces אם צריך)
   לכל שלב:
     - מה עושים בפועל
     - אילו קבצים נוגעים
     - איך לבדוק שלא שברנו כלום (בדיקות, הרצות מקומיות, logging)

6. דוגמה אחת מלאה מקצה לקצה:
   - תבחר flow אחד משמעותי מהריפו (למשל: "משתמש לוחץ כפתור X בבוט -> קורה Y במסד הנתונים -> מקבל הודעה מעוצבת").
   - תראה:
     - איך הוא בנוי היום (באופן מקוצר)
     - איך הוא אמור להיראות אחרי פיצול לשכבות (handlers -> services -> repositories -> domain).
   - תציג קטעי קוד מייצגים, בסגנון הריפו הקיים.

7. בדיקות ותחזוקה:
   - המלצות איך להשתמש בשכבות כדי לכתוב tests קלים:
     - בדיקות לשכבת services ללא Telegram ובלי DB אמיתי (mock ל-repositories).
     - בדיקות לשכבת repositories מול DB זמני.
   - איך המבנה השכבתי יעזור לי להוסיף פיצ'רים חדשים בלי לשבור את הכל.

חשוב:
- תתאים את כל ההצעות למבנה הריפו בפועל, אל תדבר תיאורטית בלבד.
- אל תיצור כרגע שינויי קוד בפועל, אלא מדריך ותוכנית ריאלית שאפשר ליישם צעד-אחר-צעד.
- תכתוב הכל בצורה ברורה, מסודרת ופרקטית, עם כותרות, רשימות, וטבלאות איפה שמתאים.
