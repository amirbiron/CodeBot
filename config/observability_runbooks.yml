version: 1
default: generic_incident_flow
runbooks:
  high_error_rate:
    title: "×–×™× ×•×§ ×‘×©×™×¢×•×¨ ×”×©×’×™××•×ª"
    description: "Playbook ××”×™×¨ ×œ×–×™×”×•×™ ×•×˜×™×¤×•×œ ×‘×”×ª×¨××•×ª error_rate ×’×‘×•×”."
    aliases:
      - error_rate_spike
      - high_errors
    steps:
      - id: focus_timeline
        title: "×”×ª××§×“ ×‘×—×œ×•×Ÿ ×”×–××Ÿ ×”× ×›×•×Ÿ"
        description: "×¤×ª×— Incident Replay ×¡×‘×™×‘ ××•×¢×“ ×”×”×ª×¨××” ×›×“×™ ×œ×”×‘×™×Ÿ ××” ×”×•×‘×™×œ ×œ×–×™× ×•×§."
        action:
          label: "âª Incident Replay"
          type: link
          href: "/admin/observability/replay?timerange=3h&focus_ts={{timestamp}}"
          safety: safe
      - id: run_triage_errors
        title: "××©×•×š /triage errors"
        description: "×”×¨×¥ ××ª ×¤×§×•×“×ª ChatOps ×›×“×™ ×œ×§×‘×œ ×“×’×™××•×ª ×©×’×™××” ×•×”×§×©×¨×™× ××”×œ×•×’×™×."
        action:
          label: "ğŸ§ª /triage errors"
          type: copy
          payload: "/triage errors"
          safety: safe
  slow_response:
    title: "Latency ×’×‘×•×” / ×©×™×¨×•×ª ××™×˜×™"
    description: "××¡×œ×•×œ ×˜×™×¤×•×œ ×‘×‘×™×¦×•×¢×™× ××™×˜×™×™× ××• ×‘×–×™× ×•×§×™ P95."
    aliases:
      - latency_spike
      - slow_response_time
    steps:
      - id: replay_latency
        title: "×‘×“×•×§ ××ª ×¦×™×¨ ×”×–××Ÿ"
        description: "×—×¤×© Deployment ×§×¨×•×‘ ××• ××™×¨×•×¢×™ ChatOps ×©××©×¤×™×¢×™× ×¢×œ latency."
        action:
          label: "ğŸ” ×¤×ª×— Replay"
          type: link
          href: "/admin/observability/replay?timerange=6h&focus_ts={{timestamp}}"
          safety: safe
      - id: run_triage_latency
        title: "×”×¨×¥ /triage latency"
        description: "×”×¤×§×•×“×” ××•×©×›×ª ××“×“×™ ×©×¨×ª ×•×—×•×¡×›×ª ×—×™×‘×•×¨ ×™×“× ×™ ×œ×’×¨×¤× ×”."
        action:
          label: "âš™ï¸ /triage latency"
          type: copy
          payload: "/triage latency"
          safety: safe
      - id: review_connection_pooling
        title: "×•×•×“× ×”×’×“×¨×•×ª Connection Pool"
        description: "×—×–×•×¨ ×œ×¡×¢×™×£ ×”-Troubleshooting ×‘××“×¨×™×š Connection Pooling."
        action:
          label: "ğŸ§­ ××“×¨×™×š Latency"
          type: link
          href: "https://github.com/amirbiron/CodeBot/blob/main/GUIDES/GUIDE_CONNECTION_POOLING.md"
          safety: safe
  db_connection_issue:
    title: "×›×©×œ×™× ××•×œ ×‘×¡×™×¡ ×”× ×ª×•× ×™×"
    description: "×¦×¢×“×™× ×œ×˜×™×¤×•×œ ×‘-DB connection issue ×œ×¤× ×™ Escalation."
    aliases:
      - db_connection_error
      - db_connection_issue
      - db_conn_error
      - replicasetnoprimary
      - no_replica_set_members
      - ssl_handshake_failed
      - operationcancelled
    steps:
      - id: vendor_status_atlas
        title: "×‘×“×•×§ ×¡×˜×˜×•×¡ ×¡×¤×§ (MongoDB)"
        description: "×× ×™×© ×ª×§×œ×” ×¢×•×œ××™×ª ××¦×œ MongoDB/Atlas â€“ ×œ×¨×•×‘ ××™×Ÿ ××” ×œ×ª×§×Ÿ ××¦×œ× ×•, ×¨×§ ×œ×¢×§×•×‘ ×•×œ×¢×“×›×Ÿ ×¡×˜×˜×•×¡."
        action:
          label: "ğŸŒ MongoDB Status"
          type: link
          href: "https://status.mongodb.com/"
          safety: safe
      - id: check_mongodb_url
        title: "×•×“× ×§×•× ×¤×™×’ ×‘×¡×™×¡×™"
        description: "×‘×“×•×§ ×©-`MONGODB_URL` ××•×’×“×¨ ×•× ×¨××” ×ª×§×™×Ÿ. ××ª `YOUR_MONGODB_HOST` ×§×— ××ª×•×š ×”-URL (×œ×¨×•×‘ ×”×“×•××™×™×Ÿ ××—×¨×™ `@`, ×œ××©×œ `cluster0.mongodb.net`)."
      - id: check_dns
        title: "×‘×“×•×§ DNS ××”×©×¨×ª"
        description: "×× DNS ×œ× ×¤×•×ª×¨ ××ª ×”×“×•××™×™×Ÿ ×©×œ MongoDB â€“ ×–×• ×‘×¢×™×™×ª ×¨×©×ª/DNS ×•×œ× ×‘×¢×™×™×ª ×§×•×“."
        action:
          label: "ğŸ“‹ ×”×¢×ª×§ ×¤×§×•×“×ª DNS"
          type: copy
          payload: "getent hosts YOUR_MONGODB_HOST"
          safety: caution
      - id: check_tcp_27017
        title: "×‘×“×•×§ TCP ×œ×¤×•×¨×˜ 27017"
        description: "×× ×”×—×™×‘×•×¨ ×œ-27017 × ×›×©×œ/× ×ª×§×¢ â€“ ×‘×“×•×§ Firewall/NAT/Network Access ×‘-Atlas."
        action:
          label: "ğŸ“‹ ×”×¢×ª×§ ×‘×“×™×§×ª TCP"
          type: copy
          payload: "timeout 5 bash -lc 'cat < /dev/null > /dev/tcp/YOUR_MONGODB_HOST/27017'"
          safety: caution
      - id: check_tls_handshake
        title: "×‘×“×•×§ TLS (×× ×™×© SSL handshake failed)"
        description: "×›×©×œ TLS ×™×›×•×œ ×œ×”×™×•×ª ×‘×’×œ×œ ×–××Ÿ ××¢×¨×›×ª, CA bundle, ××• ×©×™× ×•×™×™ ××“×™× ×™×•×ª TLS."
        action:
          label: "ğŸ“‹ ×”×¢×ª×§ ×‘×“×™×§×ª TLS"
          type: copy
          payload: "timeout 8 openssl s_client -connect YOUR_MONGODB_HOST:27017 -servername YOUR_MONGODB_HOST -brief < /dev/null"
          safety: caution
      - id: check_atlas_allowlist
        title: "×‘×“×•×§ IP allowlist (Atlas Network Access)"
        description: "×•×•×“× ×©×”-egress IP ×©×œ ×”×©×¨×ª ××•×¨×©×”. ××•××œ×¥ `x.x.x.x/32`. ×œ× ××•××œ×¥ ×œ×¤×ª×•×— `0.0.0.0/0` (×¨×§ ×›×—×¨×™×’ ×§×¦×¨-×–××Ÿ ×•×‘×›×¤×•×£ ×œ××“×™× ×™×•×ª ××‘×˜×—×”, ×•××– ×œ×”×—×–×™×¨ ××™×“)."
      - id: copy_triage_db
        title: "×”×¨×¥ /triage db"
        description: "××§×‘×œ ××ª ×¡×˜×˜×•×¡ ×”-Pool ×•××¡×¤×¨ ×”×—×™×‘×•×¨×™× ×”×¤×¢×™×œ×™×."
        action:
          label: "ğŸ—„ï¸ /triage db"
          type: copy
          payload: "/triage db"
          safety: caution
      - id: check_backup_runbook
        title: "×‘×“×•×§ ××ª Playbook ×”-DB"
        description: "×•×•×“× ×©×”×’×™×‘×•×™ ×”××—×¨×•×Ÿ ×•×”×‘×“×™×§×•×ª ×”××•×˜×•××˜×™×•×ª ×¢×‘×¨×•."
        action:
          label: "ğŸ› ï¸ ×‘×“×™×§×ª DB"
          type: link
          href: "/GUIDES/BACKUP_RESTORE.md#db-health-check"
          safety: caution
      - id: open_incident_replay_db
        title: "×‘×“×•×§ ×”×§×©×¨×™× × ×•×¡×¤×™×"
        description: "×¤×ª×— ×©×•×‘ ××ª Incident Replay ×›×“×™ ×œ×‘×“×•×§ ×× ×™×© ×”×ª×¨××•×ª × ×•×¡×¤×•×ª ×¡×‘×™×‘ ××•×ª×” ×©×¢×”."
        action:
          label: "â±ï¸ ×”×§×©×¨ × ×•×¡×£"
          type: link
          href: "/admin/observability/replay?timerange=1h&focus_ts={{timestamp}}"
          safety: safe
  # ğŸ’¾ 1. ×‘×¢×™×•×ª ××©××‘×™× (×“×™×¡×§/×–×™×›×¨×•×Ÿ)
  resource_exhaustion:
    title: "×¦×¨×™×›×ª ××©××‘×™× ×§×¨×™×˜×™×ª (CPU/RAM/Disk)"
    description: "×”×©×¨×ª ××ª×§×¨×‘ ×œ×§×¦×” ×’×‘×•×œ ×”×™×›×•×œ×ª. ×¡×›× ×ª ×§×¨×™×¡×” ××™×™×“×™×ª."
    aliases:
      - high_cpu
      - high_memory
      - disk_full
    steps:
      - id: check_system_health
        title: "×”×¨×¥ /triage system"
        description: "×§×‘×œ ×ª××•× ×ª ××¦×‘ ×©×œ Top Processes ×•× ×™×¦×•×œ ×“×™×¡×§."
        action:
          label: "ğŸ’» /triage system"
          type: copy
          payload: "/triage system"
          safety: safe
      - id: clear_cache_suggestion
        title: "×©×§×•×œ × ×™×§×•×™ Cache"
        description: "×× ×”×–×™×›×¨×•×Ÿ ××œ× ×‘×’×œ×œ Redis, ×”×¨×¥ × ×™×§×•×™ Stale ××‘×•×§×¨ ×“×¨×š ChatOps."
        action:
          label: "ğŸ§¹ /cache_clear_stale"
          type: copy
          payload: "/cache_clear_stale"
          safety: caution
  # âš™ï¸ 2. ×ª×•×¨×™× ×•××©×™××•×ª ×¨×§×¢
  worker_lag:
    title: "×¢×™×›×•×‘ ×‘×¢×™×‘×•×“ ××©×™××•×ª ×¨×§×¢"
    description: "×”×ª×•×¨ (Queue) ×¢××•×¡ ××• ×©×”-Worker × ×ª×§×¢."
    aliases:
      - queue_spike
      - worker_down
      - job_failure
    steps:
      - id: check_worker_status
        title: "×¡×˜×˜×•×¡ Sidecar Worker"
        description: "×‘×“×•×§ ×”×× ×”-Worker ××—×•×‘×¨ ×•××—×–×™×¨ /healthz ×ª×§×™×Ÿ."
        action:
          label: "ğŸ‘· /status_worker"
          type: copy
          payload: "/status_worker"
          safety: safe
      - id: check_queue_depth
        title: "×‘×“×•×§ ×¢×•××§ ×ª×•×¨"
        description: "×”×× ×™×© ×”×¦×˜×‘×¨×•×ª ×—×¨×™×’×” ×©×œ ××©×™××•×ª?"
        action:
          label: "ğŸ“Š /triage queues"
          type: copy
          payload: "/triage queues"
          safety: safe
  # â˜ï¸ 3. ×ª×§×œ×•×ª ×¦×“ ×’' (×¡×¤×§×™×)
  external_outage:
    title: "×›×©×œ ×‘×©×™×¨×•×ª ×—×™×¦×•× ×™"
    description: "×©×’×™××•×ª ×‘×—×™×‘×•×¨ ×œ-GitHub, AWS, ××• ×¡×¤×§×™× ××—×¨×™×."
    aliases:
      - github_api_error
      - s3_error
      - external_api_timeout
    steps:
      - id: focus_replay_external
        title: "×¤×ª×— Incident Replay ×¡×‘×™×‘ ×”×©×¢×”"
        description: "×œ×¤× ×™ ×©××¡×™×§×™× ××¡×§× ×•×ª, ×‘×“×•×§ ×× ×™×© ×¢×•×“ ××™×¨×•×¢×™×/×“×™×¤×œ×•×™×™× ×¡×‘×™×‘ ××•×ª×• ×–××Ÿ."
        action:
          label: "âª Incident Replay"
          type: link
          href: "/admin/observability/replay?timerange=3h&focus_ts={{timestamp}}"
          safety: safe
      - id: check_status_openai
        title: "×‘×“×•×§ ×¡×˜×˜×•×¡ OpenAI"
        description: "×× ×™×© ×ª×§×œ×” ××¦×œ ×”×¡×¤×§ â€“ ×œ×¨×•×‘ ×”×¤×ª×¨×•×Ÿ ×”×•× ×”××ª× ×”/×”×•×“×¢×ª ×¡×˜×˜×•×¡ ×œ××©×ª××©×™×."
        action:
          label: "ğŸŒ OpenAI Status"
          type: link
          href: "https://status.openai.com/"
          safety: safe
      - id: check_status_telegram
        title: "×‘×“×•×§ ×¡×˜×˜×•×¡ Telegram"
        description: "×× Telegram ×œ××˜×” â€“ ×”×•×“×¢×•×ª ×™×›×•×œ×•×ª ×œ×”×™×ª×§×¢/×œ×”×™×›×©×œ."
        action:
          label: "ğŸŒ Telegram Status"
          type: link
          href: "https://status.telegram.org/"
          safety: safe
      - id: check_status_github
        title: "×‘×“×•×§ ×¡×˜×˜×•×¡ GitHub"
        description: "×¨×œ×•×•× ×˜×™ ×œ×ª×§×œ×•×ª API/Rate limit ×©×œ GitHub ××• ×”×©×”×™×•×ª ×›×œ×œ×™×•×ª."
        action:
          label: "ğŸŒ GitHub Status"
          type: link
          href: "https://www.githubstatus.com/"
          safety: safe
      - id: run_errors_fallback
        title: "××©×•×š /errors"
        description: "×¤×§×•×“×” ××”×™×¨×” ×©××¦×™×¤×” ×©×’×™××•×ª ××—×¨×•× ×•×ª (fallback ×›×©××™×Ÿ ×ª××•× ×” ××œ××”)."
        action:
          label: "ğŸš¨ /errors"
          type: copy
          payload: "/errors"
          safety: safe

  deployment_event:
    title: "××—×¨×™ Deploy â€“ ×‘×“×™×§×ª ×¨×’×¨×¡×™×”/×›×©×œ"
    description: "×¦×¢×“×™× ××”×™×¨×™× ×›×©××™×“ ××—×¨×™ ×“×™×¤×œ×•×™ ××ª×—×™×œ×•×ª ×—×¨×™×’×•×ª/500 ××• ×©×‘×¨ ×‘×¤×™×¦'×¨."
    aliases:
      - deployment_error
      - deploy_error
      - release_regression
      - observability_aggregations_failed
    steps:
      - id: replay_deploy_window
        title: "×¤×ª×— Replay ×¡×‘×™×‘ ×”×“×™×¤×œ×•×™"
        description: "×‘×“×•×§ ×× ×™×© ×§×•×¨×œ×¦×™×” ×‘×™×Ÿ ×”×“×™×¤×œ×•×™ ×œ×–×™× ×•×§ ×‘×©×’×™××•×ª/×œ×˜× ×¦×™×”."
        action:
          label: "âª Incident Replay"
          type: link
          href: "/admin/observability/replay?timerange=3h&focus_ts={{timestamp}}"
          safety: safe
      - id: check_recent_errors
        title: "××©×•×š /errors"
        description: "×¨××” ××”×¨ ××™×œ×• ×—×¨×™×’×•×ª ×—×•×–×¨×•×ª (TypeError, 500, ×•×›×•')."
        action:
          label: "ğŸš¨ /errors"
          type: copy
          payload: "/errors"
          safety: safe
      - id: check_version_history
        title: "×‘×“×•×§ /version_history"
        description: "×•×•×“× ××™×–×• ×’×¨×¡×” ×¢×œ×ª×” ×•××ª×™."
        action:
          label: "ğŸš€ /version_history"
          type: copy
          payload: "/version_history"
          safety: safe
      - id: triage_with_request_id
        title: "×× ×™×© request_id â€“ ×”×¨×¥ /triage"
        description: "×›×©×™×© ××–×”×” ×‘×§×©×”, /triage × ×•×ª×Ÿ ×§×™×©×•×¨×™× ×™×©×™×¨×™× ×œ×œ×•×’×™×/×”×§×©×¨."
        action:
          label: "ğŸ“‹ /triage <request_id>"
          type: copy
          payload: "/triage "
          safety: safe
      - id: rollback_if_needed
        title: "×× ×™×© ×¤×’×™×¢×” ×‘×¤×¨×•×“×§×©×Ÿ â€“ rollback"
        description: "×‘×¦×¢ rollback ×“×¨×š CI/CD ××• ×”×—×–×¨×ª image/tag ×§×•×“×. ×”×™×× ×¢ ××¤×§×•×“×•×ª git ×”×¨×¡× ×™×•×ª ×¢×œ ×©×¨×ª ×¤×¨×•×“×§×©×Ÿ."
  generic_incident_flow:
    title: "×¤×œ×™×™×‘×•×§ ×›×œ×œ×™ ×œ×”×ª×¨××•×ª"
    description: "Fallback ×‘×¡×™×¡×™ ×”××ª××™× ×œ×›×œ alert_type ×œ×œ× Runbook ×™×™×¢×•×“×™."
    default: true
    steps:
      - id: open_focus_link
        title: "×¤×ª×— ××ª ×”××™×¨×•×¢ ×‘×œ×•×—"
        description: "×”×§×¤×¥ ××ª ×”×œ×•×— ×œ×˜×•×•×— ×”×–××Ÿ ×©×œ ×”×”×ª×¨××” ×›×“×™ ×œ×¨××•×ª ××“×“×™× ×¨×œ×•×•× ×˜×™×™×."
        action:
          label: "ğŸ“ ×¤×ª×— ×‘×œ×•×—"
          type: link
          href: "/admin/observability?focus_ts={{timestamp}}"
          safety: safe
      - id: run_errors_command
        title: "××©×•×š /errors"
        description: "×¤×§×•×“×ª ×‘×¨×™×¨×ª ××—×“×œ ×©××¦×™×¤×” 5 ×©×’×™××•×ª ××—×¨×•× ×•×ª."
        action:
          label: "ğŸš¨ /errors"
          type: copy
          payload: "/errors"
          safety: safe
      - id: check_recent_deploys
        title: "×‘×“×•×§ ×’×¨×¡××•×ª ××—×¨×•× ×•×ª"
        description: "×”×× ×¢×œ×ª×” ×’×¨×¡×” ×‘-30 ×”×“×§×•×ª ×”××—×¨×•× ×•×ª? ×©×œ×•×£ ××ª ×™×•××Ÿ ×”×“×¤×œ×•×™×™×."
        action:
          label: "ğŸš€ /version_history"
          type: copy
          payload: "/version_history"
          safety: safe
      - id: review_replay
        title: "×‘×“×•×§ ××ª Incident Replay"
        description: "×ª××™×“ ×›×“××™ ×œ×”×¦×™×¥ ×‘×¦×™×¨ ×”×–××Ÿ ×›×“×™ ×œ×¨××•×ª ×× ×™×© Runbook ×™×¢×•×“×™ ××—×¨."
        action:
          label: "âª Incident Replay"
          type: link
          href: "/admin/observability/replay?timerange=6h"
          safety: safe

# --- Quick Fix ×—×›× (×“×™× ××™) ×œ×¤×™ Queue Delay + ×¢×•××¡/DB ---
# ×”×¢×¨×”: ×–×” ×§×•× ×¤×™×’ ×¢×‘×•×¨ ×”×œ×•×’×™×§×” ×”×“×™× ××™×ª ×‘×©×¨×ª/×‘×•×˜. ×›×©×—×¡×¨×™× × ×ª×•× ×™× (×œ××©×œ ××™×Ÿ pool/resource metrics)
# ×”×œ×•×’×™×§×” ×¢×•×©×” fallback ×‘×˜×•×— ×•×œ× ×©×•×‘×¨×ª UI.
quick_fix_rules:
  latency_v1:
    enabled: true
    thresholds:
      queue_delay_ms: 500
      duration_ms: 3000
      pool_utilization_high_pct: 90
      pool_utilization_low_pct: 20
      cpu_high_pct: 85
      memory_high_pct: 85
      cpu_low_pct: 30
      memory_low_pct: 30
      active_requests_low: 2
    actions:
      queue_pool_high:
        label: "ğŸ”Œ ×”×’×“×œ Connection Pool / Kill Slow Queries"
        type: copy
        payload: "/triage db"
        safety: caution
        description: "Queueing ×’×‘×•×” + ×œ×—×¥ ×¢×œ DB: ×‘×“×•×§ pool utilization / minPoolSize, ×•×©××™×œ×ª×•×ª ××™×˜×™×•×ª."
      queue_resources_high:
        label: "ğŸ“ˆ Scale Up / Add Workers"
        type: copy
        payload: "/triage system"
        safety: safe
        description: "Queueing ×’×‘×•×” + ×¢×•××¡ CPU/RAM: ×›× ×¨××” ×¦×¨×™×š ×¢×•×“ ××©××‘×™×/Workers."
      queue_stuck_workers:
        label: "ğŸ”„ Restart Service (Stuck Workers)"
        type: copy
        payload: "/status_worker"
        safety: caution
        description: "Queueing ×’×‘×•×” ××‘×œ ×©×™××•×© × ××•×š: ×—×©×“ ×œ-workers ×ª×§×•×¢×™×/deadlock."
      queue_generic:
        label: "ğŸ“ˆ Scale Up"
        type: copy
        payload: "/triage system"
        safety: safe
        description: "Queueing ×’×‘×•×” ×œ×œ× ××™× ×“×™×§×¦×™×” ×‘×¨×•×¨×”: ×”×ª×—×œ ×-scaling ×•××– ×”×¢××§."
      processing_mongo:
        label: "ğŸ” ×‘×“×•×§ ××™× ×“×§×¡×™× / currentOp (Slow Query)"
        type: copy
        payload: "/triage db"
        safety: caution
        description: "Queueing × ××•×š ××‘×œ Duration ×’×‘×•×”: ×—×©×“ ×œ-Slow Query ×‘××•× ×’×•."
      processing_generic:
        label: "ğŸ’¾ ×”×•×¡×£ Caching"
        type: copy
        payload: "/triage latency"
        safety: safe
        description: "Queueing × ××•×š ××‘×œ Duration ×’×‘×•×”: ×›× ×¨××” ×¢×™×‘×•×“ ××™×˜×™ ×‘×§×•×“ (Cache/××•×¤×˜×™××™×–×¦×™×”)."
