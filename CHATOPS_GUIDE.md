# 🚀 מדריך ChatOps ומעקב ביצועים ב-CodeBot

## 📋 תוכן עניינים
1. [סקירה כללית](#סקירה-כללית)
2. [פקודות בריאות המערכת](#פקודות-בריאות-המערכת)
3. [פקודות ניטור ביצועים](#פקודות-ניטור-ביצועים)
4. [פקודות חקירת תקלות](#פקודות-חקירת-תקלות)
5. [פקודות GitHub](#פקודות-github)
6. [פקודות חיזוי ומניעה](#פקודות-חיזוי-ומניעה)
7. [הגדרות והרשאות](#הגדרות-והרשאות)
8. [דוגמאות שימוש מתקדמות](#דוגמאות-שימוש-מתקדמות)

---

## 📌 סקירה כללית

### מה זה ChatOps?
ChatOps זה דרך לנהל ולנטר את המערכת ישירות דרך הצ'אט של טלגרם, בלי צורך בממשקי ניהול נפרדים. אתה יכול לקבל מידע בזמן אמת, לחקור תקלות ולקבל התראות - הכל דרך הבוט.

### היכולות החדשות
- 🔍 **ניטור בזמן אמת** - בדיקת בריאות, ביצועים ושגיאות
- 📊 **מעקב מטריקות** - טעינה, זמני תגובה, משתמשים פעילים
- 🚨 **התראות חכמות** - עם המלצות לפתרון
- 🔎 **זיהוי כפילויות** - מציאת קוד כפול אוטומטית
- 🛠️ **כלי triage** - חקירת תקלות עם timeline מלא
- 🔮 **חיזוי תקלות** - זיהוי בעיות לפני שהן קורות

---

## 🏥 פקודות בריאות המערכת

### `/status` - בדיקת בריאות כללית
בודק את מצב כל הרכיבים המרכזיים במערכת.

**דוגמה:**
```
/status
```

**תשובה:**
```
📋 Status
DB: 🟢
Redis: 🟢
GitHub: 4823/5000 (3% used)
```

**מה זה בודק:**
- חיבור למסד נתונים (MongoDB)
- זמינות Redis לקאשינג
- מכסת GitHub API

---

### `/health` - בדיקת בריאות (alias ל-`/status` בצ'אט)
בסביבת הצ'אט, הפקודה `/health` זהה ל-`/status` ומחזירה את אותן בדיקות (DB, Redis, GitHub).

**שימוש בסיסי:**
```
/health
```

בנוסף, קיימים גם endpoints לייבנס/בריאות עבור תשתיות ומוניטורינג:
- `GET /health`
- `GET /healthz`

---

### `/uptime` - אחוז זמינות
מציג את אחוז הזמינות של המערכת.

**דוגמה:**
```
/uptime
```

**תשובה:**
```
⏱️ Uptime: 99.87%
```

---

## 📊 פקודות ניטור ביצועים

### `/observe` - סקירה מהירה
מציג סיכום של המטריקות החשובות ביותר.

**דוגמה:**
```
/observe
```

**תשובה:**
```
🔍 Observability Overview
Uptime: 99.87%
Error Rate: 0.12%
Active Users: 42
Alerts (24h): 3 (1 critical)
```

---

### `/observe -v` - תצוגה מפורטת
מעניק תמונת מצב עשירה בזמן אמת, כולל מקורות נתונים וספי התראות אדפטיביים.

**פרמטרים:**
- `source=db|memory|all` – סינון מקור הנתונים לספירות ההתראות (ברירת מחדל: `all`).
- `window=5m|1h|24h` – חלון זמן לספירת התראות (ברירת מחדל: `24h`).

**דוגמאות:**
```
/observe -v window=5m source=all
/observe -v source=memory
```

בפלט תראו:
- Uptime, Error Rate (5m), Latency (5m) לצד Thresholds (mean+3σ) – מקור: memory
- Alerts (DB) ו-Alerts (Memory) לפי החלון הנבחר, עם השוואת de-dup ל-Dispatch Log
- Recent Errors (N≤5)
- Cooling & Health – מצב cooldown והתפלגות הצלחות/כשלונות משלוח ליעדי sinks

### `/observe -vv` - מפורט מאוד
מוסיף רשימה קצרה (N=10) של מזהי ההתראות האחרונות מה-DB לטובת חקירה ומעקב.

```
/observe -vv source=db
```

---

### `/errors` - השגיאות האחרונות
מציג את 10 השגיאות האחרונות במערכת.

**דוגמה:**
```
/errors
```

**תשובה:**
```
🧰 שגיאות אחרונות:
1. [CONN_001] Database connection timeout
2. [API_002] GitHub rate limit exceeded
3. [MEM_003] Memory usage above 90%
...
```

**מקורות נתונים:**
- Sentry (אם מוגדר)
- לוג שגיאות פנימי (fallback)

---

### `/alerts` - התראות אחרונות
מציג את 5 ההתראות האחרונות מהמערכת.

**דוגמה:**
```
/alerts
```

**תשובה:**
```
🚨 התראות אחרונות:
1. [CRITICAL] High error rate – 15% errors in last 5 min
2. [WARNING] GitHub API usage – 85% of rate limit used
3. [INFO] Backup completed – 1,234 files backed up
```

---

### `/incidents` - תקלות אחרונות
מציג היסטוריה של תקלות עם פעולות הטיפול.

**דוגמה:**
```
/incidents
```

**תשובה:**
```
🧠 תקלות אחרונות:
1. DB Connection Loss — 2024-10-18 14:30 — action: auto-reconnect
2. High Memory Usage — 2024-10-18 12:15 — action: cache cleared
3. Rate Limit Hit — 2024-10-18 10:45 — action: enabled backoff

🔮 תחזיות פעילות:
1. error_rate → צפוי לחצות סף ב-16:30 UTC
2. memory_usage → מגמת עלייה, בדוק ב-18:00
```

---

## 🔍 פקודות חקירת תקלות

### `/triage` - חקירה מעמיקה
כלי חקירה מתקדם שאוסף את כל המידע על בעיה ספציפית.

**שימוש עם request ID:**
```
/triage req-abc123
```

**שימוש עם חיפוש חופשי:**
```
/triage "database timeout"
```

**תשובה:**
```
🔎 Triage
Query: req-abc123
1. 14:30:15 – Request started
2. 14:30:16 – Database query initiated
3. 14:30:46 – Timeout after 30s
4. 14:30:47 – Error logged to Sentry

דוח מלא: https://bot.example.com/share/triage-abc123.html
Grafana: [Logs (24h)](link) [Latency (5m)](link)
```

**מה מקבלים:**
- Timeline מלא של האירועים
- קישורים לדשבורדים ב-Grafana
- דוח HTML מפורט עם כל הנתונים
- המלצות לפתרון

---

## 🐙 פקודות GitHub

### `/rate_limit` - מצב מכסת GitHub API
מציג את מצב השימוש במכסת ה-API של GitHub.

**דוגמה:**
```
/rate_limit
```

**תשובה:**
```
📈 GitHub Rate Limit
Remaining: 4,234/5,000
Usage: [████████████████░░░░] 15%
```

**התראות:**
- ⚠️ אזהרה ב-80% שימוש
- 🔴 קריטי ב-90% שימוש

---

### `/enable_backoff` - הפעלת מצב חיסכון
מפעיל מצב חיסכון ב-GitHub API כשמתקרבים למגבלה.

**דוגמה:**
```
/enable_backoff
```

**תשובה:**
```
✅ GitHub Backoff Mode: ENABLED
• סנכרונים אוטומטיים: מושהים
• בדיקות רקע: מצומצמות
• המצב יבוטל אוטומטית בחידוש המכסה
```

---

### `/disable_backoff` - ביטול מצב חיסכון
מבטל את מצב החיסכון ומחזיר פעילות רגילה.

**דוגמה:**
```
/disable_backoff
```

---

## 🔮 פקודות חיזוי ומניעה

### `/predict` - תחזית תקלות
מנתח מגמות ומנבא בעיות פוטנציאליות ב-3 השעות הקרובות.

**דוגמה:**
```
/predict
```

**תשובה:**
```
🔮 Predictive Health – 3h
🔴 error_rate: curr=2.1% thr=5% slope/min=0.015 → חצייה צפויה ב-16:45 UTC
🟢 memory_usage: curr=65% thr=90% slope/min=-0.002 → יציב
⚪ cpu_usage: curr=45% thr=80% slope/min=0.000 → יציב
```

**מקרא:**
- 🔴 מגמת עלייה מדאיגה
- 🟢 מגמת ירידה טובה
- ⚪ יציב

---

### `/accuracy` - דיוק החיזוי
מציג סטטיסטיקה על דיוק החיזויים ותקלות שנמנעו.

**דוגמה:**
```
/accuracy
```

**תשובה:**
```
📊 Prediction Accuracy: 87.5%
🛡️ Prevented Incidents (est.): 42
```

---

### `/sen` - קישור ל-Sentry
מחזיר קישור מהיר לדשבורד Sentry (אם מוגדר).

**דוגמה:**
```
/sen
```

**תשובה:**
```
🔗 Sentry: https://sentry.example.com/organizations/myorg/issues/
```

---

## ⚙️ הגדרות והרשאות

### דרישות הרשאה
כל הפקודות דורשות הרשאת אדמין. הגדר אדמינים דרך משתנה הסביבה:
```bash
ADMIN_USER_IDS=123456789,987654321
```

### הגבלת צ'אטים
אפשר להגביל פקודות לצ'אטים מסוימים:
```bash
ALLOWED_CHAT_IDS=-1001234567890,-1009876543210
```

### הגדרות ניטור
```bash
# Sentry (אופציונלי אך מומלץ)
SENTRY_DSN=https://xxx@sentry.io/yyy
SENTRY_DASHBOARD_URL=https://sentry.io/organizations/myorg/

# Grafana (אופציונלי)
GRAFANA_URL=https://grafana.example.com

# מטריקות
METRICS_DB_ENABLED=true
MONGODB_URL=mongodb://localhost:27017
METRICS_COLLECTION=service_metrics

# התראות
ALERT_COOLDOWN_SECONDS=300
ALERT_ERRORS_PER_MINUTE=20
ALERT_AVG_RESPONSE_TIME=2.0
```

---

## 💡 דוגמאות שימוש מתקדמות

### תרחיש 1: המערכת איטית
```
1. /status          # בדיקה ראשונית
2. /observe         # סקירת מטריקות
3. /errors          # האם יש שגיאות?
4. /rate_limit      # בדיקת GitHub API
5. /triage "slow"   # חקירה מעמיקה
```

### תרחיש 2: קבלת התראה על שגיאות
```
1. /alerts          # צפייה בהתראות
2. /errors          # פירוט השגיאות
3. /triage req-xyz  # חקירת request ספציפי
4. /incidents       # היסטוריית תקלות דומות
```

### תרחיש 3: תחזוקה מונעת
```
1. /predict         # בדיקת תחזיות
2. /observe         # מעקב אחר מגמות
3. /accuracy        # בדיקת אמינות החיזוי
4. /enable_backoff  # הפעלת חיסכון אם צריך
```

### תרחיש 4: דיווח יומי למנהל
```
1. /uptime          # זמינות כללית
2. /observe         # סטטוס נוכחי
3. /incidents       # תקלות ב-24 שעות
4. /predict         # תחזית ל-3 שעות הבאות
```

---

## 🎯 טיפים לשימוש יעיל

### 1. הגדר התראות אוטומטיות
הבוט ישלח התראות אוטומטית כשיש בעיות. ודא שאתה אדמין ושההגדרות נכונות.

### 2. השתמש ב-triage לחקירה מעמיקה
אם משהו לא עובד, `/triage` עם request ID או תיאור הבעיה ייתן את התמונה המלאה.

### 3. עקוב אחר מגמות
`/predict` עוזר לזהות בעיות לפני שהן קורות. בדוק אותו מדי פעם.

### 4. נטר את GitHub API
אם אתה משתמש הרבה בסנכרון GitHub, עקוב אחר `/rate_limit` כדי להימנע מחסימות.

### 5. שמור דוחות triage
הדוחות המלאים שנוצרים ב-`/triage` שימושיים לניתוח מאוחר יותר.

---

## 📚 משאבים נוספים

- [תיעוד המערכת](https://amirbiron.github.io/CodeBot/)
- [Issue המקורי (#808)](https://github.com/amirbiron/CodeBot/issues/808)
- [דוגמאות קוד במימוש](https://github.com/amirbiron/CodeBot/tree/main/chatops)

---

## 🚨 פתרון בעיות נפוצות

### "פקודה זמינה למנהלים בלבד"
הוסף את ה-User ID שלך ל-`ADMIN_USER_IDS` במשתני הסביבה.

### "אין נתוני שגיאות זמינים"
ודא ש-Sentry מוגדר או שיש שגיאות בלוג הפנימי.

### מטריקות לא מעודכנות
בדוק ש-`METRICS_DB_ENABLED=true` ושיש חיבור ל-MongoDB.

### תחזיות לא מדויקות
המערכת לומדת עם הזמן. דיוק משתפר אחרי כמה ימי פעילות.

---

## 📝 סיכום

המערכת החדשה של ChatOps נותנת לך שליטה מלאה על הניטור והתפעול של הבוט ישירות מטלגרם. השתמש בפקודות האלה באופן קבוע כדי לשמור על המערכת יציבה ומהירה.

**זכור:**
- בדוק `/status` כל יום
- עקוב אחר `/alerts` להתראות
- השתמש ב-`/triage` לחקירת בעיות
- נצל את `/predict` למניעת תקלות

בהצלחה! 🚀