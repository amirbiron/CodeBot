{% extends "base.html" %}

{% block title %}×¡×œ ××—×–×•×¨ - Code Keeper{% endblock %}

{% block content %}
<div class="section-header" style="display:flex; align-items:center; justify-content:space-between; gap:1rem; flex-wrap:wrap;">
    <h1 class="page-title" style="margin:0;">×¡×œ ××—×–×•×¨</h1>
    <div style="display:flex; gap:0.5rem; align-items:center; flex-wrap:wrap;">
        <a href="/files" class="btn btn-secondary btn-icon" title="×—×–×¨×” ×œ×§×‘×¦×™×">
            <i class="fas fa-arrow-right" aria-hidden="true"></i>
            <span class="btn-text">×—×–×¨×” ×œ×§×‘×¦×™×</span>
        </a>
    </div>
</div>

<div class="glass-card" style="margin-top: 1rem;">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:0.75rem; flex-wrap:wrap;">
        <div style="opacity:0.9;">
            ğŸ—‘ï¸ ×™×© ×›×¨×’×¢ <strong>{{ total_count }}</strong> ×¤×¨×™×˜×™× ×‘×¡×œ
            {% if recycle_ttl_days %}
            <span style="opacity:0.85;">| ×¤×¨×™×˜×™× × ××—×§×™× ××•×˜×•××˜×™×ª ××—×¨×™ ~{{ recycle_ttl_days }} ×™××™×</span>
            {% endif %}
        </div>
        {% if total_pages > 1 %}
        <div style="opacity:0.8;">×¢××•×“ {{ page }} ××ª×•×š {{ total_pages }}</div>
        {% endif %}
    </div>
</div>

{% if items %}
<div class="glass-card" style="margin-top: 1rem; overflow:hidden;">
    <div style="overflow-x:auto;">
        <table style="width:100%; border-collapse: collapse;">
            <thead>
                <tr style="text-align:right; border-bottom: 1px solid rgba(255,255,255,0.12);">
                    <th style="padding: 0.75rem;">×§×•×‘×¥</th>
                    <th style="padding: 0.75rem; white-space:nowrap;">× ××—×§</th>
                    <th style="padding: 0.75rem; white-space:nowrap;">× ××—×§ ×¡×•×¤×™×ª ×‘-</th>
                    <th style="padding: 0.75rem; text-align:left;">×¤×¢×•×œ×•×ª</th>
                </tr>
            </thead>
            <tbody>
                {% for it in items %}
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.08);">
                    <td style="padding: 0.75rem; min-width: 260px;">
                        <div style="display:flex; align-items:center; gap:0.75rem; min-width:0;">
                            <span style="font-size:1.5rem; flex:0 0 auto;" aria-hidden="true">{{ it.icon }}</span>
                            <div style="min-width:0;">
                                <div style="font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="{{ it.file_name }}">{{ it.file_name }}</div>
                                <div style="opacity:0.8; font-size:0.9rem; display:flex; gap:0.5rem; flex-wrap:wrap;">
                                    <span class="lang-badge" data-lang="{{ it.language|lower }}">{{ it.language }}</span>
                                    {% if it.version %}
                                    <span class="badge" style="opacity:0.9;">v{{ it.version }}</span>
                                    {% endif %}
                                    {% if it.kind %}
                                    <span class="badge" style="opacity:0.9;">{{ it.kind }}</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </td>
                    <td style="padding: 0.75rem; white-space:nowrap; opacity:0.9;">{{ it.deleted_at or 'â€”' }}</td>
                    <td style="padding: 0.75rem; white-space:nowrap; opacity:0.9;">{{ it.expires_at or 'â€”' }}</td>
                    <td style="padding: 0.75rem; text-align:left; white-space:nowrap;">
                        <button type="button"
                                class="btn btn-secondary btn-icon"
                                onclick="restoreTrashed('{{ it.id }}')"
                                title="×©×—×–×¨">
                            â™»ï¸ <span class="btn-text">×©×—×–×¨</span>
                        </button>
                        <button type="button"
                                class="btn btn-danger btn-icon"
                                onclick="purgeTrashed('{{ it.id }}')"
                                title="××—×™×§×” ×¡×•×¤×™×ª">
                            ğŸ§¨ <span class="btn-text">××—×™×§×” ×¡×•×¤×™×ª</span>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="pagination glass-card" style="margin-top: 1rem; display:flex; justify-content:center; align-items:center; gap: 0.75rem;">
    {% if has_prev %}
    <a href="/trash?page={{ page - 1 }}" class="btn btn-secondary btn-icon">
        <i class="fas fa-chevron-right" aria-hidden="true"></i>
        ×”×§×•×“×
    </a>
    {% endif %}
    {% if total_pages > 1 %}
    <span style="opacity:0.9;">×¢××•×“ {{ page }} ××ª×•×š {{ total_pages }}</span>
    {% endif %}
    {% if has_next %}
    <a href="/trash?page={{ page + 1 }}" class="btn btn-secondary btn-icon">
        ×”×‘×
        <i class="fas fa-chevron-left" aria-hidden="true"></i>
    </a>
    {% endif %}
</div>
{% else %}
<div class="glass-card" style="margin-top: 1rem; text-align:center; padding: 3rem 1.5rem;">
    <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ—‘ï¸</div>
    <h2 style="margin:0;">×”×¡×œ ×¨×™×§</h2>
    <p style="margin: 0.75rem 0 0; opacity:0.85;">×§×‘×¦×™× ×©××•×¢×‘×¨×™× ×œ×¡×œ ×™×•×¤×™×¢×• ×›××Ÿ ×¢×“ ×œ××—×™×§×” ××•×˜×•××˜×™×ª.</p>
    <a href="/files" class="btn btn-primary btn-icon" style="margin-top: 1.25rem;">
        <i class="fas fa-folder" aria-hidden="true"></i>
        ×—×–×¨×” ×œ×§×‘×¦×™×
    </a>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
async function restoreTrashed(fileId) {
    if (!fileId) return;
    try {
        const res = await fetch(`/api/trash/${encodeURIComponent(fileId)}/restore`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({})
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data || !data.ok) {
            alert((data && data.error) ? data.error : '×©×’×™××” ×‘×©×—×–×•×¨');
            return;
        }
        window.location.reload();
    } catch (e) {
        alert('×©×’×™××” ×‘×©×—×–×•×¨');
    }
}

async function purgeTrashed(fileId) {
    if (!fileId) return;
    if (!confirm('×œ××—×•×§ ×œ×¦××™×ª×•×ª? ××™ ××¤×©×¨ ×œ×©×—×–×¨ ××—×¨×™ ×–×”.')) return;
    try {
        const res = await fetch(`/api/trash/${encodeURIComponent(fileId)}/purge`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({})
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data || !data.ok) {
            alert((data && data.error) ? data.error : '×©×’×™××” ×‘××—×™×§×” ×¡×•×¤×™×ª');
            return;
        }
        window.location.reload();
    } catch (e) {
        alert('×©×’×™××” ×‘××—×™×§×” ×¡×•×¤×™×ª');
    }
}
</script>
{% endblock %}

