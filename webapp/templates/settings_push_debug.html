{% extends "base.html" %}

{% block title %}×“×™×‘×•×’ Web Push - Code Keeper Bot{% endblock %}

{% block content %}
<h1 class="page-title">
  <i class="fas fa-bug"></i>
  ×“×™×‘×•×’ Web Push
</h1>

<div class="glass-card">
  <h2 class="section-title">
    <i class="fas fa-server"></i>
    ×¡×˜×˜×•×¡ ×©×¨×ª
  </h2>
  <div class="glass-card" style="background: rgba(255, 255, 255, 0.05)">
    <div style="display: grid; grid-template-columns: 1fr; gap: 0.6rem">
      <div><strong>PUSH_NOTIFICATIONS_ENABLED:</strong> {{ 'ğŸŸ¢ true' if push_enabled else 'ğŸ”´ false' }}</div>
      <div><strong>VAPID_PUBLIC_KEY:</strong> {{ 'ğŸŸ¢ ××•×’×“×¨' if vapid_public_set else 'ğŸ”´ ×—×¡×¨' }}</div>
      <div><strong>VAPID_PRIVATE_KEY:</strong> {{ 'ğŸŸ¢ ××•×’×“×¨' if vapid_private_set else 'ğŸ”´ ×—×¡×¨' }}</div>
      <div><strong>PUSH_REMOTE_DELIVERY_ENABLED:</strong> {{ remote_enabled_env if remote_enabled_env else 'â€”' }}</div>
      <div><strong>PUSH_DELIVERY_URL:</strong> {{ remote_url if remote_url else 'â€”' }}</div>
      <div><strong>PUSH_DELIVERY_TOKEN:</strong> {{ 'ğŸŸ¢ ××•×’×“×¨' if remote_token_set else 'ğŸ”´ ×—×¡×¨' }}</div>
    </div>
  </div>
</div>

<div class="glass-card">
  <h2 class="section-title">
    <i class="fas fa-database"></i>
    ×× ×•×™×™× (DB)
  </h2>
  <div class="glass-card" style="background: rgba(255, 255, 255, 0.05)">
    {% if subs_error %}
      <div style="opacity: 0.9">ğŸ”´ ×©×’×™××” ×‘×§×¨×™××ª DB: {{ subs_error }}</div>
    {% else %}
      <div><strong>Subscriptions count (user):</strong> {{ subs_count }}</div>
      <div style="opacity: 0.85; margin-top: 0.5rem">
        ×× ×”××¡×¤×¨ 0 â€“ ××™×Ÿ ×× ×•×™ ×‘×“×¤×“×¤×Ÿ/××›×©×™×¨ ×”×–×” (××• ×©×”-Subscribe ×œ× × ×©×œ×— ×œ×©×¨×ª).
      </div>
    {% endif %}
  </div>
</div>

<div class="glass-card">
  <h2 class="section-title">
    <i class="fas fa-mobile-screen"></i>
    ×œ×§×•×— (××™×“×¢ ×›×œ×œ×™)
  </h2>
  <div class="glass-card" style="background: rgba(255, 255, 255, 0.05)">
    <div style="opacity: 0.9; word-break: break-word">
      <strong>User-Agent:</strong> {{ user_agent if user_agent else 'â€”' }}
    </div>
    <div style="opacity: 0.85; margin-top: 0.75rem">
      ×ª×–×›×•×¨×ª: ×‘-iOS ×”×ª×¨××•×ª Web Push ×‘×“×¤×“×¤×Ÿ ×¢×•×‘×“×•×ª ×¨×§ ×›×©××ª×§×™× ×™× ××ª ×”××ª×¨ ×›â€‘PWA (Add to Home Screen).
      ×‘-Telegram/Embedded WebView ×œ×¤×¢××™× ××™×Ÿ ×ª××™×›×” ×‘-ServiceWorker/PushManager.
    </div>
  </div>
</div>

<div class="glass-card">
  <h2 class="section-title">
    <i class="fas fa-vial"></i>
    ×‘×“×™×§×•×ª
  </h2>
  <div class="glass-card" style="background: rgba(255, 255, 255, 0.05)">
    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap">
      <form action="/settings/push-test" method="post" style="margin: 0">
        <button type="submit" class="btn btn-primary">
          ×©×œ×— ×¤×•×© ×‘×“×™×§×” (×©×¨×ª)
        </button>
      </form>
      <a href="/settings#push" class="btn btn-secondary">×—×–×¨×” ×œ×”×’×“×¨×•×ª</a>
    </div>
    <div style="opacity: 0.85; margin-top: 0.75rem">
      ×”×‘×“×™×§×” ×”×–×• ××—×–×™×¨×” JSON ×©×œ <code>/api/push/test</code>. ×× ××™×Ÿ ×× ×•×™×™× â€“ ×ª×§×‘×œ <code>no_subscriptions</code>.
    </div>
  </div>
</div>

<div class="glass-card">
  <h2 class="section-title">
    <i class="fas fa-desktop"></i>
    ×¡×˜×˜×•×¡ ×“×¤×“×¤×Ÿ (JavaScript)
  </h2>
  <div class="glass-card" style="background: rgba(255, 255, 255, 0.05)">
    <div id="browser-checks" style="display: grid; gap: 0.6rem">
      <div>×˜×•×¢×Ÿ ×‘×“×™×§×•×ª...</div>
    </div>
  </div>
</div>

<div class="glass-card">
  <h2 class="section-title">
    <i class="fas fa-wand-magic-sparkles"></i>
    ×¤×¢×•×œ×•×ª ××”×“×¤×“×¤×Ÿ
  </h2>
  <div class="glass-card" style="background: rgba(255, 255, 255, 0.05)">
    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap">
      <button id="swRegisterBtn" type="button" class="btn btn-secondary" onclick="registerServiceWorkerNow()">
        ×¨×©×•× Service Worker
      </button>
      <button id="browserSubscribeBtn" type="button" class="btn btn-primary" onclick="subscribeFromBrowserNow()">
        ×‘×§×© ×”×¨×©××” + ×¦×•×¨ ×× ×•×™ + ×©××•×¨ ×‘×©×¨×ª
      </button>
      <button id="browserUnsubscribeBtn" type="button" class="btn btn-secondary" onclick="unsubscribeFromBrowserNow()">
        ×‘×˜×œ ×× ×•×™ ×‘×“×¤×“×¤×Ÿ (Unsubscribe)
      </button>
      <button id="swUnregisterBtn" type="button" class="btn btn-secondary" onclick="unregisterServiceWorkerNow()">
        ×‘×˜×œ ×¨×™×©×•× Service Worker
      </button>
    </div>
    <div id="browser-actions-status" style="margin-top: 0.75rem; opacity: 0.9">
      â€”
    </div>
    <div style="opacity: 0.8; margin-top: 0.75rem; font-size: 0.95rem">
      ×”×¢×¨×”: ××—×™×§×” ×©×œ ×× ×•×™×™× ×‘×©×¨×ª (DB) ×œ× ××‘×˜×œ×ª ××•×˜×•××˜×™×ª ××ª ×”×× ×•×™ ×”××§×•××™ ×‘×“×¤×“×¤×Ÿ. ×›×“×™ â€œ×œ××¤×¡ ×‘×××ªâ€ ×¦×¨×™×š ×’× Unsubscribe/Unregister ×›××Ÿ.
    </div>
  </div>
</div>

<div class="glass-card">
  <h2 class="section-title">
    <i class="fas fa-plug"></i>
    ×‘×“×™×§×ª ×—×™×‘×•×¨×™×•×ª Push Services
  </h2>
  <div class="glass-card" style="background: rgba(255, 255, 255, 0.05)">
    <button id="diagnoseBtn" type="button" class="btn btn-secondary" onclick="runDiagnose()">
      ×”×¨×¥ ×‘×“×™×§×ª ×—×™×‘×•×¨×™×•×ª
    </button>
    <div id="diagnose-results" style="margin-top: 1rem; display: none"></div>
  </div>
</div>

<div class="glass-card">
  <h2 class="section-title">
    <i class="fas fa-list"></i>
    ×›×œ×™× × ×•×¡×¤×™×
  </h2>
  <div class="glass-card" style="background: rgba(255, 255, 255, 0.05)">
    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap">
      <button type="button" onclick="listSubscriptions()" class="btn btn-secondary">
        ×”×¦×’ ×× ×•×™×™×
      </button>
      <button type="button" onclick="deleteAllSubs()" class="btn btn-danger">
        ××—×§ ××ª ×›×œ ×”×× ×•×™×™×
      </button>
    </div>
    <div id="subs-list" style="margin-top: 1rem"></div>
  </div>
</div>

<script>
(function () {
  try {
    var checksDiv = document.getElementById('browser-checks');
    if (!checksDiv) return;

    var checks = [];
    function add(line) { checks.push(line); }
    function render() { checksDiv.innerHTML = checks.join(''); }

    // 1) Notification API
    var hasNotification = ('Notification' in window);
    var notifPerm = hasNotification ? String(Notification.permission || '') : 'not-supported';
    add('<div><strong>Notification API:</strong> ' + (hasNotification ? 'ğŸŸ¢ × ×ª××š' : 'ğŸ”´ ×œ× × ×ª××š') + ' (×”×¨×©××”: ' + notifPerm + ')</div>');

    // 2) Service Worker
    var hasSW = (typeof navigator !== 'undefined' && 'serviceWorker' in navigator);
    add('<div><strong>Service Worker:</strong> ' + (hasSW ? 'ğŸŸ¢ × ×ª××š' : 'ğŸ”´ ×œ× × ×ª××š') + '</div>');

    // 3) PushManager
    var hasPush = ('PushManager' in window);
    add('<div><strong>PushManager:</strong> ' + (hasPush ? 'ğŸŸ¢ × ×ª××š' : 'ğŸ”´ ×œ× × ×ª××š') + '</div>');

    // 4) HTTPS/Localhost
    var host = String(location.hostname || '');
    var isSecure = (location.protocol === 'https:') || (host === 'localhost') || (host === '127.0.0.1');
    add('<div><strong>×—×™×‘×•×¨ ×××•×‘×˜×— (HTTPS):</strong> ' + (isSecure ? 'ğŸŸ¢ ×›×Ÿ' : 'ğŸ”´ ×œ× (×“×¨×•×© HTTPS)') + '</div>');

    // If no permission yet - show CTA
    if (hasNotification && notifPerm === 'default') {
      add('<div style="margin-top: 1rem"><button type="button" onclick="requestNotificationPermission()" class="btn btn-primary">×‘×§×© ×”×¨×©××ª ×”×ª×¨××•×ª</button></div>');
    }

    // 5) SW registration + subscription
    if (!hasSW) {
      render();
      return;
    }

    navigator.serviceWorker.getRegistration().then(function (reg) {
      var hasReg = !!reg;
      add('<div><strong>Service Worker ×¨×©×•×:</strong> ' + (hasReg ? 'ğŸŸ¢ ×›×Ÿ' : 'ğŸŸ¡ ×œ× (×¢×“×™×™×Ÿ ×œ× × ×¨×©×)') + '</div>');
      if (!hasReg || !reg.pushManager) {
        render();
        return;
      }
      reg.pushManager.getSubscription().then(function (sub) {
        var hasSub = !!sub;
        add('<div><strong>×™×© ×× ×•×™ ×¤×¢×™×œ ×‘×“×¤×“×¤×Ÿ:</strong> ' + (hasSub ? 'ğŸŸ¢ ×›×Ÿ' : 'ğŸŸ¡ ×œ×') + '</div>');
        render();
      }).catch(function () {
        add('<div><strong>×™×© ×× ×•×™ ×¤×¢×™×œ ×‘×“×¤×“×¤×Ÿ:</strong> ğŸ”´ ×©×’×™××” ×‘×‘×“×™×§×”</div>');
        render();
      });
    }).catch(function () {
      add('<div><strong>Service Worker ×¨×©×•×:</strong> ğŸ”´ ×©×’×™××” ×‘×‘×“×™×§×”</div>');
      render();
    });
  } catch (e) {
    try {
      var el = document.getElementById('browser-checks');
      if (el) el.innerHTML = '<div>ğŸ”´ ×©×’×™××” ×‘×”×¨×¦×ª ×‘×“×™×§×•×ª ×“×¤×“×¤×Ÿ</div>';
    } catch (_) {}
  }
})();

function requestNotificationPermission() {
  try {
    if (!('Notification' in window)) {
      alert('×”×“×¤×“×¤×Ÿ ×œ× ×ª×•××š ×‘×”×ª×¨××•×ª');
      return;
    }
    Notification.requestPermission().then(function (perm) {
      alert('×”×¨×©××”: ' + perm);
      try { location.reload(); } catch (_) {}
    });
  } catch (_) {
    alert('×©×’×™××” ×‘×‘×§×©×ª ×”×¨×©××”');
  }
}

function _setBrowserActionsStatus(text) {
  try {
    var el = document.getElementById('browser-actions-status');
    if (el) el.textContent = String(text || '');
  } catch (_) {}
}

function registerServiceWorkerNow() {
  var btn = document.getElementById('swRegisterBtn');
  if (btn) btn.disabled = true;
  _setBrowserActionsStatus('×¨×•×©× Service Worker...');
  try {
    if (!('serviceWorker' in navigator)) {
      _setBrowserActionsStatus('ServiceWorker ×œ× × ×ª××š ×‘×“×¤×“×¤×Ÿ ×”×–×”');
      if (btn) btn.disabled = false;
      return;
    }
    navigator.serviceWorker.register('/sw.js').then(function () {
      _setBrowserActionsStatus('Service Worker × ×¨×©× ×‘×”×¦×œ×—×”. ××¨×¢× ×Ÿ...');
      try { location.reload(); } catch (_) {}
    }).catch(function (e) {
      _setBrowserActionsStatus('×©×’×™××” ×‘×¨×™×©×•× Service Worker: ' + String((e && e.message) || e || 'unknown'));
    }).finally(function () {
      if (btn) btn.disabled = false;
    });
  } catch (e) {
    _setBrowserActionsStatus('×©×’×™××” ×‘×¨×™×©×•× Service Worker');
    if (btn) btn.disabled = false;
  }
}

function _urlBase64ToUint8Array(base64String) {
  var padding = Array((4 - (base64String.length % 4)) % 4 + 1).join('=');
  var base64 = String(base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
  var rawData = window.atob(base64);
  var outputArray = new Uint8Array(rawData.length);
  for (var i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
  return outputArray;
}

function _fetchVapidPublicKey() {
  return fetch('/api/push/public-key', { cache: 'no-store', credentials: 'include' })
    .then(function (r) { return r.json().catch(function () { return {}; }); })
    .then(function (j) {
      if (!j || j.ok === false || !j.vapidPublicKey) throw new Error('VAPID public key missing');
      return j.vapidPublicKey;
    });
}

function subscribeFromBrowserNow() {
  var btn = document.getElementById('browserSubscribeBtn');
  if (btn) btn.disabled = true;
  _setBrowserActionsStatus('×‘×•×“×§ ×ª××™×›×”...');
  try {
    if (!('Notification' in window)) {
      _setBrowserActionsStatus('Notification API ×œ× × ×ª××š');
      if (btn) btn.disabled = false;
      return;
    }
    if (!('serviceWorker' in navigator)) {
      _setBrowserActionsStatus('ServiceWorker ×œ× × ×ª××š');
      if (btn) btn.disabled = false;
      return;
    }
    if (!('PushManager' in window)) {
      _setBrowserActionsStatus('PushManager ×œ× × ×ª××š');
      if (btn) btn.disabled = false;
      return;
    }
  } catch (_) {}

  _setBrowserActionsStatus('××‘×§×© ×”×¨×©××ª ×”×ª×¨××•×ª...');
  Notification.requestPermission().then(function (perm) {
    if (perm !== 'granted') {
      _setBrowserActionsStatus('×”×¨×©××ª ×”×ª×¨××•×ª ×œ× ××•×©×¨×”: ' + String(perm));
      if (btn) btn.disabled = false;
      return;
    }
    _setBrowserActionsStatus('×¨×•×©× Service Worker...');
    return navigator.serviceWorker.register('/sw.js').then(function (reg) {
      _setBrowserActionsStatus('×™×•×¦×¨ subscription...');
      return _fetchVapidPublicKey().then(function (key) {
        return reg.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: _urlBase64ToUint8Array(key),
        }).then(function (sub) {
          _setBrowserActionsStatus('×©×•××¨ ×× ×•×™ ×‘×©×¨×ª...');
          return fetch('/api/push/subscribe', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(sub),
          }).then(function (resp) {
            return resp.json().catch(function () { return {}; }).then(function (j) {
              if (!resp.ok || !j || j.ok === false) throw new Error('server_subscribe_failed');
              _setBrowserActionsStatus('×”×¦×œ×—×”: × ×¨×©× ×× ×•×™ ×•× ×©××¨ ×‘×©×¨×ª. ××¨×¢× ×Ÿ...');
              try { location.reload(); } catch (_) {}
            });
          });
        });
      });
    });
  }).catch(function (e) {
    _setBrowserActionsStatus('×›×©×œ ×‘×”×¤×¢×œ×” ××”×“×¤×“×¤×Ÿ: ' + String((e && e.message) || e || 'unknown'));
  }).finally(function () {
    if (btn) btn.disabled = false;
  });
}

function unsubscribeFromBrowserNow() {
  var btn = document.getElementById('browserUnsubscribeBtn');
  if (btn) btn.disabled = true;
  _setBrowserActionsStatus('××‘×˜×œ ×× ×•×™ ×‘×“×¤×“×¤×Ÿ...');
  try {
    if (!('serviceWorker' in navigator)) {
      _setBrowserActionsStatus('ServiceWorker ×œ× × ×ª××š');
      if (btn) btn.disabled = false;
      return;
    }
    navigator.serviceWorker.getRegistration().then(function (reg) {
      if (!reg || !reg.pushManager) {
        _setBrowserActionsStatus('××™×Ÿ Service Worker ×¨×©×•×');
        return;
      }
      return reg.pushManager.getSubscription().then(function (sub) {
        if (!sub) {
          _setBrowserActionsStatus('××™×Ÿ ×× ×•×™ ×¤×¢×™×œ ×‘×“×¤×“×¤×Ÿ');
          return;
        }
        // Best-effort: remove from server by endpoint too (doesn't require DB list)
        try {
          var ep = (sub && typeof sub.endpoint === 'string') ? sub.endpoint : '';
          if (ep) {
            fetch('/api/push/subscribe', {
              method: 'DELETE',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify({ endpoint: ep }),
            }).catch(function () {});
          }
        } catch (_) {}
        return sub.unsubscribe().then(function () {
          _setBrowserActionsStatus('×”×× ×•×™ ×‘×•×˜×œ ×‘×”×¦×œ×—×”. ××¨×¢× ×Ÿ...');
          try { location.reload(); } catch (_) {}
        }).catch(function (e) {
          _setBrowserActionsStatus('×©×’×™××” ×‘×‘×™×˜×•×œ ×× ×•×™: ' + String((e && e.message) || e || 'unknown'));
        });
      });
    }).catch(function (e) {
      _setBrowserActionsStatus('×©×’×™××” ×‘×‘×™×˜×•×œ ×× ×•×™: ' + String((e && e.message) || e || 'unknown'));
    }).finally(function () {
      if (btn) btn.disabled = false;
    });
  } catch (e) {
    _setBrowserActionsStatus('×©×’×™××” ×‘×‘×™×˜×•×œ ×× ×•×™');
    if (btn) btn.disabled = false;
  }
}

function unregisterServiceWorkerNow() {
  var btn = document.getElementById('swUnregisterBtn');
  if (btn) btn.disabled = true;
  _setBrowserActionsStatus('××‘×˜×œ ×¨×™×©×•× Service Worker...');
  try {
    if (!('serviceWorker' in navigator)) {
      _setBrowserActionsStatus('ServiceWorker ×œ× × ×ª××š');
      if (btn) btn.disabled = false;
      return;
    }
    navigator.serviceWorker.getRegistration().then(function (reg) {
      if (!reg) {
        _setBrowserActionsStatus('××™×Ÿ Service Worker ×¨×©×•×');
        return;
      }
      return reg.unregister().then(function (ok) {
        if (ok) {
          _setBrowserActionsStatus('Service Worker ×‘×•×˜×œ. ××¨×¢× ×Ÿ...');
          try { location.reload(); } catch (_) {}
          return;
        }
        _setBrowserActionsStatus('×œ× ×”×¦×œ×—×ª×™ ×œ×‘×˜×œ Service Worker');
      });
    }).catch(function (e) {
      _setBrowserActionsStatus('×©×’×™××” ×‘×‘×™×˜×•×œ Service Worker: ' + String((e && e.message) || e || 'unknown'));
    }).finally(function () {
      if (btn) btn.disabled = false;
    });
  } catch (e) {
    _setBrowserActionsStatus('×©×’×™××” ×‘×‘×™×˜×•×œ Service Worker');
    if (btn) btn.disabled = false;
  }
}

function runDiagnose() {
  var btn = document.getElementById('diagnoseBtn');
  var results = document.getElementById('diagnose-results');
  if (!btn || !results) return;

  btn.disabled = true;
  btn.textContent = '×‘×•×“×§...';
  results.style.display = 'none';
  results.innerHTML = '';

  fetch('/api/push/diagnose', { credentials: 'include' })
    .then(function (r) { return r.json(); })
    .then(function (data) {
      results.style.display = 'block';
      if (!data || !data.results || !(data.results instanceof Array)) {
        results.innerHTML = '<div style="color: var(--danger)">âŒ ×©×’×™××” ×‘×‘×“×™×§×”</div>';
        return;
      }
      var html = '<div style="display: grid; gap: 0.5rem">';
      for (var i = 0; i < data.results.length; i++) {
        var row = data.results[i] || {};
        var ok = !!row.ok;
        var icon = ok ? 'ğŸŸ¢' : 'ğŸ”´';
        var status = row.status || 0;
        var err = row.error ? (' (' + row.error + ')') : '';
        html += '<div><strong>' + String(row.name || 'unknown') + ':</strong> ' + icon + ' ' + String(row.url || '') + ' - Status: ' + String(status) + err + '</div>';
      }
      html += '</div>';
      results.innerHTML = html;
    })
    .catch(function (err) {
      results.style.display = 'block';
      results.innerHTML = '<div style="color: var(--danger)">âŒ ×©×’×™××”: ' + String((err && err.message) || err || 'unknown') + '</div>';
    })
    .finally(function () {
      btn.disabled = false;
      btn.textContent = '×”×¨×¥ ×‘×“×™×§×ª ×—×™×‘×•×¨×™×•×ª';
    });
}

function listSubscriptions() {
  var div = document.getElementById('subs-list');
  if (!div) return;
  div.innerHTML = '×˜×•×¢×Ÿ...';

  fetch('/api/push/subscriptions', { credentials: 'include' })
    .then(function (r) { return r.json(); })
    .then(function (data) {
      if (!data || !data.ok || !data.subscriptions) {
        div.innerHTML = '<div style="color: var(--danger)">×©×’×™××” ×‘×˜×¢×™× ×ª ×× ×•×™×™×</div>';
        return;
      }
      if (!data.count) {
        div.innerHTML = '<div>××™×Ÿ ×× ×•×™×™×</div>';
        return;
      }
      var subs = data.subscriptions;
      var html = '<div style="display: grid; gap: 0.5rem; margin-top: 0.5rem">';
      for (var i = 0; i < subs.length; i++) {
        var s = subs[i] || {};
        html += '<div class="glass-card" style="padding: 0.5rem; background: rgba(255,255,255,0.05)">';
        html += '<div><strong>Provider:</strong> ' + String(s.provider || 'unknown') + '</div>';
        html += '<div><strong>Created:</strong> ' + String(s.created_at || '×œ× ×™×“×•×¢') + '</div>';
        html += '<div><strong>Endpoint:</strong> ' + String(s.endpoint_preview || '') + '</div>';
        html += '</div>';
      }
      html += '</div>';
      div.innerHTML = html;
    })
    .catch(function (err) {
      div.innerHTML = '<div style="color: var(--danger)">âŒ ' + String((err && err.message) || err || 'unknown') + '</div>';
    });
}

function deleteAllSubs() {
  if (!confirm('×œ××—×•×§ ××ª ×›×œ ×”×× ×•×™×™×? ×ª×¦×˜×¨×š ×œ×”×™×¨×©× ××—×“×©.')) return;
  fetch('/api/push/subscriptions/delete-all', { method: 'DELETE', credentials: 'include' })
    .then(function (r) { return r.json(); })
    .then(function (data) {
      var msg = (data && (data.message || data.error)) || ('× ××—×§×• ' + String((data && data.deleted) || 0) + ' ×× ×•×™×™×');
      alert(msg);
      try { location.reload(); } catch (_) {}
    })
    .catch(function (err) {
      alert('×©×’×™××”: ' + String((err && err.message) || err || 'unknown'));
    });
}
</script>
{% endblock %}

