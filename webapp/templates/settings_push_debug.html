{% extends "base.html" %}

{% block title %}×“×™×‘×•×’ Web Push - Code Keeper Bot{% endblock %}

{% block content %}
<h1 class="page-title">
  <i class="fas fa-bug"></i>
  ×“×™×‘×•×’ Web Push
</h1>

<div class="glass-card">
  <h2 class="section-title">
    <i class="fas fa-server"></i>
    ×¡×˜×˜×•×¡ ×©×¨×ª
  </h2>
  <div class="glass-card" style="background: rgba(255, 255, 255, 0.05)">
    <div style="display: grid; grid-template-columns: 1fr; gap: 0.6rem">
      <div><strong>PUSH_NOTIFICATIONS_ENABLED:</strong> {{ 'ğŸŸ¢ true' if push_enabled else 'ğŸ”´ false' }}</div>
      <div><strong>VAPID_PUBLIC_KEY:</strong> {{ 'ğŸŸ¢ ××•×’×“×¨' if vapid_public_set else 'ğŸ”´ ×—×¡×¨' }}</div>
      <div><strong>VAPID_PRIVATE_KEY:</strong> {{ 'ğŸŸ¢ ××•×’×“×¨' if vapid_private_set else 'ğŸ”´ ×—×¡×¨' }}</div>
      <div><strong>PUSH_REMOTE_DELIVERY_ENABLED:</strong> {{ remote_enabled_env if remote_enabled_env else 'â€”' }}</div>
      <div><strong>PUSH_DELIVERY_URL:</strong> {{ remote_url if remote_url else 'â€”' }}</div>
      <div><strong>PUSH_DELIVERY_TOKEN:</strong> {{ 'ğŸŸ¢ ××•×’×“×¨' if remote_token_set else 'ğŸ”´ ×—×¡×¨' }}</div>
    </div>
  </div>
</div>

<div class="glass-card">
  <h2 class="section-title">
    <i class="fas fa-database"></i>
    ×× ×•×™×™× (DB)
  </h2>
  <div class="glass-card" style="background: rgba(255, 255, 255, 0.05)">
    {% if subs_error %}
      <div style="opacity: 0.9">ğŸ”´ ×©×’×™××” ×‘×§×¨×™××ª DB: {{ subs_error }}</div>
    {% else %}
      <div><strong>Subscriptions count (user):</strong> {{ subs_count }}</div>
      <div style="opacity: 0.85; margin-top: 0.5rem">
        ×× ×”××¡×¤×¨ 0 â€“ ××™×Ÿ ×× ×•×™ ×‘×“×¤×“×¤×Ÿ/××›×©×™×¨ ×”×–×” (××• ×©×”-Subscribe ×œ× × ×©×œ×— ×œ×©×¨×ª).
      </div>
    {% endif %}
  </div>
</div>

<div class="glass-card">
  <h2 class="section-title">
    <i class="fas fa-mobile-screen"></i>
    ×œ×§×•×— (××™×“×¢ ×›×œ×œ×™)
  </h2>
  <div class="glass-card" style="background: rgba(255, 255, 255, 0.05)">
    <div style="opacity: 0.9; word-break: break-word">
      <strong>User-Agent:</strong> {{ user_agent if user_agent else 'â€”' }}
    </div>
    <div style="opacity: 0.85; margin-top: 0.75rem">
      ×ª×–×›×•×¨×ª: ×‘-iOS ×”×ª×¨××•×ª Web Push ×‘×“×¤×“×¤×Ÿ ×¢×•×‘×“×•×ª ×¨×§ ×›×©××ª×§×™× ×™× ××ª ×”××ª×¨ ×›â€‘PWA (Add to Home Screen).
      ×‘-Telegram/Embedded WebView ×œ×¤×¢××™× ××™×Ÿ ×ª××™×›×” ×‘-ServiceWorker/PushManager.
    </div>
  </div>
</div>

<div class="glass-card">
  <h2 class="section-title">
    <i class="fas fa-vial"></i>
    ×‘×“×™×§×•×ª
  </h2>
  <div class="glass-card" style="background: rgba(255, 255, 255, 0.05)">
    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap">
      <form action="/settings/push-test" method="post" style="margin: 0">
        <button type="submit" class="btn btn-primary">
          ×©×œ×— ×¤×•×© ×‘×“×™×§×” (×©×¨×ª)
        </button>
      </form>
      <a href="/settings#push" class="btn btn-secondary">×—×–×¨×” ×œ×”×’×“×¨×•×ª</a>
    </div>
    <div style="opacity: 0.85; margin-top: 0.75rem">
      ×”×‘×“×™×§×” ×”×–×• ××—×–×™×¨×” JSON ×©×œ <code>/api/push/test</code>. ×× ××™×Ÿ ×× ×•×™×™× â€“ ×ª×§×‘×œ <code>no_subscriptions</code>.
    </div>
  </div>
</div>

<div class="glass-card">
  <h2 class="section-title">
    <i class="fas fa-desktop"></i>
    ×¡×˜×˜×•×¡ ×“×¤×“×¤×Ÿ (JavaScript)
  </h2>
  <div class="glass-card" style="background: rgba(255, 255, 255, 0.05)">
    <div id="browser-checks" style="display: grid; gap: 0.6rem">
      <div>×˜×•×¢×Ÿ ×‘×“×™×§×•×ª...</div>
    </div>
  </div>
</div>

<div class="glass-card">
  <h2 class="section-title">
    <i class="fas fa-plug"></i>
    ×‘×“×™×§×ª ×—×™×‘×•×¨×™×•×ª Push Services
  </h2>
  <div class="glass-card" style="background: rgba(255, 255, 255, 0.05)">
    <button id="diagnoseBtn" type="button" class="btn btn-secondary" onclick="runDiagnose()">
      ×”×¨×¥ ×‘×“×™×§×ª ×—×™×‘×•×¨×™×•×ª
    </button>
    <div id="diagnose-results" style="margin-top: 1rem; display: none"></div>
  </div>
</div>

<div class="glass-card">
  <h2 class="section-title">
    <i class="fas fa-list"></i>
    ×›×œ×™× × ×•×¡×¤×™×
  </h2>
  <div class="glass-card" style="background: rgba(255, 255, 255, 0.05)">
    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap">
      <button type="button" onclick="listSubscriptions()" class="btn btn-secondary">
        ×”×¦×’ ×× ×•×™×™×
      </button>
      <button type="button" onclick="deleteAllSubs()" class="btn btn-danger">
        ××—×§ ××ª ×›×œ ×”×× ×•×™×™×
      </button>
    </div>
    <div id="subs-list" style="margin-top: 1rem"></div>
  </div>
</div>

<script>
(function () {
  try {
    var checksDiv = document.getElementById('browser-checks');
    if (!checksDiv) return;

    var checks = [];
    function add(line) { checks.push(line); }
    function render() { checksDiv.innerHTML = checks.join(''); }

    // 1) Notification API
    var hasNotification = ('Notification' in window);
    var notifPerm = hasNotification ? String(Notification.permission || '') : 'not-supported';
    add('<div><strong>Notification API:</strong> ' + (hasNotification ? 'ğŸŸ¢ × ×ª××š' : 'ğŸ”´ ×œ× × ×ª××š') + ' (×”×¨×©××”: ' + notifPerm + ')</div>');

    // 2) Service Worker
    var hasSW = (typeof navigator !== 'undefined' && 'serviceWorker' in navigator);
    add('<div><strong>Service Worker:</strong> ' + (hasSW ? 'ğŸŸ¢ × ×ª××š' : 'ğŸ”´ ×œ× × ×ª××š') + '</div>');

    // 3) PushManager
    var hasPush = ('PushManager' in window);
    add('<div><strong>PushManager:</strong> ' + (hasPush ? 'ğŸŸ¢ × ×ª××š' : 'ğŸ”´ ×œ× × ×ª××š') + '</div>');

    // 4) HTTPS/Localhost
    var host = String(location.hostname || '');
    var isSecure = (location.protocol === 'https:') || (host === 'localhost') || (host === '127.0.0.1');
    add('<div><strong>×—×™×‘×•×¨ ×××•×‘×˜×— (HTTPS):</strong> ' + (isSecure ? 'ğŸŸ¢ ×›×Ÿ' : 'ğŸ”´ ×œ× (×“×¨×•×© HTTPS)') + '</div>');

    // If no permission yet - show CTA
    if (hasNotification && notifPerm === 'default') {
      add('<div style="margin-top: 1rem"><button type="button" onclick="requestNotificationPermission()" class="btn btn-primary">×‘×§×© ×”×¨×©××ª ×”×ª×¨××•×ª</button></div>');
    }

    // 5) SW registration + subscription
    if (!hasSW) {
      render();
      return;
    }

    navigator.serviceWorker.getRegistration().then(function (reg) {
      var hasReg = !!reg;
      add('<div><strong>Service Worker ×¨×©×•×:</strong> ' + (hasReg ? 'ğŸŸ¢ ×›×Ÿ' : 'ğŸŸ¡ ×œ× (×¢×“×™×™×Ÿ ×œ× × ×¨×©×)') + '</div>');
      if (!hasReg || !reg.pushManager) {
        render();
        return;
      }
      reg.pushManager.getSubscription().then(function (sub) {
        var hasSub = !!sub;
        add('<div><strong>×™×© ×× ×•×™ ×¤×¢×™×œ ×‘×“×¤×“×¤×Ÿ:</strong> ' + (hasSub ? 'ğŸŸ¢ ×›×Ÿ' : 'ğŸŸ¡ ×œ×') + '</div>');
        render();
      }).catch(function () {
        add('<div><strong>×™×© ×× ×•×™ ×¤×¢×™×œ ×‘×“×¤×“×¤×Ÿ:</strong> ğŸ”´ ×©×’×™××” ×‘×‘×“×™×§×”</div>');
        render();
      });
    }).catch(function () {
      add('<div><strong>Service Worker ×¨×©×•×:</strong> ğŸ”´ ×©×’×™××” ×‘×‘×“×™×§×”</div>');
      render();
    });
  } catch (e) {
    try {
      var el = document.getElementById('browser-checks');
      if (el) el.innerHTML = '<div>ğŸ”´ ×©×’×™××” ×‘×”×¨×¦×ª ×‘×“×™×§×•×ª ×“×¤×“×¤×Ÿ</div>';
    } catch (_) {}
  }
})();

function requestNotificationPermission() {
  try {
    if (!('Notification' in window)) {
      alert('×”×“×¤×“×¤×Ÿ ×œ× ×ª×•××š ×‘×”×ª×¨××•×ª');
      return;
    }
    Notification.requestPermission().then(function (perm) {
      alert('×”×¨×©××”: ' + perm);
      try { location.reload(); } catch (_) {}
    });
  } catch (_) {
    alert('×©×’×™××” ×‘×‘×§×©×ª ×”×¨×©××”');
  }
}

function runDiagnose() {
  var btn = document.getElementById('diagnoseBtn');
  var results = document.getElementById('diagnose-results');
  if (!btn || !results) return;

  btn.disabled = true;
  btn.textContent = '×‘×•×“×§...';
  results.style.display = 'none';
  results.innerHTML = '';

  fetch('/api/push/diagnose', { credentials: 'include' })
    .then(function (r) { return r.json(); })
    .then(function (data) {
      results.style.display = 'block';
      if (!data || !data.results || !(data.results instanceof Array)) {
        results.innerHTML = '<div style="color: var(--danger)">âŒ ×©×’×™××” ×‘×‘×“×™×§×”</div>';
        return;
      }
      var html = '<div style="display: grid; gap: 0.5rem">';
      for (var i = 0; i < data.results.length; i++) {
        var row = data.results[i] || {};
        var ok = !!row.ok;
        var icon = ok ? 'ğŸŸ¢' : 'ğŸ”´';
        var status = row.status || 0;
        var err = row.error ? (' (' + row.error + ')') : '';
        html += '<div><strong>' + String(row.name || 'unknown') + ':</strong> ' + icon + ' ' + String(row.url || '') + ' - Status: ' + String(status) + err + '</div>';
      }
      html += '</div>';
      results.innerHTML = html;
    })
    .catch(function (err) {
      results.style.display = 'block';
      results.innerHTML = '<div style="color: var(--danger)">âŒ ×©×’×™××”: ' + String((err && err.message) || err || 'unknown') + '</div>';
    })
    .finally(function () {
      btn.disabled = false;
      btn.textContent = '×”×¨×¥ ×‘×“×™×§×ª ×—×™×‘×•×¨×™×•×ª';
    });
}

function listSubscriptions() {
  var div = document.getElementById('subs-list');
  if (!div) return;
  div.innerHTML = '×˜×•×¢×Ÿ...';

  fetch('/api/push/subscriptions', { credentials: 'include' })
    .then(function (r) { return r.json(); })
    .then(function (data) {
      if (!data || !data.ok || !data.subscriptions) {
        div.innerHTML = '<div style="color: var(--danger)">×©×’×™××” ×‘×˜×¢×™× ×ª ×× ×•×™×™×</div>';
        return;
      }
      if (!data.count) {
        div.innerHTML = '<div>××™×Ÿ ×× ×•×™×™×</div>';
        return;
      }
      var subs = data.subscriptions;
      var html = '<div style="display: grid; gap: 0.5rem; margin-top: 0.5rem">';
      for (var i = 0; i < subs.length; i++) {
        var s = subs[i] || {};
        html += '<div class="glass-card" style="padding: 0.5rem; background: rgba(255,255,255,0.05)">';
        html += '<div><strong>Provider:</strong> ' + String(s.provider || 'unknown') + '</div>';
        html += '<div><strong>Created:</strong> ' + String(s.created_at || '×œ× ×™×“×•×¢') + '</div>';
        html += '<div><strong>Endpoint:</strong> ' + String(s.endpoint_preview || '') + '</div>';
        html += '</div>';
      }
      html += '</div>';
      div.innerHTML = html;
    })
    .catch(function (err) {
      div.innerHTML = '<div style="color: var(--danger)">âŒ ' + String((err && err.message) || err || 'unknown') + '</div>';
    });
}

function deleteAllSubs() {
  if (!confirm('×œ××—×•×§ ××ª ×›×œ ×”×× ×•×™×™×? ×ª×¦×˜×¨×š ×œ×”×™×¨×©× ××—×“×©.')) return;
  fetch('/api/push/subscriptions/delete-all', { method: 'DELETE', credentials: 'include' })
    .then(function (r) { return r.json(); })
    .then(function (data) {
      var msg = (data && (data.message || data.error)) || ('× ××—×§×• ' + String((data && data.deleted) || 0) + ' ×× ×•×™×™×');
      alert(msg);
      try { location.reload(); } catch (_) {}
    })
    .catch(function (err) {
      alert('×©×’×™××”: ' + String((err && err.message) || err || 'unknown'));
    });
}
</script>
{% endblock %}

