{% extends "base.html" %}

{% block title %}×”×¢×œ×” ×§×•×‘×¥ ×—×“×© - Code Keeper Bot{% endblock %}

{% from "components/editor_components.html" import image_uploader, code_tools_toolbar, code_tools_modal, markdown_toolbar %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/split-view.css') }}?v={{ static_version }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md_preview.bundle.css') }}?v={{ static_version }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/file-editor.css') }}?v={{ static_version }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/code-tools.css') }}?v={{ static_version }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/markdown-toolbar.css') }}?v={{ static_version }}">
{% endblock %}

{% block content %}
<h1 class="page-title">×”×¢×œ×” ×§×•×‘×¥ ×—×“×©</h1>

<div class="glass-card glass-card--file-form">
  {% if error %}
  <div class="alert alert-error">{{ error }}</div>
  {% endif %}
  {% if success %}
  <div class="alert alert-success">{{ success }}</div>
  {% endif %}

  {% set ffm_config = {
    "mode": "create",
    "fileId": none,
    "selectors": {
      "form": "#uploadForm",
      "editorContainer": "#editorContainer",
      "languageSelect": "#languageSelect",
      "filenameInput": "#fileNameInput",
      "imageExternalTrigger": "#externalImageTrigger",
      "imageUploadContainer": "#image-upload-widget",
      "sourceUrlContainer": "#source-url-group"
    },
    "initialData": {
      "language": (language_value or "text"),
      "existingImages": []
    }
  } %}

  <form id="uploadForm"
        method="post"
        enctype="multipart/form-data"
        data-file-form-config='{{ ffm_config | tojson }}'
        data-upload-success="{{ '1' if success else '0' }}"
        data-reset-draft="{{ '1' if clear_local_draft else '0' }}"
        style="display: grid; gap: 1rem;">
    <div>
      <label for="fileNameInput">×©× ×§×•×‘×¥</label>
      <div class="filename-input-wrapper">
        <input id="fileNameInput" type="text" name="file_name" placeholder="example.py" value="{{ file_name_value or '' }}" class="form-field">
        <button
          type="button"
          class="image-upload-trigger"
          id="externalImageTrigger"
          data-action="open-image-picker"
          title="×¦×¨×£ ×ª××•× ×”"
          aria-label="×¦×¨×£ ×ª××•× ×”"
          style="display: none;"
        >ğŸ–¼ï¸</button>
      </div>
      <small class="markdown-image-hint">
        × ×™×ª×Ÿ ×œ×¦×¨×£ ×ª××•× ×•×ª ×œ×§×‘×¦×™ Markdown (×¡×™×•××ª .md/.markdown ××• ×‘×—×™×¨×ª "Markdown" ×‘×©×¤×”).
      </small>
    </div>

    {{ image_uploader(existing_images=[]) }}
    <div>
      <label>×©×¤×”</label>
      <select id="languageSelect" name="language" class="form-field">
        <option value="text" {% if (language_value or 'text') == 'text' %}selected{% endif %}>×–×”×” ×œ×¤×™ ×¡×™×•××ª</option>
        {% for lang in languages %}
        <option value="{{ lang }}" {% if lang == language_value %}selected{% endif %}>{{ lang }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label>×ª×™××•×¨</label>
      <input type="text" name="description" placeholder="×ª×™××•×¨ ×§×¦×¨" value="{{ description_value or '' }}" class="form-field">
    </div>
    <div>
      <label>×ª×’×™×•×ª</label>
      <input type="text" name="tags" placeholder="#utils, #repo:owner/name" value="{{ tags_value or '' }}" class="form-field">
    </div>
    <!-- Code Tools toolbar (shared macro) -->
    {{ code_tools_toolbar(user_is_admin=user_is_admin) }}
    {{ markdown_toolbar() }}
    <div id="livePreviewRoot" class="split-view" data-active-panel="editor">
      <div class="split-toolbar">
        <div class="split-toolbar-controls">
          <button
            type="button"
            class="split-toggle"
            data-action="toggle-live-preview"
            aria-pressed="false"
          >
            <i class="fas fa-columns"></i>
            <span class="split-toggle__text">Live Preview</span>
          </button>
          <span class="split-toolbar-hint">Ctrl+Shift+Enter</span>
        </div>
        <div class="split-tabs" role="tablist" aria-label="×—×œ×•× ×•×ª ×ª×¦×•×’×”">
          <button type="button" role="tab" aria-selected="true" data-panel-target="editor">×¢×•×¨×š</button>
          <button type="button" role="tab" aria-selected="false" data-panel-target="preview">×ª×¦×•×’×”</button>
        </div>
      </div>
      <div class="split-panels">
        <section class="split-panel split-panel--editor" aria-label="××–×•×¨ ×¢×¨×™×›×”">
          <div id="editorContainer">
            <label for="codeTextarea">×§×•×“</label>
            <textarea id="codeTextarea" name="code" rows="18" placeholder="# ×”×“×‘×§ ×›××Ÿ ××ª ×”×§×•×“" class="form-field code-field">{{ code_value or '' }}</textarea>
          </div>
        </section>
        <div class="split-resizer" role="separator" aria-label="×©× ×” ××ª ×¨×•×—×‘ ×”×¤×× ×œ×™×"></div>
        <section class="split-panel split-panel--preview" aria-label="×ª×¦×•×’×” ×—×™×”">
          <div class="split-preview-content" data-preview-content aria-live="polite">
            <div class="split-preview-canvas" data-preview-canvas>
              <div class="split-preview-placeholder">
                <p>×ª×¦×•×’×” ×—×™×” ×ª×•×¤×™×¢ ×›××Ÿ</p>
                <small>×”×¤×¢×œ ××ª Live Preview ×›×“×™ ×œ×¨×¢× ×Ÿ ×‘×–××Ÿ ×××ª</small>
              </div>
            </div>
            <div class="split-preview-meta" data-preview-meta></div>
            <p class="split-preview-status" data-preview-status>×”×¤×¢×œ ××ª Live Preview ×›×“×™ ×œ×¨××•×ª ×¢×“×›×•×Ÿ ×‘×–××Ÿ ×××ª.</p>
          </div>
        </section>
      </div>
    </div>
    <div class="source-url-block" id="source-url-group">
      <button type="button"
              id="sourceUrlToggle"
              class="source-url-toggle"
              aria-expanded="{{ 'true' if source_url_value else 'false' }}"
              aria-controls="sourceUrlField"
              data-open-label="×”×¡×ª×¨ ×§×™×©×•×¨ ×œ××§×•×¨"
              data-closed-label="×”×•×¡×£ ×§×™×©×•×¨ ×œ××§×•×¨">
        <span class="source-url-toggle__icon">ğŸ”—</span>
        <span class="source-url-toggle__text">{{ '×”×¡×ª×¨ ×§×™×©×•×¨ ×œ××§×•×¨' if source_url_value else '×”×•×¡×£ ×§×™×©×•×¨ ×œ××§×•×¨' }}</span>
      </button>
      <div class="source-url-field{% if source_url_value %} is-open{% endif %}" id="sourceUrlField" data-open="{{ '1' if source_url_value else '0' }}">
        <label for="sourceUrlInput">×§×™×©×•×¨ ×œ××§×•×¨</label>
        <input type="url"
               name="source_url"
               id="sourceUrlInput"
               class="source-url-input"
               value="{{ source_url_value or '' }}"
               placeholder="https://github.com/..."
               inputmode="url"
               autocomplete="url">
        <small class="source-url-hint">×©××•×¨ ×§×™×©×•×¨ ×œ××§×•×¨ ×”×§×•×“ (StackOverflow, GitHub ×•×¢×•×“) ×›×“×™ ×œ×”×¦×™×’ ×§×¨×“×™×˜ ×•×”×§×©×¨.</small>
      </div>
      <input type="hidden" name="source_url_touched" id="sourceUrlTouched" value="{{ 'edited' if source_url_value else '0' }}">
    </div>
    <div>
      <label>××• ×”×¢×œ×” ×§×•×‘×¥</label>
      <input type="file" name="code_file" accept=".txt,.py,.js,.ts,.java,.c,.cpp,.cs,.go,.rs,.rb,.php,.swift,.kt,.html,.css,.sql,.sh,.yaml,.yml,.json,.xml,.md" style="width: 100%;">
      <small style="opacity:.8;">×× × ×‘×—×¨ ×§×•×‘×¥, ×”×ª×•×›×Ÿ ×™×§×¨× ××× ×• ×•×™×©×ª××© ×‘×©× ×”×§×•×‘×¥ ×œ×–×™×”×•×™ ×”×©×¤×”.</small>
    </div>
    <div class="save-actions">
      <div class="primary-actions">
        <button type="submit" class="btn btn-primary btn-icon"><i class="fas fa-upload"></i> ×©××•×¨</button>
        <a href="/files" class="btn btn-secondary btn-icon"><i class="fas fa-arrow-right"></i> ×‘×™×˜×•×œ</a>
      </div>
      <div class="draft-meta" aria-live="polite">
        <span id="draftSaveStatus" class="draft-status">×˜×™×•×˜×” ×˜×¨× × ×©××¨×”</span>
        <button type="button" id="clearDraftBtn" class="btn-clear-draft">× ×§×” ×˜×™×•×˜×”</button>
      </div>
    </div>
  </form>
</div>
<!-- Code Tools Bootstrap Modal (shared macro) -->
{{ code_tools_modal(user_is_admin=user_is_admin) }}
{% endblock %}
{% block extra_js %}
<script src="{{ url_for('static', filename='js/code-tools.js') }}?v={{ static_version }}" defer></script>
<script src="{{ url_for('static', filename='js/markdown-toolbar.js') }}?v={{ static_version }}" defer></script>
<script src="{{ url_for('static', filename='js/file-form-manager.js') }}?v={{ static_version }}" defer></script>
<script src="{{ url_for('static', filename='js/upload-page.js') }}?v={{ static_version }}" defer></script>
<script src="{{ url_for('static', filename='js/md_preview.bundle.js') }}?v={{ static_version }}" defer></script>
<script src="{{ url_for('static', filename='js/live-preview.js') }}?v={{ static_version }}" defer></script>
{% endblock %}

