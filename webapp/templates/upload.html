{% extends "base.html" %}

{% block title %}העלה קובץ חדש - Code Keeper Bot{% endblock %}

{% block content %}
<h1 class="page-title">העלה קובץ חדש</h1>

<div class="glass-card">
  {% if error %}
  <div class="alert alert-error">{{ error }}</div>
  {% endif %}
  {% if success %}
  <div class="alert alert-success">{{ success }}</div>
  {% endif %}

  <form id="uploadForm" method="post" enctype="multipart/form-data" style="display: grid; gap: 1rem;">
    <div>
      <label>שם קובץ</label>
      <input type="text" name="file_name" placeholder="example.py" value="{{ file_name_value or '' }}" style="width: 100%; padding: .75rem; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: white;">
    </div>
    <div>
      <label>שפה</label>
      <select id="languageSelect" name="language" style="width: 100%; padding: .75rem; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: white;">
        <option value="text" {% if (language_value or 'text') == 'text' %}selected{% endif %}>זהה לפי סיומת</option>
        {% for lang in languages %}
        <option value="{{ lang }}" {% if lang == language_value %}selected{% endif %}>{{ lang }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label>תיאור</label>
      <input type="text" name="description" placeholder="תיאור קצר" value="{{ description_value or '' }}" style="width: 100%; padding: .75rem; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: white;">
    </div>
    <div>
      <label>תגיות</label>
      <input type="text" name="tags" placeholder="#utils, #repo:owner/name" value="{{ tags_value or '' }}" style="width: 100%; padding: .75rem; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: white;">
    </div>
    <div id="editorContainer">
      <label>קוד</label>
      <textarea name="code" rows="14" placeholder="# הדבק כאן את הקוד" style="width: 100%; padding: .75rem; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: white; font-family: 'Fira Code', 'Consolas', monospace;">{{ code_value or '' }}</textarea>
    </div>
    <div>
      <label>או העלה קובץ</label>
      <input type="file" name="code_file" accept=".txt,.py,.js,.ts,.java,.c,.cpp,.cs,.go,.rs,.rb,.php,.swift,.kt,.html,.css,.sql,.sh,.yaml,.yml,.json,.xml,.md" style="width: 100%;">
      <small style="opacity:.8;">אם נבחר קובץ, התוכן יקרא ממנו וישתמש בשם הקובץ לזיהוי השפה.</small>
    </div>
    <div style="display: flex; gap: 1rem;">
      <button type="submit" class="btn btn-primary btn-icon"><i class="fas fa-upload"></i> שמור</button>
      <a href="/files" class="btn btn-secondary btn-icon"><i class="fas fa-arrow-right"></i> ביטול</a>
    </div>
  </form>
</div>
{% endblock %}
{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', async function () {
    try {
      const container = document.getElementById('editorContainer');
      const languageSelect = document.getElementById('languageSelect');
      const form = document.getElementById('uploadForm');
      const fileNameInput = document.querySelector('input[name="file_name"]');
      if (container && window.editorManager && typeof window.editorManager.initEditor === 'function') {
        await window.editorManager.initEditor(container, {
          language: (languageSelect && languageSelect.value) || 'text',
          value: {{ code_value | tojson }},
          theme: 'dark'
        });
      }
      if (languageSelect && window.editorManager && typeof window.editorManager.updateLanguage === 'function') {
        languageSelect.addEventListener('change', async (e) => {
          try { await window.editorManager.updateLanguage(e.target.value); } catch (_) {}
        });
      }

      // אישור דריסה אם שם הקובץ כבר קיים
      if (form && fileNameInput) {
        form.addEventListener('submit', async (e) => {
          try {
            // מנגנון מניעה מלולאת שליחה חוזרת
            if (form.dataset.skipConfirm === '1') {
              return;
            }

            const name = (fileNameInput.value || '').trim();
            if (!name) {
              return; // השרת יוודא שם ריק
            }

            e.preventDefault();
            const url = `/api/files/resolve?name=${encodeURIComponent(name)}`;
            const res = await fetch(url, { credentials: 'same-origin' });
            let exists = false;
            if (res && res.ok) {
              const data = await res.json().catch(() => ({}));
              exists = !!(data && data.ok);
            }
            if (exists) {
              const confirmed = window.confirm(`קובץ זה יחליף את קובץ ${name} — האם אתה בטוח?`);
              if (!confirmed) {
                return; // ביטול השמירה
              }
            }
            // המשך שליחה רגילה
            form.dataset.skipConfirm = '1';
            form.submit();
          } catch (_) {
            // במקרה של כשל בבדיקה – נמשיך לשליחה רגילה והשרת יטפל
            try { form.dataset.skipConfirm = '1'; } catch (_) {}
            try { form.submit(); } catch (_) {}
          }
        });
      }
    } catch (_) {}
  });
</script>
{% endblock %}

