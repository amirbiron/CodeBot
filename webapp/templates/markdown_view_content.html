<!-- Markdown specific CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
<link rel="stylesheet" href="/static/markdown-styles.css">

<style>
/* Markdown specific styles */
.markdown-content {
    line-height: 1.8;
    font-size: 1.05rem;
}

.markdown-content h1,
.markdown-content h2,
.markdown-content h3,
.markdown-content h4,
.markdown-content h5,
.markdown-content h6 {
    margin-top: 1.5em;
    margin-bottom: 0.5em;
    font-weight: 600;
    line-height: 1.25;
}

.markdown-content h1 {
    font-size: 2em;
    border-bottom: 2px solid rgba(255,255,255,0.1);
    padding-bottom: 0.3em;
}

.markdown-content h2 {
    font-size: 1.5em;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    padding-bottom: 0.3em;
}

.markdown-content h3 { font-size: 1.25em; }
.markdown-content h4 { font-size: 1em; }

.markdown-content p { margin-bottom: 1em; }

.markdown-content ul,
.markdown-content ol {
    padding-right: 2em;
    margin-bottom: 1em;
}

.markdown-content li { margin-bottom: 0.25em; }

/* Task Lists */
.markdown-content .task-list-item {
    list-style: none;
    position: relative;
    padding-right: 1.5em;
}

.markdown-content .task-list-item-checkbox {
    position: absolute;
    right: 0;
    top: 0.25em;
    cursor: pointer;
}

/* Code blocks */
.markdown-content code {
    background: rgba(110, 118, 129, 0.15);
    padding: 0.2em 0.4em;
    border-radius: 3px;
    font-family: 'Fira Code', 'Consolas', monospace;
    font-size: 0.85em;
}

.markdown-content pre {
    background: #282c34;
    color: #abb2bf;
    padding: 1rem;
    border-radius: 6px;
    overflow-x: auto;
    margin: 1em 0;
}

.markdown-content pre code {
    background: none;
    padding: 0;
}

/* Blockquotes */
.markdown-content blockquote {
    border-right: 4px solid var(--primary);
    padding: 0.5em 1em;
    margin: 1em 0;
    background: rgba(102, 126, 234, 0.05);
    border-radius: 0 5px 5px 0;
}

/* Tables */
.markdown-content table {
    border-collapse: collapse;
    width: 100%;
    margin: 1em 0;
}

.markdown-content th,
.markdown-content td {
    border: 1px solid rgba(255,255,255,0.1);
    padding: 0.6em 1em;
    text-align: right;
}

.markdown-content th {
    background: rgba(102, 126, 234, 0.1);
    font-weight: 600;
}

/* Images */
.markdown-content img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    margin: 1em 0;
}

/* Links */
.markdown-content a {
    color: var(--primary);
    text-decoration: none;
}

.markdown-content a:hover {
    text-decoration: underline;
}

/* View mode toggle */
.view-toggle {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.view-toggle button {
    padding: 0.5rem 1rem;
    border: 1px solid var(--border-color);
    background: transparent;
    color: var(--text-color);
    cursor: pointer;
    border-radius: 6px;
    transition: all 0.2s;
}

.view-toggle button.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}
</style>

<div class="file-header">
    <div class="file-info">
        <div class="file-title-row">
            <span class="file-icon">{{ file.icon }}</span>
            <div class="file-title-wrap">
                <h1 class="file-title">{{ file.file_name }}</h1>
                <div class="file-subrow">
                    <span class="badge">Markdown</span>
                    <span class="muted">专住 {{ file.version }}</span>
                </div>
            </div>
        </div>
        
        {% if file.description %}
        <p style="margin: 1rem 0; opacity: 0.9; font-size: 1.1rem;">{{ file.description }}</p>
        {% endif %}
        
        {% if file.tags %}
        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin: 1rem 0;">
            {% for tag in file.tags %}
            <span class="badge" style="background: rgba(102, 126, 234, 0.2); border-color: rgba(102, 126, 234, 0.4);">
                #{{ tag }}
            </span>
            {% endfor %}
        </div>
        {% endif %}
    </div>
    
    <div class="file-actions">
        <div class="view-toggle">
            <button id="btnRender" class="active" onclick="toggleView('render')">
                 转爪 注爪转
            </button>
            <button id="btnSource" onclick="toggleView('source')">
                <i class="fas fa-code"></i> 拽 拽专
            </button>
        </div>
        
        <a href="/edit/{{ file.id }}" class="btn btn-primary btn-icon">
            <i class="fas fa-edit"></i>
            注专
        </a>
        <button onclick="copyCode()" class="btn btn-primary btn-icon copy-button">
            <i class="fas fa-copy"></i>
            注转拽
            <div class="copy-feedback" id="copyFeedback">注转拽!</div>
        </button>
        <a href="/html/{{ file.id }}" class="btn btn-secondary btn-icon">
             转爪转 驻驻
        </a>
        <a href="/download/{{ file.id }}" class="btn btn-secondary btn-icon">
            <i class="fas fa-download"></i>
            专
        </a>
        <a href="#" onclick="return goBack(event)" class="btn btn-secondary btn-icon">
            <i class="fas fa-arrow-right"></i>
            专
        </a>
    </div>
</div>

<!-- Markdown Stats -->
<div class="file-meta glass-card">
    <div class="meta-item">
        <div class="meta-label"><i class="fas fa-weight"></i> </div>
        <div class="meta-value">{{ file.size }}</div>
    </div>
    <div class="meta-item">
        <div class="meta-label"><i class="fas fa-list-ol"></i> 砖专转</div>
        <div class="meta-value">{{ file.lines }}</div>
    </div>
    <div class="meta-item">
        <div class="meta-label"><i class="fas fa-calendar-plus"></i> 爪专</div>
        <div class="meta-value">{{ file.created_at }}</div>
    </div>
    <div class="meta-item">
        <div class="meta-label"><i class="fas fa-calendar-check"></i> 注</div>
        <div class="meta-value">{{ file.updated_at }}</div>
    </div>
</div>

<!-- Markdown Content -->
<div id="renderView" class="glass-card">
    <h2 class="section-title">
        <i class="fas fa-eye"></i>
        转爪 注爪转
    </h2>
    <div class="markdown-content">
        {{ markdown_html|safe }}
    </div>
</div>

<!-- Source Code View (hidden by default) -->
<div id="sourceView" class="glass-card" style="display: none;">
    <h2 class="section-title">
        <i class="fas fa-code"></i>
        拽 拽专
    </h2>
    <div class="code-container">
        {{ highlighted_code|safe }}
    </div>
</div>

<!-- Hidden raw code for copying -->
<textarea id="rawCode" style="position: absolute; left: -9999px; height: 0; opacity: 0;">{{ raw_code }}</textarea>

<!-- File ID for task sync -->
<div data-file-id="{{ file.id }}" style="display: none;"></div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
<script src="/static/markdown-enhancements.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>

<script>
// Initialize on load
document.addEventListener('DOMContentLoaded', function() {
    // Render math if present
    {% if has_math %}
    if (typeof renderMathInElement !== 'undefined') {
        renderMathInElement(document.querySelector('.markdown-content'), {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false},
                {left: '\\[', right: '\\]', display: true},
                {left: '\\(', right: '\\)', display: false}
            ],
            throwOnError: false
        });
    }
    {% endif %}
    
    // Render Mermaid diagrams
    {% if has_mermaid %}
    if (typeof mermaid !== 'undefined') {
        mermaid.initialize({ startOnLoad: true, theme: 'default' });
        document.querySelectorAll('.mermaid-diagram').forEach(function(elem) {
            const code = elem.getAttribute('data-mermaid');
            if (code) {
                elem.innerHTML = '';
                const graphDiv = document.createElement('div');
                graphDiv.className = 'mermaid';
                graphDiv.textContent = code;
                elem.appendChild(graphDiv);
            }
        });
        mermaid.init();
    }
    {% endif %}
    
    // Syntax highlighting
    if (typeof Prism !== 'undefined') {
        Prism.highlightAll();
    }
    
    // Interactive task lists
    {% if has_tasks %}
    document.querySelectorAll('.task-list-item-checkbox').forEach(function(checkbox) {
        const taskId = checkbox.getAttribute('data-task-id');
        if (taskId) {
            // Restore state from localStorage
            const saved = localStorage.getItem('task-' + taskId);
            if (saved !== null) {
                checkbox.checked = saved === '1';
            }
            
            // Save state on change
            checkbox.addEventListener('change', function() {
                localStorage.setItem('task-' + taskId, this.checked ? '1' : '0');
            });
        }
    });
    {% endif %}
});

// Toggle between render and source view
function toggleView(view) {
    const renderView = document.getElementById('renderView');
    const sourceView = document.getElementById('sourceView');
    const btnRender = document.getElementById('btnRender');
    const btnSource = document.getElementById('btnSource');
    
    if (view === 'render') {
        renderView.style.display = 'block';
        sourceView.style.display = 'none';
        btnRender.classList.add('active');
        btnSource.classList.remove('active');
    } else {
        renderView.style.display = 'none';
        sourceView.style.display = 'block';
        btnRender.classList.remove('active');
        btnSource.classList.add('active');
    }
}

// Copy code function
function copyCode() {
    const rawArea = document.getElementById('rawCode');
    if (rawArea) {
        navigator.clipboard.writeText(rawArea.value).then(() => {
            const feedback = document.getElementById('copyFeedback');
            feedback.classList.add('show');
            setTimeout(() => {
                feedback.classList.remove('show');
            }, 2000);
        }).catch(err => {
            console.error('Failed to copy:', err);
            alert(' 爪 注转拽 转 拽');
        });
    }
}

// Go back function
function goBack(ev) {
    if (ev) ev.preventDefault();
    if (window.history && window.history.length > 1) {
        window.history.back();
    } else {
        window.location.href = '/files';
    }
    return false;
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl+M - toggle view
    if ((e.ctrlKey || e.metaKey) && e.key === 'm') {
        e.preventDefault();
        const currentView = document.getElementById('renderView').style.display !== 'none' ? 'source' : 'render';
        toggleView(currentView === 'render' ? 'source' : 'render');
    }
    
    // Ctrl+C - copy
    if ((e.ctrlKey || e.metaKey) && e.key === 'c' && !window.getSelection().toString()) {
        e.preventDefault();
        copyCode();
    }
    
    // Escape - go back
    if (e.key === 'Escape') {
        goBack();
    }
});
</script>