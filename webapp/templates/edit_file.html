{% extends "base.html" %}

{% block title %}×¢×¨×™×›×ª {{ file.file_name }} - Code Keeper Bot{% endblock %}

{% from "components/editor_components.html" import image_uploader, code_tools_toolbar, code_tools_modal, markdown_toolbar %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/split-view.css') }}?v={{ static_version }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md_preview.bundle.css') }}?v={{ static_version }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/file-editor.css') }}?v={{ static_version }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/code-tools.css') }}?v={{ static_version }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/markdown-toolbar.css') }}?v={{ static_version }}">
{% endblock %}

{% block content %}
<h1 class="page-title">×¢×¨×™×›×ª ×§×•×‘×¥</h1>

<div class="glass-card">
  {% if error %}
  <div class="alert alert-error">{{ error }}</div>
  {% endif %}
  {% if success %}
  <div class="alert alert-success">{{ success }}</div>
  {% endif %}

  {% set ffm_config = {
    "mode": "edit",
    "fileId": (file.id or none),
    "selectors": {
      "form": "#editForm",
      "editorContainer": "#editorContainer",
      "languageSelect": "#languageSelect",
      "filenameInput": "#fileNameInput",
      "imageExternalTrigger": "#externalImageTrigger",
      "imageUploadContainer": "#image-upload-widget",
      "sourceUrlContainer": "#source-url-group"
    },
    "initialData": {
      "language": (file.language or "text"),
      "existingImages": (existing_images or [])
    }
  } %}

  <form id="editForm"
        class="file-edit-form"
        method="post"
        enctype="multipart/form-data"
        data-edit-file-id="{{ file.id }}"
        data-file-form-config='{{ ffm_config | tojson }}'
        style="display: grid; gap: 1rem;">
    <div>
      <label for="fileNameInput">×©× ×§×•×‘×¥</label>
      <div class="filename-input-wrapper">
        <input id="fileNameInput" type="text" name="file_name" value="{{ file.file_name }}" class="form-field">
        <button
          type="button"
          class="image-upload-trigger"
          id="externalImageTrigger"
          data-action="open-image-picker"
          title="×¦×¨×£ ×ª××•× ×”"
          aria-label="×¦×¨×£ ×ª××•× ×”"
          style="display: none;"
        >ğŸ–¼ï¸</button>
      </div>
      <small class="markdown-image-hint">
        × ×™×ª×Ÿ ×œ×¦×¨×£ ×ª××•× ×•×ª ×œ×§×‘×¦×™ Markdown (×¡×™×•××ª .md/.markdown ××• ×‘×—×™×¨×ª "Markdown" ×‘×©×¤×”).
      </small>
    </div>

    {{ image_uploader(existing_images=existing_images or []) }}
    <div>
      <label>×©×¤×”</label>
      <select id="languageSelect" name="language" class="form-field">
        <option value="{{ file.language }}">â€” {{ file.language }} (× ×•×›×—×™×ª) â€”</option>
        <option value="text">×–×”×” ×œ×¤×™ ×¡×™×•××ª/×ª×•×›×Ÿ</option>
        {% for lang in languages %}
        <option value="{{ lang }}">{{ lang }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label>×ª×™××•×¨</label>
      <input type="text" name="description" value="{{ file.description }}" class="form-field">
    </div>
    <div>
      <label>×ª×’×™×•×ª</label>
      <input type="text" name="tags" value="{{ file.tags | join(', ') }}" placeholder="#utils, #repo:owner/name" class="form-field">
    </div>
    <!-- Code Tools toolbar (shared macro) -->
    {{ code_tools_toolbar(user_is_admin=user_is_admin) }}
    {{ markdown_toolbar() }}
    <div id="livePreviewRoot" class="split-view" data-active-panel="editor">
      <div class="split-toolbar">
        <div class="split-toolbar-controls">
          <button
            type="button"
            class="split-toggle"
            data-action="toggle-live-preview"
            aria-pressed="false"
          >
            <i class="fas fa-columns"></i>
            <span class="split-toggle__text">Live Preview</span>
          </button>
          <span class="split-toolbar-hint">Ctrl+Shift+Enter</span>
        </div>
        <div class="split-tabs" role="tablist" aria-label="×—×œ×•× ×•×ª ×ª×¦×•×’×”">
          <button type="button" role="tab" aria-selected="true" data-panel-target="editor">×¢×•×¨×š</button>
          <button type="button" role="tab" aria-selected="false" data-panel-target="preview">×ª×¦×•×’×”</button>
        </div>
      </div>
      <div class="split-panels">
        <section class="split-panel split-panel--editor" aria-label="××–×•×¨ ×¢×¨×™×›×”">
          <div id="editorContainer">
            <label for="codeTextarea">×§×•×“</label>
            <textarea id="codeTextarea" name="code" rows="18" class="form-field code-field">{{ code_value }}</textarea>
          </div>
        </section>
        <div class="split-resizer" role="separator" aria-label="×©× ×” ××ª ×¨×•×—×‘ ×”×¤×× ×œ×™×"></div>
        <section class="split-panel split-panel--preview" aria-label="×ª×¦×•×’×” ×—×™×”">
          <div class="split-preview-content" data-preview-content aria-live="polite">
            <div class="split-preview-canvas" data-preview-canvas>
              <div class="split-preview-placeholder">
                <p>×ª×¦×•×’×” ×—×™×” ×ª×•×¤×™×¢ ×›××Ÿ</p>
                <small>×”×¤×¢×œ ××ª Live Preview ×›×“×™ ×œ×¨×¢× ×Ÿ ×‘×–××Ÿ ×××ª</small>
              </div>
            </div>
            <div class="split-preview-meta" data-preview-meta></div>
            <p class="split-preview-status" data-preview-status>×”×¤×¢×œ ××ª Live Preview ×›×“×™ ×œ×¨××•×ª ×¢×“×›×•×Ÿ ×‘×–××Ÿ ×××ª.</p>
          </div>
        </section>
      </div>
    </div>
    <div class="source-url-block" id="source-url-group">
      <button type="button"
              id="sourceUrlToggle"
              class="source-url-toggle"
              aria-expanded="{{ 'true' if file.source_url else 'false' }}"
              aria-controls="sourceUrlField"
              data-open-label="×”×¡×ª×¨ ×§×™×©×•×¨ ×œ××§×•×¨"
              data-closed-label="×”×•×¡×£ ×§×™×©×•×¨ ×œ××§×•×¨">
        <span class="source-url-toggle__icon">ğŸ”—</span>
        <span class="source-url-toggle__text">{{ '×”×¡×ª×¨ ×§×™×©×•×¨ ×œ××§×•×¨' if file.source_url else '×”×•×¡×£ ×§×™×©×•×¨ ×œ××§×•×¨' }}</span>
      </button>
      <div class="source-url-field{% if file.source_url %} is-open{% endif %}" id="sourceUrlField" data-open="{{ '1' if file.source_url else '0' }}">
        <label for="sourceUrlInput">×§×™×©×•×¨ ×œ××§×•×¨</label>
        <input type="url"
               name="source_url"
               id="sourceUrlInput"
               class="source-url-input"
               value="{{ file.source_url or '' }}"
               placeholder="https://github.com/..."
               inputmode="url"
               autocomplete="url">
        <small class="source-url-hint">×©××•×¨ ×§×™×©×•×¨ ×œ××§×•×¨ ×”×§×•×“ (GitHub, StackOverflow ×•×›×•×³) ×›×“×™ ×œ×–×›×•×¨ ××ª ×”×”×©×¨××”.</small>
      </div>
      <input type="hidden" name="source_url_touched" id="sourceUrlTouched" value="{{ 'edited' if file.source_url else '0' }}">
    </div>
    <div class="save-actions">
      <div class="primary-actions">
        <button type="submit" class="btn btn-primary btn-icon"><i class="fas fa-save"></i> {% if file.is_large %}×©××•×¨{% else %}×©××•×¨ ×’×¨×¡×” ×—×“×©×”{% endif %}</button>
        <a href="/file/{{ file.id }}" class="btn btn-secondary btn-icon"><i class="fas fa-times"></i> ×‘×™×˜×•×œ</a>
      </div>
      <div class="draft-meta" aria-live="polite">
        <span id="editDraftStatus" class="draft-status">×˜×™×•×˜×” ×˜×¨× × ×©××¨×”</span>
        <button type="button" id="restoreEditDraftBtn" class="btn-clear-draft" hidden>×©×—×–×¨ ×˜×™×•×˜×”</button>
        <button type="button" id="discardEditDraftBtn" class="btn-clear-draft">× ×§×” ×˜×™×•×˜×”</button>
      </div>
    </div>
  </form>
</div>

<!-- Code Tools Bootstrap Modal (shared macro) -->
{{ code_tools_modal(user_is_admin=user_is_admin) }}
{% endblock %}
{% block extra_js %}
<script src="{{ url_for('static', filename='js/code-tools.js') }}?v={{ static_version }}" defer></script>
<script src="{{ url_for('static', filename='js/markdown-toolbar.js') }}?v={{ static_version }}" defer></script>
<script src="{{ url_for('static', filename='js/file-form-manager.js') }}?v={{ static_version }}" defer></script>
<script src="{{ url_for('static', filename='js/edit-draft.js') }}?v={{ static_version }}" defer></script>
<script src="{{ url_for('static', filename='js/md_preview.bundle.js') }}?v={{ static_version }}" defer></script>
<script src="{{ url_for('static', filename='js/live-preview.js') }}?v={{ static_version }}" defer></script>
{% endblock %}


