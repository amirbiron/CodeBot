{% extends "base.html" %}

{% block title %}{{ file.file_name }} - Markdown Preview{% endblock %}

{% block extra_css %}
<style>
/* אזור התצוגה והביצועים */
#md-root {
  /* הרחבת אזור התוכן הלבן לצדדים והרחקה מהשוליים הסגולים */
  max-width: min(1600px, 100vw);
  margin: 0 auto;
  padding: 0.5rem 0; /* את הריווח הצדדי ניתן דרך הכרטיס הפנימי */
}
#md-content {
  background: #ffffff;
  color: #111111;
  border-radius: 12px;
  border: none; /* ביטול מסגרת (שנתפסה כ"סגולה") */
  padding: 14px; /* ריווח אחיד ועדין – לא מרחיק את הבלוק מהגבול */
  font-size: 16px;
  line-height: 1.6; /* שיפור קריאות */
}
/* במסך מלא – לאפשר גלילה בתוך הכרטיס עצמו (תמיכה גם ב-WebKit) */
#mdCard:fullscreen { height: 100vh; overflow: auto; }
#mdCard:-webkit-full-screen { height: 100vh; overflow: auto; }
#md-content img {
  max-width: 100%;
  height: auto;
}
/* הרחבת הקונטיינר בעמוד Markdown כדי לצמצם את הסגול בצדדים */
.main-content > .container {
  /* מכולה רחבה כדי לצמצם "סגול" בצדדים */
  max-width: 100% !important;
  width: 100% !important;
  padding-left: 8px !important;
  padding-right: 8px !important;
}
/* בעמוד Markdown בלבד: צמצום הפס הסגול משמאל – מרחיבים את הכרטיס שמאלה */
.main-content .glass-card {
  margin-left: 0 !important;        /* שמאל קרוב יותר לקצה */
  margin-right: 0.5rem !important;  /* שומרים על ימין קיים */
  width: calc(100% - 0.5rem) !important;
}
/* טבלאות בסגנון GitHub */
#md-content table {
  width: 100%;
  border-collapse: collapse;
  overflow: auto;
  display: block;
}
#md-content table th, #md-content table td {
  border: 1px solid #e5e7eb;
  padding: 0.5rem 0.75rem;
}
#md-content table thead {
  background: #f8fafc;
}
/* קוד (fenced) */
#md-content pre code,
#md-content pre > code,
#md-content code.hljs {
  display: block;
  /* נשמור על ריווח מינימלי בתוך תגית הקוד עצמה – דק שלא יבטל הדגשות */
  padding: 0 2px 0 0;            /* תוספת עדינה מימין ב-RTL */
  border-radius: 8px;
  font-family: 'Fira Code', 'Consolas', monospace;
  font-size: 16px;               /* נגישות טובה יותר */
  line-height: 1.5;              /* רווח אנכי טוב */
  /* גלילה אופקית במקום עטיפה – כדי לא לחתוך קוד ארוך */
  white-space: pre !important;
  word-break: normal !important;
  overflow-wrap: normal !important;
}
#md-content .md-highlight {
  background: linear-gradient(90deg, #ffd700 0%, #ffed4e 100%);
  color: #000;
  padding: 2px 4px;
  border-radius: 3px;
  font-weight: 600;
}
#md-content pre { overflow-x: auto; max-width: 100%; margin: 1rem 0; width: 100%; }
#md-content .hljs { overflow-x: auto; display: block; }
#md-content pre {
  background: linear-gradient(135deg, #1a2332 0%, #243447 100%);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 12px;
  padding: 16px;                    /* בסיס */
  /* ריווח פנימי סימטרי בתוך הבלוק – כדי שהקוד לא ייגע בגבולות */
  padding-right: clamp(22px, 6vw, 36px);
  padding-left: clamp(22px, 6vw, 36px);
  box-shadow: 0 8px 24px rgba(0,0,0,0.3);
  overflow-x: auto;
  margin: 1.5em 0;
  width: 100%;                      /* מילוי רוחב הכרטיס, ללא גלישה */
  color: #e8eaed;                   /* Fallback: טקסט בהיר אם hljs לא נטען */
  box-sizing: border-box;
  position: relative;
  /* אופטימיזציה לאנימציות */
  will-change: transform;
}
#md-content pre code {
  display: block;
  overflow-x: auto;
  /* ריווח עדין בתוך תגית הקוד עצמה */
  padding: 0 2px;
}
#md-content {
  /* לא נחסום גלישה כדי שלא ייחתכו מספרים/תווים מחוץ לקופסה (למשל ברשימות) */
  overflow: visible;
}
/* מניעת גלישה אופקית של טקסט מחוץ לקוד/inline-code */
#md-content p, #md-content li, #md-content blockquote {
  overflow-wrap: anywhere;
  word-break: break-word;
}
/* מרווח נעים בין פסקאות */
#md-content p { 
  margin: 1rem 0;
  text-align: justify;
  hyphens: auto;
}

/* הדגשות ותגיות סמנטיות */
#md-content strong {
  font-weight: 600;
  color: #1a202c;
}

#md-content em {
  font-style: italic;
  color: #2d3748;
}

#md-content mark {
  background: linear-gradient(90deg, #ffd700 0%, #ffed4e 100%);
  color: #000;
  padding: 2px 4px;
  border-radius: 3px;
  font-weight: 500;
}

/* קווי הפרדה */
#md-content hr {
  border: none;
  height: 2px;
  background: linear-gradient(90deg, transparent, #cbd5e1, transparent);
  margin: 2rem 0;
}
/* ריווח ברור סביב כותרות משנה כדי למנוע הדבקה לטקסט שלפניהן/אחריהן */
#md-content h2, #md-content h3, #md-content h4 {
  margin-top: 1.25rem;
  margin-bottom: 0.75rem;
}
/* ברשימות ממוספרות/תבליטים ב-RTL המספר/סמל יישב בתוך הבלוק, לא מחוצה לו */
#md-content ol, #md-content ul {
  /* הצגת התבליט/מספור מחוץ לבלוק כדי ליצור הזחה טבעית */
  list-style-position: outside;
  /* ריווח תחתון כדי שלא יידבקו לכותרת/פסקה הבאה */
  margin-block: 0 1rem;
  /* הזחה בצד ההתחלה (RTL: ימין) */
  padding-inline-start: 1.25rem;
}
/* רווח עדין בין פריטי רשימה */
#md-content li { margin: 0.25rem 0; }
/* רשימות מקוננות – מעט רווח מעל/מתחת */
#md-content li > ul, #md-content li > ol { margin-block: 0.25rem 0.5rem; }
#md-content .code-block { position: relative; margin: 1rem 0; }
#md-content .code-block pre {
  margin: 0;
  /* ריווח סימטרי בתוך הבלוק עצמו – לא משפיע על המיקום של הבלוק בדף */
  padding: 16px;
  padding-right: clamp(22px, 6vw, 36px);
  padding-left: clamp(22px, 6vw, 36px);
  padding-top: 2.6rem;           /* מקום לשורת כפתורים עליונה */
  box-sizing: border-box;
}
#md-content .md-copy-btn {
  position: absolute;
  top: 12px;
  left: 12px;
  padding: 8px 10px;
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s ease;
  backdrop-filter: blur(8px);
  z-index: 2;
}
#md-content .md-copy-btn:hover {
  background: rgba(255, 255, 255, 0.2);
  border-color: rgba(255, 255, 255, 0.4);
}
#md-content .md-copy-btn.copied {
  background: rgba(76, 175, 80, 0.3);
  border-color: rgba(76, 175, 80, 0.6);
}
#md-content .md-copy-btn.copy-error {
  background: rgba(220, 38, 38, 0.25);
  border-color: rgba(220, 38, 38, 0.55);
}
#md-content .md-copy-btn::before {
  content: "";
  display: inline-block;
  width: 16px;
  height: 16px;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2'%3E%3Crect x='9' y='9' width='13' height='13' rx='2'/%3E%3Cpath d='M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1'/%3E%3C/svg%3E");
  background-size: contain;
  background-repeat: no-repeat;
  vertical-align: middle;
}
#md-content code:not(pre code) {
  background: linear-gradient(135deg, #f1f3f5 0%, #e9ecef 100%);
  color: #24292e;                 /* כהה אך לא שחור מלא */
  border: 1px solid #dee2e6;
  padding: 0.2em 0.5em;
  border-radius: 4px;
  font-family: 'Fira Code', 'Consolas', monospace;
  font-size: 0.9em;
  font-weight: 500;
  white-space: nowrap;
}
/* חיווי למופע פעיל בחיפוש */
#md-content .md-highlight.is-active {
  outline: 2px solid #ffd700;
  outline-offset: 1px;
}
/* ציטוטים - מודרנזציה נוספת */
#md-content > blockquote {
  position: relative;
  quotes: "“" "”" "‘" "’";
}

#md-content > blockquote::before {
  content: open-quote;
  position: absolute;
  top: -10px;
  right: 10px;
  font-size: 3em;
  color: rgba(108, 117, 125, 0.2);
  font-family: Georgia, serif;
}
/* שם קובץ ארוך – מניעת חריגה במסגרת הכותרת */
#md-file-name-wrap { min-width: 0; }
#md-file-name {
  margin: 0;
  font-size: 1.6rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
  display: block;
}
/* רשימות משימות */
input.md-task-checkbox {
  margin-inline-end: .5rem;
  transform: scale(1.1);
  cursor: pointer;
}

/* תוכן עניינים צף */
.md-toc {
  position: fixed;
  top: 100px;
  left: 20px;
  max-width: 250px;
  max-height: 70vh;
  overflow-y: auto;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  border-radius: 8px;
  padding: 1rem;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  z-index: 100;
  display: none; /* מוסתר בברירת מחדל */
}

.md-toc.show {
  display: block;
}

.md-toc h3 {
  margin: 0 0 0.5rem 0;
  font-size: 1rem;
  color: #2d3748;
}

.md-toc ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

.md-toc li {
  margin: 0.25rem 0;
}

.md-toc a {
  color: #4a5568;
  text-decoration: none;
  font-size: 0.9rem;
  transition: color 0.2s;
}

.md-toc a:hover {
  color: var(--primary);
}

.md-toc a.active {
  color: var(--primary);
  font-weight: 600;
}

/* הסתרת TOC במסכים קטנים */
@media (max-width: 1024px) {
  .md-toc {
    display: none !important;
  }
}

/* שיפורים ויזואליים חדשים */

/* כותרות משופרות */
#md-content h1 {
  font-size: 2.2em;
  margin-top: 1.5em;
  margin-bottom: 0.5em;
  font-weight: 700;
  border-bottom: 3px solid #e1e4e8;
  padding-bottom: 0.3em;
}

#md-content h2 {
  font-size: 1.8em;
  margin-top: 1.3em;
  margin-bottom: 0.5em;
  font-weight: 600;
  border-bottom: 2px solid #e1e4e8;
  padding-bottom: 0.3em;
}

#md-content h3 {
  font-size: 1.4em;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  font-weight: 600;
}

#md-content h4 {
  font-size: 1.2em;
  margin-top: 1em;
  margin-bottom: 0.4em;
  font-weight: 600;
}

/* קישורים משופרים */
#md-content a {
  color: #0366d6;
  text-decoration: none;
  border-bottom: 1px solid transparent;
  transition: border-color 0.2s ease, color 0.2s ease;
}

#md-content a:hover {
  color: #0256c7;
  border-bottom-color: #0366d6;
}

/* בלוקים מצוטטים משודרגים */
#md-content blockquote {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-inline-start: 5px solid #6c757d;
  margin: 1.5em 0;
  padding: 1em 1.5em;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  font-style: italic;
}

#md-content blockquote p:first-child {
  margin-top: 0;
}

#md-content blockquote p:last-child {
  margin-bottom: 0;
}

/* רשימות משופרות */
#md-content ul, #md-content ol {
  padding-inline-start: 2em;
  margin: 1em 0;
}

#md-content li {
  margin: 0.5em 0;
  line-height: 1.6;
}

#md-content li::marker {
  color: var(--primary, #667eea);
  font-weight: 600;
}

/* טבלאות מודרניות */
#md-content table {
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  margin: 1.5em 0;
}

#md-content table thead {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

#md-content table th {
  font-weight: 600;
  padding: 0.75rem 1rem;
  text-align: right;
  border: none;
}

#md-content table td {
  padding: 0.65rem 1rem;
  border-bottom: 1px solid #e5e7eb;
}

#md-content table tbody tr:last-child td {
  border-bottom: none;
}

#md-content table tbody tr:nth-child(even) {
  background: #f8f9fa;
}

#md-content table tbody tr:hover {
  background: #e9ecef;
  transition: background 0.2s ease;
}

/* כפתור העתקה משופר */
#md-content .md-copy-btn {
  background: rgba(255, 255, 255, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.25);
  color: #fff;
  font-size: 0.85rem;
  font-weight: 500;
  backdrop-filter: blur(10px);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

#md-content .md-copy-btn:hover {
  background: rgba(255, 255, 255, 0.25);
  border-color: rgba(255, 255, 255, 0.4);
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

/* תווית שפה לבלוקי קוד */
.code-block[data-language]::before {
  content: attr(data-language);
  position: absolute;
  top: 8px;
  right: 12px;
  padding: 4px 8px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 4px;
  font-size: 0.75rem;
  color: rgba(255, 255, 255, 0.7);
  font-family: 'Heebo', sans-serif;
  z-index: 1;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* מספרי שורות (אופציונלי) */
.code-block.line-numbers pre {
  padding-right: 3.5em !important;
  position: relative;
  counter-reset: line-number;
}

.code-block.line-numbers pre code .line::before {
  counter-increment: line-number;
  content: counter(line-number);
  display: inline-block;
  width: 2.5em;
  margin-inline-end: 0.5em;
  text-align: left;
  color: rgba(255, 255, 255, 0.3);
  user-select: none;
}

/* אנימציות כניסה */
#md-content > * {
  animation: fadeIn 0.4s ease-out;
  animation-fill-mode: backwards;
}

#md-content > *:nth-child(1) { animation-delay: 0.05s; }
#md-content > *:nth-child(2) { animation-delay: 0.1s; }
#md-content > *:nth-child(3) { animation-delay: 0.15s; }
#md-content > *:nth-child(4) { animation-delay: 0.2s; }
#md-content > *:nth-child(5) { animation-delay: 0.25s; }

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* הפחתת אנימציה למשתמשים שמעדיפים תנועה מופחתת */
@media (prefers-reduced-motion: reduce) {
  #md-content > * {
    animation: none;
  }
}

/* שיפורי נגישות - focus states */
#md-content a:focus,
#md-content button:focus {
  outline: 2px solid var(--primary, #667eea);
  outline-offset: 2px;
}

/* תמיכה ב-Dark Mode (אוטומטי לפי העדפות המערכת) */
@media (prefers-color-scheme: dark) {
  #md-content {
    background: #1a202c;
    color: #e2e8f0;
  }
  
  #md-content h1, #md-content h2, #md-content h3, #md-content h4 {
    color: #f7fafc;
    border-bottom-color: #4a5568;
  }
  
  #md-content a {
    color: #63b3ed;
  }
  
  #md-content a:hover {
    color: #90cdf4;
    border-bottom-color: #63b3ed;
  }
  
  #md-content strong {
    color: #f7fafc;
  }
  
  #md-content em {
    color: #cbd5e0;
  }
  
  #md-content code:not(pre code) {
    background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
    color: #90cdf4;
    border-color: #4a5568;
  }
  
  #md-content blockquote {
    background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
    border-inline-start-color: #4a5568;
  }
  
  #md-content table thead {
    background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
  }
  
  #md-content table td {
    border-bottom-color: #4a5568;
  }
  
  #md-content table tbody tr:nth-child(even) {
    background: #2d3748;
  }
  
  #md-content table tbody tr:hover {
    background: #4a5568;
  }
  
  #md-content hr {
    background: linear-gradient(90deg, transparent, #4a5568, transparent);
  }
}

/* רספונסיביות */
@media (max-width: 768px) {
  #md-content {
    font-size: 15px;
    padding: 12px;
  }
  
  #md-content h1 { font-size: 1.8em; }
  #md-content h2 { font-size: 1.5em; }
  #md-content h3 { font-size: 1.3em; }
  
  #md-content table {
    font-size: 14px;
  }
  
  #md-content pre {
    padding: 12px;
    padding-right: 16px;
    padding-left: 16px;
  }
}
</style>
{% endblock %}

{% block content %}
<div id="md-root">
  <div class="file-header" style="display:flex;justify-content:space-between;align-items:center;gap:1rem;flex-wrap:wrap;margin-bottom:1rem;">
    <div style="display:flex;align-items:center;gap:.75rem;min-width:0;">
      <span style="font-size:2rem;">📝</span>
      <div id="md-file-name-wrap">
        <h1 id="md-file-name">{{ file.file_name }}</h1>
        <div class="muted" style="margin-top:.25rem;">Markdown</div>
      </div>
    </div>
  <div class="file-actions" style="display:flex;gap:.5rem;flex-wrap:wrap;">
      {% if not is_public %}
      <a href="#" onclick="return goBackToFile(event)" class="btn btn-secondary btn-icon">↩️ חזרה לקובץ</a>
      {% endif %}
    </div>
  </div>

  <div class="glass-card" id="mdCard" style="padding:1rem;">
    <div class="section-header" style="display:flex;justify-content:space-between;align-items:center;gap:1rem;margin-bottom:.5rem;">
      <h2 class="section-title" style="margin:0;display:flex;align-items:center;gap:.5rem;">
        <i class="fas fa-file-alt"></i>
        תצוגת Markdown
      </h2>
      <button id="mdFullscreenBtn" class="btn btn-secondary btn-icon" title="מסך מלא">
        <i class="fas fa-expand"></i>
        מסך מלא
      </button>
    </div>
    <div class="search-bar" id="md-search" style="display:flex;flex-wrap:wrap;gap:.5rem;align-items:center;background:linear-gradient(135deg,#2d4a7c 0%,#3d5a8c 100%);padding:.75rem;border-radius:12px 12px 0 0;box-shadow:0 2px 8px rgba(0,0,0,0.2);margin:-16px -16px 0 -16px;">
      <input id="mdSearchInput" type="text" placeholder="🔍 חפש בקוד..." style="flex:1 1 220px;min-width:0;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);border-radius:8px;padding:.6rem .8rem;color:#fff;font-size:.95rem;outline:none;">
      <span id="mdSearchCount" class="result-count" style="color:rgba(255,255,255,.9);font-size:.85rem;padding:.35rem .6rem;background:rgba(255,255,255,.12);border-radius:6px;min-width:60px;text-align:center;flex:0 0 auto;"></span>
      <button id="mdSearchNext" type="button" class="btn btn-secondary btn-icon" title="הבא" style="background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);flex:0 0 auto;">▶</button>
      <button id="mdSearchClear" type="button" class="btn btn-secondary btn-icon" title="נקה" style="background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);flex:0 0 auto;">✕</button>
    </div>
    <div id="md-content" style="margin-inline:-4px;width:calc(100% + 8px);"></div>
  </div>
  {% if not is_public %}
  <div class="glass-card" style="margin-top: 1rem;">
    <h2 class="section-title">
      <i class="fas fa-share-alt"></i>
      שיתוף
    </h2>
    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
      <button onclick="shareToTelegramMd()" class="btn btn-secondary btn-icon">
        <i class="fab fa-telegram"></i>
        שתף בטלגרם
      </button>
      <button onclick="copyLinkMd()" class="btn btn-secondary btn-icon">
        <i class="fas fa-link"></i>
        העתק קישור
      </button>
    </div>
  </div>
  {% endif %}
  <script type="application/json" id="mdText">{{ md_code | tojson | safe }}</script>
</div>

<script>
// תוכן ה-Markdown מועבר בבטחה JSON-encoded
const MD_TEXT = (function(){
  try {
    var el = document.getElementById('mdText');
    if (!el) return "";
    return JSON.parse(el.textContent || '""');
  } catch(_) { return ""; }
})();

// שמירת מצב רשימות משימות (לפי קובץ) ב-localStorage
const STORAGE_KEY = `md_tasks_state:{{ file.id }}`;
function loadTaskState(){
  try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); }catch(_){ return {}; }
}
function saveTaskState(state){
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state || {})); }catch(_){ }
}
const taskState = loadTaskState();

// טעינת ספריות דרך CDN
// markdown-it + plugins (GFM-like), KaTeX, Mermaid, highlight.js
const CDN = {
  md: 'https://cdn.jsdelivr.net/npm/markdown-it@13.0.2/dist/markdown-it.min.js',
  mdEmoji: 'https://cdn.jsdelivr.net/npm/markdown-it-emoji@2.0.2/dist/markdown-it-emoji.min.js',
  mdTask: 'https://cdn.jsdelivr.net/npm/markdown-it-task-lists@2.1.1/dist/markdown-it-task-lists.min.js',
  mdAnchor: 'https://cdn.jsdelivr.net/npm/markdown-it-anchor@8.6.7/dist/markdown-it-anchor.min.js',
  mdFootnote: 'https://cdn.jsdelivr.net/npm/markdown-it-footnote@3.0.3/dist/markdown-it-footnote.min.js',
  mdTocDone: 'https://cdn.jsdelivr.net/npm/markdown-it-toc-done-right@4.2.0/dist/markdown-it-toc-done-right.min.js',
  hljs: 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js',
  hljsCss: 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css', // תמה מודרנית יותר
  katexCss: 'https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css',
  katexJs: 'https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js',
  katexAuto: 'https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js',
  mermaid: 'https://cdn.jsdelivr.net/npm/mermaid@10.9.1/dist/mermaid.min.js'
};

function injectCss(href){ 
  const l=document.createElement('link'); 
  l.rel='stylesheet'; 
  l.href=href; 
  l.media='print'; // טעינה לא חוסמת
  l.onload = function() { this.media='all'; }; // החלפה אחרי הטעינה
  document.head.appendChild(l); 
}
function loadScript(src){ 
  return new Promise((res,rej)=>{ 
    const s=document.createElement('script'); 
    s.src=src; 
    s.async=true; // טעינה אסינכרונית
    s.onload=res; 
    s.onerror=rej; 
    document.head.appendChild(s); 
  }); 
}

(async function(){
  try{
    injectCss(CDN.hljsCss);
    injectCss(CDN.katexCss);
    try { await loadScript(CDN.md); } catch(_){}
    try { await loadScript(CDN.mdEmoji); } catch(_){}
    try { await loadScript(CDN.mdTask); } catch(_){}
    try { await loadScript(CDN.mdAnchor); } catch(_){}
    try { await loadScript(CDN.mdFootnote); } catch(_){}
    try { await loadScript(CDN.mdTocDone); } catch(_){}
    try { await loadScript(CDN.hljs); } catch(_){}
    try { await loadScript(CDN.katexJs); } catch(_){}
    try { await loadScript(CDN.katexAuto); } catch(_){}
    try { await loadScript(CDN.mermaid); } catch(_){}

    const md = (window.markdownit ? window.markdownit : (()=>({render:(s)=>s})))({
      breaks: true,
      linkify: true,
      typographer: true,
      html: false,
      // לא לבצע הדגשה בשלב ה-render של markdown-it; נבצע post-process עם hljs
      highlight: function (_str, _lang) { return ''; }
    })
    if (window.markdownitEmoji) md.use(window.markdownitEmoji);
    if (window.markdownitTaskLists) md.use(window.markdownitTaskLists, { label: true, enabled: true });
    if (window.markdownitAnchor) md.use(window.markdownitAnchor, { permalink: true, permalinkSymbol: '¶' });
    if (window.markdownitFootnote) md.use(window.markdownitFootnote);
    if (window.markdownitTocDoneRight) md.use(window.markdownitTocDoneRight);

    // רינדור ראשוני
    const container = document.getElementById('md-content');
    container.innerHTML = md.render(MD_TEXT || '');

    // הדגשת תחביר לאחר הרינדור: הדגשה ממוקדת בתוך #md-content בלבד
    try {
      if (window.hljs) {
        try { if (typeof window.hljs.highlightAll === 'function') window.hljs.highlightAll(); } catch(_){}
        container.querySelectorAll('pre code').forEach(el => {
          try {
            if (el.classList.contains('hljs')) return;
            var hasLang = /\blanguage-/.test(el.className || '');
            if (hasLang && typeof window.hljs.highlightElement === 'function') {
              window.hljs.highlightElement(el);
            } else if (typeof window.hljs.highlightAuto === 'function') {
              var res = window.hljs.highlightAuto(el.textContent || '');
              el.innerHTML = res.value;
              el.classList.add('hljs');
            }
          } catch(__) {}
        });
      }
    } catch(_) { }

    // אחרי הדגשת hljs – נשמור מקור רק לכל בלוק קוד (לא לכל הקונטיינר)
    try {
      const blocks = container.querySelectorAll('pre code');
      blocks.forEach(code => {
        if (!code.hasAttribute('data-original-html')) {
          code.setAttribute('data-original-html', code.innerHTML);
        }
      });
    } catch(_) {}

    // חיפוש והדגשה בתוך קטעי קוד בלבד
    (function(){
      const input = document.getElementById('mdSearchInput');
      const clearBtn = document.getElementById('mdSearchClear');
      const nextBtn = document.getElementById('mdSearchNext');
      const countEl = document.getElementById('mdSearchCount');
      if (!input || !clearBtn || !countEl) return;
      let justAutoFocused = false;

      function restore() {
        // משחזר כל בלוק קוד מהמקור שנשמר בו, בלי לגעת בשאר ה-HTML והדגשות hljs
        const blocks = container.querySelectorAll('pre code');
        blocks.forEach(code => {
          try {
            const orig = code.getAttribute('data-original-html');
            if (orig != null) {
              code.innerHTML = orig;
            }
          } catch(_) {}
        });
      }

      function highlightTerm(term) {
        // מדגיש רק בתוך pre > code כדי לא לשבור HTML מחוץ לקוד
        const blocks = container.querySelectorAll('pre code');
        let total = 0;
        blocks.forEach(code => {
          try {
            const original = code.getAttribute('data-original-html') || code.innerHTML;
            code.setAttribute('data-original-html', original);
            if (!term) { code.innerHTML = original; return; }
            const safe = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const rx = new RegExp(`(${safe})`, 'gi');
            const replaced = original.replace(rx, '<span class="md-highlight">$1</span>');
            code.innerHTML = replaced;
            total += (original.match(rx) || []).length;
          } catch(_) {}
        });
        return total;
      }

      function updateCount(n, term){
        if (!term) { countEl.textContent = ''; return; }
        const active = container.querySelector('.md-highlight.is-active');
        const activeIndex = active ? (Array.from(container.querySelectorAll('.md-highlight')).indexOf(active) + 1) : 0;
        countEl.textContent = n > 0 ? (activeIndex ? `${activeIndex}/${n}` : `${n} תוצאות`) : 'אין תוצאות';
      }

      function setActiveAndScroll(target){
        try { container.querySelectorAll('.md-highlight.is-active').forEach(el => el.classList.remove('is-active')); } catch(_){ }
        if (!target) return;
        try { target.classList.add('is-active'); } catch(_){ }
        try { target.scrollIntoView({ behavior:'smooth', block:'center' }); } catch(_){ }
      }

      function focusFirst(){
        const first = container.querySelector('.md-highlight');
        if (first) setActiveAndScroll(first);
      }

      function focusNext(){
        const all = Array.from(container.querySelectorAll('.md-highlight'));
        if (all.length === 0) return;
        const current = container.querySelector('.md-highlight.is-active');
        const idx = current ? all.indexOf(current) : -1;
        const next = all[(idx + 1) % all.length];
        setActiveAndScroll(next);
        updateCount(all.length, input.value.trim());
      }

      input.addEventListener('input', () => {
        const term = (input.value || '').trim();
        restore();
        const n = highlightTerm(term);
        if (term && n > 0) {
          focusFirst();
          justAutoFocused = true;
        }
        updateCount(n, term);
      });

      clearBtn.addEventListener('click', () => {
        input.value = '';
        restore();
        updateCount(0, '');
        justAutoFocused = false;
      });

      if (nextBtn) {
        nextBtn.addEventListener('click', () => {
          const term = (input.value || '').trim();
          if (!term) return;
          const active = container.querySelector('.md-highlight.is-active');
          if (justAutoFocused || !active) {
            const first = container.querySelector('.md-highlight');
            if (first) setActiveAndScroll(first);
            justAutoFocused = false;
            updateCount(container.querySelectorAll('.md-highlight').length, term);
          } else {
            focusNext();
          }
        });
      }

      input.addEventListener('keydown', (ev) => {
        if (ev.key === 'Enter') {
          ev.preventDefault();
          const all = container.querySelectorAll('.md-highlight');
          if (all.length === 0) return;
          if (ev.shiftKey) {
            const arr = Array.from(all);
            const current = container.querySelector('.md-highlight.is-active');
            const idx = current ? arr.indexOf(current) : 0;
            const prev = arr[(idx - 1 + arr.length) % arr.length];
            setActiveAndScroll(prev);
            // reset auto-focus state so forward navigation advances
            justAutoFocused = false;
            updateCount(arr.length, input.value.trim());
          } else {
            const active = container.querySelector('.md-highlight.is-active');
            if (justAutoFocused || !active) {
              const first = container.querySelector('.md-highlight');
              if (first) setActiveAndScroll(first);
              justAutoFocused = false;
              updateCount(all.length, input.value.trim());
            } else {
              focusNext();
            }
          }
        }
      });

      // הוסר הקוד הכפול מהמיין; נשארת רק הלוגיקה החדשה שלא מדלגת על הראשונה
    })();

    // Lazy loading לתמונות
    container.querySelectorAll('img').forEach(img => { img.loading = 'lazy'; });

    // Smooth scrolling לעוגנים
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener('click', function (e) {
        const href = this.getAttribute('href');
        if (href && href !== '#') {
          e.preventDefault();
          const target = document.querySelector(href);
          if (target) {
            target.scrollIntoView({ 
              behavior: 'smooth', 
              block: 'start'
            });
            // עדכון URL בלי לגרום לגלילה
            if (history.pushState) {
              history.pushState(null, null, href);
            }
          }
        }
      });
    });
    
    // יצירת תוכן עניינים אוטומטי למסמכים ארוכים
    try {
      const headings = container.querySelectorAll('h1, h2, h3');
      if (headings.length > 3) { // רק אם יש מספיק כותרות
        const tocContainer = document.createElement('div');
        tocContainer.className = 'md-toc';
        tocContainer.innerHTML = '<h3>תוכן עניינים</h3>';
        const tocList = document.createElement('ul');
        
        headings.forEach((heading, index) => {
          // וודא שלכותרת יש ID
          if (!heading.id) {
            heading.id = 'heading-' + index;
          }
          
          const li = document.createElement('li');
          const level = parseInt(heading.tagName.charAt(1));
          li.style.paddingInlineStart = ((level - 1) * 1) + 'rem';
          
          const link = document.createElement('a');
          link.href = '#' + heading.id;
          link.textContent = heading.textContent;
          link.addEventListener('click', function(e) {
            e.preventDefault();
            heading.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            // סמן כפעיל
            tocList.querySelectorAll('a').forEach(a => a.classList.remove('active'));
            this.classList.add('active');
          });
          
          li.appendChild(link);
          tocList.appendChild(li);
        });
        
        tocContainer.appendChild(tocList);
        
        // הוסף כפתור להצגת/הסתרת תוכן עניינים
        const tocToggle = document.createElement('button');
        tocToggle.className = 'btn btn-secondary btn-icon';
        tocToggle.style.position = 'fixed';
        tocToggle.style.top = '80px';
        tocToggle.style.left = '20px';
        tocToggle.style.zIndex = '101';
        tocToggle.innerHTML = '<i class="fas fa-list"></i> תוכן';
        tocToggle.addEventListener('click', () => {
          tocContainer.classList.toggle('show');
        });
        
        // הוסף רק אם המסך גדול מספיק
        if (window.innerWidth > 1024) {
          document.body.appendChild(tocContainer);
          document.body.appendChild(tocToggle);
          
          // עדכון אוטומטי של הכותרת הפעילה בזמן גלילה
          let scrollTimeout;
          window.addEventListener('scroll', () => {
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(() => {
              let activeHeading = null;
              const scrollPos = window.scrollY + 100; // קצת offset מהחלק העליון
              
              headings.forEach(heading => {
                if (heading.offsetTop <= scrollPos) {
                  activeHeading = heading;
                }
              });
              
              if (activeHeading) {
                tocList.querySelectorAll('a').forEach(a => {
                  a.classList.remove('active');
                  if (a.href.endsWith('#' + activeHeading.id)) {
                    a.classList.add('active');
                  }
                });
              }
            }, 100); // debounce
          });
        }
      }
    } catch(_) {}

    // KaTeX אוטו-רנדר (בבטחה; אין html גולמי)
    try { if (window.renderMathInElement) window.renderMathInElement(container, { delimiters:[{left:'$$',right:'$$',display:true},{left:'$',right:'$',display:false}] }); } catch(_){ }

    // Mermaid: רנדר דיאגרמות בקוד fence ```mermaid
    try {
      if (!window.mermaid) throw new Error('mermaid missing');
      window.mermaid.initialize({ startOnLoad: false, securityLevel: 'strict' });
      const blocks = container.querySelectorAll('code.language-mermaid, pre code.language-mermaid');
      let i=0;
      for (const el of blocks) {
        const parent = el.closest('pre') || el.parentElement;
        const svgId = 'mmd_' + (++i);
        const code = el.textContent;
        const wrapper = document.createElement('div');
        parent.replaceWith(wrapper);
        try {
          const { svg } = await window.mermaid.render(svgId, code);
          wrapper.innerHTML = svg;
        } catch(e) {
          wrapper.innerHTML = '<div class="alert alert-warning">Mermaid render failed</div>';
        }
      }
    } catch(_){ }

    // כפתור העתקה ושפה לכל בלוק קוד (עטיפה ב-.code-block כדי לא להסתיר טקסט)
    try {
      const pres = Array.from(container.querySelectorAll('pre'));
      pres.forEach(pre => {
        let wrapper = pre.parentElement;
        if (!wrapper || !wrapper.classList || !wrapper.classList.contains('code-block')) {
          wrapper = document.createElement('div');
          wrapper.className = 'code-block';
          pre.replaceWith(wrapper);
          wrapper.appendChild(pre);
        }
        
        // זיהוי שפת הקוד
        const codeEl = pre.querySelector('code');
        if (codeEl) {
          const classList = codeEl.className || '';
          const langMatch = classList.match(/language-(\w+)/);
          if (langMatch) {
            wrapper.setAttribute('data-language', langMatch[1]);
          }
        }
        
        // אל תיצור כפתור נוסף אם כבר קיים בתוך ה-wrapper
        if (wrapper.querySelector('button.md-copy-btn')) {
          return;
        }
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'md-copy-btn';
        btn.setAttribute('aria-label', 'העתק קוד');
        btn.setAttribute('role', 'button');
        btn.setAttribute('tabindex', '0');
        btn.title = 'העתק קוד';
        btn.addEventListener('click', async () => {
          const codeEl = wrapper.querySelector('code');
          const text = codeEl ? codeEl.innerText : pre.innerText;
          // ניקוי מצבי עבר
          btn.classList.remove('copied');
          btn.classList.remove('copy-error');
          // ניסיון ראשון: Clipboard API
          try {
            await navigator.clipboard.writeText(text);
            btn.classList.add('copied');
            setTimeout(() => { btn.classList.remove('copied'); }, 1500);
            return;
          } catch(_) {}

          // Fallback: execCommand('copy') עם textarea זמני
          let success = false;
          try {
            const ta = document.createElement('textarea');
            ta.value = text;
            ta.setAttribute('readonly', '');
            ta.style.position = 'fixed';
            ta.style.opacity = '0';
            document.body.appendChild(ta);
            ta.select();
            success = document.execCommand('copy');
            document.body.removeChild(ta);
          } catch(_) {
            success = false;
          }

          if (success) {
            btn.classList.add('copied');
            setTimeout(() => { btn.classList.remove('copied'); }, 1500);
          } else {
            btn.classList.add('copy-error');
            setTimeout(() => { btn.classList.remove('copy-error'); }, 1500);
          }
        });
        wrapper.appendChild(btn);
      });
    } catch(_){ }

    // רשימות משימות אינטראקטיביות: שמירה/שחזור מצב
    // ב-render, markdown-it-task-lists הופך ל-input[type=checkbox]
    const boxes = container.querySelectorAll('input[type="checkbox"]');
    let idx = 0;
    boxes.forEach(cb => {
      cb.classList.add('md-task-checkbox');
      const key = 'i' + (idx++);
      // שחזור מצב
      if (Object.prototype.hasOwnProperty.call(taskState, key)) {
        cb.checked = !!taskState[key];
      }
      cb.addEventListener('change', () => {
        taskState[key] = cb.checked;
        saveTaskState(taskState);
      });
    });

    // וירטואליזציה בסיסית למסמכים ארוכים (חלוקה לקטעים לפי כותרות)
    try {
      const MAX_NODES = 2000;
      const nodes = Array.from(container.childNodes);
      if (nodes.length > MAX_NODES) {
        const chunk = document.createDocumentFragment();
        nodes.slice(0, MAX_NODES).forEach(n => chunk.appendChild(n));
        const rest = nodes.slice(MAX_NODES);
        container.innerHTML = '';
        container.appendChild(chunk);
        const more = document.createElement('button');
        more.className = 'btn btn-secondary btn-icon';
        more.textContent = 'טען עוד…';
        more.addEventListener('click', () => {
          const frag = document.createDocumentFragment();
          rest.forEach(n => frag.appendChild(n));
          container.appendChild(frag);
          more.remove();
        });
        container.appendChild(document.createElement('hr'));
        container.appendChild(more);
      }
    } catch(_){ }

  } catch (e) {
    console.error('Markdown preview failed', e);
    const container = document.getElementById('md-content');
    container.innerHTML = '<div class="alert alert-error">שגיאה ברינדור Markdown</div>';
  }
})();

// מסך מלא ל- Markdown Card
(function(){
  try {
    const btn = document.getElementById('mdFullscreenBtn');
    const card = document.getElementById('mdCard');
    if (!btn || !card) return;
    function isFullscreen(){ return document.fullscreenElement === card; }
    function updateButton(){
      if (isFullscreen()) {
        btn.innerHTML = '<i class="fas fa-compress"></i> יציאה ממסך מלא';
      } else {
        btn.innerHTML = '<i class="fas fa-expand"></i> מסך מלא';
      }
    }
    btn.addEventListener('click', async function(){
      try {
        if (!isFullscreen()) { await card.requestFullscreen(); }
        else { await document.exitFullscreen(); }
      } catch(_) {}
    });
    document.addEventListener('fullscreenchange', updateButton);
    updateButton();
  } catch(_) {}
})();

// יצירת קישור ציבורי שמכוון לתצוגת Markdown (view=md)
async function ensurePublicLinkMd(){
  try {
    const resp = await fetch(`/api/share/{{ file.id }}`, { method: 'POST' });
    const data = await resp.json();
    let baseUrl = window.location.origin;
    let url = (data && data.ok && data.url) ? data.url : window.location.href;
    try {
      const u = new URL(url, window.location.origin);
      u.searchParams.set('view', 'md');
      return u.toString();
    } catch(_) {
      return url + (url.includes('?') ? '&' : '?') + 'view=md';
    }
  } catch (e) {
    try {
      const u = new URL(window.location.href);
      u.searchParams.set('view','md');
      return u.toString();
    } catch(_) {
      return window.location.href;
    }
  }
}

async function copyLinkMd(){
  const url = await ensurePublicLinkMd();
  try { await navigator.clipboard.writeText(url); alert('הקישור הציבורי הועתק!'); }
  catch(e){ console.error('copy failed', e); alert('לא הצלחנו להעתיק את הקישור'); }
}

async function shareToTelegramMd(){
  const url = await ensurePublicLinkMd();
  const text = `צפה במסמך Markdown ב-Code Keeper:`;
  const telegramUrl = `https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`;
  try { window.open(telegramUrl, '_blank'); } catch(_) { window.location.href = telegramUrl; }
}

// ניווט חזרה אמין: אם יש היסטוריה – חזור; אחרת נווט ישירות לעמוד הקובץ
function goBackToFile(ev){
  try { if (ev) ev.preventDefault(); } catch(_){ }
  try {
    const sameOriginRef = document.referrer && new URL(document.referrer, window.location.origin).origin === window.location.origin;
    if (window.history && window.history.length > 1 && sameOriginRef) {
      window.history.back();
      return false;
    }
  } catch(_){ }
  try { window.location.replace('/file/{{ file.id }}'); } catch(_) { window.location.href = '/file/{{ file.id }}'; }
  return false;
}

// התאמת גודל שם הקובץ: מצמצם פונט הדרגתי עד שנכנס בשורה אחת (עם מינימום מוגן)
(function(){
  try {
    var el = document.getElementById('md-file-name');
    if (!el) return;
    el.setAttribute('title', el.textContent || '');
    var sizeRem = 1.6;    // גודל יעד התחלתי (התואם ל-CSS)
    var minRem = 1.0;     // מינימום – לא קטן מדי
    el.style.fontSize = sizeRem + 'rem';
    var guard = 0;
    while (guard < 15 && el.scrollWidth > el.clientWidth && sizeRem > minRem) {
      sizeRem -= 0.1;
      el.style.fontSize = sizeRem.toFixed(2) + 'rem';
      guard++;
    }
  } catch(_) { }
})();
</script>
{% endblock %}

