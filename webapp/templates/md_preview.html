{% extends "base.html" %}

{% block title %}{{ file.file_name }} - Markdown Preview{% endblock %}

{% block extra_css %}
<style>
/* ××–×•×¨ ×”×ª×¦×•×’×” ×•×”×‘×™×¦×•×¢×™× */
#md-root {
  /* ×”×¨×—×‘×ª ××–×•×¨ ×”×ª×•×›×Ÿ ×”×œ×‘×Ÿ ×œ×¦×“×“×™× ×•×”×¨×—×§×” ××”×©×•×œ×™×™× ×”×¡×’×•×œ×™× */
  max-width: min(1600px, 100vw);
  margin: 0 auto;
  padding: 0.5rem 0; /* ××ª ×”×¨×™×•×•×— ×”×¦×“×“×™ × ×™×ª×Ÿ ×“×¨×š ×”×›×¨×˜×™×¡ ×”×¤× ×™××™ */
}
#md-content {
  background: #ffffff;
  color: #111111;
  border-radius: 12px;
  border: none; /* ×‘×™×˜×•×œ ××¡×’×¨×ª (×©× ×ª×¤×¡×” ×›"×¡×’×•×œ×”") */
  padding: 14px; /* ×¨×™×•×•×— ××—×™×“ ×•×¢×“×™×Ÿ â€“ ×œ× ××¨×—×™×§ ××ª ×”×‘×œ×•×§ ××”×’×‘×•×œ */
  transition: background-color 0.3s ease, color 0.3s ease;
}

/* ×¦×‘×¢×™ ×¨×§×¢ ×—×•××™× ×œ×ª×¦×•×’×ª ×××¨×§×“××•×Ÿ â€” ×’×•×•× ×™× ×‘×”×™×¨×™× ×•× ×¢×™××™× */
#md-content.bg-light {
  background: #f7eadb; /* ××¢×˜ ×‘×”×™×¨ ×™×•×ª×¨ */
  color: #2b2b2b;
}

#md-content.bg-medium {
  background: #ecd9bd; /* ×‘×™× ×•× ×™ ×‘×”×™×¨ */
  color: #1f1f1f;
}

#md-content.bg-dark {
  background: #dec4a3; /* ×”×›×”×” ××‘×™×Ÿ ×”×©×œ×•×©×” ××š ×¢×“×™×™×Ÿ ×—× ×•×‘×”×™×¨ */
  color: #111111;
}

/* ×”×ª×××ª ×¦×‘×¢×™ ××œ×× ×˜×™× ×¤× ×™××™×™× ×œ×¨×§×¢ ×”×—×•× */
#md-content.bg-light code:not(pre code),
#md-content.bg-medium code:not(pre code),
#md-content.bg-dark code:not(pre code) {
  background: rgba(255, 255, 255, 0.4);
  border: 1px solid rgba(0, 0, 0, 0.1);
}

#md-content.bg-light blockquote,
#md-content.bg-medium blockquote,
#md-content.bg-dark blockquote {
  background: rgba(255, 255, 255, 0.3);
  border-inline-start-color: rgba(0, 0, 0, 0.2);
}

#md-content.bg-light table thead,
#md-content.bg-medium table thead,
#md-content.bg-dark table thead {
  background: rgba(255, 255, 255, 0.3);
}

#md-content.bg-light table th,
#md-content.bg-light table td,
#md-content.bg-medium table th,
#md-content.bg-medium table td,
#md-content.bg-dark table th,
#md-content.bg-dark table td {
  border-color: rgba(0, 0, 0, 0.1);
}

/* hover effect for color options */
.bg-color-option:hover {
  transform: scale(1.05);
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.bg-color-option.active {
  border: 2px solid #4a90e2 !important;
  box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);
}
/* ×‘××¡×š ××œ× â€“ ×œ××¤×©×¨ ×’×œ×™×œ×” ×‘×ª×•×š ×”×›×¨×˜×™×¡ ×¢×¦××• (×ª××™×›×” ×’× ×‘-WebKit) */
#mdCard:fullscreen { height: 100vh; overflow: auto; }
#mdCard:-webkit-full-screen { height: 100vh; overflow: auto; }
#md-content img {
  max-width: 100%;
  height: auto;
}
/* ××™×§×•× ×›×¤×ª×•×¨ "×¦×‘×¢ ×¨×§×¢" â€“ ×”×¢×‘×¨×” ×œ×›×•×ª×¨×ª ×•×× ×™×¢×ª ×—×¤×™×¤×” */
#md-search { position: relative; }
#bgColorSwitcher { position: relative; z-index: 1; margin-inline-end: .5rem; }
@media (max-width: 600px) {
  /* ×‘××•×‘×™×™×œ â€“ ×× ×¦×¨×™×š, × ×™×ª×Ÿ ×œ×”×¢×‘×™×¨ ×œ×©×•×¨×” ×©× ×™×™×” ×‘×ª×•×š ×”×›×•×ª×¨×ª */
  #bgColorSwitcher { order: 2; width: auto; margin-top: 6px; }
}
/* ×”×¨×—×‘×ª ×”×§×•× ×˜×™×™× ×¨ ×‘×¢××•×“ Markdown ×›×“×™ ×œ×¦××¦× ××ª ×”×¡×’×•×œ ×‘×¦×“×“×™× */
.main-content > .container {
  /* ××›×•×œ×” ×¨×—×‘×” ×›×“×™ ×œ×¦××¦× "×¡×’×•×œ" ×‘×¦×“×“×™× */
  max-width: 100% !important;
  width: 100% !important;
  padding-left: 8px !important;
  padding-right: 8px !important;
}
/* ×‘×¢××•×“ Markdown ×‘×œ×‘×“: ×¦××¦×•× ×”×¤×¡ ×”×¡×’×•×œ ××©×××œ â€“ ××¨×—×™×‘×™× ××ª ×”×›×¨×˜×™×¡ ×©×××œ×” */
.main-content .glass-card {
  margin-left: 0 !important;        /* ×©×××œ ×§×¨×•×‘ ×™×•×ª×¨ ×œ×§×¦×” */
  margin-right: 0.5rem !important;  /* ×©×•××¨×™× ×¢×œ ×™××™×Ÿ ×§×™×™× */
  width: calc(100% - 0.5rem) !important;
}
/* ×˜×‘×œ××•×ª ×‘×¡×’× ×•×Ÿ GitHub */
#md-content table {
  width: 100%;
  border-collapse: collapse;
  overflow: auto;
  display: block;
}
#md-content table th, #md-content table td {
  border: 1px solid #e5e7eb;
  padding: 0.5rem 0.75rem;
}
#md-content table thead {
  background: #f8fafc;
}
/* ×§×•×“ (fenced) */
#md-content pre code,
#md-content pre > code,
#md-content code.hljs {
  display: block;
  /* × ×©××•×¨ ×¢×œ ×¨×™×•×•×— ××™× ×™××œ×™ ×‘×ª×•×š ×ª×’×™×ª ×”×§×•×“ ×¢×¦××” â€“ ×“×§ ×©×œ× ×™×‘×˜×œ ×”×“×’×©×•×ª */
  padding: 0 2px 0 0;            /* ×ª×•×¡×¤×ª ×¢×“×™× ×” ××™××™×Ÿ ×‘-RTL */
  border-radius: 8px;
  font-family: 'Fira Code', 'Consolas', monospace;
  font-size: 16px;               /* × ×’×™×©×•×ª ×˜×•×‘×” ×™×•×ª×¨ */
  line-height: 1.5;              /* ×¨×•×•×— ×× ×›×™ ×˜×•×‘ */
  /* ×’×œ×™×œ×” ××•×¤×§×™×ª ×‘××§×•× ×¢×˜×™×¤×” â€“ ×›×“×™ ×œ× ×œ×—×ª×•×š ×§×•×“ ××¨×•×š */
  white-space: pre !important;
  word-break: normal !important;
  overflow-wrap: normal !important;
}
#md-content .md-highlight {
  background: linear-gradient(90deg, #ffd700 0%, #ffed4e 100%);
  color: #000;
  padding: 2px 4px;
  border-radius: 3px;
  font-weight: 600;
}
#md-content pre { overflow-x: auto; max-width: 100%; margin: 1rem 0; width: 100%; }
#md-content .hljs { overflow-x: auto; display: block; }
#md-content pre {
  background: linear-gradient(135deg, #1e3a5f 0%, #2d4a6f 100%);
  border: 0;                        /* ×”×¡×¨×ª ××¡×’×¨×ª ×“×§×” ×©××¦×˜×™×™×¨×ª ×›×¡×’×•×œ×” */
  border-radius: 12px;
  padding: 16px;                    /* ×‘×¡×™×¡ */
  /* ×¨×™×•×•×— ×¤× ×™××™ ×¡×™××˜×¨×™ ×‘×ª×•×š ×”×‘×œ×•×§ â€“ ×›×“×™ ×©×”×§×•×“ ×œ× ×™×™×’×¢ ×‘×’×‘×•×œ×•×ª */
  padding-right: clamp(22px, 6vw, 36px);
  padding-left: clamp(22px, 6vw, 36px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  overflow-x: auto;
  margin: 1em 0;                    /* ××™×Ÿ ××¨×•×•×— ×©×œ×™×œ×™ â€“ ×œ× ×©×•×‘×¨×™× ×¤×¨×™×¡×” */
  width: 100%;                      /* ××™×œ×•×™ ×¨×•×—×‘ ×”×›×¨×˜×™×¡, ×œ×œ× ×’×œ×™×©×” */
  color: #e8eaed;                   /* Fallback: ×˜×§×¡×˜ ×‘×”×™×¨ ×× hljs ×œ× × ×˜×¢×Ÿ */
  box-sizing: border-box;
}
#md-content pre code {
  display: block;
  overflow-x: auto;
  /* ×¨×™×•×•×— ×¢×“×™×Ÿ ×‘×ª×•×š ×ª×’×™×ª ×”×§×•×“ ×¢×¦××” */
  padding: 0 2px;
}
#md-content {
  /* ×œ× × ×—×¡×•× ×’×œ×™×©×” ×›×“×™ ×©×œ× ×™×™×—×ª×›×• ××¡×¤×¨×™×/×ª×•×•×™× ××—×•×¥ ×œ×§×•×¤×¡×” (×œ××©×œ ×‘×¨×©×™××•×ª) */
  overflow: visible;
}
/* ×× ×™×¢×ª ×’×œ×™×©×” ××•×¤×§×™×ª ×©×œ ×˜×§×¡×˜ ××—×•×¥ ×œ×§×•×“/inline-code */
#md-content p, #md-content li, #md-content blockquote {
  overflow-wrap: anywhere;
  word-break: break-word;
}
/* ××¨×•×•×— × ×¢×™× ×‘×™×Ÿ ×¤×¡×§××•×ª */
#md-content p { margin: 0.75rem 0; }
/* ×¨×™×•×•×— ×‘×¨×•×¨ ×¡×‘×™×‘ ×›×•×ª×¨×•×ª ××©× ×” ×›×“×™ ×œ×× ×•×¢ ×”×“×‘×§×” ×œ×˜×§×¡×˜ ×©×œ×¤× ×™×”×Ÿ/××—×¨×™×”×Ÿ */
#md-content h2, #md-content h3, #md-content h4 {
  margin-top: 1.25rem;
  margin-bottom: 0.75rem;
}
/* ×‘×¨×©×™××•×ª ×××•×¡×¤×¨×•×ª/×ª×‘×œ×™×˜×™× ×‘-RTL ×”××¡×¤×¨/×¡××œ ×™×™×©×‘ ×‘×ª×•×š ×”×‘×œ×•×§, ×œ× ××—×•×¦×” ×œ×• */
#md-content ol, #md-content ul {
  /* ×”×¦×’×ª ×”×ª×‘×œ×™×˜/××¡×¤×•×¨ ××—×•×¥ ×œ×‘×œ×•×§ ×›×“×™ ×œ×™×¦×•×¨ ×”×–×—×” ×˜×‘×¢×™×ª */
  list-style-position: outside;
  /* ×¨×™×•×•×— ×ª×—×ª×•×Ÿ ×›×“×™ ×©×œ× ×™×™×“×‘×§×• ×œ×›×•×ª×¨×ª/×¤×¡×§×” ×”×‘××” */
  margin-block: 0 1rem;
  /* ×”×–×—×” ×‘×¦×“ ×”×”×ª×—×œ×” (RTL: ×™××™×Ÿ) */
  padding-inline-start: 1.25rem;
}
/* ×¨×•×•×— ×¢×“×™×Ÿ ×‘×™×Ÿ ×¤×¨×™×˜×™ ×¨×©×™××” */
#md-content li { margin: 0.25rem 0; }
/* ×¨×©×™××•×ª ××§×•× × ×•×ª â€“ ××¢×˜ ×¨×•×•×— ××¢×œ/××ª×—×ª */
#md-content li > ul, #md-content li > ol { margin-block: 0.25rem 0.5rem; }
#md-content .code-block { position: relative; margin: 1rem 0; }
#md-content .code-block pre {
  margin: 0;
  /* ×¨×™×•×•×— ×¡×™××˜×¨×™ ×‘×ª×•×š ×”×‘×œ×•×§ ×¢×¦××• â€“ ×œ× ××©×¤×™×¢ ×¢×œ ×”××™×§×•× ×©×œ ×”×‘×œ×•×§ ×‘×“×£ */
  padding: 16px;
  padding-right: clamp(22px, 6vw, 36px);
  padding-left: clamp(22px, 6vw, 36px);
  padding-top: 2.6rem;           /* ××§×•× ×œ×©×•×¨×ª ×›×¤×ª×•×¨×™× ×¢×œ×™×•× ×” */
  box-sizing: border-box;
}
#md-content .md-copy-btn {
  position: absolute;
  top: 10px;
  left: 10px;
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
  padding: 6px 10px;
  font-size: 0.85rem;
  background: rgba(255, 255, 255, 0.95);
  color: #1f2937;
  border: 1px solid rgba(209, 213, 219, 0.9);
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.2s ease, transform 0.2s ease, border-color 0.2s ease, color 0.2s ease;
  box-shadow: 0 1px 2px rgba(15, 23, 42, 0.08);
  z-index: 2;
}
#md-content .md-copy-btn:hover {
  background: #f6f8fa;
  border-color: rgba(148, 163, 184, 0.9);
  transform: translateY(-1px);
}
#md-content .md-copy-btn.copied {
  background: #28a745;
  border-color: #28a745;
  color: #ffffff;
}
#md-content .md-copy-btn.copy-error {
  background: #fee2e2;
  border-color: #ef4444;
  color: #991b1b;
}
#md-content .md-copy-btn::before {
  content: none;
}
#md-content .md-copy-btn .copy-icon {
  font-size: 1rem;
}
#md-content .md-copy-btn .copied-text {
  font-weight: 500;
}
#md-content code:not(pre code) {
  background: #f3f4f6;            /* ××¤×•×¨ ×‘×”×™×¨ ×¢× × ×™×’×•×“×™×•×ª ×˜×•×‘×” ×¢×œ ×œ×‘×Ÿ */
  color: #111111;                 /* ×˜×§×¡×˜ ×›×”×” ×œ×§×¨×™××•×ª */
  border: 1px solid #e5e7eb;      /* ××¡×’×¨×ª ×¢×“×™× ×” */
  padding: 0.2rem 0.4rem;
  border-radius: 6px;
  font-family: 'Fira Code', 'Consolas', monospace;
}
/* ×—×™×•×•×™ ×œ××•×¤×¢ ×¤×¢×™×œ ×‘×—×™×¤×•×© */
#md-content .md-highlight.is-active {
  outline: 2px solid #ffd700;
  outline-offset: 1px;
}
/* ×¦×™×˜×•×˜×™× */
#md-content blockquote {
  margin: 0.75rem 0;
  padding: 0.5rem 0.75rem;
  background: #eef2f7; /* ××¢×˜ ×›×”×” ×™×•×ª×¨ ×œ× ×™×’×•×“×™×•×ª ×˜×•×‘×” ×¢×œ ×œ×‘×Ÿ */
  border-inline-start: 4px solid #cbd5e1; /* ×§×• ×¦×“ ×›×”×” ×‘××§×¦×ª */
}
/* ×©× ×§×•×‘×¥ ××¨×•×š â€“ ×× ×™×¢×ª ×—×¨×™×’×” ×‘××¡×’×¨×ª ×”×›×•×ª×¨×ª */
#md-file-name-wrap { min-width: 0; }
#md-file-name {
  margin: 0;
  font-size: 1.6rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
  display: block;
}
/* ×¨×©×™××•×ª ××©×™××•×ª */
input.md-task-checkbox {
  margin-inline-end: .5rem;
  transform: scale(1.1);
}
/* ×©×™×¤×•×¨×™ ×›×•×ª×¨×•×ª ×¢× ×’×‘×•×œ×•×ª ×ª×—×ª×•× ×™× */
#md-content h1 {
  font-size: 2.2em;
  margin-top: 1.5em;
  margin-bottom: 0.5em;
  font-weight: 700;
  border-bottom: 3px solid #e1e4e8;
  padding-bottom: 0.3em;
}

#md-content h2 {
  font-size: 1.8em;
  font-weight: 600;
  border-bottom: 2px solid #e1e4e8;
  padding-bottom: 0.3em;
}

#md-content h3 {
  font-size: 1.4em;
  font-weight: 600;
}

#md-content h4 {
  font-size: 1.2em;
  font-weight: 500;
}

/* ×©×‘×™×¨×ª ×©×•×¨×•×ª ×œ×›×•×ª×¨×•×ª ××¨×•×›×•×ª ×‘×ª×¦×•×’×ª Markdown */
#md-content h1,
#md-content h2,
#md-content h3,
#md-content h4,
#md-content h5,
#md-content h6 {
  white-space: normal;
  overflow-wrap: anywhere;
  word-break: break-word;
}

/* ×× ×™××¦×™×•×ª ×›× ×™×¡×” ×¢×“×™× ×•×ª */
#md-content > * {
  animation: fadeIn 0.4s ease-in;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* ×× ×™××¦×™×” ××”×™×¨×” ×™×•×ª×¨ ×œ××œ×× ×˜×™× ×¡×¤×¦×™×¤×™×™× */
#md-content pre,
#md-content blockquote,
#md-content table {
  animation: fadeIn 0.3s ease-out;
}

@media (prefers-reduced-motion: reduce) {
  /* × ×˜×¨×œ ×× ×™××¦×™×•×ª ×œ×›×œ ×™×œ×“ ×™×©×™×¨ */
  #md-content > * { animation: none; }
  /* × ×˜×¨×œ ×’× ×œ×›×œ×œ×™× ×”×¡×¤×¦×™×¤×™×™× ×™×•×ª×¨ ×›×“×™ ×œ× ×œ×¢×§×•×£ ××ª ×”×”×¢×“×¤×” */
  #md-content pre,
  #md-content blockquote,
  #md-content table { animation: none; }
  /* ×¦××¦× ×’× ××¢×‘×¨×™× ×œ×§×™×©×•×¨×™× ×•××¤×§×˜ ×”-::after ×©×œ×”× */
  #md-content a,
  #md-content a::after { transition: none; }
}

/* ×¢×™×¦×•×‘ ××©×•×¤×¨ ×œ×§×™×©×•×¨×™× */
#md-content a {
  color: #0366d6;
  text-decoration: none;
  border-bottom: 1px solid transparent;
  transition: all 0.2s ease;
  position: relative;
}

#md-content a:hover {
  color: #0256c7;
}

/* ××¤×§×˜ hover × ×•×¡×£ ××•×¤×¦×™×•× ×œ×™ - ×§×• ×ª×—×ª×•×Ÿ ××ª×¨×—×‘ */
#md-content a::after {
  content: '';
  position: absolute;
  bottom: -1px;
  left: 50%;
  width: 0;
  height: 1px;
  background: #0366d6;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  transform: translateX(-50%);
}

#md-content a:hover::after {
  width: 100%;
}

/* ×§×™×©×•×¨×™× ×‘×›×•×ª×¨×•×ª - ×œ×œ× ×§×• ×ª×—×ª×•×Ÿ */
#md-content h1 a,
#md-content h2 a,
#md-content h3 a {
  border-bottom: none;
}

#md-content h1 a::after,
#md-content h2 a::after,
#md-content h3 a::after {
  display: none;
}

/* ×§×™×©×•×¨×™ ×¢×•×’×Ÿ (permalink) */
#md-content .header-anchor {
  opacity: 0;
  transition: opacity 0.2s;
  margin-left: 0.5em;
  color: #6c757d;
}

#md-content h1:hover .header-anchor,
#md-content h2:hover .header-anchor,
#md-content h3:hover .header-anchor {
  opacity: 1;
}
</style>
<style>
/* === ×ª×•×›×Ÿ ×¢× ×™×™× ×™× ×¦×£ ××ª×§×“× === */
:root {
  --toc-bg-light: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(250,250,252,0.98) 100%);
  --toc-bg-dark: linear-gradient(135deg, rgba(30,30,40,0.98) 0%, rgba(40,40,50,0.98) 100%);
  --toc-header-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  --toc-text-light: #2d3748;
  --toc-text-dark: #e0e0e0;
  --toc-hover-light: rgba(102, 126, 234, 0.1);
  --toc-hover-dark: rgba(102, 126, 234, 0.2);
  --toc-active-light: rgba(102, 126, 234, 0.15);
  --toc-active-dark: rgba(102, 126, 234, 0.25);
}

:root {
  --toc-bg-light: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(250,250,252,0.98) 100%);
  --toc-bg-dark: linear-gradient(135deg, rgba(30,30,40,0.98) 0%, rgba(40,40,50,0.98) 100%);
  --toc-header-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  --toc-text-light: #2d3748;
  --toc-text-dark: #e0e0e0;
  --toc-hover-light: rgba(102, 126, 234, 0.1);
  --toc-hover-dark: rgba(102, 126, 234, 0.2);
  --toc-active-light: rgba(102, 126, 234, 0.15);
  --toc-active-dark: rgba(102, 126, 234, 0.25);
}

:root {
  --toc-bg-light: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(250,250,252,0.98) 100%);
  --toc-bg-dark: linear-gradient(135deg, rgba(30,30,40,0.98) 0%, rgba(40,40,50,0.98) 100%);
  --toc-header-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  --toc-text-light: #2d3748;
  --toc-text-dark: #e0e0e0;
  --toc-hover-light: rgba(102, 126, 234, 0.1);
  --toc-hover-dark: rgba(102, 126, 234, 0.2);
  --toc-active-light: rgba(102, 126, 234, 0.15);
  --toc-active-dark: rgba(102, 126, 234, 0.25);
}

:root {
  --toc-bg-light: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(250,250,252,0.98) 100%);
  --toc-bg-dark: linear-gradient(135deg, rgba(30,30,40,0.98) 0%, rgba(40,40,50,0.98) 100%);
  --toc-header-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  --toc-text-light: #2d3748;
  --toc-text-dark: #e0e0e0;
  --toc-hover-light: rgba(102, 126, 234, 0.1);
  --toc-hover-dark: rgba(102, 126, 234, 0.2);
  --toc-active-light: rgba(102, 126, 234, 0.15);
  --toc-active-dark: rgba(102, 126, 234, 0.25);
}

.md-toc {
  position: fixed;
  top: 100px;
  left: 20px;
  max-width: 320px;
  min-width: 250px;
  max-height: calc(100vh - 140px);
  background: var(--toc-bg-light);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  border-radius: 16px;
  box-shadow:
    0 10px 40px rgba(0,0,0,0.12),
    0 2px 10px rgba(0,0,0,0.06),
    inset 0 1px 0 rgba(255,255,255,0.5);
  border: 1px solid rgba(255,255,255,0.3);
  z-index: 900;
  overflow: hidden;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Dark Mode Support */
@media (prefers-color-scheme: dark) {
  .md-toc {
    background: var(--toc-bg-dark);
    box-shadow:
      0 10px 40px rgba(0,0,0,0.5),
      0 2px 10px rgba(0,0,0,0.3);
    border: 1px solid rgba(255,255,255,0.1);
  }
}

/* ×›×•×ª×¨×ª ×¢× gradient */
.md-toc-header {
  padding: 1rem;
  background: var(--toc-header-gradient);
  color: white;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: relative;
  user-select: none;
}

.md-toc-title-wrapper {
  flex: 1;
}

.md-toc-title-wrapper h3 {
  margin: 0;
  font-size: 1.1rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-weight: 600;
}

/* ×¤×¡ ×”×ª×§×“××•×ª */
.md-toc-progress {
  height: 3px;
  background: rgba(255,255,255,0.2);
  border-radius: 2px;
  margin-top: 0.5rem;
  overflow: hidden;
}

.md-toc-progress-bar {
  height: 100%;
  background: rgba(255,255,255,0.9);
  border-radius: 2px;
  width: 0%;
  transition: width 0.3s ease;
  box-shadow: 0 0 10px rgba(255,255,255,0.5);
}

/* ×›×¤×ª×•×¨×™ ×‘×§×¨×” */
.md-toc-controls {
  display: flex;
  gap: 0.5rem;
}

.md-toc-toggle,
.md-toc-search-btn {
  background: rgba(255,255,255,0.2);
  border: 1px solid rgba(255,255,255,0.3);
  border-radius: 8px;
  padding: 0.4rem 0.6rem;
  cursor: pointer;
  color: white;
  transition: all 0.2s ease;
}

.md-toc-toggle:hover,
.md-toc-search-btn:hover {
  background: rgba(255,255,255,0.3);
  transform: scale(1.05);
}

.md-toc-toggle:active,
.md-toc-search-btn:active {
  transform: scale(0.95);
}

.md-toc-toggle i {
  transition: transform 0.3s ease;
}

.md-toc.collapsed .md-toc-toggle i {
  transform: rotate(180deg);
}

/* ×ª×™×‘×ª ×—×™×¤×•×© */
.md-toc-search-container {
  padding: 0.75rem;
  background: rgba(102, 126, 234, 0.05);
  border-bottom: 1px solid rgba(102, 126, 234, 0.2);
}

.md-toc-search-input {
  width: 100%;
  padding: 0.5rem;
  border: 1px solid rgba(102, 126, 234, 0.3);
  border-radius: 8px;
  background: white;
  font-size: 0.9rem;
  transition: all 0.2s ease;
}

.md-toc-search-input:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

@media (prefers-color-scheme: dark) {
  .md-toc-search-input {
    background: rgba(255,255,255,0.1);
    color: white;
    border-color: rgba(255,255,255,0.2);
  }
}

.md-toc-search-results {
  display: block;
  margin-top: 0.25rem;
  font-size: 0.75rem;
  color: #667eea;
  text-align: center;
}

/* ××–×•×¨ × ×™×•×•×˜ ×¢× ×’×œ×™×œ×” */
.md-toc-nav {
  padding: 0.5rem 0;
  overflow-y: auto;
  max-height: calc(100vh - 240px);
  scrollbar-width: thin;
  scrollbar-color: #667eea transparent;
  position: relative;
}

.md-toc-nav::-webkit-scrollbar {
  width: 6px;
}

.md-toc-nav::-webkit-scrollbar-thumb {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 3px;
}

.md-toc-nav::-webkit-scrollbar-track {
  background: transparent;
}

/* ×¤×¨×™×˜×™ ×ª×•×›×Ÿ ×¢× ×™×™× ×™× */
.md-toc-item {
  padding: 0.6rem 1rem;
  cursor: pointer;
  color: var(--toc-text-light);
  transition: all 0.2s ease;
  border-right: 3px solid transparent;
  font-size: 0.9rem;
  display: block;
  text-decoration: none;
  position: relative;
  overflow: hidden;
}

@media (prefers-color-scheme: dark) {
  .md-toc-item {
    color: var(--toc-text-dark);
  }
}

/* ××¤×§×˜ hover ××ª×§×“× */
.md-toc-item::before {
  content: '';
  position: absolute;
  right: 0;
  top: 0;
  height: 100%;
  width: 3px;
  background: var(--toc-header-gradient);
  transform: translateX(100%);
  transition: transform 0.3s ease;
}

.md-toc-item:hover {
  background: var(--toc-hover-light);
  padding-right: 1.25rem;
}

@media (prefers-color-scheme: dark) {
  .md-toc-item:hover {
    background: var(--toc-hover-dark);
  }
}

.md-toc-item:hover::before,
.md-toc-item.active::before {
  transform: translateX(0);
}

.md-toc-item.active {
  background: var(--toc-active-light);
  color: #667eea;
  font-weight: 600;
}

@media (prefers-color-scheme: dark) {
  .md-toc-item.active {
    background: var(--toc-active-dark);
  }
}

/* ×”×“×’×©×ª ×—×™×¤×•×© */
.md-toc-item.search-match {
  background: rgba(255, 235, 59, 0.2);
}

.md-toc-item.search-match mark {
  background: rgba(255, 235, 59, 0.5);
  color: inherit;
  padding: 0 2px;
  border-radius: 2px;
}

/* ×”×¡×ª×¨×” ×‘×—×™×¤×•×© */
.md-toc-item.search-hidden {
  display: none;
}

/* ×”×–×—×” ×œ×¤×™ ×¨××ª ×›×•×ª×¨×ª */
.md-toc-item[data-level="1"] { padding-right: 1rem; font-weight: 600; }
.md-toc-item[data-level="2"] { padding-right: 1.25rem; }
.md-toc-item[data-level="3"] { padding-right: 2rem; font-size: 0.85rem; }
.md-toc-item[data-level="4"] { padding-right: 2.75rem; font-size: 0.8rem; }
.md-toc-item[data-level="5"] { padding-right: 3.5rem; font-size: 0.75rem; }
.md-toc-item[data-level="6"] { padding-right: 4.25rem; font-size: 0.75rem; }

/* ××¦×‘ ××›×•×•×¥ */
.md-toc.collapsed {
  max-height: 60px;
}

.md-toc.collapsed .md-toc-nav,
.md-toc.collapsed .md-toc-search-container {
  display: none;
}

.md-toc.collapsed .md-toc-progress {
  margin-top: 0.25rem;
}

/* ××¦×‘ ××™× ×™××œ×™ */
.md-toc.minimized {
  display: none;
}

.md-toc-mini-btn {
  position: fixed;
  top: 100px;
  left: 12px;  /* ×‘×¦×“ ×©×××œ ×©×œ ×”××¡×š */
  width: 44px;
  height: 44px;
  border-radius: 10px; /* ×¨×™×‘×•×¢ ××¢×•×’×œ ×§×œ×•×ª */
  background: var(--toc-header-gradient);
  color: white;
  border: none;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.35);
  transition: transform 0.15s ease, box-shadow 0.2s ease;
  z-index: 1000;
  touch-action: none; /* ×××¤×©×¨ ×’×¨×™×¨×” ×—×œ×§×” ×‘××•×‘×™×™×œ */
}

.md-toc-mini-btn:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
}

/* Virtual Scrolling - ×¤×¨×™×˜ placeholder */
.md-toc-item-placeholder {
  height: 32px;
  background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
  background-size: 200% 100%;
  animation: loading 1.5s infinite;
  margin: 0.25rem 1rem;
  border-radius: 4px;
}

@keyframes loading {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

/* ×”×ª×××” ×œ××¡×›×™× ×§×˜× ×™× */
@media (max-width: 1024px) {
  .md-toc {
    left: 10px;
    max-width: 280px;
    min-width: 220px;
    font-size: 0.85rem;
  }
  
  .md-toc-item {
    padding: 0.5rem 0.75rem;
  }
}

@media (max-width: 768px) {
  /* ×‘××•×‘×™×™×œ: ×”×¡×ª×¨×ª ×”×¤×× ×œ ×•×”×¦×’×ª ×›×¤×ª×•×¨ ××™× ×™××œ×™ ×œ×¤×ª×™×—×” */
  .md-toc { display: none; }
  .md-toc-mini-btn { display: block; }
}

/* ×‘××¡×š ××œ× - ×”×¡×ª×¨ */
#mdCard:fullscreen ~ .md-toc,
#mdCard:-webkit-full-screen ~ .md-toc,
#mdCard:fullscreen ~ .md-toc-mini-btn,
#mdCard:-webkit-full-screen ~ .md-toc-mini-btn {
  display: none !important;
}

/* ×× ×™××¦×™×•×ª × ×•×¡×¤×•×ª */
@keyframes slideIn {
  from {
    transform: translateX(-100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

.md-toc {
  animation: slideIn 0.3s ease-out;
}

/* Tooltip ×œ×›×•×ª×¨×•×ª ××¨×•×›×•×ª */
.md-toc-item[title] {
  position: relative;
}

.md-toc-item[title]:hover::after {
  content: attr(title);
  position: absolute;
  right: calc(100% + 10px);
  top: 50%;
  transform: translateY(-50%);
  background: rgba(0,0,0,0.8);
  color: white;
  padding: 0.5rem;
  border-radius: 6px;
  white-space: nowrap;
  font-size: 0.85rem;
  z-index: 1000;
  max-width: 300px;
  overflow: hidden;
  text-overflow: ellipsis;
}
</style>
{% endblock %}

{% block content %}
<div id="md-root">
  <div class="file-header" style="display:flex;justify-content:space-between;align-items:center;gap:1rem;flex-wrap:wrap;margin-bottom:1rem;">
    <div style="display:flex;align-items:center;gap:.75rem;min-width:0;">
      <span style="font-size:2rem;">ğŸ“</span>
      <div id="md-file-name-wrap">
        <h1 id="md-file-name">{{ file.file_name }}</h1>
        <div class="muted" style="margin-top:.25rem;">Markdown</div>
      </div>
    </div>
  <div class="file-actions" style="display:flex;gap:.5rem;flex-wrap:wrap;">
      {% if not is_public %}
      <a href="#" onclick="return goBackToFile(event)" class="btn btn-secondary btn-icon">â†©ï¸ ×—×–×¨×” ×œ×ª×¦×•×’×ª ×§×•×“</a>
      <a href="#" onclick="return goBackTwoSteps(event)" class="btn btn-secondary btn-icon" title="×—×–×•×¨ ×œ××¡×š ×§×•×“×"><i class="fas fa-arrow-right"></i> ×—×–×•×¨</a>
      {% endif %}
    </div>
  </div>

  <div class="glass-card" id="mdCard" style="padding:1rem;">
    <div class="section-header" style="display:flex;justify-content:space-between;align-items:center;gap:1rem;margin-bottom:.5rem;flex-wrap:wrap;">
      <div class="section-title-wrap" style="display:flex;align-items:center;gap:.5rem;flex-wrap:wrap;">
        <h2 class="section-title" style="margin:0;display:flex;align-items:center;gap:.5rem;">
          <i class="fas fa-file-alt"></i>
          ×ª×¦×•×’×ª Markdown
        </h2>
        <!-- ×›×¤×ª×•×¨ ×”×—×œ×¤×ª ×¦×‘×¢×™ ×¨×§×¢ ×”×•×¢×‘×¨ ×œ×›×•×ª×¨×ª ×›×“×™ ×œ×× ×•×¢ ×—×¤×™×¤×” ×‘×˜××‘×œ×˜ -->
        <div id="bgColorSwitcher">
          <button id="bgColorBtn" class="btn btn-secondary btn-icon" style="background:rgba(255,255,255,0.95);color:#333;border:1px solid #ddd;box-shadow:0 2px 8px rgba(0,0,0,0.15);padding:8px 16px;border-radius:8px;font-size:14px;cursor:pointer;transition:all 0.2s ease;" title="×”×—×œ×£ ×¦×‘×¢ ×¨×§×¢">
            <span style="display:inline-block;width:16px;height:16px;border-radius:50%;background:#ffffff;border:2px solid #333;vertical-align:middle;margin-left:6px;"></span>
            ×¦×‘×¢ ×¨×§×¢
          </button>
          <div id="bgColorOptions" style="display:none;position:absolute;top:100%;left:50%;transform:translateX(-50%);margin-top:5px;background:white;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.2);padding:10px;white-space:nowrap;">
            <button class="bg-color-option" data-color="light" style="display:block;width:100%;padding:8px 12px;margin:4px 0;border:1px solid #ddd;border-radius:6px;background:#f7eadb;color:#333;cursor:pointer;font-size:14px;transition:all 0.2s ease;">
              <span style="display:inline-block;width:20px;height:20px;border-radius:4px;background:#f7eadb;border:1px solid #999;vertical-align:middle;margin-left:8px;"></span>
              ×—×•× ×‘×”×™×¨
            </button>
            <button class="bg-color-option" data-color="medium" style="display:block;width:100%;padding:8px 12px;margin:4px 0;border:1px solid #ddd;border-radius:6px;background:#ecd9bd;color:#333;cursor:pointer;font-size:14px;transition:all 0.2s ease;">
              <span style="display:inline-block;width:20px;height:20px;border-radius:4px;background:#ecd9bd;border:1px solid #999;vertical-align:middle;margin-left:8px;"></span>
              ×—×•× ×‘×™× ×•× ×™
            </button>
            <button class="bg-color-option" data-color="dark" style="display:block;width:100%;padding:8px 12px;margin:4px 0;border:1px solid #ddd;border-radius:6px;background:#dec4a3;color:#333;cursor:pointer;font-size:14px;transition:all 0.2s ease;">
              <span style="display:inline-block;width:20px;height:20px;border-radius:4px;background:#dec4a3;border:1px solid #999;vertical-align:middle;margin-left:8px;"></span>
              ×—×•× ×›×”×”
            </button>
          </div>
        </div>
      </div>
      <button id="mdFullscreenBtn" class="btn btn-secondary btn-icon" title="××¡×š ××œ×">
        <i class="fas fa-expand"></i>
        ××¡×š ××œ×
      </button>
    </div>
    <div class="search-bar" id="md-search" style="display:flex;flex-wrap:wrap;gap:.5rem;align-items:center;background:linear-gradient(135deg,#2d4a7c 0%,#3d5a8c 100%);padding:.75rem;border-radius:12px 12px 0 0;box-shadow:0 2px 8px rgba(0,0,0,0.2);margin:-16px -16px 0 -16px;position:relative;">
      <input id="mdSearchInput" type="text" placeholder="ğŸ” ×—×¤×© ×‘×§×•×“..." style="flex:1 1 220px;min-width:0;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);border-radius:8px;padding:.6rem .8rem;color:#fff;font-size:.95rem;outline:none;">
      <span id="mdSearchCount" class="result-count" style="color:rgba(255,255,255,.9);font-size:.85rem;padding:.35rem .6rem;background:rgba(255,255,255,.12);border-radius:6px;min-width:60px;text-align:center;flex:0 0 auto;"></span>
      <button id="mdSearchNext" type="button" class="btn btn-secondary btn-icon" title="×”×‘×" style="background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);flex:0 0 auto;">â–¶</button>
      <button id="mdSearchClear" type="button" class="btn btn-secondary btn-icon" title="× ×§×”" style="background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);flex:0 0 auto;">âœ•</button>
    </div>
    <div id="md-content" style="margin-inline:-4px;width:calc(100% + 8px);"></div>
  </div>

  <!-- ×ª×•×›×Ÿ ×¢× ×™×™× ×™× ×¦×£ ××ª×§×“× ×¢× ×›×œ ×”×¤×™×¦'×¨×™× (×××•×§× ××—×¨×™ #mdCard ×›×“×™ ×©×›×œ×œ×™ CSS ×©×œ fullscreen ×™×¢×‘×“×•) -->
  <div id="mdToc" class="md-toc" style="display:none;"
       role="navigation"
       aria-label="×ª×•×›×Ÿ ×¢× ×™×™× ×™× ×©×œ ×”××¡××š">

    <!-- ×›×•×ª×¨×ª ×¢× ××™× ×“×™×§×˜×•×¨ ×”×ª×§×“××•×ª -->
    <div class="md-toc-header">
      <div class="md-toc-title-wrapper">
        <h3 id="toc-heading">
          <i class="fas fa-list" aria-hidden="true"></i>
          ×ª×•×›×Ÿ ×¢× ×™×™× ×™×
        </h3>
        <div class="md-toc-progress" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
          <div class="md-toc-progress-bar" id="tocProgressBar"></div>
        </div>
      </div>
      <div class="md-toc-controls">
        <button id="mdTocSearch"
                class="md-toc-search-btn"
                aria-label="×—×¤×© ×‘×›×•×ª×¨×•×ª"
                title="×—×™×¤×•×© (Ctrl+F)">
          <i class="fas fa-search" aria-hidden="true"></i>
        </button>
        <!-- ×¡××œ ×ª×¤×¨×™×˜ (â˜°) â€“ ×œ×—×™×¦×” ××¨×•×›×” ×ª××–×¢×¨ ××ª ×”×¤×× ×œ -->
        <button id="mdTocMenuBtn"
                class="md-toc-toggle"
                aria-label="××–×¢×•×¨ ×”×ª×¤×¨×™×˜ ×‘×œ×—×™×¦×” ××¨×•×›×”"
                title="×œ×—×™×¦×” ××¨×•×›×”: ××–×¢×¨ (â˜°)">
          <i class="fas fa-bars" aria-hidden="true"></i>
        </button>
        <button id="mdTocToggle"
                class="md-toc-toggle"
                aria-controls="mdTocNav"
                aria-expanded="true"
                aria-labelledby="toc-heading"
                title="×›×•×•×¥ ××• ×”×¨×—×‘ (Ctrl+T)">
          <i class="fas fa-chevron-up" aria-hidden="true"></i>
        </button>
      </div>
    </div>

    <!-- ×ª×™×‘×ª ×—×™×¤×•×© (××•×¡×ª×¨×ª ×‘×”×ª×—×œ×”) -->
    <div class="md-toc-search-container" id="tocSearchContainer" style="display:none;">
      <input type="search"
             id="tocSearchInput"
             class="md-toc-search-input"
             placeholder="×—×¤×© ×‘×›×•×ª×¨×•×ª..."
             aria-label="×—×™×¤×•×© ×‘×ª×•×›×Ÿ ×”×¢× ×™×™× ×™×">
      <span class="md-toc-search-results" id="tocSearchResults"></span>
    </div>

    <!-- ××–×•×¨ ×”× ×™×•×•×˜ ×¢× Virtual Scrolling -->
    <nav id="mdTocNav"
         class="md-toc-nav"
         aria-labelledby="toc-heading"
         role="list">
      <!-- ×›××Ÿ ×™×•×›× ×¡×• ×”×›×•×ª×¨×•×ª ×“×™× ××™×ª -->
    </nav>
  </div>
  <!-- ×›×¤×ª×•×¨ ××™× ×™××œ×™ ×¦×£ (××—×•×¥ ×œ×¤×× ×œ) -->
  <button id="mdTocMini"
          class="md-toc-mini-btn"
          style="display:none;"
          aria-label="×”×¦×’ ×ª×•×›×Ÿ ×¢× ×™×™× ×™×"
          title="×”×¦×’ ×ª×•×›×Ÿ ×¢× ×™×™× ×™×">
    <i class="fas fa-bars"></i>
  </button>

  {% if not is_public %}
  <div class="glass-card" style="margin-top: 1rem;">
    <h2 class="section-title">
      <i class="fas fa-share-alt"></i>
      ×©×™×ª×•×£
    </h2>
    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
      <button onclick="shareToTelegramMd()" class="btn btn-secondary btn-icon">
        <i class="fab fa-telegram"></i>
        ×©×ª×£ ×‘×˜×œ×’×¨×
      </button>
      <button onclick="openShareLinkModalMd()" class="btn btn-secondary btn-icon">
        <i class="fas fa-link"></i>
        ×”×¢×ª×§ ×§×™×©×•×¨
      </button>
    </div>
  </div>

  <div id="shareLinkModalMd" class="share-link-modal" role="dialog" aria-modal="true" aria-labelledby="shareLinkMdTitle" hidden>
    <div class="share-link-modal__content" role="document">
      <h3 id="shareLinkMdTitle" class="share-link-modal__title">×‘×—×¨×• ×¡×•×’ ×§×™×©×•×¨</h3>
      <p class="share-link-modal__subtitle">××¤×©×¨ ×œ×™×¦×•×¨ ×§×™×©×•×¨ ×–×× ×™ (×¤×’ ×ª×•×§×£ ××•×˜×•××˜×™×ª) ××• ×§×™×©×•×¨ ×§×‘×•×¢ ×œ×œ× ×ª×¤×•×’×”.</p>
      <div class="share-link-modal__actions">
        <button type="button" class="btn btn-primary" onclick="copyShareLinkMd(false)">
          <i class="fas fa-clock"></i>
          ×§×™×©×•×¨ ×–×× ×™
        </button>
        <button type="button" class="btn btn-secondary" onclick="copyShareLinkMd(true)">
          <i class="fas fa-infinity"></i>
          ×§×™×©×•×¨ ×§×‘×•×¢
        </button>
      </div>
      <button type="button" class="share-link-modal__close" onclick="closeShareLinkModalMd()" aria-label="×¡×’×•×¨">âœ•</button>
    </div>
  </div>

  <style>
  .share-link-modal {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.55);
    z-index: 9999;
  }
  .share-link-modal[hidden] {
    display: none;
  }
  .share-link-modal__content {
    background: #1f2a44;
    border-radius: 16px;
    padding: 1.5rem;
    max-width: 420px;
    width: calc(100% - 2rem);
    color: #fff;
    position: relative;
    box-shadow: 0 12px 30px rgba(0, 0, 0, 0.35);
  }
  .share-link-modal__title {
    margin: 0 0 0.5rem;
    font-size: 1.3rem;
  }
  .share-link-modal__subtitle {
    margin: 0 0 1.25rem;
    color: rgba(255, 255, 255, 0.8);
  }
  .share-link-modal__actions {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }
  .share-link-modal__actions .btn {
    flex: 1 1 150px;
  }
  .share-link-modal__close {
    position: absolute;
    top: 0.75rem;
    left: 0.75rem;
    background: transparent;
    border: none;
    color: rgba(255, 255, 255, 0.7);
    font-size: 1.1rem;
    cursor: pointer;
  }
  .share-link-modal__close:hover,
  .share-link-modal__close:focus {
    color: #fff;
  }
  </style>
  {% endif %}
  <script type="application/json" id="mdText">{{ md_code | tojson | safe }}</script>
  <script>
    // ×—×©×•×£ ××–×”×” ×§×•×‘×¥ ×œ×©×™××•×© ×¨×›×™×‘×™ ××™× ×˜×¨××§×¦×™×” (×¤×ª×§×™× ×“×‘×™×§×™× ×•×›×•')
    window.FILE_ID = "{{ file.id }}";
  </script>
</div>

<script>
// ××–×”×” ×§×•×‘×¥ ×œ×©×™××•×© ×‘×©××™×¨×ª ×”×¢×“×¤×•×ª ×¤×¨-×§×•×‘×¥
const FILE_ID = "{{ file.id }}";
const FILE_VIEW_URL = "{{ url_for('view_file', file_id=file.id) }}";
// ×ª×•×›×Ÿ ×”-Markdown ××•×¢×‘×¨ ×‘×‘×˜×—×” JSON-encoded
const MD_TEXT = (function(){
  try {
    var el = document.getElementById('mdText');
    if (!el) return "";
    return JSON.parse(el.textContent || '""');
  } catch(_) { return ""; }
})();

// ×©××™×¨×ª ××¦×‘ ×¨×©×™××•×ª ××©×™××•×ª (×œ×¤×™ ×§×•×‘×¥) ×‘-localStorage
const STORAGE_KEY = `md_tasks_state:{{ file.id }}`;
function loadTaskState(){
  try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); }catch(_){ return {}; }
}
function saveTaskState(state){
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state || {})); }catch(_){ }
}
const taskState = loadTaskState();

// ×˜×¢×™× ×ª bundle ××§×•××™ (×œ×œ× CDN)
const BUNDLE = {
  js: "{{ url_for('static', filename='js/md_preview.bundle.js') }}",
  css: "{{ url_for('static', filename='css/md_preview.bundle.css') }}"
};

// ×ª××™××•×ª ×œ××—×•×¨: ××¤×” "CDN" ×œ×¢×¨×›×™× ××§×•××™×™× ×›×š ×©×œ× × ×“×¨×© ×¨×©×ª
const CDN = {
  md: BUNDLE.js,
  mdEmoji: null,
  mdTask: null,
  mdAnchor: null,
  mdFootnote: null,
  mdTocDone: null,
  mdContainer: null,
  mdAdmonition: null,
  hljs: null,
  hljsCss: BUNDLE.css,
  katexCss: BUNDLE.css,
  katexJs: null,
  katexAuto: null,
  mermaid: null
};

// Slug ×™×¦×™×‘ ×‘×¡×’× ×•×Ÿ GitHub â€“ ×©×•××¨ ×¢×œ ×”×ª×××” ×œ×ª×•×›×Ÿ ×¢× ×™×™× ×™× ×™×“× ×™ ×’× ×‘×›×•×ª×¨×•×ª ×¨×‘Ö¾×œ×©×•× ×™×•×ª
function slugifyHeadingId(rawText) {
  try {
    let slug = (rawText || '')
      .toString()
      .trim()
      .toLowerCase()
      .normalize('NFKD')
      // × ×™×§×•×™ ×¡×™×× ×™× ×‘×œ×ª×™ ××•×“×¤×¡×™×/RTL ×•×›×“×•××”
      .replace(/[\u200B-\u200D\uFEFF]/g, '')
      // ×”×¡×¨×ª ×¡×™×× ×™ × ×™×§×•×“ ×œ××—×¨ × ×¨××•×œ (×›××• Ã¡ -> a)
      .replace(/\p{M}+/gu, '')
      // ×”×©××¨×ª ××•×ª×™×•×ª (××›×œ ×©×¤×”), ×¡×¤×¨×•×ª, ×¨×•×•×—×™× ×•××§×¤×™× ×‘×˜×•×—×™×
      .replace(/[^\p{L}\p{N}\s-]+/gu, '')
      // ×”××¨×” ×©×œ ×¨×•×•×—×™× ×¨×¦×•×¤×™× ×œ××§×£ ×™×—×™×“
      .replace(/\s+/g, '-')
      // ×‘×™×˜×•×œ ×¨×™×‘×•×™ ××§×¤×™× ×¨×¦×•×¤×™×
      .replace(/-{2,}/g, '-')
      // ×”×¡×¨×ª ××§×¤×™× ××•×‘×™×œ×™× ××• ××¡×™×™××™× ×©× ×•×¦×¨×• ×œ××—×¨ ×”× ×™×§×•×™
      .replace(/^-+|-+$/g, '');

    // ××™×Ÿ ××¦×‘ ×©× ×©××™×¨ ×¢×•×’×Ÿ ×¨×™×§ â€“ × ×¡×¤×§ ×‘×¨×™×¨×ª ××—×“×œ ×™×¦×™×‘×”
    if (!slug) {
      slug = 'section';
    }

    return slug;
  } catch (_) {
    // ×‘××§×¨×” × ×“×™×¨ ×©×œ ×©×’×™××ª RegExp ×‘×“×¤×“×¤×Ÿ ×™×©×Ÿ, ×  fallback ×œ×©×™×˜×” ×‘×¡×™×¡×™×ª
    const safe = (rawText || '')
      .toString()
      .trim()
      .toLowerCase()
      .replace(/\s+/g, '-')
      .replace(/[^a-z0-9-]/g, '') || 'section';
    return safe;
  }
}

function injectCss(href){
  if (!href) return;
  try {
    if (document.querySelector('link[rel="stylesheet"][href="' + href + '"]')) return;
  } catch(_) {}
  const l = document.createElement('link');
  l.rel = 'stylesheet';
  l.href = href;
  document.head.appendChild(l);
}
function loadScript(src){
  return new Promise((res, rej) => {
    if (!src) { res(); return; }
    try {
      if (document.querySelector('script[src="' + src + '"]')) { res(); return; }
    } catch(_) {}
    const s = document.createElement('script');
    s.src = src;
    s.defer = true;
    s.onload = res;
    s.onerror = rej;
    document.head.appendChild(s);
  });
}

(async function(){
  try{
    injectCss(CDN.hljsCss);
    injectCss(CDN.katexCss);
    try { await loadScript(CDN.md); } catch(_){}
    try { await loadScript(CDN.mdEmoji); } catch(_){}
    try { await loadScript(CDN.mdTask); } catch(_){}
    try { await loadScript(CDN.mdAnchor); } catch(_){}
    try { await loadScript(CDN.mdFootnote); } catch(_){}
    try { await loadScript(CDN.mdTocDone); } catch(_){}
    try { await loadScript(CDN.mdContainer); } catch(_){}
    try { await loadScript(CDN.mdAdmonition); } catch(_){}
    try { await loadScript(CDN.hljs); } catch(_){}
    try { await loadScript(CDN.katexJs); } catch(_){}
    try { await loadScript(CDN.katexAuto); } catch(_){}
    try { await loadScript(CDN.mermaid); } catch(_){}

    const md = (window.markdownit ? window.markdownit : (()=>({render:(s)=>s})))({
      breaks: true,
      linkify: true,
      typographer: true,
      html: false,
      // ×œ× ×œ×‘×¦×¢ ×”×“×’×©×” ×‘×©×œ×‘ ×”-render ×©×œ markdown-it; × ×‘×¦×¢ post-process ×¢× hljs
      highlight: function (_str, _lang) { return ''; }
    })
    if (window.markdownitEmoji) md.use(window.markdownitEmoji);
    if (window.markdownitTaskLists) md.use(window.markdownitTaskLists, { label: true, enabled: true });
    // ×¢×•×’× ×™ ×›×•×ª×¨×•×ª â€“ ×”×’×“×¨×” ×™×¦×™×‘×” ×œ×× ×™×¢×ª ×¨×’×¨×¡×™×•×ª ×‘×™×Ÿ ×’×¨×¡××•×ª ×”×ª×•×¡×£
    if (window.markdownitAnchor) {
      const anchorOptions = { permalink: true, permalinkSymbol: 'Â¶', slugify: slugifyHeadingId };
      try {
        md.use(window.markdownitAnchor, anchorOptions);
      } catch(_) {
        try { md.use(window.markdownitAnchor, { slugify: slugifyHeadingId }); } catch(__) {}
      }
    }
    if (window.markdownitFootnote) md.use(window.markdownitFootnote);
    // ×ª××™×›×” ×’× ×‘×©××•×ª ×’×œ×•×‘×œ×™×™× ×©×•× ×™× ×©×œ ×”×ª×•×¡×£ (markdown-it-admonition)
    (function(){
      try {
        const admonitionPlugin = (window.markdownitAdmonition || window.markdownItAdmonition || window.markdownItAdmonitionDefault || null);
        if (admonitionPlugin) {
          md.use(admonitionPlugin, {
            types: ['note','tip','warning','danger','info','success','question','example','quote','experimental','deprecated','todo','abstract']
          });
        }
      } catch(_) {}
    })();
    // ×ª××™×›×” ×¨×©××™×ª ×‘×ª×—×‘×™×¨ ::: ×¢"×™ markdown-it-container ×¢×‘×•×¨ ×›×œ ×”×¡×•×’×™× ×•×”-details
    (function(){
      try {
        const containerPlugin = (window.markdownitContainer || window.markdownItContainer || null);
        if (!containerPlugin) return;
        const types = ['details','note','tip','warning','danger','info','success','question','example','quote','experimental','deprecated','todo','abstract'];
        const DEFAULT_TITLES = { note:'×”×¢×¨×”', tip:'×˜×™×¤', warning:'××–×”×¨×”', danger:'×¡×›× ×”', info:'××™×“×¢', success:'×”×¦×œ×—×”', question:'×©××œ×”', example:'×“×•×’××”', quote:'×¦×™×˜×•×˜', experimental:'× ×™×¡×•×™', deprecated:'×œ× ××•××œ×¥', todo:'×œ×¢×©×•×ª', abstract:'×ª×§×¦×™×¨' };
        function defaultTitle(type){ return DEFAULT_TITLES[type] || type; }

        types.forEach(function(type){
          if (type === 'details') {
            md.use(containerPlugin, 'details', {
              validate: function(params){ return /^details\b/i.test((params||'').trim()); },
              render: function(tokens, idx){
                const m = (tokens[idx].info || '').trim().match(/^details\s+(.*)$/i);
                const title = (m && m[1] && m[1].trim()) || '×œ×—×¥ ×œ×”×¦×’×”';
                if (tokens[idx].nesting === 1) {
                  return `<details class="markdown-details"><summary class="markdown-summary">${md.utils.escapeHtml(title)}</summary><div class="details-content">`;
                }
                return `</div></details>\n`;
              }
            });
          } else {
            // ×›×¨×˜×™×¡×™×•×ª ×”×¡×‘×¨ (admonitions) ×¢× ::: tip ×›×•×ª×¨×ª
            const rxOpen = new RegExp('^' + type + '\\b\\s*(.*)$', 'i');
            md.use(containerPlugin, type, {
              validate: function(params){ return rxOpen.test((params||'').trim()); },
              render: function(tokens, idx){
                const info = (tokens[idx].info || '').trim();
                const m = info.match(rxOpen);
                const title = (m && m[1] && m[1].trim()) || defaultTitle(type);
                if (tokens[idx].nesting === 1) {
                  return `<div class="admonition admonition-${type}"><div class="admonition-title">${md.utils.escapeHtml(title)}</div><div class="admonition-content">`;
                }
                return `</div></div>\n`;
              }
            });
          }
        });
      } catch(_) {}
    })();
    if (window.markdownitTocDoneRight) {
      try {
        md.use(window.markdownitTocDoneRight, { slugify: slugifyHeadingId });
      } catch(_) {
        try { md.use(window.markdownitTocDoneRight); } catch(__) {}
      }
    }

    // ×¨×™× ×“×•×¨ ×¨××©×•× ×™
    const container = document.getElementById('md-content');
    container.innerHTML = md.render(MD_TEXT || '');
    // ×‘×“×™×§×ª smoke ××”×™×¨×”: ×”×× ::: tip ××•××¨ ×œ-admonition (×œ×•×’ ×‘×œ×‘×“)
    try {
      const smoke = md.render('::: tip ×‘×“×™×§×ª ×˜×™×¤\n×ª×•×›×Ÿ\n:::');
      console.info('Admonition(::: tip) supported =', /class="admonition admonition-tip"/.test(smoke));
    } catch(_) {}
    try {
      // ×”×©×œ× ××–×”×™ ×¢×•×’×Ÿ ×—×¡×¨×™× ×•×”×¡×¨ ×›×¤×™×œ×•×™×•×ª ×›×“×™ ×©×¡×™×× ×™×•×ª ×¢×œ ×›×•×ª×¨×•×ª ×™×¢×‘×“×• ×™×¦×™×‘
      const seen = new Set();
      const gen = (t, el) => {
        const base = slugifyHeadingId(t);
        let candidate = base;
        let idx = 2;
        while (seen.has(candidate) || (document.getElementById(candidate) && document.getElementById(candidate) !== el)) {
          candidate = `${base}-${idx++}`;
        }
        seen.add(candidate);
        return candidate;
      };
      Array.from(container.querySelectorAll('h1, h2, h3, h4, h5, h6')).forEach(h => {
        const txt = (h.textContent || '').trim();
        if (!h.id) { h.id = gen(txt, h); }
        else if (seen.has(h.id)) { h.id = gen(txt, h); }
        else { seen.add(h.id); }
      });
    } catch(_) {}

    // ×”××¨×” ×©×œ ::: details / ::: admonitions / ??? ×•-!!! ×œ-HTML ×‘×˜×•×— ×œ××—×¨ ×”×¨×™× ×“×•×¨
    (function enhanceMarkdownContainers() {
      try {
        if (!container) return;
        const OPEN_RE = /^:{3,}\s*(details|note|tip|warning|danger|info|success|question|example|quote|experimental|deprecated|todo|abstract)\b/i;
        const CLOSE_RE = /^:{3,}\s*$/;
        const Q_OPEN_RE = /^\?{3,}\s*([+\-])?\s*(?:details|note|tip|warning|danger|info|success|question|example|quote|experimental|deprecated|todo|abstract)?\b/i;
        const Q_CLOSE_RE = /^\?{3,}\s*$/;
        const B_OPEN_RE = /^!{3,}\s*([a-z]+)?\s*(.*)$/i; // !!! type? title?
        const B_CLOSE_RE = /^!{3,}\s*$/;
        function isOpenMarker(p){ return p && p.tagName === 'P' && OPEN_RE.test((p.textContent || '').trim()); }
        function isCloseMarker(p){ return p && p.tagName === 'P' && CLOSE_RE.test((p.textContent || '').trim()); }
        function isQOpenMarker(p){ return p && p.tagName === 'P' && Q_OPEN_RE.test((p.textContent || '').trim()); }
        function isQCloseMarker(p){ return p && p.tagName === 'P' && Q_CLOSE_RE.test((p.textContent || '').trim()); }
        function isBOpenMarker(p){ return p && p.tagName === 'P' && B_OPEN_RE.test((p.textContent || '').trim()); }
        function isBCloseMarker(p){ return p && p.tagName === 'P' && B_CLOSE_RE.test((p.textContent || '').trim()); }
        function findMatchingClose(startP) {
          let depth = 0;
          let cursor = startP.nextElementSibling;
          while (cursor) {
            if (isOpenMarker(cursor)) depth += 1;
            else if (isCloseMarker(cursor)) {
              if (depth === 0) return cursor;
              depth -= 1;
            }
            cursor = cursor.nextElementSibling;
          }
          return null;
        }
        function findMatchingQClose(startP) {
          let depth = 0;
          let cursor = startP.nextElementSibling;
          while (cursor) {
            if (isQOpenMarker(cursor)) depth += 1;
            else if (isQCloseMarker(cursor)) {
              if (depth === 0) return cursor;
              depth -= 1;
            }
            cursor = cursor.nextElementSibling;
          }
          return null;
        }
        function findMatchingBClose(startP) {
          let depth = 0;
          let cursor = startP.nextElementSibling;
          while (cursor) {
            if (isBOpenMarker(cursor)) depth += 1;
            else if (isBCloseMarker(cursor)) {
              if (depth === 0) return cursor;
              depth -= 1;
            }
            cursor = cursor.nextElementSibling;
          }
          return null;
        }
        function extractBetween(startP, endP) {
          if (!endP) return null;
          const frag = document.createDocumentFragment();
          let cur = startP.nextSibling;
          while (cur && cur !== endP) { const next = cur.nextSibling; frag.appendChild(cur); cur = next; }
          return frag;
        }
        function defaultTitle(type){ const m={note:'×”×¢×¨×”',tip:'×˜×™×¤',warning:'××–×”×¨×”',danger:'×¡×›× ×”',info:'××™×“×¢',success:'×”×¦×œ×—×”',question:'×©××œ×”',example:'×“×•×’××”',quote:'×¦×™×˜×•×˜',experimental:'× ×™×¡×•×™',deprecated:'×œ× ××•××œ×¥',todo:'×œ×¢×©×•×ª',abstract:'×ª×§×¦×™×¨'}; return m[type]||type; }
        function transformIn(root) {
          let changed = false;
          let node = root.firstElementChild;
          while (node) {
            if (node.tagName === 'P') {
              const text = (node.textContent || '').trim();
              let m = text.match(/^:{3,}\s*details\s*(.*)$/i);
              if (m) {
                const endP = findMatchingClose(node);
                if (!endP) { node = node.nextElementSibling; continue; }
                const frag = extractBetween(node, endP);
                const details = document.createElement('details'); details.className = 'markdown-details';
                const summary = document.createElement('summary'); summary.className = 'markdown-summary'; summary.textContent = m[1] ? m[1].trim() : '×œ×—×¥ ×œ×”×¦×’×”';
                const content = document.createElement('div'); content.className = 'details-content'; content.appendChild(frag);
                details.appendChild(summary); details.appendChild(content);
                const parent = node.parentNode; parent.replaceChild(details, node);
                if (endP && endP.parentNode) endP.parentNode.removeChild(endP);
                // ×¢×‘×“ ×¨×§×•×¨×¡×™×‘×™×ª ×‘×ª×•×š ×”×ª×•×›×Ÿ, ×œ×ª××™×›×” ×‘×§×™× ×•×Ÿ
                try { transformIn(content); } catch(_) {}
                node = details;
                changed = true;
              } else {
                m = text.match(/^:{3,}\s*(note|tip|warning|danger|info|success|question|example|quote|experimental|deprecated|todo|abstract)\s*(.*)$/i);
                if (m) {
                  const type = m[1].toLowerCase(); const titleTxt = (m[2] || '').trim() || defaultTitle(type);
                  const endP = findMatchingClose(node);
                  if (!endP) { node = node.nextElementSibling; continue; }
                  const frag = extractBetween(node, endP);
                  const wrap = document.createElement('div'); wrap.className = 'admonition admonition-' + type;
                  const title = document.createElement('div'); title.className = 'admonition-title'; title.textContent = titleTxt;
                  const content = document.createElement('div'); content.className = 'admonition-content'; content.appendChild(frag);
                  wrap.appendChild(title); wrap.appendChild(content);
                  const parent = node.parentNode; parent.replaceChild(wrap, node);
                  if (endP && endP.parentNode) endP.parentNode.removeChild(endP);
                  try { transformIn(content); } catch(_) {}
                  node = wrap;
                  changed = true;
                } else {
                  // ??? blocks: ??? [+/âˆ’] [type?] [title?]
                  m = text.match(/^\?{3,}\s*([+\-])?\s*([a-z]+)?\s*(.*)$/i);
                  if (m) {
                    const openFlag = (m[1] || '').trim();
                    const type = (m[2] || 'question').toLowerCase();
                    const titleTxt = (m[3] || '').trim() || defaultTitle(type);
                    const endP = findMatchingQClose(node);
                    if (!endP) { node = node.nextElementSibling; continue; }
                    const frag = extractBetween(node, endP);
                    const details = document.createElement('details'); details.className = 'markdown-details admonition admonition-' + type; if (openFlag === '+') details.setAttribute('open', '');
                    const summary = document.createElement('summary'); summary.className = 'markdown-summary admonition-title'; summary.textContent = titleTxt;
                    const content = document.createElement('div'); content.className = 'details-content admonition-content'; content.appendChild(frag);
                    details.appendChild(summary); details.appendChild(content);
                    const parent = node.parentNode; parent.replaceChild(details, node);
                    if (endP && endP.parentNode) endP.parentNode.removeChild(endP);
                    try { transformIn(content); } catch(_) {}
                    node = details;
                    changed = true;
                  } else {
                    // !!! blocks: !!! [type?] [title?] ... !!!
                    m = text.match(/^!{3,}\s*([a-z]+)?\s*(.*)$/i);
                    if (m) {
                      const type = (m[1] || 'note').toLowerCase();
                      const titleTxt = (m[2] || '').trim() || defaultTitle(type);
                      const endP = findMatchingBClose(node);
                      if (!endP) { node = node.nextElementSibling; continue; }
                      const frag = extractBetween(node, endP);
                      const wrap = document.createElement('div'); wrap.className = 'admonition admonition-' + type;
                      const title = document.createElement('div'); title.className = 'admonition-title'; title.textContent = titleTxt;
                      const content = document.createElement('div'); content.className = 'admonition-content'; content.appendChild(frag);
                      wrap.appendChild(title); wrap.appendChild(content);
                      const parent = node.parentNode; parent.replaceChild(wrap, node);
                      if (endP && endP.parentNode) endP.parentNode.removeChild(endP);
                      try { transformIn(content); } catch(_) {}
                      node = wrap;
                      changed = true;
                    }
                  }
                }
              }
            }
            node = node.nextElementSibling;
          }
          return changed;
        }
        // ×”×¨×¥ ×¢×“ ×©×œ× × ×©××¨×™× ×‘×œ×•×§×™× ×œ×¢×™×‘×•×“ (××’×Ÿ ××œ×•×œ××•×ª ××™× ×¡×•×¤×™×•×ª ×¢"×™ ××§×¡×™××•× ××™×˜×¨×¦×™×•×ª)
        let guard = 0;
        while (transformIn(container) && guard < 10) { guard++; }
      } catch(_) {}
    })();

    // ×”×“×’×©×ª ×ª×—×‘×™×¨ ×œ××—×¨ ×”×¨×™× ×“×•×¨: ×”×“×’×©×” ×××•×§×“×ª ×‘×ª×•×š #md-content ×‘×œ×‘×“
    try {
      if (window.hljs) {
        try { if (typeof window.hljs.highlightAll === 'function') window.hljs.highlightAll(); } catch(_){}
        container.querySelectorAll('pre code').forEach(el => {
          try {
            if (el.classList.contains('hljs')) return;
            var hasLang = /\blanguage-/.test(el.className || '');
            if (hasLang && typeof window.hljs.highlightElement === 'function') {
              window.hljs.highlightElement(el);
            } else if (typeof window.hljs.highlightAuto === 'function') {
              var res = window.hljs.highlightAuto(el.textContent || '');
              el.innerHTML = res.value;
              el.classList.add('hljs');
            }
          } catch(__) {}
        });
      }
    } catch(_) { }

    // ××—×¨×™ ×”×“×’×©×ª hljs â€“ × ×©××•×¨ ××§×•×¨ ×¨×§ ×œ×›×œ ×‘×œ×•×§ ×§×•×“ (×œ× ×œ×›×œ ×”×§×•× ×˜×™×™× ×¨)
    try {
      const blocks = container.querySelectorAll('pre code');
      blocks.forEach(code => {
        if (!code.hasAttribute('data-original-html')) {
          code.setAttribute('data-original-html', code.innerHTML);
        }
      });
    } catch(_) {}

    // ×—×™×¤×•×© ×•×”×“×’×©×” ×‘×ª×•×š ×§×˜×¢×™ ×§×•×“ ×‘×œ×‘×“
    (function(){
      const input = document.getElementById('mdSearchInput');
      const clearBtn = document.getElementById('mdSearchClear');
      const nextBtn = document.getElementById('mdSearchNext');
      const countEl = document.getElementById('mdSearchCount');
      if (!input || !clearBtn || !countEl) return;
      let justAutoFocused = false;

      function restore() {
        // ××©×—×–×¨ ×›×œ ×‘×œ×•×§ ×§×•×“ ××”××§×•×¨ ×©× ×©××¨ ×‘×•, ×‘×œ×™ ×œ×’×¢×ª ×‘×©××¨ ×”-HTML ×•×”×“×’×©×•×ª hljs
        const blocks = container.querySelectorAll('pre code');
        blocks.forEach(code => {
          try {
            const orig = code.getAttribute('data-original-html');
            if (orig != null) {
              code.innerHTML = orig;
            }
          } catch(_) {}
        });
      }

      function highlightTerm(term) {
        // ××“×’×™×© ×¨×§ ×‘×ª×•×š pre > code ×›×“×™ ×œ× ×œ×©×‘×•×¨ HTML ××—×•×¥ ×œ×§×•×“
        const blocks = container.querySelectorAll('pre code');
        let total = 0;
        blocks.forEach(code => {
          try {
            const original = code.getAttribute('data-original-html') || code.innerHTML;
            code.setAttribute('data-original-html', original);
            if (!term) { code.innerHTML = original; return; }
            const safe = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const rx = new RegExp(`(${safe})`, 'gi');
            const replaced = original.replace(rx, '<span class="md-highlight">$1</span>');
            code.innerHTML = replaced;
            total += (original.match(rx) || []).length;
          } catch(_) {}
        });
        return total;
      }

      function updateCount(n, term){
        if (!term) { countEl.textContent = ''; return; }
        const active = container.querySelector('.md-highlight.is-active');
        const activeIndex = active ? (Array.from(container.querySelectorAll('.md-highlight')).indexOf(active) + 1) : 0;
        countEl.textContent = n > 0 ? (activeIndex ? `${activeIndex}/${n}` : `${n} ×ª×•×¦××•×ª`) : '××™×Ÿ ×ª×•×¦××•×ª';
      }

      function setActiveAndScroll(target){
        try { container.querySelectorAll('.md-highlight.is-active').forEach(el => el.classList.remove('is-active')); } catch(_){ }
        if (!target) return;
        try { target.classList.add('is-active'); } catch(_){ }
        try { target.scrollIntoView({ behavior:'smooth', block:'center' }); } catch(_){ }
      }

      function focusFirst(){
        const first = container.querySelector('.md-highlight');
        if (first) setActiveAndScroll(first);
      }

      function focusNext(){
        const all = Array.from(container.querySelectorAll('.md-highlight'));
        if (all.length === 0) return;
        const current = container.querySelector('.md-highlight.is-active');
        const idx = current ? all.indexOf(current) : -1;
        const next = all[(idx + 1) % all.length];
        setActiveAndScroll(next);
        updateCount(all.length, input.value.trim());
      }

      input.addEventListener('input', () => {
        const term = (input.value || '').trim();
        restore();
        const n = highlightTerm(term);
        if (term && n > 0) {
          focusFirst();
          justAutoFocused = true;
        }
        updateCount(n, term);
      });

      clearBtn.addEventListener('click', () => {
        input.value = '';
        restore();
        updateCount(0, '');
        justAutoFocused = false;
      });

      if (nextBtn) {
        nextBtn.addEventListener('click', () => {
          const term = (input.value || '').trim();
          if (!term) return;
          const active = container.querySelector('.md-highlight.is-active');
          if (justAutoFocused || !active) {
            const first = container.querySelector('.md-highlight');
            if (first) setActiveAndScroll(first);
            justAutoFocused = false;
            updateCount(container.querySelectorAll('.md-highlight').length, term);
          } else {
            focusNext();
          }
        });
      }

      input.addEventListener('keydown', (ev) => {
        if (ev.key === 'Enter') {
          ev.preventDefault();
          const all = container.querySelectorAll('.md-highlight');
          if (all.length === 0) return;
          if (ev.shiftKey) {
            const arr = Array.from(all);
            const current = container.querySelector('.md-highlight.is-active');
            const idx = current ? arr.indexOf(current) : 0;
            const prev = arr[(idx - 1 + arr.length) % arr.length];
            setActiveAndScroll(prev);
            // reset auto-focus state so forward navigation advances
            justAutoFocused = false;
            updateCount(arr.length, input.value.trim());
          } else {
            const active = container.querySelector('.md-highlight.is-active');
            if (justAutoFocused || !active) {
              const first = container.querySelector('.md-highlight');
              if (first) setActiveAndScroll(first);
              justAutoFocused = false;
              updateCount(all.length, input.value.trim());
            } else {
              focusNext();
            }
          }
        }
      });

      // ×”×•×¡×¨ ×”×§×•×“ ×”×›×¤×•×œ ××”××™×™×Ÿ; × ×©××¨×ª ×¨×§ ×”×œ×•×’×™×§×” ×”×—×“×©×” ×©×œ× ××“×œ×’×ª ×¢×œ ×”×¨××©×•× ×”
    })();

    // Lazy loading ×œ×ª××•× ×•×ª
    container.querySelectorAll('img').forEach(img => { img.loading = 'lazy'; });

    // KaTeX ××•×˜×•-×¨× ×“×¨ (×‘×‘×˜×—×”; ××™×Ÿ html ×’×•×œ××™)
    try { if (window.renderMathInElement) window.renderMathInElement(container, { delimiters:[{left:'$$',right:'$$',display:true},{left:'$',right:'$',display:false}] }); } catch(_){ }

    // Mermaid: ×¨× ×“×¨ ×“×™××’×¨××•×ª ×‘×§×•×“ fence ```mermaid
    try {
      if (!window.mermaid) throw new Error('mermaid missing');
      window.mermaid.initialize({ startOnLoad: false, securityLevel: 'strict' });
      const blocks = container.querySelectorAll('code.language-mermaid, pre code.language-mermaid');
      let i=0;
      for (const el of blocks) {
        const parent = el.closest('pre') || el.parentElement;
        const svgId = 'mmd_' + (++i);
        const code = el.textContent;
        const wrapper = document.createElement('div');
        parent.replaceWith(wrapper);
        try {
          const { svg } = await window.mermaid.render(svgId, code);
          wrapper.innerHTML = svg;
        } catch(e) {
          wrapper.innerHTML = '<div class="alert alert-warning">Mermaid render failed</div>';
        }
      }
    } catch(_){ }

    // ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ × ×’×™×©×•×ª ×‘×©×™××•×© ××©×•×ª×£ (copy/permalink)
    function announceToScreenReader(message) {
      try {
        const announcement = document.createElement('div');
        announcement.setAttribute('role', 'status');
        announcement.setAttribute('aria-live', 'polite');
        announcement.className = 'sr-only';
        announcement.textContent = message;
        document.body.appendChild(announcement);
        setTimeout(() => { try { document.body.removeChild(announcement); } catch(_){} }, 1000);
      } catch(_) {}
    }
    function fallbackCopy(text) {
      try {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        const success = document.execCommand('copy');
        document.body.removeChild(textarea);
        return success;
      } catch(_) { return false; }
    }
    // ×›×¤×ª×•×¨ ×”×¢×ª×§×” ××©×•×¤×¨ ×œ×›×œ ×‘×œ×•×§ ×§×•×“ + × ×’×™×©×•×ª ××œ××”
    try {
      function showCopySuccess(btn) {
        try {
          btn.classList.add('copied');
          const copyText = btn.querySelector('.copy-text');
          const copiedText = btn.querySelector('.copied-text');
          if (copyText) copyText.style.display = 'none';
          if (copiedText) copiedText.style.display = 'inline';
          setTimeout(() => {
            btn.classList.remove('copied');
            if (copyText) copyText.style.display = 'inline';
            if (copiedText) copiedText.style.display = 'none';
          }, 2000);
        } catch(_) {}
      }
      function showCopyError(btn) {
        try { btn.classList.add('copy-error'); setTimeout(() => btn.classList.remove('copy-error'), 2000); } catch(_) {}
      }
      function addCopyButtons() {
        const pres = document.querySelectorAll('#md-content pre');
        pres.forEach(pre => {
          if (pre.querySelector('.md-copy-btn')) return;
          let wrapper = pre.parentElement;
          if (!wrapper || !wrapper.classList || !wrapper.classList.contains('code-block')) {
            wrapper = document.createElement('div');
            wrapper.className = 'code-block';
            pre.replaceWith(wrapper);
            wrapper.appendChild(pre);
          }
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'md-copy-btn';
          btn.setAttribute('aria-label', '×”×¢×ª×§ ×§×•×“');
          btn.setAttribute('role', 'button');
          btn.innerHTML = `
            <span class="copy-icon" aria-hidden="true">ğŸ“‹</span>
            <span class="copy-text">×”×¢×ª×§</span>
            <span class="copied-text" style="display:none">âœ… ×”×•×¢×ª×§!</span>
          `;
          btn.addEventListener('click', async () => {
            const code = pre.querySelector('code')?.innerText || pre.innerText;
            try {
              await navigator.clipboard.writeText(code);
              showCopySuccess(btn);
              announceToScreenReader('×”×§×•×“ ×”×•×¢×ª×§ ×œ×œ×•×—');
            } catch(_) {
              if (fallbackCopy(code)) {
                showCopySuccess(btn);
                announceToScreenReader('×”×§×•×“ ×”×•×¢×ª×§ ×œ×œ×•×—');
              } else {
                showCopyError(btn);
                announceToScreenReader('×”×”×¢×ª×§×” × ×›×©×œ×”');
              }
            }
          });
          btn.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              btn.click();
            }
          });
          wrapper.appendChild(btn);
        });
      }
      addCopyButtons();
    } catch(_){ }

    // Permalinks × ×’×™×©×™×: ×”×¢×ª×§×ª ×§×™×©×•×¨ ×›×•×ª×¨×ª ×‘×œ×—×™×¦×” ×•××©×•×‘ ×™×“×™×“×•×ª×™
    try {
      function showTooltip(element, message) {
        try {
          const tooltip = document.createElement('div');
          tooltip.className = 'permalink-tooltip';
          tooltip.textContent = message;
          tooltip.setAttribute('role', 'tooltip');
          const rect = element.getBoundingClientRect();
          tooltip.style.position = 'fixed';
          tooltip.style.top = `${rect.top - 30}px`;
          tooltip.style.left = `${rect.left}px`;
          document.body.appendChild(tooltip);
          setTimeout(() => { tooltip.style.opacity = '0'; setTimeout(() => { try { document.body.removeChild(tooltip); } catch(_){} }, 300); }, 2000);
        } catch(_) {}
      }
      function enhanceHeaderPermalinks() {
        const headers = document.querySelectorAll('#md-content h1, #md-content h2, #md-content h3, #md-content h4, #md-content h5, #md-content h6');
        headers.forEach(header => {
          if (!header.id) {
            // ×™×¦×™×¨×ª ××–×”×” ×™×™×—×•×“×™ ×× ×—×¡×¨
            const base = (header.textContent || '').trim().toLowerCase()
              .replace(/[^\w\u0590-\u05FF\s-]/g, '')
              .replace(/[\s_]+/g, '-')
              .replace(/^-+|-+$/g, '') || 'section';
            let id = base; let i = 1;
            while (document.getElementById(id)) { id = `${base}-${++i}`; }
            header.id = id;
          }
          // ×× ××™×Ÿ ×¢×•×’×Ÿ ×©× ×•×¦×¨ ×¢"×™ ×”×ª×•×¡×£ â€“ ×”×•×¡×£ ×™×“× ×™×ª
          if (!header.querySelector('.header-anchor')) {
            const permalink = document.createElement('a');
            permalink.className = 'header-anchor';
            permalink.href = `#${header.id}`;
            permalink.innerHTML = 'ğŸ”—';
            permalink.setAttribute('aria-label', `×§×™×©×•×¨ ×§×‘×•×¢ ×œ×¡×¢×™×£: ${header.textContent || ''}`);
            permalink.setAttribute('title', '×”×¢×ª×§ ×§×™×©×•×¨ ×œ×¡×¢×™×£ ×–×”');
            header.appendChild(permalink);
          }
        });
        // ×¨×™×©×•× ×××–×™× ×™× ×œ×”×¢×ª×§×”
        document.querySelectorAll('#md-content .header-anchor').forEach(permalink => {
          permalink.addEventListener('click', async (e) => {
            e.preventDefault();
            const header = permalink.closest('h1, h2, h3, h4, h5, h6');
            if (!header || !header.id) return;
            const url = new URL(window.location.href);
            url.hash = header.id;
            try {
              await navigator.clipboard.writeText(url.toString());
              showTooltip(permalink, '×”×§×™×©×•×¨ ×”×•×¢×ª×§!');
              // ×©×™××•×© ×‘×¤×•× ×§×¦×™×” ×©×”×•×’×“×¨×” ×œ××¢×œ×” (×× ×§×™×™××ª)
              try { announceToScreenReader('×§×™×©×•×¨ ×œ×›×•×ª×¨×ª ×”×•×¢×ª×§'); } catch(_){}
            } catch(_) {
              if (fallbackCopy(url.toString())) {
                showTooltip(permalink, '×”×§×™×©×•×¨ ×”×•×¢×ª×§!');
                try { announceToScreenReader('×§×™×©×•×¨ ×œ×›×•×ª×¨×ª ×”×•×¢×ª×§'); } catch(_){}
              }
            }
            try { header.scrollIntoView({ behavior: 'smooth', block: 'start' }); } catch(_){}
          });
        });
      }
      enhanceHeaderPermalinks();
    } catch(_){ }

    // ×§×™×¦×•×¨×™ ××§×œ×“×ª ×‘×¡×™×¡×™×™×: ×”×¢×ª×§×ª ×§×•×“ ×¨××©×•×Ÿ ×•×”×¢×ª×§×ª ×§×™×©×•×¨ ×œ×›×•×ª×¨×ª ×’×œ×•×™×”
    try {
      function getCurrentVisibleHeader() {
        const headers = document.querySelectorAll('#md-content h1, #md-content h2, #md-content h3, #md-content h4, #md-content h5, #md-content h6');
        const scrollPos = window.scrollY + 100;
        for (let i = headers.length - 1; i >= 0; i--) {
          const el = headers[i];
          if (el.offsetTop <= scrollPos) return el;
        }
        return headers[0] || null;
      }
      document.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.shiftKey && e.key.toUpperCase() === 'C') {
          e.preventDefault();
          const firstCopyBtn = document.querySelector('#md-content .md-copy-btn');
          if (firstCopyBtn) firstCopyBtn.click();
        }
        if (e.ctrlKey && (e.key === 'l' || e.key === 'L')) {
          e.preventDefault();
          const currentHeader = getCurrentVisibleHeader();
          if (currentHeader) {
            const permalink = currentHeader.querySelector('.header-anchor');
            if (permalink) permalink.click();
          }
        }
      });
    } catch(_){ }

    // ×’×œ×™×œ×”/×¤×•×§×•×¡ ×œ×¤×™ hash ×× ×”×•×–×Ÿ ×‘×›× ×™×¡×”
    try {
      (function restoreScrollPosition(){
        const hash = window.location.hash;
        if (!hash) return;
        const element = document.querySelector(hash);
        if (!element) return;
        setTimeout(() => { try { element.scrollIntoView({ behavior: 'smooth', block: 'start' }); element.tabIndex = -1; element.focus(); } catch(_){} }, 100);
      })();
    } catch(_){ }

    // ×¨×©×™××•×ª ××©×™××•×ª ××™× ×˜×¨××§×˜×™×‘×™×•×ª: ×©××™×¨×”/×©×—×–×•×¨ ××¦×‘
    // ×‘-render, markdown-it-task-lists ×”×•×¤×š ×œ-input[type=checkbox]
    const boxes = container.querySelectorAll('input[type="checkbox"]');
    let idx = 0;
    boxes.forEach(cb => {
      cb.classList.add('md-task-checkbox');
      const key = 'i' + (idx++);
      // ×©×—×–×•×¨ ××¦×‘
      if (Object.prototype.hasOwnProperty.call(taskState, key)) {
        cb.checked = !!taskState[key];
      }
      cb.addEventListener('change', () => {
        taskState[key] = cb.checked;
        saveTaskState(taskState);
      });
    });

    // ×•×™×¨×˜×•××œ×™×–×¦×™×” ×‘×¡×™×¡×™×ª ×œ××¡××›×™× ××¨×•×›×™× (×—×œ×•×§×” ×œ×§×˜×¢×™× ×œ×¤×™ ×›×•×ª×¨×•×ª)
    try {
      const MAX_NODES = 2000;
      const nodes = Array.from(container.childNodes);
      if (nodes.length > MAX_NODES) {
        const chunk = document.createDocumentFragment();
        nodes.slice(0, MAX_NODES).forEach(n => chunk.appendChild(n));
        const rest = nodes.slice(MAX_NODES);
        container.innerHTML = '';
        container.appendChild(chunk);
        const more = document.createElement('button');
        more.className = 'btn btn-secondary btn-icon';
        more.textContent = '×˜×¢×Ÿ ×¢×•×“â€¦';
        more.addEventListener('click', () => {
          const frag = document.createDocumentFragment();
          rest.forEach(n => frag.appendChild(n));
          container.appendChild(frag);
          more.remove();
        });
        container.appendChild(document.createElement('hr'));
        container.appendChild(more);
      }
    } catch(_){ }

    // ××•×ª ×©×”×¨×™× ×“×•×¨ ×”×¨××©×•× ×™ ×©×œ ×”-Markdown ×”×•×©×œ× â€“ ×××¤×©×¨ ×œ×¨×›×™×‘×™× ×—×™×¦×•× ×™×™× (×›××• ×¤×ª×§×™× ×“×‘×™×§×™×)
    // ×œ×”××ª×™×Ÿ ×œ×¡×™×•× ×”×¨×™× ×“×•×¨ ×œ×¤× ×™ ××ª×—×•×œ, ×›×“×™ ×œ×”×™×× ×¢ ××—×¤×™×¤×”/×§×¤×™×¦×•×ª.
    try { document.dispatchEvent(new CustomEvent('md:rendered', { detail: { fileId: FILE_ID } })); } catch(_) {}

  } catch (e) {
    console.error('Markdown preview failed', e);
    const container = document.getElementById('md-content');
    container.innerHTML = '<div class="alert alert-error">×©×’×™××” ×‘×¨×™× ×“×•×¨ Markdown</div>';
  }
})();

// === ××¢×¨×›×ª ×”×—×œ×¤×ª ×¦×‘×¢×™ ×¨×§×¢ ×œ×××¨×§×“××•×Ÿ ===
(function initBackgroundColorSwitcher() {
  'use strict';
  
  const COLORS = {
    light: '#f5e6d3',
    medium: '#e8d4b0',
    dark: '#d4b896'
  };
  
  const STORAGE_KEY = 'md_bg_color_preference';
  
  // ×©×œ×™×¤×ª ×”×¢×“×¤×” ×©××•×¨×”
  function getSavedColorPreference() {
    try {
      return localStorage.getItem(STORAGE_KEY) || null;
    } catch(_) {
      return null;
    }
  }
  
  // ×©××™×¨×ª ×”×¢×“×¤×”
  function saveColorPreference(color) {
    try {
      if (color) {
        localStorage.setItem(STORAGE_KEY, color);
      } else {
        localStorage.removeItem(STORAGE_KEY);
      }
    } catch(_) {}
  }
  
  // ×”×—×œ×ª ×¦×‘×¢ ×¨×§×¢
  function applyBackgroundColor(color) {
    const mdContent = document.getElementById('md-content');
    if (!mdContent) return;
    
    // ×”×¡×¨×ª ×›×œ ×”××—×œ×§×•×ª ×”×§×•×“××•×ª
    mdContent.classList.remove('bg-light', 'bg-medium', 'bg-dark');
    
    // ×”×—×œ×ª ×¦×‘×¢ ×—×“×© ×× × ×‘×—×¨
    if (color && COLORS[color]) {
      mdContent.classList.add(`bg-${color}`);
      
      // ×¢×“×›×•×Ÿ ×”×›×¤×ª×•×¨ ×”×¨××©×™
      const indicator = document.querySelector('#bgColorBtn span');
      if (indicator) {
        indicator.style.background = COLORS[color];
      }
    } else {
      // ×—×–×¨×” ×œ×¦×‘×¢ ×‘×¨×™×¨×ª ×”××—×“×œ (×œ×‘×Ÿ)
      const indicator = document.querySelector('#bgColorBtn span');
      if (indicator) {
        indicator.style.background = '#ffffff';
      }
    }
    
    // ×¡×™××•×Ÿ ×”××¤×©×¨×•×ª ×”×¤×¢×™×œ×”
    document.querySelectorAll('.bg-color-option').forEach(btn => {
      btn.classList.remove('active');
      // ×”×©×•×•××” ×’× ×œ×¢×¨×š ×¨×™×§ ×¢×‘×•×¨ ×‘×¨×™×¨×ª ×”××—×“×œ
      if ((color === null || color === '') && (btn.dataset.color === '' || btn.dataset.color === 'default')) {
        btn.classList.add('active');
      } else if (btn.dataset.color === color) {
        btn.classList.add('active');
      }
    });
    
    // ×©××™×¨×ª ×”×”×¢×“×¤×”
    saveColorPreference(color);
  }
  
  // ××ª×—×•×œ ×”××¢×¨×›×ª
  function init() {
    const bgColorBtn = document.getElementById('bgColorBtn');
    const bgColorOptions = document.getElementById('bgColorOptions');
    
    if (!bgColorBtn || !bgColorOptions) return;
    
    // ×˜×¢×™× ×ª ×”×¢×“×¤×” ×©××•×¨×”
    const savedColor = getSavedColorPreference();
    if (savedColor) {
      applyBackgroundColor(savedColor);
    }
    
    // ×¤×ª×™×—×”/×¡×’×™×¨×” ×©×œ ×”×ª×¤×¨×™×˜
    bgColorBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      const isVisible = bgColorOptions.style.display !== 'none';
      bgColorOptions.style.display = isVisible ? 'none' : 'block';
    });
    
    // ×‘×—×™×¨×ª ×¦×‘×¢
    document.querySelectorAll('.bg-color-option').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const color = btn.dataset.color;
        applyBackgroundColor(color);
        bgColorOptions.style.display = 'none';
      });
    });
    
    // ×¡×’×™×¨×ª ×”×ª×¤×¨×™×˜ ×‘×œ×—×™×¦×” ××—×•×¥ ×œ××–×•×¨
    document.addEventListener('click', (e) => {
      if (!e.target.closest('#bgColorSwitcher')) {
        bgColorOptions.style.display = 'none';
      }
    });
    
    // ×”×•×¡×¤×ª ××¤×©×¨×•×ª ×œ×—×–×•×¨ ×œ×¦×‘×¢ ×”×œ×‘×Ÿ ×”××§×•×¨×™
    const defaultBtn = document.createElement('button');
    defaultBtn.className = 'bg-color-option';
    defaultBtn.dataset.color = ''; // ×¢×¨×š ×¨×™×§ ×œ×‘×¨×™×¨×ª ××—×“×œ
    defaultBtn.style = 'display:block;width:100%;padding:8px 12px;margin:4px 0;border:1px solid #ddd;border-radius:6px;background:#ffffff;color:#333;cursor:pointer;font-size:14px;transition:all 0.2s ease;';
    defaultBtn.innerHTML = `
      <span style="display:inline-block;width:20px;height:20px;border-radius:4px;background:#ffffff;border:1px solid #999;vertical-align:middle;margin-left:8px;"></span>
      ×œ×‘×Ÿ (×‘×¨×™×¨×ª ××—×“×œ)
    `;
    defaultBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      applyBackgroundColor(null); // ×©×™××•×© ×‘×¤×•× ×§×¦×™×” ×”××¨×›×–×™×ª
      bgColorOptions.style.display = 'none';
    });
    
    // ×”×•×¡×¤×ª ×›×¤×ª×•×¨ ×‘×¨×™×¨×ª ×”××—×“×œ ×œ×ª×—×™×œ×ª ×”×¨×©×™××”
    bgColorOptions.insertBefore(defaultBtn, bgColorOptions.firstChild);
    
    // ×¡×™××•×Ÿ ×‘×¨×™×¨×ª ×”××—×“×œ ×× ××™×Ÿ ×¦×‘×¢ ×©××•×¨ - ×™×¢×©×” ××•×˜×•××˜×™×ª ×“×¨×š applyBackgroundColor
  }
  
  // ×”×¤×¢×œ×ª ×”××¢×¨×›×ª ×œ××—×¨ ×˜×¢×™× ×ª ×”×“×£
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();

// === ×ª×•×›×Ÿ ×¢× ×™×™× ×™× ×¦×£ ××ª×§×“× - ×’×¨×¡×” 2.0 ===
(function initAdvancedTableOfContents() {
  'use strict';
  const CONFIG = {
    MAX_HEADINGS: 200,
    VIRTUAL_SCROLL_THRESHOLD: 50,
    SEARCH_DEBOUNCE: 300,
    SCROLL_OFFSET: 120,
    INTERSECTION_THRESHOLD: 0.5,
    INTERSECTION_MARGIN: '-20% 0% -70% 0%',
    WAIT_TIMEOUT: 5000,
    CHECK_INTERVAL: 100,
    LONG_PRESS_MS: 450,
    MINI_POS_KEY: 'md_toc_mini_top',
    MINIMIZED_KEY_GLOBAL: 'mdTocMinimized',
    MINIMIZED_KEY_PER_FILE_PREFIX: 'mdTocMinimized:'
  };
  let tocState = {
    headings: [],
    visibleHeadings: [],
    activeHeading: null,
    observer: null,
    clickHandlers: [],
    searchTerm: '',
    isCollapsed: false,
    isMinimized: false,
    scrollPercentage: 0
  };
  function clamp(value, min, max){ return Math.min(Math.max(value, min), max); }
  function getSavedMiniTop(){
    try { const v = parseInt(localStorage.getItem(CONFIG.MINI_POS_KEY) || '100', 10); return isNaN(v) ? 100 : v; } catch(_) { return 100; }
  }
  function saveMiniTop(top){ try { localStorage.setItem(CONFIG.MINI_POS_KEY, String(top)); } catch(_){} }
  function applyMiniTop(top){
    const miniBtn = document.getElementById('mdTocMini');
    const tocElement = document.getElementById('mdToc');
    if (miniBtn) miniBtn.style.top = top + 'px';
    if (tocElement) tocElement.style.top = top + 'px';
  }
  function debounce(func, wait) {
    let timeout; return function executedFunction(...args) { const later = () => { clearTimeout(timeout); func(...args); }; clearTimeout(timeout); timeout = setTimeout(later, wait); };
  }
  function sanitizeText(text) {
    const div = document.createElement('div'); div.textContent = text; return div.innerHTML.replace(/[<>\"'&]/g, '').replace(/Â¶/g, '').trim();
  }
  function generateUniqueId(prefix, index) {
    return `${prefix}-${Date.now()}-${index}-${Math.random().toString(36).substr(2, 9)}`;
  }
  function waitForContent(callback) {
    const startTime = Date.now();
    function check() {
      try {
        const container = document.getElementById('md-content');
        const hasContent = container && container.innerHTML.trim().length > 0 && container.querySelector('h1, h2, h3, h4, h5, h6');
        if (hasContent) { setTimeout(callback, 50); }
        else if (Date.now() - startTime < CONFIG.WAIT_TIMEOUT) { setTimeout(check, CONFIG.CHECK_INTERVAL); }
        else { console.warn('TOC: ×ª×•×›×Ÿ ×œ× × ×˜×¢×Ÿ ×‘×–××Ÿ ×”××•×’×“×¨'); hideTOC(); }
      } catch (e) { console.error('TOC: ×©×’×™××” ×‘×‘×“×™×§×ª ×ª×•×›×Ÿ', e); hideTOC(); }
    }
    check();
  }
  function hideTOC() { const tocElement = document.getElementById('mdToc'); if (tocElement) tocElement.style.display = 'none'; }
  function cleanup() {
    try {
      if (tocState.observer) { tocState.observer.disconnect(); tocState.observer = null; }
      tocState.clickHandlers.forEach(({ element, event, handler }) => { element.removeEventListener(event, handler); });
      tocState.clickHandlers = [];
    } catch (e) { console.error('TOC: ×©×’×™××” ×‘× ×™×§×•×™', e); }
  }
  function buildTOC() {
    try {
      const container = document.getElementById('md-content');
      const tocElement = document.getElementById('mdToc');
      const tocNav = document.getElementById('mdTocNav');
      if (!container || !tocElement || !tocNav) { console.error('TOC: ××œ×× ×˜×™× ×—×¡×¨×™×'); return; }
      let headings = Array.from(container.querySelectorAll('h1, h2, h3, h4, h5, h6'));
      if (headings.length === 0) { console.info('TOC: ×œ× × ××¦××• ×›×•×ª×¨×•×ª ×‘××¡××š'); hideTOC(); return; }
      if (headings.length > CONFIG.MAX_HEADINGS) { console.warn(`TOC: × ××¦××• ${headings.length} ×›×•×ª×¨×•×ª, ××¦×™×’ ×¨×§ ${CONFIG.MAX_HEADINGS} ×”×¨××©×•× ×•×ª`); headings = headings.slice(0, CONFIG.MAX_HEADINGS); }
      tocState.headings = headings;
      const fragment = document.createDocumentFragment();
      const seenIds = new Map();
      headings.forEach((heading, index) => {
        try {
          const level = parseInt(heading.tagName.substring(1));
          const text = sanitizeText(heading.textContent || '');
          // ×©××™×¨×ª ××–×”×™× ×§×™×™××™× ×©× ×•×¦×¨×• ×¢×´×™ markdown-it-anchor; ×©×™× ×•×™ ×¨×§ ×‘××§×¨×” ×›×¤×™×œ×•×™×•×ª ××• ×—×•×¡×¨ ××–×”×”
          let currentId = heading.id || '';
          if (!currentId) {
            currentId = generateUniqueId('toc-heading', index);
            heading.id = currentId;
          }
          const priorCount = seenIds.get(currentId) || 0;
          if (priorCount > 0) {
            // ×”×¤×•×š ×œ×›×•×ª×¨×ª ×™×™×—×•×“×™×ª ×‘×œ×™ ×œ×©× ×•×ª ××ª ×”×¨××©×•× ×”
            let suffix = priorCount + 1;
            let candidate = `${currentId}-${suffix}`;
            while (document.getElementById(candidate) || seenIds.has(candidate)) {
              suffix += 1;
              candidate = `${currentId}-${suffix}`;
            }
            heading.id = candidate;
            currentId = candidate;
          }
          seenIds.set(currentId, (seenIds.get(currentId) || 0) + 1);

          const item = document.createElement('a');
          item.className = 'md-toc-item';
          item.setAttribute('data-level', level);
          item.setAttribute('href', `#${encodeURIComponent(currentId)}`);
          item.setAttribute('data-index', index);
          item.setAttribute('aria-label', `×¢×‘×•×¨ ×œ×›×•×ª×¨×ª: ${text}`);
          item.textContent = text;
          if (text.length > 30) { item.title = text; item.textContent = text.substring(0, 30) + '...'; }
          const clickHandler = (e) => { e.preventDefault(); try { heading.scrollIntoView({ behavior: 'smooth', block: 'start' }); updateActiveItem(item); closeSearch(); minimizeTOC(); } catch (error) { console.error('TOC: ×©×’×™××” ×‘×’×œ×™×œ×”', error); } };
          item.addEventListener('click', clickHandler);
          tocState.clickHandlers.push({ element: item, event: 'click', handler: clickHandler });
          fragment.appendChild(item);
        } catch (error) { console.error('TOC: ×©×’×™××” ×‘×™×¦×™×¨×ª ×¤×¨×™×˜', error); }
      });
      tocNav.appendChild(fragment);
      if (headings.length > CONFIG.VIRTUAL_SCROLL_THRESHOLD) { setupVirtualScrolling(); }
      setupIntersectionObserver();
      setupInteractions();
      setupSearch();
      setupKeyboardShortcuts();
      setupProgressIndicator();
      tocElement.style.display = 'block';
      // ×”×—×œ×ª ×”×¢×“×¤×ª ××™×–×¢×•×¨ (×’×œ×•×‘×œ×™/×¤×¨-×§×•×‘×¥) ×œ××—×¨ ×‘× ×™×™×”
      try { if (typeof getSavedMinimizedPreference === 'function' && getSavedMinimizedPreference()) { minimizeTOC(); } } catch(_) {}
      console.info(`TOC: × ×‘× ×” ×‘×”×¦×œ×—×” ×¢× ${headings.length} ×›×•×ª×¨×•×ª`);
    } catch (e) { console.error('TOC: ×©×’×™××” ×›×œ×œ×™×ª ×‘×‘× ×™×™×”', e); hideTOC(); }
  }
  function setupVirtualScrolling() {
    console.info('TOC: ××¤×¢×™×œ Virtual Scrolling');
    const tocNav = document.getElementById('mdTocNav'); if (!tocNav) return;
    const observer = new IntersectionObserver((entries) => { entries.forEach(entry => { if (entry.isIntersecting) { entry.target.classList.remove('md-toc-item-placeholder'); } else { entry.target.classList.add('md-toc-item-placeholder'); } }); }, { root: tocNav, rootMargin: '100px' });
    tocNav.querySelectorAll('.md-toc-item').forEach(item => { observer.observe(item); });
  }
  function setupIntersectionObserver() {
    try {
      const options = { rootMargin: CONFIG.INTERSECTION_MARGIN, threshold: CONFIG.INTERSECTION_THRESHOLD };
      tocState.observer = new IntersectionObserver((entries) => { entries.forEach(entry => { if (entry.isIntersecting) { const index = tocState.headings.indexOf(entry.target); if (index !== -1) { const item = document.querySelector(`.md-toc-item[data-index="${index}"]`); if (item) updateActiveItem(item); } } }); }, options);
      tocState.headings.forEach(heading => { tocState.observer.observe(heading); });
      console.debug('TOC: Intersection Observer ××•×¤×¢×œ');
    } catch (e) { console.error('TOC: ×©×’×™××” ×‘-Intersection Observer', e); setupScrollFallback(); }
  }
  function setupScrollFallback() {
    console.info('TOC: ××©×ª××© ×‘-scroll event ×›-fallback');
    let ticking = false; const scrollHandler = () => { if (!ticking) { window.requestAnimationFrame(() => { updateActiveHeadingByScroll(); ticking = false; }); ticking = true; } };
    window.addEventListener('scroll', scrollHandler, { passive: true });
    tocState.clickHandlers.push({ element: window, event: 'scroll', handler: scrollHandler });
  }
  function updateActiveHeadingByScroll() {
    const scrollPos = window.scrollY + CONFIG.SCROLL_OFFSET; let activeHeading = null;
    for (let i = tocState.headings.length - 1; i >= 0; i--) { const heading = tocState.headings[i]; if (heading.offsetTop <= scrollPos) { activeHeading = heading; break; } }
    if (activeHeading) { const index = tocState.headings.indexOf(activeHeading); const item = document.querySelector(`.md-toc-item[data-index="${index}"]`); if (item) updateActiveItem(item); }
  }
  function updateActiveItem(newActiveItem) {
    document.querySelectorAll('.md-toc-item').forEach(item => { item.classList.remove('active'); });
    if (newActiveItem) {
      newActiveItem.classList.add('active'); tocState.activeHeading = newActiveItem;
      const tocNav = document.getElementById('mdTocNav'); if (tocNav) { const itemRect = newActiveItem.getBoundingClientRect(); const navRect = tocNav.getBoundingClientRect(); if (itemRect.top < navRect.top || itemRect.bottom > navRect.bottom) { newActiveItem.scrollIntoView({ behavior: 'smooth', block: 'center' }); } }
    }
  }
  function setupInteractions() {
    const tocElement = document.getElementById('mdToc');
    const tocToggle = document.getElementById('mdTocToggle');
    const tocHeader = document.querySelector('.md-toc-header');
    const miniBtn = document.getElementById('mdTocMini');
    const menuBtn = document.getElementById('mdTocMenuBtn');
    if (tocToggle && tocElement) {
      const toggleHandler = (e) => { e.stopPropagation(); tocState.isCollapsed = !tocState.isCollapsed; tocElement.classList.toggle('collapsed'); tocToggle.setAttribute('aria-expanded', !tocState.isCollapsed); localStorage.setItem('mdTocCollapsed', tocState.isCollapsed); };
      tocToggle.addEventListener('click', toggleHandler);
      tocState.clickHandlers.push({ element: tocToggle, event: 'click', handler: toggleHandler });
    }
    if (tocHeader && tocElement) {
      const headerHandler = () => { tocState.isCollapsed = !tocState.isCollapsed; tocElement.classList.toggle('collapsed'); if (tocToggle) { tocToggle.setAttribute('aria-expanded', !tocState.isCollapsed); } localStorage.setItem('mdTocCollapsed', tocState.isCollapsed); };
      tocHeader.addEventListener('click', headerHandler);
      tocState.clickHandlers.push({ element: tocHeader, event: 'click', handler: headerHandler });
    }
    if (miniBtn && tocElement) {
      // ×©×—×–×•×¨ ××™×§×•× ×©××•×¨
      applyMiniTop(getSavedMiniTop());
      const miniHandler = () => {
        tocElement.classList.remove('minimized');
        tocElement.classList.remove('collapsed');
        const tocToggle = document.getElementById('mdTocToggle');
        if (tocToggle) tocToggle.setAttribute('aria-expanded', 'true');
        tocState.isCollapsed = false;
        tocElement.style.display = 'block';
        miniBtn.style.display = 'none';
        tocState.isMinimized = false;
      };
      miniBtn.addEventListener('click', miniHandler);
      tocState.clickHandlers.push({ element: miniBtn, event: 'click', handler: miniHandler });

      // ×’×¨×™×¨×” ×× ×›×™×ª ×œ×¨×™×‘×•×¢ ×”×¦×£ (×©×•××¨ ××™×§×•×)
      let dragActive = false; let startY = 0; let startTop = 0; const onPointerDown = (ev) => {
        try { ev.preventDefault(); } catch(_){}
        dragActive = true; startY = ev.clientY || (ev.touches && ev.touches[0] && ev.touches[0].clientY) || 0;
        startTop = parseInt(window.getComputedStyle(miniBtn).top || '100', 10) || 100;
        try { miniBtn.setPointerCapture && miniBtn.setPointerCapture(ev.pointerId); } catch(_){}
      };
      const onPointerMove = (ev) => {
        if (!dragActive) return; const y = ev.clientY || (ev.touches && ev.touches[0] && ev.touches[0].clientY) || 0; const delta = y - startY; let newTop = startTop + delta; const maxTop = Math.max(60, window.innerHeight - 64); newTop = clamp(newTop, 60, maxTop); applyMiniTop(newTop);
      };
      const onPointerUp = (ev) => { if (!dragActive) return; dragActive = false; const top = parseInt(miniBtn.style.top || '100', 10) || 100; saveMiniTop(top); };
      miniBtn.addEventListener('pointerdown', onPointerDown, { passive: false });
      window.addEventListener('pointermove', onPointerMove, { passive: false });
      window.addEventListener('pointerup', onPointerUp);
      window.addEventListener('pointercancel', onPointerUp);
      // ×¨×™×©×•× ×œ× ×™×§×•×™
      tocState.clickHandlers.push({ element: miniBtn, event: 'pointerdown', handler: onPointerDown });
      tocState.clickHandlers.push({ element: window, event: 'pointermove', handler: onPointerMove });
      tocState.clickHandlers.push({ element: window, event: 'pointerup', handler: onPointerUp });
      tocState.clickHandlers.push({ element: window, event: 'pointercancel', handler: onPointerUp });
    }
    // ×œ×—×™×¦×” ××¨×•×›×” ×¢×œ ×¡××œ â˜° ×œ××–×¢×•×¨ ××”×™×¨
    if (menuBtn) {
      let pressTimer = null;
      const start = (e) => { try { e.preventDefault(); } catch(_){}; clearTimeout(pressTimer); pressTimer = setTimeout(() => { minimizeTOC(); }, CONFIG.LONG_PRESS_MS); };
      const cancel = () => { clearTimeout(pressTimer); };
      const ctxHandler = (e)=>{ try{ e.preventDefault(); }catch(_){} };
      menuBtn.addEventListener('pointerdown', start);
      menuBtn.addEventListener('pointerup', cancel);
      menuBtn.addEventListener('pointerleave', cancel);
      menuBtn.addEventListener('contextmenu', ctxHandler);
      // ×¨×™×©×•× ×œ× ×™×§×•×™
      tocState.clickHandlers.push({ element: menuBtn, event: 'pointerdown', handler: start });
      tocState.clickHandlers.push({ element: menuBtn, event: 'pointerup', handler: cancel });
      tocState.clickHandlers.push({ element: menuBtn, event: 'pointerleave', handler: cancel });
      tocState.clickHandlers.push({ element: menuBtn, event: 'contextmenu', handler: ctxHandler });
    }
    const savedCollapsed = localStorage.getItem('mdTocCollapsed');
    if (savedCollapsed === 'true') {
      tocElement?.classList.add('collapsed'); if (tocToggle) tocToggle.setAttribute('aria-expanded', 'false'); tocState.isCollapsed = true;
    }
  }
  function setupSearch() {
    const searchBtn = document.getElementById('mdTocSearch');
    const searchContainer = document.getElementById('tocSearchContainer');
    const searchInput = document.getElementById('tocSearchInput');
    const searchResults = document.getElementById('tocSearchResults');
    if (!searchBtn || !searchContainer || !searchInput) return;
    const searchBtnHandler = (e) => { e.stopPropagation(); const isVisible = searchContainer.style.display !== 'none'; searchContainer.style.display = isVisible ? 'none' : 'block'; if (!isVisible) { searchInput.focus(); } else { closeSearch(); } };
    searchBtn.addEventListener('click', searchBtnHandler);
    tocState.clickHandlers.push({ element: searchBtn, event: 'click', handler: searchBtnHandler });
    function escapeRegExp(string) { return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
    function highlightText(element, searchTerm) {
      const originalText = element.textContent; if (!searchTerm) { element.textContent = originalText; return; }
      element.textContent = ''; const escapedTerm = escapeRegExp(searchTerm); const regex = new RegExp(escapedTerm, 'gi'); let lastIndex = 0; let match; const maxIterations = 100; let iterations = 0;
      while ((match = regex.exec(originalText)) !== null && iterations < maxIterations) {
        iterations++; if (match.index > lastIndex) { const textNode = document.createTextNode(originalText.slice(lastIndex, match.index)); element.appendChild(textNode); }
        const mark = document.createElement('mark'); mark.textContent = match[0]; element.appendChild(mark); lastIndex = regex.lastIndex; if (regex.lastIndex === match.index) { regex.lastIndex++; }
      }
      if (lastIndex < originalText.length) { const textNode = document.createTextNode(originalText.slice(lastIndex)); element.appendChild(textNode); }
    }
    const searchHandler = debounce((e) => {
      const searchTerm = e.target.value.toLowerCase().trim(); const MAX_SEARCH_LENGTH = 100; if (searchTerm.length > MAX_SEARCH_LENGTH) { console.warn('TOC: ×—×™×¤×•×© ××¨×•×š ××“×™'); return; }
      tocState.searchTerm = searchTerm; const items = document.querySelectorAll('.md-toc-item'); let matchCount = 0; items.forEach(item => { if (!item.dataset.originalText) { item.dataset.originalText = item.textContent; } const originalText = item.dataset.originalText; const text = originalText.toLowerCase(); if (!searchTerm) { item.classList.remove('search-hidden', 'search-match'); item.textContent = originalText; } else if (text.includes(searchTerm)) { item.classList.remove('search-hidden'); item.classList.add('search-match'); highlightText(item, searchTerm); matchCount++; } else { item.classList.add('search-hidden'); item.classList.remove('search-match'); item.textContent = originalText; } }); if (searchResults) { if (!searchTerm) { searchResults.textContent = ''; } else if (matchCount === 0) { searchResults.textContent = '×œ× × ××¦××• ×ª×•×¦××•×ª'; } else { searchResults.textContent = `× ××¦××• ${matchCount} ×ª×•×¦××•×ª`; } }
    }, CONFIG.SEARCH_DEBOUNCE);
    searchInput.addEventListener('input', searchHandler);
    tocState.clickHandlers.push({ element: searchInput, event: 'input', handler: searchHandler });
    const escapeHandler = (e) => { if (e.key === 'Escape' && searchContainer.style.display !== 'none') { closeSearch(); } };
    searchInput.addEventListener('keydown', escapeHandler);
    tocState.clickHandlers.push({ element: searchInput, event: 'keydown', handler: escapeHandler });
  }
  function closeSearch() {
    const searchContainer = document.getElementById('tocSearchContainer');
    const searchInput = document.getElementById('tocSearchInput');
    const searchResults = document.getElementById('tocSearchResults');
    if (searchContainer) searchContainer.style.display = 'none'; if (searchInput) searchInput.value = ''; if (searchResults) searchResults.textContent = '';
    document.querySelectorAll('.md-toc-item').forEach(item => { item.classList.remove('search-hidden', 'search-match'); if (item.dataset.originalText) { item.textContent = item.dataset.originalText; } });
    tocState.searchTerm = '';
  }
  function setupKeyboardShortcuts() {
    const keyboardHandler = (e) => {
      if (e.ctrlKey && e.key === 't') { e.preventDefault(); const tocToggle = document.getElementById('mdTocToggle'); if (tocToggle) tocToggle.click(); }
      if (e.ctrlKey && e.key === 'f') { const tocElement = document.getElementById('mdToc'); if (tocElement && tocElement.contains(document.activeElement)) { e.preventDefault(); const searchBtn = document.getElementById('mdTocSearch'); if (searchBtn) searchBtn.click(); } }
      if (e.ctrlKey && e.key === 'm') { e.preventDefault(); toggleMinimize(); }
    };
    document.addEventListener('keydown', keyboardHandler);
    tocState.clickHandlers.push({ element: document, event: 'keydown', handler: keyboardHandler });
  }
  function setMinimizedPreference(isMinimized){
    try {
      // ×©××™×¨×” ×’×œ×•×‘×œ×™×ª
      localStorage.setItem(CONFIG.MINIMIZED_KEY_GLOBAL, isMinimized ? '1' : '0');
      // ×©××™×¨×” ×¤×¨-×§×•×‘×¥
      if (typeof FILE_ID !== 'undefined' && FILE_ID) {
        localStorage.setItem(CONFIG.MINIMIZED_KEY_PER_FILE_PREFIX + FILE_ID, isMinimized ? '1' : '0');
      }
    } catch(_) {}
  }
  function getSavedMinimizedPreference(){
    try {
      // ×¢×“×™×¤×•×ª ×œ×”×’×“×¨×” ×¤×¨-×§×•×‘×¥ ×× ×§×™×™××ª
      if (typeof FILE_ID !== 'undefined' && FILE_ID) {
        const perFile = localStorage.getItem(CONFIG.MINIMIZED_KEY_PER_FILE_PREFIX + FILE_ID);
        if (perFile === '1' || perFile === '0') return perFile === '1';
      }
      const globalVal = localStorage.getItem(CONFIG.MINIMIZED_KEY_GLOBAL);
      if (globalVal === '1' || globalVal === '0') return globalVal === '1';
    } catch(_) {}
    return false;
  }
  function minimizeTOC(){
    const tocElement = document.getElementById('mdToc');
    const miniBtn = document.getElementById('mdTocMini');
    if (!tocElement || !miniBtn) return;
    tocState.isMinimized = true;
    tocElement.style.display = 'none';
    miniBtn.style.display = 'block';
    applyMiniTop(parseInt(miniBtn.style.top||String(getSavedMiniTop()),10));
    setMinimizedPreference(true);
  }
  function restoreTOC(){
    const tocElement = document.getElementById('mdToc');
    const miniBtn = document.getElementById('mdTocMini');
    if (!tocElement || !miniBtn) return;
    tocState.isMinimized = false;
    tocElement.style.display = 'block';
    miniBtn.style.display = 'none';
    setMinimizedPreference(false);
  }
  function toggleMinimize() { if (tocState.isMinimized) { restoreTOC(); } else { minimizeTOC(); } }
  function setupProgressIndicator() {
    const progressBar = document.getElementById('tocProgressBar'); if (!progressBar) return; const updateProgress = () => { const scrollHeight = document.documentElement.scrollHeight - window.innerHeight; const scrollPosition = window.scrollY; const percentage = Math.round((scrollPosition / scrollHeight) * 100); progressBar.style.width = `${percentage}%`; tocState.scrollPercentage = percentage; const progressContainer = document.querySelector('.md-toc-progress'); if (progressContainer) { progressContainer.setAttribute('aria-valuenow', percentage); } };
    updateProgress(); let progressTicking = false; const progressHandler = () => { if (!progressTicking) { window.requestAnimationFrame(() => { updateProgress(); progressTicking = false; }); progressTicking = true; } };
    window.addEventListener('scroll', progressHandler, { passive: true });
    tocState.clickHandlers.push({ element: window, event: 'scroll', handler: progressHandler });
  }
  function init() {
    try {
      console.info('TOC: ××ª×—×™×œ ××ª×—×•×œ');
      waitForContent(buildTOC);
      window.addEventListener('beforeunload', cleanup);
      if (window.navigation && typeof window.navigation.addEventListener === 'function') {
        const navHandler = (event) => {
          try {
            if (event && event.destination && event.destination.sameDocument) {
              return;
            }
          } catch(_) {}
          cleanup();
        };
        window.navigation.addEventListener('navigate', navHandler);
        tocState.clickHandlers.push({ element: window.navigation, event: 'navigate', handler: navHandler });
      }
      // ×™×™×©×¨ ××™×§×•× ×”×ª×¤×¨×™×˜ ×•×”×›×¤×ª×•×¨ ×”××™× ×™××œ×™ ×œ×©×•×¨×” ××—×ª ×‘×¦×“ ×©×××œ
      applyMiniTop(getSavedMiniTop());
      // ×©×—×–×•×¨ ×”×¢×“×¤×ª ××™×–×¢×•×¨ (×’×œ×•×‘×œ×™/×¤×¨-×§×•×‘×¥)
      if (getSavedMinimizedPreference()) {
        // × ×‘×˜×™×— ×©×”×›×¤×ª×•×¨ ×”××™× ×™××œ×™ × ×¨××” ×›×‘×¨ ×‘×˜×¢×™× ×”
        const tocElement = document.getElementById('mdToc');
        const miniBtn = document.getElementById('mdTocMini');
        if (tocElement && miniBtn) {
          tocElement.style.display = 'none';
          miniBtn.style.display = 'block';
          tocState.isMinimized = true;
        }
      }
    } catch (e) { console.error('TOC: ×©×’×™××” ×‘××ª×—×•×œ', e); hideTOC(); }
  }
  init();
})();
// ××¡×š ××œ× ×œ- Markdown Card
(function(){
  try {
    const btn = document.getElementById('mdFullscreenBtn');
    const card = document.getElementById('mdCard');
    if (!btn || !card) return;
    function isFullscreen(){ return document.fullscreenElement === card; }
    function updateButton(){
      if (isFullscreen()) {
        btn.innerHTML = '<i class="fas fa-compress"></i> ×™×¦×™××” ×××¡×š ××œ×';
        // Fallback: ×”×¡×ª×¨×ª TOC ×‘××¦×‘ ××¡×š ××œ× ×’× ×× ×›×œ×œ ×”-CSS ×œ× ×ª×•×¤×¡
        try {
          const toc = document.getElementById('mdToc');
          const mini = document.getElementById('mdTocMini');
          if (toc) { toc.dataset.prevDisplay = toc.style.display || ''; toc.style.display = 'none'; }
          if (mini) { mini.dataset.prevDisplay = mini.style.display || ''; mini.style.display = 'none'; }
        } catch(_) {}
      } else {
        btn.innerHTML = '<i class="fas fa-expand"></i> ××¡×š ××œ×';
        // Fallback: ×©×—×–×•×¨ ××¦×‘ ×”-TOC ×œ××—×¨ ×™×¦×™××” ×××¡×š ××œ×
        try {
          const toc = document.getElementById('mdToc');
          const mini = document.getElementById('mdTocMini');
          if (toc && Object.prototype.hasOwnProperty.call(toc.dataset, 'prevDisplay')) {
            toc.style.display = toc.dataset.prevDisplay;
            delete toc.dataset.prevDisplay;
          }
          if (mini && Object.prototype.hasOwnProperty.call(mini.dataset, 'prevDisplay')) {
            mini.style.display = mini.dataset.prevDisplay;
            delete mini.dataset.prevDisplay;
          }
        } catch(_) {}
      }
    }
    btn.addEventListener('click', async function(){
      try {
        if (!isFullscreen()) { await card.requestFullscreen(); }
        else { await document.exitFullscreen(); }
      } catch(_) {}
    });
    document.addEventListener('fullscreenchange', updateButton);
    updateButton();
  } catch(_) {}
})();

let shareLinkModalKeyHandlerMd = null;

function openShareLinkModalMd(){
  const modal = document.getElementById('shareLinkModalMd');
  if (!modal){
    copyShareLinkMd(false);
    return;
  }
  modal.hidden = false;
  if (!modal.dataset.boundBackdrop){
    modal.addEventListener('click', function(ev){
      if (ev.target === modal){ closeShareLinkModalMd(); }
    });
    modal.dataset.boundBackdrop = '1';
  }
  if (shareLinkModalKeyHandlerMd){
    try {
      document.removeEventListener('keydown', shareLinkModalKeyHandlerMd);
    } catch(_){ }
  }
  shareLinkModalKeyHandlerMd = function(ev){
    try {
      if (ev.key === 'Escape'){
        ev.preventDefault();
        closeShareLinkModalMd();
      }
    } catch(_){ }
  };
  document.addEventListener('keydown', shareLinkModalKeyHandlerMd);
  setTimeout(() => {
    try {
      const firstButton = modal.querySelector('.share-link-modal__actions button');
      if (firstButton){ firstButton.focus(); }
    } catch(_){ }
  }, 0);
}

function closeShareLinkModalMd(){
  const modal = document.getElementById('shareLinkModalMd');
  if (!modal){ return; }
  modal.hidden = true;
  if (shareLinkModalKeyHandlerMd){
    document.removeEventListener('keydown', shareLinkModalKeyHandlerMd);
    shareLinkModalKeyHandlerMd = null;
  }
}

async function requestShareLinkMd(permanent){
  let baseUrl = window.location.href;
  try {
    const resp = await fetch(`/api/share/{{ file.id }}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        type: permanent ? 'permanent' : 'temporary',
        permanent: !!permanent
      })
    });
    const data = await resp.json();
    if (data && data.ok && data.url){
      baseUrl = data.url;
    }
  } catch(err){
    console.error('share create failed', err);
  }
  try {
    const u = new URL(baseUrl, window.location.origin);
    u.searchParams.set('view','md');
    return u.toString();
  } catch(_){
    return baseUrl + (baseUrl.includes('?') ? '&' : '?') + 'view=md';
  }
}

async function copyShareLinkMd(permanent){
  try { closeShareLinkModalMd(); } catch(_){ }
  const url = await requestShareLinkMd(!!permanent);
  const successMessage = permanent ? '×”×§×™×©×•×¨ ×”×§×‘×•×¢ ×”×•×¢×ª×§!' : '×”×§×™×©×•×¨ ×”×–×× ×™ ×”×•×¢×ª×§!';
  try {
    await navigator.clipboard.writeText(url);
    alert(successMessage);
  } catch(e){
    console.error('copy failed', e);
    alert('×œ× ×”×¦×œ×—× ×• ×œ×”×¢×ª×™×§ ××ª ×”×§×™×©×•×¨');
  }
}

async function shareToTelegramMd(){
  const url = await requestShareLinkMd(false);
  const text = `×¦×¤×” ×‘××¡××š Markdown ×‘-Code Keeper:`;
  const telegramUrl = `https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`;
  try { window.open(telegramUrl, '_blank'); }
  catch(_){ window.location.href = telegramUrl; }
}

// × ×™×•×•×˜ ×—×–×¨×” ×××™×Ÿ: ×ª××™×“ ××—×–×™×¨ ×œ×ª×¦×•×’×ª ×”×§×•×“ ×©×œ ×”×§×•×‘×¥
function goBackToFile(ev){
  try { if (ev) ev.preventDefault(); } catch(_){ }
  try {
    if (window.location && typeof window.location.replace === 'function') {
      window.location.replace(FILE_VIEW_URL);
    } else {
      window.location.href = FILE_VIEW_URL;
    }
  } catch(_) {
    window.location.href = FILE_VIEW_URL;
  }
  return false;
}

// ×›×¤×ª×•×¨ "×—×–×•×¨" ×›×œ×œ×™ â€“ ×× ××™×Ÿ ×”×™×¡×˜×•×¨×™×” ×—×•×–×¨×™× ×œ×¨×©×™××ª ×”×§×‘×¦×™×
function goBackTwoSteps(ev){
  try { if (ev) ev.preventDefault(); } catch(_){ }
  try {
    if (window.history && window.history.length > 2) {
      window.history.go(-2);
      return false;
    }
    // Fallback: ×¦×¢×“ ××—×“ ××—×•×¨×”
    if (window.history && window.history.length > 1) {
      window.history.back();
      return false;
    }
    if (document.referrer) {
      const ref = new URL(document.referrer, window.location.origin);
      if (ref.origin === window.location.origin) {
        window.location.href = ref.toString();
        return false;
      }
    }
  } catch(_){ }
  window.location.href = '/files';
  return false;
}

// ×”×ª×××ª ×’×•×“×œ ×©× ×”×§×•×‘×¥: ××¦××¦× ×¤×•× ×˜ ×”×“×¨×’×ª×™ ×¢×“ ×©× ×›× ×¡ ×‘×©×•×¨×” ××—×ª (×¢× ××™× ×™××•× ××•×’×Ÿ)
(function(){
  try {
    var el = document.getElementById('md-file-name');
    if (!el) return;
    el.setAttribute('title', el.textContent || '');
    var sizeRem = 1.6;    // ×’×•×“×œ ×™×¢×“ ×”×ª×—×œ×ª×™ (×”×ª×•×× ×œ-CSS)
    var minRem = 1.0;     // ××™× ×™××•× â€“ ×œ× ×§×˜×Ÿ ××“×™
    el.style.fontSize = sizeRem + 'rem';
    var guard = 0;
    while (guard < 15 && el.scrollWidth > el.clientWidth && sizeRem > minRem) {
      sizeRem -= 0.1;
      el.style.fontSize = sizeRem.toFixed(2) + 'rem';
      guard++;
    }
  } catch(_) { }
})();
</script>
<link rel="stylesheet" href="{{ url_for('static', filename='css/sticky-notes.css') }}">
<script src="{{ url_for('static', filename='js/sticky-notes.js') }}"></script>
<script>
  // ××ª×—×•×œ ×¤×ª×§×™× ×“×‘×™×§×™× ×¨×§ ×œ××—×¨ ×©×¨×™× ×“×•×¨ ×”-Markdown ×”×•×©×œ× (××• fallback ×‘×˜×•×—)
  (function(){
    try{
      function readyForNotes(){
        const c = document.getElementById('md-content');
        return !!(c && c.innerHTML.trim().length > 0);
      }
      function doInit(){
        if (window._stickyNotes) return; // ×× ×™×¢×ª ×›×¤×™×œ×•×™×•×ª
        if (typeof window.StickyNotesManager !== 'function') return;
        if (!window.FILE_ID) return;
        if (!readyForNotes()) return;
        // ××œ ×ª×¦×™×’ ×œ××‘×§×¨×™× ×¦×™×‘×•×¨×™×™×
        {% if not is_public %}
        window._stickyNotes = new window.StickyNotesManager(window.FILE_ID);
        {% endif %}
      }
      // ×”×¢×“×¤×”: ×”××ª×Ÿ ×œ××™×¨×•×¢ ××•×ª×× ×©×œ ×¨×™× ×“×•×¨ ×”-Markdown
      document.addEventListener('md:rendered', () => { try { doInit(); } catch(_){} }, { once: true });
      // Fallback: ×× ×”××™×¨×•×¢ ×œ× ×™×•×¤×¢×œ ××¡×™×‘×” ×›×œ×©×”×™, × × ×¡×” ×œ××—×¨ DOMContentLoaded ×•××– ×‘×¢×•×“ ×§×¦×ª ×–××Ÿ
      const fallbackInit = () => {
        if (readyForNotes()) { doInit(); return; }
        setTimeout(() => { try { doInit(); } catch(_){} }, 500);
      };
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', fallbackInit);
      } else {
        fallbackInit();
      }
    } catch(e) { console.warn('sticky notes init failed', e); }
  })();
</script>
{% if not is_public %}{% include 'bookmarks_snippet.html' %}{% endif %}
{% endblock %}

