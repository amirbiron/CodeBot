{% extends "base.html" %}

{% block title %}{{ file.file_name }} - Markdown Preview{% endblock %}

{% block extra_css %}
<style>
/* ××–×•×¨ ×”×ª×¦×•×’×” ×•×”×‘×™×¦×•×¢×™× */
#md-root {
  max-width: 980px;
  margin: 0 auto;
  padding: 1rem;
}
#md-content {
  background: #ffffff;
  color: #111111;
  border-radius: 10px;
  border: 1px solid #e5e7eb;
}
#md-content img {
  max-width: 100%;
  height: auto;
}
/* ×˜×‘×œ××•×ª ×‘×¡×’× ×•×Ÿ GitHub */
#md-content table {
  width: 100%;
  border-collapse: collapse;
  overflow: auto;
  display: block;
}
#md-content table th, #md-content table td {
  border: 1px solid #e5e7eb;
  padding: 0.5rem 0.75rem;
}
#md-content table thead {
  background: #f8fafc;
}
/* ×§×•×“ (fenced) */
#md-content pre code,
#md-content pre > code,
#md-content code.hljs {
  display: block;
  padding: 0;                    /* × × ×˜×¨×œ padding ×¤× ×™××™ ×›×“×™ ×œ× ×œ×™×™×¦×¨ ××¨×•×•×— ×›×¤×•×œ */
  border-radius: 8px;
  font-family: 'Fira Code', 'Consolas', monospace;
  font-size: 14px;
  white-space: pre-wrap !important;  /* ×¢×˜×™×¤×ª ×©×•×¨×•×ª ××¨×•×›×•×ª */
  word-break: break-word !important;
  overflow-wrap: anywhere !important;
}
#md-content pre { overflow-x: auto; max-width: 100%; margin: 1rem 0; }
#md-content .hljs { overflow-x: auto; display: block; }
#md-content pre {
  background: #f5f5f5 !important; /* ×¨×§×¢ ××¤×•×¨ ×‘×”×™×¨ ×•×‘×¨×•×¨ */
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: .6rem 1rem;            /* fallback padding ×’× ×œ×œ× JS */
}
#md-content pre code {
  display: block;
  overflow-x: auto;
}
#md-content .code-block { position: relative; margin: 1rem 0; }
#md-content .code-block pre {
  margin: 0;
  padding: .6rem 1rem;           /* ××¨×•×•×— ×‘×¡×™×¡×™ ×§×˜×Ÿ ×•× ×¢×™× */
  padding-right: 3.25rem;        /* ××§×•× ×œ×›×¤×ª×•×¨ Copy ××™××™×Ÿ */
}
#md-content .md-copy-btn {
  position: absolute;
  top: 6px;
  right: 6px;
  font-size: 12px;
  padding: 4px 8px;
  background: transparent;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  color: #666;
  z-index: 2;
}
#md-content .md-copy-btn:hover { color: #000; }
#md-content .md-copy-btn.copied { background: #d1fae5; border: 1px solid #10b981; }
#md-content code:not(pre code) {
  background: #f3f4f6;            /* ××¤×•×¨ ×‘×”×™×¨ ×¢× × ×™×’×•×“×™×•×ª ×˜×•×‘×” ×¢×œ ×œ×‘×Ÿ */
  color: #111111;                 /* ×˜×§×¡×˜ ×›×”×” ×œ×§×¨×™××•×ª */
  border: 1px solid #e5e7eb;      /* ××¡×’×¨×ª ×¢×“×™× ×” */
  padding: 0.2rem 0.4rem;
  border-radius: 6px;
  font-family: 'Fira Code', 'Consolas', monospace;
}
/* ×¦×™×˜×•×˜×™× */
#md-content blockquote {
  margin: 0.75rem 0;
  padding: 0.5rem 0.75rem;
  background: #f8fafc;
  border-inline-start: 4px solid #e5e7eb;
}
/* ×¨×©×™××•×ª ××©×™××•×ª */
input.md-task-checkbox {
  margin-inline-end: .5rem;
  transform: scale(1.1);
}
</style>
{% endblock %}

{% block content %}
<div id="md-root">
  <div class="file-header" style="display:flex;justify-content:space-between;align-items:center;gap:1rem;flex-wrap:wrap;margin-bottom:1rem;">
    <div style="display:flex;align-items:center;gap:.75rem;">
      <span style="font-size:2rem;">ğŸ“</span>
      <div>
        <h1 style="margin:0;font-size:1.6rem;">{{ file.file_name }}</h1>
        <div class="muted" style="margin-top:.25rem;">Markdown</div>
      </div>
    </div>
  <div class="file-actions" style="display:flex;gap:.5rem;flex-wrap:wrap;">
      <a href="#" onclick="return goBackToFile(event)" class="btn btn-secondary btn-icon">â†©ï¸ ×—×–×¨×” ×œ×§×•×‘×¥</a>
    </div>
  </div>

  <div id="md-content" class="glass-card" style="padding:1rem;"></div>
  <script type="application/json" id="mdText">{{ md_code | tojson | safe }}</script>
</div>

<script>
// ×ª×•×›×Ÿ ×”-Markdown ××•×¢×‘×¨ ×‘×‘×˜×—×” JSON-encoded
const MD_TEXT = (function(){
  try {
    var el = document.getElementById('mdText');
    if (!el) return "";
    return JSON.parse(el.textContent || '""');
  } catch(_) { return ""; }
})();

// ×©××™×¨×ª ××¦×‘ ×¨×©×™××•×ª ××©×™××•×ª (×œ×¤×™ ×§×•×‘×¥) ×‘-localStorage
const STORAGE_KEY = `md_tasks_state:{{ file.id }}`;
function loadTaskState(){
  try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); }catch(_){ return {}; }
}
function saveTaskState(state){
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state || {})); }catch(_){ }
}
const taskState = loadTaskState();

// ×˜×¢×™× ×ª ×¡×¤×¨×™×•×ª ×“×¨×š CDN
// markdown-it + plugins (GFM-like), KaTeX, Mermaid, highlight.js
const CDN = {
  md: 'https://cdn.jsdelivr.net/npm/markdown-it@13.0.2/dist/markdown-it.min.js',
  mdEmoji: 'https://cdn.jsdelivr.net/npm/markdown-it-emoji@2.0.2/dist/markdown-it-emoji.min.js',
  mdTask: 'https://cdn.jsdelivr.net/npm/markdown-it-task-lists@2.1.1/dist/markdown-it-task-lists.min.js',
  mdAnchor: 'https://cdn.jsdelivr.net/npm/markdown-it-anchor@8.6.7/dist/markdown-it-anchor.min.js',
  mdFootnote: 'https://cdn.jsdelivr.net/npm/markdown-it-footnote@3.0.3/dist/markdown-it-footnote.min.js',
  mdTocDone: 'https://cdn.jsdelivr.net/npm/markdown-it-toc-done-right@4.2.0/dist/markdown-it-toc-done-right.min.js',
  hljs: 'https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/common.min.js',
  hljsCss: 'https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css',
  katexCss: 'https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css',
  katexJs: 'https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js',
  katexAuto: 'https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js',
  mermaid: 'https://cdn.jsdelivr.net/npm/mermaid@10.9.1/dist/mermaid.min.js'
};

function injectCss(href){ const l=document.createElement('link'); l.rel='stylesheet'; l.href=href; document.head.appendChild(l); }
function loadScript(src){ return new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=src; s.onload=res; s.onerror=rej; document.head.appendChild(s); }); }

(async function(){
  try{
    injectCss(CDN.hljsCss);
    injectCss(CDN.katexCss);
    try { await loadScript(CDN.md); } catch(_){}
    try { await loadScript(CDN.mdEmoji); } catch(_){}
    try { await loadScript(CDN.mdTask); } catch(_){}
    try { await loadScript(CDN.mdAnchor); } catch(_){}
    try { await loadScript(CDN.mdFootnote); } catch(_){}
    try { await loadScript(CDN.mdTocDone); } catch(_){}
    try { await loadScript(CDN.hljs); } catch(_){}
    try { await loadScript(CDN.katexJs); } catch(_){}
    try { await loadScript(CDN.katexAuto); } catch(_){}
    try { await loadScript(CDN.mermaid); } catch(_){}

    const md = (window.markdownit ? window.markdownit : (()=>({render:(s)=>s})))({
      breaks: true,
      linkify: true,
      typographer: true,
      html: false,
      // ×œ× ×œ×‘×¦×¢ ×”×“×’×©×” ×‘×©×œ×‘ ×”-render ×©×œ markdown-it; × ×‘×¦×¢ post-process ×¢× hljs
      highlight: function (_str, _lang) { return ''; }
    })
    if (window.markdownitEmoji) md.use(window.markdownitEmoji);
    if (window.markdownitTaskLists) md.use(window.markdownitTaskLists, { label: true, enabled: true });
    if (window.markdownitAnchor) md.use(window.markdownitAnchor, { permalink: true, permalinkSymbol: 'Â¶' });
    if (window.markdownitFootnote) md.use(window.markdownitFootnote);
    if (window.markdownitTocDoneRight) md.use(window.markdownitTocDoneRight);

    // ×¨×™× ×“×•×¨ ×¨××©×•× ×™
    const container = document.getElementById('md-content');
    container.innerHTML = md.render(MD_TEXT || '');

    // ×”×“×’×©×ª ×ª×—×‘×™×¨ ×œ××—×¨ ×”×¨×™× ×“×•×¨: ×”×“×’×©×” ×××•×§×“×ª ×‘×ª×•×š #md-content ×‘×œ×‘×“
    try {
      if (window.hljs && typeof window.hljs.highlightElement === 'function') {
        container.querySelectorAll('pre code').forEach(el => {
          if (el.classList.contains('hljs')) return;
          window.hljs.highlightElement(el);
        });
      }
    } catch(_) { }

    // Lazy loading ×œ×ª××•× ×•×ª
    container.querySelectorAll('img').forEach(img => { img.loading = 'lazy'; });

    // KaTeX ××•×˜×•-×¨× ×“×¨ (×‘×‘×˜×—×”; ××™×Ÿ html ×’×•×œ××™)
    try { if (window.renderMathInElement) window.renderMathInElement(container, { delimiters:[{left:'$$',right:'$$',display:true},{left:'$',right:'$',display:false}] }); } catch(_){ }

    // Mermaid: ×¨× ×“×¨ ×“×™××’×¨××•×ª ×‘×§×•×“ fence ```mermaid
    try {
      if (!window.mermaid) throw new Error('mermaid missing');
      window.mermaid.initialize({ startOnLoad: false, securityLevel: 'strict' });
      const blocks = container.querySelectorAll('code.language-mermaid, pre code.language-mermaid');
      let i=0;
      for (const el of blocks) {
        const parent = el.closest('pre') || el.parentElement;
        const svgId = 'mmd_' + (++i);
        const code = el.textContent;
        const wrapper = document.createElement('div');
        parent.replaceWith(wrapper);
        try {
          const { svg } = await window.mermaid.render(svgId, code);
          wrapper.innerHTML = svg;
        } catch(e) {
          wrapper.innerHTML = '<div class="alert alert-warning">Mermaid render failed</div>';
        }
      }
    } catch(_){ }

    // ×›×¤×ª×•×¨ ×”×¢×ª×§×” ×œ×›×œ ×‘×œ×•×§ ×§×•×“ (×¢×˜×™×¤×” ×‘-.code-block ×›×“×™ ×œ× ×œ×”×¡×ª×™×¨ ×˜×§×¡×˜)
    try {
      const pres = Array.from(container.querySelectorAll('pre'));
      pres.forEach(pre => {
        let wrapper = pre.parentElement;
        if (!wrapper || !wrapper.classList || !wrapper.classList.contains('code-block')) {
          wrapper = document.createElement('div');
          wrapper.className = 'code-block';
          pre.replaceWith(wrapper);
          wrapper.appendChild(pre);
        }
        // ××œ ×ª×™×¦×•×¨ ×›×¤×ª×•×¨ × ×•×¡×£ ×× ×›×‘×¨ ×§×™×™× ×‘×ª×•×š ×”-wrapper
        if (wrapper.querySelector('button.md-copy-btn')) {
          return;
        }
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'md-copy-btn';
        btn.textContent = '×”×¢×ª×§';
        btn.addEventListener('click', async () => {
          try {
            const codeEl = wrapper.querySelector('code');
            const text = codeEl ? codeEl.innerText : pre.innerText;
            await navigator.clipboard.writeText(text);
            btn.textContent = '×”×•×¢×ª×§!';
            btn.classList.add('copied');
            setTimeout(() => { btn.textContent = '×”×¢×ª×§'; btn.classList.remove('copied'); }, 1500);
          } catch(e) {
            btn.textContent = '× ×›×©×œ';
            setTimeout(() => { btn.textContent = '×”×¢×ª×§'; }, 1200);
          }
        });
        wrapper.appendChild(btn);
      });
    } catch(_){ }

    // ×¨×©×™××•×ª ××©×™××•×ª ××™× ×˜×¨××§×˜×™×‘×™×•×ª: ×©××™×¨×”/×©×—×–×•×¨ ××¦×‘
    // ×‘-render, markdown-it-task-lists ×”×•×¤×š ×œ-input[type=checkbox]
    const boxes = container.querySelectorAll('input[type="checkbox"]');
    let idx = 0;
    boxes.forEach(cb => {
      cb.classList.add('md-task-checkbox');
      const key = 'i' + (idx++);
      // ×©×—×–×•×¨ ××¦×‘
      if (Object.prototype.hasOwnProperty.call(taskState, key)) {
        cb.checked = !!taskState[key];
      }
      cb.addEventListener('change', () => {
        taskState[key] = cb.checked;
        saveTaskState(taskState);
      });
    });

    // ×•×™×¨×˜×•××œ×™×–×¦×™×” ×‘×¡×™×¡×™×ª ×œ××¡××›×™× ××¨×•×›×™× (×—×œ×•×§×” ×œ×§×˜×¢×™× ×œ×¤×™ ×›×•×ª×¨×•×ª)
    try {
      const MAX_NODES = 2000;
      const nodes = Array.from(container.childNodes);
      if (nodes.length > MAX_NODES) {
        const chunk = document.createDocumentFragment();
        nodes.slice(0, MAX_NODES).forEach(n => chunk.appendChild(n));
        const rest = nodes.slice(MAX_NODES);
        container.innerHTML = '';
        container.appendChild(chunk);
        const more = document.createElement('button');
        more.className = 'btn btn-secondary btn-icon';
        more.textContent = '×˜×¢×Ÿ ×¢×•×“â€¦';
        more.addEventListener('click', () => {
          const frag = document.createDocumentFragment();
          rest.forEach(n => frag.appendChild(n));
          container.appendChild(frag);
          more.remove();
        });
        container.appendChild(document.createElement('hr'));
        container.appendChild(more);
      }
    } catch(_){ }

  } catch (e) {
    console.error('Markdown preview failed', e);
    const container = document.getElementById('md-content');
    container.innerHTML = '<div class="alert alert-error">×©×’×™××” ×‘×¨×™× ×“×•×¨ Markdown</div>';
  }
})();

// × ×™×•×•×˜ ×—×–×¨×” ×××™×Ÿ: ×× ×™×© ×”×™×¡×˜×•×¨×™×” â€“ ×—×–×•×¨; ××—×¨×ª × ×•×•×˜ ×™×©×™×¨×•×ª ×œ×¢××•×“ ×”×§×•×‘×¥
function goBackToFile(ev){
  try { if (ev) ev.preventDefault(); } catch(_){ }
  try {
    const sameOriginRef = document.referrer && new URL(document.referrer, window.location.origin).origin === window.location.origin;
    if (window.history && window.history.length > 1 && sameOriginRef) {
      window.history.back();
      return false;
    }
  } catch(_){ }
  try { window.location.replace('/file/{{ file.id }}'); } catch(_) { window.location.href = '/file/{{ file.id }}'; }
  return false;
}
</script>
{% endblock %}

