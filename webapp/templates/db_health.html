{% extends "base.html" %}

{% block title %}Database Health - Code Keeper Bot{% endblock %}

{% block content %}
<h1 class="page-title">ğŸ¥ Database Health Dashboard</h1>

<!-- Health Summary Card -->
<div class="health-summary glass-card" id="health-summary">
    <div class="summary-header">
        <div class="status-indicator" data-status="loading">
            <span class="status-dot"></span>
            <span class="status-text">×˜×•×¢×Ÿ...</span>
        </div>
        <button class="btn btn-secondary btn-icon" onclick="refreshAll()">
            <i class="fas fa-sync"></i>
            ×¨×¢× ×Ÿ ×”×›×œ
        </button>
    </div>
</div>

<!-- Metrics Grid -->
<div class="metrics-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.5rem; margin-top: 2rem;">

    <!-- Connection Pool Card -->
    <div class="glass-card metric-card" id="pool-card">
        <div class="card-header">
            <div class="card-title">
                <span class="card-icon">ğŸ”Œ</span>
                <h2>Connection Pool</h2>
            </div>
            <span class="refresh-indicator" data-refresh="5s">
                <i class="fas fa-clock"></i> 5s
            </span>
        </div>

        <div class="pool-metrics" id="pool-metrics">
            <div class="metric-row">
                <span class="metric-label">×—×™×‘×•×¨×™× ×¤×¢×™×œ×™×</span>
                <span class="metric-value" id="pool-current">-</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">×—×™×‘×•×¨×™× ×–××™× ×™×</span>
                <span class="metric-value" id="pool-available">-</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">× ×™×¦×•×œ×ª</span>
                <div class="progress-bar">
                    <div class="progress-fill" id="pool-utilization-bar" style="width: 0%"></div>
                </div>
                <span class="metric-value" id="pool-utilization">0%</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">×××ª×™× ×™× ×‘×ª×•×¨</span>
                <span class="metric-value" id="pool-queue">0</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">×¡×”"×› × ×•×¦×¨×•</span>
                <span class="metric-value dim" id="pool-created">-</span>
            </div>
        </div>
    </div>

    <!-- Current Operations Card -->
    <div class="glass-card metric-card" id="ops-card">
        <div class="card-header">
            <div class="card-title">
                <span class="card-icon">â±ï¸</span>
                <h2>Slow Queries</h2>
            </div>
            <span class="refresh-indicator" data-refresh="10s">
                <i class="fas fa-clock"></i> 10s
            </span>
        </div>

        <div class="ops-summary" id="ops-summary">
            <div class="ops-count">
                <span class="count-value" id="ops-count">0</span>
                <span class="count-label">×¤×¢×•×œ×•×ª ××™×˜×™×•×ª (>1s)</span>
            </div>
        </div>

        <div class="ops-list" id="ops-list">
            <p class="empty-state">××™×Ÿ ×¤×¢×•×œ×•×ª ××™×˜×™×•×ª ×›×¨×’×¢ ğŸ‰</p>
        </div>
    </div>
</div>

<!-- Collections Stats (On-Demand) -->
<div class="glass-card collections-card" id="collections-card" style="margin-top: 2rem;">
    <div class="card-header">
        <div class="card-title">
            <span class="card-icon">ğŸ“Š</span>
            <h2>Collection Stats</h2>
        </div>
        <button class="btn btn-primary btn-icon" id="load-collections-btn" onclick="loadCollections()">
            <i class="fas fa-database"></i>
            ×˜×¢×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª
        </button>
    </div>
    <div id="collections-notice" style="display:none; margin-top: 0.75rem; opacity: 0.9; font-size: 0.95rem;"></div>

    <div class="collections-table-wrapper" id="collections-wrapper" style="display: none;">
        <table class="collections-table">
            <thead>
                <tr>
                    <th>Collection</th>
                    <th>××¡××›×™×</th>
                    <th>×’×•×“×œ (MB)</th>
                    <th>××—×¡×•×Ÿ (MB)</th>
                    <th>××™× ×“×§×¡×™×</th>
                    <th>×’×•×“×œ ××™× ×“×§×¡×™× (MB)</th>
                </tr>
            </thead>
            <tbody id="collections-tbody">
            </tbody>
        </table>
    </div>
</div>

<!-- Documents Viewer (× ×¤×ª×— ×‘×œ×—×™×¦×” ×¢×œ collection) -->
<div class="glass-card documents-viewer" id="documents-viewer" style="display: none; margin-top: 2rem;">
    <div class="card-header">
        <div class="card-title">
            <span class="card-icon">ğŸ“„</span>
            <h2>×¦×¤×™×™×” ×‘××¡××›×™× â€” <code id="viewer-collection-name">-</code></h2>
        </div>
        <div class="card-actions">
            <button class="btn btn-secondary btn-icon" id="copy-json-btn" onclick="copyJsonToClipboard()" disabled>
                <i class="fas fa-copy"></i>
                ×”×¢×ª×§ JSON
            </button>
            <button class="btn btn-secondary btn-icon" onclick="closeDocumentsViewer()">
                <i class="fas fa-times"></i>
                ×¡×’×•×¨
            </button>
        </div>
    </div>

    <!-- Pagination Controls -->
    <div class="pagination-controls">
        <button class="btn btn-secondary" id="prev-btn" onclick="prevPage()" disabled>
            <i class="fas fa-chevron-right"></i>
            ×”×§×•×“×
        </button>
        <span class="pagination-info" id="pagination-info">-</span>
        <button class="btn btn-secondary" id="next-btn" onclick="nextPage()" disabled>
            ×”×‘×
            <i class="fas fa-chevron-left"></i>
        </button>
    </div>

    <!-- Code Display -->
    <div class="documents-code-wrapper">
        <!-- Empty State -->
        <div class="documents-empty-state" id="documents-empty-state" style="display: none;">
            ××™×Ÿ ××¡××›×™× ×œ×”×¦×’×”
        </div>
        
        <!-- Fallback: pre element (×œ×œ× CodeMirror) -->
        <pre class="documents-code" id="documents-code">×‘×—×¨ collection ××”×˜×‘×œ×” ×œ××¢×œ×”</pre>
        
        <!-- CodeMirror container (×× ×–××™×Ÿ) -->
        <textarea id="documents-code-editor" style="display: none;"></textarea>
    </div>
</div>

<style>
.health-summary {
    padding: 1.5rem;
}

.summary-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.status-indicator {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1.25rem;
    font-weight: 600;
}

.status-dot {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: #6b7280;
    animation: pulse 2s infinite;
}

.status-indicator[data-status="healthy"] .status-dot {
    background: #22c55e;
}

.status-indicator[data-status="warning"] .status-dot {
    background: #f59e0b;
}

.status-indicator[data-status="critical"] .status-dot {
    background: #ef4444;
}

.status-indicator[data-status="error"] .status-dot {
    background: #ef4444;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.metric-card {
    min-height: 280px;
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1.5rem;
}

.card-title {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.card-title h2 {
    margin: 0;
    font-size: 1.3rem;
    font-weight: 600;
}

.card-icon {
    font-size: 1.5rem;
}

.refresh-indicator {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.9rem;
}

.metric-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.metric-row:last-child {
    border-bottom: none;
}

.metric-label {
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.95rem;
}

.metric-value {
    font-size: 1.1rem;
    font-weight: 600;
    color: #fff;
}

.metric-value.dim {
    color: rgba(255, 255, 255, 0.6);
    font-weight: 400;
}

.progress-bar {
    flex: 1;
    height: 8px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    margin: 0 1rem;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #22c55e, #f59e0b, #ef4444);
    border-radius: 4px;
    transition: width 0.5s ease;
}

.ops-count {
    text-align: center;
    margin-bottom: 1.5rem;
}

.count-value {
    display: block;
    font-size: 2.5rem;
    font-weight: 700;
    color: #fff;
}

.count-label {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.95rem;
}

.ops-list {
    max-height: 300px;
    overflow-y: auto;
}

.empty-state {
    text-align: center;
    color: rgba(255, 255, 255, 0.6);
    padding: 2rem;
}

.op-item {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
    border-left: 4px solid;
}

.op-item.severity-info {
    border-left-color: #3b82f6;
}

.op-item.severity-warning {
    border-left-color: #f59e0b;
}

.op-item.severity-critical {
    border-left-color: #ef4444;
}

.op-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.op-namespace {
    font-weight: 600;
    color: #fff;
}

.op-duration {
    background: rgba(0, 0, 0, 0.3);
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.85rem;
}

.op-query {
    font-family: monospace;
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.7);
    background: rgba(0, 0, 0, 0.2);
    padding: 0.75rem;
    border-radius: 6px;
    overflow-x: auto;
}

.collections-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
}

.collections-table th {
    text-align: left;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.05);
    color: rgba(255, 255, 255, 0.9);
    font-weight: 600;
}

.collections-table td {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.8);
}

.collections-table tr:hover {
    background: rgba(255, 255, 255, 0.03);
}

/* ========== Documents Viewer ========== */
.documents-viewer {
    padding: 1.5rem;
}

.card-actions {
    display: flex;
    gap: 0.5rem;
}

.card-header code {
    font-family: 'Fira Code', ui-monospace, monospace;
    background: rgba(0, 0, 0, 0.2);
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-size: 0.9em;
}

.pagination-controls {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.pagination-info {
    font-size: 0.9rem;
    opacity: 0.8;
    min-width: 220px;
    text-align: center;
    font-variant-numeric: tabular-nums;
}

.documents-code-wrapper {
    max-height: 500px;
    overflow: auto;
    border-radius: 8px;
    background: rgba(0, 0, 0, 0.3);
    position: relative;
}

.documents-code {
    margin: 0;
    padding: 1rem;
    font-family: 'Fira Code', 'JetBrains Mono', ui-monospace, monospace;
    font-size: 0.85rem;
    line-height: 1.5;
    white-space: pre-wrap;
    word-break: break-word;
    color: #e2e8f0;
    tab-size: 2;
}

.documents-empty-state {
    text-align: center;
    padding: 3rem;
    opacity: 0.6;
    font-size: 1.1rem;
}

/* ×›×¤×ª×•×¨ Copy - ××¦×‘ ×”×¦×œ×—×” */
.btn-success {
    background: rgba(34, 197, 94, 0.3) !important;
    border-color: #22c55e !important;
}

/* ×”×“×’×©×ª ×©×•×¨×” × ×‘×—×¨×ª ×‘×˜×‘×œ×” */
.collections-table tr.selected {
    background: rgba(59, 130, 246, 0.2) !important;
}

.collections-table tr:hover {
    background: rgba(255, 255, 255, 0.05);
}

/* Rose Pine Dawn overrides */
:root[data-theme="rose-pine-dawn"] .documents-code-wrapper {
    background: rgba(242, 233, 225, 0.5);
}

:root[data-theme="rose-pine-dawn"] .documents-code {
    color: #575279;
}

:root[data-theme="rose-pine-dawn"] .card-header code {
    background: rgba(87, 82, 121, 0.1);
}

:root[data-theme="rose-pine-dawn"] .collections-table tr.selected {
    background: rgba(215, 130, 126, 0.15) !important;
}

:root[data-theme="rose-pine-dawn"] .pagination-controls {
    border-bottom-color: rgba(87, 82, 121, 0.15);
}

/* CodeMirror container styling */
.documents-code-wrapper .CodeMirror {
    height: 100%;
    max-height: 500px;
    font-family: 'Fira Code', ui-monospace, monospace;
    font-size: 0.85rem;
}

@media (max-width: 768px) {
    .card-actions {
        flex-direction: column;
        gap: 0.25rem;
    }
    
    .pagination-controls {
        flex-wrap: wrap;
    }
}
</style>

<script>
const DB_HEALTH_TOKEN = {{ db_health_token | tojson }};

function authHeaders() {
    if (!DB_HEALTH_TOKEN) {
        return {};
    }
    return { 'Authorization': `Bearer ${DB_HEALTH_TOKEN}` };
}

// Auto refresh timers
let poolInterval;
let opsInterval;
let collectionsCooldownTimer;
let collectionsCooldownEndMs = 0;

// ========== State ×œ×¦×¤×™×™×” ×‘××¡××›×™× ==========
let currentCollection = null;
let currentSkip = 0;
let currentRequestId = 0;  // ××•× ×¢ race conditions
const DOCS_LIMIT = 20;

async function refreshAll() {
    await Promise.all([
        loadHealthSummary(),
        loadPoolStatus(),
        loadCurrentOps()
    ]);
}

async function loadHealthSummary() {
    try {
        const resp = await fetch('/api/db/health', { headers: authHeaders() });
        const data = await resp.json();

        const indicator = document.querySelector('.status-indicator');
        indicator.dataset.status = data.status || 'unknown';
        indicator.querySelector('.status-text').textContent = getStatusText(data.status);
    } catch (e) {
        console.error('loadHealthSummary error:', e);
        const indicator = document.querySelector('.status-indicator');
        indicator.dataset.status = 'error';
        indicator.querySelector('.status-text').textContent = '×©×’×™××”';
    }
}

async function loadPoolStatus() {
    try {
        const resp = await fetch('/api/db/pool', { headers: authHeaders() });
        const data = await resp.json();

        document.getElementById('pool-current').textContent = data.current;
        document.getElementById('pool-available').textContent = data.available;
        document.getElementById('pool-created').textContent = data.total_created;
        document.getElementById('pool-queue').textContent = data.wait_queue_size || 0;

        const util = data.utilization_pct || 0;
        document.getElementById('pool-utilization').textContent = `${util}%`;
        document.getElementById('pool-utilization-bar').style.width = `${util}%`;

        // Update card border based on status
        const card = document.getElementById('pool-card');
        card.dataset.status = data.status || 'unknown';
    } catch (e) {
        console.error('loadPoolStatus error:', e);
    }
}

async function loadCurrentOps() {
    try {
        const resp = await fetch('/api/db/ops?threshold_ms=1000', { headers: authHeaders() });
        const data = await resp.json();

        document.getElementById('ops-count').textContent = data.count;

        const list = document.getElementById('ops-list');
        list.innerHTML = '';

        if (!data.operations || data.operations.length === 0) {
            list.innerHTML = '<p class="empty-state">××™×Ÿ ×¤×¢×•×œ×•×ª ××™×˜×™×•×ª ×›×¨×’×¢ ğŸ‰</p>';
            return;
        }

        data.operations.slice(0, 10).forEach(op => {
            const div = document.createElement('div');
            div.className = `op-item severity-${op.severity}`;

            const queryText = JSON.stringify(op.query, null, 2);

            div.innerHTML = `
                <div class="op-header">
                    <span class="op-namespace">${op.namespace}</span>
                    <span class="op-duration">${op.running_secs}s</span>
                </div>
                <div class="op-query">${escapeHtml(queryText)}</div>
            `;

            list.appendChild(div);
        });
    } catch (e) {
        console.error('loadCurrentOps error:', e);
    }
}

function escapeHtml(str) {
    return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
}

function getCollectionsBaseLabel() {
    const wrapper = document.getElementById('collections-wrapper');
    const hasData = wrapper && wrapper.style.display !== 'none';
    return hasData ? '<i class="fas fa-sync"></i> ×¨×¢× ×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª' : '<i class="fas fa-database"></i> ×˜×¢×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª';
}

function setCollectionsNotice(text, variant = 'muted') {
    const el = document.getElementById('collections-notice');
    if (!el) return;
    el.style.display = text ? 'block' : 'none';
    el.textContent = text || '';

    if (variant === 'warning') el.style.color = 'rgba(251, 191, 36, 0.95)';
    else if (variant === 'error') el.style.color = 'rgba(239, 68, 68, 0.95)';
    else el.style.color = 'rgba(255, 255, 255, 0.85)';
}

function startCollectionsCooldown(seconds) {
    const btn = document.getElementById('load-collections-btn');
    if (!btn) return;

    const sec = Math.max(1, parseInt(seconds || 0, 10) || 1);
    collectionsCooldownEndMs = Date.now() + (sec * 1000);

    if (collectionsCooldownTimer) {
        clearInterval(collectionsCooldownTimer);
        collectionsCooldownTimer = null;
    }

    const tick = () => {
        const remainingMs = Math.max(0, collectionsCooldownEndMs - Date.now());
        const remainingSec = Math.max(0, Math.ceil(remainingMs / 1000));
        if (remainingSec <= 0) {
            if (collectionsCooldownTimer) {
                clearInterval(collectionsCooldownTimer);
                collectionsCooldownTimer = null;
            }
            setCollectionsNotice('', 'muted');
            btn.disabled = false;
            btn.innerHTML = getCollectionsBaseLabel();
            return;
        }
        btn.disabled = true;
        btn.innerHTML = `<i class="fas fa-clock"></i> × × ×œ×”××ª×™×Ÿ ${remainingSec}s`;
    };

    tick();
    collectionsCooldownTimer = setInterval(tick, 250);
}

// ========== ×¤×•× ×§×¦×™×•×ª ×˜×¢×™× ×” ==========

/**
 * ×˜×¢×™× ×ª ××¡××›×™× ×-collection.
 * @param {string} collectionName - ×©× ×”-collection
 * @param {number} skip - ×›××” ××¡××›×™× ×œ×“×œ×’ (×‘×¨×™×¨×ª ××—×“×œ: 0)
 */
async function loadDocuments(collectionName, skip = 0) {
    const viewer = document.getElementById('documents-viewer');
    const viewerTitle = document.getElementById('viewer-collection-name');
    const codeContainer = document.getElementById('documents-code');
    const paginationInfo = document.getElementById('pagination-info');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const copyBtn = document.getElementById('copy-json-btn');
    const emptyState = document.getElementById('documents-empty-state');

    // âš ï¸ ×× ×™×¢×ª race condition: ×©××•×¨ ××–×”×” ×‘×§×©×” ×™×™×—×•×“×™
    const thisRequestId = ++currentRequestId;

    // ×”×¦×’ loading
    viewer.style.display = 'block';
    viewerTitle.textContent = collectionName;
    emptyState.style.display = 'none';
    paginationInfo.textContent = '×˜×•×¢×Ÿ...';
    prevBtn.disabled = true;
    nextBtn.disabled = true;
    copyBtn.disabled = true;

    // ×”×¦×’ loading ×‘-CodeMirror ××• ×‘-pre (×œ× ×©× ×™×”×!)
    if (window.documentsEditor) {
        window.documentsEditor.setValue('×˜×•×¢×Ÿ ××¡××›×™×...');
        codeContainer.style.display = 'none';  // ×”×¡×ª×¨ pre ×›×©-CM ×¤×¢×™×œ
    } else {
        codeContainer.textContent = '×˜×•×¢×Ÿ ××¡××›×™×...';
        codeContainer.style.display = 'block';
    }

    try {
        const url = `/api/db/${encodeURIComponent(collectionName)}/documents?skip=${skip}&limit=${DOCS_LIMIT}`;
        const resp = await fetch(url, { headers: authHeaders() });
        
        // âš ï¸ ×‘×“×™×§×ª race condition: ×× ×”×’×™×¢×” ×‘×§×©×” ×—×“×©×” ×‘×™× ×ª×™×™×, ×”×ª×¢×œ× ××ª×©×•×‘×” ×–×•
        if (thisRequestId !== currentRequestId) {
            console.log('Ignoring stale response for:', collectionName);
            return;
        }

        // ×¤×¨×¡×•×¨ JSON ×¢× ×˜×™×¤×•×œ ×‘×©×’×™××•×ª
        let data;
        try {
            data = await resp.json();
        } catch (parseError) {
            throw new Error('×ª×©×•×‘×” ×œ× ×ª×§×™× ×” ××”×©×¨×ª');
        }

        if (!resp.ok) {
            // ×”×¦×’×ª ×©×’×™××” ××ª××™××” ×œ×¤×™ ×¡×˜×˜×•×¡
            let errorMsg = data?.message || `×©×’×™××” ${resp.status}`;
            if (resp.status === 403) {
                errorMsg = `×’×™×©×” ×œ-${collectionName} ×—×¡×•××”`;
            } else if (resp.status === 400) {
                errorMsg = `×©× collection ×œ× ×ª×§×™×Ÿ: ${collectionName}`;
            }
            throw new Error(errorMsg);
        }

        // ×•×•×œ×™×“×¦×™×” ×©×œ ××‘× ×” ×”×ª×©×•×‘×”
        if (typeof data?.total !== 'number' || !Array.isArray(data?.documents)) {
            throw new Error('××‘× ×” ×ª×©×•×‘×” ×œ× ×ª×§×™×Ÿ ××”×©×¨×ª');
        }

        // ×¢×“×›×•×Ÿ state
        currentCollection = collectionName;
        currentSkip = skip;

        const total = data.total;
        const returnedCount = data.returned_count ?? data.documents.length;
        const hasMore = data.has_more ?? false;  // ×©×™××•×© ×‘×©×“×” ××”-backend

        // ×‘×“×™×§×ª empty state
        if (total === 0 || returnedCount === 0) {
            if (window.documentsEditor) {
                window.documentsEditor.setValue('');
            }
            codeContainer.style.display = 'none';
            emptyState.style.display = 'block';
            emptyState.textContent = `××™×Ÿ ××¡××›×™× ×‘-${collectionName}`;
            paginationInfo.textContent = '0 ××¡××›×™×';
            copyBtn.disabled = true;
        } else {
            // ×”×¦×’×ª JSON ××¢×•×¦×‘
            const formatted = JSON.stringify(data.documents, null, 2);
            
            // ×”×¦×’ ×‘-CodeMirror ××• ×‘-pre (×œ× ×©× ×™×”×!)
            if (window.documentsEditor) {
                window.documentsEditor.setValue(formatted);
                codeContainer.style.display = 'none';  // ×”×¡×ª×¨ pre
            } else {
                codeContainer.textContent = formatted;
                codeContainer.style.display = 'block';
            }
            emptyState.style.display = 'none';

            // ×¢×“×›×•×Ÿ ××™×“×¢ pagination
            const startDoc = skip + 1;
            const endDoc = skip + returnedCount;
            paginationInfo.textContent = `××¦×™×’ ${startDoc}-${endDoc} ××ª×•×š ${total.toLocaleString()} ××¡××›×™×`;

            // ×¢×“×›×•×Ÿ ×›×¤×ª×•×¨×™× - ×©×™××•×© ×‘-has_more ××”-backend
            prevBtn.disabled = skip === 0;
            nextBtn.disabled = !hasMore;
            copyBtn.disabled = false;
        }

        // ×”×“×’×©×ª ×”×©×•×¨×” ×”× ×‘×—×¨×ª ×‘×˜×‘×œ×”
        highlightSelectedCollection(collectionName);

    } catch (e) {
        // âš ï¸ ×‘×“×™×§×ª race condition ×’× ×‘×©×’×™××”
        if (thisRequestId !== currentRequestId) return;
        
        console.error('loadDocuments error:', e);
        const errorText = `×©×’×™××”: ${e.message}`;
        if (window.documentsEditor) {
            window.documentsEditor.setValue(errorText);
            codeContainer.style.display = 'none';
        } else {
            codeContainer.textContent = errorText;
            codeContainer.style.display = 'block';
        }
        emptyState.style.display = 'none';
    }
}

/**
 * ×“×¤×“×•×£ ×œ×¢××•×“ ×”×§×•×“×.
 */
function prevPage() {
    if (!currentCollection || currentSkip === 0) return;
    const newSkip = Math.max(0, currentSkip - DOCS_LIMIT);
    loadDocuments(currentCollection, newSkip);
}

/**
 * ×“×¤×“×•×£ ×œ×¢××•×“ ×”×‘×.
 */
function nextPage() {
    if (!currentCollection) return;
    loadDocuments(currentCollection, currentSkip + DOCS_LIMIT);
}

/**
 * ×”×¢×ª×§×ª ×”-JSON ×œ-clipboard.
 */
async function copyJsonToClipboard() {
    const codeContainer = document.getElementById('documents-code');
    const copyBtn = document.getElementById('copy-json-btn');
    
    try {
        const text = window.documentsEditor 
            ? window.documentsEditor.getValue() 
            : codeContainer.textContent;
        
        await navigator.clipboard.writeText(text);
        
        // ×¤×™×“×‘×§ ×•×™×–×•××œ×™
        const originalText = copyBtn.innerHTML;
        copyBtn.innerHTML = '<i class="fas fa-check"></i> ×”×•×¢×ª×§!';
        copyBtn.classList.add('btn-success');
        
        setTimeout(() => {
            copyBtn.innerHTML = originalText;
            copyBtn.classList.remove('btn-success');
        }, 2000);
    } catch (e) {
        console.error('Copy failed:', e);
        alert('×”×”×¢×ª×§×” × ×›×©×œ×”');
    }
}

/**
 * ×”×“×’×©×ª ×”×©×•×¨×” ×”× ×‘×—×¨×ª ×‘×˜×‘×œ×ª ×”-collections.
 */
function highlightSelectedCollection(collectionName) {
    // ×”×¡×¨ ×”×“×’×©×” ×§×•×“××ª
    document.querySelectorAll('.collections-table tr.selected').forEach(tr => {
        tr.classList.remove('selected');
    });

    // ×”×•×¡×£ ×”×“×’×©×” ×œ×©×•×¨×” ×”× ×•×›×—×™×ª
    document.querySelectorAll('.collections-table tbody tr').forEach(tr => {
        const nameCell = tr.querySelector('td:first-child');
        if (nameCell && nameCell.textContent === collectionName) {
            tr.classList.add('selected');
        }
    });
}

/**
 * ×¡×’×™×¨×ª ×—×œ×•×Ÿ ×”×¦×¤×™×™×” ×‘××¡××›×™×.
 */
function closeDocumentsViewer() {
    document.getElementById('documents-viewer').style.display = 'none';
    currentCollection = null;
    currentSkip = 0;

    // ×”×¡×¨ ×”×“×’×©×”
    document.querySelectorAll('.collections-table tr.selected').forEach(tr => {
        tr.classList.remove('selected');
    });
}

// Reference ×œ-MutationObserver ×œ× ×™×§×•×™
let _documentsEditorObserver = null;

/**
 * ××ª×—×•×œ CodeMirror ×œ×ª×¦×•×’×ª ××¡××›×™×.
 * ×‘×˜×•×— ×œ×§×¨×™××” ×—×•×–×¨×ª - ×œ× ×™×•×¦×¨ instances ×›×¤×•×œ×™×.
 */
function initDocumentsEditor() {
    if (typeof CodeMirror === 'undefined') {
        console.log('CodeMirror not available, using fallback <pre>');
        return;
    }

    // âš ï¸ ×× ×™×¢×ª ××ª×—×•×œ ×›×¤×•×œ - ×‘×“×•×§ ×× ×›×‘×¨ ×§×™×™×
    if (window.documentsEditor) {
        console.log('CodeMirror already initialized');
        return;
    }

    const textarea = document.getElementById('documents-code-editor');
    const preFallback = document.getElementById('documents-code');
    
    if (!textarea) return;

    // ×§×‘×¢ theme ×œ×¤×™ ×”-theme ×”× ×•×›×—×™ ×©×œ ×”×“×£
    const currentTheme = document.documentElement.dataset.theme || 'dark';
    const cmTheme = currentTheme.includes('dawn') || currentTheme.includes('light') 
        ? 'default'  // ××• theme ×‘×”×™×¨ ××—×¨ ×©×™×© ×œ×š
        : 'dracula'; // ××• theme ×›×”×” ××—×¨

    textarea.style.display = 'block';
    
    window.documentsEditor = CodeMirror.fromTextArea(textarea, {
        mode: { name: 'javascript', json: true },
        theme: cmTheme,
        readOnly: true,
        lineNumbers: true,
        foldGutter: true,
        gutters: ['CodeMirror-linenumbers', 'CodeMirror-foldgutter'],
        lineWrapping: true,
        matchBrackets: true,
    });

    // ×”×¡×ª×¨ ××ª ×”-pre fallback
    if (preFallback) {
        preFallback.style.display = 'none';
    }

    // ×¢×“×›×Ÿ theme ×›×©-theme ×”×“×£ ××©×ª× ×”
    _documentsEditorObserver = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            if (mutation.attributeName === 'data-theme' && window.documentsEditor) {
                const newTheme = document.documentElement.dataset.theme || 'dark';
                const newCmTheme = newTheme.includes('dawn') || newTheme.includes('light')
                    ? 'default'
                    : 'dracula';
                window.documentsEditor.setOption('theme', newCmTheme);
            }
        });
    });
    _documentsEditorObserver.observe(document.documentElement, { attributes: true });
}

/**
 * × ×™×§×•×™ CodeMirror ×•-observer (×œ×©×™××•×© ×‘-SPA ××• cleanup).
 */
function destroyDocumentsEditor() {
    if (_documentsEditorObserver) {
        _documentsEditorObserver.disconnect();
        _documentsEditorObserver = null;
    }
    
    if (window.documentsEditor) {
        window.documentsEditor.toTextArea();  // ××—×–×™×¨ ×œ-textarea ×¨×’×™×œ
        window.documentsEditor = null;
    }
}

async function loadCollections() {
    const btn = document.getElementById('load-collections-btn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ×˜×•×¢×Ÿ...';

    let rateLimited = false;
    try {
        const resp = await fetch('/api/db/collections', { headers: authHeaders() });
        const data = await resp.json().catch(() => ({}));

        if (resp.status === 429) {
            rateLimited = true;
            const hdr = resp.headers.get('Retry-After');
            const retryAfter = parseInt((data && data.retry_after_sec) || hdr || '0', 10) || 1;
            setCollectionsNotice(`× × ×œ×”××ª×™×Ÿ ${retryAfter} ×©× ×™×•×ª ×œ×¤× ×™ × ×™×¡×™×•×Ÿ × ×•×¡×£.`, 'warning');
            startCollectionsCooldown(retryAfter);
            return;
        }
        if (!resp.ok) {
            throw new Error((data && data.error) || 'request_failed');
        }

        const tbody = document.getElementById('collections-tbody');
        tbody.innerHTML = '';

        (data.collections || []).forEach(c => {
            const tr = document.createElement('tr');
            
            // ×”×•×¡×¤×ª ××™×¨×•×¢ ×œ×—×™×¦×”
            tr.style.cursor = 'pointer';
            tr.addEventListener('click', () => loadDocuments(c.name));
            tr.title = '×œ×—×¥ ×œ×¦×¤×™×™×” ×‘××¡××›×™×';

            const cells = [
                c.name,
                c.count.toLocaleString(),
                c.size_mb,
                c.storage_size_mb,
                c.index_count,
                c.total_index_size_mb
            ];

            cells.forEach(value => {
                const td = document.createElement('td');
                td.textContent = value;  // textContent ×‘×˜×•×— ×-XSS
                tr.appendChild(td);
            });

            tbody.appendChild(tr);
        });

        document.getElementById('collections-wrapper').style.display = 'block';
        setCollectionsNotice('ğŸ’¡ ×œ×—×¥ ×¢×œ ×©×•×¨×” ×œ×¦×¤×™×™×” ×‘××¡××›×™×', 'muted');
        btn.innerHTML = getCollectionsBaseLabel();
    } catch (e) {
        console.error('loadCollections error:', e);
        setCollectionsNotice('×©×’×™××” ×‘×˜×¢×™× ×ª ×¡×˜×˜×™×¡×˜×™×§×•×ª. × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.', 'error');
        btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> ×©×’×™××”';
    } finally {
        if (!rateLimited) {
            btn.disabled = false;
        }
    }
}

function getStatusText(status) {
    const texts = {
        healthy: 'âœ… ×ª×§×™×Ÿ',
        warning: 'âš ï¸ ××–×”×¨×”',
        critical: 'ğŸ”´ ×§×¨×™×˜×™',
        error: 'âŒ ×©×’×™××”',
        loading: '×˜×•×¢×Ÿ...',
        unknown: 'â“ ×œ× ×™×“×•×¢',
    };
    return texts[status] || status;
}

// Start polling
document.addEventListener('DOMContentLoaded', async () => {
    initDocumentsEditor();
    await refreshAll();
    poolInterval = setInterval(loadPoolStatus, 5000);
    opsInterval = setInterval(loadCurrentOps, 10000);
    setInterval(loadHealthSummary, 5000);
});
</script>
{% endblock %}

