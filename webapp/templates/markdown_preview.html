{% extends "base.html" %}

{% block title %}转爪转 Markdown - {{ file.file_name }}{% endblock %}

{% block extra_css %}
<style>
.preview-container {
    width: 100%;
    height: calc(100vh - 180px);
    background: rgba(255,255,255,0.05);
    border-radius: 12px;
    overflow: hidden;
}
.preview-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    row-gap: 0.5rem;
}
.preview-iframe {
    width: 100%;
    height: 100%;
    border: 0;
    background: white;
}
@media (max-width: 768px) {
    .preview-container { height: calc(100vh - 220px); }
}

@media (max-width: 480px) {
    .preview-actions .btn { padding: 0.5rem 0.75rem; }
}
</style>
{% endblock %}

{% block content %}
<div class="file-header">
    <div class="file-info">
        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
            <span style="font-size: 3rem;"></span>
            <div>
                <h1 style="margin: 0;">转爪转 Markdown: {{ file.file_name }}</h1>
                <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                    <span class="badge">{{ file.language }}</span>
                </div>
            </div>
        </div>
        <p style="margin: 0.5rem 0; opacity: 0.85;">
            转 爪 转 住专转 转 (sandbox)  专爪转 住拽专驻.
        </p>
    </div>

    <div class="preview-actions">
        <a href="/file/{{ file.id }}" class="btn btn-secondary btn-icon" title="爪驻 拽">
            <i class="fas fa-code"></i>
            拽
        </a>
        <a href="/download/{{ file.id }}" class="btn btn-secondary btn-icon" title="专">
            <i class="fas fa-download"></i>
            专
        </a>
        <a href="#" onclick="return goBack(event)" class="btn btn-secondary btn-icon" title="专 专砖">
            <i class="fas fa-arrow-right"></i>
            专
        </a>
    </div>
</div>

<div class="glass-card preview-container">
    <div style="display: flex; gap: .5rem; padding: .5rem; align-items: center; flex-wrap: wrap;">
        <button id="btnFullscreen" class="btn btn-secondary btn-icon" style="margin-inline-start:auto;">
            <i class="fas fa-expand"></i>
            住 
        </button>
        <a id="btnNewWindow" href="/raw_markdown/{{ file.id }}" target="_blank" rel="noopener" class="btn btn-secondary btn-icon">
            <i class="fas fa-external-link-alt"></i>
             砖
        </a>
    </div>
    <iframe
        id="previewFrame"
        class="preview-iframe"
        src="/raw_markdown/{{ file.id }}"
        sandbox="allow-modals"
        referrerpolicy="no-referrer"
        loading="eager"
        title="Markdown Preview"
    ></iframe>
    
</div>
<script>
(function(){
  const frame = document.getElementById('previewFrame');
  const btnFs = document.getElementById('btnFullscreen');
  if (!frame) return;
  if (btnFs) {
    btnFs.addEventListener('click', async function(){
      try {
        if (document.fullscreenElement === frame) {
          await document.exitFullscreen();
        } else {
          await frame.requestFullscreen();
        }
      } catch(e) { console.error(e); }
    });
  }
})();

// 专 专 砖转 转 住专转  住  
function goBack(ev){
  try { if (ev) ev.preventDefault(); } catch(e){}
  try {
    if (window.history && window.history.length > 1) {
      window.history.back();
      return false;
    }
    if (document.referrer) {
      const ref = new URL(document.referrer, window.location.origin);
      if (ref.origin === window.location.origin) {
        window.location.href = ref.toString();
        return false;
      }
    }
  } catch(e) {}
  window.location.href = '/files';
  return false;
}
</script>
{% endblock %}

