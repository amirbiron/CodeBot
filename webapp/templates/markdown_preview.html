{% extends "base.html" %}

{% block title %}×ª×¦×•×’×ª Markdown - {{ file.file_name }}{% endblock %}

{% block extra_css %}
<style>
.preview-container {
    width: 100%;
    height: calc(100vh - 180px);
    background: rgba(255,255,255,0.05);
    border-radius: 12px;
    overflow: hidden;
}
.preview-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    row-gap: 0.5rem;
}
.preview-iframe {
    width: 100%;
    height: 100%;
    border: 0;
    background: white;
}
@media (max-width: 768px) {
    .preview-container { height: calc(100vh - 220px); }
}

@media (max-width: 480px) {
    .preview-actions .btn { padding: 0.5rem 0.75rem; }
}
</style>
{% endblock %}

{% block content %}
<div class="file-header">
    <div class="file-info">
        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
            <span style="font-size: 3rem;">ğŸŒ</span>
            <div>
                <h1 style="margin: 0;">×ª×¦×•×’×ª Markdown: {{ file.file_name }}</h1>
                <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                    <span class="badge">{{ file.language }}</span>
                </div>
            </div>
        </div>
        <p style="margin: 0.5rem 0; opacity: 0.85;">
            ×”×ª×•×›×Ÿ ××•×¦×’ ×‘×ª×•×š ××¡×’×¨×ª ××‘×•×“×“×ª (sandbox) ×œ×œ× ×”×¨×¦×ª ×¡×§×¨×™×¤×˜×™×.
        </p>
    </div>

    <div class="preview-actions">
        <a href="/file/{{ file.id }}" class="btn btn-secondary btn-icon" title="×¦×¤×” ×‘×§×•×“">
            <i class="fas fa-code"></i>
            ×§×•×“
        </a>
        <a href="/download/{{ file.id }}" class="btn btn-secondary btn-icon" title="×”×•×¨×“">
            <i class="fas fa-download"></i>
            ×”×•×¨×“
        </a>
        <a href="#" onclick="return goBack(event)" class="btn btn-secondary btn-icon" title="×—×–×•×¨ ×œ×¨×©×™××”">
            <i class="fas fa-arrow-right"></i>
            ×—×–×•×¨
        </a>
    </div>
</div>

<div class="glass-card preview-container">
    <div style="display: flex; gap: .5rem; padding: .5rem; align-items: center; flex-wrap: wrap;">
        <div class="btn-group" role="group" aria-label="view-toggle">
            <button id="btnRendered" class="btn btn-primary btn-icon">ğŸŒ ×ª×¦×•×’×” ××¢×•×¦×‘×ª</button>
            <button id="btnRaw" class="btn btn-secondary btn-icon">ğŸ“ ×˜×§×¡×˜ ×’×•×œ××™</button>
        </div>
        <button id="btnFullscreen" class="btn btn-secondary btn-icon" style="margin-inline-start:auto;">
            <i class="fas fa-expand"></i>
            ××¡×š ××œ×
        </button>
        <a id="btnNewWindow" href="/raw_markdown/{{ file.id }}" target="_blank" rel="noopener" class="btn btn-secondary btn-icon">
            <i class="fas fa-external-link-alt"></i>
            ×—×œ×•×Ÿ ×—×“×©
        </a>
    </div>
    <div id="renderedView" class="preview-iframe" style="overflow:auto; padding: 1rem;">
        <article id="mdContent" class="markdown-body"></article>
    </div>
    <textarea id="rawView" class="preview-iframe" style="display:none; padding:1rem; font-family: 'Fira Code', monospace; font-size: 14px; white-space: pre; line-height: 1.5;">×˜×•×¢×Ÿâ€¦</textarea>
    
</div>
<script>
(function(){
  const rendered = document.getElementById('renderedView');
  const raw = document.getElementById('rawView');
  const mdArticle = document.getElementById('mdContent');
  const btnFs = document.getElementById('btnFullscreen');
  const btnRendered = document.getElementById('btnRendered');
  const btnRaw = document.getElementById('btnRaw');
  let current = 'rendered';

  async function loadData(){
    try {
      const resp = await fetch('/api/markdown_render/{{ file.id }}', {headers: {'Accept': 'application/json'}});
      const data = await resp.json();
      if (data && data.ok) {
        if (mdArticle) mdArticle.innerHTML = data.html || '';
        if (raw) raw.value = data.raw || '';
      } else {
        if (mdArticle) mdArticle.innerHTML = '<div class="alert alert-warning">×©×’×™××” ×‘×˜×¢×™× ×”</div>';
      }
    } catch (e) {
      if (mdArticle) mdArticle.innerHTML = '<div class="alert alert-danger">×©×’×™××” ×‘×˜×¢×™× ×”</div>';
    }
  }

  function showRendered(){
    current = 'rendered';
    if (rendered) rendered.style.display = '';
    if (raw) raw.style.display = 'none';
    if (btnRendered) { btnRendered.classList.remove('btn-secondary'); btnRendered.classList.add('btn-primary'); }
    if (btnRaw) { btnRaw.classList.remove('btn-primary'); btnRaw.classList.add('btn-secondary'); }
  }

  function showRaw(){
    current = 'raw';
    if (rendered) rendered.style.display = 'none';
    if (raw) raw.style.display = '';
    if (btnRendered) { btnRendered.classList.remove('btn-primary'); btnRendered.classList.add('btn-secondary'); }
    if (btnRaw) { btnRaw.classList.remove('btn-secondary'); btnRaw.classList.add('btn-primary'); }
  }

  if (btnRendered) btnRendered.addEventListener('click', function(e){ e.preventDefault(); showRendered(); });
  if (btnRaw) btnRaw.addEventListener('click', function(e){ e.preventDefault(); showRaw(); });
  loadData();

  if (btnFs) {
    btnFs.addEventListener('click', async function(){
      try {
        const target = current === 'raw' ? raw : rendered;
        if (document.fullscreenElement === target) {
          await document.exitFullscreen();
        } else {
          await target.requestFullscreen();
        }
      } catch(e) { console.error(e); }
    });
  }
})();

// ×—×–×¨×” ××—×•×¨×” ×©××›×‘×“×ª ××ª ×”×™×¡×˜×•×¨×™×™×ª ×”× ×™×•×•×˜ ×‘××¡×š ××—×“ ×‘×œ×‘×“
function goBack(ev){
  try { if (ev) ev.preventDefault(); } catch(e){}
  try {
    if (window.history && window.history.length > 1) {
      window.history.back();
      return false;
    }
    if (document.referrer) {
      const ref = new URL(document.referrer, window.location.origin);
      if (ref.origin === window.location.origin) {
        window.location.href = ref.toString();
        return false;
      }
    }
  } catch(e) {}
  window.location.href = '/files';
  return false;
}
</script>
{% endblock %}

