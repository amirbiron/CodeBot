{% extends "base.html" %}

{% block title %}Observability Dashboard{% endblock %}

{% block extra_css %}
<style>
.obs-page {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
  color: #fff;
}
.obs-page .page-title {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  font-size: 1.8rem;
  font-weight: 600;
}
.obs-toolbar {
  display: flex;
  flex-wrap: wrap;
  gap: 0.75rem;
  align-items: center;
  justify-content: space-between;
}
.toolbar-actions {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}
.toolbar-actions button {
  border: none;
  border-radius: 999px;
  padding: 0.35rem 0.9rem;
  background: rgba(255,255,255,0.08);
  color: #fff;
  cursor: pointer;
  font-size: 0.9rem;
  transition: background 0.2s ease;
}
.toolbar-actions button:hover {
  background: rgba(255,255,255,0.18);
}
.obs-toolbar .range-buttons {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}
.obs-toolbar button.range-btn {
  border: none;
  border-radius: 999px;
  padding: 0.35rem 0.9rem;
  background: rgba(255,255,255,0.08);
  color: #fff;
  cursor: pointer;
  font-size: 0.9rem;
  transition: background 0.2s ease;
}
.obs-toolbar button.range-btn.active {
  background: linear-gradient(135deg,#ff749c,#ffa34f);
  color: #121826;
  font-weight: 600;
}
.obs-toolbar .last-updated {
  font-size: 0.9rem;
  opacity: 0.8;
}
.obs-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(230px,1fr));
  gap: 1rem;
}
.obs-card {
  background: rgba(18,24,38,0.75);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 16px;
  padding: 1.25rem;
  box-shadow: 0 10px 30px rgba(0,0,0,0.25);
}
.obs-card h3 {
  font-size: 0.9rem;
  margin: 0;
  opacity: 0.75;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}
.obs-card .obs-card-value {
  font-size: 2.4rem;
  font-weight: 600;
  margin: 0.5rem 0 0;
}
.obs-card .obs-card-subtext {
  font-size: 0.85rem;
  opacity: 0.65;
  margin-top: 0.2rem;
}
.obs-graphs {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(320px,1fr));
  gap: 1rem;
}
.obs-graph {
  background: rgba(18,24,38,0.72);
  border-radius: 18px;
  padding: 1rem 1.25rem 1.2rem;
  border: 1px solid rgba(255,255,255,0.05);
  box-shadow: 0 18px 32px rgba(0,0,0,0.35);
}
.obs-graph h2 {
  margin: 0 0 0.8rem;
  font-size: 1.1rem;
}
.obs-section {
  background: rgba(18,24,38,0.72);
  border-radius: 18px;
  padding: 1rem 1.25rem 1.5rem;
  border: 1px solid rgba(255,255,255,0.05);
  box-shadow: 0 18px 32px rgba(0,0,0,0.35);
}
.obs-section h2 {
  margin: 0 0 0.8rem;
  font-size: 1.1rem;
}
.obs-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.92rem;
}
.obs-table thead th {
  text-align: right;
  padding: 0.5rem;
  border-bottom: 1px solid rgba(255,255,255,0.09);
  font-weight: 500;
  opacity: 0.75;
}
.obs-table tbody td {
  padding: 0.55rem 0.5rem;
  border-bottom: 1px solid rgba(255,255,255,0.05);
}
.obs-table tbody tr:hover {
  background: rgba(255,255,255,0.02);
}
.obs-history-card {
  background: rgba(18,24,38,0.8);
  border-radius: 20px;
  padding: 1.25rem;
  border: 1px solid rgba(255,255,255,0.05);
  box-shadow: 0 20px 38px rgba(0,0,0,0.4);
}
.history-header {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}
.history-filters {
  display: flex;
  flex-wrap: wrap;
  gap: 0.6rem;
}
.history-filters select,
.history-filters input {
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 999px;
  color: #fff;
  padding: 0.35rem 0.9rem;
  font-size: 0.85rem;
}
.history-filters input {
  border-radius: 12px;
}
.pagination-controls {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 0.8rem;
}
.pagination-controls button {
  background: rgba(255,255,255,0.08);
  border: none;
  color: #fff;
  padding: 0.4rem 0.9rem;
  border-radius: 999px;
  cursor: pointer;
}
.pagination-controls button:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}
.status-pill {
  display: inline-flex;
  align-items: center;
  gap: 0.3rem;
  border-radius: 999px;
  padding: 0.2rem 0.7rem;
  font-size: 0.8rem;
}
.status-critical { background: rgba(255,99,132,0.15); color: #ff627c; }
.status-anomaly { background: rgba(255,206,86,0.18); color: #fcd177; }
.status-warning { background: rgba(54,162,235,0.18); color: #5ec0ff; }
.status-info { background: rgba(99,255,203,0.15); color: #64ffda; }
.meta-list {
  display: flex;
  flex-wrap: wrap;
  gap: 0.4rem;
  font-size: 0.8rem;
  opacity: 0.8;
}
.meta-list span {
  background: rgba(255,255,255,0.06);
  border-radius: 8px;
  padding: 0.15rem 0.5rem;
}
.quick-fix-list {
  display: flex;
  flex-wrap: wrap;
  gap: 0.3rem;
}
.quick-fix-action {
  border: none;
  border-radius: 999px;
  padding: 0.25rem 0.7rem;
  font-size: 0.8rem;
  background: rgba(100,255,218,0.12);
  color: #64ffda;
  cursor: pointer;
}
.quick-fix-action.safety-caution {
  background: rgba(255, 206, 86, 0.2);
  color: #fdd65c;
}
.quick-fix-action.safety-danger {
  background: rgba(255, 99, 132, 0.2);
  color: #ff627c;
}
.quick-fix-action:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
.story-cell {
  display: flex;
  flex-direction: column;
  gap: 0.15rem;
}
.story-btn {
  border: none;
  border-radius: 10px;
  padding: 0.25rem 0.7rem;
  font-size: 0.8rem;
  background: rgba(100,255,218,0.12);
  color: #64ffda;
  cursor: pointer;
}
.story-btn.has-story {
  background: linear-gradient(135deg,#64ffda,#36c2ff);
  color: #08111d;
  font-weight: 600;
  box-shadow: 0 10px 18px rgba(54,194,255,0.25);
}
.story-badge {
  font-size: 0.75rem;
  color: #9efff0;
  opacity: 0.85;
}
.story-modal {
  position: fixed;
  inset: 0;
  background: rgba(4,6,12,0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 3000;
}
.story-modal[hidden] {
  display: none;
}
.story-modal__dialog {
  background: rgba(18,24,38,0.95);
  border-radius: 18px;
  border: 1px solid rgba(255,255,255,0.08);
  width: min(720px, 95vw);
  max-height: 92vh;
  overflow-y: auto;
  padding: 1.5rem;
  box-shadow: 0 20px 60px rgba(0,0,0,0.6);
}
.story-modal__header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 1rem;
  margin-bottom: 1rem;
}
.story-modal__header h3 {
  margin: 0;
}
.story-modal__close {
  background: transparent;
  border: none;
  color: #fff;
  font-size: 1.25rem;
  cursor: pointer;
}
.story-form {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}
.story-form label {
  font-size: 0.85rem;
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
  opacity: 0.85;
}
.story-form input,
.story-form textarea {
  border: 1px solid rgba(255,255,255,0.12);
  background: rgba(255,255,255,0.05);
  color: #fff;
  border-radius: 12px;
  padding: 0.45rem 0.6rem;
  font-size: 0.9rem;
  width: 100%;
}
.story-form textarea {
  min-height: 90px;
}
.story-form__row {
  display: grid;
  gap: 0.75rem;
  grid-template-columns: repeat(auto-fit,minmax(180px,1fr));
}
.story-modal__actions {
  display: flex;
  flex-wrap: wrap;
  gap: 0.6rem;
  margin-top: 0.5rem;
}
.story-modal__actions button {
  border: none;
  border-radius: 12px;
  padding: 0.45rem 1rem;
  cursor: pointer;
  font-weight: 600;
}
.story-save-btn {
  background: linear-gradient(135deg,#64ffda,#36c2ff);
  color: #08111d;
}
.story-download-btn {
  background: rgba(255,255,255,0.15);
  color: #fff;
}
.story-secondary-btn {
  background: rgba(255,255,255,0.08);
  color: #fff;
}
.story-meta-box {
  background: rgba(255,255,255,0.04);
  border: 1px solid rgba(255,255,255,0.06);
  border-radius: 12px;
  padding: 0.75rem;
  font-size: 0.85rem;
}
.graph-toggle-btn {
  border: none;
  border-radius: 999px;
  padding: 0.3rem 0.8rem;
  background: rgba(255,255,255,0.08);
  color: #64ffda;
  cursor: pointer;
  font-size: 0.85rem;
  transition: background 0.2s ease;
}
.graph-toggle-btn:hover {
  background: rgba(100,255,218,0.2);
}
.graph-toggle-btn.active {
  background: rgba(255,255,255,0.15);
  color: #121826;
  font-weight: 600;
}
.visual-context-row {
  display: none;
}
.visual-context-row.open {
  display: table-row;
}
.visual-context-panel {
  background: rgba(10,16,26,0.92);
  border: 1px solid rgba(100,255,218,0.2);
  border-radius: 18px;
  padding: 1rem 1.2rem 1.4rem;
  box-shadow: 0 20px 40px rgba(0,0,0,0.45);
}
.visual-context-header {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  gap: 0.8rem;
  align-items: center;
  margin-bottom: 0.6rem;
}
.visual-context-title {
  font-size: 1.1rem;
  font-weight: 600;
}
.visual-context-subtitle {
  font-size: 0.85rem;
  opacity: 0.65;
}
.vc-controls {
  display: flex;
  flex-wrap: wrap;
  gap: 0.35rem;
  align-items: center;
}
.vc-controls span {
  font-size: 0.85rem;
  opacity: 0.7;
}
.vc-range-btn,
.vc-zoom-btn {
  border: none;
  border-radius: 999px;
  padding: 0.25rem 0.7rem;
  background: rgba(255,255,255,0.08);
  color: #fff;
  cursor: pointer;
  font-size: 0.8rem;
}
.vc-range-btn.active {
  background: linear-gradient(135deg,#64ffda,#4dd0e1);
  color: #0c1725;
  font-weight: 600;
}
.vc-zoom-btn {
  font-weight: 600;
  min-width: 2rem;
}
.visual-context-status {
  font-size: 0.85rem;
  opacity: 0.8;
  margin-bottom: 0.5rem;
}
.visual-context-status.error {
  color: #ff627c;
  opacity: 1;
}
.vc-chart-wrapper {
  width: 100%;
  overflow: hidden;
}
.vc-chart-wrapper canvas {
  width: 100%;
}
.highlight-row {
  background: rgba(255,255,255,0.05);
  box-shadow: inset 0 0 0 1px rgba(255,255,255,0.12);
}
@media (max-width: 720px) {
  .obs-toolbar {
    flex-direction: column;
    align-items: flex-start;
  }
  .obs-toolbar .last-updated {
    width: 100%;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="obs-page" dir="rtl">
  <div class="page-title">
    <i class="fas fa-eye"></i>
    ×œ×•×— Observability
  </div>

  <div class="obs-toolbar">
    <div class="range-buttons" id="rangeButtons">
      <button class="range-btn active" data-range="1h">1 ×©×¢×”</button>
      <button class="range-btn" data-range="24h">24 ×©×¢×•×ª</button>
      <button class="range-btn" data-range="7d">7 ×™××™×</button>
      <button class="range-btn" data-range="30d">30 ×™×•×</button>
    </div>
    <div class="last-updated">
      <span>×¢×•×“×›×Ÿ ×œ××—×¨×•× ×”:</span>
      <span id="lastUpdated">â€”</span>
    </div>
    <div class="toolbar-actions">
      <button id="exportJsonBtn">ğŸ“¥ ×™×™×¦×•× JSON</button>
      <button id="openReplayBtn">âª Incident Replay</button>
    </div>
  </div>

  <div class="obs-cards">
    <div class="obs-card" data-card="critical">
      <h3>CRITICAL ×”×™×•×</h3>
      <div class="obs-card-value" id="criticalCount">â€”</div>
      <div class="obs-card-subtext">×”×ª×¨××•×ª ××—××™×¨×•×ª ×‘-24 ×”×©×¢×•×ª ×”××—×¨×•× ×•×ª</div>
    </div>
    <div class="obs-card" data-card="anomaly">
      <h3>×× ×•××œ×™×•×ª ×‘×©×‘×•×¢</h3>
      <div class="obs-card-value" id="anomalyCount">â€”</div>
      <div class="obs-card-subtext">×”×ª×¨×¢×•×ª anomaly ×‘×˜×•×•×— ×©× ×‘×—×¨</div>
    </div>
    <div class="obs-card" data-card="deployments">
      <h3>×“×™×¤×œ×•×™×× ×˜×™×</h3>
      <div class="obs-card-value" id="deployCount">â€”</div>
      <div class="obs-card-subtext">×“×™×¤×œ×•×™×× ×˜×™× ×©×“×•×•×—×• ×‘×˜×•×•×—</div>
    </div>
    <div class="obs-card" data-card="error-rate">
      <h3>Spike ×‘×–××Ÿ ×“×™×¤×œ×•×™×× ×˜</h3>
      <div class="obs-card-value" id="deploySpike">â€”</div>
      <div class="obs-card-subtext">×××•×¦×¢ ×©× ×™×•×ª ×¢×™×›×•×‘ ×‘×¡××•×š ×œ×“×™×¤×œ×•×™×× ×˜×™×</div>
    </div>
  </div>

  <div class="obs-graphs">
    <div class="obs-graph">
      <h2>×”×ª×¨××•×ª ×œ×¤×™ ×—×•××¨×”</h2>
      <canvas id="alertsChart" height="240"></canvas>
    </div>
    <div class="obs-graph">
      <h2>×–×× ×™ ×ª×’×•×‘×” ×××•×¦×¢×™×</h2>
      <canvas id="responseChart" height="240"></canvas>
    </div>
  </div>

  <div class="obs-section">
    <h2>× ×§×•×“×•×ª ×§×¦×” ××™×˜×™×•×ª (24 ×©×¢×•×ª ××—×¨×•× ×•×ª)</h2>
    <div class="table-responsive" style="overflow-x:auto;">
      <table class="obs-table" id="slowEndpointsTable">
        <thead>
          <tr>
            <th>Endpoint</th>
            <th>×©×™×˜×”</th>
            <th>×××•×¦×¢ (×©×³×³)</th>
            <th>××§×¡×™××•× (×©×³×³)</th>
            <th>×›××•×ª</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="5">×˜×•×¢×Ÿ × ×ª×•× ×™×â€¦</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="obs-history-card">
    <div class="history-header">
      <h2>×”×™×¡×˜×•×¨×™×™×ª ×”×ª×¨××•×ª</h2>
      <div class="history-filters">
        <select id="severityFilter">
          <option value="all">×›×œ ×”×—×•××¨×•×ª</option>
          <option value="critical">Critical</option>
          <option value="anomaly">Anomaly</option>
          <option value="warning">Warning</option>
          <option value="info">Info</option>
        </select>
        <select id="typeFilter">
          <option value="all">×›×œ ×”×¡×•×’×™×</option>
          <option value="deployment_event">Deployment</option>
          <option value="anomaly_detected">Anomaly Detected</option>
          <option value="high_error_rate">High Error Rate</option>
        </select>
        <input type="text" id="endpointFilter" placeholder="Endpoint / Path">
        <input type="search" id="searchFilter" placeholder="×—×™×¤×•×© ×—×•×¤×©×™">
      </div>
    </div>
    <div class="table-responsive" style="overflow-x:auto;">
      <table class="obs-table" id="alertsTable">
        <thead>
          <tr>
            <th>×–××Ÿ</th>
            <th>×©×</th>
            <th>×—×•××¨×”</th>
            <th>×¡×™×›×•×</th>
            <th>Meta</th>
            <th>×’×¨×£</th>
            <th>Quick Fix</th>
            <th>×¡×™×¤×•×¨ ××™×¨×•×¢</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="8">×˜×•×¢×Ÿ × ×ª×•× ×™×â€¦</td></tr>
        </tbody>
      </table>
    </div>
    <div class="pagination-controls">
      <button id="prevPageBtn">&larr; ×§×•×“×</button>
      <div id="pageLabel">×¢××•×“ 1</div>
      <button id="nextPageBtn">×”×‘× &rarr;</button>
    </div>
  </div>
</div>

<div id="storyModal" class="story-modal" hidden>
  <div class="story-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="storyModalTitle">
    <div class="story-modal__header">
      <h3 id="storyModalTitle">ğŸ“– ×¡×™×¤×•×¨ ××™×¨×•×¢</h3>
      <button class="story-modal__close" type="button" data-story-close aria-label="×¡×’×•×¨">âœ•</button>
    </div>
    <div id="storyModalBody">
      <form class="story-form" onsubmit="return false;">
        <div class="story-form__row">
          <label>
            ×”×ª×—×œ×”
            <input type="datetime-local" id="storyWindowStart">
          </label>
          <label>
            ×¡×™×•×
            <input type="datetime-local" id="storyWindowEnd">
          </label>
        </div>
        <label>
          ğŸ‘€ ××” ×¨××™× ×•
          <textarea id="storyWhatSaw"></textarea>
        </label>
        <label>
          ğŸ› ï¸ ××” ×¢×©×™× ×• (×”×¢×¨×•×ª ×™×“× ×™×•×ª)
          <textarea id="storyWhatDid"></textarea>
        </label>
        <label>
          ğŸ’» ×œ×•×’×™× / ×¤×§×•×“×•×ª
          <textarea id="storyLogs" placeholder="××¤×©×¨ ×œ×”×–×™×Ÿ ×›×œ ×©×•×¨×” ×›×¢×¨×š × ×¤×¨×“"></textarea>
        </label>
        <label>
          ğŸ’¡ ×ª×•×‘× ×•×ª
          <textarea id="storyInsights"></textarea>
        </label>
        <div class="story-meta-box" id="storyAutoSection">
          <div><strong>×¤×¢×•×œ×•×ª ×©× ×¨×©××•:</strong></div>
          <ul id="storyAutoActions"></ul>
          <div style="margin-top:0.5rem;"><strong>××™×“×¢ ×’×¨×¤×™:</strong></div>
          <div id="storyGraphMeta" style="opacity:0.85;"></div>
        </div>
      </form>
      <div id="storyStatus" style="font-size:0.85rem; opacity:0.85; margin-top:0.6rem;"></div>
      <div class="story-modal__actions">
        <button type="button" class="story-save-btn" id="storySaveBtn">ğŸ’¾ ×©××•×¨ ×¡×™×¤×•×¨</button>
        <button type="button" class="story-download-btn" id="storySaveMarkdown">ğŸ“ ×©××™×¨×” ×›-Markdown</button>
        <button type="button" class="story-secondary-btn" id="storyDownloadPdf">ğŸ–¨ï¸ ×™×™×¦×•× PDF</button>
        <button type="button" class="story-secondary-btn" data-story-close>×¡×’×•×¨</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function(){
  const initialParams = new URLSearchParams(window.location.search || '');
  const state = {
    range: '1h',
    severity: 'all',
    type: 'all',
    endpoint: '',
    search: '',
    page: 1,
    perPage: 25,
    lastUpdatedEl: document.getElementById('lastUpdated'),
    focusTs: initialParams.get('focus_ts') || '',
    alerts: [],
    pendingStoryId: initialParams.get('story_id') || '',
  };
  const storyState = {
    alert: null,
    template: null,
    story: null,
  };
  const storyModal = document.getElementById('storyModal');
  const storyFormEls = {
    start: document.getElementById('storyWindowStart'),
    end: document.getElementById('storyWindowEnd'),
    whatSaw: document.getElementById('storyWhatSaw'),
    whatDid: document.getElementById('storyWhatDid'),
    logs: document.getElementById('storyLogs'),
    insights: document.getElementById('storyInsights'),
    autoList: document.getElementById('storyAutoActions'),
    graphMeta: document.getElementById('storyGraphMeta'),
    status: document.getElementById('storyStatus'),
    title: document.getElementById('storyModalTitle'),
  };
  const storyButtons = {
    save: document.getElementById('storySaveBtn'),
    saveMarkdown: document.getElementById('storySaveMarkdown'),
    downloadPdf: document.getElementById('storyDownloadPdf'),
  };
  const OBS_LOCALE = 'he-IL';
  const OBS_TIMEZONE = 'Asia/Jerusalem';

  function formatJerusalemDate(value, overrides = {}) {
    if (value == null || value === '') return 'â€”';
    try {
      const date = value instanceof Date ? value : new Date(value);
      if (Number.isNaN(date.getTime())) {
        return typeof value === 'string' ? value : 'â€”';
      }
      return date.toLocaleString(OBS_LOCALE, {
        hour12: false,
        timeZone: OBS_TIMEZONE,
        ...overrides,
      });
    } catch (err) {
      return typeof value === 'string' ? value : 'â€”';
    }
  }
  const VISUAL_PRESETS = ['15m', '30m', '1h', '6h', '24h', '7d'];
  const visualContextStore = {};
  const visualContextCache = {};
  let alertsChart;
  let responseChart;

  function formatTimestamp(ts){
    return formatJerusalemDate(ts);
  }

  function formatShortTimestamp(ts) {
    if (!ts) return 'â€”';
    const label = formatJerusalemDate(ts, { hour: '2-digit', minute: '2-digit' });
    return label === 'â€”' ? 'â€”' : label;
  }

  function getGranularity() {
    if (state.range === '1h') return '5m';
    if (state.range === '24h') return '1h';
    if (state.range === '7d') return '6h';
    return '12h';
  }

  async function fetchJson(url) {
    const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    return res.json();
  }

  function updateCards(summary, correlation) {
    const criticalEl = document.getElementById('criticalCount');
    const anomalyEl = document.getElementById('anomalyCount');
    const deployEl = document.getElementById('deployCount');
    const spikeEl = document.getElementById('deploySpike');
    if (criticalEl) criticalEl.textContent = summary?.critical ?? '0';
    if (anomalyEl) anomalyEl.textContent = summary?.anomaly ?? '0';
    if (deployEl) deployEl.textContent = summary?.deployment ?? '0';
    if (spikeEl) spikeEl.textContent = correlation?.avg_spike_during_deployment?.toFixed?.(2) ?? '0';
  }

  function updateLastUpdated() {
    if (state.lastUpdatedEl) {
      state.lastUpdatedEl.textContent = formatJerusalemDate(new Date());
    }
  }

  function renderTopEndpoints(rows) {
    const body = document.querySelector('#slowEndpointsTable tbody');
    if (!body) return;
    if (!rows || !rows.length) {
      body.innerHTML = '<tr><td colspan="5">××™×Ÿ × ×ª×•× ×™× ×–××™× ×™×</td></tr>';
      return;
    }
    body.innerHTML = rows.map(row => `
      <tr>
        <td>${row.endpoint || '-'}</td>
        <td>${row.method || '-'}</td>
        <td>${Number(row.avg_duration || 0).toFixed(2)}</td>
        <td>${Number(row.max_duration || 0).toFixed(2)}</td>
        <td>${row.count || 0}</td>
      </tr>
    `).join('');
  }

  function ensureChart(ctxId, cfg) {
    const ctx = document.getElementById(ctxId);
    if (!ctx) return null;
    if (ctxId === 'alertsChart' && alertsChart) alertsChart.destroy();
    if (ctxId === 'responseChart' && responseChart) responseChart.destroy();
    const chart = new Chart(ctx, cfg);
    if (ctxId === 'alertsChart') alertsChart = chart;
    if (ctxId === 'responseChart') responseChart = chart;
    return chart;
  }

  function renderAlertsChart(data) {
    const labels = data.map(d => {
      const label = formatJerusalemDate(d.timestamp);
      return label === 'â€”' ? '' : label;
    });
    const critical = data.map(d => d.critical || 0);
    const anomaly = data.map(d => d.anomaly || 0);
    const info = data.map(d => d.info || 0);
    ensureChart('alertsChart', {
      type: 'line',
      data: {
        labels,
        datasets: [
          { label: 'Critical', data: critical, borderColor: '#ff6384', backgroundColor: 'rgba(255,99,132,0.15)', tension: 0.3 },
          { label: 'Anomaly', data: anomaly, borderColor: '#ffcd56', backgroundColor: 'rgba(255,206,86,0.15)', tension: 0.3 },
          { label: 'Info', data: info, borderColor: '#36a2eb', backgroundColor: 'rgba(54,162,235,0.15)', tension: 0.3 },
        ],
      },
      options: {
        plugins: { legend: { labels: { color: '#fff' } } },
        scales: {
          x: { ticks: { color: '#ccc' }, grid: { color: 'rgba(255,255,255,0.05)' } },
          y: { ticks: { color: '#ccc' }, grid: { color: 'rgba(255,255,255,0.05)' }, beginAtZero: true },
        },
      },
    });
  }

  function renderResponseChart(data) {
    const labels = data.map(d => {
      const label = formatJerusalemDate(d.timestamp);
      return label === 'â€”' ? '' : label;
    });
    const avg = data.map(d => d.avg_duration || 0);
    const max = data.map(d => d.max_duration || 0);
    ensureChart('responseChart', {
      type: 'line',
      data: {
        labels,
        datasets: [
          { label: '×××•×¦×¢ (×©×³×³)', data: avg, borderColor: '#64ffda', backgroundColor: 'rgba(100,255,218,0.15)', tension: 0.25 },
          { label: '××§×¡×™××•× (×©×³×³)', data: max, borderColor: '#ff79c6', backgroundColor: 'rgba(255,121,198,0.15)', tension: 0.25 },
        ],
      },
      options: {
        plugins: { legend: { labels: { color: '#fff' } } },
        scales: {
          x: { ticks: { color: '#ccc' }, grid: { color: 'rgba(255,255,255,0.05)' } },
          y: { ticks: { color: '#ccc' }, grid: { color: 'rgba(255,255,255,0.05)' }, beginAtZero: true },
        },
      },
    });
  }

  function severityClass(sev) {
    if (!sev) return 'status-info';
    const v = String(sev).toLowerCase();
    if (v.startsWith('crit')) return 'status-critical';
    if (v.startsWith('anom')) return 'status-anomaly';
    if (v.startsWith('warn')) return 'status-warning';
    return 'status-info';
  }

  function hasVisualGraph(alert) {
    return Boolean(
      alert &&
      alert.graph &&
      alert.graph.available &&
      alert.graph.metric &&
      alert.alert_uid &&
      alert.timestamp
    );
  }

  function buildGraphMeta(alert) {
    const graph = alert.graph || {};
    return {
      uid: alert.alert_uid || '',
      metric: graph.metric,
      label: graph.label || graph.metric || '×’×¨×£',
      unit: graph.unit || '',
      defaultRange: String(graph.default_range || '').toLowerCase(),
      defaultMinutes: Number(graph.default_minutes || 60),
      timestamp: alert.timestamp,
      category: graph.category || '',
    };
  }

  function renderGraphCell(alert) {
    if (!hasVisualGraph(alert)) {
      return '<span style="opacity:0.4;">â€”</span>';
    }
    const meta = buildGraphMeta(alert);
    if (!meta.uid || !meta.metric || !meta.timestamp) {
      return '<span style="opacity:0.4;">â€”</span>';
    }
    const payload = encodeURIComponent(JSON.stringify(meta));
    return `<button class="graph-toggle-btn" data-graph="${payload}" data-alert-uid="${meta.uid}" aria-expanded="false">ğŸ“ˆ ×”×§×©×¨</button>`;
  }

  function renderGraphRow(alert) {
    if (!hasVisualGraph(alert)) {
      return '';
    }
    const meta = buildGraphMeta(alert);
    if (!meta.uid) {
      return '';
    }
    const payload = encodeURIComponent(JSON.stringify(meta));
    const presetButtons = VISUAL_PRESETS
      .map(label => `<button class="vc-range-btn" data-range="${label}">${label}</button>`)
      .join('');
    return `
      <tr class="visual-context-row" id="visual-row-${meta.uid}" data-alert-uid="${meta.uid}" hidden>
        <td colspan="8">
          <div class="visual-context-panel" data-graph="${payload}">
            <div class="visual-context-header">
              <div>
                <div class="visual-context-title">${meta.label}</div>
                <div class="visual-context-subtitle">${meta.unit || ''}</div>
              </div>
              <div class="vc-controls">
                <span>×˜×•×•×—:</span>
                ${presetButtons}
                <div class="vc-zoom">
                  <button class="vc-zoom-btn" data-zoom="out" title="Zoom Out">âˆ’</button>
                  <button class="vc-zoom-btn" data-zoom="in" title="Zoom In">+</button>
                </div>
              </div>
            </div>
            <div class="visual-context-status" id="vc-status-${meta.uid}">×œ×—×¥ ×¢×œ ×”×›×¤×ª×•×¨ ×›×“×™ ×œ×˜×¢×•×Ÿ ××ª ×”×’×¨×£.</div>
            <div class="vc-chart-wrapper">
              <canvas id="vc-canvas-${meta.uid}" height="180"></canvas>
            </div>
          </div>
        </td>
      </tr>
    `;
  }

  function renderAlertsTable(alerts, total, page, perPage) {
    const body = document.querySelector('#alertsTable tbody');
    if (!body) return;
    Object.values(visualContextStore).forEach(entry => {
      if (entry && entry.chart && typeof entry.chart.destroy === 'function') {
        try {
          entry.chart.destroy();
        } catch (err) {
          console.debug('visual_context_chart_destroy_failed', err);
        }
      }
    });
    Object.keys(visualContextStore).forEach(key => delete visualContextStore[key]);
    if (!alerts || !alerts.length) {
      body.innerHTML = '<tr><td colspan="8">×œ× × ××¦××• ×”×ª×¨××•×ª ×‘×˜×•×•×— ×©× ×‘×—×¨</td></tr>';
      return;
    }
    const rows = [];
    alerts.forEach(alert => {
      const meta = alert.metadata || {};
      const metaItems = Object.keys(meta)
        .slice(0, 3)
        .map(key => `<span>${key}: ${meta[key]}</span>`)
        .join('');
      rows.push(`
        <tr data-timestamp="${alert.timestamp || ''}" data-alert-uid="${alert.alert_uid || ''}" class="alert-row">
          <td>${formatTimestamp(alert.timestamp)}</td>
          <td>${alert.name || '-'}</td>
          <td><span class="status-pill ${severityClass(alert.severity)}">${alert.severity || '-'}</span></td>
          <td>${alert.summary || '-'}</td>
          <td><div class="meta-list">${metaItems || ''}</div></td>
          <td>${renderGraphCell(alert)}</td>
          <td>${renderQuickFixCell(alert)}</td>
          <td>${renderStoryCell(alert)}</td>
        </tr>
      `);
      const graphRow = renderGraphRow(alert);
      if (graphRow) {
        rows.push(graphRow);
      }
    });
    body.innerHTML = rows.join('');

    const totalPages = Math.max(1, Math.ceil((total || 0) / perPage));
    const label = document.getElementById('pageLabel');
    if (label) label.textContent = `×¢××•×“ ${page} ××ª×•×š ${totalPages}`;
    const prevBtn = document.getElementById('prevPageBtn');
    const nextBtn = document.getElementById('nextPageBtn');
    if (prevBtn) prevBtn.disabled = page <= 1;
    if (nextBtn) nextBtn.disabled = page >= totalPages;
    initQuickFixHandlers();
    initStoryHandlers();
    initVisualContextHandlers();
    highlightFocusedRow();
  }

  function renderQuickFixCell(alert) {
    const fixes = alert.quick_fixes || [];
    if (!fixes.length) {
      return '<span style="opacity:0.5;">â€”</span>';
    }
    return `
      <div class="quick-fix-list">
        ${fixes.map(fix => {
          const payload = encodeURIComponent(JSON.stringify({
            action: {
              id: fix.id,
              type: fix.type,
              label: fix.label,
              href: fix.href,
              payload: fix.payload,
              safety: fix.safety,
              description: fix.description,
            },
            alert: {
              alert_uid: alert.alert_uid,
              alert_type: alert.alert_type,
              severity: alert.severity,
              timestamp: alert.timestamp,
              summary: alert.summary,
            }
          }));
          const safetyClass = fix.safety ? `safety-${fix.safety}` : '';
          return `<button class="quick-fix-action ${safetyClass}" data-qf="${payload}">${fix.label || '×¤×¢×•×œ×”'}</button>`;
        }).join('')}
      </div>
    `;
  }

  function renderStoryCell(alert) {
    const payload = encodeURIComponent(JSON.stringify({
      alert_uid: alert.alert_uid,
      name: alert.name,
      severity: alert.severity,
      summary: alert.summary,
      timestamp: alert.timestamp,
      metadata: alert.metadata || {},
      graph: alert.graph || null,
      story: alert.story || null,
    }));
    const hasStory = Boolean(alert.story && alert.story.story_id);
    const badgeText = hasStory
      ? `×¢×•×“×›×Ÿ ${formatShortTimestamp(alert.story?.updated_at)}`
      : '×˜×¨× × ×©××¨';
    const btnLabel = hasStory ? '×¢×¨×•×š ×¡×™×¤×•×¨' : '×©××•×¨ ×¡×™×¤×•×¨';
    const btnClass = hasStory ? 'story-btn has-story' : 'story-btn';
    return `
      <div class="story-cell">
        <button class="${btnClass}" data-story="${payload}">${btnLabel}</button>
        <span class="story-badge">${badgeText}</span>
      </div>
    `;
  }

  function initVisualContextHandlers() {
    document.querySelectorAll('.graph-toggle-btn').forEach(btn => {
      if (btn.dataset.graphBound === '1') return;
      btn.dataset.graphBound = '1';
      btn.addEventListener('click', () => {
        const meta = parseGraphMeta(btn.dataset.graph);
        if (!meta) return;
        toggleVisualContext(meta);
      });
    });
    document.querySelectorAll('.visual-context-panel').forEach(panel => {
      if (panel.dataset.vcBound === '1') return;
      panel.dataset.vcBound = '1';
      const meta = parseGraphMeta(panel.dataset.graph);
      if (!meta) return;
      const rangeButtons = panel.querySelectorAll('.vc-range-btn');
      rangeButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          rangeButtons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          const minutes = minutesFromPreset(btn.dataset.range);
          loadVisualContext(meta, { minutes });
        });
      });
      panel.querySelectorAll('.vc-zoom-btn').forEach(btn => {
        btn.addEventListener('click', () => handleVisualZoom(meta, btn.dataset.zoom));
      });
    });
  }

  function parseGraphMeta(payload) {
    if (!payload) return null;
    try {
      return JSON.parse(decodeURIComponent(payload));
    } catch (err) {
      console.warn('visual context parse failed', err);
      return null;
    }
  }

  function toggleVisualContext(meta) {
    if (!meta || !meta.uid) return;
    const row = document.getElementById(`visual-row-${meta.uid}`);
    if (!row) return;
    const isOpen = row.classList.contains('open');
    if (isOpen) {
      row.classList.remove('open');
      row.hidden = true;
      setToggleActive(meta.uid, false);
      return;
    }
    ensureVisualState(meta);
    row.hidden = false;
    row.classList.add('open');
    setToggleActive(meta.uid, true);
    if (!row.dataset.loaded) {
      row.dataset.loaded = '1';
      selectDefaultPreset(meta);
    }
  }

  function setToggleActive(uid, isOpen) {
    document.querySelectorAll(`.graph-toggle-btn[data-alert-uid="${uid}"]`).forEach(btn => {
      btn.classList.toggle('active', isOpen);
      btn.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
      btn.textContent = isOpen ? '×”×¡×ª×¨ ×’×¨×£' : 'ğŸ“ˆ ×”×§×©×¨';
    });
  }

  function ensureVisualState(meta) {
    if (!meta || !meta.uid) return null;
    const defaultMinutes = Math.max(5, Number(meta.defaultMinutes || 60));
    if (!visualContextStore[meta.uid]) {
      visualContextStore[meta.uid] = {
        meta,
        minutes: defaultMinutes,
        chart: null,
      };
    } else {
      visualContextStore[meta.uid].meta = meta;
      if (!visualContextStore[meta.uid].minutes) {
        visualContextStore[meta.uid].minutes = defaultMinutes;
      }
    }
    return visualContextStore[meta.uid];
  }

  function selectDefaultPreset(meta) {
    const row = document.getElementById(`visual-row-${meta.uid}`);
    if (!row) return;
    const panel = row.querySelector('.visual-context-panel');
    if (!panel) return;
    const rangeButtons = panel.querySelectorAll('.vc-range-btn');
    let matched = false;
    const targetRange = (meta.defaultRange || '').toLowerCase();
    rangeButtons.forEach(btn => {
      const isMatch = btn.dataset.range && btn.dataset.range.toLowerCase() === targetRange;
      btn.classList.toggle('active', isMatch);
      if (isMatch && !matched) {
        matched = true;
        loadVisualContext(meta, { minutes: minutesFromPreset(btn.dataset.range) });
      }
    });
    if (!matched) {
      rangeButtons.forEach(btn => btn.classList.remove('active'));
      loadVisualContext(meta, { minutes: meta.defaultMinutes || 60 });
    }
  }

  function minutesFromPreset(label) {
    if (!label) return 60;
    const text = String(label).trim().toLowerCase();
    const match = text.match(/^(\d+)([mhd])$/);
    if (!match) return 60;
    const value = Number(match[1]);
    const unit = match[2];
    if (unit === 'm') return value;
    if (unit === 'h') return value * 60;
    if (unit === 'd') return value * 1440;
    return value;
  }

  function handleVisualZoom(meta, direction) {
    const entry = ensureVisualState(meta);
    if (!entry) return;
    const factor = direction === 'in' ? 0.5 : 2;
    entry.minutes = clampMinutes(entry.minutes * factor);
    clearPresetSelection(meta.uid);
    loadVisualContext(meta, { minutes: entry.minutes });
  }

  function clampMinutes(value) {
    return Math.min(14 * 24 * 60, Math.max(5, Math.round(value)));
  }

  function clearPresetSelection(uid) {
    const row = document.getElementById(`visual-row-${uid}`);
    if (!row) return;
    row.querySelectorAll('.vc-range-btn').forEach(btn => btn.classList.remove('active'));
  }

  function buildWindowAroundAlert(meta, minutes) {
    const ts = Date.parse(meta.timestamp || '');
    if (Number.isNaN(ts)) {
      return null;
    }
    const totalMinutes = Math.max(5, Number(minutes || meta.defaultMinutes || 60));
    const halfMs = (totalMinutes * 60000) / 2;
    return {
      start: new Date(ts - halfMs),
      end: new Date(ts + halfMs),
      totalMinutes,
    };
  }

  function pickGranularityLabel(totalMinutes) {
    if (totalMinutes <= 30) return '1m';
    if (totalMinutes <= 120) return '5m';
    if (totalMinutes <= 360) return '15m';
    if (totalMinutes <= 720) return '30m';
    if (totalMinutes <= 1440) return '1h';
    if (totalMinutes <= 2880) return '2h';
    if (totalMinutes <= 4320) return '3h';
    if (totalMinutes <= 10080) return '6h';
    return '12h';
  }

  function setVisualStatus(uid, text, isError = false) {
    const statusEl = document.getElementById(`vc-status-${uid}`);
    if (!statusEl) return;
    statusEl.textContent = text;
    statusEl.classList.toggle('error', Boolean(isError));
  }

  async function loadVisualContext(meta, options = {}) {
    const entry = ensureVisualState(meta);
    if (!entry) return;
    if (options.minutes) {
      entry.minutes = clampMinutes(options.minutes);
    }
    const windowInfo = buildWindowAroundAlert(meta, entry.minutes);
    if (!windowInfo) {
      setVisualStatus(meta.uid, '×œ× × ×™×ª×Ÿ ×œ×—×©×‘ ×˜×•×•×— ×–××Ÿ ×¢×‘×•×¨ ×”×”×ª×¨××”', true);
      return;
    }
    const granularity = pickGranularityLabel(windowInfo.totalMinutes);
    const params = new URLSearchParams({
      metric: meta.metric,
      granularity,
      timerange: 'custom',
      start_time: windowInfo.start.toISOString(),
      end_time: windowInfo.end.toISOString(),
    });
    const cacheKey = `${meta.uid}|${meta.metric}|${granularity}|${windowInfo.start.toISOString()}|${windowInfo.end.toISOString()}`;
    try {
      setVisualStatus(meta.uid, '×˜×•×¢×Ÿ × ×ª×•× ×™×â€¦');
      let payload = visualContextCache[cacheKey];
      if (!payload) {
        payload = await fetchJson(`/api/observability/timeseries?${params.toString()}`);
        if (!payload || payload.ok === false) {
          throw new Error(payload?.error || 'visual_context_error');
        }
        visualContextCache[cacheKey] = payload;
      }
      const rendered = renderVisualChart(meta, payload.data || []);
      if (rendered) {
        const label = formatVisualWindowLabel(windowInfo.start, windowInfo.end);
        setVisualStatus(meta.uid, `×˜×•×•×— ${label}`);
      }
    } catch (err) {
      console.error('visual_context_load_failed', err);
      setVisualStatus(meta.uid, '×œ× × ××¦××• × ×ª×•× ×™× ×œ×’×¨×£ ×”×–×”', true);
    }
  }

  function formatVisualWindowLabel(start, end) {
    const startLabel = formatJerusalemDate(start);
    const endLabel = formatJerusalemDate(end);
    if (startLabel === 'â€”' || endLabel === 'â€”') {
      return `${start?.toISOString?.() || ''} â†’ ${end?.toISOString?.() || ''}`;
    }
    return `${startLabel} â†’ ${endLabel}`;
  }

  function renderVisualChart(meta, rows) {
    const entry = ensureVisualState(meta);
    if (!entry) return false;
    const canvas = document.getElementById(`vc-canvas-${meta.uid}`);
    if (!canvas) return false;
    const points = (rows || [])
      .map(row => {
        const ts = row.timestamp || row.time || row.ts;
        const value = resolveSeriesValue(meta.metric, row);
        return {
          ts,
          value,
        };
      })
      .filter(pt => pt.ts && Number.isFinite(pt.value));
    if (!points.length) {
      setVisualStatus(meta.uid, '××™×Ÿ × ×ª×•× ×™× ×–××™× ×™× ×‘×—×œ×•×Ÿ ×”× ×‘×—×¨', true);
      if (entry.chart) {
        entry.chart.destroy();
        entry.chart = null;
      }
      return false;
    }
    const labels = points.map(point => {
      const label = formatJerusalemDate(point.ts);
      return label === 'â€”' ? String(point.ts ?? '') : label;
    });
    const values = points.map(point => Number(point.value));
    if (entry.chart) {
      entry.chart.destroy();
    }
    entry.chart = new Chart(canvas, {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: meta.label || meta.metric,
            data: values,
            borderColor: getVisualColor(meta.metric),
            backgroundColor: 'rgba(100,255,218,0.15)',
            pointRadius: 0,
            tension: 0.25,
            fill: false,
          },
        ],
      },
      options: {
        plugins: {
          legend: { labels: { color: '#fff' } },
        },
        scales: {
          x: { ticks: { color: '#ccc' }, grid: { color: 'rgba(255,255,255,0.08)' } },
          y: {
            ticks: { color: '#ccc' },
            grid: { color: 'rgba(255,255,255,0.08)' },
            beginAtZero: false,
          },
        },
      },
    });
    return true;
  }

  function getVisualColor(metric) {
    const key = String(metric || '').toLowerCase();
    if (key.includes('cpu')) return '#ffa34f';
    if (key.includes('memory')) return '#64ffda';
    if (key.includes('latency') || key.includes('response')) return '#36a2eb';
    if (key.includes('error')) return '#ff6384';
    if (key.includes('disk')) return '#a78bfa';
    if (key.includes('request')) return '#fcd177';
    return '#4dd0e1';
  }

  function resolveSeriesValue(metric, row) {
    if (!row || typeof row !== 'object') return 0;
    if (row.value != null && row.value !== '') return Number(row.value);
    const metricKey = String(metric || '').toLowerCase();
    if ((metricKey.includes('latency') || metricKey.includes('response')) && row.avg_duration != null) {
      return Number(row.avg_duration);
    }
    if (metricKey.includes('error')) {
      if (row.error_rate != null) return Number(row.error_rate);
      if (row.errors != null && row.count) {
        const count = Number(row.count) || 1;
        return (Number(row.errors) / count) * 100;
      }
    }
    if (metricKey.includes('request')) {
      if (row.requests_per_minute != null) return Number(row.requests_per_minute);
      if (row.count != null) return Number(row.count);
    }
    if (row.avg_duration != null) return Number(row.avg_duration);
    if (row.max_duration != null) return Number(row.max_duration);
    if (row.total != null) return Number(row.total);
    if (row.count != null) return Number(row.count);
    const firstNumeric = Object.values(row).find(val => typeof val === 'number');
    return Number(firstNumeric || 0);
  }

  function initQuickFixHandlers() {
    document.querySelectorAll('.quick-fix-action').forEach(btn => {
      if (btn.dataset.qfBound === '1') return;
      btn.dataset.qfBound = '1';
      btn.addEventListener('click', async () => {
        const payload = btn.dataset.qf;
        if (!payload) return;
        let meta;
        try {
          meta = JSON.parse(decodeURIComponent(payload));
        } catch (err) {
          console.warn('quick fix parse failed', err);
          return;
        }
        await handleQuickFixAction(meta.action || {}, meta.alert || {}, btn);
      });
    });
  }

  function initStoryHandlers() {
    document.querySelectorAll('.story-btn').forEach(btn => {
      if (btn.dataset.storyBound === '1') return;
      btn.dataset.storyBound = '1';
      btn.addEventListener('click', () => {
        const payload = btn.dataset.story;
        if (!payload) return;
        try {
          const meta = JSON.parse(decodeURIComponent(payload));
          openStoryModal(meta);
        } catch (err) {
          console.warn('story payload parse failed', err);
        }
      });
    });
  }

  async function openStoryModal(alertMeta, options = {}) {
    if (!alertMeta) return;
    storyState.alert = alertMeta;
    storyState.template = null;
    storyState.story = options.prefetchedStory || null;
    setStoryStatus('×˜×•×¢×Ÿ × ×ª×•× ×™×â€¦', false);
    if (storyModal) storyModal.hidden = false;
    try {
      if (!storyState.story && alertMeta.story && alertMeta.story.story_id) {
        storyState.story = await fetchStoryById(alertMeta.story.story_id);
      }
      if (!options.template) {
        const templatePayload = await fetch('/api/observability/story/template', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            alert: alertMeta,
            timerange: state.range,
          }),
        });
        if (!templatePayload.ok) throw new Error('template_failed');
        const templateJson = await templatePayload.json();
        if (templateJson.ok === false) throw new Error(templateJson.error || 'template_failed');
        storyState.template = templateJson.story || null;
      } else {
        storyState.template = options.template;
      }
      populateStoryForm();
      setStoryStatus(storyState.story ? '× ×¢×¨×š ×¡×™×¤×•×¨ ×§×™×™×' : '×˜×™×•×˜×” ×—×“×©×”', false);
    } catch (err) {
      console.error('story_template_failed', err);
      setStoryStatus('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×¡×™×¤×•×¨', true);
    }
  }

  function closeStoryModal() {
    if (storyModal) storyModal.hidden = true;
    storyState.alert = null;
  }

  async function fetchStoryById(storyId) {
    const res = await fetch(`/api/observability/stories/${storyId}`);
    if (!res.ok) return null;
    const data = await res.json();
    if (data.ok === false) return null;
    return data.story || null;
  }

  function populateStoryForm() {
    const template = storyState.template || {};
    const existing = storyState.story || {};
    const windowData = existing.time_window || template.time_window || {};
    if (storyFormEls.title) {
      storyFormEls.title.textContent = `ğŸ“– ×¡×™×¤×•×¨: ${template.alert_name || existing.alert_name || storyState.alert?.name || '××™×¨×•×¢'}`;
    }
    if (storyFormEls.start) storyFormEls.start.value = toLocalInput(windowData.start || template.time_window?.start);
    if (storyFormEls.end) storyFormEls.end.value = toLocalInput(windowData.end || template.time_window?.end);
    const alertTimestamp = storyState.alert?.timestamp;
    if (storyFormEls.start && !storyFormEls.start.value && alertTimestamp) {
      storyFormEls.start.value = toLocalInput(alertTimestamp);
    }
    const whatSaw = existing.what_we_saw || template.what_we_saw || {};
    if (storyFormEls.whatSaw) storyFormEls.whatSaw.value = whatSaw.description || '';
    const whatDid = existing.what_we_did || template.what_we_did || {};
    if (storyFormEls.whatDid) storyFormEls.whatDid.value = whatDid.manual_notes || '';
    const logs = existing.logs || template.logs || [];
    if (storyFormEls.logs) storyFormEls.logs.value = logs.map(entry => {
      const prefix = entry.source ? `${entry.source}: ` : '';
      return `${prefix}${entry.content || ''}`.trim();
    }).filter(Boolean).join('\n');
    if (storyFormEls.insights) storyFormEls.insights.value = existing.insights || template.insights || '';
    const autoActions = template.what_we_did?.auto_actions || [];
    if (storyFormEls.autoList) {
      storyFormEls.autoList.innerHTML = autoActions.length
        ? autoActions.map(action => `<li>${action.label || '×¤×¢×•×œ×”'} (${formatShortTimestamp(action.timestamp)})</li>`).join('')
        : '<li style="opacity:0.6;">×œ× × ××¦××• ×¤×¢×•×œ×•×ª ××•×˜×•××˜×™×•×ª</li>';
    }
    const graphMeta = template.what_we_saw?.graph_snapshot || {};
    if (storyFormEls.graphMeta) {
      if (graphMeta.metric) {
        storyFormEls.graphMeta.innerHTML = `
          ××“×“: <strong>${graphMeta.label || graphMeta.metric}</strong><br>
          ×“×’×™××•×ª: ${Array.isArray(graphMeta.series) ? graphMeta.series.length : 0}<br>
          ×˜×•×•×— (×“×§×•×ª): ${graphMeta.range_minutes || 'â€”'}
        `;
      } else {
        storyFormEls.graphMeta.textContent = '×œ× ×–××™×Ÿ snapshot ×¢×‘×•×¨ ×’×¨×£ ×–×”';
      }
    }
  }

  function toLocalInput(isoValue) {
    if (!isoValue) return '';
    const date = new Date(isoValue);
    if (Number.isNaN(date.getTime())) return '';
    const pad = (num) => String(num).padStart(2, '0');
    return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
  }

  function fromLocalInput(value) {
    if (!value) return null;
    const date = new Date(value);
    if (Number.isNaN(date.getTime())) return null;
    return date.toISOString();
  }

  function buildLogsFromText(text) {
    if (!text) return [];
    return text.split('\n').map(line => line.trim()).filter(Boolean).map(line => {
      const parts = line.split(':');
      if (parts.length > 1) {
        const source = parts.shift();
        return { source: source?.trim() || 'log', content: parts.join(':').trim() };
      }
      return { source: 'log', content: line };
    });
  }

  function setStoryStatus(text, isError) {
    if (!storyFormEls.status) return;
    storyFormEls.status.textContent = text || '';
    storyFormEls.status.style.color = isError ? '#ff627c' : '#9efff0';
  }

  function buildStoryPayload(options = {}) {
    const template = storyState.template || {};
    const alertMeta = storyState.alert || {};
    const startIso = fromLocalInput(storyFormEls.start?.value);
    const endIso = fromLocalInput(storyFormEls.end?.value);
    if (!options.allowPartial && (!startIso || !endIso)) {
      throw new Error('×™×© ×œ×”×–×™×Ÿ ×˜×•×•×— ×–××Ÿ ×œ×¡×™×¤×•×¨');
    }
    const payload = {
      story_id: storyState.story?.story_id,
      alert_uid: template.alert_uid || alertMeta.alert_uid,
      alert_name: template.alert_name || alertMeta.name,
      alert_timestamp: template.alert_timestamp || alertMeta.timestamp,
      summary: template.summary || alertMeta.summary,
      metadata: template.metadata || alertMeta.metadata || {},
      severity: template.severity || alertMeta.severity,
      time_window: {
        start: startIso,
        end: endIso,
        label: template.time_window?.label || '',
      },
      what_we_saw: {
        description: storyFormEls.whatSaw?.value?.trim() || '',
        graph_snapshot: template.what_we_saw?.graph_snapshot || storyState.story?.what_we_saw?.graph_snapshot || null,
      },
      what_we_did: {
        auto_actions: template.what_we_did?.auto_actions || [],
        manual_notes: storyFormEls.whatDid?.value?.trim() || '',
      },
      logs: buildLogsFromText(storyFormEls.logs?.value || ''),
      insights: storyFormEls.insights?.value?.trim() || '',
    };
    return payload;
  }

  async function saveStoryFromModal() {
    try {
      if (storyButtons.save) storyButtons.save.disabled = true;
      setStoryStatus('×©×•××¨â€¦', false);
      const payload = buildStoryPayload();
      const res = await fetch('/api/observability/stories', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload),
      });
      if (!res.ok) throw new Error('save_failed');
      const data = await res.json();
      if (data.ok === false) throw new Error(data.error || data.detail || 'save_failed');
      storyState.story = data.story;
      setStoryStatus('× ×©××¨ ×‘×”×¦×œ×—×”', false);
      showToast('×”×¡×™×¤×•×¨ × ×©××¨');
      refreshHistory().catch(() => {});
    } catch (err) {
      console.error('story_save_failed', err);
      setStoryStatus('×©×’×™××” ×‘×©××™×¨×ª ×”×¡×™×¤×•×¨', true);
      showToast('×©××™×¨×” × ×›×©×œ×”');
    } finally {
      if (storyButtons.save) storyButtons.save.disabled = false;
    }
  }

  function suggestStoryFileName(payload) {
    const base =
      payload.alert_name ||
      payload.alert_uid ||
      storyState.alert?.name ||
      storyState.alert?.alert_uid ||
      'incident_story';
    const normalized = String(base || 'incident_story').trim().replace(/\s+/g, '_');
    const sanitized = normalized.replace(/[^A-Za-z0-9_\-.\u0590-\u05FF]/g, '') || 'incident_story';
    const suffix = storyState.story?.story_id || storyState.alert?.alert_uid || Date.now().toString();
    const candidate = `${sanitized}_${suffix}`.replace(/__+/g, '_');
    return candidate.toLowerCase().endsWith('.md') ? candidate : `${candidate}.md`;
  }

  async function saveStoryMarkdownToWebapp() {
    const payload = buildStoryPayload({ allowPartial: true });
    const suggestedName = suggestStoryFileName(payload);
    const userInput = window.prompt('×©× ×§×•×‘×¥ ×œ×©××™×¨×ª Markdown', suggestedName);
    if (userInput === null) {
      setStoryStatus('×©××™×¨×ª Markdown ×‘×•×˜×œ×”', false);
      return;
    }
    const trimmed = userInput.trim();
    if (!trimmed) {
      setStoryStatus('×™×© ×œ×”×–×™×Ÿ ×©× ×§×•×‘×¥ ×œ×©××™×¨×”', true);
      showToast('×©× ×§×•×‘×¥ ××™× ×• ×ª×§×™×Ÿ');
      return;
    }
    const finalName = trimmed.toLowerCase().endsWith('.md') ? trimmed : `${trimmed}.md`;
    try {
      if (storyButtons.saveMarkdown) storyButtons.saveMarkdown.disabled = true;
      setStoryStatus('×©×•××¨ ×§×•×‘×¥ Markdown...', false);
      const res = await fetch('/api/observability/stories/save_markdown', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ file_name: finalName, story: payload }),
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok || data.ok === false) {
        throw new Error(data.error || data.detail || 'save_failed');
      }
      setStoryStatus(`×§×•×‘×¥ × ×©××¨ ×‘×©× ${data.file_name}`, false);
      showToast('×”×§×•×‘×¥ × ×©××¨ ×‘×¡×¤×¨×™×™×ª ×”×§×‘×¦×™×');
    } catch (err) {
      console.error('story_markdown_save_failed', err);
      setStoryStatus('×©××™×¨×ª ×§×•×‘×¥ Markdown × ×›×©×œ×”', true);
      showToast('×©××™×¨×ª Markdown × ×›×©×œ×”');
    } finally {
      if (storyButtons.saveMarkdown) storyButtons.saveMarkdown.disabled = false;
    }
  }

  function downloadStoryPdf() {
    try {
      const payload = buildStoryPayload({ allowPartial: true });
      const html = `
        <html>
          <head>
            <title>Incident Story</title>
            <style>
              body { font-family: sans-serif; padding: 1.5rem; }
              h1 { border-bottom: 1px solid #ccc; padding-bottom: 0.5rem; }
              section { margin-bottom: 1rem; }
            </style>
          </head>
          <body>
            <h1>${payload.alert_name || payload.alert_uid}</h1>
            <section><strong>Alert UID:</strong> ${payload.alert_uid}</section>
            <section><strong>Time Window:</strong> ${payload.time_window.start || ''} â†’ ${payload.time_window.end || ''}</section>
            <section><strong>Severity:</strong> ${payload.severity || 'n/a'}</section>
            <section>
              <h3>××” ×¨××™× ×•</h3>
              <p>${payload.what_we_saw.description || ''}</p>
            </section>
            <section>
              <h3>××” ×¢×©×™× ×•</h3>
              <p>${payload.what_we_did.manual_notes || 'â€”'}</p>
            </section>
            <section>
              <h3>×œ×•×’×™×</h3>
              <ul>${payload.logs.map(log => `<li>${log.source || 'log'}: ${log.content || ''}</li>`).join('')}</ul>
            </section>
            <section>
              <h3>×ª×•×‘× ×•×ª</h3>
              <p>${payload.insights || 'â€”'}</p>
            </section>
          </body>
        </html>
      `;
      const win = window.open('', '_blank');
      if (!win) {
        showToast('×¤×ª×— ×—×œ×•×Ÿ ×¤×•×¤××¤ ×œ×¦×•×¨×š PDF');
        return;
      }
      win.document.write(html);
      win.document.close();
      setTimeout(() => {
        try {
          win.print();
        } catch (err) {
          console.error('pdf_print_failed', err);
        }
      }, 400);
    } catch (err) {
      console.error('pdf_export_failed', err);
      showToast('×™×™×¦×•× PDF × ×›×©×œ');
    }
  }

  async function maybeOpenPendingStory() {
    if (!state.pendingStoryId) return;
    const targetId = state.pendingStoryId;
    const match = (state.alerts || []).find(alert => alert.story && alert.story.story_id === targetId);
    state.pendingStoryId = '';
    if (match) {
      openStoryModal(match, { prefetchedStory: match.story });
      return;
    }
    try {
      const existing = await fetchStoryById(targetId);
      if (!existing) return;
      const graphMeta = existing.what_we_saw?.graph_snapshot;
      const fallbackAlert = {
        alert_uid: existing.alert_uid,
        name: existing.alert_name,
        severity: existing.severity,
        summary: existing.summary,
        timestamp: existing.alert_timestamp,
        metadata: existing.metadata || {},
        graph: graphMeta
          ? {
              metric: graphMeta.metric,
              label: graphMeta.label,
              unit: graphMeta.unit,
              default_range: graphMeta.meta?.default_range,
              default_minutes: graphMeta.range_minutes,
              category: graphMeta.meta?.category,
            }
          : null,
        story: existing,
      };
      openStoryModal(fallbackAlert, { prefetchedStory: existing });
    } catch (err) {
      console.error('pending_story_load_failed', err);
    }
  }

  async function handleQuickFixAction(action, alertMeta, btn) {
    if (!action || !action.id) return;
    try {
      if (btn) btn.disabled = true;
      const kind = (action.type || '').toLowerCase();
      if (kind === 'copy' && action.payload) {
        await navigator.clipboard.writeText(action.payload);
        showToast('×”×¤×§×•×“×” ×”×•×¢×ª×§×” ×œ×œ×•×—');
      } else if (action.href) {
        window.open(action.href, '_blank', 'noopener');
      }
      await trackQuickFixAction(action, alertMeta);
    } catch (err) {
      console.error('quick fix failed', err);
      showToast('×©×’×™××” ×‘×‘×™×¦×•×¢ ×”×¤×¢×•×œ×”');
    } finally {
      if (btn) btn.disabled = false;
    }
  }

  async function trackQuickFixAction(action, alertMeta) {
    try {
      await fetch('/api/observability/quickfix/track', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          action_id: action.id,
          action_label: action.label,
          alert: alertMeta,
        }),
      });
    } catch (err) {
      console.debug('quick fix telemetry skipped', err);
    }
  }

  function showToast(text) {
    const toast = document.createElement('div');
    toast.textContent = text;
    toast.style.position = 'fixed';
    toast.style.bottom = '24px';
    toast.style.left = '50%';
    toast.style.transform = 'translateX(-50%)';
    toast.style.background = 'rgba(0,0,0,0.75)';
    toast.style.color = '#fff';
    toast.style.padding = '0.5rem 1rem';
    toast.style.borderRadius = '999px';
    toast.style.zIndex = '999';
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2000);
  }

  function highlightFocusedRow() {
    if (!state.focusTs) return;
    const rows = document.querySelectorAll('#alertsTable tbody tr');
    let target = null;
    const focusMs = Date.parse(state.focusTs);
    rows.forEach(row => {
      const ts = row.dataset.timestamp;
      if (!ts) return;
      const rowMs = Date.parse(ts);
      if (!Number.isNaN(focusMs) && !Number.isNaN(rowMs)) {
        if (Math.abs(rowMs - focusMs) <= 5 * 60 * 1000 && !target) {
          target = row;
        }
      } else if (!target && ts.startsWith(state.focusTs)) {
        target = row;
      }
    });
    if (target) {
      target.classList.add('highlight-row');
      target.scrollIntoView({behavior: 'smooth', block: 'center'});
      state.focusTs = '';
    }
  }

  async function refreshAggregations() {
    const params = new URLSearchParams({ timerange: state.range, limit: '5' });
    const data = await fetchJson('/api/observability/aggregations?' + params.toString());
    if (!data.ok) throw new Error(data.error || 'aggregation_error');
    updateCards(data.summary, data.deployment_correlation);
    renderTopEndpoints(data.top_slow_endpoints || []);
  }

  async function refreshTimeseries() {
    const granularity = getGranularity();
    const baseParams = `timerange=${state.range}&granularity=${granularity}`;
    const alertsData = await fetchJson(`/api/observability/timeseries?${baseParams}&metric=alerts_count`);
    if (alertsData.ok !== false) {
      renderAlertsChart(alertsData.data || []);
    }
    const responseData = await fetchJson(`/api/observability/timeseries?${baseParams}&metric=response_time`);
    if (responseData.ok !== false) {
      renderResponseChart(responseData.data || []);
    }
  }

  async function refreshHistory() {
    const params = new URLSearchParams({
      timerange: state.range,
      severity: state.severity === 'all' ? '' : state.severity,
      alert_type: state.type === 'all' ? '' : state.type,
      endpoint: state.endpoint || '',
      search: state.search || '',
      page: String(state.page),
      per_page: String(state.perPage),
    });
    const data = await fetchJson('/api/observability/alerts?' + params.toString());
    if (!data.ok) throw new Error(data.error || 'alerts_error');
    state.alerts = data.alerts || [];
    renderAlertsTable(state.alerts, data.total || 0, data.page || 1, data.per_page || state.perPage);
    await maybeOpenPendingStory();
  }

  async function refreshAll() {
    try {
      updateLastUpdated();
      await Promise.all([refreshAggregations(), refreshTimeseries(), refreshHistory()]);
    } catch (err) {
      console.error('Observability dashboard error:', err);
    }
  }

  function initRangeButtons() {
    document.querySelectorAll('#rangeButtons .range-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('#rangeButtons .range-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        state.range = btn.dataset.range || '24h';
        state.page = 1;
        refreshAll();
      });
    });
  }

  function initFilters() {
    const severitySelect = document.getElementById('severityFilter');
    const typeSelect = document.getElementById('typeFilter');
    const endpointInput = document.getElementById('endpointFilter');
    const searchInput = document.getElementById('searchFilter');
    if (severitySelect) severitySelect.addEventListener('change', () => { state.severity = severitySelect.value; state.page = 1; refreshHistory(); });
    if (typeSelect) typeSelect.addEventListener('change', () => { state.type = typeSelect.value; state.page = 1; refreshHistory(); });
    if (endpointInput) endpointInput.addEventListener('change', () => { state.endpoint = endpointInput.value.trim(); state.page = 1; refreshHistory(); });
    if (searchInput) {
      let timer;
      searchInput.addEventListener('input', () => {
        clearTimeout(timer);
        timer = setTimeout(() => {
          state.search = searchInput.value.trim();
          state.page = 1;
          refreshHistory();
        }, 350);
      });
    }
    const prevBtn = document.getElementById('prevPageBtn');
    const nextBtn = document.getElementById('nextPageBtn');
    if (prevBtn) prevBtn.addEventListener('click', () => {
      if (state.page > 1) {
        state.page -= 1;
        refreshHistory();
      }
    });
    if (nextBtn) nextBtn.addEventListener('click', () => {
      state.page += 1;
      refreshHistory();
    });
  }

  function initExportButton() {
    const btn = document.getElementById('exportJsonBtn');
    if (!btn) return;
    btn.addEventListener('click', async () => {
      btn.disabled = true;
      try {
        const params = new URLSearchParams({timerange: state.range});
        const res = await fetch(`/api/observability/export?${params.toString()}`, {headers: {'Accept': 'application/json'}});
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const payload = await res.json();
        payload.requested_range = state.range;
        const blob = new Blob([JSON.stringify(payload, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        const ts = new Date().toISOString().replace(/[:.]/g, '-');
        link.href = url;
        link.download = `observability_snapshot_${ts}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        showToast('×§×•×‘×¥ JSON ×™×¨×“ ×‘×”×¦×œ×—×”');
      } catch (err) {
        console.error('export failed', err);
        showToast('×©×’×™××” ×‘×™×¦×•×');
      } finally {
        btn.disabled = false;
      }
    });
  }

  function initReplayButton() {
    const btn = document.getElementById('openReplayBtn');
    if (!btn) return;
    btn.addEventListener('click', () => {
      const params = new URLSearchParams({timerange: state.range});
      window.open(`/admin/observability/replay?${params.toString()}`, '_blank', 'noopener');
    });
  }

  if (storyButtons.save) storyButtons.save.addEventListener('click', () => saveStoryFromModal());
  if (storyButtons.saveMarkdown) storyButtons.saveMarkdown.addEventListener('click', () => saveStoryMarkdownToWebapp());
  if (storyButtons.downloadPdf) storyButtons.downloadPdf.addEventListener('click', () => downloadStoryPdf());
  if (storyModal) {
    storyModal.addEventListener('click', event => {
      if (event.target === storyModal) {
        closeStoryModal();
      }
    });
    storyModal.querySelectorAll('[data-story-close]').forEach(btn => {
      btn.addEventListener('click', closeStoryModal);
    });
  }

  initRangeButtons();
  initFilters();
  initExportButton();
  initReplayButton();
  refreshAll();
})();
</script>
{% endblock %}
