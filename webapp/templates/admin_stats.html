{% extends "base.html" %}

{% block title %}סטטיסטיקות אדמין{% endblock %}

{% block content %}
<h1 class="page-title">
  <i class="fas fa-chart-line"></i>
  סטטיסטיקות מערכת (מנהלים)
</h1>

{% if error %}
  <div class="alert alert-error" style="margin-bottom:1rem;">{{ error }}</div>
{% endif %}

<div class="metrics-grid" style="display:grid; gap:1rem; grid-template-columns:repeat(auto-fit, minmax(220px,1fr)); margin-bottom:1.5rem;">
  <div class="glass-card metric-card">
    <div class="metric-label">סה"כ משתמשים</div>
    <div class="metric-value">{{ summary.total_users | default(0) }}</div>
  </div>
  <div class="glass-card metric-card">
    <div class="metric-label">פעילים היום</div>
    <div class="metric-value">{{ summary.active_today | default(0) }}</div>
  </div>
  <div class="glass-card metric-card">
    <div class="metric-label">פעילים השבוע</div>
    <div class="metric-value">{{ summary.active_week | default(0) }}</div>
  </div>
  <div class="glass-card metric-card">
    <div class="metric-label">סה"כ פעולות (Top {{ weekly_limit }})</div>
    <div class="metric-value">{{ total_actions | default(0) }}</div>
  </div>
</div>

<p style="opacity:.7; font-size:.9rem; margin-bottom:1.5rem;">
  עודכן לאחרונה: {{ generated_at }}
</p>

<div class="glass-card">
  <h2 class="section-title">משתמשים פעילים ב־7 הימים האחרונים</h2>
  {% if not weekly_users %}
    <div style="opacity:.8;">אין פעילות שנרשמה בשבוע האחרון.</div>
  {% else %}
    <div class="table-responsive" style="overflow:auto; margin-top:1rem;">
      <table class="table" style="width:100%; min-width:480px;">
        <thead>
          <tr>
            <th style="width:60px;">#</th>
            <th>משתמש</th>
            <th style="width:140px;">ימים פעילים</th>
            <th style="width:160px;">סה"כ פעולות</th>
          </tr>
        </thead>
        <tbody>
          {% for entry in weekly_users %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>
                {% set name = entry.username or 'ללא שם' %}
                {% if name.startswith('@') %}
                  {{ name }}
                {% else %}
                  @{{ name }}
                {% endif %}
              </td>
              <td>{{ entry.days | default(0) }}</td>
              <td>{{ entry.total_actions | default(0) }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% if weekly_users|length == weekly_limit %}
      <p style="margin-top:0.75rem; opacity:.7; font-size:.9rem;">
        מוצגים {{ weekly_limit }} המשתמשים הפעילים ביותר. השתמש ב־/stats בבוט לנתונים מלאים.
      </p>
    {% endif %}
  {% endif %}
</div>

<style>
.metric-card {
  padding: 1rem;
  background: rgba(255,255,255,0.05);
  border-radius: 12px;
}
.metric-label {
  font-size: .9rem;
  opacity: .75;
  margin-bottom: .35rem;
}
.metric-value {
  font-size: 2rem;
  font-weight: 600;
}
@media (max-width:600px){
  .metric-value { font-size: 1.5rem; }
}
</style>
{% endblock %}
