{% extends "base.html" %}

{% block title %}ğŸ“ƒ ×¡×¤×¨×™×™×ª ×¡× ×™×¤×˜×™× Â· ×”×•×¡×£ ×¡× ×™×¤×˜{% endblock %}

{% block content %}
<div class="community-header">
  <div class="title">
    <h1>ğŸ“ƒ ×¡×¤×¨×™×™×ª ×¡× ×™×¤×˜×™×</h1>
    <p class="subtitle">×”×•×¡×£ ×¡× ×™×¤×˜ ××©×œ×š ×œ××•×¡×£ ×”×§×”×™×œ×”</p>
  </div>
</div>

<div class="glass-card">
  <form id="snippetForm" class="form-grid" onsubmit="return false;">
    <div class="form-row">
      <label for="title">×›×•×ª×¨×ª ×”×¡× ×™×¤×˜</label>
      <input id="title" name="title" type="text" placeholder="×œ××©×œ: ×§×¨×™××ª ×§×•×‘×¥ JSON" required maxlength="180">
    </div>

    <div class="form-row">
      <label for="description">×ª×™××•×¨ ×§×¦×¨</label>
      <textarea id="description" name="description" rows="3" placeholder="×©×•×¨×”â€‘×©×ª×™×™× ×©××¡×‘×™×¨×•×ª ××” ×”×¡× ×™×¤×˜ ×¢×•×©×”" required maxlength="1000"></textarea>
    </div>

    <div class="form-row">
      <label for="language">×‘×—×™×¨×ª ×©×¤×”</label>
      <select id="language" name="language" required>
        <option value="">â€” ×‘×—×¨/×™ â€”</option>
        <option value="python">Python</option>
        <option value="javascript">JavaScript</option>
        <option value="typescript">TypeScript</option>
        <option value="bash">Bash</option>
        <option value="go">Go</option>
        <option value="java">Java</option>
        <option value="csharp">C#</option>
        <option value="sql">SQL</option>
        <option value="html">HTML</option>
        <option value="css">CSS</option>
        <option value="json">JSON</option>
        <option value="yaml">YAML</option>
        <option value="text">Text</option>
      </select>
    </div>

    <div id="snippetEditorContainer" class="form-row">
      <label for="code">×§×˜×¢ ×”×§×•×“ ×©×œ ×”×¡× ×™×¤×˜</label>
      <textarea id="code" name="code" rows="12" placeholder="# ×”×“×‘×§/×™ ×›××Ÿ ××ª ×§×˜×¢ ×”×§×•×“" required style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', monospace;"></textarea>
    </div>

    <div class="form-actions">
      <button id="submitBtn" class="btn btn-primary" type="submit">×©×œ×—</button>
      <a class="btn btn-secondary" href="/snippets">â†©ï¸ ×—×–×¨×” ×œ×¡×¤×¨×™×™×”</a>
    </div>
  </form>

  <div id="resultOk" class="alert success" style="display:none; margin-top:1rem;">
    âœ… ×”×¡× ×™×¤×˜ ×”×ª×§×‘×œ ×•×××ª×™×Ÿ ×œ××™×©×•×¨ ×× ×”×œ
  </div>
  <div id="resultErr" class="alert error" style="display:none; margin-top:1rem;"></div>
</div>

<style>
.form-grid { display: grid; gap: 1rem; }
.form-row { display: grid; gap: .35rem; }
.form-row > label { opacity: .85; font-weight: 600; }
.form-row > input, .form-row > textarea, .form-row > select {
  padding: .65rem .8rem; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2);
  background: rgba(255,255,255,0.06); color: inherit;
}
.alert.success { background: rgba(16, 185, 129, .15); border: 1px solid rgba(16, 185, 129, .35); padding: .75rem 1rem; border-radius: 10px; }
.alert.error { background: rgba(239, 68, 68, .15); border: 1px solid rgba(239, 68, 68, .35); padding: .75rem 1rem; border-radius: 10px; }
</style>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  const form = document.getElementById('snippetForm');
  const btn = document.getElementById('submitBtn');
  const okEl = document.getElementById('resultOk');
  const errEl = document.getElementById('resultErr');

  // Initialize CodeMirror editor
  document.addEventListener('DOMContentLoaded', async function() {
    try {
      const container = document.getElementById('snippetEditorContainer');
      const languageSelect = document.getElementById('language');
      if (container && window.editorManager && typeof window.editorManager.initEditor === 'function') {
        console.debug('[snippet_submit] Initializing editor with language: text');
        await window.editorManager.initEditor(container, {
          language: 'text',
          value: '',
          theme: 'dark'
        });

        // Update editor language when select changes
        if (languageSelect && window.editorManager && typeof window.editorManager.updateLanguage === 'function') {
          languageSelect.addEventListener('change', async (e) => {
            console.debug('[snippet_submit] Language changed to:', e.target.value);
            try { await window.editorManager.updateLanguage(e.target.value); } catch (err) { console.warn('Failed to update language:', err); }
          });
        }
      } else {
        console.warn('[snippet_submit] EditorManager not available, using plain textarea');
      }
    } catch (err) {
      console.error('[snippet_submit] Failed to initialize editor:', err);
    }
  });

  async function submitSnippet(ev){
    try{
      ev && ev.preventDefault();
      errEl.style.display = 'none'; errEl.textContent = '';
      okEl.style.display = 'none';

      const title = document.getElementById('title').value.trim();
      const description = document.getElementById('description').value.trim();
      const language = document.getElementById('language').value.trim();
      const code = document.getElementById('code').value;
      if (!title || !description || !language || !code.trim()){
        errEl.textContent = '× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª'; errEl.style.display = 'block'; return;
      }
      btn.disabled = true; btn.textContent = '×©×•×œ×—â€¦';
      const res = await fetch('/api/snippets/submit', {
        method: 'POST', credentials: 'same-origin', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, description, language, code })
      });
      const data = await res.json().catch(()=>({ok:false,error:'invalid_response'}));
      if (!res.ok || !data.ok){
        const msg = (data && data.error) ? String(data.error) : '×©×’×™××” ×‘×©×œ×™×—×”';
        throw new Error(msg);
      }
      // Success: redirect to Thank You page
      window.location.href = '/snippets/submit/thanks';
      return;
    }catch(e){
      btn.disabled = false; btn.textContent = '×©×œ×—';
      errEl.textContent = (e && e.message) ? e.message : '×©×’×™××” ×‘×œ×ª×™ ×¦×¤×•×™×”';
      errEl.style.display = 'block';
    }
  }

  if (form) form.addEventListener('submit', submitSnippet);
})();
</script>
{% endblock %}