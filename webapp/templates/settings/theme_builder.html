{% extends "base.html" %}

{% block title %} 注专转 砖 - Code Keeper Bot{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='libs/pickr/nano.min.css') }}?v={{ static_version }}" />
{% endblock %}

{% block content %}
<h1 class="page-title">
    <i class="fas fa-palette"></i>
     注专转 砖
</h1>

<div class="theme-builder-layout">
    <!-- Sidebar: My Themes -->
    <aside class="theme-builder-sidebar glass-card">
        <div class="sidebar-header">
            <h3>
                <i class="fas fa-palette"></i>
                注专转 砖
            </h3>
            <div style="display:flex; gap: 0.5rem; align-items: center;">
                <a href="/settings/theme-gallery" class="btn btn-secondary btn-sm" title="专转 注专转 ">
                    <i class="fas fa-star"></i>
                    专 / 
                </a>
                <button type="button" id="createNewThemeBtn" class="btn btn-primary btn-sm">
                    <i class="fas fa-plus"></i>
                    注专 砖
                </button>
            </div>
        </div>

        <div id="themesList" class="themes-list">
            <!-- 住 转 -->
            <div class="themes-loading">
                <i class="fas fa-spinner fa-spin"></i>
                注...
            </div>
        </div>

        <div class="sidebar-footer">
            <small>
                <span id="themesCount">0</span>/<span id="themesMax">10</span> 注专转
            </small>
        </div>
    </aside>

    <!-- Control Panel -->
    <div class="theme-builder-controls glass-card">
        <form id="themeBuilderForm" autocomplete="off">
            <!-- Theme Name -->
            <div class="control-group">
                <label for="themeName">
                    <i class="fas fa-tag"></i>
                    砖 注专
                </label>
                <input
                    type="text"
                    id="themeName"
                    name="name"
                    maxlength="50"
                    placeholder="注专 砖"
                    aria-describedby="themeNameHelp"
                    required
                />
                <small id="themeNameHelp">注 50 转</small>
            </div>

            <!-- Background Colors -->
            <fieldset class="control-section">
                <legend><i class="fas fa-fill-drip"></i> 专拽注</legend>

                <div class="color-row">
                    <label for="bgPrimary">专拽注 专砖</label>
                    <div class="color-input-wrapper">
                        <input type="text" id="bgPrimaryText" data-var="--bg-primary" class="color-text" />
                        <div id="bgPrimary" class="color-picker" data-var="--bg-primary"></div>
                    </div>
                </div>

                <div class="color-row">
                    <label for="bgSecondary">专拽注 砖</label>
                    <div class="color-input-wrapper">
                        <input type="text" id="bgSecondaryText" data-var="--bg-secondary" class="color-text" />
                        <div id="bgSecondary" class="color-picker" data-var="--bg-secondary"></div>
                    </div>
                </div>

                <div class="color-row">
                    <label for="cardBg">专拽注 专住</label>
                    <div class="color-input-wrapper">
                        <input type="text" id="cardBgText" data-var="--card-bg" class="color-text" />
                        <div id="cardBg" class="color-picker" data-var="--card-bg"></div>
                    </div>
                </div>
            </fieldset>

            <!-- Accent Colors -->
            <fieldset class="control-section">
                <legend><i class="fas fa-star"></i> 爪注 拽住</legend>

                <div class="color-row">
                    <label for="primary">专砖 (Primary)</label>
                    <div class="color-input-wrapper">
                        <input type="text" id="primaryText" data-var="--primary" class="color-text" />
                        <div id="primary" class="color-picker" data-var="--primary"></div>
                    </div>
                </div>

                <div class="color-row">
                    <label for="secondary">砖 (Secondary)</label>
                    <div class="color-input-wrapper">
                        <input type="text" id="secondaryText" data-var="--secondary" class="color-text" />
                        <div id="secondary" class="color-picker" data-var="--secondary"></div>
                    </div>
                </div>
            </fieldset>

            <fieldset class="control-section">
                <legend><i class="fas fa-mouse-pointer"></i> 驻转专 专砖</legend>
                
                <div class="color-row">
                    <label for="btnPrimaryBg">爪注 专拽注</label>
                    <div class="color-input-wrapper">
                        <input type="text" id="btnPrimaryBgText" data-var="--btn-primary-bg" class="color-text" />
                        <div id="btnPrimaryBg" class="color-picker" data-var="--btn-primary-bg"></div>
                    </div>
                </div>

                <div class="color-row">
                    <label for="btnPrimaryColor">爪注 拽住</label>
                    <div class="color-input-wrapper">
                        <input type="text" id="btnPrimaryColorText" data-var="--btn-primary-color" class="color-text" value="#ffffff" />
                        <div id="btnPrimaryColor" class="color-picker" data-var="--btn-primary-color"></div>
                    </div>
                </div>
            </fieldset>

            <!-- Text Colors -->
            <fieldset class="control-section">
                <legend><i class="fas fa-font"></i> 拽住</legend>

                <div class="color-row">
                    <label for="textPrimary">拽住 专砖</label>
                    <div class="color-input-wrapper">
                        <input type="text" id="textPrimaryText" data-var="--text-primary" class="color-text" />
                        <div id="textPrimary" class="color-picker" data-var="--text-primary"></div>
                    </div>
                </div>
            </fieldset>

            <!-- Glass Controls -->
            <fieldset class="control-section">
                <legend><i class="fas fa-window-maximize"></i> Glass Effect</legend>

                <div class="slider-row">
                    <label for="glassOpacity">砖拽驻转</label>
                    <input
                        type="range"
                        id="glassOpacity"
                        min="0" max="100"
                        value="10"
                        aria-describedby="glassOpacityValue"
                    />
                    <span id="glassOpacityValue">10%</span>
                </div>

                <div class="slider-row">
                    <label for="glassBlur">砖砖 (Blur)</label>
                    <input
                        type="range"
                        id="glassBlur"
                        min="0" max="40"
                        value="20"
                        aria-describedby="glassBlurValue"
                    />
                    <span id="glassBlurValue">20px</span>
                </div>
            </fieldset>

            <!-- Markdown (stays dark) -->
            <fieldset class="control-section">
                <legend><i class="fas fa-code"></i> Markdown / 拽</legend>

                <div class="color-row">
                    <label for="mdSurface">专拽注 拽</label>
                    <div class="color-input-wrapper">
                        <input type="text" id="mdSurfaceText" data-var="--md-surface" class="color-text" />
                        <div id="mdSurface" class="color-picker" data-var="--md-surface"></div>
                    </div>
                </div>

                <div class="color-row">
                    <label for="mdText">拽住 拽 (拽住  砖转 转专)</label>
                    <div class="color-input-wrapper">
                        <input type="text" id="mdTextText" data-var="--md-text" class="color-text" />
                        <div id="mdText" class="color-picker" data-var="--md-text"></div>
                    </div>
                </div>
            </fieldset>

            <!-- Actions -->
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="undoBtn" title=" (Ctrl+Z)">
                    <i class="fas fa-undo"></i>
                    
                </button>
                <button type="button" class="btn btn-secondary" id="redoBtn" title="专 (Ctrl+Shift+Z)">
                    <i class="fas fa-redo"></i>
                    专
                </button>
                <button type="submit" class="btn btn-primary" id="saveThemeBtn">
                    <i class="fas fa-save"></i>
                    砖专 砖
                </button>
                <button type="button" class="btn btn-success" id="activateThemeBtn">
                    <i class="fas fa-check"></i>
                    驻注 注专 
                </button>
                <button type="button" class="btn btn-secondary" id="resetThemeBtn">
                    <i class="fas fa-undo"></i>
                    驻住 专专转 
                </button>
                <button type="button" class="btn btn-danger" id="deleteThemeBtn">
                    <i class="fas fa-trash"></i>
                    拽 注专
                </button>
                {% if is_admin %}
                <button type="button" class="btn btn-warning" id="publishThemeBtn">
                    <i class="fas fa-share-alt"></i>
                    驻专住 
                </button>
                {% endif %}
            </div>
        </form>
    </div>

    <!-- Live Preview -->
    <div class="theme-builder-preview glass-card">
        <h3>
            <i class="fas fa-eye"></i>
            转爪 拽
        </h3>

        <div id="theme-preview-container" class="preview-sandbox">
            <!-- Navbar Preview -->
            <nav class="preview-navbar">
                <span class="preview-logo">
                    <i class="fas fa-code"></i>
                    CodeBot
                </span>
                <div class="preview-nav-links">
                    <a href="#">拽爪</a>
                    <a href="#">住驻</a>
                    <a href="#">专转</a>
                </div>
            </nav>

            <!-- Card Preview -->
            <div class="preview-card">
                <div class="preview-card-header">
                    <i class="fas fa-file-code"></i>
                    <span>example.py</span>
                </div>
                <pre class="preview-code-block"><code>def hello():
    print("Hello, Theme!")
    return True</code></pre>
            </div>

            <!-- Buttons Preview -->
            <div class="preview-buttons">
                <button class="preview-btn-primary">驻转专 专砖</button>
                <button class="preview-btn-secondary">驻转专 砖</button>
            </div>

            <!-- Glass Card Preview -->
            <div class="preview-glass-card">
                <p>专住 Glass 注 砖砖 专拽注</p>
            </div>
        </div>
    </div>
</div>

<!-- Toast notifications -->
<div id="theme-toast" class="theme-toast" role="alert" aria-live="polite"></div>

{% if is_admin %}
<!-- Publish Modal -->
<div id="publishModal" class="publish-modal" hidden>
    <div class="publish-modal-content glass-card">
        <div class="publish-modal-header">
            <h3>
                <i class="fas fa-share-alt"></i>
                驻专住 注专 
            </h3>
            <button type="button" class="publish-modal-close" id="closePublishModal" aria-label="住专转  驻专住">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <form id="publishForm">
            <div class="form-group">
                <label for="publishSlug">
                     转 (Slug)
                    <span class="required">*</span>
                </label>
                <input
                    type="text"
                    id="publishSlug"
                    placeholder="cyber_purple"
                    pattern="[a-z][a-z0-9_]{2,29}"
                    required
                />
                <small>3-30 转, 转转 拽转 住驻专 , 转 转</small>
            </div>

            <div class="form-group">
                <label for="publishName">
                    砖 转爪
                    <span class="required">*</span>
                </label>
                <input
                    type="text"
                    id="publishName"
                    placeholder="Cyber Purple"
                    maxlength="50"
                    required
                />
            </div>

            <div class="form-group">
                <label for="publishDescription">转专 拽爪专</label>
                <textarea
                    id="publishDescription"
                    placeholder="注专 住 砖专转 住专驻拽"
                    maxlength="200"
                    rows="2"
                ></textarea>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" id="publishFeatured" />
                    住 爪转 (Featured)
                </label>
            </div>

            <div class="publish-modal-actions">
                <button type="submit" class="btn btn-primary" id="publishSubmitBtn">
                    <i class="fas fa-upload"></i>
                    驻专住
                </button>
                <button type="button" class="btn btn-secondary" id="cancelPublish">
                    
                </button>
            </div>
        </form>
    </div>
</div>
{% endif %}

<style>
.theme-builder-layout {
    display: grid;
    grid-template-columns: 280px 1fr 1fr;
    gap: 1.5rem;
    align-items: start;
}

@media (max-width: 1200px) {
    .theme-builder-layout {
        grid-template-columns: 240px 1fr;
    }
    .theme-builder-preview {
        grid-column: 1 / -1;
    }
}

@media (max-width: 768px) {
    .theme-builder-layout {
        grid-template-columns: 1fr;
    }
    .theme-builder-sidebar {
        order: -1;
    }
}

.theme-builder-controls {
    position: sticky;
    top: 1rem;
}

/* Sidebar Styles */
.theme-builder-sidebar {
    position: sticky;
    top: 1rem;
    max-height: calc(100vh - 2rem);
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

/* (专  注专 祝 注: /settings/theme-gallery) */

.sidebar-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--glass-border);
    margin-bottom: 1rem;
}

.sidebar-header h3 {
    margin: 0;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.sidebar-header .btn-sm {
    padding: 0.4rem 0.8rem;
    font-size: 0.85rem;
}

/* Themes List */
.themes-list {
    flex: 1;
    overflow-y: auto;
    padding-right: 0.5rem;
}

.themes-loading {
    text-align: center;
    padding: 2rem;
    color: var(--text-secondary);
}

.theme-item {
    display: flex;
    align-items: center;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    border-radius: 10px;
    background: var(--glass);
    border: 1px solid transparent;
    cursor: pointer;
    transition: all 0.2s ease;
}

.theme-item:hover {
    background: var(--glass-hover);
    border-color: var(--glass-border);
}

.theme-item.active {
    border-color: var(--primary);
    background: color-mix(in srgb, var(--primary) 15%, transparent);
}

.theme-item.selected {
    border-color: var(--secondary);
    box-shadow: 0 0 0 2px color-mix(in srgb, var(--secondary) 30%, transparent);
}

.theme-item-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-left: 0.75rem;
    flex-shrink: 0;
}

.theme-item.active .theme-item-indicator {
    background: var(--success);
    box-shadow: 0 0 6px var(--success);
}

.theme-item:not(.active) .theme-item-indicator {
    background: var(--glass-border);
}

.theme-item-content {
    flex: 1;
    min-width: 0;
}

.theme-item-name {
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: var(--text-primary);
}

.theme-item-meta {
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin-top: 0.25rem;
}

.theme-item-actions {
    display: flex;
    gap: 0.25rem;
    opacity: 0;
    transition: opacity 0.2s;
}

.theme-item:hover .theme-item-actions {
    opacity: 1;
}

.theme-item-btn {
    width: 28px;
    height: 28px;
    border-radius: 6px;
    border: none;
    background: var(--glass);
    color: var(--text-secondary);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    transition: all 0.2s;
}

.theme-item-btn:hover {
    background: var(--glass-hover);
    color: var(--text-primary);
}

.theme-item-btn.danger:hover {
    background: var(--danger);
    color: white;
}

/* Sidebar Footer */
.sidebar-footer {
    padding-top: 1rem;
    border-top: 1px solid var(--glass-border);
    margin-top: auto;
    text-align: center;
    color: var(--text-secondary);
}

/* Empty State */
.themes-empty {
    text-align: center;
    padding: 2rem 1rem;
    color: var(--text-secondary);
}

.themes-empty i {
    font-size: 2rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.themes-empty p {
    margin: 0;
}

.control-group {
    margin-bottom: 1.5rem;
}

.control-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
}

.control-group input[type="text"] {
    width: 100%;
    padding: 0.75rem;
    border-radius: 10px;
    border: 1px solid var(--glass-border);
    background: var(--glass);
    color: var(--text-primary);
}

.control-section {
    border: 1px solid var(--glass-border);
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1.5rem;
}

.control-section legend {
    padding: 0 0.5rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.color-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
}

.color-row label {
    flex: 1;
}

.color-input-wrapper {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.color-text {
    width: 100px;
    padding: 0.4rem;
    border-radius: 6px;
    border: 1px solid var(--glass-border);
    background: var(--glass);
    color: var(--text-primary);
    font-family: monospace;
    font-size: 0.85rem;
}

.color-picker {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    cursor: pointer;
    border: 2px solid var(--glass-border);
}

.slider-row {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

.slider-row label {
    flex: 1;
}

.slider-row input[type="range"] {
    flex: 2;
}

.slider-row span {
    min-width: 50px;
    text-align: left;
    font-family: monospace;
}

.form-actions {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    margin-top: 2rem;
}

/* Preview Sandbox - isolated styles */
.preview-sandbox {
    background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
    border-radius: 12px;
    padding: 1rem;
    min-height: 400px;
}

.preview-navbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    background: var(--glass);
    backdrop-filter: blur(var(--glass-blur, 20px));
    border-radius: 10px;
    margin-bottom: 1rem;
}

.preview-logo {
    font-weight: 700;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.preview-nav-links {
    display: flex;
    gap: 1rem;
}

.preview-nav-links a {
    color: var(--text-primary);
    text-decoration: none;
    opacity: 0.85;
}

.preview-card {
    background: var(--card-bg);
    border: 1px solid var(--glass-border);
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.preview-card-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
    color: var(--text-primary);
    font-weight: 600;
}

.preview-code-block {
    background: var(--md-surface);
    color: var(--md-text);
    padding: 1rem;
    border-radius: 8px;
    font-family: 'Fira Code', monospace;
    font-size: 0.85rem;
    overflow-x: auto;
}

.preview-buttons {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
}

.preview-btn-primary {
    background: var(--btn-primary-bg, var(--primary));
    color: var(--btn-primary-color, white);
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
}

.preview-btn-secondary {
    background: var(--glass);
    color: var(--text-primary);
    border: 1px solid var(--glass-border);
    padding: 0.75rem 1.5rem;
    border-radius: 10px;
    cursor: pointer;
}

.preview-glass-card {
    background: var(--glass);
    backdrop-filter: blur(var(--glass-blur, 20px));
    border: 1px solid var(--glass-border);
    border-radius: 12px;
    padding: 1rem;
    color: var(--text-primary);
}

/* Toast */
.theme-toast {
    position: fixed;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: var(--card-bg);
    color: var(--text-primary);
    padding: 1rem 2rem;
    border-radius: 10px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    opacity: 0;
    transition: transform 0.3s ease, opacity 0.3s ease;
    z-index: 9999;
}

.theme-toast.visible {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
}

.theme-toast.error {
    background: var(--danger);
    color: white;
}

.theme-toast.success {
    background: var(--success);
    color: white;
}

/* Modal (Publish)
   锔  砖转砖 拽 .modal  注 拽驻拽 注 smooth-scroll.css 砖住转专 .modal 注 !important
*/
.publish-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    backdrop-filter: blur(4px);
}

.publish-modal[hidden] {
    display: none;
}

.publish-modal-content {
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
    animation: modalFadeIn 0.2s ease;
}

@keyframes modalFadeIn {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.publish-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--glass-border);
}

.publish-modal-header h3 {
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.publish-modal-close {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 1.2rem;
    padding: 0.5rem;
    border-radius: 6px;
    transition: all 0.2s;
}

.publish-modal-close:hover {
    background: var(--glass);
    color: var(--text-primary);
}

.form-group {
    margin-bottom: 1.25rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
}

.form-group input[type="text"],
.form-group textarea {
    width: 100%;
    padding: 0.75rem;
    border-radius: 8px;
    border: 1px solid var(--glass-border);
    background: var(--glass);
    color: var(--text-primary);
    font-size: 1rem;
}

.form-group input:focus,
.form-group textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 2px color-mix(in srgb, var(--primary) 30%, transparent);
}

.form-group small {
    display: block;
    margin-top: 0.4rem;
    color: var(--text-secondary);
    font-size: 0.85rem;
}

.form-group input[type="checkbox"] {
    margin-left: 0.5rem;
}

.required {
    color: var(--danger);
}

.publish-modal-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    margin-top: 1.5rem;
    padding-top: 1rem;
    border-top: 1px solid var(--glass-border);
}
</style>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='libs/pickr/pickr.min.js') }}?v={{ static_version }}"></script>

<script>
(function() {
    'use strict';

    // ========== Configuration ==========
    const DEFAULT_VALUES = {
        '--bg-primary': '#6b63ff',
        '--bg-secondary': '#8e63ff',
        '--card-bg': 'rgba(255, 255, 255, 0.12)',
        '--primary': '#667eea',
        '--secondary': '#764ba2',
        '--btn-primary-bg': '#667eea',
        '--btn-primary-color': '#ffffff',
        '--text-primary': '#ffffff',
        '--glass': 'rgba(255, 255, 255, 0.1)',
        '--glass-border': 'rgba(255, 255, 255, 0.2)',
        '--glass-hover': 'rgba(255, 255, 255, 0.15)',
        '--glass-blur': '20px',
        '--md-surface': '#1b1e24',
        '--md-text': '#f0f0f0',
    };

    const VAR_MAP = {
        'bgPrimary': '--bg-primary',
        'bgSecondary': '--bg-secondary',
        'cardBg': '--card-bg',
        'primary': '--primary',
        'secondary': '--secondary',
        'textPrimary': '--text-primary',
        'mdSurface': '--md-surface',
        'mdText': '--md-text',
        'btnPrimaryBg': '--btn-primary-bg',
        'btnPrimaryColor': '--btn-primary-color',
    };

    // ========== State ==========
    let currentThemes = [];
    let selectedThemeId = null;
    let isNewTheme = false;
    //   爪   注转 注专: 注 "驻专住" 砖 转 砖 驻住
    let isThemeLoading = false;
    //  注专 砖驻住 专注 爪 驻注 (专 fetch + loadThemeIntoForm)
    let loadedThemeId = null;
    let hasUnsavedChanges = false;
    let currentThemeSyntaxCss = '';
    //  砖专转  砖转 砖 注专 拽专转 ( 专拽  砖驻住) - 砖 驻专住!
    let currentThemeAllVariables = {};

    // ========== DOM Elements ==========
    const themesList = document.getElementById('themesList');
    const themesCount = document.getElementById('themesCount');
    const themesMax = document.getElementById('themesMax');
    const createNewBtn = document.getElementById('createNewThemeBtn');

    const previewContainer = document.getElementById('theme-preview-container');
    const pickrInstances = {};

    // ========== Toast ==========
    function showToast(message, type = 'info') {
        const toast = document.getElementById('theme-toast');
        toast.textContent = message;
        toast.className = 'theme-toast visible ' + type;
        setTimeout(() => {
            toast.classList.remove('visible');
        }, 3000);
    }

    // ========== Preview Update ==========
    function updatePreview(varName, value) {
        if (!previewContainer) return;
        previewContainer.style.setProperty(varName, value);
    }

    // ========== Undo/Redo + Autosave Draft (LocalStorage) ==========
    const HISTORY_MAX = 50;
    let history = [];
    let historyIndex = -1;
    let _historyDebounce = null;
    let _draftDebounce = null;
    let _suppressTracking = false;

    function _draftKey() {
        return `codebot.theme_builder.draft.v1:${selectedThemeId || 'new'}`;
    }

    function _safeJsonParse(s) {
        try { return JSON.parse(s); } catch (e) { return null; }
    }

    function _getCurrentState() {
        const nameEl = document.getElementById('themeName');
        return {
            version: 1,
            theme_id: selectedThemeId || null,
            is_new: !!isNewTheme,
            name: (nameEl && nameEl.value ? String(nameEl.value) : ''),
            variables: collectThemeValues(),
            saved_at: new Date().toISOString(),
        };
    }

    function _stateFingerprint(state) {
        try {
            const vars = state && state.variables ? state.variables : {};
            const keys = Object.keys(vars).sort();
            const flat = keys.map((k) => `${k}:${String(vars[k])}`).join('|');
            return `${state && state.name ? String(state.name) : ''}||${flat}`;
        } catch (e) {
            return '';
        }
    }

    function _applyState(state) {
        if (!state || typeof state !== 'object') return;
        _suppressTracking = true;
        try {
            const nameEl = document.getElementById('themeName');
            if (nameEl && typeof state.name === 'string') {
                nameEl.value = state.name;
            }

            const variables = state.variables || {};
            Object.entries(VAR_MAP).forEach(([pickrId, varName]) => {
                const textInput = document.getElementById(pickrId + 'Text');
                const value = variables[varName] || DEFAULT_VALUES[varName];
                if (textInput) textInput.value = value;
                if (pickrInstances[pickrId]) {
                    try { pickrInstances[pickrId].setColor(value); } catch (e) {}
                }
                updatePreview(varName, value);
            });

            // Glass sliders from variables
            try {
                const opacitySlider = document.getElementById('glassOpacity');
                const opacityValue = document.getElementById('glassOpacityValue');
                const blurSlider = document.getElementById('glassBlur');
                const blurValue = document.getElementById('glassBlurValue');

                if (variables['--glass']) {
                    const match = String(variables['--glass']).match(/[\d.]+(?=\))/);
                    if (match && opacitySlider) {
                        const v = Math.round(parseFloat(match[0]) * 100);
                        opacitySlider.value = String(v);
                        if (opacityValue) opacityValue.textContent = v + '%';
                    }
                    updatePreview('--glass', String(variables['--glass']));
                }

                if (variables['--glass-border']) updatePreview('--glass-border', String(variables['--glass-border']));
                if (variables['--glass-hover']) updatePreview('--glass-hover', String(variables['--glass-hover']));

                if (variables['--glass-blur']) {
                    const vRaw = String(variables['--glass-blur']);
                    const v = parseInt(vRaw, 10);
                    if (blurSlider) blurSlider.value = String(v);
                    if (blurValue) blurValue.textContent = v + 'px';
                    updatePreview('--glass-blur', vRaw);
                }
            } catch (e) {}

            hasUnsavedChanges = true;
            updateFormButtons();
        } finally {
            _suppressTracking = false;
        }
    }

    function _updateUndoRedoButtons() {
        const undoBtn = document.getElementById('undoBtn');
        const redoBtn = document.getElementById('redoBtn');
        if (undoBtn) undoBtn.disabled = !(historyIndex > 0);
        if (redoBtn) redoBtn.disabled = !(historyIndex >= 0 && historyIndex < history.length - 1);
    }

    function _pushHistory(state) {
        if (!state) return;
        const fp = _stateFingerprint(state);
        const cur = historyIndex >= 0 ? _stateFingerprint(history[historyIndex]) : '';
        if (fp && fp === cur) return;

        history = history.slice(0, historyIndex + 1);
        history.push(state);
        if (history.length > HISTORY_MAX) {
            history.shift();
        }
        historyIndex = history.length - 1;
        _updateUndoRedoButtons();
    }

    function _resetHistoryFromCurrent() {
        history = [];
        historyIndex = -1;
        _pushHistory(_getCurrentState());
    }

    function undo() {
        if (historyIndex <= 0) return;
        historyIndex -= 1;
        _applyState(history[historyIndex]);
        _updateUndoRedoButtons();
    }

    function redo() {
        if (historyIndex < 0 || historyIndex >= history.length - 1) return;
        historyIndex += 1;
        _applyState(history[historyIndex]);
        _updateUndoRedoButtons();
    }

    function _saveDraftNow() {
        try {
            const state = _getCurrentState();
            localStorage.setItem(_draftKey(), JSON.stringify(state));
        } catch (e) {}
    }

    function _clearDraftForCurrent() {
        try { localStorage.removeItem(_draftKey()); } catch (e) {}
    }

    function _maybeRestoreDraftForCurrentTheme() {
        try {
            const raw = localStorage.getItem(_draftKey());
            const draft = _safeJsonParse(raw);
            if (!draft || !draft.variables) return;

            const shouldRestore = confirm('爪  砖砖专 转 注专 注专 .\n砖专?');
            if (!shouldRestore) return;

            _applyState(draft);
            _resetHistoryFromCurrent();
            showToast('砖专  砖砖专 转', 'success');
        } catch (e) {}
    }

    function _onStateChanged() {
        if (_suppressTracking) return;
        hasUnsavedChanges = true;

        clearTimeout(_historyDebounce);
        _historyDebounce = setTimeout(() => {
            try { _pushHistory(_getCurrentState()); } catch (e) {}
        }, 150);

        clearTimeout(_draftDebounce);
        _draftDebounce = setTimeout(() => {
            _saveDraftNow();
        }, 350);
    }

    // ========== Contrast (WCAG 2.1) ==========
    function _hexToRgb(hex) {
        const h = String(hex || '').trim().replace('#', '');
        if (h.length !== 6) return null;
        const r = parseInt(h.slice(0, 2), 16);
        const g = parseInt(h.slice(2, 4), 16);
        const b = parseInt(h.slice(4, 6), 16);
        if ([r, g, b].some((v) => Number.isNaN(v))) return null;
        return { r, g, b };
    }

    function _luminance({ r, g, b }) {
        const srgb = [r, g, b].map((v) => v / 255);
        const lin = srgb.map((c) => (c <= 0.03928 ? c / 12.92 : Math.pow((c + 0.055) / 1.055, 2.4)));
        return 0.2126 * lin[0] + 0.7152 * lin[1] + 0.0722 * lin[2];
    }

    function checkContrast(fgHex, bgHex) {
        const fg = _hexToRgb(fgHex);
        const bg = _hexToRgb(bgHex);
        if (!fg || !bg) return null;
        const l1 = _luminance(fg);
        const l2 = _luminance(bg);
        const lighter = Math.max(l1, l2);
        const darker = Math.min(l1, l2);
        return (lighter + 0.05) / (darker + 0.05);
    }

    // ========== Pickr Initialization ==========
    function initColorPicker(elementId, varName) {
        const el = document.getElementById(elementId);
        if (!el) return null;

        const textInput = document.getElementById(elementId + 'Text');
        const initialColor = DEFAULT_VALUES[varName] || '#ffffff';

        const pickr = Pickr.create({
            el: el,
            theme: 'nano',
            default: initialColor,
            components: {
                preview: true,
                opacity: true,
                hue: true,
                interaction: {
                    hex: true,
                    rgba: true,
                    input: true,
                    save: true,
                }
            }
        });

        pickr.on('change', (color) => {
            const rgba = color.toRGBA();
            const value = rgba[3] < 1
                ? `rgba(${Math.round(rgba[0])}, ${Math.round(rgba[1])}, ${Math.round(rgba[2])}, ${rgba[3].toFixed(2)})`
                : color.toHEXA().toString();

            if (textInput) textInput.value = value;
            updatePreview(varName, value);
            _onStateChanged();
        });

        pickr.on('save', () => pickr.hide());

        // Sync text input
        if (textInput) {
            textInput.value = initialColor;
            textInput.addEventListener('change', () => {
                const val = textInput.value.trim();
                if (val) {
                    try {
                        pickr.setColor(val);
                        updatePreview(varName, val);
                        _onStateChanged();
                    } catch (e) {
                        // ignore invalid color
                    }
                }
            });
        }

        // Initial preview
        updatePreview(varName, initialColor);

        return pickr;
    }

    // ========== Initialize All Pickers ==========
    function initAllPickers() {
        pickrInstances['bgPrimary'] = initColorPicker('bgPrimary', '--bg-primary');
        pickrInstances['bgSecondary'] = initColorPicker('bgSecondary', '--bg-secondary');
        pickrInstances['cardBg'] = initColorPicker('cardBg', '--card-bg');
        pickrInstances['primary'] = initColorPicker('primary', '--primary');
        pickrInstances['secondary'] = initColorPicker('secondary', '--secondary');
        pickrInstances['textPrimary'] = initColorPicker('textPrimary', '--text-primary');
        pickrInstances['mdSurface'] = initColorPicker('mdSurface', '--md-surface');
        pickrInstances['mdText'] = initColorPicker('mdText', '--md-text');
        pickrInstances['btnPrimaryBg'] = initColorPicker('btnPrimaryBg', '--btn-primary-bg');
        pickrInstances['btnPrimaryColor'] = initColorPicker('btnPrimaryColor', '--btn-primary-color');
    }

    // ========== Glass Sliders ==========
    function initGlassSliders() {
        const opacitySlider = document.getElementById('glassOpacity');
        const opacityValue = document.getElementById('glassOpacityValue');
        const blurSlider = document.getElementById('glassBlur');
        const blurValue = document.getElementById('glassBlurValue');

        opacitySlider.addEventListener('input', () => {
            const val = opacitySlider.value;
            opacityValue.textContent = val + '%';
            const rgba = `rgba(255, 255, 255, ${(val / 100).toFixed(2)})`;
            updatePreview('--glass', rgba);
            _onStateChanged();
        });

        blurSlider.addEventListener('input', () => {
            const val = blurSlider.value;
            blurValue.textContent = val + 'px';
            updatePreview('--glass-blur', val + 'px');
            _onStateChanged();
        });

        // Initial update
        opacityValue.textContent = opacitySlider.value + '%';
        blurValue.textContent = blurSlider.value + 'px';
        updatePreview('--glass', `rgba(255, 255, 255, ${(opacitySlider.value / 100).toFixed(2)})`);
        updatePreview('--glass-blur', blurSlider.value + 'px');
    }

    // ========== Collect Values ==========
    function collectThemeValues() {
        const variables = {};

        // Colors from pickr
        for (const [pickrId, varName] of Object.entries(VAR_MAP)) {
            const textInput = document.getElementById(pickrId + 'Text');
            if (textInput && textInput.value) {
                variables[varName] = textInput.value.trim();
            }
        }

        // Glass
        const opacitySlider = document.getElementById('glassOpacity');
        const blurSlider = document.getElementById('glassBlur');
        const opacityVal = parseInt(opacitySlider.value, 10);
        // Clamp alpha values to valid 0-1 range
        const glassAlpha = (opacityVal / 100).toFixed(2);
        const borderAlpha = Math.min(1, (opacityVal + 10) / 100).toFixed(2);
        const hoverAlpha = Math.min(1, (opacityVal + 5) / 100).toFixed(2);
        variables['--glass'] = `rgba(255, 255, 255, ${glassAlpha})`;
        variables['--glass-border'] = `rgba(255, 255, 255, ${borderAlpha})`;
        variables['--glass-hover'] = `rgba(255, 255, 255, ${hoverAlpha})`;
        variables['--glass-blur'] = blurSlider.value + 'px';

        return variables;
    }

    // ========== API Functions ==========
    async function fetchThemes() {
        if (!themesList) return;
        try {
            const res = await fetch('/api/themes');
            const data = await res.json();

            if (!res.ok || !data.ok) {
                throw new Error(data.error || 'fetch_failed');
            }

            currentThemes = data.themes || [];
            if (themesMax) themesMax.textContent = data.max_allowed;

            renderThemesList();

            // 专 转 注专 驻注 ( 专砖)
            const stillExists = selectedThemeId && currentThemes.some((t) => t.id === selectedThemeId);
            if (stillExists) {
                // keep selection
                await selectTheme(selectedThemeId);
                return;
            }

            const activeTheme = currentThemes.find(t => t.is_active);
            if (activeTheme) {
                await selectTheme(activeTheme.id);
            } else if (currentThemes.length > 0) {
                await selectTheme(currentThemes[0].id);
            } else {
                clearFormForNewTheme();
            }

        } catch (err) {
            console.error('Failed to fetch themes:', err);
            showToast('砖 注转 注专转', 'error');
        }
    }

    async function fetchThemeDetails(themeId) {
        try {
            const res = await fetch(`/api/themes/${themeId}`);
            const data = await res.json();

            if (!res.ok || !data.ok) {
                throw new Error(data.error || 'fetch_failed');
            }

            return data.theme;

        } catch (err) {
            console.error('Failed to fetch theme details:', err);
            showToast('砖 注转 驻专 注专', 'error');
            return null;
        }
    }

    async function createNewTheme(themeData) {
        try {
            const res = await fetch('/api/themes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(themeData)
            });

            const data = await res.json();

            if (!res.ok || !data.ok) {
                throw new Error(data.error || 'create_failed');
            }

            showToast('注专 爪专 爪!', 'success');
            return data.theme_id;

        } catch (err) {
            console.error('Failed to create theme:', err);
            let msg = '砖 爪专转 注专';
            if (err.message === 'max_themes_reached') msg = `注转 转 注专转 (${themesMax?.textContent || '10'})`;
            if (err.message === 'invalid_color') msg = ' 爪注  转拽';
            if (err.message === 'name_too_long') msg = '砖 专  (注 50 转)';
            showToast(msg, 'error');
            return null;
        }
    }

    async function updateExistingTheme(themeId, themeData) {
        try {
            const res = await fetch(`/api/themes/${themeId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(themeData)
            });

            const data = await res.json();

            if (!res.ok || !data.ok) {
                throw new Error(data.error || 'update_failed');
            }

            showToast('注专 注 爪!', 'success');
            return true;

        } catch (err) {
            console.error('Failed to update theme:', err);
            showToast('砖 注 注专', 'error');
            return false;
        }
    }

    async function activateTheme(themeId) {
        try {
            const res = await fetch(`/api/themes/${themeId}/activate`, { method: 'POST' });
            const data = await res.json();

            if (!res.ok || !data.ok) {
                throw new Error(data.error || 'activate_failed');
            }

            showToast('注专 驻注! 专注...', 'success');
            setTimeout(() => location.reload(), 1000);

        } catch (err) {
            console.error('Failed to activate theme:', err);
            showToast('砖 驻注转 注专', 'error');
        }
    }

    async function deleteTheme(themeId) {
        if (!confirm(' 拽 转 注专? 驻注   转转 .')) {
            return;
        }

        try {
            const res = await fetch(`/api/themes/${themeId}`, { method: 'DELETE' });
            const data = await res.json();

            if (!res.ok || !data.ok) {
                throw new Error(data.error || 'delete_failed');
            }

            showToast('注专 拽', 'success');

            if (data.was_active) {
                setTimeout(() => location.reload(), 1000);
            } else {
                await fetchThemes();
            }

        } catch (err) {
            console.error('Failed to delete theme:', err);
            showToast('砖 拽转 注专', 'error');
        }
    }

    // ========== Render Functions ==========
    function renderThemesList() {
        if (!themesList) return;
        if (themesCount) themesCount.textContent = currentThemes.length;

        if (currentThemes.length === 0) {
            themesList.innerHTML = `
                <div class="themes-empty">
                    <i class="fas fa-palette"></i>
                    <p>注   注专转 转转</p>
                    <p><small>抓 "注专 砖" 爪专转 专砖</small></p>
                </div>
            `;
            return;
        }

        themesList.innerHTML = currentThemes.map(theme => `
            <div class="theme-item ${theme.is_active ? 'active' : ''} ${selectedThemeId === theme.id ? 'selected' : ''}"
                 data-theme-id="${theme.id}">
                <div class="theme-item-indicator" title="${theme.is_active ? '注专 驻注' : ''}"></div>
                <div class="theme-item-content">
                    <div class="theme-item-name">${escapeHtml(theme.name)}</div>
                    <div class="theme-item-meta">
                        ${theme.is_active ? '<i class="fas fa-check-circle"></i> 驻注' : ''}
                        ${!theme.is_active && theme.updated_at ? formatDate(theme.updated_at) : ''}
                    </div>
                </div>
                <div class="theme-item-actions">
                    ${!theme.is_active ? `
                        <button type="button" class="theme-item-btn activate-btn"
                                title="驻注 注专" data-action="activate">
                            <i class="fas fa-check"></i>
                        </button>
                    ` : ''}
                    <button type="button" class="theme-item-btn danger delete-btn"
                            title="拽 注专" data-action="delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');

        themesList.querySelectorAll('.theme-item').forEach(item => {
            item.addEventListener('click', (e) => {
                const action = e.target.closest('[data-action]')?.dataset.action;
                const themeId = item.dataset.themeId;

                if (action === 'activate') {
                    activateTheme(themeId);
                } else if (action === 'delete') {
                    deleteTheme(themeId);
                } else {
                    selectTheme(themeId);
                }
            });
        });
    }

    function setFormDisabled(disabled) {
        const form = document.getElementById('themeBuilderForm');
        if (!form) return;
        form.querySelectorAll('input, button').forEach((el) => {
            // 砖专 转 驻转专 驻专住 抓 转 (专转 " "  注/砖)
            if (el && el.id === 'publishThemeBtn') return;
            el.disabled = !!disabled;
        });
        // 转 砖专 转 驻转专 "注专 砖" 驻注
        if (createNewBtn) createNewBtn.disabled = false;
    }

    async function selectTheme(themeId) {
        if (!themeId) return;
        if (hasUnsavedChanges && !confirm('砖 砖 砖 砖专. 砖?')) {
            return;
        }

        selectedThemeId = themeId;
        isNewTheme = false;
        isThemeLoading = true;
        loadedThemeId = null;
        renderThemesList();

        setFormDisabled(true);
        try {
            const theme = await fetchThemeDetails(themeId);
            if (theme) {
                loadThemeIntoForm(theme);
                loadedThemeId = themeId;
            }
        } finally {
            isThemeLoading = false;
            setFormDisabled(false);
        }

        hasUnsavedChanges = false;
        updateFormButtons();
        _resetHistoryFromCurrent();
        _maybeRestoreDraftForCurrentTheme();
    }

    function loadThemeIntoForm(theme) {
        _suppressTracking = true;
        try {
        const nameEl = document.getElementById('themeName');
        if (nameEl) nameEl.value = theme.name || '';

        const variables = theme.variables || {};
        currentThemeSyntaxCss = (theme && typeof theme.syntax_css === 'string') ? theme.syntax_css : '';
        //  砖专转  砖转 砖 注专 拽专转 ( 专拽  砖驻住)
        currentThemeAllVariables = { ...variables };

        Object.entries(VAR_MAP).forEach(([pickrId, varName]) => {
            const textInput = document.getElementById(pickrId + 'Text');
            const value = variables[varName] || DEFAULT_VALUES[varName];

            if (textInput) {
                textInput.value = value;
            }
            if (pickrInstances[pickrId]) {
                try {
                    pickrInstances[pickrId].setColor(value);
                } catch (e) {}
            }
            updatePreview(varName, value);
        });

        // Glass sliders
        if (variables['--glass']) {
            const match = String(variables['--glass']).match(/[\d.]+(?=\))/);
            if (match) {
                const opacitySlider = document.getElementById('glassOpacity');
                const v = Math.round(parseFloat(match[0]) * 100);
                if (opacitySlider) opacitySlider.value = v;
                const opacityValue = document.getElementById('glassOpacityValue');
                if (opacityValue) opacityValue.textContent = v + '%';
                updatePreview('--glass', String(variables['--glass']));
            }
        }

        if (variables['--glass-blur']) {
            const blurSlider = document.getElementById('glassBlur');
            const vRaw = String(variables['--glass-blur']);
            const v = parseInt(vRaw, 10);
            if (blurSlider) blurSlider.value = v;
            const blurValue = document.getElementById('glassBlurValue');
            if (blurValue) blurValue.textContent = v + 'px';
            updatePreview('--glass-blur', vRaw);
        }
        } finally {
            _suppressTracking = false;
        }
    }

    function clearFormForNewTheme() {
        if (hasUnsavedChanges && !confirm('砖 砖 砖 砖专. 砖?')) {
            return;
        }

        selectedThemeId = null;
        isNewTheme = true;
        isThemeLoading = false;
        loadedThemeId = null;
        currentThemeSyntaxCss = '';
        currentThemeAllVariables = {};
        renderThemesList();

        _suppressTracking = true;
        try {
        const nameEl = document.getElementById('themeName');
        if (nameEl) {
            nameEl.value = '';
            nameEl.focus();
        }

        Object.entries(VAR_MAP).forEach(([pickrId, varName]) => {
            const textInput = document.getElementById(pickrId + 'Text');
            const value = DEFAULT_VALUES[varName];
            if (textInput) textInput.value = value;
            if (pickrInstances[pickrId]) {
                try { pickrInstances[pickrId].setColor(value); } catch (e) {}
            }
            updatePreview(varName, value);
        });

        // Reset glass sliders
        const opacitySlider = document.getElementById('glassOpacity');
        if (opacitySlider) opacitySlider.value = 10;
        const opacityValue = document.getElementById('glassOpacityValue');
        if (opacityValue) opacityValue.textContent = '10%';

        const blurSlider = document.getElementById('glassBlur');
        if (blurSlider) blurSlider.value = 20;
        const blurValue = document.getElementById('glassBlurValue');
        if (blurValue) blurValue.textContent = '20px';

        updatePreview('--glass', 'rgba(255, 255, 255, 0.10)');
        updatePreview('--glass-blur', '20px');
        } finally {
            _suppressTracking = false;
        }

        hasUnsavedChanges = false;
        updateFormButtons();
        _resetHistoryFromCurrent();
        _maybeRestoreDraftForCurrentTheme();
    }

    function updateFormButtons() {
        const saveBtn = document.getElementById('saveThemeBtn');
        const activateBtn = document.getElementById('activateThemeBtn');
        const deleteBtn = document.getElementById('deleteThemeBtn');

        if (isNewTheme) {
            if (saveBtn) saveBtn.innerHTML = '<i class="fas fa-plus"></i> 爪专 注专';
            if (activateBtn) activateBtn.disabled = true;
            if (deleteBtn) deleteBtn.disabled = true;
        } else {
            if (saveBtn) saveBtn.innerHTML = '<i class="fas fa-save"></i> 砖专 砖';
            if (activateBtn) activateBtn.disabled = !selectedThemeId;
            if (deleteBtn) deleteBtn.disabled = !selectedThemeId;
        }
    }

    {% if is_admin %}
    // ========== Publish Logic (Admin Only) ==========
    const publishBtn = document.getElementById('publishThemeBtn');
    const publishModal = document.getElementById('publishModal');
    const publishForm = document.getElementById('publishForm');
    const closePublishModal = document.getElementById('closePublishModal');
    const cancelPublish = document.getElementById('cancelPublish');
    const publishSubmitBtn = document.getElementById('publishSubmitBtn');

    function hidePublishModal() {
        if (publishModal) {
            publishModal.hidden = true;
            try { publishModal.style.display = ''; } catch (e) {}
            try { delete publishModal.dataset.themeId; } catch (e) {}
        }
        try { if (publishForm) publishForm.reset(); } catch (e) {}
    }

    if (publishBtn) {
        publishBtn.addEventListener('click', () => {
            if (!selectedThemeId || isNewTheme) {
                showToast(' 驻专住 爪专 专 注专 拽转 ( "注专 砖")', 'error');
                return;
            }
            //  注 驻住 注 爪 注专 拽转  注 驻转转    驻专住 转 砖
            if (isThemeLoading || loadedThemeId !== selectedThemeId) {
                showToast('注 转 驻专 注专... 住 砖 注 专注', 'info');
                return;
            }

            //  转 砖 转
            const currentName = document.getElementById('themeName')?.value || '';
            const publishNameEl = document.getElementById('publishName');
            if (publishNameEl) publishNameEl.value = currentName;

            // 爪注 slug 
            const suggestedSlug = String(currentName || '')
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, '_')
                .replace(/^_|_$/g, '')
                .slice(0, 30);
            const publishSlugEl = document.getElementById('publishSlug');
            if (publishSlugEl) publishSlugEl.value = suggestedSlug || '';

            if (publishModal) {
                try { publishModal.dataset.themeId = String(selectedThemeId); } catch (e) {}
                publishModal.hidden = false;
                // "拽砖转"  CSS 爪 砖注砖 住转专 overlays
                try { publishModal.style.display = 'flex'; } catch (e) {}
            }
        });
    }

    if (closePublishModal) closePublishModal.addEventListener('click', hidePublishModal);
    if (cancelPublish) cancelPublish.addEventListener('click', hidePublishModal);

    publishModal?.addEventListener('click', (e) => {
        if (e.target === publishModal) {
            hidePublishModal();
        }
    });

    if (publishForm) {
        publishForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const expectedThemeId = (publishModal && publishModal.dataset) ? publishModal.dataset.themeId : null;
            if (!expectedThemeId || !selectedThemeId || String(expectedThemeId) !== String(selectedThemeId)) {
                showToast('注专 砖转转  驻转转 . 驻转 转  驻专住 砖.', 'error');
                return;
            }
            if (isThemeLoading || loadedThemeId !== selectedThemeId) {
                showToast('注专 注 注转. 住 砖 注 专注.', 'info');
                return;
            }

            const slug = (document.getElementById('publishSlug')?.value || '').trim().toLowerCase();
            const name = (document.getElementById('publishName')?.value || '').trim();
            const description = (document.getElementById('publishDescription')?.value || '').trim();
            const isFeatured = !!document.getElementById('publishFeatured')?.checked;

            //  : 转  砖转 砖 注专 拽专转,  专住 注  砖驻住
            //  砖专  砖转 砖  pickr ( --code-bg, --primary-hover ')
            const formColors = collectThemeValues();
            const colors = { ...currentThemeAllVariables, ...formColors };

            try {
                if (publishSubmitBtn) publishSubmitBtn.disabled = true;
                const res = await fetch('/api/themes/publish', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        slug,
                        name,
                        colors,
                        description,
                        is_featured: isFeatured,
                        //  转 -VS Code Import:  注专 砖 syntax_css 砖专  转
                        syntax_css: (typeof currentThemeSyntaxCss === 'string' ? currentThemeSyntaxCss : ''),
                    })
                });

                const data = await res.json();
                if (!res.ok || !data.ok) {
                    throw new Error(data.message || data.error || 'publish_failed');
                }

                hidePublishModal();
                showToast(`注专 "${name}" 驻专住 爪!`, 'success');
            } catch (err) {
                console.error('Publish failed:', err);
                showToast(err?.message || '砖 驻专住 注专', 'error');
            } finally {
                if (publishSubmitBtn) publishSubmitBtn.disabled = false;
            }
        });
    }
    {% endif %}

    // ========== Save Handler ==========
    async function handleSave(e) {
        e.preventDefault();

        const nameEl = document.getElementById('themeName');
        const name = (nameEl?.value || '').trim();
        if (!name) {
            showToast('  砖 注专', 'error');
            if (nameEl) nameEl.focus();
            return;
        }

        const variables = collectThemeValues();

        // 砖转: 拽转 转 住住转 (砖专 注专  hex)
        try {
            const warnings = [];
            const ratio = checkContrast(variables['--text-primary'], variables['--bg-primary']);
            if (typeof ratio === 'number' && ratio < 4.5) {
                warnings.push(`转 拽住/专拽注  (${ratio.toFixed(1)}:1)`);
            }
            if (warnings.length && !confirm('爪 注转 砖转:\n' + warnings.join('\n') + '\n\n砖  转?')) {
                return;
            }
        } catch (_) {}

        if (isNewTheme) {
            const newId = await createNewTheme({
                name: name,
                variables: variables,
                activate: false
            });
            if (newId) {
                _clearDraftForCurrent(); // clears draft for "new"
                isNewTheme = false;
                selectedThemeId = newId;
                await fetchThemes();
                await selectTheme(newId);
            }
        } else {
            const ok = await updateExistingTheme(selectedThemeId, { name: name, variables: variables });
            if (ok) {
                _clearDraftForCurrent();
                await fetchThemes();
            }
        }

        hasUnsavedChanges = false;
        updateFormButtons();
        _resetHistoryFromCurrent();
    }

    // ========== Reset Form (Defaults) ==========
    function resetFormToDefaults() {
        if (!confirm('驻住 转 注专 专专转 ? ( 砖专 转)')) {
            return;
        }

        Object.entries(VAR_MAP).forEach(([pickrId, varName]) => {
            const textInput = document.getElementById(pickrId + 'Text');
            const value = DEFAULT_VALUES[varName];
            if (textInput) textInput.value = value;
            if (pickrInstances[pickrId]) {
                try { pickrInstances[pickrId].setColor(value); } catch (e) {}
            }
            updatePreview(varName, value);
        });

        const opacitySlider = document.getElementById('glassOpacity');
        if (opacitySlider) opacitySlider.value = 10;
        const opacityValue = document.getElementById('glassOpacityValue');
        if (opacityValue) opacityValue.textContent = '10%';

        const blurSlider = document.getElementById('glassBlur');
        if (blurSlider) blurSlider.value = 20;
        const blurValue = document.getElementById('glassBlurValue');
        if (blurValue) blurValue.textContent = '20px';

        updatePreview('--glass', 'rgba(255, 255, 255, 0.10)');
        updatePreview('--glass-blur', '20px');

        _onStateChanged();
    }

    // ========== Utilities ==========
    function escapeHtml(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    function formatDate(isoString) {
        try {
            const date = new Date(isoString);
            return date.toLocaleDateString('he-IL', { day: 'numeric', month: 'short' });
        } catch (e) {
            return '';
        }
    }

    // ========== Init ==========
    function init() {
        initAllPickers();
        initGlassSliders();

        // 注 专砖转 注专转
        fetchThemes();

        if (createNewBtn) {
            createNewBtn.addEventListener('click', clearFormForNewTheme);
        }

        // 注拽 专 砖
        document.querySelectorAll('.color-text, #themeName').forEach(input => {
            input.addEventListener('input', _onStateChanged);
        });
        document.querySelectorAll('input[type="range"]').forEach(slider => {
            slider.addEventListener('input', _onStateChanged);
        });

        // Undo/Redo buttons
        const undoBtn = document.getElementById('undoBtn');
        const redoBtn = document.getElementById('redoBtn');
        if (undoBtn) undoBtn.addEventListener('click', undo);
        if (redoBtn) redoBtn.addEventListener('click', redo);

        // Keyboard shortcuts: Ctrl+S, Ctrl+Z, Ctrl+Shift+Z
        window.addEventListener('keydown', (e) => {
            try {
                const t = e.target;
                const tag = t && t.tagName ? String(t.tagName).toLowerCase() : '';
                const isTextInput = tag === 'input' || tag === 'textarea' || (t && t.isContentEditable);

                const key = String(e.key || '').toLowerCase();
                if (e.ctrlKey && key === 's') {
                    e.preventDefault();
                    const form = document.getElementById('themeBuilderForm');
                    if (form) form.requestSubmit();
                    return;
                }

                //   砖专 undo 注 转 砖转 拽住,  History 专拽 砖 驻拽住 注 input/textarea
                if (isTextInput) return;

                if (e.ctrlKey && !e.shiftKey && key === 'z') {
                    e.preventDefault();
                    undo();
                } else if ((e.ctrlKey && e.shiftKey && key === 'z') || (e.ctrlKey && key === 'y')) {
                    e.preventDefault();
                    redo();
                }
            } catch (err) {}
        });

        // 砖专 (create/update)
        document.getElementById('themeBuilderForm').addEventListener('submit', handleSave);

        // 驻转专 驻注
        const activateBtn = document.getElementById('activateThemeBtn');
        if (activateBtn) {
            activateBtn.addEventListener('click', () => {
                if (selectedThemeId) {
                    activateTheme(selectedThemeId);
                }
            });
        }

        // 驻转专 拽
        const deleteBtn = document.getElementById('deleteThemeBtn');
        if (deleteBtn) {
            deleteBtn.addEventListener('click', () => {
                if (selectedThemeId) {
                    deleteTheme(selectedThemeId);
                }
            });
        }

        // 驻住 专专转  (注专)
        const resetBtn = document.getElementById('resetThemeBtn');
        if (resetBtn) {
            resetBtn.addEventListener('click', resetFormToDefaults);
        }

        // 专 驻 爪 注 砖 砖 砖专
        window.addEventListener('beforeunload', (e) => {
            if (hasUnsavedChanges) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        updateFormButtons();
        _resetHistoryFromCurrent();
        _updateUndoRedoButtons();
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
})();
</script>
{% endblock %}
