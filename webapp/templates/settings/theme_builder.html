{% extends "base.html" %}

{% block title %}בונה ערכת נושא - Code Keeper Bot{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='libs/pickr/nano.min.css') }}?v={{ static_version }}" />
{% endblock %}

{% block content %}
<h1 class="page-title">
    <i class="fas fa-palette"></i>
    בונה ערכת נושא
</h1>

<div class="theme-builder-layout">
    <!-- Sidebar: My Themes -->
    <aside class="theme-builder-sidebar glass-card">
        <div class="sidebar-header">
            <h3>
                <i class="fas fa-palette"></i>
                הערכות שלי
            </h3>
            <button type="button" id="createNewThemeBtn" class="btn btn-primary btn-sm">
                <i class="fas fa-plus"></i>
                ערכה חדשה
            </button>
        </div>

        <div id="themesList" class="themes-list">
            <!-- יאוכלס דינמית -->
            <div class="themes-loading">
                <i class="fas fa-spinner fa-spin"></i>
                טוען...
            </div>
        </div>

        <div class="sidebar-footer">
            <small>
                <span id="themesCount">0</span>/<span id="themesMax">10</span> ערכות
            </small>
        </div>
    </aside>

    <!-- Control Panel -->
    <div class="theme-builder-controls glass-card">
        <form id="themeBuilderForm" autocomplete="off">
            <!-- Theme Name -->
            <div class="control-group">
                <label for="themeName">
                    <i class="fas fa-tag"></i>
                    שם הערכה
                </label>
                <input
                    type="text"
                    id="themeName"
                    name="name"
                    maxlength="50"
                    placeholder="הערכה שלי"
                    aria-describedby="themeNameHelp"
                    required
                />
                <small id="themeNameHelp">עד 50 תווים</small>
            </div>

            <!-- Background Colors -->
            <fieldset class="control-section">
                <legend><i class="fas fa-fill-drip"></i> רקעים</legend>

                <div class="color-row">
                    <label for="bgPrimary">רקע ראשי</label>
                    <div class="color-input-wrapper">
                        <input type="text" id="bgPrimaryText" data-var="--bg-primary" class="color-text" />
                        <div id="bgPrimary" class="color-picker" data-var="--bg-primary"></div>
                    </div>
                </div>

                <div class="color-row">
                    <label for="bgSecondary">רקע משני</label>
                    <div class="color-input-wrapper">
                        <input type="text" id="bgSecondaryText" data-var="--bg-secondary" class="color-text" />
                        <div id="bgSecondary" class="color-picker" data-var="--bg-secondary"></div>
                    </div>
                </div>

                <div class="color-row">
                    <label for="cardBg">רקע כרטיסים</label>
                    <div class="color-input-wrapper">
                        <input type="text" id="cardBgText" data-var="--card-bg" class="color-text" />
                        <div id="cardBg" class="color-picker" data-var="--card-bg"></div>
                    </div>
                </div>
            </fieldset>

            <!-- Accent Colors -->
            <fieldset class="control-section">
                <legend><i class="fas fa-star"></i> צבעי אקסנט</legend>

                <div class="color-row">
                    <label for="primary">ראשי (Primary)</label>
                    <div class="color-input-wrapper">
                        <input type="text" id="primaryText" data-var="--primary" class="color-text" />
                        <div id="primary" class="color-picker" data-var="--primary"></div>
                    </div>
                </div>

                <div class="color-row">
                    <label for="secondary">משני (Secondary)</label>
                    <div class="color-input-wrapper">
                        <input type="text" id="secondaryText" data-var="--secondary" class="color-text" />
                        <div id="secondary" class="color-picker" data-var="--secondary"></div>
                    </div>
                </div>
            </fieldset>

            <fieldset class="control-section">
                <legend><i class="fas fa-mouse-pointer"></i> כפתור ראשי</legend>
                
                <div class="color-row">
                    <label for="btnPrimaryBg">צבע רקע</label>
                    <div class="color-input-wrapper">
                        <input type="text" id="btnPrimaryBgText" data-var="--btn-primary-bg" class="color-text" />
                        <div id="btnPrimaryBg" class="color-picker" data-var="--btn-primary-bg"></div>
                    </div>
                </div>

                <div class="color-row">
                    <label for="btnPrimaryColor">צבע טקסט</label>
                    <div class="color-input-wrapper">
                        <input type="text" id="btnPrimaryColorText" data-var="--btn-primary-color" class="color-text" value="#ffffff" />
                        <div id="btnPrimaryColor" class="color-picker" data-var="--btn-primary-color"></div>
                    </div>
                </div>
            </fieldset>

            <!-- Text Colors -->
            <fieldset class="control-section">
                <legend><i class="fas fa-font"></i> טקסט</legend>

                <div class="color-row">
                    <label for="textPrimary">טקסט ראשי</label>
                    <div class="color-input-wrapper">
                        <input type="text" id="textPrimaryText" data-var="--text-primary" class="color-text" />
                        <div id="textPrimary" class="color-picker" data-var="--text-primary"></div>
                    </div>
                </div>
            </fieldset>

            <!-- Glass Controls -->
            <fieldset class="control-section">
                <legend><i class="fas fa-window-maximize"></i> Glass Effect</legend>

                <div class="slider-row">
                    <label for="glassOpacity">שקיפות</label>
                    <input
                        type="range"
                        id="glassOpacity"
                        min="0" max="100"
                        value="10"
                        aria-describedby="glassOpacityValue"
                    />
                    <span id="glassOpacityValue">10%</span>
                </div>

                <div class="slider-row">
                    <label for="glassBlur">טשטוש (Blur)</label>
                    <input
                        type="range"
                        id="glassBlur"
                        min="0" max="40"
                        value="20"
                        aria-describedby="glassBlurValue"
                    />
                    <span id="glassBlurValue">20px</span>
                </div>
            </fieldset>

            <!-- Markdown (stays dark) -->
            <fieldset class="control-section">
                <legend><i class="fas fa-code"></i> Markdown / קוד</legend>

                <div class="color-row">
                    <label for="mdSurface">רקע קוד</label>
                    <div class="color-input-wrapper">
                        <input type="text" id="mdSurfaceText" data-var="--md-surface" class="color-text" />
                        <div id="mdSurface" class="color-picker" data-var="--md-surface"></div>
                    </div>
                </div>

                <div class="color-row">
                    <label for="mdText">טקסט קוד (טקסט ללא הדגשת תחביר)</label>
                    <div class="color-input-wrapper">
                        <input type="text" id="mdTextText" data-var="--md-text" class="color-text" />
                        <div id="mdText" class="color-picker" data-var="--md-text"></div>
                    </div>
                </div>
            </fieldset>

            <!-- Actions -->
            <div class="form-actions">
                <button type="submit" class="btn btn-primary" id="saveThemeBtn">
                    <i class="fas fa-save"></i>
                    שמור שינויים
                </button>
                <button type="button" class="btn btn-success" id="activateThemeBtn">
                    <i class="fas fa-check"></i>
                    הפעל ערכה זו
                </button>
                <button type="button" class="btn btn-secondary" id="resetThemeBtn">
                    <i class="fas fa-undo"></i>
                    איפוס לברירות מחדל
                </button>
                <button type="button" class="btn btn-danger" id="deleteThemeBtn">
                    <i class="fas fa-trash"></i>
                    מחק ערכה
                </button>
            </div>
        </form>
    </div>

    <!-- Live Preview -->
    <div class="theme-builder-preview glass-card">
        <h3>
            <i class="fas fa-eye"></i>
            תצוגה מקדימה
        </h3>

        <div id="theme-preview-container" class="preview-sandbox">
            <!-- Navbar Preview -->
            <nav class="preview-navbar">
                <span class="preview-logo">
                    <i class="fas fa-code"></i>
                    CodeBot
                </span>
                <div class="preview-nav-links">
                    <a href="#">קבצים</a>
                    <a href="#">אוספים</a>
                    <a href="#">הגדרות</a>
                </div>
            </nav>

            <!-- Card Preview -->
            <div class="preview-card">
                <div class="preview-card-header">
                    <i class="fas fa-file-code"></i>
                    <span>example.py</span>
                </div>
                <pre class="preview-code-block"><code>def hello():
    print("Hello, Theme!")
    return True</code></pre>
            </div>

            <!-- Buttons Preview -->
            <div class="preview-buttons">
                <button class="preview-btn-primary">כפתור ראשי</button>
                <button class="preview-btn-secondary">כפתור משני</button>
            </div>

            <!-- Glass Card Preview -->
            <div class="preview-glass-card">
                <p>כרטיס Glass עם טשטוש רקע</p>
            </div>
        </div>
    </div>
</div>

<!-- Toast notifications -->
<div id="theme-toast" class="theme-toast" role="alert" aria-live="polite"></div>

<style>
.theme-builder-layout {
    display: grid;
    grid-template-columns: 280px 1fr 1fr;
    gap: 1.5rem;
    align-items: start;
}

@media (max-width: 1200px) {
    .theme-builder-layout {
        grid-template-columns: 240px 1fr;
    }
    .theme-builder-preview {
        grid-column: 1 / -1;
    }
}

@media (max-width: 768px) {
    .theme-builder-layout {
        grid-template-columns: 1fr;
    }
    .theme-builder-sidebar {
        order: -1;
    }
}

.theme-builder-controls {
    position: sticky;
    top: 1rem;
}

/* Sidebar Styles */
.theme-builder-sidebar {
    position: sticky;
    top: 1rem;
    max-height: calc(100vh - 2rem);
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.sidebar-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--glass-border);
    margin-bottom: 1rem;
}

.sidebar-header h3 {
    margin: 0;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.sidebar-header .btn-sm {
    padding: 0.4rem 0.8rem;
    font-size: 0.85rem;
}

/* Themes List */
.themes-list {
    flex: 1;
    overflow-y: auto;
    padding-right: 0.5rem;
}

.themes-loading {
    text-align: center;
    padding: 2rem;
    color: var(--text-secondary);
}

.theme-item {
    display: flex;
    align-items: center;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    border-radius: 10px;
    background: var(--glass);
    border: 1px solid transparent;
    cursor: pointer;
    transition: all 0.2s ease;
}

.theme-item:hover {
    background: var(--glass-hover);
    border-color: var(--glass-border);
}

.theme-item.active {
    border-color: var(--primary);
    background: color-mix(in srgb, var(--primary) 15%, transparent);
}

.theme-item.selected {
    border-color: var(--secondary);
    box-shadow: 0 0 0 2px color-mix(in srgb, var(--secondary) 30%, transparent);
}

.theme-item-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-left: 0.75rem;
    flex-shrink: 0;
}

.theme-item.active .theme-item-indicator {
    background: var(--success);
    box-shadow: 0 0 6px var(--success);
}

.theme-item:not(.active) .theme-item-indicator {
    background: var(--glass-border);
}

.theme-item-content {
    flex: 1;
    min-width: 0;
}

.theme-item-name {
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: var(--text-primary);
}

.theme-item-meta {
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin-top: 0.25rem;
}

.theme-item-actions {
    display: flex;
    gap: 0.25rem;
    opacity: 0;
    transition: opacity 0.2s;
}

.theme-item:hover .theme-item-actions {
    opacity: 1;
}

.theme-item-btn {
    width: 28px;
    height: 28px;
    border-radius: 6px;
    border: none;
    background: var(--glass);
    color: var(--text-secondary);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    transition: all 0.2s;
}

.theme-item-btn:hover {
    background: var(--glass-hover);
    color: var(--text-primary);
}

.theme-item-btn.danger:hover {
    background: var(--danger);
    color: white;
}

/* Sidebar Footer */
.sidebar-footer {
    padding-top: 1rem;
    border-top: 1px solid var(--glass-border);
    margin-top: auto;
    text-align: center;
    color: var(--text-secondary);
}

/* Empty State */
.themes-empty {
    text-align: center;
    padding: 2rem 1rem;
    color: var(--text-secondary);
}

.themes-empty i {
    font-size: 2rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.themes-empty p {
    margin: 0;
}

.control-group {
    margin-bottom: 1.5rem;
}

.control-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
}

.control-group input[type="text"] {
    width: 100%;
    padding: 0.75rem;
    border-radius: 10px;
    border: 1px solid var(--glass-border);
    background: var(--glass);
    color: var(--text-primary);
}

.control-section {
    border: 1px solid var(--glass-border);
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1.5rem;
}

.control-section legend {
    padding: 0 0.5rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.color-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
}

.color-row label {
    flex: 1;
}

.color-input-wrapper {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.color-text {
    width: 100px;
    padding: 0.4rem;
    border-radius: 6px;
    border: 1px solid var(--glass-border);
    background: var(--glass);
    color: var(--text-primary);
    font-family: monospace;
    font-size: 0.85rem;
}

.color-picker {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    cursor: pointer;
    border: 2px solid var(--glass-border);
}

.slider-row {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

.slider-row label {
    flex: 1;
}

.slider-row input[type="range"] {
    flex: 2;
}

.slider-row span {
    min-width: 50px;
    text-align: left;
    font-family: monospace;
}

.form-actions {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    margin-top: 2rem;
}

/* Preview Sandbox - isolated styles */
.preview-sandbox {
    background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
    border-radius: 12px;
    padding: 1rem;
    min-height: 400px;
}

.preview-navbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    background: var(--glass);
    backdrop-filter: blur(var(--glass-blur, 20px));
    border-radius: 10px;
    margin-bottom: 1rem;
}

.preview-logo {
    font-weight: 700;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.preview-nav-links {
    display: flex;
    gap: 1rem;
}

.preview-nav-links a {
    color: var(--text-primary);
    text-decoration: none;
    opacity: 0.85;
}

.preview-card {
    background: var(--card-bg);
    border: 1px solid var(--glass-border);
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.preview-card-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
    color: var(--text-primary);
    font-weight: 600;
}

.preview-code-block {
    background: var(--md-surface);
    color: var(--md-text);
    padding: 1rem;
    border-radius: 8px;
    font-family: 'Fira Code', monospace;
    font-size: 0.85rem;
    overflow-x: auto;
}

.preview-buttons {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
}

.preview-btn-primary {
    background: var(--btn-primary-bg, var(--primary));
    color: var(--btn-primary-color, white);
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
}

.preview-btn-secondary {
    background: var(--glass);
    color: var(--text-primary);
    border: 1px solid var(--glass-border);
    padding: 0.75rem 1.5rem;
    border-radius: 10px;
    cursor: pointer;
}

.preview-glass-card {
    background: var(--glass);
    backdrop-filter: blur(var(--glass-blur, 20px));
    border: 1px solid var(--glass-border);
    border-radius: 12px;
    padding: 1rem;
    color: var(--text-primary);
}

/* Toast */
.theme-toast {
    position: fixed;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: var(--card-bg);
    color: var(--text-primary);
    padding: 1rem 2rem;
    border-radius: 10px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    opacity: 0;
    transition: transform 0.3s ease, opacity 0.3s ease;
    z-index: 9999;
}

.theme-toast.visible {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
}

.theme-toast.error {
    background: var(--danger);
    color: white;
}

.theme-toast.success {
    background: var(--success);
    color: white;
}
</style>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='libs/pickr/pickr.min.js') }}?v={{ static_version }}"></script>

<script>
(function() {
    'use strict';

    // ========== Configuration ==========
    const DEFAULT_VALUES = {
        '--bg-primary': '#6b63ff',
        '--bg-secondary': '#8e63ff',
        '--card-bg': 'rgba(255, 255, 255, 0.12)',
        '--primary': '#667eea',
        '--secondary': '#764ba2',
        '--btn-primary-bg': '#667eea',
        '--btn-primary-color': '#ffffff',
        '--text-primary': '#ffffff',
        '--glass': 'rgba(255, 255, 255, 0.1)',
        '--glass-border': 'rgba(255, 255, 255, 0.2)',
        '--glass-hover': 'rgba(255, 255, 255, 0.15)',
        '--glass-blur': '20px',
        '--md-surface': '#1b1e24',
        '--md-text': '#f0f0f0',
    };

    const VAR_MAP = {
        'bgPrimary': '--bg-primary',
        'bgSecondary': '--bg-secondary',
        'cardBg': '--card-bg',
        'primary': '--primary',
        'secondary': '--secondary',
        'textPrimary': '--text-primary',
        'mdSurface': '--md-surface',
        'mdText': '--md-text',
        'btnPrimaryBg': '--btn-primary-bg',
        'btnPrimaryColor': '--btn-primary-color',
    };

    // ========== State ==========
    let currentThemes = [];
    let selectedThemeId = null;
    let isNewTheme = false;
    let hasUnsavedChanges = false;

    // ========== DOM Elements ==========
    const themesList = document.getElementById('themesList');
    const themesCount = document.getElementById('themesCount');
    const themesMax = document.getElementById('themesMax');
    const createNewBtn = document.getElementById('createNewThemeBtn');

    const previewContainer = document.getElementById('theme-preview-container');
    const pickrInstances = {};

    // ========== Toast ==========
    function showToast(message, type = 'info') {
        const toast = document.getElementById('theme-toast');
        toast.textContent = message;
        toast.className = 'theme-toast visible ' + type;
        setTimeout(() => {
            toast.classList.remove('visible');
        }, 3000);
    }

    // ========== Preview Update ==========
    function updatePreview(varName, value) {
        if (!previewContainer) return;
        previewContainer.style.setProperty(varName, value);
    }

    // ========== Contrast (WCAG 2.1) ==========
    function _hexToRgb(hex) {
        const h = String(hex || '').trim().replace('#', '');
        if (h.length !== 6) return null;
        const r = parseInt(h.slice(0, 2), 16);
        const g = parseInt(h.slice(2, 4), 16);
        const b = parseInt(h.slice(4, 6), 16);
        if ([r, g, b].some((v) => Number.isNaN(v))) return null;
        return { r, g, b };
    }

    function _luminance({ r, g, b }) {
        const srgb = [r, g, b].map((v) => v / 255);
        const lin = srgb.map((c) => (c <= 0.03928 ? c / 12.92 : Math.pow((c + 0.055) / 1.055, 2.4)));
        return 0.2126 * lin[0] + 0.7152 * lin[1] + 0.0722 * lin[2];
    }

    function checkContrast(fgHex, bgHex) {
        const fg = _hexToRgb(fgHex);
        const bg = _hexToRgb(bgHex);
        if (!fg || !bg) return null;
        const l1 = _luminance(fg);
        const l2 = _luminance(bg);
        const lighter = Math.max(l1, l2);
        const darker = Math.min(l1, l2);
        return (lighter + 0.05) / (darker + 0.05);
    }

    // ========== Pickr Initialization ==========
    function initColorPicker(elementId, varName) {
        const el = document.getElementById(elementId);
        if (!el) return null;

        const textInput = document.getElementById(elementId + 'Text');
        const initialColor = DEFAULT_VALUES[varName] || '#ffffff';

        const pickr = Pickr.create({
            el: el,
            theme: 'nano',
            default: initialColor,
            components: {
                preview: true,
                opacity: true,
                hue: true,
                interaction: {
                    hex: true,
                    rgba: true,
                    input: true,
                    save: true,
                }
            }
        });

        pickr.on('change', (color) => {
            const rgba = color.toRGBA();
            const value = rgba[3] < 1
                ? `rgba(${Math.round(rgba[0])}, ${Math.round(rgba[1])}, ${Math.round(rgba[2])}, ${rgba[3].toFixed(2)})`
                : color.toHEXA().toString();

            if (textInput) textInput.value = value;
            updatePreview(varName, value);
            hasUnsavedChanges = true;
        });

        pickr.on('save', () => pickr.hide());

        // Sync text input
        if (textInput) {
            textInput.value = initialColor;
            textInput.addEventListener('change', () => {
                const val = textInput.value.trim();
                if (val) {
                    try {
                        pickr.setColor(val);
                        updatePreview(varName, val);
                        hasUnsavedChanges = true;
                    } catch (e) {
                        // ignore invalid color
                    }
                }
            });
        }

        // Initial preview
        updatePreview(varName, initialColor);

        return pickr;
    }

    // ========== Initialize All Pickers ==========
    function initAllPickers() {
        pickrInstances['bgPrimary'] = initColorPicker('bgPrimary', '--bg-primary');
        pickrInstances['bgSecondary'] = initColorPicker('bgSecondary', '--bg-secondary');
        pickrInstances['cardBg'] = initColorPicker('cardBg', '--card-bg');
        pickrInstances['primary'] = initColorPicker('primary', '--primary');
        pickrInstances['secondary'] = initColorPicker('secondary', '--secondary');
        pickrInstances['textPrimary'] = initColorPicker('textPrimary', '--text-primary');
        pickrInstances['mdSurface'] = initColorPicker('mdSurface', '--md-surface');
        pickrInstances['mdText'] = initColorPicker('mdText', '--md-text');
        pickrInstances['btnPrimaryBg'] = initColorPicker('btnPrimaryBg', '--btn-primary-bg');
        pickrInstances['btnPrimaryColor'] = initColorPicker('btnPrimaryColor', '--btn-primary-color');
    }

    // ========== Glass Sliders ==========
    function initGlassSliders() {
        const opacitySlider = document.getElementById('glassOpacity');
        const opacityValue = document.getElementById('glassOpacityValue');
        const blurSlider = document.getElementById('glassBlur');
        const blurValue = document.getElementById('glassBlurValue');

        opacitySlider.addEventListener('input', () => {
            const val = opacitySlider.value;
            opacityValue.textContent = val + '%';
            const rgba = `rgba(255, 255, 255, ${(val / 100).toFixed(2)})`;
            updatePreview('--glass', rgba);
            hasUnsavedChanges = true;
        });

        blurSlider.addEventListener('input', () => {
            const val = blurSlider.value;
            blurValue.textContent = val + 'px';
            updatePreview('--glass-blur', val + 'px');
            hasUnsavedChanges = true;
        });

        // Initial update
        opacityValue.textContent = opacitySlider.value + '%';
        blurValue.textContent = blurSlider.value + 'px';
        updatePreview('--glass', `rgba(255, 255, 255, ${(opacitySlider.value / 100).toFixed(2)})`);
        updatePreview('--glass-blur', blurSlider.value + 'px');
    }

    // ========== Collect Values ==========
    function collectThemeValues() {
        const variables = {};

        // Colors from pickr
        for (const [pickrId, varName] of Object.entries(VAR_MAP)) {
            const textInput = document.getElementById(pickrId + 'Text');
            if (textInput && textInput.value) {
                variables[varName] = textInput.value.trim();
            }
        }

        // Glass - use card-bg color as base for glass effect (not hardcoded white)
        const opacitySlider = document.getElementById('glassOpacity');
        const blurSlider = document.getElementById('glassBlur');
        const opacityVal = parseInt(opacitySlider.value, 10);
        // Clamp alpha values to valid 0-1 range
        const glassAlpha = (opacityVal / 100).toFixed(2);
        const borderAlpha = Math.min(1, (opacityVal + 10) / 100).toFixed(2);
        const hoverAlpha = Math.min(1, (opacityVal + 5) / 100).toFixed(2);

        // Extract RGB values from card-bg or use a smart fallback
        const cardBgInput = document.getElementById('cardBgText');
        const cardBgValue = cardBgInput?.value?.trim() || '';
        const glassBaseRgb = parseColorToRgb(cardBgValue) || { r: 255, g: 255, b: 255 };

        variables['--glass'] = `rgba(${glassBaseRgb.r}, ${glassBaseRgb.g}, ${glassBaseRgb.b}, ${glassAlpha})`;
        variables['--glass-border'] = `rgba(${glassBaseRgb.r}, ${glassBaseRgb.g}, ${glassBaseRgb.b}, ${borderAlpha})`;
        variables['--glass-hover'] = `rgba(${glassBaseRgb.r}, ${glassBaseRgb.g}, ${glassBaseRgb.b}, ${hoverAlpha})`;
        variables['--glass-blur'] = blurSlider.value + 'px';

        // Add --card-border based on glass-border for consistency
        variables['--card-border'] = variables['--glass-border'];

        return variables;
    }

    // Helper: parse hex or rgba color to RGB object
    function parseColorToRgb(colorStr) {
        if (!colorStr) return null;
        colorStr = colorStr.trim();

        // Handle hex (#rrggbb or #rgb)
        if (colorStr.startsWith('#')) {
            const hex = colorStr.slice(1);
            if (hex.length === 3) {
                return {
                    r: parseInt(hex[0] + hex[0], 16),
                    g: parseInt(hex[1] + hex[1], 16),
                    b: parseInt(hex[2] + hex[2], 16)
                };
            } else if (hex.length === 6) {
                return {
                    r: parseInt(hex.slice(0, 2), 16),
                    g: parseInt(hex.slice(2, 4), 16),
                    b: parseInt(hex.slice(4, 6), 16)
                };
            }
        }

        // Handle rgba(r, g, b, a) or rgb(r, g, b)
        const rgbaMatch = colorStr.match(/rgba?\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)/i);
        if (rgbaMatch) {
            return {
                r: parseInt(rgbaMatch[1], 10),
                g: parseInt(rgbaMatch[2], 10),
                b: parseInt(rgbaMatch[3], 10)
            };
        }

        return null;
    }

    // ========== API Functions ==========
    async function fetchThemes() {
        if (!themesList) return;
        try {
            const res = await fetch('/api/themes');
            const data = await res.json();

            if (!res.ok || !data.ok) {
                throw new Error(data.error || 'fetch_failed');
            }

            currentThemes = data.themes || [];
            if (themesMax) themesMax.textContent = data.max_allowed;

            renderThemesList();

            // בחר את הערכה הפעילה (או הראשונה)
            const stillExists = selectedThemeId && currentThemes.some((t) => t.id === selectedThemeId);
            if (stillExists) {
                // keep selection
                await selectTheme(selectedThemeId);
                return;
            }

            const activeTheme = currentThemes.find(t => t.is_active);
            if (activeTheme) {
                await selectTheme(activeTheme.id);
            } else if (currentThemes.length > 0) {
                await selectTheme(currentThemes[0].id);
            } else {
                clearFormForNewTheme();
            }

        } catch (err) {
            console.error('Failed to fetch themes:', err);
            showToast('שגיאה בטעינת הערכות', 'error');
        }
    }

    async function fetchThemeDetails(themeId) {
        try {
            const res = await fetch(`/api/themes/${themeId}`);
            const data = await res.json();

            if (!res.ok || !data.ok) {
                throw new Error(data.error || 'fetch_failed');
            }

            return data.theme;

        } catch (err) {
            console.error('Failed to fetch theme details:', err);
            showToast('שגיאה בטעינת פרטי הערכה', 'error');
            return null;
        }
    }

    async function createNewTheme(themeData) {
        try {
            const res = await fetch('/api/themes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(themeData)
            });

            const data = await res.json();

            if (!res.ok || !data.ok) {
                throw new Error(data.error || 'create_failed');
            }

            showToast('הערכה נוצרה בהצלחה!', 'success');
            return data.theme_id;

        } catch (err) {
            console.error('Failed to create theme:', err);
            let msg = 'שגיאה ביצירת הערכה';
            if (err.message === 'max_themes_reached') msg = `הגעת למגבלת הערכות (${themesMax?.textContent || '10'})`;
            if (err.message === 'invalid_color') msg = 'אחד הצבעים אינו תקין';
            if (err.message === 'name_too_long') msg = 'השם ארוך מדי (עד 50 תווים)';
            showToast(msg, 'error');
            return null;
        }
    }

    async function updateExistingTheme(themeId, themeData) {
        try {
            const res = await fetch(`/api/themes/${themeId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(themeData)
            });

            const data = await res.json();

            if (!res.ok || !data.ok) {
                throw new Error(data.error || 'update_failed');
            }

            showToast('הערכה עודכנה בהצלחה!', 'success');
            return true;

        } catch (err) {
            console.error('Failed to update theme:', err);
            showToast('שגיאה בעדכון הערכה', 'error');
            return false;
        }
    }

    async function activateTheme(themeId) {
        try {
            const res = await fetch(`/api/themes/${themeId}/activate`, { method: 'POST' });
            const data = await res.json();

            if (!res.ok || !data.ok) {
                throw new Error(data.error || 'activate_failed');
            }

            showToast('הערכה הופעלה! מרענן...', 'success');
            setTimeout(() => location.reload(), 1000);

        } catch (err) {
            console.error('Failed to activate theme:', err);
            showToast('שגיאה בהפעלת הערכה', 'error');
        }
    }

    async function deleteTheme(themeId) {
        if (!confirm('האם למחוק את הערכה? פעולה זו אינה ניתנת לביטול.')) {
            return;
        }

        try {
            const res = await fetch(`/api/themes/${themeId}`, { method: 'DELETE' });
            const data = await res.json();

            if (!res.ok || !data.ok) {
                throw new Error(data.error || 'delete_failed');
            }

            showToast('הערכה נמחקה', 'success');

            if (data.was_active) {
                setTimeout(() => location.reload(), 1000);
            } else {
                await fetchThemes();
            }

        } catch (err) {
            console.error('Failed to delete theme:', err);
            showToast('שגיאה במחיקת הערכה', 'error');
        }
    }

    // ========== Render Functions ==========
    function renderThemesList() {
        if (!themesList) return;
        if (themesCount) themesCount.textContent = currentThemes.length;

        if (currentThemes.length === 0) {
            themesList.innerHTML = `
                <div class="themes-empty">
                    <i class="fas fa-palette"></i>
                    <p>עדיין אין לך ערכות מותאמות</p>
                    <p><small>לחץ "ערכה חדשה" ליצירת הראשונה</small></p>
                </div>
            `;
            return;
        }

        themesList.innerHTML = currentThemes.map(theme => `
            <div class="theme-item ${theme.is_active ? 'active' : ''} ${selectedThemeId === theme.id ? 'selected' : ''}"
                 data-theme-id="${theme.id}">
                <div class="theme-item-indicator" title="${theme.is_active ? 'ערכה פעילה' : ''}"></div>
                <div class="theme-item-content">
                    <div class="theme-item-name">${escapeHtml(theme.name)}</div>
                    <div class="theme-item-meta">
                        ${theme.is_active ? '<i class="fas fa-check-circle"></i> פעילה' : ''}
                        ${!theme.is_active && theme.updated_at ? formatDate(theme.updated_at) : ''}
                    </div>
                </div>
                <div class="theme-item-actions">
                    ${!theme.is_active ? `
                        <button type="button" class="theme-item-btn activate-btn"
                                title="הפעל ערכה" data-action="activate">
                            <i class="fas fa-check"></i>
                        </button>
                    ` : ''}
                    <button type="button" class="theme-item-btn danger delete-btn"
                            title="מחק ערכה" data-action="delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');

        themesList.querySelectorAll('.theme-item').forEach(item => {
            item.addEventListener('click', (e) => {
                const action = e.target.closest('[data-action]')?.dataset.action;
                const themeId = item.dataset.themeId;

                if (action === 'activate') {
                    activateTheme(themeId);
                } else if (action === 'delete') {
                    deleteTheme(themeId);
                } else {
                    selectTheme(themeId);
                }
            });
        });
    }

    function setFormDisabled(disabled) {
        const form = document.getElementById('themeBuilderForm');
        if (!form) return;
        form.querySelectorAll('input, button').forEach((el) => {
            el.disabled = !!disabled;
        });
        // תמיד נשאיר את כפתור "ערכה חדשה" פעיל
        if (createNewBtn) createNewBtn.disabled = false;
    }

    async function selectTheme(themeId) {
        if (!themeId) return;
        if (hasUnsavedChanges && !confirm('יש שינויים שלא נשמרו. להמשיך?')) {
            return;
        }

        selectedThemeId = themeId;
        isNewTheme = false;
        renderThemesList();

        setFormDisabled(true);
        const theme = await fetchThemeDetails(themeId);
        if (theme) {
            loadThemeIntoForm(theme);
        }
        setFormDisabled(false);

        hasUnsavedChanges = false;
        updateFormButtons();
    }

    function loadThemeIntoForm(theme) {
        const nameEl = document.getElementById('themeName');
        if (nameEl) nameEl.value = theme.name || '';

        const variables = theme.variables || {};

        Object.entries(VAR_MAP).forEach(([pickrId, varName]) => {
            const textInput = document.getElementById(pickrId + 'Text');
            const value = variables[varName] || DEFAULT_VALUES[varName];

            if (textInput) {
                textInput.value = value;
            }
            if (pickrInstances[pickrId]) {
                try {
                    pickrInstances[pickrId].setColor(value);
                } catch (e) {}
            }
            updatePreview(varName, value);
        });

        // Glass sliders
        if (variables['--glass']) {
            const match = String(variables['--glass']).match(/[\d.]+(?=\))/);
            if (match) {
                const opacitySlider = document.getElementById('glassOpacity');
                const v = Math.round(parseFloat(match[0]) * 100);
                if (opacitySlider) opacitySlider.value = v;
                const opacityValue = document.getElementById('glassOpacityValue');
                if (opacityValue) opacityValue.textContent = v + '%';
                updatePreview('--glass', String(variables['--glass']));
            }
        }

        if (variables['--glass-blur']) {
            const blurSlider = document.getElementById('glassBlur');
            const vRaw = String(variables['--glass-blur']);
            const v = parseInt(vRaw, 10);
            if (blurSlider) blurSlider.value = v;
            const blurValue = document.getElementById('glassBlurValue');
            if (blurValue) blurValue.textContent = v + 'px';
            updatePreview('--glass-blur', vRaw);
        }
    }

    function clearFormForNewTheme() {
        if (hasUnsavedChanges && !confirm('יש שינויים שלא נשמרו. להמשיך?')) {
            return;
        }

        selectedThemeId = null;
        isNewTheme = true;
        renderThemesList();

        const nameEl = document.getElementById('themeName');
        if (nameEl) {
            nameEl.value = '';
            nameEl.focus();
        }

        Object.entries(VAR_MAP).forEach(([pickrId, varName]) => {
            const textInput = document.getElementById(pickrId + 'Text');
            const value = DEFAULT_VALUES[varName];
            if (textInput) textInput.value = value;
            if (pickrInstances[pickrId]) {
                try { pickrInstances[pickrId].setColor(value); } catch (e) {}
            }
            updatePreview(varName, value);
        });

        // Reset glass sliders
        const opacitySlider = document.getElementById('glassOpacity');
        if (opacitySlider) opacitySlider.value = 10;
        const opacityValue = document.getElementById('glassOpacityValue');
        if (opacityValue) opacityValue.textContent = '10%';

        const blurSlider = document.getElementById('glassBlur');
        if (blurSlider) blurSlider.value = 20;
        const blurValue = document.getElementById('glassBlurValue');
        if (blurValue) blurValue.textContent = '20px';

        updatePreview('--glass', 'rgba(255, 255, 255, 0.10)');
        updatePreview('--glass-blur', '20px');

        hasUnsavedChanges = false;
        updateFormButtons();
    }

    function updateFormButtons() {
        const saveBtn = document.getElementById('saveThemeBtn');
        const activateBtn = document.getElementById('activateThemeBtn');
        const deleteBtn = document.getElementById('deleteThemeBtn');

        if (isNewTheme) {
            if (saveBtn) saveBtn.innerHTML = '<i class="fas fa-plus"></i> צור ערכה';
            if (activateBtn) activateBtn.disabled = true;
            if (deleteBtn) deleteBtn.disabled = true;
        } else {
            if (saveBtn) saveBtn.innerHTML = '<i class="fas fa-save"></i> שמור שינויים';
            if (activateBtn) activateBtn.disabled = !selectedThemeId;
            if (deleteBtn) deleteBtn.disabled = !selectedThemeId;
        }
    }

    // ========== Save Handler ==========
    async function handleSave(e) {
        e.preventDefault();

        const nameEl = document.getElementById('themeName');
        const name = (nameEl?.value || '').trim();
        if (!name) {
            showToast('נא להזין שם לערכה', 'error');
            if (nameEl) nameEl.focus();
            return;
        }

        const variables = collectThemeValues();

        // נגישות: בדיקת ניגודיות בסיסית (כאשר הערכים הם hex)
        try {
            const warnings = [];
            const ratio = checkContrast(variables['--text-primary'], variables['--bg-primary']);
            if (typeof ratio === 'number' && ratio < 4.5) {
                warnings.push(`ניגודיות טקסט/רקע נמוכה (${ratio.toFixed(1)}:1)`);
            }
            if (warnings.length && !confirm('נמצאו בעיות נגישות:\n' + warnings.join('\n') + '\n\nלהמשיך בכל זאת?')) {
                return;
            }
        } catch (_) {}

        if (isNewTheme) {
            const newId = await createNewTheme({
                name: name,
                variables: variables,
                activate: false
            });
            if (newId) {
                isNewTheme = false;
                selectedThemeId = newId;
                await fetchThemes();
                await selectTheme(newId);
            }
        } else {
            const ok = await updateExistingTheme(selectedThemeId, { name: name, variables: variables });
            if (ok) {
                await fetchThemes();
            }
        }

        hasUnsavedChanges = false;
        updateFormButtons();
    }

    // ========== Reset Form (Defaults) ==========
    function resetFormToDefaults() {
        if (!confirm('לאפס את הערכים לברירות מחדל? (לא שומר אוטומטית)')) {
            return;
        }

        Object.entries(VAR_MAP).forEach(([pickrId, varName]) => {
            const textInput = document.getElementById(pickrId + 'Text');
            const value = DEFAULT_VALUES[varName];
            if (textInput) textInput.value = value;
            if (pickrInstances[pickrId]) {
                try { pickrInstances[pickrId].setColor(value); } catch (e) {}
            }
            updatePreview(varName, value);
        });

        const opacitySlider = document.getElementById('glassOpacity');
        if (opacitySlider) opacitySlider.value = 10;
        const opacityValue = document.getElementById('glassOpacityValue');
        if (opacityValue) opacityValue.textContent = '10%';

        const blurSlider = document.getElementById('glassBlur');
        if (blurSlider) blurSlider.value = 20;
        const blurValue = document.getElementById('glassBlurValue');
        if (blurValue) blurValue.textContent = '20px';

        updatePreview('--glass', 'rgba(255, 255, 255, 0.10)');
        updatePreview('--glass-blur', '20px');

        hasUnsavedChanges = true;
    }

    // ========== Utilities ==========
    function escapeHtml(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    function formatDate(isoString) {
        try {
            const date = new Date(isoString);
            return date.toLocaleDateString('he-IL', { day: 'numeric', month: 'short' });
        } catch (e) {
            return '';
        }
    }

    // ========== Init ==========
    function init() {
        initAllPickers();
        initGlassSliders();

        // טען רשימת ערכות
        fetchThemes();

        if (createNewBtn) {
            createNewBtn.addEventListener('click', clearFormForNewTheme);
        }

        // מעקב אחר שינויים
        document.querySelectorAll('.color-text, #themeName').forEach(input => {
            input.addEventListener('input', () => {
                hasUnsavedChanges = true;
            });
        });
        document.querySelectorAll('input[type="range"]').forEach(slider => {
            slider.addEventListener('input', () => {
                hasUnsavedChanges = true;
            });
        });

        // שמירה (create/update)
        document.getElementById('themeBuilderForm').addEventListener('submit', handleSave);

        // כפתור הפעלה
        const activateBtn = document.getElementById('activateThemeBtn');
        if (activateBtn) {
            activateBtn.addEventListener('click', () => {
                if (selectedThemeId) {
                    activateTheme(selectedThemeId);
                }
            });
        }

        // כפתור מחיקה
        const deleteBtn = document.getElementById('deleteThemeBtn');
        if (deleteBtn) {
            deleteBtn.addEventListener('click', () => {
                if (selectedThemeId) {
                    deleteTheme(selectedThemeId);
                }
            });
        }

        // איפוס לברירות מחדל (ערכים)
        const resetBtn = document.getElementById('resetThemeBtn');
        if (resetBtn) {
            resetBtn.addEventListener('click', resetFormToDefaults);
        }

        // אזהרה לפני יציאה עם שינויים שלא נשמרו
        window.addEventListener('beforeunload', (e) => {
            if (hasUnsavedChanges) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        updateFormButtons();
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
})();
</script>
{% endblock %}
