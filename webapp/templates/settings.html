{% extends "base.html" %}

{% block title %}הגדרות - Code Keeper Bot{% endblock %}

{% block content %}
<h1 class="page-title">
    <i class="fas fa-cog"></i>
    הגדרות
</h1>

<div class="glass-card">
    <h2 class="section-title">
        <i class="fas fa-user"></i>
        פרטי משתמש
    </h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
        <div>
            <label style="opacity: 0.7;">מזהה משתמש</label>
            <p style="font-size: 1.1rem;">{{ user.id }}</p>
        </div>
        <div>
            <label style="opacity: 0.7;">שם משתמש</label>
            <p style="font-size: 1.1rem;">@{{ user.username or 'לא מוגדר' }}</p>
        </div>
        <div>
            <label style="opacity: 0.7;">סטטוס</label>
            <p style="font-size: 1.1rem;">
                {% if is_admin %}
                <span class="badge" style="background: var(--success);">
                    <i class="fas fa-crown"></i> אדמין
                </span>
                {% else %}
                <span class="badge">משתמש רגיל</span>
                {% endif %}
            </p>
        </div>
    </div>
</div>

{% if is_admin %}
<div class="glass-card" style="border: 2px solid var(--warning);">
    <h2 class="section-title">
        <i class="fab fa-github"></i>
        הגדרות GitHub (אדמין בלבד)
    </h2>
    
    <div class="alert alert-info" style="background: rgba(66, 153, 225, 0.1); border: 1px solid rgba(66, 153, 225, 0.3); padding: 1rem; border-radius: 10px; margin-bottom: 2rem;">
        <i class="fas fa-info-circle"></i>
        <strong>הערה:</strong> הטוקן נשמר מוצפן במסד הנתונים ומשמש לגישה ל-GitHub API.
        הטוקן נשאר פעיל בין התחברויות ולא צריך להזין אותו כל פעם.
    </div>
    
    {% if github_token_exists %}
    <div style="background: rgba(72, 187, 120, 0.1); border: 1px solid rgba(72, 187, 120, 0.3); padding: 1.5rem; border-radius: 10px; margin-bottom: 2rem;">
        <div style="display: flex; align-items: center; gap: 1rem;">
            <i class="fas fa-check-circle" style="color: var(--success); font-size: 2rem;"></i>
            <div style="flex: 1;">
                <h3 style="margin: 0;">טוקן GitHub פעיל</h3>
                <p style="margin: 0.5rem 0; opacity: 0.8;">הטוקן שלך שמור ומוצפן במערכת</p>
            </div>
            <button onclick="deleteGitHubToken()" class="btn btn-danger btn-icon">
                <i class="fas fa-trash"></i>
                מחק טוקן
            </button>
        </div>
    </div>
    {% else %}
    <div id="tokenForm">
        <div style="margin-bottom: 1rem;">
            <label for="githubToken" style="display: block; margin-bottom: 0.5rem;">
                <i class="fas fa-key"></i>
                Personal Access Token
            </label>
            <input type="password" id="githubToken" 
                   placeholder="ghp_... או github_pat_..." 
                   style="width: 100%; padding: 0.75rem; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: white; font-size: 1rem;">
            <small style="opacity: 0.7; display: block; margin-top: 0.5rem;">
                צור טוקן חדש ב-<a href="https://github.com/settings/tokens/new" target="_blank" style="color: var(--info);">GitHub Settings</a>
                עם הרשאות: repo, read:user
            </small>
        </div>
        
        <button onclick="saveGitHubToken()" class="btn btn-primary btn-icon">
            <i class="fas fa-save"></i>
            שמור טוקן
        </button>
    </div>
    {% endif %}
    
    <div id="tokenMessage" style="display: none; margin-top: 1rem; padding: 1rem; border-radius: 10px;"></div>
</div>

<div class="glass-card">
    <h2 class="section-title">
        <i class="fas fa-shield-alt"></i>
        אבטחה
    </h2>
    <p style="opacity: 0.8;">
        <i class="fas fa-lock"></i>
        כל הטוקנים והמידע הרגיש מוצפנים בצד השרת באמצעות AES-256
    </p>
    <p style="opacity: 0.8;">
        <i class="fas fa-server"></i>
        הטוקנים לא נשמרים בדפדפן ולא נחשפים ב-JavaScript
    </p>
    <p style="opacity: 0.8;">
        <i class="fas fa-user-shield"></i>
        רק משתמשי אדמין יכולים לשמור טוקנים קבועים
    </p>
</div>
{% endif %}

<div class="glass-card">
    <h2 class="section-title">
        <i class="fas fa-palette"></i>
        העדפות תצוגה
    </h2>
    <p style="opacity: 0.7;">בקרוב...</p>
</div>

<script>
async function saveGitHubToken() {
    const token = document.getElementById('githubToken').value.trim();
    const messageDiv = document.getElementById('tokenMessage');
    
    if (!token) {
        showMessage('אנא הזן טוקן', 'error');
        return;
    }
    
    if (!token.startsWith('ghp_') && !token.startsWith('github_pat_')) {
        showMessage('פורמט טוקן לא תקין. הטוקן צריך להתחיל ב-ghp_ או github_pat_', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/settings/github-token', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ token })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showMessage('הטוקן נשמר בהצלחה! הדף יתרענן...', 'success');
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            showMessage(data.error || 'שגיאה בשמירת הטוקן', 'error');
        }
    } catch (error) {
        showMessage('שגיאת תקשורת', 'error');
    }
}

async function deleteGitHubToken() {
    if (!confirm('האם אתה בטוח שברצונך למחוק את הטוקן?')) {
        return;
    }
    
    try {
        const response = await fetch('/api/settings/github-token', {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showMessage('הטוקן נמחק בהצלחה! הדף יתרענן...', 'success');
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            showMessage(data.error || 'שגיאה במחיקת הטוקן', 'error');
        }
    } catch (error) {
        showMessage('שגיאת תקשורת', 'error');
    }
}

function showMessage(message, type) {
    const messageDiv = document.getElementById('tokenMessage');
    messageDiv.style.display = 'block';
    messageDiv.className = type === 'error' ? 'alert alert-error' : 'alert alert-success';
    messageDiv.style.background = type === 'error' 
        ? 'rgba(245, 101, 101, 0.1)' 
        : 'rgba(72, 187, 120, 0.1)';
    messageDiv.style.border = `1px solid ${type === 'error' ? 'rgba(245, 101, 101, 0.3)' : 'rgba(72, 187, 120, 0.3)'}`;
    messageDiv.innerHTML = `<i class="fas fa-${type === 'error' ? 'exclamation-triangle' : 'check-circle'}"></i> ${message}`;
}
</script>

<style>
.btn-danger {
    background: linear-gradient(135deg, var(--danger), #c53030);
}

.btn-danger:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(245, 101, 101, 0.3);
}

.alert {
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>
{% endblock %}