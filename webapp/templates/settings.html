{% extends "base.html" %} {% block title %}×”×’×“×¨×•×ª - Code Keeper Bot{% endblock
%} {% block content %}
<h1 class="page-title">
  <i class="fas fa-cog"></i>
  ×”×’×“×¨×•×ª
</h1>

<div class="glass-card">
  <h2 class="section-title">
    <i class="fas fa-user"></i>
    ×¤×¨×˜×™ ×—×©×‘×•×Ÿ
  </h2>
  <div
    style="
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 2rem;
    "
  >
    <div>
      <label style="opacity: 0.7; font-size: 0.9rem">××–×”×” ××©×ª××©</label>
      <p style="font-size: 1.2rem; margin: 0.5rem 0">{{ user.id }}</p>
    </div>
    <div>
      <label style="opacity: 0.7; font-size: 0.9rem">×©× ××©×ª××© ×‘×˜×œ×’×¨×</label>
      <p style="font-size: 1.2rem; margin: 0.5rem 0">
        {% if user.username %} @{{ user.username }} {% else %}
        <span style="opacity: 0.5">×œ× ××•×’×“×¨</span>
        {% endif %}
      </p>
    </div>
    <div>
      <label style="opacity: 0.7; font-size: 0.9rem">×©× ××œ×</label>
      <p style="font-size: 1.2rem; margin: 0.5rem 0">
        {{ user.first_name }} {{ user.last_name or '' }}
      </p>
    </div>
    <div id="account-status">
      <label style="opacity: 0.7; font-size: 0.9rem">×¡×˜×˜×•×¡</label>
      <p style="font-size: 1.2rem; margin: 0.5rem 0">
        {% if is_admin %}
        <span
          class="badge"
          style="
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            padding: 0.5rem 1rem;
          "
        >
          ğŸªª ××©×ª××© ××“××™×Ÿ
        </span>
        {% elif is_premium %}
        <span
          class="badge"
          style="
            background: linear-gradient(135deg, #60a5fa, #7dd3fc);
            padding: 0.5rem 1rem;
          "
        >
          ğŸ’ ××©×ª××© ×¤×¨×™××™×•×
        </span>
        {% else %}
        <span class="badge">××©×ª××© ×¨×’×™×œ</span>
        {% endif %}
      </p>
    </div>
  </div>
  {% if is_premium %}
  <div
    style="
      margin-top: 1.5rem;
      padding: 1rem;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    "
  >
    <div style="font-size: 1rem">
      ğŸ’ ×™×© ×œ×š ×‘×§×©×” ××™×•×—×“×ª? ××•×–××Ÿ ×œ×¤× ×•×ª ××œ×™×™ ×‘×˜×œ×’×¨×:
      <a
        href="https://t.me/moominAmir"
        target="_blank"
        rel="noopener"
        style="color: var(--text-primary, #fff); text-decoration: underline"
        >@moominAmir</a
      >
    </div>
  </div>
  {% endif %}
</div>

<div class="glass-card">
  <h2 class="section-title">
    <i class="fas fa-clock"></i>
    ×”×’×“×¨×•×ª ×¡×©×Ÿ
  </h2>
  <div class="glass-card" style="background: rgba(255, 255, 255, 0.05)">
    <div
      style="
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
      "
    >
      <div style="display: flex; align-items: center; gap: 1rem">
        <i
          class="fas fa-check-circle"
          style="color: var(--success); font-size: 1.5rem"
        ></i>
        <div>
          <div style="font-weight: 600">×—×™×‘×•×¨ ×§×‘×•×¢</div>
          <div style="opacity: 0.8; font-size: 0.95rem">
            ×”×©××¨ ××—×•×‘×¨ ××•×˜×•××˜×™×ª ×¢×“ {{ persistent_days }} ×™×•× ×‘××›×©×™×¨ ×–×”
          </div>
        </div>
      </div>
      <label class="switch">
        <input
          id="persistentToggle"
          type="checkbox"
          {%
          if
          persistent_login_enabled
          %}checked{%
          endif
          %}
        />
        <span class="slider"></span>
      </label>
    </div>
    <div
      id="persistMsg"
      style="opacity: 0.8; margin-top: 0.75rem; font-size: 0.95rem"
    >
      {% if persistent_login_enabled %} ×”×—×™×‘×•×¨ ×”×§×‘×•×¢ ×¤×¢×™×œ. ×ª×•×›×œ ×œ×›×‘×•×ª ×‘×›×œ ×¨×’×¢.
      {% else %} ×”×—×™×‘×•×¨ ×”×§×‘×•×¢ ×›×‘×•×™. {% endif %}
    </div>
  </div>

  <div style="margin-top: 1.5rem">
    <a href="/logout" class="btn btn-secondary btn-icon">
      <i class="fas fa-sign-out-alt"></i>
      ×”×ª× ×ª×§ ××›×œ ×”××›×©×™×¨×™×
    </a>
    <p style="margin-top: 0.5rem; opacity: 0.7; font-size: 0.9rem">
      ×”×ª× ×ª×§×•×ª ×ª×¡×™×¨ ××ª ×”×”×ª×—×‘×¨×•×ª ××›×œ ×”×“×¤×“×¤× ×™× ×•×”××›×©×™×¨×™×
    </p>
  </div>
</div>

{% if push_enabled %}
<div class="glass-card">
  <h2 class="section-title">
    <i class="fas fa-bell"></i>
    ×”×ª×¨××•×ª ×“×¤×“×¤×Ÿ (Web Push)
  </h2>
  <div class="glass-card" style="background: rgba(255, 255, 255, 0.05)">
    <div
      style="
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        flex-wrap: wrap;
      "
    >
      <div
        style="display: flex; align-items: center; gap: 1rem; min-width: 260px"
      >
        <i class="fas fa-bell" style="font-size: 1.5rem"></i>
        <div>
          <div style="font-weight: 600">×”×ª×¨××•×ª ×œ×¤×ª×§×™ Sticky Notes</div>
          <div style="opacity: 0.8; font-size: 0.95rem">
            ×§×‘×œ ×”×ª×¨××•×ª ×›×©×”×ª×–×›×•×¨×ª ××’×™×¢×”. ×‘â€‘iOS × ×“×¨×© ×œ×”×ª×§×™×Ÿ ×›â€‘PWA.
          </div>
        </div>
      </div>
      <div style="display: flex; gap: 0.5rem; flex-wrap: wrap">
        <button id="pushEnableBtn" class="btn btn-primary">××¤×©×¨ ×”×ª×¨××•×ª</button>
        <button id="pushDisableBtn" class="btn btn-secondary">
          ×›×‘×” ×”×ª×¨××•×ª
        </button>
        <button id="pushTestBtn" class="btn btn-tertiary">×©×œ×— ×¤×•×© ×‘×“×™×§×”</button>
      </div>
    </div>
    <div
      id="pushStatus"
      style="opacity: 0.8; margin-top: 0.75rem; font-size: 0.95rem"
    >
      ××¦×‘ ×œ× ×™×“×•×¢
    </div>
  </div>
</div>
{% else %}
<div class="glass-card">
  <h2 class="section-title">
    <i class="fas fa-bell-slash"></i>
    ×”×ª×¨××•×ª ×“×¤×“×¤×Ÿ (Web Push)
  </h2>
  <div class="glass-card" style="background: rgba(255, 255, 255, 0.05)">
    <div style="opacity: 0.8; font-size: 0.95rem">
      ×”×ª×¨××•×ª ×¤×•×© ×›×‘×•×™×•×ª ×‘××¢×¨×›×ª.
    </div>
  </div>
</div>
{% endif %}
{% if is_admin %}
<div class="glass-card config-radar-card" id="configRadarCard">
  <div class="config-radar-header">
    <div>
      <h2 class="section-title">
        <i class="fas fa-satellite-dish"></i>
        Config Radar â€“ × ×¨××•×ª ×§×•× ×¤×™×’×•×¨×¦×™×”
      </h2>
      <p class="config-radar-lead">
        ××‘×˜ ××¨×•×›×– ×¢×œ alerts.yml, error_signatures.yml, image_settings.yaml, alert_quick_fixes.json ×•-observability_runbooks.yml ×›×•×œ×œ ×¡×˜×˜×•×¡ ×•×œ×™×“×¦×™×” ×•-Git.
      </p>
    </div>
    <div class="config-radar-actions">
      <button class="btn btn-secondary btn-icon" id="configRadarRefreshBtn" type="button">
        <i class="fas fa-sync-alt"></i>
        ×˜×¢×Ÿ ××—×“×©
      </button>
      <button class="btn btn-primary btn-icon" id="configRadarValidateBtn" type="button">
        <i class="fas fa-shield-check"></i>
        Validate Schema
      </button>
    </div>
  </div>
  <div class="config-radar-status" data-radar-status>
    <span class="badge">×××ª×™×Ÿ ×œ× ×ª×•× ×™×...</span>
  </div>
  <small class="config-radar-timestamp" data-radar-timestamp></small>
  <div class="config-radar-tabs" role="tablist">
    <button class="radar-tab active" data-panel="alerts" type="button">×”×ª×¨××•×ª</button>
    <button class="radar-tab" data-panel="errors" type="button">×—×ª×™××•×ª ×©×’×™××”</button>
    <button class="radar-tab" data-panel="images" type="button">×”×’×“×¨×•×ª ×ª××•× ×”</button>
    <button class="radar-tab" data-panel="quickfixes" type="button">Quick Fixes</button>
    <button class="radar-tab" data-panel="runbooks" type="button">Runbooks</button>
    <button class="radar-tab" data-panel="coverage" type="button">Coverage</button>
  </div>
  <div class="radar-panel active" data-panel="alerts">
    <div class="radar-panel-body" id="configRadarAlerts" data-radar-panel="alerts">
      <div class="radar-empty-state">×‘×§×¨×•×‘ ×™×•×¦×’×• × ×ª×•× ×™× ×¢×œ alerts.yml</div>
    </div>
  </div>
  <div class="radar-panel" data-panel="errors">
    <div class="radar-panel-body" id="configRadarErrors" data-radar-panel="errors">
      <div class="radar-empty-state">×‘×§×¨×•×‘ ×™×•×¦×’×• ×—×ª×™××•×ª ×©×’×™××”</div>
    </div>
  </div>
  <div class="radar-panel" data-panel="images">
    <div class="radar-panel-body" id="configRadarImages" data-radar-panel="images">
      <div class="radar-empty-state">×‘×§×¨×•×‘ ×™×•×¦×’×• ×”×’×“×¨×•×ª ×”×ª××•× ×”</div>
    </div>
  </div>
  <div class="radar-panel" data-panel="quickfixes">
    <div class="radar-panel-body" id="configRadarQuickFixes" data-radar-panel="quickfixes">
      <div class="radar-empty-state">×‘×§×¨×•×‘ ×™×•×¦×’×• × ×ª×•× ×™ quick fixes</div>
    </div>
  </div>
  <div class="radar-panel" data-panel="runbooks">
    <div class="radar-panel-body" id="configRadarRunbooks" data-radar-panel="runbooks">
      <div class="radar-empty-state">×‘×§×¨×•×‘ ×™×•×¦×’×• Runbooks</div>
    </div>
  </div>
  <div class="radar-panel" data-panel="coverage">
    <div class="radar-panel-body" id="configRadarCoverage" data-radar-panel="coverage">
      <div class="radar-empty-state">×‘×—×¨ ×‘×œ×©×•× ×™×ª Coverage ×›×“×™ ×œ×˜×¢×•×Ÿ ×“×•×— ×›×™×¡×•×™.</div>
    </div>
  </div>
</div>

<div class="glass-card" style="border: 2px solid rgba(251, 191, 36, 0.3)">
  <h2 class="section-title">
    <i class="fas fa-tools"></i>
    ×›×œ×™ ××“××™×Ÿ
  </h2>
  <div style="display: grid; gap: 1rem">
    <div
      style="
        padding: 1rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
      "
    >
      <h4>ğŸ“ƒ × ×™×”×•×œ ×¡×¤×¨×™×™×ª ×¡× ×™×¤×˜×™×</h4>
      <div style="display: flex; gap: 0.5rem; flex-wrap: wrap">
        <a class="btn btn-primary" href="/admin/snippets/pending"
          >ğŸ“¥ ×”×¦×¢×•×ª ×××ª×™× ×•×ª</a
        >
        <a class="btn btn-secondary" href="/snippets">ğŸ“š ××¢×‘×¨ ×œ×¡×¤×¨×™×™×”</a>
        <a class="btn btn-secondary" href="/snippets/submit"
          >â• ×”×•×¡×£ ×¡× ×™×¤×˜ ×—×“×©</a
        >
        <a class="btn btn-secondary" href="/admin/snippets/translate"
          >ğŸŒ ×™×™×¦×•×/×™×™×‘×•× ×›×•×ª×¨×•×ª</a
        >
      </div>
    </div>
    <div
      style="
        padding: 1rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
      "
    >
      <h4>ğŸ“£ × ×™×”×•×œ ×”×›×¨×–×•×ª ××¢×¨×›×ª</h4>
      <div style="display: flex; gap: 0.5rem; flex-wrap: wrap">
        <a class="btn btn-primary" href="/admin/announcements"
          >×¤×ª×— ×¢××•×“ ×”×›×¨×–×•×ª</a
        >
      </div>
    </div>
    <div
      style="
        padding: 1rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
      "
    >
      <h4>ğŸ§© ×××©×§×™ ××©×ª××©×™× â€“ ××•×¡×£ ×”×§×”×™×œ×”</h4>
      <div style="display: flex; gap: 0.5rem; flex-wrap: wrap">
        <a class="btn btn-primary" href="/admin/community/pending"
          >ğŸ“¥ ××•×¡×¤×™× ×××ª×™× ×™×</a
        >
        <a class="btn btn-secondary" href="/community-library"
          >ğŸ›ï¸ ×œ×¢××•×“ ×”××•×¡×£</a
        >
      </div>
    </div>
    <div
      style="
        padding: 1rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
      "
    >
      <h4><i class="fas fa-database"></i> ×¡×˜×˜×™×¡×˜×™×§×•×ª ××¢×¨×›×ª</h4>
      <p style="opacity: 0.8; margin-bottom:0.75rem;">
        ×¦×¤×™×™×” ×‘×¨×©×™××ª ×”××©×ª××©×™× ×”×¤×¢×™×œ×™×, ×›××•×ª ×¤×¢×•×œ×•×ª ×©×‘×•×¢×™×ª ×•×ª×§×¦×™×¨ ×©×™××•×©.
      </p>
      <div style="display:flex; gap:.5rem; flex-wrap:wrap;">
        <a class="btn btn-primary" href="/admin/stats">×¤×ª×— ××¡×š ×¡×˜×˜×™×¡×˜×™×§×•×ª</a>
      </div>
    </div>
    <div
      style="
        padding: 1rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
      "
    >
      <h4><i class="fas fa-eye"></i> Observability Dashboard</h4>
      <p style="opacity: 0.8; margin-bottom: 0.75rem;">
        ×œ×•×— × ×™×˜×•×¨ ××“××™×Ÿ ×¢× ×”×ª×¨××•×ª, ×’×¨×¤×™× ×•×–×™×”×•×™ × ×§×•×“×•×ª ×§×¦×” ××™×˜×™×•×ª ×‘×–××Ÿ ×××ª.
      </p>
      <div style="display: flex; gap: 0.5rem; flex-wrap: wrap">
        <a class="btn btn-primary" href="/admin/observability">×¤×ª×— ×“×©×‘×•×¨×“</a>
        <a
          class="btn btn-secondary"
          href="https://amirbiron.github.io/CodeBot/observability/observability_dashboard.html"
          target="_blank"
          rel="noopener"
        >
          ×§×¨× ××ª ×”××“×¨×™×š
        </a>
      </div>
    </div>
    <div
      style="
        padding: 1rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
      "
    >
      <h4><i class="fas fa-users"></i> × ×™×”×•×œ ××©×ª××©×™×</h4>
      <p style="opacity: 0.8">×‘×§×¨×•×‘: ×¦×¤×™×™×” ×•× ×™×”×•×œ ××©×ª××©×™ ×”××¢×¨×›×ª</p>
    </div>
    <div
      style="
        padding: 1rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
      "
    >
      <h4><i class="fab fa-github"></i> ××™× ×˜×’×¨×¦×™×™×ª GitHub</h4>
      <p style="opacity: 0.8">×‘×§×¨×•×‘: ×—×™×‘×•×¨ ×•× ×™×”×•×œ ×¨×™×¤×•×–×™×˜×•×¨×™×– ×-GitHub</p>
    </div>
  </div>
</div>
{% endif %}

<div class="glass-card">
  <h2 class="section-title">
    <i class="fas fa-palette"></i>
    ×”×¢×“×¤×•×ª ×ª×¦×•×’×”
  </h2>
  <div class="glass-card" style="background: rgba(255, 255, 255, 0.05)">
    <div
      style="
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
      "
    >
      <div style="display: flex; align-items: center; gap: 1rem">
        <i class="fas fa-text-height" style="font-size: 1.5rem"></i>
        <div>
          <div style="font-weight: 600">×’×•×“×œ ×’×•×¤×Ÿ</div>
          <div style="opacity: 0.8; font-size: 0.95rem">
            ×”×ª×× ××ª ×’×•×“×œ ×”×˜×§×¡×˜ ×‘××¤×œ×™×§×¦×™×”
          </div>
        </div>
      </div>
      <div
        style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap"
      >
        <button
          id="fontMinus"
          class="btn btn-secondary"
          title="×”×§×˜×Ÿ"
          style="min-width: 3rem"
        >
          A-
        </button>
        <div id="fontValue" class="badge">Ã— {{ '%.2f' % ui_font_scale }}</div>
        <button
          id="fontPlus"
          class="btn btn-secondary"
          title="×”×’×“×œ"
          style="min-width: 3rem"
        >
          A+
        </button>
      </div>
    </div>
  </div>
  <p style="opacity: 0.7; margin-top: 0.75rem; font-size: 0.9rem">
    ×”×”×’×“×¨×” × ×©××¨×ª ×œ××©×ª××© ×•×œ××›×©×™×¨ ×–×”.
  </p>

  <div
    class="glass-card"
    style="background: rgba(255, 255, 255, 0.05); margin-top: 1rem"
  >
    <div
      style="
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        flex-wrap: wrap;
      "
    >
      <div style="display: flex; align-items: center; gap: 1rem">
        <i class="fas fa-fill-drip" style="font-size: 1.5rem"></i>
        <div>
          <div style="font-weight: 600">×¢×¨×›×ª × ×•×©×</div>
          <div style="opacity: 0.8; font-size: 0.95rem">
            ×‘×—×¨ ×¡×’× ×•×Ÿ ×¦×‘×¢×™× â€” ×›×•×œ×œ ×”× ×•×›×—×™×ª
          </div>
        </div>
      </div>
      <div>
        <select
          id="themeSelect"
          class="filter-select"
          aria-label="×‘×—×¨ ×¢×¨×›×ª × ×•×©×"
          style="padding: 0.5rem 0.75rem; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: var(--text-primary);"
        >
          {% if is_admin and custom_theme and custom_theme.is_active %}
          <option value="custom" {% if ui_theme == 'custom' %}selected{% endif %}>ğŸ¨ {{ custom_theme.name if custom_theme.name else 'Custom' }}{% if ui_theme == 'custom' %} (× ×•×›×—×™×ª){% endif %}</option>
          {% endif %}
          <option value="classic" {% if ui_theme == 'classic' %}selected{% endif %}>×§×œ××¡×™{% if ui_theme == 'classic' %} (× ×•×›×—×™×ª){% endif %}</option>
          <option value="ocean" {% if ui_theme == 'ocean' %}selected{% endif %}>××•×§×™×™× ×•×¡{% if ui_theme == 'ocean' %} (× ×•×›×—×™×ª){% endif %}</option>
          <option value="rose-pine-dawn" {% if ui_theme == 'rose-pine-dawn' %}selected{% endif %}>ğŸŒ¹ Rose Pine Dawn{% if ui_theme == 'rose-pine-dawn' %} (× ×•×›×—×™×ª){% endif %}</option>
          <option value="dark" {% if ui_theme == 'dark' %}selected{% endif %}>ğŸŒ™ ×—×©×•×š{% if ui_theme == 'dark' %} (× ×•×›×—×™×ª){% endif %}</option>
          <option value="dim" {% if ui_theme == 'dim' %}selected{% endif %}>ğŸŒ† ××¢×•××¢×{% if ui_theme == 'dim' %} (× ×•×›×—×™×ª){% endif %}</option>
          <option value="nebula" {% if ui_theme == 'nebula' %}selected{% endif %}>ğŸŒŒ Nebula{% if ui_theme == 'nebula' %} (× ×•×›×—×™×ª){% endif %}</option>
          <option value="high-contrast" {% if ui_theme == 'high-contrast' %}selected{% endif %}>× ×™×’×•×“×™×•×ª ×’×‘×•×”×”{% if ui_theme == 'high-contrast' %} (× ×•×›×—×™×ª){% endif %}</option>
        </select>
        {% if is_admin %}
        <div style="margin-top: 0.75rem; opacity: 0.85; font-size: 0.95rem;">
          <a class="btn btn-secondary btn-icon" href="/settings/theme-builder">
            <i class="fas fa-palette"></i>
            ×‘×•× ×” ×¢×¨×›×ª × ×•×©× (××“××™×Ÿ)
          </a>
        </div>
        {% if custom_theme and custom_theme.is_active %}
        <div style="margin-top: 0.5rem; display: flex; justify-content: flex-end;">
          <button
            type="button"
            class="btn btn-tertiary btn-icon"
            onclick="deleteCustomTheme()"
            title="××—×§ ×¢×¨×›×” ××•×ª×××ª"
            style="border-color: rgba(245, 101, 101, 0.55); color: var(--danger);"
          >
            <i class="fas fa-trash" style="color: var(--danger);"></i>
            ××—×§ ×¢×¨×›×”
          </button>
        </div>
        {% endif %}
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Bookmarks toggle visibility (moved from panel) -->
  <div
    class="glass-card"
    style="background: rgba(255, 255, 255, 0.05); margin-top: 1rem"
  >
    <div
      style="
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
      "
    >
      <div style="display: flex; align-items: center; gap: 1rem">
        <i class="fas fa-bookmark" style="font-size: 1.5rem"></i>
        <div>
          <div style="font-weight: 600">×”×¦×’×ª ×›×¤×ª×•×¨ ×¡×™×× ×™×•×ª</div>
          <div style="opacity: 0.8; font-size: 0.95rem">
            ×”×¦×’ / ×”×¡×ª×¨ ××ª ×”×›×¤×ª×•×¨ ×”×¦×£ ğŸ”–
          </div>
        </div>
      </div>
      <div
        style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap"
      >
        <button id="bmShowBtn" class="btn btn-secondary">×”×¦×’</button>
        <button id="bmHideBtn" class="btn btn-secondary">×”×¡×ª×¨</button>
        <span
          id="bmState"
          class="badge"
          style="min-width: 64px; text-align: center"
        ></span>
      </div>
    </div>
  </div>
  <div class="glass-card" id="smoothScrollSettingsCard">
    <h2 class="section-title">
      <i class="fas fa-stream"></i>
      ×’×œ×™×œ×” ×—×œ×§×”
    </h2>
    <div
      class="glass-card"
      style="
        background: rgba(255, 255, 255, 0.05);
        display: flex;
        flex-direction: column;
        gap: 1rem;
      "
    >
      <div class="smooth-scroll-setting-row">
        <div>
          <strong>×”×¤×¢×œ ×’×œ×™×œ×” ×—×œ×§×”</strong>
          <small>×›×™×‘×•×™ ×™×›×‘×“ ××ª ×”×’×“×¨×•×ª ×”× ×’×™×©×•×ª ×©×œ ××¢×¨×›×ª ×”×”×¤×¢×œ×”</small>
        </div>
        <label class="switch">
          <input type="checkbox" id="smoothScrollEnabledToggle" />
          <span class="slider"></span>
        </label>
      </div>
      <div class="smooth-scroll-setting-row">
        <div>
          <strong>××©×š ×× ×™××¦×™×”</strong>
          <small>××’×“×™×¨ ×ª×•×š ×›××” ×–××Ÿ ××¡×ª×™×™××ª ×”×’×œ×™×œ×”</small>
        </div>
        <div class="smooth-scroll-control">
          <input
            type="range"
            id="smoothScrollDuration"
            min="150"
            max="1200"
            step="50"
          />
          <span id="smoothScrollDurationValue">400ms</span>
        </div>
      </div>
      <div class="smooth-scroll-setting-row">
        <div>
          <strong>×¢×§×•××ª ×× ×™××¦×™×”</strong>
          <small>×”×’×“×¨×ª easing (Linear, Ease-in ×•×›×•')</small>
        </div>
        <div class="smooth-scroll-control">
          <select id="smoothScrollEasing" aria-label="×‘×—×¨ ×¢×§×•××ª ×’×œ×™×œ×”">
            <option value="linear">Linear</option>
            <option value="ease-in">Ease-in</option>
            <option value="ease-out">Ease-out</option>
            <option value="ease-in-out" selected>Ease-in-out</option>
          </select>
        </div>
      </div>
      <div class="smooth-scroll-setting-row">
        <div>
          <strong>×¨×’×™×©×•×ª ×’×œ×’×œ×ª</strong>
          <small>×§×•×‘×¢ ×›××” ×ª× ×•×¢×” ×ª×ª×¨×’× ×œ×’×œ×™×œ×”</small>
        </div>
        <div class="smooth-scroll-control">
          <input
            type="range"
            id="smoothScrollWheel"
            min="0.5"
            max="3"
            step="0.1"
          />
          <span id="smoothScrollWheelValue">1.0Ã—</span>
        </div>
      </div>
      <div class="smooth-scroll-setting-row">
        <div>
          <strong>×¨×’×™×©×•×ª ××§×œ×“×ª</strong>
          <small>××©×¤×™×¢ ×¢×œ PageUp/PageDown ×•×—×™×¦×™×</small>
        </div>
        <div class="smooth-scroll-control">
          <input
            type="range"
            id="smoothScrollKeyboard"
            min="0.5"
            max="3"
            step="0.1"
          />
          <span id="smoothScrollKeyboardValue">1.5Ã—</span>
        </div>
      </div>
      <div class="smooth-scroll-setting-row">
        <div>
          <strong>××™× ×¨×¦×™×” ×‘×× ×“×¨×•××™×“</strong>
          <small>×›××•×ª ×”×ª××•×¦×” ×©××ª×•×•×¡×¤×ª ××—×¨×™ ×©×—×¨×•×¨ ×”××¦×‘×¢</small>
        </div>
        <div class="smooth-scroll-control">
          <input
            type="range"
            id="smoothScrollMomentum"
            min="10"
            max="60"
            step="1"
          />
          <span id="smoothScrollMomentumValue">26Ã—</span>
        </div>
      </div>
      <div class="smooth-scroll-actions">
        <button
          id="smoothScrollTestBtn"
          class="btn btn-secondary"
          type="button"
        >
          <i class="fas fa-play-circle"></i>
          ×‘×“×™×§×ª ×’×œ×™×œ×”
        </button>
        <button
          id="smoothScrollResetBtn"
          class="btn btn-tertiary"
          type="button"
        >
          <i class="fas fa-undo"></i>
          ××™×¤×•×¡ ×œ×‘×¨×™×¨×ª ××—×“×œ
        </button>
      </div>
    </div>
    <p id="smoothScrollSettingsNote" style="opacity: 0.75; margin-top: 0.75rem">
      ×”×”×’×“×¨×•×ª × ×©××¨×•×ª ××§×•××™×ª ×•××¡×•× ×›×¨× ×•×ª ×œ×©×¨×ª (×× ×”××¤×©×¨×•×ª ×–××™× ×”). ×‘×¨×™×¨×ª ×”××—×“×œ
      ××›×‘×“×ª ××ª ×”×¢×“×¤×•×ª ×”× ×’×™×©×•×ª ×©×œ ×”××›×©×™×¨.
    </p>
  </div>

  <div class="glass-card">
    <h2 class="section-title">
      <i class="fas fa-shield-alt"></i>
      ×¤×¨×˜×™×•×ª ×•××‘×˜×—×”
    </h2>
    <div style="display: grid; gap: 1rem">
      <div style="display: flex; align-items: start; gap: 1rem">
        <i
          class="fas fa-lock"
          style="color: var(--success); margin-top: 0.25rem"
        ></i>
        <div>
          <strong>×—×™×‘×•×¨ ×××•×‘×˜×—</strong>
          <p style="opacity: 0.8; margin: 0.25rem 0">
            ×›×œ ×”×ª×§×©×•×¨×ª ××•×¦×¤× ×ª ×‘-HTTPS
          </p>
        </div>
      </div>
      <div style="display: flex; align-items: start; gap: 1rem">
        <i
          class="fas fa-user-shield"
          style="color: var(--success); margin-top: 0.25rem"
        ></i>
        <div>
          <strong>××™××•×ª ×“×¨×š Telegram</strong>
          <p style="opacity: 0.8; margin: 0.25rem 0">
            ×”×ª×—×‘×¨×•×ª ×××•×‘×˜×—×ª ×œ×œ× ×¡×™×¡×××•×ª
          </p>
        </div>
      </div>
      <div style="display: flex; align-items: start; gap: 1rem">
        <i
          class="fas fa-database"
          style="color: var(--success); margin-top: 0.25rem"
        ></i>
        <div>
          <strong>×”×¦×¤× ×ª × ×ª×•× ×™×</strong>
          <p style="opacity: 0.8; margin: 0.25rem 0">
            ×›×œ ×”××™×“×¢ ×”×¨×’×™×© ××•×¦×¤×Ÿ ×‘××¡×“ ×”× ×ª×•× ×™×
          </p>
        </div>
      </div>
    </div>
  </div>

  <style>
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
      font-size: 1.25rem;
    }

    .glass-card h4 {
      margin: 0 0 0.5rem 0;
      color: var(--text-primary); /* ×©×™××•×© ×‘××©×ª× ×” ×‘××§×•× ×¦×‘×¢ ×§×‘×•×¢ */
    }

    /* Toggle switch */
    .switch {
      position: relative;
      display: inline-block;
      width: 52px;
      height: 28px;
    }
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.2);
      transition: 0.2s;
      border-radius: 28px;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 3px;
      top: 2px;
      background: white;
      transition: 0.2s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background: rgba(72, 187, 120, 0.5);
    }
    input:checked + .slider:before {
      transform: translateX(24px);
    }

    .smooth-scroll-setting-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .smooth-scroll-setting-row strong {
      display: block;
    }
    .smooth-scroll-setting-row small {
      display: block;
      opacity: 0.7;
      font-size: 0.85rem;
    }
    .smooth-scroll-control {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex: 1;
      min-width: 220px;
    }
    .smooth-scroll-control input[type="range"] {
      flex: 1;
    }
    .smooth-scroll-control span {
      font-weight: 600;
      min-width: 60px;
      text-align: right;
    }
    .smooth-scroll-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .config-radar-card {
      margin-bottom: 2rem;
      border: 1px solid rgba(251, 191, 36, 0.25);
    }
    .config-radar-header {
      display: flex;
      justify-content: space-between;
      gap: 1.5rem;
      flex-wrap: wrap;
      align-items: flex-start;
    }
    .config-radar-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .config-radar-lead {
      opacity: 0.85;
      margin: 0.25rem 0 0;
    }
    .config-radar-status {
      margin-top: 0.75rem;
    }
    .config-radar-timestamp {
      display: block;
      opacity: 0.7;
      margin-top: 0.25rem;
    }
    .config-radar-tabs {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
      flex-wrap: wrap;
    }
    .radar-tab {
      padding: 0.5rem 1rem;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.05);
      color: inherit;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .radar-tab.active {
      background: linear-gradient(120deg, #fbbf24, #f59e0b);
      border-color: transparent;
      color: #1f1f1f;
      font-weight: 600;
    }
    .radar-panel {
      display: none;
      margin-top: 1rem;
    }
    .radar-panel.active {
      display: block;
    }
    .radar-panel-body {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .radar-empty-state {
      padding: 1rem;
      border-radius: 12px;
      background: rgba(255,255,255,0.05);
      opacity: 0.8;
    }
    .radar-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
    }
    .radar-controls {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      align-items: flex-end;
      margin-top: 1rem;
    }
    .radar-controls label {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      font-size: 0.85rem;
      opacity: 0.9;
      min-width: 160px;
    }
    .radar-controls input,
    .radar-controls select {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 12px;
      color: inherit;
      padding: 0.45rem 0.6rem;
      font-size: 0.9rem;
    }
    .radar-link {
      color: inherit;
      text-decoration: underline;
    }
    .radar-kpi {
      padding: 1rem;
      border-radius: 12px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.08);
    }
    .radar-kpi strong {
      display: block;
      font-size: 1.85rem;
      margin-bottom: 0.15rem;
    }
    .radar-meta {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      font-size: 0.85rem;
      opacity: 0.8;
    }
    .radar-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    .radar-table th,
    .radar-table td {
      padding: 0.5rem;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      text-align: right;
    }
    .radar-table tbody tr:hover {
      background: rgba(255,255,255,0.03);
    }
    .radar-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.1rem 0.55rem;
      border-radius: 999px;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .radar-badge.severity {
      background: rgba(248, 113, 113, 0.25);
      border: 1px solid rgba(248, 113, 113, 0.45);
    }
    .radar-badge.policy {
      background: rgba(96, 165, 250, 0.25);
      border: 1px solid rgba(96, 165, 250, 0.45);
    }
    .radar-badge.immediate {
      background: rgba(251, 191, 36, 0.2);
      border: 1px solid rgba(251, 191, 36, 0.45);
      color: #fcd34d;
    }
    .radar-accordion {
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.04);
      padding: 0.25rem 1rem 0.75rem;
    }
    .radar-accordion summary {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      cursor: pointer;
      list-style: none;
    }
    .radar-accordion summary::-webkit-details-marker {
      display: none;
    }
    .radar-accordion[open] {
      background: rgba(255,255,255,0.07);
    }
    .radar-signature {
      border-top: 1px solid rgba(255,255,255,0.08);
      padding: 0.75rem 0;
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
    }
    .radar-signature:first-of-type {
      border-top: none;
    }
    .radar-chip {
      display: inline-flex;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(255,255,255,0.04);
      font-size: 0.8rem;
      margin-left: 0.25rem;
    }
    .radar-chip.radar-action-chip {
      align-items: center;
      gap: 0.35rem;
    }
    .radar-action-link {
      color: inherit;
      text-decoration: underline;
    }
    .radar-action-copy {
      appearance: none;
      background: none;
      border: none;
      color: inherit;
      text-decoration: underline;
      font: inherit;
      padding: 0;
      cursor: pointer;
    }
    .radar-action-copy[disabled] {
      cursor: default;
      opacity: 0.65;
    }
    .badge-success {
      background: rgba(16, 185, 129, 0.2);
      border-color: rgba(16, 185, 129, 0.4);
      color: #10b981;
    }
    .badge-danger {
      background: rgba(248, 113, 113, 0.2);
      border-color: rgba(248, 113, 113, 0.4);
      color: #f87171;
    }
    .config-radar-card code {
      font-family: "Fira Code", "JetBrains Mono", monospace;
      font-size: 0.85rem;
      background: rgba(0, 0, 0, 0.35);
      padding: 0.15rem 0.35rem;
      border-radius: 6px;
    }
    .radar-issues {
      margin: 0.5rem 0 0;
      padding-right: 1.25rem;
      font-size: 0.85rem;
    }
    .radar-issues li {
      margin-bottom: 0.25rem;
      display: flex;
      gap: 0.4rem;
      align-items: baseline;
    }
    .radar-issues-count {
      margin-top: 0.75rem;
      font-size: 0.85rem;
      opacity: 0.85;
    }
    .radar-issue-index {
      font-weight: 600;
      color: #93c5fd;
    }
    :root[data-theme="rose-pine-dawn"] .config-radar-card {
      background: color-mix(in srgb, #ffffff 78%, var(--bg-secondary) 22%);
      border: 1px solid var(--glass-border);
      box-shadow: 0 16px 34px rgba(144,122,169,0.16);
      color: var(--text-primary);
    }
    :root[data-theme="rose-pine-dawn"] .radar-tab {
      background: color-mix(in srgb, var(--bg-secondary) 70%, #ffffff 30%);
      border: 1px solid var(--glass-border);
      color: var(--text-primary);
    }
    :root[data-theme="rose-pine-dawn"] .radar-tab.active {
      background: linear-gradient(135deg, #d7827e, #907aa9);
      color: #fff;
      border: none;
      box-shadow: 0 10px 20px rgba(144,122,169,0.25);
    }
    :root[data-theme="rose-pine-dawn"] .radar-empty-state,
    :root[data-theme="rose-pine-dawn"] .radar-kpi,
    :root[data-theme="rose-pine-dawn"] .radar-accordion,
    :root[data-theme="rose-pine-dawn"] .radar-chip {
      background: color-mix(in srgb, #ffffff 80%, var(--bg-secondary) 20%);
      border: 1px solid var(--glass-border);
      color: var(--text-primary);
    }
    :root[data-theme="rose-pine-dawn"] .radar-table th,
    :root[data-theme="rose-pine-dawn"] .radar-table td,
    :root[data-theme="rose-pine-dawn"] .radar-signature {
      border-color: rgba(87,82,121,0.25);
    }
    :root[data-theme="rose-pine-dawn"] .config-radar-status,
    :root[data-theme="rose-pine-dawn"] .config-radar-lead,
    :root[data-theme="rose-pine-dawn"] .config-radar-timestamp {
      color: var(--text-secondary);
    }
  </style>

  {% block extra_js %}
  <script>
    (function(){
      const toggle = document.getElementById('persistentToggle');
      const msg = document.getElementById('persistMsg');
      if (toggle) {
        toggle.addEventListener('change', async function(){
          try {
            const res = await fetch('/api/persistent_login', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ enable: toggle.checked })
            });
            const data = await res.json();
            if (!data.ok) throw new Error(data.error || 'Failed');
            if (toggle.checked) { msg.textContent = '×”×—×™×‘×•×¨ ×”×§×‘×•×¢ ×¤×¢×™×œ. ×ª×•×›×œ ×œ×›×‘×•×ª ×‘×›×œ ×¨×’×¢.'; }
            else { msg.textContent = '×”×—×™×‘×•×¨ ×”×§×‘×•×¢ ×›×‘×•×™.'; }
          } catch (e) {
            toggle.checked = !toggle.checked;
            alert('×©×’×™××” ×‘×¢×“×›×•×Ÿ ××¦×‘ ×”×—×™×‘×•×¨ ×”×§×‘×•×¢');
          }
        });
      }

      // Font size controls
      const vEl = document.getElementById('fontValue');
      const btnMinus = document.getElementById('fontMinus');
      const btnPlus = document.getElementById('fontPlus');
      const themeSel = document.getElementById('themeSelect');
      
      // ××—×™×§×ª ×¢×¨×›×ª × ×•×©× ××•×ª×××ª (Custom) ××ª×•×š ××¡×š ×”×”×’×“×¨×•×ª
      window.deleteCustomTheme = async function deleteCustomTheme(){
        if (!confirm("×”×× ×œ××—×•×§ ××ª ×”×¢×¨×›×”?")) {
          return;
        }
        try {
          const res = await fetch('/api/themes/custom', { method: 'DELETE' });
          const data = await res.json();
          if (!res.ok || !data || !data.ok) {
            throw new Error((data && data.error) || 'delete_failed');
          }
        } catch (e) {
          console.error('deleteCustomTheme failed:', e);
          alert('×©×’×™××” ×‘××—×™×§×ª ×”×¢×¨×›×”');
          return;
        }

        // dark_mode_preference ×”×•× enum ×©×œ dark/dim/light/auto ×‘×œ×‘×“
        // ×›×“×™ ×œ×—×–×•×¨ ×œ-Classic ×‘×¦×•×¨×” ×ª×§×™× ×” × ×©×ª××© ×‘-"light"
        try { localStorage.setItem('dark_mode_preference', 'light'); } catch (_) {}
        try { localStorage.setItem('user_theme', 'classic'); } catch (_) {}
        location.reload();
      };
      function setVal(x){ if (vEl) vEl.textContent = 'Ã— ' + x.toFixed(2); }
      function save(scale){
        return fetch('/api/ui_prefs', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ font_scale: scale })
        }).then(r=>r.json());
      }
      function getCurrent(){
        try { return parseFloat((vEl.textContent||'').replace(/[Ã—\s]/g,'')) || 1.00; } catch(e){ return 1.00; }
      }
      if (btnMinus) btnMinus.addEventListener('click', async function(){
        let cur = getCurrent();
        cur = Math.max(0.85, (cur - 0.05));
        setVal(cur);
        try { const res = await save(cur); if (!res.ok) throw 0; } catch(e){ alert('×©×’×™××” ×‘×©××™×¨×ª ×’×•×“×œ ×”×’×•×¤×Ÿ'); }
        location.reload();
      });
      if (btnPlus) btnPlus.addEventListener('click', async function(){
        let cur = getCurrent();
        cur = Math.min(1.60, (cur + 0.05));
        setVal(cur);
        try { const res = await save(cur); if (!res.ok) throw 0; } catch(e){ alert('×©×’×™××” ×‘×©××™×¨×ª ×’×•×“×œ ×”×’×•×¤×Ÿ'); }
        location.reload();
      });

      if (themeSel) themeSel.addEventListener('change', async function(){
        const html = document.documentElement;
        const prevTheme = ((html.getAttribute('data-theme') || 'classic') + '').trim().toLowerCase();
        const nextTheme = ((themeSel.value || '') + '').trim().toLowerCase();

        const allowed = (window.__ckThemeRipple && Array.isArray(window.__ckThemeRipple.allowedThemes))
          ? window.__ckThemeRipple.allowedThemes
          : ['classic','ocean','rose-pine-dawn','dark','dim','nebula','high-contrast','custom'];

        const isAllowed = (t) => !!t && allowed.indexOf(t) !== -1;
        if (!isAllowed(nextTheme)) {
          alert('×¢×¨×›×ª × ×•×©× ×œ× × ×ª××›×ª');
          try { themeSel.value = prevTheme; } catch(_) {}
          return;
        }

        // × ×™×”×•×œ ×ª×—×¨×•×ª (race): ×¨×§ ×”×¤×¢×•×œ×” ×”××—×¨×•× ×” ×¨×©××™×ª ×œ×‘×¦×¢ rollback/cancel
        const opState = window.__ckThemeSelectOp = window.__ckThemeSelectOp || { seq: 0, controller: null, intendedTheme: null };
        const opId = (opState.seq = (Number(opState.seq) || 0) + 1);
        opState.intendedTheme = nextTheme;
        try {
          if (opState.controller && typeof opState.controller.abort === 'function') {
            opState.controller.abort();
          }
        } catch(_) {}
        try {
          opState.controller = (typeof AbortController !== 'undefined') ? new AbortController() : null;
        } catch(_) {
          opState.controller = null;
        }

        function persistLocal(theme){
          try { localStorage.setItem('user_theme', theme); } catch(_) {}
          try {
            if (theme === 'dark' || theme === 'dim') {
              localStorage.setItem('dark_mode_preference', theme);
            } else if (theme === 'classic') {
              localStorage.setItem('dark_mode_preference', 'light');
            } else {
              localStorage.removeItem('dark_mode_preference');
            }
          } catch(_) {}
        }

        function applyNow(theme){
          try { html.setAttribute('data-theme', theme); } catch(_) {}
        }

        try {
          // ×©××™×¨×” ××§×•××™×ª ×œ×¤× ×™ ×”×›×œ (×›×“×™ ×œ×¡× ×›×¨×Ÿ ×˜××‘×™× ×•×œ×”×—×–×™×§ ×’× ×× ×”×¨×©×ª × ×•×¤×œ×ª)
          persistLocal(nextTheme);

          // ××¤×§×˜ ripple + ×”×—×œ×¤×” ×‘×¡×•×£ ×”×× ×™××¦×™×”
          if (typeof window.applyThemeChangeWithRipple === 'function') {
            window.applyThemeChangeWithRipple(nextTheme, themeSel, applyNow);
          } else {
            applyNow(nextTheme);
          }

          const fetchOpts = {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ theme: nextTheme })
          };
          try {
            if (opState.controller && opState.controller.signal) {
              fetchOpts.signal = opState.controller.signal;
            }
          } catch(_) {}

          const res = await fetch('/api/ui_prefs', fetchOpts);
          const data = await res.json();
          if (!data.ok) throw 0;
        } catch (e) {
          // ×× ×–×• ×œ× ×”×¤×¢×•×œ×” ×”××—×¨×•× ×” â€“ ×œ× ×¢×•×©×™× rollback (××—×¨×ª × ×©×‘×•×¨ ×‘×—×™×¨×” ×—×“×©×”)
          const aborted = !!(e && (e.name === 'AbortError' || String(e).toLowerCase().includes('abort')));
          const stillLatest = (window.__ckThemeSelectOp && window.__ckThemeSelectOp.seq === opId);
          const stillIntended = (window.__ckThemeSelectOp && window.__ckThemeSelectOp.intendedTheme === nextTheme);
          if (aborted || !stillLatest || !stillIntended) {
            return;
          }
          // rollback: ×‘×˜×œ ×× ×™××¦×™×” ×× ×¨×¦×”, ×•×”×—×–×¨ ××ª ×”×¢×¨×š ×”×§×•×“×
          try { if (window.__ckThemeRipple && typeof window.__ckThemeRipple.cancel === 'function') window.__ckThemeRipple.cancel(); } catch(_) {}
          persistLocal(prevTheme);
          applyNow(prevTheme);
          try { themeSel.value = prevTheme; } catch(_) {}
          alert('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¢×¨×›×ª ×”× ×•×©×');
        }
      });

      // Bookmarks toggle visibility controls
      const BM_KEY = 'bookmarks_toggle_btn_visible';
      const bmShow = document.getElementById('bmShowBtn');
      const bmHide = document.getElementById('bmHideBtn');
      const bmState = document.getElementById('bmState');
      function refreshBmState(){
        try {
          const v = localStorage.getItem(BM_KEY);
          const shown = v !== '0';
          if (bmState) bmState.textContent = shown ? '××•×¦×’' : '××•×¡×ª×¨';
        } catch(_) { if (bmState) bmState.textContent = 'â€”'; }
      }
      function setBm(show){
        try { localStorage.setItem(BM_KEY, show ? '1' : '0'); } catch(_) {}
        refreshBmState();
      }
      if (bmShow) bmShow.addEventListener('click', ()=> setBm(true));
      if (bmHide) bmHide.addEventListener('click', ()=> setBm(false));
      refreshBmState();

      const escapeHtml = (value) => {
        if (value === null || value === undefined) return '';
        return String(value).replace(/[&<>"']/g, (char) => {
          switch (char) {
            case '&': return '&amp;';
            case '<': return '&lt;';
            case '>': return '&gt;';
            case '"': return '&quot;';
            case "'": return '&#39;';
            default: return char;
          }
        });
      };

      const formatDateTime = (value) => {
        if (!value) return '×œ× ×–××™×Ÿ';
        try {
          const dt = new Date(value);
          if (Number.isNaN(dt.getTime())) return value;
          return new Intl.DateTimeFormat('he-IL', {
            dateStyle: 'short',
            timeStyle: 'short',
          }).format(dt);
        } catch (e) {
          return value;
        }
      };

      const sanitizeHref = (value) => {
        const href = String(value || '').trim();
        if (!href || href === 'â€”') return '';
        const lower = href.toLowerCase();
        // Avoid javascript: / data: injection vectors.
        if (lower.startsWith('javascript:') || lower.startsWith('data:') || lower.startsWith('vbscript:')) return '';
        // Disallow protocol-relative URLs like //evil.com (can look like internal path).
        if (href.startsWith('//') || href.startsWith('\\\\')) return '';
        // Allow relative, hash, and common safe schemes.
        if (href.startsWith('/') && !href.startsWith('//')) return href;
        if (href.startsWith('#')) return href;
        if (lower.startsWith('http://') || lower.startsWith('https://') || lower.startsWith('mailto:')) return href;
        return '';
      };

      const safeCopyToClipboard = async (raw) => {
        const text = String(raw ?? '');
        if (!text) return false;
        try {
          if (navigator?.clipboard?.writeText && window.isSecureContext) {
            await navigator.clipboard.writeText(text);
            return true;
          }
        } catch (_) {}
        try {
          const ta = document.createElement('textarea');
          ta.value = text;
          ta.setAttribute('readonly', 'true');
          ta.style.position = 'fixed';
          ta.style.top = '0';
          ta.style.left = '-9999px';
          document.body.appendChild(ta);
          ta.focus();
          ta.select();
          const ok = document.execCommand('copy');
          document.body.removeChild(ta);
          return Boolean(ok);
        } catch (_) {
          return false;
        }
      };

      const bindRadarCopyButtons = (root) => {
        if (!root) return;
        root.querySelectorAll('.radar-action-copy').forEach((btn) => {
          if (btn.dataset.bound === '1') return;
          btn.dataset.bound = '1';
          btn.addEventListener('click', async (event) => {
            event.preventDefault();
            const encoded = btn.dataset.copy || '';
            let text = '';
            try { text = decodeURIComponent(encoded); } catch (_) { text = encoded; }
            const prev = btn.textContent;
            btn.disabled = true;
            const ok = await safeCopyToClipboard(text);
            btn.textContent = ok ? '×”×•×¢×ª×§' : '×©×’×™××”';
            setTimeout(() => {
              btn.textContent = prev;
              btn.disabled = false;
            }, 1200);
          });
        });
      };

      const initConfigRadar = () => {
        const card = document.getElementById('configRadarCard');
        if (!card) return;
        const urlParams = new URLSearchParams(window.location.search || '');

        const statusEl = card.querySelector('[data-radar-status]');
        const timestampEl = card.querySelector('[data-radar-timestamp]');
        const refreshBtn = document.getElementById('configRadarRefreshBtn');
        const validateBtn = document.getElementById('configRadarValidateBtn');
        const tabs = Array.from(card.querySelectorAll('.radar-tab'));
        const panels = Array.from(card.querySelectorAll('.radar-panel'));
        const slots = {
          alerts: card.querySelector('#configRadarAlerts'),
          errors: card.querySelector('#configRadarErrors'),
          images: card.querySelector('#configRadarImages'),
          quickfixes: card.querySelector('#configRadarQuickFixes'),
          runbooks: card.querySelector('#configRadarRunbooks'),
          coverage: card.querySelector('#configRadarCoverage'),
        };

        let isLoading = false;
        let coverageLoading = false;
        let coverageCache = null;
        const coverageState = {
          minCount: Number(urlParams.get('min_count') || '1') || 1,
          search: (urlParams.get('alert_type') || urlParams.get('q') || '').trim().toLowerCase(),
        };
        coverageState.minCount = Math.max(1, Math.min(10_000, Math.floor(coverageState.minCount || 1)));

        const setStatus = (message, variant = 'muted', extraHtml = '') => {
          if (!statusEl) return;
          let badgeClass = 'badge';
          if (variant === 'success') badgeClass += ' badge-success';
          if (variant === 'error') badgeClass += ' badge-danger';
          statusEl.innerHTML = `<span class="${badgeClass}">${escapeHtml(message)}</span>${extraHtml}`;
        };

        const buildIssuesList = (issues = []) => {
          if (!issues.length) {
            return '';
          }
          const countLabel = `<div class="radar-issues-count">${issues.length} ×‘×¢×™×•×ª ××•×ª×¨×•</div>`;
          const listItems = issues.map((issue, idx) => {
            const scope = [issue.file, issue.field].filter(Boolean).join(' â€¢ ');
            return `<li><span class="radar-issue-index">#${idx + 1}</span> ${escapeHtml(scope || '×œ× ×™×“×•×¢')} â€“ ${escapeHtml(issue.message || '')}</li>`;
          }).join('');
          return `${countLabel}<ul class="radar-issues" aria-live="polite">${listItems}</ul>`;
        };

        const activatePanel = (panelName) => {
          tabs.forEach((btn) => {
            btn.classList.toggle('active', btn.dataset.panel === panelName);
          });
          panels.forEach((panel) => {
            panel.classList.toggle('active', panel.dataset.panel === panelName);
          });
          if (panelName === 'coverage') {
            fetchCoverage().catch(() => {});
          }
        };

        tabs.forEach((btn) => {
          btn.addEventListener('click', () => {
            activatePanel(btn.dataset.panel);
          });
        });

        const buildGitMeta = (meta = {}, fallbackPath) => {
          const bits = [];
          if (meta.path || fallbackPath) bits.push(`×§×•×‘×¥: ${escapeHtml(meta.path || fallbackPath || '')}`);
          if (meta.last_updated) bits.push(`×¢×•×“×›×Ÿ: ${escapeHtml(formatDateTime(meta.last_updated))}`);
          if (meta.author) bits.push(`×¢\"×™ ${escapeHtml(meta.author)}`);
          if (meta.last_commit) bits.push(`Commit ${escapeHtml(meta.last_commit)}`);
          if (!bits.length) return '';
          return `<div class="radar-meta">${bits.map((bit) => `<span>${bit}</span>`).join('')}</div>`;
        };

        const buildAlertsPanel = (snapshot) => {
          const alerts = snapshot?.alerts || {};
          const categories = snapshot?.error_signatures?.categories || [];
          const kpis = [
            { label: '×—×œ×•×Ÿ ×–××Ÿ (×“×§×³)', value: alerts.window_minutes },
            { label: '×¡×£ min_count', value: alerts.min_count_default },
            { label: 'Cooldown (×“×§×³)', value: alerts.cooldown_minutes },
          ];
          const kpiHtml = kpis.map((kpi) => `
            <div class="radar-kpi">
              <strong>${escapeHtml(kpi.value ?? 'â€”')}</strong>
              <span>${escapeHtml(kpi.label)}</span>
            </div>
          `).join('');
          const immediate = (alerts.immediate_categories || []).map((cat) => `<span class="radar-chip">${escapeHtml(cat)}</span>`).join(' ') || '<span class="radar-chip">×œ× ×”×•×’×“×¨×•</span>';
          const rows = categories.length ? categories.map((cat) => `
            <tr>
              <td>${escapeHtml(cat.name || '')}</td>
              <td>${escapeHtml(cat.description || '')}</td>
              <td><span class="radar-badge severity">${escapeHtml(cat.default_severity || '')}</span></td>
              <td><span class="radar-badge policy">${escapeHtml(cat.default_policy || '')}</span></td>
              <td>${cat.is_immediate ? '<span class="radar-badge immediate">Immediate</span>' : 'â€”'}</td>
              <td>${escapeHtml(cat.total_signatures ?? 0)}</td>
            </tr>
          `).join('') : '<tr><td colspan="6">×œ× × ××¦××• ×§×˜×’×•×¨×™×•×ª ×‘×§×•×‘×¥</td></tr>';
          return `
            ${buildGitMeta(alerts.git, alerts.path)}
            <div class="radar-grid">${kpiHtml}</div>
            <div>
              <strong>Immediate categories:</strong>
              ${immediate}
            </div>
            <table class="radar-table">
              <thead>
                <tr>
                  <th>×§×˜×’×•×¨×™×”</th>
                  <th>×ª×™××•×¨</th>
                  <th>×—×•××¨×”</th>
                  <th>××“×™× ×™×•×ª</th>
                  <th>Immediate</th>
                  <th>×—×ª×™××•×ª</th>
                </tr>
              </thead>
              <tbody>${rows}</tbody>
            </table>
          `;
        };

        const buildErrorsPanel = (snapshot) => {
          const signatures = snapshot?.error_signatures || {};
          const allowlist = signatures.noise_allowlist || [];
          const allowlistHtml = allowlist.length
            ? allowlist.map((expr) => `<code dir="ltr">${escapeHtml(expr)}</code>`).join(' ')
            : '<span class="radar-chip">×œ× ×”×•×’×“×¨</span>';
          const categories = signatures.categories || [];
          const categoriesHtml = categories.length
            ? categories.map((cat) => {
                const signaturesHtml = (cat.signatures || []).map((sig) => `
                  <div class="radar-signature">
                    <div><strong>${escapeHtml(sig.summary || sig.id || '')}</strong></div>
                    <code dir="ltr">${escapeHtml(sig.pattern || '')}</code>
                    <div>
                      <span class="radar-badge severity">${escapeHtml(sig.severity || '')}</span>
                      <span class="radar-badge policy">${escapeHtml(sig.policy || '')}</span>
                    </div>
                  </div>
                `).join('') || '<div class="radar-empty-state">××™×Ÿ ×—×ª×™××•×ª ×‘×§×˜×’×•×¨×™×” ×–×•</div>';
                return `
                  <details class="radar-accordion"${cat.is_immediate ? ' open' : ''}>
                    <summary>
                      <div>
                        <strong>${escapeHtml(cat.name || '')}</strong>
                        ${cat.is_immediate ? '<span class="radar-badge immediate">Immediate</span>' : ''}
                      </div>
                      <div>
                        <span class="radar-badge severity">${escapeHtml(cat.default_severity || '')}</span>
                        <span class="radar-badge policy">${escapeHtml(cat.default_policy || '')}</span>
                        <span class="radar-chip">${escapeHtml(cat.total_signatures ?? 0)} ×—×ª×™××•×ª</span>
                      </div>
                    </summary>
                    <div class="radar-accordion-body">
                      <p style="opacity:0.8">${escapeHtml(cat.description || '')}</p>
                      ${signaturesHtml}
                    </div>
                  </details>
                `;
              }).join('')
            : '<div class="radar-empty-state">×œ× ×§×™×™××•×ª ×§×˜×’×•×¨×™×•×ª ×‘×§×•×‘×¥ error_signatures.yml</div>';
          return `
            ${buildGitMeta(signatures.git, signatures.path)}
            <div>
              <strong>Noise allowlist:</strong>
              ${allowlistHtml}
            </div>
            ${categoriesHtml}
          `;
        };

        const buildImagesPanel = (snapshot) => {
          const settings = snapshot?.image_settings || {};
          const preview = settings.preview || {};
          const imageAll = settings.image_all || {};
          const supported = (settings.supported_formats || []).map((fmt) => `<span class="radar-chip">${escapeHtml(fmt)}</span>`).join(' ') || '<span class="radar-chip">×œ× ×”×•×’×“×¨</span>';
          const widths = (settings.width_options || []).map((w) => `<span class="radar-chip">${escapeHtml(w)}px</span>`).join(' ') || '<span class="radar-chip">×œ× ×”×•×’×“×¨</span>';
          return `
            ${buildGitMeta(settings.git, settings.path)}
            <div class="radar-grid">
              <div class="radar-kpi"><strong>${escapeHtml(settings.default_theme || 'dark')}</strong><span>×¢×¨×›×ª × ×•×©×</span></div>
              <div class="radar-kpi"><strong>${escapeHtml(settings.default_style || 'â€”')}</strong><span>×¡×’× ×•×Ÿ</span></div>
              <div class="radar-kpi"><strong>${escapeHtml(settings.default_width ?? 'â€”')}px</strong><span>×¨×•×—×‘ ×‘×¨×™×¨×ª ××—×“×œ</span></div>
              <div class="radar-kpi"><strong>${escapeHtml(settings.default_font_size ?? 'â€”')}px</strong><span>×’×•×“×œ ×’×•×¤×Ÿ</span></div>
            </div>
            <div class="radar-grid">
              <div class="radar-kpi">
                <strong>${escapeHtml(preview.max_lines ?? 'â€”')}</strong>
                <span>Preview max lines</span>
                <small>××•× ×¢ ×’×œ×¨×™×” ×›×‘×“×” ×‘××¡×š ×”×¦×¤×™×™×” ×”××§×“×™××”</small>
              </div>
              <div class="radar-kpi">
                <strong>${escapeHtml(imageAll.max_lines ?? 'â€”')}</strong>
                <span>Image all â€“ max lines</span>
                <small>××•× ×¢ ×¢×•××¡ ×¢×œ ×× ×’× ×•×Ÿ ×”×™×™×¦×•×</small>
              </div>
              <div class="radar-kpi">
                <strong>${escapeHtml(imageAll.max_total_chars ?? 'â€”')}</strong>
                <span>×ª×§×¦×™×‘ ×ª×•×•×™×</span>
                <small>×©×•××¨ ×¢×œ ×™×¦×™×‘×•×ª ×•×¦×¨×™×›×ª ×–×™×›×¨×•×Ÿ</small>
              </div>
              <div class="radar-kpi">
                <strong>${escapeHtml(imageAll.max_images ?? 'â€”')}</strong>
                <span>×›××•×ª ×ª××•× ×•×ª</span>
                <small>××’×‘×œ×” ×œ×¤×¨×•×¡×¡ ×™×—×™×“</small>
              </div>
            </div>
            <div>
              <strong>×¤×•×¨××˜×™× × ×ª××›×™×:</strong>
              ${supported}
            </div>
            <div>
              <strong>×¨×•×—×‘×™× ×–××™× ×™×:</strong>
              ${widths}
            </div>
          `;
        };

        const renderActionChips = (actions = []) => {
          if (!Array.isArray(actions) || !actions.length) {
            return '<span class="radar-chip">â€”</span>';
          }
        return actions.map((action) => {
          const label = escapeHtml(action?.label || 'â€”');
          const typeRaw = String(action?.type || '');
          const type = typeRaw.toLowerCase();
          const value = String(action?.value || '');

          if (type === 'link') {
            const href = sanitizeHref(value);
            if (href) {
              return `<span class="radar-chip radar-action-chip">
                ${label}
                <span style="opacity:0.6;">â€¢</span>
                <a class="radar-action-link" href="${escapeHtml(href)}" target="_blank" rel="noopener">link</a>
              </span>`;
            }
          }
          if (type === 'copy') {
            const payload = value && value !== 'â€”' ? value : '';
            if (payload) {
              return `<span class="radar-chip radar-action-chip">
                ${label}
                <span style="opacity:0.6;">â€¢</span>
                <button class="radar-action-copy" type="button" data-copy="${encodeURIComponent(payload)}">copy</button>
              </span>`;
            }
          }

          const typeLabel = escapeHtml(typeRaw);
          return `<span class="radar-chip">
            ${label}
            ${typeLabel ? `<small style="display:block; opacity:0.7">${typeLabel}</small>` : ''}
          </span>`;
        }).join(' ');
        };

      const renderRunbookStepAction = (step) => {
        const rawLabel = String(step?.action_label || '').trim();
        if (!rawLabel) return '';
        const typeRaw = String(step?.action_type || '');
        const type = typeRaw.toLowerCase();
        const value = String(step?.action_value || '');
        const label = escapeHtml(rawLabel);

        if (type === 'link') {
          const href = sanitizeHref(value);
          if (href) {
            return `<span class="radar-chip radar-action-chip">
              ${label}
              <span style="opacity:0.6;">â€¢</span>
              <a class="radar-action-link" href="${escapeHtml(href)}" target="_blank" rel="noopener">link</a>
            </span>`;
          }
        }
        if (type === 'copy') {
          const payload = value && value !== 'â€”' ? value : '';
          if (payload) {
            return `<span class="radar-chip radar-action-chip">
              ${label}
              <span style="opacity:0.6;">â€¢</span>
              <button class="radar-action-copy" type="button" data-copy="${encodeURIComponent(payload)}">copy</button>
            </span>`;
          }
        }

        const typeLabel = escapeHtml(typeRaw);
        return `<span class="radar-chip">${label}${typeLabel ? ` â€¢ ${typeLabel}` : ''}</span>`;
      };

        const buildQuickFixPanel = (snapshot) => {
          const quick = snapshot?.quick_fixes || {};
          const kpis = [
            { label: '×’×¨×¡×”', value: quick.version },
            { label: 'Alert types', value: quick.total_alert_types },
            { label: 'Rules ×œ×¤×™ ×—×•××¨×”', value: quick.total_severity_rules },
            { label: 'Fallback actions', value: quick.total_fallback },
          ];
          const kpiHtml = kpis.map((kpi) => `
            <div class="radar-kpi">
              <strong>${escapeHtml(kpi.value ?? 'â€”')}</strong>
              <span>${escapeHtml(kpi.label)}</span>
            </div>
          `).join('');
          const alertRows = (quick.alert_types || []).length
            ? (quick.alert_types || []).map((entry) => `
                <tr>
                  <td>${escapeHtml(entry.name || '')}</td>
                  <td>${escapeHtml(entry.actions_count ?? 0)}</td>
                  <td>${renderActionChips(entry.sample_actions || [])}</td>
                </tr>
              `).join('')
            : '<tr><td colspan="3">×œ× ×”×•×’×“×¨×• Quick Fixes ×œ×¤×™ ×¡×•×’ ×”×ª×¨××”</td></tr>';
          const severityRows = (quick.severity_rules || []).length
            ? (quick.severity_rules || []).map((entry) => `
                <tr>
                  <td>${escapeHtml(entry.severity || '')}</td>
                  <td>${escapeHtml(entry.actions_count ?? 0)}</td>
                  <td>${renderActionChips(entry.sample_actions || [])}</td>
                </tr>
              `).join('')
            : '<tr><td colspan="3">×œ× ×”×•×’×“×¨×• ×›×œ×œ×™× ×œ×¤×™ ×—×•××¨×”</td></tr>';
          const fallbackHtml = renderActionChips(quick.fallback_actions || []);

          return `
            ${buildGitMeta(quick.git, quick.path)}
            <div class="radar-grid">${kpiHtml}</div>
            <h4>×¤×¢×•×œ×•×ª ×œ×¤×™ Alert Type</h4>
            <table class="radar-table">
              <thead>
                <tr>
                  <th>Alert</th>
                  <th>×›××•×ª ×¤×¢×•×œ×•×ª</th>
                  <th>×“×•×’×××•×ª</th>
                </tr>
              </thead>
              <tbody>${alertRows}</tbody>
            </table>
            <h4>×¤×¢×•×œ×•×ª ×œ×¤×™ Severity</h4>
            <table class="radar-table">
              <thead>
                <tr>
                  <th>×—×•××¨×”</th>
                  <th>×›××•×ª ×¤×¢×•×œ×•×ª</th>
                  <th>×“×•×’×××•×ª</th>
                </tr>
              </thead>
              <tbody>${severityRows}</tbody>
            </table>
            <div>
              <strong>Fallback:</strong>
              ${fallbackHtml}
            </div>
          `;
        };

        const buildRunbooksPanel = (snapshot) => {
          const runbooks = snapshot?.runbooks || {};
          const kpis = [
            { label: '×’×¨×¡×”', value: runbooks.version },
            { label: '××¡×¤×¨ Runbooks', value: runbooks.total_runbooks },
            { label: 'Runbook ×‘×¨×™×¨×ª ××—×“×œ', value: runbooks.default_runbook || 'â€”' },
          ];
          const kpiHtml = kpis.map((kpi) => `
            <div class="radar-kpi">
              <strong>${escapeHtml(kpi.value ?? 'â€”')}</strong>
              <span>${escapeHtml(kpi.label)}</span>
            </div>
          `).join('');
          const runbookItems = (runbooks.runbooks || []).length
            ? (runbooks.runbooks || []).map((book) => {
                const aliases = (book.aliases || []).map((alias) => `<span class="radar-chip">${escapeHtml(alias)}</span>`).join(' ') || '<span class="radar-chip">â€”</span>';
                const steps = (book.steps || []).length
                  ? (book.steps || []).map((step) => `
                      <li>
                        <strong>${escapeHtml(step.title || step.id || '')}</strong>
                        ${step.action_label ? renderRunbookStepAction(step) : ''}
                      </li>
                    `).join('')
                  : '<li>×œ× ×”×•×’×“×¨×• ×¦×¢×“×™× ×œ×“×•×’××”</li>';
                return `
                  <details class="radar-accordion">
                    <summary>
                      <div>
                        <strong>${escapeHtml(book.title || book.name || '')}</strong>
                        <span class="radar-chip">${escapeHtml(book.steps_count ?? 0)} ×¦×¢×“×™×</span>
                      </div>
                      <div style="opacity:0.8">${escapeHtml(book.description || '')}</div>
                    </summary>
                    <div class="radar-accordion-body">
                      <div><strong>Aliases:</strong> ${aliases}</div>
                      <ol class="radar-list">${steps}</ol>
                    </div>
                  </details>
                `;
              }).join('')
            : '<div class="radar-empty-state">×œ× ×§×™×™××™× Runbooks ×‘×§×•×‘×¥</div>';
          return `
            ${buildGitMeta(runbooks.git, runbooks.path)}
            <div class="radar-grid">${kpiHtml}</div>
            ${runbookItems}
          `;
        };

        const buildCoverageControls = () => {
          return `
            <div class="radar-controls">
              <label>
                ××™× ×™××•× ×”×•×¤×¢×•×ª (All-time)
                <input id="configRadarCoverageMinCount" type="number" min="1" step="1" value="${escapeHtml(String(coverageState.minCount))}" />
              </label>
              <label style="flex:1; min-width: 220px;">
                ×—×™×¤×•×© (alert_type / runbook)
                <input id="configRadarCoverageSearch" type="search" placeholder="×œ××©×œ: high_error_rate" value="${escapeHtml(coverageState.search)}" />
              </label>
              <button class="btn btn-secondary" id="configRadarCoverageRefreshBtn" type="button">×¨×¢× ×Ÿ</button>
            </div>
          `;
        };

        const buildCoverageTable = (title, rows, kind) => {
          const header = `
            <h4 style="margin: 0.25rem 0 0.6rem;">${escapeHtml(title)} <span class="radar-chip">${escapeHtml(String(rows.length))}</span></h4>
          `;
          if (!rows.length) {
            return `${header}<div class="radar-empty-state">××™×Ÿ ×¤×¨×™×˜×™× ×œ×”×¦×’×”</div>`;
          }
          if (kind === 'missing') {
            const body = rows.map((r) => {
              const alertType = escapeHtml(r.alert_type || '');
              const count = escapeHtml(String(r.count ?? 0));
              const lastSeen = escapeHtml(formatDateTime(r.last_seen_ts));
              const sample = escapeHtml(r.sample_title || '');
              const obsHref = `/admin/observability?timerange=24h&alert_type=${encodeURIComponent(r.alert_type || '')}`;
              const selfHref = `/settings?config_radar_tab=coverage&min_count=${encodeURIComponent(String(coverageState.minCount))}&alert_type=${encodeURIComponent(r.alert_type || '')}#configRadarCard`;
              return `
                <tr>
                  <td><code dir="ltr">${alertType}</code></td>
                  <td>${count}</td>
                  <td>${lastSeen}</td>
                  <td>${sample || 'â€”'}</td>
                  <td>
                    <a class="radar-link" href="${selfHref}">×¤×ª×— Config Radar</a>
                    <span style="opacity:0.6;">|</span>
                    <a class="radar-link" href="${obsHref}" target="_blank" rel="noopener">×¤×ª×— Observability</a>
                  </td>
                </tr>
              `;
            }).join('');
            return `
              ${header}
              <table class="radar-table">
                <thead>
                  <tr>
                    <th>alert_type</th>
                    <th>Count</th>
                    <th>Last Seen</th>
                    <th>×“×•×’××”</th>
                    <th>×¤×¢×•×œ×•×ª</th>
                  </tr>
                </thead>
                <tbody>${body}</tbody>
              </table>
            `;
          }
          if (kind === 'orphan_runbooks') {
            const body = rows.map((r) => {
              const key = escapeHtml(r.runbook_key || '');
              const aliases = (r.aliases || []).map(a => `<span class="radar-chip"><code dir="ltr">${escapeHtml(a)}</code></span>`).join(' ') || '<span class="radar-chip">â€”</span>';
              return `
                <tr>
                  <td><code dir="ltr">${key}</code></td>
                  <td>${aliases}</td>
                </tr>
              `;
            }).join('');
            return `
              ${header}
              <table class="radar-table">
                <thead>
                  <tr>
                    <th>runbook_key</th>
                    <th>aliases</th>
                  </tr>
                </thead>
                <tbody>${body}</tbody>
              </table>
            `;
          }
          // orphan_quick_fixes
          const body = rows.map((r) => {
            const alertType = escapeHtml(r.alert_type || '');
            return `<tr><td><code dir="ltr">${alertType}</code></td></tr>`;
          }).join('');
          return `
            ${header}
            <table class="radar-table">
              <thead><tr><th>alert_type</th></tr></thead>
              <tbody>${body}</tbody>
            </table>
          `;
        };

        const applyCoverageFilters = (payload) => {
          const q = (coverageState.search || '').trim().toLowerCase();
          if (!q) return payload;
          const filterByType = (rows) => (rows || []).filter(r => String(r.alert_type || r.runbook_key || '').toLowerCase().includes(q));
          const filtered = { ...payload };
          filtered.missing_runbooks = filterByType(payload.missing_runbooks || []);
          filtered.missing_quick_fixes = filterByType(payload.missing_quick_fixes || []);
          filtered.orphan_quick_fixes = filterByType(payload.orphan_quick_fixes || []);
          filtered.orphan_runbooks = (payload.orphan_runbooks || []).filter(r => {
            const key = String(r.runbook_key || '').toLowerCase();
            const aliases = Array.isArray(r.aliases) ? r.aliases.map(a => String(a || '').toLowerCase()) : [];
            return key.includes(q) || aliases.some(a => a.includes(q));
          });
          return filtered;
        };

        const renderCoverage = (payload) => {
          if (!slots.coverage) return;
          const filtered = applyCoverageFilters(payload || {});
          const meta = payload?.meta || {};
          const metaHtml = `
            <div class="radar-meta" style="margin-top:0.25rem;">
              <span><strong>××¦×‘:</strong> ${escapeHtml(meta.mode || 'catalog')}</span>
              <span><strong>Catalog:</strong> ${escapeHtml(String(meta.catalog_total ?? 'â€”'))} alert_types</span>
              <span><strong>× ×•×¦×¨:</strong> ${escapeHtml(formatDateTime(meta.generated_at))}</span>
            </div>
          `;
          slots.coverage.innerHTML = `
            ${buildCoverageControls()}
            ${metaHtml}
            <div style="display:flex; flex-direction:column; gap: 1.25rem; margin-top: 1rem;">
              <div>${buildCoverageTable('ğŸ”´ Missing Runbooks', filtered.missing_runbooks || [], 'missing')}</div>
              <div>${buildCoverageTable('ğŸŸ  Missing Quick Fixes (×œ××¨×•×ª Runbook)', filtered.missing_quick_fixes || [], 'missing')}</div>
              <div>${buildCoverageTable('ğŸ‘» Orphan Runbooks', filtered.orphan_runbooks || [], 'orphan_runbooks')}</div>
              <div>${buildCoverageTable('ğŸ‘» Orphan Quick Fixes', filtered.orphan_quick_fixes || [], 'orphan_quick_fixes')}</div>
            </div>
          `;

          const minEl = document.getElementById('configRadarCoverageMinCount');
          const searchEl = document.getElementById('configRadarCoverageSearch');
          const refreshEl = document.getElementById('configRadarCoverageRefreshBtn');
          if (minEl) minEl.addEventListener('change', () => {
            const v = Number(minEl.value || '1') || 1;
            coverageState.minCount = Math.max(1, Math.min(10_000, Math.floor(v)));
            minEl.value = String(coverageState.minCount);
            fetchCoverage().catch(() => {});
          });
          if (searchEl) {
            let timer;
            searchEl.addEventListener('input', () => {
              clearTimeout(timer);
              timer = setTimeout(() => {
                coverageState.search = String(searchEl.value || '').trim().toLowerCase();
                if (coverageCache) renderCoverage(coverageCache);
              }, 200);
            });
          }
          if (refreshEl) refreshEl.addEventListener('click', () => fetchCoverage().catch(() => {}));
        };

        const fetchCoverage = async () => {
          if (!slots.coverage || coverageLoading) return;
          coverageLoading = true;
          const params = new URLSearchParams({
            min_count: String(coverageState.minCount),
          });
          slots.coverage.innerHTML = '<div class="radar-empty-state">×˜×•×¢×Ÿ ×“×•×— ×›×™×¡×•×™â€¦</div>';
          try {
            const res = await fetch('/api/observability/coverage?' + params.toString(), { cache: 'no-store', credentials: 'same-origin' });
            if (!res.ok) throw new Error('request_failed');
            const payload = await res.json();
            if (!payload || payload.ok === false) throw new Error(payload?.error || 'coverage_failed');
            coverageCache = payload;
            renderCoverage(payload);
          } catch (e) {
            slots.coverage.innerHTML = '<div class="radar-empty-state">×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ ×“×•×— ×›×™×¡×•×™ ×›×¨×’×¢.</div>';
          } finally {
            coverageLoading = false;
          }
        };

        const renderSnapshot = (snapshot) => {
          const validation = snapshot?.validation;
          const ok = validation?.status === 'ok';
          const issuesHtml = validation && validation.status !== 'ok'
            ? buildIssuesList(validation.issues || [])
            : '';
          setStatus(
            ok ? '×”×›×•×œ ×ª×§×™×Ÿ ×œ×¤×™ ×”×¡×›××•×ª' : '× ××¦××• ×‘×¢×™×•×ª ×‘×§×‘×¦×™ ×”×§×•× ×¤×™×’×•×¨×¦×™×”',
            ok ? 'success' : 'error',
            issuesHtml
          );
          if (timestampEl) {
            timestampEl.textContent = snapshot?.checked_at
              ? `×¢×•×“×›×Ÿ ×‘-${formatDateTime(snapshot.checked_at)}`
              : '';
          }
          if (slots.alerts) slots.alerts.innerHTML = buildAlertsPanel(snapshot);
          if (slots.errors) slots.errors.innerHTML = buildErrorsPanel(snapshot);
          if (slots.images) slots.images.innerHTML = buildImagesPanel(snapshot);
          if (slots.quickfixes) slots.quickfixes.innerHTML = buildQuickFixPanel(snapshot);
          if (slots.runbooks) slots.runbooks.innerHTML = buildRunbooksPanel(snapshot);
          bindRadarCopyButtons(card);
        };

        const fetchSnapshot = async (label) => {
          if (isLoading) return;
          isLoading = true;
          card.classList.add('loading');
          setStatus(label || '×˜×•×¢×Ÿ × ×ª×•× ×™×...', 'muted');
          try {
            const res = await fetch('/api/config/radar', { cache: 'no-store', credentials: 'same-origin' });
            if (!res.ok) throw new Error('request_failed');
            const payload = await res.json();
            renderSnapshot(payload);
          } catch (e) {
            setStatus('×©×’×™××” ×‘×˜×¢×™× ×ª Config Radar', 'error');
            Object.values(slots).forEach((slot) => {
              if (slot) slot.innerHTML = '<div class="radar-empty-state">×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ × ×ª×•× ×™× ×›×¨×’×¢.</div>';
            });
          } finally {
            isLoading = false;
            card.classList.remove('loading');
          }
        };

        refreshBtn?.addEventListener('click', () => fetchSnapshot('××¨×¢× ×Ÿ × ×ª×•× ×™×...'));
        validateBtn?.addEventListener('click', () => fetchSnapshot('××¨×™×¥ ×•×œ×™×“×¦×™×”...'));

        fetchSnapshot();

        // Optional deep-link to a specific tab (e.g. ?config_radar_tab=coverage)
        const requestedTab = (urlParams.get('config_radar_tab') || urlParams.get('radar_tab') || '').toLowerCase();
        if (requestedTab && ['alerts','errors','images','quickfixes','runbooks','coverage'].includes(requestedTab)) {
          activatePanel(requestedTab);
        }
      };

      const initSmoothScrollSettingsCard = () => {
        const card = document.getElementById('smoothScrollSettingsCard');
        if (!card) return;
        const noteEl = document.getElementById('smoothScrollSettingsNote');
        const els = {
          enabled: document.getElementById('smoothScrollEnabledToggle'),
          duration: document.getElementById('smoothScrollDuration'),
          durationLabel: document.getElementById('smoothScrollDurationValue'),
          easing: document.getElementById('smoothScrollEasing'),
          wheel: document.getElementById('smoothScrollWheel'),
          wheelLabel: document.getElementById('smoothScrollWheelValue'),
          keyboard: document.getElementById('smoothScrollKeyboard'),
          keyboardLabel: document.getElementById('smoothScrollKeyboardValue'),
          momentum: document.getElementById('smoothScrollMomentum'),
          momentumLabel: document.getElementById('smoothScrollMomentumValue'),
          test: document.getElementById('smoothScrollTestBtn'),
          reset: document.getElementById('smoothScrollResetBtn'),
        };
        const disableUi = (message, options = {}) => {
          const { keepTestButton = false } = options;
          card.querySelectorAll('input, select, button').forEach((el) => {
            if (keepTestButton && els.test && el === els.test) return;
            el.disabled = true;
          });
          if (noteEl && message) noteEl.textContent = message;
        };

        let activeTestMarker = null;
        let activeTestMarkerTimeout = null;

        const clearActiveTestMarker = () => {
          if (activeTestMarkerTimeout) {
            clearTimeout(activeTestMarkerTimeout);
            activeTestMarkerTimeout = null;
          }
          if (activeTestMarker) {
            try { activeTestMarker.remove(); } catch (_) {}
            activeTestMarker = null;
          }
        };

        const createScrollTestMarker = () => {
          if (!document?.body) return null;
          const marker = document.createElement('div');
          marker.id = 'smooth-scroll-test-target';
          marker.style.position = 'absolute';
          marker.style.left = '0';
          marker.style.width = '1px';
          marker.style.height = '1px';
          marker.style.pointerEvents = 'none';
          const docHeight = Math.max(
            document.body?.scrollHeight || 0,
            document.documentElement?.scrollHeight || 0,
            window.innerHeight || 0,
            800,
          );
          marker.style.top = `${Math.max(200, Math.floor(docHeight / 2))}px`;
          document.body.appendChild(marker);
          activeTestMarker = marker;
          activeTestMarkerTimeout = setTimeout(() => clearActiveTestMarker(), 6000);
          return marker;
        };

        const fallbackScrollTo = (targetY, onDone) => {
          try {
            window.scrollTo({ top: targetY, behavior: 'smooth' });
          } catch (_) {
            window.scrollTo(0, targetY);
          }
          setTimeout(() => {
            if (typeof onDone === 'function') onDone();
          }, 500);
        };

        const runNativeScrollTest = (marker) => {
          if (!marker) return;
          const absoluteTop = (() => {
            try {
              const rect = marker.getBoundingClientRect();
              return Math.max(0, (window.scrollY || window.pageYOffset || 0) + rect.top);
            } catch (_) {
              return 0;
            }
          })();
          fallbackScrollTo(absoluteTop, () => {
            setTimeout(() => {
              fallbackScrollTo(0, () => {
                clearActiveTestMarker();
              });
            }, 300);
          });
        };

        const runScrollTest = () => {
          clearActiveTestMarker();
          const marker = createScrollTestMarker();
          if (!marker) return;
          const manager = window.smoothScroll;
          if (manager && typeof manager.smoothScrollTo === 'function') {
            try {
              manager.smoothScrollTo(marker, {
                callback: () => {
                  setTimeout(() => {
                    try {
                      manager.smoothScrollTo('body');
                    } catch (_) {
                      fallbackScrollTo(0, () => clearActiveTestMarker());
                      return;
                    }
                    clearActiveTestMarker();
                  }, 300);
                },
              });
              return;
            } catch (_) {
              // fall through to native scroll fallback
            }
          }
          runNativeScrollTest(marker);
        };

        if (els.test) {
          els.test.addEventListener('click', (event) => {
            event.preventDefault();
            runScrollTest();
          });
        }

        const attach = (manager) => {
          const defaults = { ...(manager.defaultConfig || {}) };
          const reducePref = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
          if (noteEl && reducePref) {
            noteEl.textContent = '×œ××¢×¨×›×ª ××•×’×“×¨ "×”×¤×—×ª ×× ×™××¦×™×•×ª", ×›×š ×©×”×’×œ×™×œ×” ×”×—×œ×§×” ×ª×›×•×‘×” ×’× ×× ×”××¤×©×¨×•×ª ××¡×•×× ×ª.';
          }

          const fmtMs = (v) => `${Math.round(v)}ms`;
          const fmtX = (v) => `${v.toFixed(1)}Ã—`;
          const fmtAmp = (v) => `${Math.round(v)}Ã—`;

          const setSlider = (input, label, value, formatter) => {
            if (!input || !label || typeof value !== 'number' || Number.isNaN(value)) return;
            input.value = String(value);
            label.textContent = formatter(value);
          };

          const refresh = () => {
            const cfg = manager.config || defaults;
            if (els.enabled) els.enabled.checked = !!cfg.enabled;
            setSlider(els.duration, els.durationLabel, cfg.duration ?? defaults.duration ?? 400, fmtMs);
            setSlider(els.wheel, els.wheelLabel, cfg.wheelSensitivity ?? defaults.wheelSensitivity ?? 1, fmtX);
            setSlider(els.keyboard, els.keyboardLabel, cfg.keyboardSensitivity ?? defaults.keyboardSensitivity ?? 1.5, fmtX);
            setSlider(els.momentum, els.momentumLabel, cfg.androidMomentumAmplifier ?? defaults.androidMomentumAmplifier ?? 26, fmtAmp);
            if (els.easing) {
              els.easing.value = cfg.easing || 'ease-in-out';
            }
          };

          const commit = (partial) => {
            manager.updateConfig(partial);
            if (Object.prototype.hasOwnProperty.call(partial, 'enabled')) {
              partial.enabled ? manager.enable() : manager.disable();
            }
            refresh();
          };

          const bindRange = (input, label, formatter, key) => {
            if (!input || !label) return;
            input.addEventListener('input', () => {
              const val = Number(input.value);
              if (!Number.isNaN(val)) label.textContent = formatter(val);
            });
            input.addEventListener('change', () => {
              const val = Number(input.value);
              if (!Number.isNaN(val)) {
                const payload = {};
                payload[key] = val;
                commit(payload);
              }
            });
          };

          if (els.enabled) {
            els.enabled.addEventListener('change', () => {
              commit({ enabled: !!els.enabled.checked });
            });
          }
          bindRange(els.duration, els.durationLabel, fmtMs, 'duration');
          bindRange(els.wheel, els.wheelLabel, fmtX, 'wheelSensitivity');
          bindRange(els.keyboard, els.keyboardLabel, fmtX, 'keyboardSensitivity');
          bindRange(els.momentum, els.momentumLabel, fmtAmp, 'androidMomentumAmplifier');
          if (els.easing) {
            els.easing.addEventListener('change', () => {
              commit({ easing: els.easing.value || 'ease-in-out' });
            });
          }

          if (els.reset) {
            els.reset.addEventListener('click', (event) => {
              event.preventDefault();
              commit({ ...defaults });
            });
          }

          refresh();
        };

        const waitForManager = (attempt = 0) => {
          const manager = window.smoothScroll;
          if (manager) {
            attach(manager);
            return;
          }
          if (attempt > 200) {
            disableUi('×× ×•×¢ ×”×’×œ×™×œ×” ×œ× × ×˜×¢×Ÿ â€” ×”×›×¤×ª×•×¨ ×™×¨×™×¥ ×’×œ×™×œ×” ×¨×’×™×œ×” ××”×“×¤×“×¤×Ÿ.', { keepTestButton: true });
            return;
          }
          setTimeout(() => waitForManager(attempt + 1), 50);
        };

        waitForManager();
      };

      const initAfterDom = () => {
        initSmoothScrollSettingsCard();
        initConfigRadar();
      };

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initAfterDom);
      } else {
        initAfterDom();
      }

      // --- Web Push (Service Worker + PushManager) ---
      const __PUSH_ENABLED__ = {{ 'true' if push_enabled else 'false' }};
      if (!__PUSH_ENABLED__) {
        // When push is disabled server-side, skip all push JS logic
        return;
      }
      const pushStatus = document.getElementById('pushStatus');
      const pushEnableBtn = document.getElementById('pushEnableBtn');
      const pushDisableBtn = document.getElementById('pushDisableBtn');
      const pushTestBtn = document.getElementById('pushTestBtn');

      function setPushStatus(text){ if (pushStatus) pushStatus.textContent = text; }

      function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) { outputArray[i] = rawData.charCodeAt(i); }
        return outputArray;
      }

      async function registerSw(){
        if (!('serviceWorker' in navigator)) throw new Error('ServiceWorker ×œ× × ×ª××š');
        const reg = await navigator.serviceWorker.register('/sw.js');
        try { await navigator.serviceWorker.ready; } catch(_) {}
        return reg;
      }

      async function getVapid(){
        const r = await fetch('/api/push/public-key', { cache:'no-store' });
        const j = await r.json().catch(()=>({}));
        if (!j || j.ok === false || !j.vapidPublicKey) throw new Error('××¤×ª×— VAPID ×œ× ×–××™×Ÿ');
        return j.vapidPublicKey;
      }

      async function enablePush(){
        try {
          if (!('Notification' in window)) throw new Error('×”×ª×¨××•×ª ×œ× × ×ª××›×•×ª ×‘×“×¤×“×¤×Ÿ');
          if (!('serviceWorker' in navigator)) throw new Error('ServiceWorker ×œ× × ×ª××š');
          if (!('PushManager' in window)) throw new Error('PushManager ×œ× × ×ª××š');

          const reg = await registerSw();
          // ×× ×›×‘×¨ ×§×™×™× ×× ×•×™ â€“ ×”×¦×’ ×”×•×“×¢×ª "×›×‘×¨ ××•×¤×¢×œ×•×ª" ×•×¡× ×›×¨×Ÿ ×œ×©×¨×ª ×‘×¢×“×™× ×•×ª
          try {
            const existing = reg && reg.pushManager ? await reg.pushManager.getSubscription() : null;
            if (existing) {
              try {
                await fetch('/api/push/subscribe', { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify(existing) });
              } catch(_) {}
              setPushStatus('×”×”×ª×¨××•×ª ×›×‘×¨ ××•×¤×¢×œ×•×ª');
              return;
            }
          } catch(_) {}

          const perm = await Notification.requestPermission();
          if (perm !== 'granted') { setPushStatus('×”×¨×©××ª ×”×ª×¨××•×ª × ×“×—×ª×”'); return; }
          setPushStatus('× ×¨×©× Service Worker...');
          const key = await getVapid();
          const sub = await reg.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: urlBase64ToUint8Array(key) });
          const resp = await fetch('/api/push/subscribe', { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify(sub) });
          const j = await resp.json().catch(()=>({}));
          if (!resp.ok || !j || j.ok === false) throw new Error('×©××™×¨×ª ×× ×•×™ × ×›×©×œ×”');
          setPushStatus('×”×ª×¨××•×ª ×”×•×¤×¢×œ×• ×‘×”×¦×œ×—×”');
        } catch(e){ setPushStatus('×©×’×™××” ×‘×”×¤×¢×œ×ª ×”×ª×¨××•×ª'); console.warn('enablePush failed', e); }
      }

      async function disablePush(){
        try {
          if (!('serviceWorker' in navigator)) { setPushStatus('×”×“×¤×“×¤×Ÿ ×œ× ×ª×•××š ×‘×”×ª×¨××•×ª'); return; }
          const reg = (await navigator.serviceWorker.getRegistration()) || (await registerSw());
          const sub = (reg && reg.pushManager) ? await reg.pushManager.getSubscription() : null;
          if (!sub) { setPushStatus('×”×”×ª×¨××•×ª ×›×‘×¨ ×›×‘×•×™×•×ª'); return; }
          try {
            const ep = (sub && typeof sub.endpoint === 'string') ? sub.endpoint : '';
            if (ep) {
              await fetch('/api/push/subscribe', { method:'DELETE', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify({ endpoint: ep }) });
            }
          } catch(_) {}
          try { await sub.unsubscribe(); } catch(_) {}
          setPushStatus('×”×ª×¨××•×ª ×›×•×‘×•');
        } catch(e){ setPushStatus('×©×’×™××” ×‘×›×™×‘×•×™ ×”×ª×¨××•×ª'); console.warn('disablePush failed', e); }
      }

      async function testPush(){
        try {
          const r = await fetch('/api/push/test', { method:'POST', credentials:'include' });
          const j = await r.json().catch(()=>({}));
          if (r.ok && j && j.ok) {
            if (j.sent > 0) { setPushStatus('× ×©×œ×—×” ×”×ª×¨××ª ×‘×“×™×§×”'); return; }
            const codes = j.codes || {};
            const known = Object.keys(codes).map(k => Number(k));
            // Treat only non-zero codes as meaningful; code 0 is a transport/TLS error
            const nonZero = known.filter(k => k !== 0);
            if (nonZero.includes(404) || nonZero.includes(410)) {
              setPushStatus('×”×× ×•×™ ×¤×’ (404/410) â€” ×›×‘×”/×”×¤×¢×œ ×”×ª×¨××•×ª ×•××– × ×¡×” ×©×•×‘');
            } else if (nonZero.includes(401) || nonZero.includes(403)) {
              setPushStatus('××™Ö¾×”×ª×××ª ××¤×ª×—×•×ª (401/403) â€” ×•×“× ×–×•×’ VAPID ×ª×•×× ×•×¨×¢× ×Ÿ ×× ×•×™');
            } else if (nonZero.length) {
              setPushStatus('×›×©×œ ×©×œ×™×—×” (×§×•×“×™×: ' + nonZero.join(', ') + ')');
            } else if (Array.isArray(j.errors) && j.errors.length) {
              const first = j.errors.find(e => !e.status || e.status === 0) || j.errors[0];
              const msg = (first && first.error) ? String(first.error) : '×©×’×™××” ×œ× ×™×“×•×¢×”';
              setPushStatus('×›×©×œ ×©×œ×™×—×” (0): ' + msg);
            } else {
              setPushStatus('×œ× × ×©×œ×—×” ×”×ª×¨××” (×‘×“×•×§ ××¤×ª×— VAPID/×× ×•×™×™×)');
            }
          } else {
            if (j && j.error === 'no_subscriptions') setPushStatus('××™×Ÿ ×× ×•×™ ×¤×•×© ×œ×©×œ×— ××œ×™×• â€” ×”×¤×¢×œ ×”×ª×¨××•×ª');
            else if (j && j.error === 'missing_vapid_private_key') setPushStatus('×—×¡×¨ VAPID_PRIVATE_KEY ×‘×©×¨×ª');
            else if (j && j.error === 'pywebpush_not_available') setPushStatus('×©×¨×ª: pywebpush ×œ× ××•×ª×§×Ÿ/×–××™×Ÿ');
            else if (j && j.error === 'internal_error') setPushStatus('×©×’×™××” ×¤× ×™××™×ª ×‘×©×¨×ª');
            else setPushStatus('×‘×“×™×§×ª ×¤×•×© × ×›×©×œ×”');
          }
        } catch(e){ setPushStatus('×‘×“×™×§×ª ×¤×•×© × ×›×©×œ×”'); }
      }

      async function refreshPushUi(){
        try {
          if (!('Notification' in window)) { setPushStatus('×”×“×¤×“×¤×Ÿ ×œ× ×ª×•××š ×‘×”×ª×¨××•×ª'); return; }
          const st = Notification.permission;
          let hasSub = false;
          try {
            const reg = (await navigator.serviceWorker.getRegistration()) || (await registerSw());
            const sub = reg && reg.pushManager ? await reg.pushManager.getSubscription() : null;
            hasSub = !!sub;
          } catch(_) {}
          if (st === 'granted' && hasSub) setPushStatus('×”×ª×¨××•×ª ××•×¤×¢×œ×•×ª ×‘×“×¤×“×¤×Ÿ ×–×”');
          else if (st === 'denied') setPushStatus('×”××©×ª××© ×—×¡× ×”×ª×¨××•×ª â€“ ×™×© ×œ××¤×©×¨ ×™×“× ×™×ª');
          else setPushStatus('× ×“×¨×© ×œ×”×¤×¢×™×œ ×”×ª×¨××•×ª');
        } catch(_) { setPushStatus('××¦×‘ ×œ× ×™×“×•×¢'); }
      }

      if (pushEnableBtn) pushEnableBtn.addEventListener('click', enablePush);
      if (pushDisableBtn) pushDisableBtn.addEventListener('click', disablePush);
      if (pushTestBtn) pushTestBtn.addEventListener('click', testPush);
      refreshPushUi();
    })();
    </script>
    <script>
      // UX: ×›×¤×ª×•×¨ ××—×™×§×ª Custom ×¢×“×™×Ÿ, ×‘×¦×“, ×•×‘×˜×§×¡×˜ ×‘×¨×•×¨ ×¢× ×©× ×”×¢×¨×›×”
      (function () {
        try {
          const themeSel = document.getElementById('themeSelect');
          if (!themeSel) return;

          const deleteBtn = document.querySelector('button[onclick="deleteCustomTheme()"]');
          if (!deleteBtn) return;

          const customThemeName = {{ (custom_theme.name if custom_theme and custom_theme.name else 'Custom') | tojson | safe }};
          const name = (customThemeName && String(customThemeName).trim()) ? String(customThemeName).trim() : 'Custom';

          // ×”×¦×’×” ×¨×§ ×›×©× ××¦××™× ×¢×œ Custom (×•×’× ×›×“×™ ×œ×”×™×× ×¢ ××œ×—×™×¦×•×ª ×‘×˜×¢×•×ª ×›×©×‘×•×—×¨×™× ×¢×¨×›×” ××—×¨×ª)
          function updateVisibility() {
            try {
              const isCustomSelected = (String(themeSel.value || '').trim().toLowerCase() === 'custom');
              deleteBtn.style.display = isCustomSelected ? '' : 'none';
            } catch (_) {}
          }

          // ×œ××§× ××ª ×”×›×¤×ª×•×¨ ×œ×™×“ ×”-select (×‘××•×ª×” ×©×•×¨×”)
          try {
            const rightCol = themeSel.parentElement;
            if (rightCol && !rightCol.__ckThemeDeleteBarMounted) {
              const bar = document.createElement('div');
              bar.style.display = 'flex';
              bar.style.alignItems = 'center';
              bar.style.justifyContent = 'flex-end';
              bar.style.gap = '0.5rem';
              bar.style.flexWrap = 'wrap';
              rightCol.__ckThemeDeleteBarMounted = true;

              rightCol.insertBefore(bar, themeSel);
              bar.appendChild(themeSel);

              const oldWrap = deleteBtn.parentElement;
              bar.appendChild(deleteBtn);
              try {
                if (oldWrap && oldWrap.parentElement && oldWrap.children.length === 0) {
                  oldWrap.parentElement.removeChild(oldWrap);
                } else if (oldWrap) {
                  oldWrap.style.display = 'none';
                }
              } catch (_) {}
            }
          } catch (_) {}

          // ×¢×™×¦×•×‘ ×¤×—×•×ª "×¦×•×¢×§"
          try {
            deleteBtn.style.opacity = '0.82';
            deleteBtn.style.borderColor = 'rgba(255,255,255,0.18)';
            deleteBtn.style.color = 'inherit';
          } catch (_) {}
          try {
            const icon = deleteBtn.querySelector('i');
            if (icon) {
              icon.style.color = 'inherit';
              icon.style.opacity = '0.75';
            }
          } catch (_) {}

          // ×˜×§×¡×˜ ×‘×¨×•×¨ ×¢× ×©× ×”×¢×¨×›×”
          try {
            deleteBtn.innerHTML = `<i class="fas fa-trash" style="opacity:0.75;"></i> ××—×§ ×¢×¨×›×” ${name}`;
            deleteBtn.title = `××—×§ ×¢×¨×›×” "${name}"`;
          } catch (_) {}

          // ×“×¨×™×¡×ª confirm ×›×“×™ ×œ×›×œ×•×œ ×©× ×¢×¨×›×”, ×‘×œ×™ ×œ×©× ×•×ª ××ª ×”-HTML
          window.deleteCustomTheme = async function deleteCustomTheme() {
            if (!confirm(`×”×× ×œ××—×•×§ ××ª ×”×¢×¨×›×” "${name}"?`)) return;
            try {
              const res = await fetch('/api/themes/custom', { method: 'DELETE' });
              const data = await res.json();
              if (!res.ok || !data || !data.ok) throw new Error((data && data.error) || 'delete_failed');
            } catch (e) {
              console.error('deleteCustomTheme failed:', e);
              alert('×©×’×™××” ×‘××—×™×§×ª ×”×¢×¨×›×”');
              return;
            }
            try { localStorage.setItem('dark_mode_preference', 'light'); } catch (_) {}
            try { localStorage.setItem('user_theme', 'classic'); } catch (_) {}
            location.reload();
          };

          themeSel.addEventListener('change', updateVisibility);
          updateVisibility();
        } catch (_) { /* ignore */ }
      })();
    </script>
    {% endblock %}
{% endblock %}
