{% extends "base.html" %}

{% block title %}×”×’×“×¨×•×ª - Code Keeper Bot{% endblock %}

{% block content %}
<h1 class="page-title">
    <i class="fas fa-cog"></i>
    ×”×’×“×¨×•×ª
</h1>

<div class="glass-card">
    <h2 class="section-title">
        <i class="fas fa-user"></i>
        ×¤×¨×˜×™ ×—×©×‘×•×Ÿ
    </h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem;">
        <div>
            <label style="opacity: 0.7; font-size: 0.9rem;">××–×”×” ××©×ª××©</label>
            <p style="font-size: 1.2rem; margin: 0.5rem 0;">{{ user.id }}</p>
        </div>
        <div>
            <label style="opacity: 0.7; font-size: 0.9rem;">×©× ××©×ª××© ×‘×˜×œ×’×¨×</label>
            <p style="font-size: 1.2rem; margin: 0.5rem 0;">
                {% if user.username %}
                    @{{ user.username }}
                {% else %}
                    <span style="opacity: 0.5;">×œ× ××•×’×“×¨</span>
                {% endif %}
            </p>
        </div>
        <div>
            <label style="opacity: 0.7; font-size: 0.9rem;">×©× ××œ×</label>
            <p style="font-size: 1.2rem; margin: 0.5rem 0;">
                {{ user.first_name }} {{ user.last_name or '' }}
            </p>
        </div>
        <div id="account-status">
            <label style="opacity: 0.7; font-size: 0.9rem;">×¡×˜×˜×•×¡</label>
            <p style="font-size: 1.2rem; margin: 0.5rem 0;">
                {% if is_admin %}
                <span class="badge" style="background: linear-gradient(135deg, #fbbf24, #f59e0b); padding: 0.5rem 1rem;">
                    ğŸªª ××©×ª××© ××“××™×Ÿ
                </span>
                {% elif is_premium %}
                <span class="badge" style="background: linear-gradient(135deg, #60a5fa, #7dd3fc); padding: 0.5rem 1rem;">
                    ğŸ’ ××©×ª××© ×¤×¨×™××™×•×
                </span>
                {% else %}
                <span class="badge">××©×ª××© ×¨×’×™×œ</span>
                {% endif %}
            </p>
        </div>
    </div>
</div>

    {% if is_premium %}
    <div class="alert alert-info" role="note" style="margin-top: 1rem;">
        ×‘×§×©×•×ª ××™×•×—×“×•×ª? <a href="https://t.me/moominAmir" target="_blank" rel="noopener">@moominAmir</a>
    </div>
    {% endif %}

<div class="glass-card">
    <h2 class="section-title">
        <i class="fas fa-clock"></i>
        ×”×’×“×¨×•×ª ×¡×©×Ÿ
    </h2>
    <div class="glass-card" style="background: rgba(255,255,255,0.05);">
        <div style="display:flex; align-items:center; justify-content: space-between; gap: 1rem;">
            <div style="display:flex; align-items:center; gap: 1rem;">
                <i class="fas fa-check-circle" style="color: var(--success); font-size: 1.5rem;"></i>
                <div>
                    <div style="font-weight:600;">×—×™×‘×•×¨ ×§×‘×•×¢</div>
                    <div style="opacity:.8; font-size:.95rem;">
                        ×”×©××¨ ××—×•×‘×¨ ××•×˜×•××˜×™×ª ×¢×“ {{ persistent_days }} ×™×•× ×‘××›×©×™×¨ ×–×”
                    </div>
                </div>
            </div>
            <label class="switch">
                <input id="persistentToggle" type="checkbox" {% if persistent_login_enabled %}checked{% endif %}>
                <span class="slider"></span>
            </label>
        </div>
        <div id="persistMsg" style="opacity:.8; margin-top:.75rem; font-size:.95rem;">
            {% if persistent_login_enabled %}
            ×”×—×™×‘×•×¨ ×”×§×‘×•×¢ ×¤×¢×™×œ. ×ª×•×›×œ ×œ×›×‘×•×ª ×‘×›×œ ×¨×’×¢.
            {% else %}
            ×”×—×™×‘×•×¨ ×”×§×‘×•×¢ ×›×‘×•×™.
            {% endif %}
        </div>
    </div>

    <div style="margin-top: 1.5rem;">
        <a href="/logout" class="btn btn-secondary btn-icon">
            <i class="fas fa-sign-out-alt"></i>
            ×”×ª× ×ª×§ ××›×œ ×”××›×©×™×¨×™×
        </a>
        <p style="margin-top: 0.5rem; opacity: 0.7; font-size: 0.9rem;">
            ×”×ª× ×ª×§×•×ª ×ª×¡×™×¨ ××ª ×”×”×ª×—×‘×¨×•×ª ××›×œ ×”×“×¤×“×¤× ×™× ×•×”××›×©×™×¨×™×
        </p>
    </div>
</div>

{% if is_admin %}
<div class="glass-card" style="border: 2px solid rgba(251, 191, 36, 0.3);">
    <h2 class="section-title">
        <i class="fas fa-tools"></i>
        ×›×œ×™ ××“××™×Ÿ
    </h2>
    <div style="display: grid; gap: 1rem;">
        <div style="padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 10px;">
            <h4>ğŸ“ƒ × ×™×”×•×œ ×¡×¤×¨×™×™×ª ×¡× ×™×¤×˜×™×</h4>
            <div style="display:flex; gap:.5rem; flex-wrap: wrap;">
                <a class="btn btn-primary" href="/admin/snippets/pending">ğŸ“¥ ×”×¦×¢×•×ª ×××ª×™× ×•×ª</a>
                <a class="btn btn-secondary" href="/snippets">ğŸ“š ××¢×‘×¨ ×œ×¡×¤×¨×™×™×”</a>
                <a class="btn btn-secondary" href="/snippets/submit">â• ×”×•×¡×£ ×¡× ×™×¤×˜ ×—×“×©</a>
            </div>
        </div>
        <div style="padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 10px;">
            <h4>ğŸ§© ×××©×§×™ ××©×ª××©×™× â€“ ××•×¡×£ ×”×§×”×™×œ×”</h4>
            <div style="display:flex; gap:.5rem; flex-wrap: wrap;">
                <a class="btn btn-primary" href="/admin/community/pending">ğŸ“¥ ××•×¡×¤×™× ×××ª×™× ×™×</a>
                <a class="btn btn-secondary" href="/community-library">ğŸ›ï¸ ×œ×¢××•×“ ×”××•×¡×£</a>
            </div>
        </div>
        <div style="padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 10px;">
            <h4><i class="fas fa-database"></i> ×¡×˜×˜×™×¡×˜×™×§×•×ª ××¢×¨×›×ª</h4>
            <p style="opacity: 0.8;">×‘×§×¨×•×‘: ×¦×¤×™×™×” ×‘× ×ª×•× ×™× ×›×œ×œ×™×™× ×©×œ ×”××¢×¨×›×ª</p>
        </div>
        <div style="padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 10px;">
            <h4><i class="fas fa-users"></i> × ×™×”×•×œ ××©×ª××©×™×</h4>
            <p style="opacity: 0.8;">×‘×§×¨×•×‘: ×¦×¤×™×™×” ×•× ×™×”×•×œ ××©×ª××©×™ ×”××¢×¨×›×ª</p>
        </div>
        <div style="padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 10px;">
            <h4><i class="fab fa-github"></i> ××™× ×˜×’×¨×¦×™×™×ª GitHub</h4>
            <p style="opacity: 0.8;">×‘×§×¨×•×‘: ×—×™×‘×•×¨ ×•× ×™×”×•×œ ×¨×™×¤×•×–×™×˜×•×¨×™×– ×-GitHub</p>
        </div>
    </div>
</div>
{% endif %}

<div class="glass-card">
    <h2 class="section-title">
        <i class="fas fa-palette"></i>
        ×”×¢×“×¤×•×ª ×ª×¦×•×’×”
    </h2>
    <div class="glass-card" style="background: rgba(255,255,255,0.05);">
        <div style="display:flex; align-items:center; justify-content: space-between; gap: 1rem;">
            <div style="display:flex; align-items:center; gap: 1rem;">
                <i class="fas fa-text-height" style="font-size: 1.5rem;"></i>
                <div>
                    <div style="font-weight:600;">×’×•×“×œ ×’×•×¤×Ÿ</div>
                    <div style="opacity:.8; font-size:.95rem;">×”×ª×× ××ª ×’×•×“×œ ×”×˜×§×¡×˜ ×‘××¤×œ×™×§×¦×™×”</div>
                </div>
            </div>
            <div style="display:flex; align-items:center; gap:.5rem; flex-wrap: wrap;">
                <button id="fontMinus" class="btn btn-secondary" title="×”×§×˜×Ÿ" style="min-width: 3rem;">A-</button>
                <div id="fontValue" class="badge">Ã— {{ '%.2f' % ui_font_scale }}</div>
                <button id="fontPlus" class="btn btn-secondary" title="×”×’×“×œ" style="min-width: 3rem;">A+</button>
            </div>
        </div>
    </div>
    <p style="opacity:.7; margin-top:.75rem; font-size:.9rem;">×”×”×’×“×¨×” × ×©××¨×ª ×œ××©×ª××© ×•×œ××›×©×™×¨ ×–×”.</p>

    <div class="glass-card" style="background: rgba(255,255,255,0.05); margin-top: 1rem;">
        <div style="display:flex; align-items:center; justify-content: space-between; gap: 1rem;">
            <div style="display:flex; align-items:center; gap: 1rem;">
                <i class="fas fa-fill-drip" style="font-size: 1.5rem;"></i>
                <div>
                    <div style="font-weight:600;">×¢×¨×›×ª × ×•×©×</div>
                    <div style="opacity:.8; font-size:.95rem;">×‘×—×¨ ×¡×’× ×•×Ÿ ×¦×‘×¢×™× â€” ×›×•×œ×œ ×”× ×•×›×—×™×ª</div>
                </div>
            </div>
            <div>
                <select id="themeSelect" class="filter-select" aria-label="×‘×—×¨ ×¢×¨×›×ª × ×•×©×" style="padding: 0.5rem 0.75rem; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: white;">
                    <option value="classic" {% if ui_theme == 'classic' %}selected{% endif %}>×§×œ××¡×™{% if ui_theme == 'classic' %} (× ×•×›×—×™×ª){% endif %}</option>
                    <option value="ocean" {% if ui_theme == 'ocean' %}selected{% endif %}>××•×§×™×™× ×•×¡{% if ui_theme == 'ocean' %} (× ×•×›×—×™×ª){% endif %}</option>
                    <option value="forest" {% if ui_theme == 'forest' %}selected{% endif %}>×™×¢×¨{% if ui_theme == 'forest' %} (× ×•×›×—×™×ª){% endif %}</option>
                    <option value="high-contrast" {% if ui_theme == 'high-contrast' %}selected{% endif %}>× ×™×’×•×“×™×•×ª ×’×‘×•×”×”{% if ui_theme == 'high-contrast' %} (× ×•×›×—×™×ª){% endif %}</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Bookmarks toggle visibility (moved from panel) -->
    <div class="glass-card" style="background: rgba(255,255,255,0.05); margin-top: 1rem;">
        <div style="display:flex; align-items:center; justify-content: space-between; gap: 1rem;">
            <div style="display:flex; align-items:center; gap: 1rem;">
                <i class="fas fa-bookmark" style="font-size: 1.5rem;"></i>
                <div>
                    <div style="font-weight:600;">×”×¦×’×ª ×›×¤×ª×•×¨ ×¡×™×× ×™×•×ª</div>
                    <div style="opacity:.8; font-size:.95rem;">×”×¦×’ / ×”×¡×ª×¨ ××ª ×”×›×¤×ª×•×¨ ×”×¦×£ ğŸ”–</div>
                </div>
            </div>
            <div style="display:flex; align-items:center; gap:.5rem; flex-wrap: wrap;">
                <button id="bmShowBtn" class="btn btn-secondary">×”×¦×’</button>
                <button id="bmHideBtn" class="btn btn-secondary">×”×¡×ª×¨</button>
                <span id="bmState" class="badge" style="min-width:64px; text-align:center"></span>
            </div>
        </div>
    </div>
</div>

<div class="glass-card">
    <h2 class="section-title">
        <i class="fas fa-shield-alt"></i>
        ×¤×¨×˜×™×•×ª ×•××‘×˜×—×”
    </h2>
    <div style="display: grid; gap: 1rem;">
        <div style="display: flex; align-items: start; gap: 1rem;">
            <i class="fas fa-lock" style="color: var(--success); margin-top: 0.25rem;"></i>
            <div>
                <strong>×—×™×‘×•×¨ ×××•×‘×˜×—</strong>
                <p style="opacity: 0.8; margin: 0.25rem 0;">×›×œ ×”×ª×§×©×•×¨×ª ××•×¦×¤× ×ª ×‘-HTTPS</p>
            </div>
        </div>
        <div style="display: flex; align-items: start; gap: 1rem;">
            <i class="fas fa-user-shield" style="color: var(--success); margin-top: 0.25rem;"></i>
            <div>
                <strong>××™××•×ª ×“×¨×š Telegram</strong>
                <p style="opacity: 0.8; margin: 0.25rem 0;">×”×ª×—×‘×¨×•×ª ×××•×‘×˜×—×ª ×œ×œ× ×¡×™×¡×××•×ª</p>
            </div>
        </div>
        <div style="display: flex; align-items: start; gap: 1rem;">
            <i class="fas fa-database" style="color: var(--success); margin-top: 0.25rem;"></i>
            <div>
                <strong>×”×¦×¤× ×ª × ×ª×•× ×™×</strong>
                <p style="opacity: 0.8; margin: 0.25rem 0;">×›×œ ×”××™×“×¢ ×”×¨×’×™×© ××•×¦×¤×Ÿ ×‘××¡×“ ×”× ×ª×•× ×™×</p>
            </div>
        </div>
    </div>
</div>

<style>
.badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 600;
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
}

.section-title {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
    font-size: 1.25rem;
}

.glass-card h4 {
    margin: 0 0 0.5rem 0;
    color: #fff; /* ×›×•×ª×¨×•×ª ×œ×‘× ×•×ª ×‘××§×•× ×›×—×•×œ ×¢×‘×•×¨ ×”×’×“×¨×•×ª ××“××™×Ÿ */
}

/* Toggle switch */
.switch { position: relative; display: inline-block; width: 52px; height: 28px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.2); transition: .2s; border-radius: 28px; border: 1px solid rgba(255,255,255,0.3); }
.slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 3px; top: 2px; background: white; transition: .2s; border-radius: 50%; }
input:checked + .slider { background: rgba(72, 187, 120, 0.5); }
input:checked + .slider:before { transform: translateX(24px); }
</style>

{% block extra_js %}
<script>
(function(){
  const toggle = document.getElementById('persistentToggle');
  const msg = document.getElementById('persistMsg');
  if (toggle) {
    toggle.addEventListener('change', async function(){
      try {
        const res = await fetch('/api/persistent_login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ enable: toggle.checked })
        });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || 'Failed');
        if (toggle.checked) { msg.textContent = '×”×—×™×‘×•×¨ ×”×§×‘×•×¢ ×¤×¢×™×œ. ×ª×•×›×œ ×œ×›×‘×•×ª ×‘×›×œ ×¨×’×¢.'; }
        else { msg.textContent = '×”×—×™×‘×•×¨ ×”×§×‘×•×¢ ×›×‘×•×™.'; }
      } catch (e) {
        toggle.checked = !toggle.checked;
        alert('×©×’×™××” ×‘×¢×“×›×•×Ÿ ××¦×‘ ×”×—×™×‘×•×¨ ×”×§×‘×•×¢');
      }
    });
  }

  // Font size controls
  const vEl = document.getElementById('fontValue');
  const btnMinus = document.getElementById('fontMinus');
  const btnPlus = document.getElementById('fontPlus');
  const themeSel = document.getElementById('themeSelect');
  function setVal(x){ if (vEl) vEl.textContent = 'Ã— ' + x.toFixed(2); }
  function save(scale){
    return fetch('/api/ui_prefs', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ font_scale: scale })
    }).then(r=>r.json());
  }
  function getCurrent(){
    try { return parseFloat((vEl.textContent||'').replace(/[Ã—\s]/g,'')) || 1.00; } catch(e){ return 1.00; }
  }
  if (btnMinus) btnMinus.addEventListener('click', async function(){
    let cur = getCurrent();
    cur = Math.max(0.85, (cur - 0.05));
    setVal(cur);
    try { const res = await save(cur); if (!res.ok) throw 0; } catch(e){ alert('×©×’×™××” ×‘×©××™×¨×ª ×’×•×“×œ ×”×’×•×¤×Ÿ'); }
    location.reload();
  });
  if (btnPlus) btnPlus.addEventListener('click', async function(){
    let cur = getCurrent();
    cur = Math.min(1.60, (cur + 0.05));
    setVal(cur);
    try { const res = await save(cur); if (!res.ok) throw 0; } catch(e){ alert('×©×’×™××” ×‘×©××™×¨×ª ×’×•×“×œ ×”×’×•×¤×Ÿ'); }
    location.reload();
  });

  if (themeSel) themeSel.addEventListener('change', async function(){
    try {
      const res = await fetch('/api/ui_prefs', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ theme: themeSel.value })
      });
      const data = await res.json();
      if (!data.ok) throw 0;
      location.reload();
    } catch (e) { alert('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¢×¨×›×ª ×”× ×•×©×'); }
  });

  // Bookmarks toggle visibility controls
  const BM_KEY = 'bookmarks_toggle_btn_visible';
  const bmShow = document.getElementById('bmShowBtn');
  const bmHide = document.getElementById('bmHideBtn');
  const bmState = document.getElementById('bmState');
  function refreshBmState(){
    try {
      const v = localStorage.getItem(BM_KEY);
      const shown = v !== '0';
      if (bmState) bmState.textContent = shown ? '××•×¦×’' : '××•×¡×ª×¨';
    } catch(_) { if (bmState) bmState.textContent = 'â€”'; }
  }
  function setBm(show){
    try { localStorage.setItem(BM_KEY, show ? '1' : '0'); } catch(_) {}
    refreshBmState();
  }
  if (bmShow) bmShow.addEventListener('click', ()=> setBm(true));
  if (bmHide) bmHide.addEventListener('click', ()=> setBm(false));
  refreshBmState();
})();
</script>
{% endblock %}
{% endblock %}