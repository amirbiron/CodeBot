<!DOCTYPE html>
{% set _announcement_enabled = announcement_enabled if announcement_enabled is defined else (weekly_tip_enabled if weekly_tip_enabled is defined else none) %}
{# סשן: בטסטים/סביבות מסוימות יש user_id בלי user_data — לא להפיל את התבנית #}
{% set _session_user_id = session.get('user_id') %}
{% set _session_user_data = session.get('user_data') or {} %}
{% set _session_first_name = (_session_user_data.get('first_name') if _session_user_data is mapping else none) %}
<html dir="rtl" lang="he" data-theme-scope="{{ ui_theme_scope }}"{% if ui_theme_custom_id %} data-theme-custom-id="{{ ui_theme_custom_id }}"{% endif %}{% if _announcement_enabled is not none %} data-announcement="{{ 'on' if _announcement_enabled else 'off' }}" data-weekly-tip="{{ 'on' if _announcement_enabled else 'off' }}"{% endif %}>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>{% block title %}Code Keeper Bot{% endblock %}</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Preconnect CDNs for faster CodeMirror ESM loads -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    <link rel="preconnect" href="https://esm.sh" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        // קביעה מוקדמת של data-theme כדי למנוע הבהוב לפני טעינת ה-CSS
        (function() {
            try {
                var html = document.documentElement;
                var isLoggedIn = {{ 'true' if _session_user_id else 'false' }};
                var serverTheme = '{{ ui_theme }}';
                serverTheme = String(serverTheme || 'classic').trim().toLowerCase();
                var hasSharedTheme = {{ 'true' if shared_theme and shared_theme.colors else 'false' }};
                var allowed = {
                    'classic': 1,
                    'ocean': 1,
                    'rose-pine-dawn': 1,
                    'dark': 1,
                    'dim': 1,
                    'nebula': 1,
                    'high-contrast': 1{% if custom_theme and custom_theme.is_active %},
                    'custom': 1{% endif %}
                };

                // Shared theme מהשרת מקבל עדיפות על localStorage (מונע "הבהוב" / override מקומי)
                if (hasSharedTheme && serverTheme.indexOf('shared:') === 0) {
                    html.setAttribute('data-theme', serverTheme);
                    html.setAttribute('data-theme-type', 'custom');
                    return;
                }

                // עדיפות ל-custom אם קיים ותקין (כדי למנוע "הבהוב" לאחר שמירה/רענון)
                // חשוב: לא משתמשים ב-dark_mode_preference לסימון ערכות (זה enum של dark/dim/light/auto).
                var savedMode = localStorage.getItem('dark_mode_preference');
                savedMode = String(savedMode || '').trim().toLowerCase();
                var savedThemeAny = localStorage.getItem('user_theme');
                savedThemeAny = String(savedThemeAny || '').trim().toLowerCase();
                if (savedThemeAny === 'custom' && allowed['custom']) {
                    html.setAttribute('data-theme', 'custom');
                    html.setAttribute('data-theme-type', 'custom');
                    return;
                }

                // אם השרת קבע ערכת נושא שאינה מצב "בהיר/כהה" – נכבד אותה תמיד (סנכרון בין מכשירים)
                if (allowed[serverTheme] && (serverTheme !== 'classic' && serverTheme !== 'dark' && serverTheme !== 'dim')) {
                    html.setAttribute('data-theme', serverTheme);
                    if (serverTheme === 'custom') {
                        html.setAttribute('data-theme-type', 'custom');
                    }
                    return;
                }

                if (savedMode === 'dark' || savedMode === 'dim') {
                    html.setAttribute('data-theme', savedMode);
                    html.removeAttribute('data-theme-type');
                    return;
                }
                if (savedMode === 'auto' && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    html.setAttribute('data-theme', 'dark');
                    html.removeAttribute('data-theme-type');
                    return;
                }

                // כשלא מחוברים — נכבד user_theme מקומי (ללא תלות בשרת)
                if (!isLoggedIn) {
                    var savedTheme = localStorage.getItem('user_theme');
                    if (savedTheme) {
                        savedTheme = String(savedTheme).trim().toLowerCase();
                        if (allowed[savedTheme]) {
                            html.setAttribute('data-theme', savedTheme);
                            if (savedTheme === 'custom') {
                                html.setAttribute('data-theme-type', 'custom');
                            } else {
                                html.removeAttribute('data-theme-type');
                            }
                            return;
                        }
                    }
                }

                // fallback: ערכת נושא מהשרת
                if (allowed[serverTheme]) {
                    html.setAttribute('data-theme', serverTheme);
                    if (serverTheme === 'custom') {
                        html.setAttribute('data-theme-type', 'custom');
                    } else {
                        html.removeAttribute('data-theme-type');
                    }
                }
            } catch (_) { /* ignore */ }
        })();
    </script>
    <script>
        // רשימת ערכות מובנות שמוסתרות מהממשק (משותפת לכל המסכים)
        window.__ckHiddenBuiltinThemes = ['dark', 'dim', 'ocean', 'rose-pine-dawn'];
    </script>

    <!-- Icons -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
          {% if cdn_sri and cdn_sri.fa %}integrity="{{ cdn_sri.fa }}" crossorigin="anonymous" referrerpolicy="no-referrer"{% endif %} />
    <meta id="uiFont" data-scale="{{ '%.2f' % ui_font_scale }}">
    {% if csrf_token is defined %}
    <meta name="csrf-token" content="{{ csrf_token() }}">
    {% endif %}

    <!-- PWA Manifest (cache-busted) -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}?v={{ static_version }}">
    {% block favicons %}
    <!-- Default favicon for non-repo pages (prevents browser from reusing last-seen icon) -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('favicon') }}?v={{ static_version }}">
    <link rel="shortcut icon" href="{{ url_for('favicon') }}?v={{ static_version }}">
    {% endblock %}
    <!-- iOS Home Screen Icon -->
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='icons/apple-touch-icon-180.png') }}">

    <style>
        :root {
            --primary: #667eea;
            --primary-dark: #5a67d8;
            --secondary: #764ba2;
            --success: #48bb78;
            --danger: #f56565;
            --warning: #ed8936;
            --info: #4299e1;
            --dark: #2d3748;
            --light: #f7fafc;
            --glass: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-hover: rgba(255, 255, 255, 0.15);
            /* Solid surfaces (for dialogs/popovers that must not be "glass") */
            --solid-surface-bg: #ffffff;
            --solid-surface-text: #111827;
            --solid-surface-border: rgba(0, 0, 0, 0.12);
            --solid-surface-shadow: 0 14px 30px rgba(17, 23, 41, 0.16);
            --ui-font-scale: 1;
            --danger-bg: color-mix(in srgb, var(--danger) 18%, transparent);
            --danger-border: color-mix(in srgb, var(--danger) 45%, transparent);
            --text-on-warning: #1c1f3a;
            --btn-primary-bg: #ffffff;
            --btn-primary-color: var(--primary);
            --btn-primary-border: transparent;
            --btn-primary-shadow: none;
            --btn-primary-hover-bg: #ffffff;
            --btn-primary-hover-shadow: 0 10px 20px rgba(0,0,0,0.2);
            --md-surface: #1b1e24;
            --md-text: #f0f0f0;
            --scrollbar-width-base: 10px;
            --scrollbar-width: calc(var(--scrollbar-width-base) / 3);
        }

        /* Theme palettes */
        :root[data-theme="classic"] {
            --primary: #667eea;
            --primary-dark: #5a67d8;
            --secondary: #764ba2;
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.82);
            --text-muted: rgba(255, 255, 255, 0.65);
            --bg-primary: #6b63ff;
            --bg-secondary: #8e63ff;
            --bg-tertiary: rgba(255, 255, 255, 0.25);
            --card-bg: rgba(255, 255, 255, 0.12);
            --code-bg: rgba(0, 0, 0, 0.3);
            --card-border: rgba(255, 255, 255, 0.25);
            --btn-primary-bg: rgba(255, 255, 255, 0.94);
            --btn-primary-color: #667eea;
            --btn-primary-border: rgba(255, 255, 255, 0.65);
            --btn-primary-shadow: 0 4px 14px rgba(7, 7, 31, 0.25);
            --btn-primary-hover-bg: #ffffff;
            --btn-primary-hover-shadow: 0 14px 28px rgba(18, 20, 43, 0.45);
            --md-surface: #15141f;
            --md-text: #e0e0e0;
        }
        /* Ocean – Bold blue gradient theme */
        :root[data-theme="ocean"] {
            /* Core identity */
            --primary: #3182ce;
            --primary-dark: #2b6cb0;
            --secondary: #2c5282;

            /* Backgrounds - deep ocean blues */
            --bg-primary: #1a365d;
            --bg-secondary: #2a4365;
            --bg-tertiary: #2c5282;

            /* Text - high contrast on dark blue */
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.85);
            --text-muted: rgba(255, 255, 255, 0.65);

            /* Glass morphism - ocean-tinted */
            --glass: rgba(49, 130, 206, 0.15);
            --glass-border: rgba(49, 130, 206, 0.35);
            --glass-hover: rgba(49, 130, 206, 0.25);

            /* Cards */
            --card-bg: rgba(26, 54, 93, 0.85);
            --card-border: rgba(49, 130, 206, 0.35);

            /* Code blocks */
            --code-bg: #1a365d;
            --code-text: #e2e8f0;
            --code-border: rgba(49, 130, 206, 0.4);

            /* Status colors - adjusted for blue context */
            --success: #68d391;
            --danger: #fc8181;
            --warning: #f6ad55;
            --info: #63b3ed;

            /* Primary button */
            --btn-primary-bg: rgba(255, 255, 255, 0.95);
            --btn-primary-color: #1a365d;
            --btn-primary-border: rgba(255, 255, 255, 0.65);
            --btn-primary-shadow: 0 4px 14px rgba(26, 54, 93, 0.35);
            --btn-primary-hover-bg: #ffffff;
            --btn-primary-hover-shadow: 0 12px 28px rgba(26, 54, 93, 0.45);
            --md-surface: #1a365d;
            --md-text: #e2e8f0;
        }

        /* Rose Pine Dawn (light) */
        :root[data-theme="rose-pine-dawn"] {
            --primary: #907aa9; /* iris */
            --primary-dark: #7b6f9a;
            --secondary: #d7827e; /* rose */
            --bg-primary: #faf4ed;
            --bg-secondary: #f2e9e1;
            --bg-tertiary: #eaddd5;
            --text-primary: #575279;
            --text-secondary: #6e6a86;
            --text-muted: #797593;
            --glass: rgba(250, 244, 237, 0.9);
            --glass-border: rgba(144, 122, 169, 0.35);
            --glass-hover: rgba(144, 122, 169, 0.25);
            --card-bg: rgba(250, 244, 237, 0.96);
            --card-border: rgba(144, 122, 169, 0.35);
            --code-bg: #f2e9e1;
            --code-text: #433c59;
            --code-border: rgba(87, 82, 121, 0.25);
            --success: #56949f;
            --danger: #b4637a;
            --warning: #ea9d34;
            --info: #907aa9;
            --btn-primary-bg: color-mix(in srgb, var(--bg-secondary) 80%, #ffffff 20%);
            --btn-primary-color: #4a2c2a;
            --btn-primary-border: var(--glass-border);
            --btn-primary-shadow: 0 6px 18px rgba(149, 121, 166, 0.25);
            --btn-primary-hover-bg: color-mix(in srgb, var(--bg-secondary) 60%, #ffffff 40%);
            --btn-primary-hover-shadow: 0 10px 24px rgba(149, 121, 166, 0.3);
        }

        /* Theme palettes - Dark & Dim */
        :root[data-theme="dark"] {
            /* צבעי רקע - כהה ונוח לעיניים */
            --bg-primary: #1a1a1a;
            --bg-secondary: #252525;
            --bg-tertiary: #2d2d2d;

            /* צבעי טקסט - ניגודיות מאוזנת */
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --text-muted: #808080;

            /* צבעי אקסנט - מותאמים למצב חשוך */
            --primary: #7c8aff;
            --primary-dark: #6b7aff;
            --secondary: #9d7aff;

            /* צבעי מערכת */
            --success: #4ade80;
            --danger: #f87171;
            --warning: #fbbf24;
            --info: #60a5fa;

            /* Glass morphism - מותאם למצב חשוך */
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-hover: rgba(255, 255, 255, 0.08);

            /* צבעי רקע לכרטיסים */
            --card-bg: rgba(30, 30, 30, 0.8);
            --card-border: rgba(255, 255, 255, 0.1);

            /* צבעי קוד */
            --code-bg: #1e1e1e;
            --code-text: #d4d4d4;
            --code-border: rgba(255, 255, 255, 0.1);
            --btn-primary-bg: color-mix(in srgb, var(--bg-tertiary) 75%, var(--primary) 25%);
            --btn-primary-color: var(--text-primary);
            --btn-primary-border: var(--glass-border);
            --btn-primary-shadow: 0 8px 22px rgba(0, 0, 0, 0.45);
            --btn-primary-hover-bg: color-mix(in srgb, var(--bg-tertiary) 55%, var(--primary) 45%);
            --btn-primary-hover-shadow: 0 14px 32px rgba(0, 0, 0, 0.55);
        }

        /* מצב Dim - ביניים */
        :root[data-theme="dim"] {
            --bg-primary: #2a2a2a;
            --bg-secondary: #333333;
            --bg-tertiary: #3a3a3a;
            --text-primary: #d0d0d0;
            --text-secondary: #a0a0a0;
            --text-muted: #707070;
            --primary: #7c8aff;
            --secondary: #9d7aff;
            --glass: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.15);
            --glass-hover: rgba(255, 255, 255, 0.12);
            --card-bg: rgba(40, 40, 40, 0.8);
            --code-bg: #2a2a2a;
            --btn-primary-bg: color-mix(in srgb, var(--bg-tertiary) 78%, var(--primary) 22%);
            --btn-primary-color: var(--text-primary);
            --btn-primary-border: var(--glass-border);
            --btn-primary-shadow: 0 6px 18px rgba(0, 0, 0, 0.45);
            --btn-primary-hover-bg: color-mix(in srgb, var(--bg-tertiary) 60%, var(--primary) 40%);
            --btn-primary-hover-shadow: 0 12px 28px rgba(0, 0, 0, 0.55);
        }

        /* Nebula – גווני כחול/סגול קוסמיים */
        :root[data-theme="nebula"] {
            --bg-primary: #151a2c;
            --bg-secondary: #1f263a;
            --bg-tertiary: #28324a;
            --text-primary: #e6e9f8;
            --text-secondary: #c5c9de;
            --text-muted: #8d93ad;
            --primary: #777abc;
            --primary-dark: #5f63d3;
            --secondary: #4d6bb6;
            --success: #7fe7c4;
            --danger: #f598b2;
            --warning: #f6b37b;
            --info: #7cc4ff;
            --glass: rgba(119, 122, 188, 0.15);
            --glass-border: rgba(119, 122, 188, 0.35);
            --glass-hover: rgba(119, 122, 188, 0.22);
            --card-bg: rgba(21, 27, 44, 0.85);
            --card-border: rgba(119, 122, 188, 0.35);
            --code-bg: #12192c;
            --code-text: #ecf0ff;
            --code-border: rgba(119, 122, 188, 0.4);
            --btn-primary-bg: color-mix(in srgb, var(--card-bg) 60%, var(--primary) 40%);
            --btn-primary-color: var(--text-primary);
            --btn-primary-border: var(--glass-border);
            --btn-primary-shadow: 0 10px 30px rgba(21, 27, 44, 0.65);
            --btn-primary-hover-bg: color-mix(in srgb, var(--card-bg) 45%, var(--primary) 55%);
            --btn-primary-hover-shadow: 0 16px 36px rgba(21, 27, 44, 0.7);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body { height: 100%; overflow-x: hidden; }

        body {
            font-family: 'Heebo', sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            color: white;
            position: relative;
            font-size: calc(16px * var(--ui-font-scale, 1));
        }

        /* עדכון body למצב חשוך/מעומעם/ocean/custom */
        :root[data-theme="dark"] body,
        :root[data-theme="dim"] body,
        :root[data-theme="nebula"] body,
        :root[data-theme="ocean"] body,
        :root[data-theme-type="custom"] body {
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
        }

        :root[data-theme="rose-pine-dawn"] body {
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            /* מרכז את ה"גל" ומונע בריחה שמאלה במסכים צרים */
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="%23ffffff" fill-opacity="0.05" d="M0,96L48,112C96,128,192,160,288,160C384,160,480,128,576,122.7C672,117,768,139,864,138.7C960,139,1056,117,1152,101.3C1248,85,1344,75,1392,69.3L1440,64L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"/></svg>') no-repeat bottom center;
            background-size: 100% auto;
            background-attachment: fixed;
            inset: 0;
            overflow: hidden;
            pointer-events: none;
            z-index: 0;
        }

        /* עדכון רקע הגל למצב חשוך/מעומעם */
        :root[data-theme="dark"] body::before,
        :root[data-theme="dim"] body::before,
        :root[data-theme-type="custom"] body::before {
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="%23000000" fill-opacity="0.1" d="M0,96L48,112C96,128,192,160,288,160C384,160,480,128,576,122.7C672,117,768,139,864,138.7C960,139,1056,117,1152,101.3C1248,85,1344,75,1392,69.3L1440,64L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"/></svg>') no-repeat bottom center;
        }

        :root[data-theme="nebula"] body::before {
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="%2324324a" fill-opacity="0.22" d="M0,96L48,112C96,128,192,160,288,160C384,160,480,128,576,122.7C672,117,768,139,864,138.7C960,139,1056,117,1152,101.3C1248,85,1344,75,1392,69.3L1440,64L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"/></svg>') no-repeat bottom center;
        }

        :root[data-theme="ocean"] body::before {
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="%231a365d" fill-opacity="0.25" d="M0,96L48,112C96,128,192,160,288,160C384,160,480,128,576,122.7C672,117,768,139,864,138.7C960,139,1056,117,1152,101.3C1248,85,1344,75,1392,69.3L1440,64L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"/></svg>') no-repeat bottom center;
        }

        :root[data-theme="rose-pine-dawn"] body::before {
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="%23f2e9e1" fill-opacity="0.4" d="M0,96L48,112C96,128,192,160,288,160C384,160,480,128,576,122.7C672,117,768,139,864,138.7C960,139,1056,117,1152,101.3C1248,85,1344,75,1392,69.3L1440,64L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"/></svg>') no-repeat bottom center;
        }
        :root[data-theme="rose-pine-dawn"] input:not([type="checkbox"]):not([type="radio"]),
        :root[data-theme="rose-pine-dawn"] textarea:not(.sticky-note-content),
        :root[data-theme="rose-pine-dawn"] select {
            background: color-mix(in srgb, var(--bg-secondary) 80%, #ffffff 20%);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            box-shadow: inset 0 1px 3px rgba(87, 82, 121, 0.12);
        }
        :root[data-theme="rose-pine-dawn"] input::placeholder,
        :root[data-theme="rose-pine-dawn"] textarea::placeholder {
            color: color-mix(in srgb, var(--text-muted) 70%, #ffffff 30%);
        }
        :root[data-theme="rose-pine-dawn"] .btn,
        :root[data-theme="rose-pine-dawn"] .editor-switcher {
            color: var(--text-primary);
        }
        
        

        /* מונע חריגת תוכן לרוחב שיוצרת גלילה אופקית */
        .main-content, .container {
            max-width: 100%;
            overflow-x: hidden;
        }

        /* במסכים צרים הגל יתאים לרוחב המסך במרכז */
        @media (max-width: 480px) {
            body::before {
                background-position: bottom center;
                background-size: 140% auto; /* מעט יותר רחב כדי להימנע משוליים לבנים */
            }
        }

        .navbar {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border-bottom: 0; /* הסרת הקו האופקי העליון */
            padding: 1rem 0;
            position: static;
            top: auto;
            z-index: 1000;
            transform: translateY(0);
            transition: transform 0.24s ease, background 0.2s ease, box-shadow 0.2s ease, backdrop-filter 0.2s ease;
        }


        /* אפקט עומק עדין בעת פתיחת תפריט במובייל */
        body.nav-open .navbar {
            background: rgba(255, 255, 255, 0.16);
            box-shadow: 0 10px 24px rgba(0,0,0,0.25);
        }
        body.nav-open .navbar::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            bottom: -1px;
            height: 12px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.25), rgba(0,0,0,0));
            pointer-events: none;
        }

        .container {
            max-width: min(1320px, 98vw);
            margin: 0 auto;
            padding: 0 20px;
        }

        .nav-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary, white);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .nav-menu {
            display: flex;
            gap: 2rem;
            list-style: none;
            align-items: center;
        }

        .navbar,
        .navbar * {
            scrollbar-width: thin;
        }

        .navbar ::-webkit-scrollbar {
            width: var(--scrollbar-width);
            height: var(--scrollbar-width);
        }
        
        .nav-link {
            color: var(--text-primary, white);
            text-decoration: none;
            font-weight: 500;
            transition: opacity 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        /* טקסט ליד אייקון הגדרות – יוסתר במסכים צרים כדי לחסוך מקום */
        .nav-link .nav-text { opacity: 0.95; }
        @media (max-width: 480px) {
            .nav-link .nav-text { display: none; }
        }
        
        .nav-link:hover {
            opacity: 0.8;
        }
        
        .user-menu {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .user-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--primary);
        }
        
        .main-content {
            position: relative;
            z-index: 1;
            padding: 2rem 0;
            min-height: calc(100vh - 80px);
        }
        /* מרווח מובנה בין בלוקי חיפוש/פילטרים כדי למנוע התנגשות ויזואלית */
        .search-and-filters { display: flex; flex-direction: column; gap: 16px; }
        .filters-row { display: flex; gap: 12px; }
        .filter-container { margin-top: 16px; }
        
        .glass-card {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            padding: 2rem;
            margin-bottom: 2rem;
        }
        /* מניעת חיתוך כרטיסים בשוליים בכל המסכים (כולל RTL) */
        .main-content .glass-card,
        .main-content .feature-card,
        .main-content .stat-card {
            margin-left: 0.5rem;
            margin-right: 0.5rem;
            width: calc(100% - 1rem);
            box-sizing: border-box;
            min-width: 0;
        }
        /* ברזולוציות צרות – הוסף padding פנימי קל לימין לפיצוי על RTL ותפריטים */
        @media (max-width: 480px) {
            .main-content .glass-card { padding-right: 18px; }
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            white-space: nowrap;
        }
        
        .btn-primary {
            background: var(--btn-primary-bg, white);
            color: var(--btn-primary-color, var(--primary));
            border: 1px solid var(--btn-primary-border, transparent);
            box-shadow: var(--btn-primary-shadow, none);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            background: var(--btn-primary-hover-bg, var(--btn-primary-bg, white));
            box-shadow: var(--btn-primary-hover-shadow, 0 10px 20px rgba(0,0,0,0.2));
        }
        
        .btn-secondary {
            background: var(--glass);
            color: var(--text-primary, white);
            border: 1px solid var(--glass-border);
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .workspace-btn {
            /* fallback (old browsers) */
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            /* theme-based */
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border: none;
            position: relative;
            color: white;
        }

        .workspace-btn:hover {
            transform: translateY(-2px);
            /* fallback */
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            /* theme-based */
            box-shadow: 0 6px 20px color-mix(in srgb, var(--primary) 40%, transparent);
        }

        .collection-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0.25rem 0;
        }

        .collection-option input[type="radio"] {
            flex: 0 0 auto;
        }

        .workspace-collection-option {
            margin: 0.5rem 0;
            padding: 0.5rem;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(102, 126, 234, 0.3);
        }

        .workspace-collection-option span {
            font-weight: 600;
        }

        .collection-option-divider {
            margin: 0.75rem 0 0.5rem;
            font-size: 0.85rem;
            color: #666;
            border-top: 1px solid #ddd;
            padding-top: 0.5rem;
        }
        
        .btn-icon {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        /* כיתוב מפורש בכפתורים – מוסתר כברירת מחדל; יוצג רק ב-fallback */
        .btn .btn-text { display: none; }
        .no-fa-icons .btn .btn-text { display: inline; }
        
        .alert {
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
        }
        
        .alert-success {
            background: rgba(72, 187, 120, 0.2);
            border: 1px solid rgba(72, 187, 120, 0.4);
        }
        
        .alert-error {
            background: rgba(245, 101, 101, 0.2);
            border: 1px solid rgba(245, 101, 101, 0.4);
        }
        
        .alert-info {
            background: rgba(66, 153, 225, 0.2);
            border: 1px solid rgba(66, 153, 225, 0.4);
        }
        
        h1, h2, h3, h4, h5, h6 {
            margin-bottom: 1rem;
        }
        
        .page-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 2rem;
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
        }
        
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            background: var(--glass);
            border: 1px solid var(--glass-border);
        }
        
        .mobile-menu-toggle {
            display: none;
            background: transparent;
            border: none;
            color: var(--text-primary, white);
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        /* (ניטרלנו נעילת גלילה; התפריט אינו מכסה תוכן ולכן אין צורך) */
        
        @media (max-width: 768px) {
            .nav-menu {
                display: flex;
                position: static;
                width: 100%;
                background: transparent;
                flex-direction: column;
                padding: 0;
                gap: 1rem;
                border-top: 0; /* מניעת קו אופקי נוסף במובייל */
                max-height: 0;
                overflow: hidden;
                opacity: 0;
                transform: translateY(-8px);
                transition: max-height 0.25s ease, opacity 0.2s ease, transform 0.2s ease, padding 0.2s ease;
            }

            .nav-menu.active {
                padding: 0.5rem 0;
                max-height: 70vh;
                opacity: 1;
                transform: translateY(0);
            }

            .mobile-menu-toggle {
                display: block;
            }

            .page-title {
                font-size: 2rem;
            }

            .glass-card {
                padding: 1.5rem;
            }
            
            .container {
                max-width: 100%;
                padding: 0 12px;
            }
        }

        /* Telegram Mini App adjustments */
        body.telegram-mini-app .container {
            max-width: 100% !important;
            padding-left: 8px !important;
            padding-right: 8px !important;
        }
        body.telegram-mini-app .glass-card {
            padding: 1rem !important;
            border-radius: 14px;
        }
        /* Mini WebApp: יישור כרטיסים לקצוות המסך ללא רווח מיותר */
        body.telegram-mini-app .main-content .glass-card,
        body.telegram-mini-app .main-content .feature-card,
        body.telegram-mini-app .main-content .stat-card {
            margin-left: 0 !important;
            margin-right: 0 !important;
            width: 100% !important;
        }
        body.telegram-mini-app .navbar {
            position: static;
            top: auto;
            background: transparent;
            backdrop-filter: none;
            border-bottom: 0;
        }
        body.telegram-mini-app .navbar::after { display: none; }

        /* Mini WebApp: במסכי טאבלט ומעלה – מכולה ראשית ברוחב מלא וללא ריווח צדדי */
        @media (min-width: 768px) {
            body.telegram-mini-app .container {
                width: 100% !important;
                max-width: none !important;
                padding-left: 0 !important;
                padding-right: 0 !important;
                margin-left: 0 !important;
                margin-right: 0 !important;
            }
        }

        /* Loading animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Scrollbar styling */
        @media (min-width: 768px) {
            :root {
                --scrollbar-width: calc(var(--scrollbar-width-base) / 2);
            }
        }

        ::-webkit-scrollbar {
            width: var(--scrollbar-width);
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        /* תפריט קיצורי דרך */
        .quick-access-menu {
            position: relative;
            margin-left: 1rem;
        }

        .quick-access-toggle {
            background: var(--quick-toggle-bg, var(--glass));
            border: 1px solid var(--quick-toggle-border, var(--glass-border));
            color: var(--quick-toggle-color, var(--text-primary, #ffffff));
            padding: 0.5rem 0.85rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.25s ease;
            font-size: 1.1rem;
            box-shadow: 0 6px 18px rgba(15, 23, 42, 0.12);
        }

        .quick-access-toggle:hover {
            background: var(--quick-toggle-hover-bg, var(--glass-hover, rgba(255, 255, 255, 0.2)));
            transform: translateY(-2px);
            box-shadow: 0 10px 24px rgba(15, 23, 42, 0.16);
            color: var(--primary, currentColor);
        }

        .quick-access-toggle.active {
            background: var(--primary);
            border-color: var(--primary);
            color: #ffffff;
            box-shadow: 0 12px 30px rgba(15, 23, 42, 0.2);
        }

        .quick-access-dropdown {
            position: absolute;
            top: 100%;
            right: 0; /* נפתח מתחת לכפתור ולא מכסה את הלוגו */
            transform: translateY(6px);
            background: var(--quick-dropdown-bg, var(--card-bg, #ffffff));
            border-radius: 12px;
            box-shadow: 0 12px 32px rgba(15, 23, 42, 0.15);
            opacity: 0;
            visibility: hidden;
            transition: all 0.25s ease;
            z-index: 1000;
            display: flex;
            direction: ltr; /* שמירה על סדר פריטים משמאל לימין גם ב-RTL */
            gap: .25rem;
            padding: .4rem;
            max-width: calc(100vw - 24px); /* אין גלילה אופקית */
            overflow-x: hidden;
            border: 1px solid var(--quick-dropdown-border, var(--card-border, rgba(0, 0, 0, 0.08)));
        }

        .quick-access-dropdown.active {
            opacity: 1;
            visibility: visible;
        }

        .quick-access-item {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            padding: 0;
            border-radius: 10px;
            color: var(--text-primary, #333);
            text-decoration: none;
            background: var(--quick-item-bg, transparent);
            border: 1px solid var(--quick-item-border, var(--glass-border, rgba(0,0,0,0.08)));
            cursor: pointer;
            transition: transform .15s ease, background .2s ease;
        }

        .quick-access-item:first-child { border-radius: 12px 12px 0 0; }
        .quick-access-item:last-child { border-radius: 0 0 12px 12px; }

        .quick-access-item:hover {
            background: var(--glass-hover, rgba(103, 126, 234, 0.1));
            color: var(--primary);
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.12);
        }

        .qa-icon { font-size: 1.1rem; }
        .qa-label { display: none; }

        /* Fun Mode (כמו "קיצורי דרך" אבל עם אנימציות) */
        .fun-mode-menu {
            position: relative;
        }

        .fun-mode-toggle {
            background: var(--quick-toggle-bg, var(--glass));
            border: 1px solid var(--quick-toggle-border, var(--glass-border));
            color: var(--quick-toggle-color, var(--text-primary, #ffffff));
            padding: 0.5rem 0.75rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.25s ease;
            font-size: 1.15rem;
            line-height: 1;
            box-shadow: 0 6px 18px rgba(15, 23, 42, 0.12);
        }

        .fun-mode-toggle:hover {
            background: var(--quick-toggle-hover-bg, var(--glass-hover, rgba(255, 255, 255, 0.2)));
            transform: translateY(-2px);
            box-shadow: 0 10px 24px rgba(15, 23, 42, 0.16);
        }

        .fun-mode-toggle.active {
            background: var(--primary);
            border-color: var(--primary);
            color: #ffffff;
            box-shadow: 0 12px 30px rgba(15, 23, 42, 0.2);
        }

        .fun-mode-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            transform: translateY(6px);
            background: var(--quick-dropdown-bg, var(--card-bg, #ffffff));
            border-radius: 12px;
            box-shadow: 0 12px 32px rgba(15, 23, 42, 0.15);
            opacity: 0;
            visibility: hidden;
            transition: all 0.25s ease;
            z-index: 1000;
            display: flex;
            direction: ltr;
            gap: .25rem;
            padding: .4rem;
            max-width: calc(100vw - 24px);
            overflow-x: hidden;
            border: 1px solid var(--quick-dropdown-border, var(--card-border, rgba(0, 0, 0, 0.08)));
        }

        .fun-mode-dropdown.active {
            opacity: 1;
            visibility: visible;
        }

        .fun-mode-item {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            padding: 0;
            border-radius: 10px;
            color: var(--text-primary, #333);
            text-decoration: none;
            background: var(--quick-item-bg, transparent);
            border: 1px solid var(--quick-item-border, var(--glass-border, rgba(0,0,0,0.08)));
            cursor: pointer;
            transition: transform .15s ease, background .2s ease;
            font-size: 1.15rem;
        }

        .fun-mode-item:hover {
            background: var(--glass-hover, rgba(103, 126, 234, 0.1));
            color: var(--primary);
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.12);
        }

        /* Fallback when Font Awesome fails to load: hide FA <i> and reveal labels */
        .no-fa-icons .btn-icon i[class^="fa"],
        .no-fa-icons .btn-icon i[class*=" fa-"] { display: none !important; }
        /* In quick-access menu, reveal labels and hide emoji/icon when FA missing */
        .no-fa-icons .quick-access-item .qa-icon { display: none !important; }
        .no-fa-icons .quick-access-item .qa-label { display: inline !important; }

        /* אנימציה לפתיחה */
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        /* מודאלים כלליים (קבצים אחרונים + בורר קהילה) */
        .recent-files-modal,
        .community-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .recent-files-modal .modal-backdrop,
        .community-modal .modal-backdrop {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        .recent-files-modal .modal-content,
        .community-modal .modal-content {
            position: relative;
            background: var(--card-bg, white);
            color: var(--text-primary, #333);
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 70vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            animation: modalSlideUp 0.3s ease;
        }
        .community-modal .modal-content {
            color: var(--text-primary, #1f2933);
        }
        @keyframes modalSlideUp {
            from { opacity: 0; transform: translateY(20px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        .recent-files-modal .modal-header,
        .community-modal .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 1.5rem; border-bottom: 1px solid var(--card-border, #e0e0e0);
        }
        .recent-files-modal .modal-header h3,
        .community-modal .modal-header h3 { margin: 0; font-size: 1.25rem; color: var(--text-primary, #333); }
        .recent-files-modal .modal-close,
        .community-modal .modal-close { background: none; border: none; font-size: 1.5rem; color: var(--text-secondary, #666); cursor: pointer; padding: 0.25rem; transition: color 0.2s; }
        .recent-files-modal .modal-close:hover,
        .community-modal .modal-close:hover { color: var(--text-primary, #333); }
        .recent-files-modal .modal-body,
        .community-modal .modal-body { flex: 1; overflow-y: auto; padding: 1rem; }
        .community-modal .modal-body .btn.btn-secondary {
            color: #1f2933;
            border-color: rgba(15, 23, 42, 0.15);
        }
        .community-modal .modal-body .btn.btn-secondary:hover {
            background: rgba(102, 126, 234, 0.15);
            color: #1f2933;
        }
        .recent-file-item { display: flex; align-items: center; gap: 1rem; padding: 0.75rem; border-radius: 8px; text-decoration: none; color: var(--text-primary, #333); transition: all 0.2s ease; margin-bottom: 0.5rem; }
        .recent-file-item:hover { background: rgba(103,126,234,0.1); transform: translateX(-4px); }
        .recent-files-modal .file-icon { font-size: 1.5rem; min-width: 40px; text-align: center; }
        .recent-files-modal .file-info { flex: 1; min-width: 0; }
        .recent-files-modal .file-name { font-weight: 500; margin-bottom: 0.25rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: var(--text-primary, #333); }
        .recent-files-modal .file-meta { display: flex; gap: 1rem; font-size: 0.85rem; color: var(--text-secondary, #666); }
        .recent-files-modal .no-files { text-align: center; color: var(--text-secondary, #666); padding: 2rem; font-size: 1.1rem; }

        /* מובייל */
        @media (max-width: 768px) {
            .quick-access-menu { order: -1; margin-left: 0; margin-right: 0.5rem; }
            .quick-access-dropdown {
              position: absolute; top: 100%; right: 0; left: auto; transform: none;
              display: grid; grid-template-columns: repeat(4, 44px); gap: .25rem; padding: .4rem;
              max-width: calc(100vw - 16px);
              direction: ltr; /* במובייל גם, מניעת היפוך סדר ב-RTL */
            }
        }

        /* מצב כהה */
        @media (prefers-color-scheme: dark) {
            .quick-access-dropdown { background: #2a2a3a; }
            .quick-access-item { color: #e0e0e0; }
            .quick-access-item:hover { background: rgba(103, 126, 234, 0.2); }
            .recent-files-modal .modal-content,
            .community-modal .modal-content { background: #2a2a3a; color: #f5f5f5; }
            .recent-files-modal .modal-header,
            .community-modal .modal-header { border-bottom-color: #444; }
            .recent-files-modal .modal-header h3,
            .community-modal .modal-header h3,
            .recent-file-item { color: #e0e0e0; }
            .community-modal .modal-body .btn.btn-secondary {
                color: #f5f5f5;
                border-color: rgba(148, 163, 184, 0.35);
            }
            .community-modal .modal-body .btn.btn-secondary:hover {
                background: rgba(148, 163, 184, 0.25);
                color: #ffffff;
            }
            .recent-files-modal .file-meta, .recent-files-modal .no-files { color: #999; }
        }

        /* Premium announcement indicator */
        .notif-dot {
            position: absolute;
            top: -4px;
            left: -4px; /* RTL: שמאל מעל הכפתור */
            width: 12px;
            height: 12px;
            border-radius: 999px;
            background: #fbbf24; /* זהב לפרימיום */
            border: 2px solid rgba(255,255,255,0.85);
            box-shadow: 0 0 0 2px rgba(0,0,0,0.08);
            pointer-events: auto;
            cursor: pointer;
            z-index: 1200;
        }
        .notif-dot--pulse::after {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: inherit;
            border: 2px solid rgba(251, 191, 36, 0.55);
            animation: notifPulse 1.4s ease-out infinite;
        }
        @keyframes notifPulse {
            0% { transform: scale(0.8); opacity: 0.8; }
            80% { transform: scale(1.4); opacity: 0; }
            100% { transform: scale(1.4); opacity: 0; }
        }
        /* בועת תזכורות משודרגת עם מונה */
        .notif-bubble {
            position: absolute;
            top: -8px;
            left: -8px; /* RTL: שמאל מעל הכפתור */
            min-width: 22px;
            height: 22px;
            padding: 0 6px;
            border-radius: 999px;
            background: #fb923c; /* כתום בולט יותר */
            color: #1f2937;
            border: 2px solid rgba(255,255,255,0.9);
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 12px;
            line-height: 1;
            z-index: 1200;
        }
        .notif-bubble[data-count="1"] { min-width: 18px; height: 18px; font-size: 11px; }
        .notif-bubble--pulse::after {
            content: '';
            position: absolute; inset: -4px; border-radius: inherit;
            border: 2px solid rgba(251, 146, 60, 0.45);
            animation: notifPulse 1.4s ease-out infinite;
        }
        .mobile-menu-toggle { position: relative; }
        .nav-link[href="/settings"] { position: relative; }

        .notif-popover {
            position: absolute;
            top: 18px;
            left: 12px; /* RTL: שמאל של הכפתור */
            background: #ffffff;
            color: #1f2933;
            border-radius: 12px;
            box-shadow: 0 10px 24px rgba(0,0,0,0.18);
            padding: 10px 12px;
            z-index: 1300;
            font-size: 0.95rem;
            line-height: 1.35;
            min-width: 180px;
            max-width: 260px;
            display: none;
        }
        .notif-popover[data-open="true"] { display: block; }
        .notif-popover__title { font-weight: 700; margin-bottom: 6px; }
        .notif-popover__actions { display: flex; gap: .5rem; justify-content: flex-end; margin-top: .5rem; }
        .notif-popover .btn { padding: 0.4rem 0.75rem; font-size: 0.9rem; }

        /* כאשר רונדר דרך פורטל (מחוץ ל-navbar) נמנע חיתוך ע"י הורה */
        .notif-popover--portal {
            position: fixed;
            inset: auto; /* מאפשר ל-inline styles של JS להגדיר top/left/right */
            z-index: 12000; /* מעל ה-navbar והכרטיסים */
            max-width: min(92vw, 320px);
        }

        @media (prefers-color-scheme: dark) {
            .notif-popover { background: #2a2a3a; color: #f5f5f5; box-shadow: 0 10px 24px rgba(0,0,0,0.35); }
        }

        /* Announcement banner — vertical marquee */
        .announcement-banner {
            position: relative;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            margin-top: 8px;
            padding: 6px 10px;
            color: var(--text-primary, #fff);
            display: flex;
            align-items: center;
            gap: 8px;
            overflow: hidden;
            min-height: 40px;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            touch-action: manipulation;
        }
        .announcement-banner__icon { font-size: 1.05rem; opacity: 0.95; }
        .announcement-banner__scroller { flex: 1; overflow: visible; height: auto; }
        .announcement-banner__inner {
            will-change: auto;
            animation: none !important;
        }
        .announcement-banner__content { white-space: normal; line-height: 1.28; opacity: 0.95; font-size: 0.95rem; }
        .announcement-banner__content a { color: inherit; text-decoration: underline; }
        .announcement-banner__content a:hover { opacity: 0.9; }
        .announcement-banner:hover .announcement-banner__inner,
        .announcement-banner:focus-within .announcement-banner__inner,
        .announcement-banner.is-paused .announcement-banner__inner { animation-play-state: paused; }
        @keyframes announcementMarquee {
            from { transform: translateY(0); }
            to { transform: translateY(calc(-1 * var(--announcement-distance, 100%))); }
        }
        /* Hide the banner when nav menu is open (avoid overlap) */
        body.nav-open .announcement-banner { display: none; }
        /* Respect reduced motion */
        @media (prefers-reduced-motion: reduce) {
            .announcement-banner__inner { animation: none !important; }
        }
        /* Always show banner across breakpoints (was hidden on 640–1024px) */
        @media (max-width: 480px) {
            .announcement-banner__scroller { height: 56px; }
            .announcement-banner__content { font-size: 0.9rem; }
        }

        /* התאמות RTL ל-Driver.js */
        .driver-popover {
            direction: rtl;
            text-align: right;
            font-family: 'Heebo', sans-serif;
            border-radius: 16px;
            background: var(--card-bg, rgba(255,255,255,0.98));
            color: var(--text-primary, #1f2937);
            box-shadow: 0 18px 40px rgba(0, 0, 0, 0.35);
        }
        :root[data-theme="dark"] .driver-popover,
        :root[data-theme="dim"] .driver-popover,
        :root[data-theme="nebula"] .driver-popover {
            background: rgba(26, 32, 44, 0.98);
            color: var(--text-primary, #f7fafc);
        }
        .driver-popover .driver-popover-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.35rem;
        }
        .driver-popover .driver-popover-description {
            font-size: 0.95rem;
            line-height: 1.6;
        }
        .driver-popover .driver-popover-navigation {
            flex-direction: row-reverse;
            gap: 0.25rem;
        }
        .driver-popover button {
            font-family: inherit;
        }
.welcome-modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 11000; }
.welcome-modal.active { display: flex; }
.welcome-modal__backdrop { position: absolute; inset: 0; background: rgba(0, 0, 0, 0.55); backdrop-filter: blur(6px); }
.welcome-modal__content {
    position: relative;
    background: #1f2a44;
    color: #fff;
    border-radius: 20px;
    max-width: 420px;
    width: calc(100% - 2rem);
    padding: 2rem 1.75rem;
    text-align: center;
    box-shadow: 0 18px 40px rgba(0, 0, 0, 0.35);
}
.welcome-modal__content h2 { margin: 0 0 1rem; font-size: 1.6rem; }
.welcome-modal__content p { margin: 0.75rem 0; color: rgba(255, 255, 255, 0.85); }
.welcome-modal__actions { display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center; margin-top: 1.5rem; }
.welcome-modal__close {
    position: absolute;
    top: 0.75rem;
    left: 0.75rem;
    background: transparent;
    border: none;
    color: rgba(255, 255, 255, 0.75);
    font-size: 1.25rem;
    cursor: pointer;
}
.welcome-modal__close:hover,
.welcome-modal__close:focus { color: #fff; }
.welcome-modal__actions .btn { min-width: 180px; }
.welcome-modal__note { font-size: 0.95rem; margin-top: 1rem; color: rgba(255,255,255,0.75); }
.welcome-modal__note a { color: #fff; text-decoration: underline; }
@media (max-width: 480px) {
    .welcome-modal__content { padding: 1.5rem 1.25rem; }
}

    </style>
    <style>
        body.theme-wizard-open {
            overflow: hidden;
        }
        #themeWizard {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 14000;
            padding: 1.5rem;
        }
        #themeWizard.is-open {
            display: flex;
        }
        .theme-wizard__backdrop {
            position: absolute;
            inset: 0;
            background: rgba(7, 12, 24, 0.62);
            backdrop-filter: blur(6px);
        }
        .theme-wizard__dialog {
            position: relative;
            width: min(640px, 100%);
            background: var(--card-bg, rgba(15, 23, 42, 0.96));
            color: var(--text-primary, #f8fafc);
            border-radius: 28px;
            padding: 2.25rem 2.5rem 2.5rem;
            border: 1px solid var(--glass-border, rgba(255,255,255,0.25));
            box-shadow: 0 30px 60px rgba(3, 6, 23, 0.55);
        }
        :root[data-theme="rose-pine-dawn"] .theme-wizard__dialog {
            background: rgba(250, 244, 237, 0.96);
            color: var(--text-primary, #433c59);
            border-color: rgba(144, 122, 169, 0.3);
        }
        .theme-wizard__close {
            position: absolute;
            top: 1rem;
            left: 1rem;
            border: none;
            background: transparent;
            color: inherit;
            font-size: 1.25rem;
            cursor: pointer;
        }
        .theme-wizard__header {
            text-align: right;
            margin-bottom: 1.75rem;
        }
        .theme-wizard__eyebrow {
            font-size: 0.9rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            opacity: 0.8;
            margin-bottom: 0.4rem;
        }
        .theme-wizard__title {
            font-size: 1.8rem;
            margin: 0 0 0.75rem;
        }
        .theme-wizard__subtitle {
            margin: 0;
            color: var(--text-secondary, rgba(255,255,255,0.8));
            font-size: 1rem;
            line-height: 1.5;
        }
        .theme-wizard__options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 1.25rem;
        }
        .theme-wizard-option {
            border: 1px solid rgba(255, 255, 255, 0.18);
            background: rgba(255, 255, 255, 0.04);
            border-radius: 18px;
            padding: 1rem;
            text-align: right;
            cursor: pointer;
            transition: transform 160ms ease, border-color 160ms ease, background 160ms ease;
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }
        .theme-wizard-option:focus-visible {
            outline: 2px solid var(--primary, #7c3aed);
            outline-offset: 3px;
        }
        .theme-wizard-option__emoji {
            font-size: 1.6rem;
        }
        .theme-wizard-option__name {
            font-weight: 600;
            font-size: 1.1rem;
        }
        .theme-wizard-option__desc {
            font-size: 0.95rem;
            color: var(--text-secondary, rgba(255,255,255,0.8));
        }
        .theme-wizard-option.is-active,
        .theme-wizard-option:hover {
            transform: translateY(-4px);
            border-color: var(--primary, rgba(255,255,255,0.65));
            background: rgba(255, 255, 255, 0.12);
        }
        :root[data-theme="rose-pine-dawn"] .theme-wizard-option {
            border-color: rgba(144, 122, 169, 0.3);
            background: rgba(250, 244, 237, 0.65);
        }
        .theme-wizard__hint {
            font-size: 0.95rem;
            color: var(--text-secondary, rgba(255,255,255,0.82));
            margin-bottom: 1.5rem;
        }
        .theme-wizard__actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            justify-content: flex-end;
        }
        .theme-wizard__actions .btn {
            min-width: 160px;
        }
        @media (max-width: 640px) {
            .theme-wizard__dialog {
                padding: 1.75rem;
            }
            .theme-wizard__title {
                font-size: 1.5rem;
            }
            .theme-wizard__options {
                grid-template-columns: 1fr;
            }
            .theme-wizard__actions {
                flex-direction: column;
                align-items: stretch;
            }
            .theme-wizard__actions .btn {
                width: 100%;
            }
        }

        /* ========================================
           Theme Picker Modal Styles
           ======================================== */

        body.theme-picker-open {
            overflow: hidden;
        }

        #themePickerModal {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 15000;
            padding: 1rem;
        }

        #themePickerModal.is-open {
            display: flex;
        }

        .theme-picker__backdrop {
            position: absolute;
            inset: 0;
            background: rgba(7, 12, 24, 0.65);
            backdrop-filter: blur(8px);
        }

        .theme-picker__dialog {
            position: relative;
            width: min(720px, 95%);
            max-height: 85vh;
            background: var(--card-bg, rgba(15, 23, 42, 0.96));
            color: var(--text-primary, #f8fafc);
            border-radius: 24px;
            padding: 1.75rem 2rem 2rem;
            border: 1px solid var(--glass-border, rgba(255, 255, 255, 0.2));
            box-shadow: 0 25px 50px rgba(3, 6, 23, 0.5);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* התאמה לערכות בהירות */
        :root[data-theme="rose-pine-dawn"] .theme-picker__dialog,
        :root[data-theme="classic"] .theme-picker__dialog {
            background: rgba(250, 244, 237, 0.98);
            color: var(--text-primary, #433c59);
            border-color: rgba(144, 122, 169, 0.3);
        }

        :root[data-theme="classic"] .theme-picker__dialog {
            --text-primary: #433c59;
            --text-secondary: rgba(67, 60, 89, 0.72);
            --text-muted: rgba(67, 60, 89, 0.55);
        }

        .theme-picker__close {
            position: absolute;
            top: 1rem;
            left: 1rem;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: inherit;
            font-size: 1.1rem;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-picker__close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .theme-picker__header {
            text-align: right;
            margin-bottom: 1.25rem;
        }

        .theme-picker__title {
            font-size: 1.5rem;
            margin: 0 0 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        .theme-picker__icon {
            font-size: 1.3rem;
        }

        .theme-picker__subtitle {
            margin: 0;
            color: var(--text-secondary, rgba(255, 255, 255, 0.75));
            font-size: 0.95rem;
        }

        /* Tabs */
        .theme-picker__tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.25rem;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .theme-picker__tab {
            padding: 0.5rem 1rem;
            border: 1px solid rgba(255, 255, 255, 0.15);
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-secondary, rgba(255, 255, 255, 0.7));
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .theme-picker__tab:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.25);
        }

        .theme-picker__tab.active {
            background: var(--primary, #7c3aed);
            border-color: var(--primary, #7c3aed);
            color: #fff;
        }

        /* Grid */
        .theme-picker__grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 0.875rem;
            overflow-y: auto;
            max-height: 45vh;
            padding: 0.25rem;
            margin: 0 -0.25rem;
        }

        .theme-picker__grid::-webkit-scrollbar {
            width: 6px;
        }

        .theme-picker__grid::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        /* Theme Card */
        .theme-picker__card {
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 14px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: right;
            position: relative;
        }

        .theme-picker__card:hover {
            transform: translateY(-3px);
            border-color: rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .theme-picker__card.is-active {
            border-color: var(--primary, #7c3aed);
            background: rgba(124, 58, 237, 0.15);
        }

        .theme-picker__card.is-active::after {
            content: '✓';
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            width: 22px;
            height: 22px;
            background: var(--primary, #7c3aed);
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
        }

        /* Color Preview */
        .theme-picker__preview {
            display: flex;
            gap: 4px;
            margin-bottom: 0.75rem;
            height: 24px;
            border-radius: 6px;
            overflow: hidden;
        }

        .theme-picker__preview-color {
            flex: 1;
            min-width: 0;
        }

        .theme-picker__name {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .theme-picker__type {
            font-size: 0.75rem;
            color: var(--text-muted, rgba(255, 255, 255, 0.5));
            display: flex;
            align-items: center;
            gap: 0.3rem;
            justify-content: flex-end;
        }

        .theme-picker__type i {
            font-size: 0.7rem;
        }

        /* Loading State */
        .theme-picker__loading {
            grid-column: 1 / -1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .theme-picker__loading i {
            font-size: 1.5rem;
        }

        /* Empty State */
        .theme-picker__empty {
            grid-column: 1 / -1;
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        /* Current Theme */
        .theme-picker__current {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.9rem;
        }

        .theme-picker__current-label {
            color: var(--text-muted);
        }

        .theme-picker__current-name {
            font-weight: 600;
            color: var(--primary, #7c3aed);
        }

        /* Actions */
        .theme-picker__actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
            justify-content: flex-end;
        }

        /* Responsive */
        @media (max-width: 640px) {
            .theme-picker__dialog {
                padding: 1.25rem 1rem 1.5rem;
                max-height: 90vh;
            }
            
            .theme-picker__title {
                font-size: 1.25rem;
            }
            
            .theme-picker__grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 0.625rem;
            }
            
            .theme-picker__tabs {
                gap: 0.375rem;
            }
            
            .theme-picker__tab {
                padding: 0.4rem 0.75rem;
                font-size: 0.8rem;
            }
        }

        .quick-access-item[title="ערכת נושא"] .qa-icon {
            animation: colorShift 3s infinite;
        }

        @keyframes colorShift {
            0%, 100% { filter: hue-rotate(0deg); }
            50% { filter: hue-rotate(180deg); }
        }
    </style>
    
    {# תאימות למדריכים/תבניות שמצפים ל-extra_head #}
    {% block extra_head %}{% endblock %}
    {% block extra_css %}{% endblock %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/animations.css') }}?v={{ static_version }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/collections.css') }}?v={{ static_version }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/codemirror-custom.css') }}?v={{ static_version }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/markdown-enhanced.css') }}?v={{ static_version }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/global_search.css') }}?v={{ static_version }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/lang-badge.css') }}?v={{ static_version }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/high-contrast.css') }}?v={{ static_version }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dark-mode.css') }}?v={{ static_version }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/theme-mask.css') }}?v={{ static_version }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/smooth-scroll.css') }}?v={{ static_version }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/driver.js@1.3.1/dist/driver.css" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/driver.js@1.3.1/dist/driver.js.iife.js" defer></script>

    {% if custom_theme and custom_theme.is_active %}
    <!-- User Custom Theme Override -->
    <style id="user-custom-theme">
        :root[data-theme="custom"] {
            {% for var_name, var_value in custom_theme.variables.items() %}
            {% if var_name and var_value %}
            {{ var_name }}: {{ var_value }};
            {% endif %}
            {% endfor %}
        }
    </style>
    {% if custom_theme.syntax_css %}
    <!-- Syntax Highlighting Override -->
    <style id="user-custom-syntax">
{# תאימות לאחור: ערכות ישנות שמכילות data-theme="custom" #}
{% set _custom_syntax = (custom_theme.syntax_css
  | replace('data-theme="custom"', 'data-theme-type="custom"')
  | replace("data-theme='custom'", "data-theme-type='custom'")
) %}
{{ _custom_syntax | safe }}
    </style>
    {% endif %}
    {% if custom_theme.syntax_colors %}
    <!-- Dynamic Syntax Colors for CodeMirror HighlightStyle -->
    <script type="application/json" id="syntax-colors-data">
{{ custom_theme.syntax_colors | tojson | safe }}
    </script>
    {% endif %}
    {% endif %}

    {% if shared_theme and shared_theme.colors %}
    <!-- Shared Theme Override -->
    <style id="shared-theme-override">
        :root[data-theme^="shared:"] {
            {% for var_name, var_value in shared_theme.colors.items() %}
            {% if var_name and var_value %}
            {{ var_name }}: {{ var_value }};
            {% endif %}
            {% endfor %}
        }
    </style>
    {% if shared_theme.syntax_css %}
    <!-- Shared Theme Syntax Override -->
    <style id="shared-theme-syntax">
{# תאימות לאחור: ערכות shared שנשמרו בעבר עם data-theme="custom" #}
{% set _shared_syntax = (shared_theme.syntax_css
  | replace('data-theme="custom"', 'data-theme-type="custom"')
  | replace("data-theme='custom'", "data-theme-type='custom'")
) %}
{{ _shared_syntax | safe }}
    </style>
    {% endif %}
    {% if shared_theme.syntax_colors %}
    <!-- Dynamic Syntax Colors for CodeMirror HighlightStyle (Shared Theme) -->
    <script type="application/json" id="shared-syntax-colors-data">
{{ shared_theme.syntax_colors | tojson | safe }}
    </script>
    {% endif %}
    {% endif %}

    <!-- Primary Button States - force theme colors on all interaction states (custom + shared) -->
    <!-- 🔧 תיקון: כפתורים בערכות shared משתמשים ב-var(--primary) כמו בערכות custom (כדי לשמור על צבע link) -->
    <style id="primary-btn-states-custom-type">
        [data-theme-type="custom"] .btn-primary:active,
        [data-theme-type="custom"] .btn-primary:focus,
        [data-theme-type="custom"] .btn-primary:disabled,
        [data-theme-type="custom"] .btn-primary.disabled,
        [data-theme^="shared:"] .btn-primary:active,
        [data-theme^="shared:"] .btn-primary:focus,
        [data-theme^="shared:"] .btn-primary:disabled,
        [data-theme^="shared:"] .btn-primary.disabled {
            background-color: var(--btn-primary-bg) !important;
            color: var(--primary) !important;
            opacity: 0.8;
        }
        /* Shared theme button base styles - שימוש ב-var(--primary) כמו בערכות custom */
        [data-theme^="shared:"] .btn-primary {
            background-color: var(--btn-primary-bg) !important;
            color: var(--primary) !important;
            border-color: var(--btn-primary-border, var(--btn-primary-bg)) !important;
        }
        [data-theme^="shared:"] .btn-primary:hover {
            background-color: var(--btn-primary-hover-bg, var(--btn-primary-bg)) !important;
            color: var(--primary) !important;
        }
    </style>
    {% if can_impersonate %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/impersonation.css') }}?v={{ static_version }}">
    {% endif %}
</head>
<body>
    <div id="theme-mask" aria-hidden="true"></div>
    <script>
        // 🆕 מניעת מסך לבן: הצגת מסכה בזמן מעבר ערכה (עד שה-CSS נטען)
        (function() {
            try {
                var raw = sessionStorage.getItem('__ck_theme_transition');
                if (!raw) return;
                var data = JSON.parse(raw);
                // בדוק שהמעבר רלוונטי (לא יותר מ-5 שניות)
                if (!data || !data.ts || Date.now() - data.ts > 5000) {
                    sessionStorage.removeItem('__ck_theme_transition');
                    return;
                }
                // הצג את המסכה מיידית עם צבע הערכה הנוכחית
                var mask = document.getElementById('theme-mask');
                if (mask) {
                    mask.style.opacity = '1';
                    mask.style.clipPath = 'circle(200vmax at 50vw 50vh)';
                    mask.style.webkitClipPath = 'circle(200vmax at 50vw 50vh)';
                    mask.style.transition = 'none';
                }
                // הסר את המסכה אחרי שהעמוד נטען
                var hideAfterLoad = function() {
                    sessionStorage.removeItem('__ck_theme_transition');
                    if (mask) {
                        mask.style.transition = 'opacity 300ms ease';
                        mask.style.opacity = '0';
                        setTimeout(function() {
                            mask.style.clipPath = '';
                            mask.style.webkitClipPath = '';
                            mask.style.transition = '';
                        }, 350);
                    }
                };
                if (document.readyState === 'complete') {
                    setTimeout(hideAfterLoad, 100);
                } else {
                    window.addEventListener('load', function() { setTimeout(hideAfterLoad, 100); });
                }
            } catch (e) {
                try { sessionStorage.removeItem('__ck_theme_transition'); } catch (_) {}
            }
        })();
    </script>
    <script>
        (function() {
            try {
                if (window.Telegram && window.Telegram.WebApp) {
                    document.body.classList.add('telegram-mini-app');
                    try { window.Telegram.WebApp.expand(); } catch (e) {}
                    try { window.Telegram.WebApp.ready(); } catch (e) {}
                }
                // הזרקת scale לגופן משרת דרך data-attribute כדי להימנע מהזרקות בתוך JS
                var m = document.getElementById('uiFont');
                if (m) {
                    var scale = m.getAttribute('data-scale') || '1';
                    document.documentElement.style.setProperty('--ui-font-scale', String(scale));
                }
                // theme attribute on <html>: אל תדרוס אם נקבע מוקדם (no-flicker)
                var htmlEl = document.documentElement;
                if (!htmlEl.getAttribute('data-theme')) {
                    htmlEl.setAttribute('data-theme', '{{ ui_theme }}');
                }
                // theme-type: מאפשר CSS "לתפוס" גם ערכות shared (וגם custom) בצורה אחידה
                try {
                    var t = String(htmlEl.getAttribute('data-theme') || '').trim().toLowerCase();
                    if (t === 'custom' || t.indexOf('shared:') === 0) {
                        htmlEl.setAttribute('data-theme-type', 'custom');
                    } else {
                        htmlEl.removeAttribute('data-theme-type');
                    }
                } catch (e) {}

                // העדפת עורך מהשרת (אם קיימת) — כדי לאפשר ברירת מחדל Codemirror
                // נשמר במשתנה גלובלי שה-JS של העורך יוכל לקרוא
                try { window.__serverPreferredEditor = '{{ session.get("preferred_editor", "") }}'; } catch (e) {}
            } catch (e) {}
        })();
    </script>
    <nav class="navbar">
        <div class="container">
            <div class="nav-content">
                <a href="{{ url_for('dashboard.dashboard') }}?no_cache=1" class="logo" target="_blank" rel="noopener noreferrer">
                    <i class="fas fa-code"></i>
                    Code Keeper
                </a>
                
                <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
                    <i class="fas fa-bars"></i>
                </button>
                {% if _session_user_id %}
                <!-- תפריט קיצורי דרך -->
                <div class="quick-access-menu">
                    <button class="quick-access-toggle" onclick="toggleQuickAccess(event)" aria-label="תפריט קיצורי דרך" title="קיצורי דרך">
                        <i class="fas fa-rocket"></i>
                    </button>
                    <div class="quick-access-dropdown" id="quickAccessDropdown">
                        <a href="/upload" class="quick-access-item" title="צור קטע קוד חדש">
                            <span class="qa-icon">➕</span>
                            <span class="qa-label">צור קטע קוד חדש</span>
                        </a>
                        <button class="quick-access-item" onclick="openGlobalSearch()" title="חיפוש בכל הקבצים">
                            <span class="qa-icon">🔍</span>
                            <span class="qa-label">חיפוש גלובלי</span>
                        </button>
                        <a href="/files?category=favorites#results" class="quick-access-item" title="קבצים מועדפים">
                            <span class="qa-icon">⭐</span>
                            <span class="qa-label">מועדפים</span>
                        </a>
                        <button class="quick-access-item" onclick="toggleQuickAccess(event); navigateToWorkspace(); return false;" title="שולחן עבודה">
                            <span class="qa-icon">🖥️</span>
                            <span class="qa-label">שולחן עבודה</span>
                        </button>
                        <button class="quick-access-item" onclick="showRecentFiles()" title="קבצים שנפתחו לאחרונה">
                            <span class="qa-icon">🕓</span>
                            <span class="qa-label">נפתחו לאחרונה</span>
                        </button>
                        <button class="quick-access-item" onclick="openThemePickerModal()" title="ערכת נושא">
                            <span class="qa-icon">🎨</span>
                            <span class="qa-label">ערכת נושא</span>
                        </button>
                        {% if user_is_admin %}
                        <a href="/repo/" class="quick-access-item" title="דפדפן קוד הפרויקט">
                            <span class="qa-icon"><img src="{{ url_for('static', filename='icons/repo-browser-icon.png') }}" alt="" style="width: 1.3em; height: 1.3em; vertical-align: middle; border-radius: 3px;"></span>
                            <span class="qa-label">דפדפן קוד</span>
                        </a>
                        {% endif %}
                        <!-- הוסר: כפתור הגדרות בתוך חלונית קיצורי הדרך -->
                    </div>
                </div>
                {% endif %}

                {% if user_is_impersonating %}
                <div id="impersonation-toggle" class="impersonation-control">
                    <span class="impersonation-status" title="מצב צפייה כמשתמש פעיל">👁️ צפייה כמשתמש</span>
                    <button id="btn-stop-impersonation" class="btn btn-sm btn-warning">
                        <i class="fas fa-user-shield"></i> חזור לאדמין
                    </button>
                    <!-- 🆘 Fail-Safe Link: תמיד גלוי למקרה שה-JS לא עובד -->
                    <a href="?force_admin=1" class="impersonation-failsafe" title="לחץ כאן אם הכפתור לא עובד">
                        <i class="fas fa-life-ring"></i>
                    </a>
                </div>
                {% endif %}
                
                <ul class="nav-menu" id="navMenu">
                    {% if uptime_status_url %}
                        <li><a href="{{ uptime_status_url }}" target="_blank" class="nav-link"><i class="fas fa-signal"></i> סטטוס</a></li>
                    {% endif %}
                    {% if _session_user_id %}
                        <li><a href="/dashboard" class="nav-link"><i class="fas fa-chart-line"></i> דשבורד</a></li>
                        <li><a href="/files" class="nav-link"><i class="fas fa-folder"></i> הקבצים שלי</a></li>
                        <li><a href="/collections" class="nav-link" id="tourCollectionsNav"><i class="fas fa-layer-group"></i> האוספים שלי</a></li>
                        <li><a href="#" class="nav-link" onclick="openCommunityChooser(event)"><i class="fas fa-puzzle-piece"></i> אוסף הקהילה</a></li>
                    {% endif %}
                    
                    <li class="user-menu">
                        {% if _session_user_id %}
                            <div class="user-avatar">
                                {{ (_session_first_name[0] if _session_first_name else 'U') }}
                            </div>
                            <span>{{ _session_first_name or '' }}</span>
                            <a href="/settings" class="nav-link" title="הגדרות">
                                <i class="fas fa-cog"></i>
                                <span class="nav-text" style="display:inline-block">הגדרות</span>
                            </a>
                            <div class="fun-mode-menu">
                                <button
                                    type="button"
                                    class="fun-mode-toggle"
                                    onclick="toggleFunModeMenu(event)"
                                    aria-label="Fun Mode"
                                    title="Fun Mode"
                                >🪄</button>
                                <div class="fun-mode-dropdown" id="funModeDropdown" role="menu" aria-label="Fun Mode">
                                    <button type="button" class="fun-mode-item" role="menuitem" onclick="if (window.FunMode && typeof FunMode.startSynthwave === 'function') { FunMode.startSynthwave(); } else { alert('Fun Mode לא נטען'); } return false;" title="🎸 Synthwave" aria-label="Synthwave">🎸</button>
                                    <button type="button" class="fun-mode-item" role="menuitem" onclick="if (window.FunMode && typeof FunMode.startConfetti === 'function') { FunMode.startConfetti(); } else { alert('Fun Mode לא נטען'); } return false;" title="🎉 Confetti" aria-label="Confetti">🎉</button>
                                    <button type="button" class="fun-mode-item" role="menuitem" onclick="if (window.FunMode && typeof FunMode.startFireflies === 'function') { FunMode.startFireflies(); } else { alert('Fun Mode לא נטען'); } return false;" title="✨ Fireflies" aria-label="Fireflies">✨</button>
                                    <button type="button" class="fun-mode-item" role="menuitem" onclick="if (window.FunMode && typeof FunMode.startGravity === 'function') { FunMode.startGravity(); } else { alert('Fun Mode לא נטען'); } return false;" title="🧱 Gravity" aria-label="Gravity">🧱</button>
                                </div>
                            </div>
                        {% else %}
                            <a href="/login" class="btn btn-primary btn-icon">
                                <i class="fab fa-telegram"></i>
                                התחבר עם Telegram
                            </a>
                        {% endif %}
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    
    <div class="container" aria-hidden="false">
        <div id="announcementBanner" class="announcement-banner" role="status" aria-label="הכרזת מערכת" tabindex="-1" title="הכרזה" style="display:none;" aria-hidden="true">
            <span class="announcement-banner__icon" aria-hidden="true">📣</span>
            <div class="announcement-banner__scroller">
                <div class="announcement-banner__inner" id="announcementBannerInner" aria-live="polite">
                    <!-- content filled by JS -->
                </div>
            </div>
        </div>
    </div>

    <main class="main-content">
        <div class="container">
            {% block content %}{% endblock %}
        </div>
    </main>
    <!-- Modal: Add to Collection -->
    <div id="addToCollectionModal" style="display:none; position:fixed; inset:0; z-index:9999; align-items:center; justify-content:center;">
      <div onclick="closeAddToCollectionModal()" style="position:absolute; inset:0; background: rgba(0,0,0,0.5);"></div>
      <div style="position:relative; background:var(--solid-surface-bg, rgba(255,255,255,0.98)); color:var(--solid-surface-text, #111827); border-radius:12px; border: 1px solid var(--solid-surface-border, rgba(0,0,0,0.12)); box-shadow: var(--solid-surface-shadow, 0 14px 30px rgba(17, 23, 41, 0.16)); max-width:420px; width:90%; padding:1rem;">
        <h3 style="margin-top:0">הוסף לאוסף</h3>
        <div id="addToCollectionBody">
          <div>טוען…</div>
        </div>
        <div style="display:flex; gap:.5rem; justify-content:flex-end; margin-top:1rem;">
          <button class="btn btn-secondary" onclick="closeAddToCollectionModal()">בטל</button>
          <button class="btn btn-primary" onclick="confirmAddToCollection()">הוסף</button>
        </div>
      </div>
    </div>

{% if show_welcome_modal %}
<div id="welcomeModal" class="welcome-modal" role="dialog" aria-modal="true" aria-labelledby="welcomeModalTitle">
  <div class="welcome-modal__backdrop"></div>
  <div class="welcome-modal__content">
    <button type="button" class="welcome-modal__close" aria-label="סגור מודאל">
      <i class="fas fa-times"></i>
    </button>
    <h2 id="welcomeModalTitle">ברוכים הבאים ל-CodeKeeper WebApp! 👋</h2>
    <p>כדי להתחיל בקלות הכנו עבורך מדריך מפורט שיעשה סדר בכל האפשרויות.</p>
    <div class="welcome-modal__actions">
      <a id="welcomePrimaryCta"
         class="btn btn-primary btn-icon"
         href="{{ welcome_primary_guide_url }}"
         data-guide-url="{{ welcome_primary_guide_url }}">
        <i class="fas fa-book"></i>
        📘 מדריך תפעול WebApp
      </a>
      <button id="welcomeSkipBtn" type="button" class="btn btn-secondary btn-icon">
        <i class="fas fa-forward"></i>
        דלג לעכשיו
      </button>
    </div>
    <p class="welcome-modal__note">מומלץ לגלול לתחתית העמוד ולבחור בשמירת המדריך.</p>
  </div>
</div>
{% endif %}

<div id="themeWizard" class="theme-wizard" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="themeWizardTitle">
  <div class="theme-wizard__backdrop" data-theme-wizard-dismiss></div>
  <div class="theme-wizard__dialog">
    <button type="button" class="theme-wizard__close" data-action="close" aria-label="סגור ויזארד התאמה אישית">
      <i class="fas fa-times"></i>
    </button>
    <div class="theme-wizard__header">
      <p class="theme-wizard__eyebrow">התאמה אישית</p>
      <h2 id="themeWizardTitle" class="theme-wizard__title">איך תרצה שהממשק שלך ייראה?</h2>
      <p class="theme-wizard__subtitle">בחר ערכת נושא כדי לראות תצוגה חיה. אפשר לשנות בכל שלב גם ממסך ההגדרות.</p>
    </div>
    <div class="theme-wizard__options" role="list">
      <button type="button" class="theme-wizard-option" role="listitem" data-theme-option="nebula" aria-pressed="false">
        <span class="theme-wizard-option__emoji" aria-hidden="true">🌌</span>
        <span class="theme-wizard-option__name">Nebula</span>
        <span class="theme-wizard-option__desc">גוונים קוסמיים עמוקים עם ניגודיות עשירה.</span>
      </button>
      <button type="button" class="theme-wizard-option" role="listitem" data-theme-option="classic" aria-pressed="false">
        <span class="theme-wizard-option__emoji" aria-hidden="true">🏛️</span>
        <span class="theme-wizard-option__name">Classic</span>
        <span class="theme-wizard-option__desc">המראה המוכר והמאוזן של CodeKeeper.</span>
      </button>
      <button type="button" class="theme-wizard-option" role="listitem" data-theme-option="high-contrast" aria-pressed="false">
        <span class="theme-wizard-option__emoji" aria-hidden="true">⚫️</span>
        <span class="theme-wizard-option__name">High Contrast</span>
        <span class="theme-wizard-option__desc">ניגודיות גבוהה ונגישות משופרת.</span>
      </button>
    </div>
    <p class="theme-wizard__hint">
      לצפייה בכל ערכות הנושא הזמינות תמיד תוכל להיכנס דרך ממשק הגדרות ה-WebApp.
    </p>
    <div class="theme-wizard__actions">
      <button type="button" class="btn btn-primary" data-action="save">שמור והמשך</button>
      <button type="button" class="btn btn-secondary" data-action="skip">דלג</button>
    </div>
  </div>
</div>

<!-- Theme Picker Modal -->
<div id="themePickerModal" class="theme-picker-modal" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="themePickerTitle">
  <div class="theme-picker__backdrop" data-theme-picker-dismiss></div>
  <div class="theme-picker__dialog">
    <button type="button" class="theme-picker__close" data-action="close-picker" aria-label="סגור בוחר ערכות נושא">
      <i class="fas fa-times"></i>
    </button>
    
    <div class="theme-picker__header">
      <h2 id="themePickerTitle" class="theme-picker__title">
        <span class="theme-picker__icon">🎨</span>
        בחר ערכת נושא
      </h2>
      <p class="theme-picker__subtitle">בחר מתוך הערכות המובנות, הציבוריות או האישיות שלך</p>
    </div>
    
    <!-- Filter Tabs -->
    <div class="theme-picker__tabs" role="tablist">
      <button type="button" class="theme-picker__tab active" data-filter="all" role="tab" aria-selected="true">
        <i class="fas fa-th-large"></i> הכל
      </button>
      <button type="button" class="theme-picker__tab" data-filter="builtin" role="tab" aria-selected="false">
        <i class="fas fa-cube"></i> מובנות
      </button>
      <button type="button" class="theme-picker__tab" data-filter="shared" role="tab" aria-selected="false">
        <i class="fas fa-globe"></i> ציבוריות
      </button>
      <button type="button" class="theme-picker__tab" data-filter="custom" role="tab" aria-selected="false">
        <i class="fas fa-user"></i> אישיות
      </button>
    </div>
    
    <!-- Themes Grid -->
    <div class="theme-picker__grid" id="themePickerGrid" role="listbox" aria-label="רשימת ערכות נושא">
      <!-- Themes will be loaded dynamically -->
      <div class="theme-picker__loading">
        <i class="fas fa-spinner fa-spin"></i>
        <span>טוען ערכות...</span>
      </div>
    </div>
    
    <!-- Current Theme Indicator -->
    <div class="theme-picker__current">
      <span class="theme-picker__current-label">ערכה נוכחית:</span>
      <span class="theme-picker__current-name" id="currentThemeName">--</span>
    </div>
    
    <!-- Actions -->
    <div class="theme-picker__actions">
      <a href="/settings#appearance" class="btn btn-secondary btn-sm">
        <i class="fas fa-cog"></i> הגדרות מתקדמות
      </a>
      <button type="button" class="btn btn-outline-secondary btn-sm" data-action="close-picker">
        סגור
      </button>
    </div>
  </div>
</div>

    <script>
        function toggleMobileMenu() {
            const menu = document.getElementById('navMenu');
            menu.classList.toggle('active');
            if (menu.classList.contains('active')) {
                document.body.classList.add('nav-open');
            } else {
                document.body.classList.remove('nav-open');
            }
        }
        
        // סגירת תפריט הניווט בלחיצה מחוץ לו
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('navMenu');
            const toggle = document.querySelector('.mobile-menu-toggle');
            
            if (menu.classList.contains('active') && !menu.contains(event.target) && !toggle.contains(event.target)) {
                menu.classList.remove('active');
                document.body.classList.remove('nav-open');
            }
        });
        // --- תפריט קיצורי דרך ---
        function ensureQuickAccessVisible(dropdown) {
            if (!dropdown) return;
            const runner = () => {
                try {
                    const rect = dropdown.getBoundingClientRect();
                    const viewportHeight = window.innerHeight || document.documentElement.clientHeight || 0;
                    const viewportWidth = window.innerWidth || document.documentElement.clientWidth || 0;
                    const needScrollUp = rect.top < 12;
                    const needScrollDown = rect.bottom > (viewportHeight - 12);
                    const needVertical = needScrollUp || needScrollDown;
                    const needHorizontal = rect.left < 12 || rect.right > (viewportWidth - 12);

                    if (typeof dropdown.scrollIntoView === 'function' && (needVertical || needHorizontal)) {
                        dropdown.scrollIntoView({
                            behavior: 'smooth',
                            block: needScrollUp ? 'start' : (needScrollDown ? 'end' : 'nearest'),
                            inline: needHorizontal ? 'center' : 'nearest'
                        });
                        return;
                    }

                    if (needVertical) {
                        const delta = needScrollUp ? rect.top - 12 : rect.bottom - (viewportHeight - 12);
                        window.scrollBy({ top: delta, behavior: 'smooth' });
                    }
                } catch (e) {}
            };

            if (typeof window.requestAnimationFrame === 'function') {
                window.requestAnimationFrame(runner);
            } else {
                setTimeout(runner, 0);
            }
        }

        function toggleQuickAccess(ev) {
            try { ev && ev.stopPropagation && ev.stopPropagation(); } catch (e) {}
            const dropdown = document.getElementById('quickAccessDropdown');
            const toggle = document.querySelector('.quick-access-toggle');
            if (!dropdown || !toggle) return;
            dropdown.classList.toggle('active');
            toggle.classList.toggle('active');
            if (dropdown.classList.contains('active')) {
                try { dropdown.scrollTop = 0; } catch (e) {}
                ensureQuickAccessVisible(dropdown);
                const closer = function(event) {
                    try {
                        const menu = document.querySelector('.quick-access-menu');
                        if (!menu || !menu.contains(event.target)) {
                            dropdown.classList.remove('active');
                            toggle.classList.remove('active');
                            document.removeEventListener('click', closer);
                        }
                    } catch (e) {
                        document.removeEventListener('click', closer);
                    }
                };
                setTimeout(() => document.addEventListener('click', closer), 0);
            }
        }

        // --- Fun Mode menu (אנימציות) ---
        let __funModeMenuCloser = null;
        let __funModeMenuKeydown = null;

        function closeFunModeMenu() {
            const dropdown = document.getElementById('funModeDropdown');
            const toggle = document.querySelector('.fun-mode-toggle');
            if (!dropdown || !toggle) return;
            dropdown.classList.remove('active');
            toggle.classList.remove('active');
            try {
                if (__funModeMenuCloser) {
                    document.removeEventListener('click', __funModeMenuCloser);
                    __funModeMenuCloser = null;
                }
            } catch (e) { __funModeMenuCloser = null; }
            try {
                if (__funModeMenuKeydown) {
                    window.removeEventListener('keydown', __funModeMenuKeydown, true);
                    __funModeMenuKeydown = null;
                }
            } catch (e) { __funModeMenuKeydown = null; }
        }

        function toggleFunModeMenu(ev) {
            try { ev && ev.stopPropagation && ev.stopPropagation(); } catch (e) {}
            const dropdown = document.getElementById('funModeDropdown');
            const toggle = document.querySelector('.fun-mode-toggle');
            if (!dropdown || !toggle) return;

            const shouldOpen = !dropdown.classList.contains('active');
            closeFunModeMenu();
            if (!shouldOpen) return;

            dropdown.classList.add('active');
            toggle.classList.add('active');
            try { dropdown.scrollTop = 0; } catch (e) {}
            ensureQuickAccessVisible(dropdown);

            __funModeMenuCloser = function(event) {
                try {
                    const menu = document.querySelector('.fun-mode-menu');
                    if (!menu || !menu.contains(event.target)) {
                        closeFunModeMenu();
                    }
                } catch (e) {
                    closeFunModeMenu();
                }
            };

            __funModeMenuKeydown = function(e) {
                try {
                    if (e && e.key === 'Escape') {
                        closeFunModeMenu();
                    }
                } catch (_) {}
            };

            setTimeout(() => document.addEventListener('click', __funModeMenuCloser), 0);
            window.addEventListener('keydown', __funModeMenuKeydown, true);
        }

        function openGlobalSearch() {
            try {
                if (window.location.pathname === '/files') {
                    const input = document.getElementById('globalSearchInput');
                    if (input) {
                        input.focus();
                        try { input.scrollIntoView({ behavior: 'smooth', block: 'center' }); } catch (e) {}
                    }
                } else {
                    window.location.href = '/files?search=open#results';
                }
            } finally {
                try { toggleQuickAccess(); } catch (e) {}
            }
        }

        async function showRecentFiles() {
            let modal = null;
            try {
                // סגור את התפריט
                try { toggleQuickAccess(); } catch (e) {}
                modal = createRecentFilesModal();
                document.body.appendChild(modal);
                // טעינת קבצים אחרונים מה-API
                const resp = await fetch('/api/files/recent');
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                const files = await resp.json();
                displayRecentFiles(files, modal);
            } catch (err) {
                console.error('Error loading recent files:', err);
                alert('שגיאה בטעינת קבצים אחרונים');
                // הבטח שהמודאל לא יישאר תקוע במסך
                try { if (modal) modal.remove(); } catch (e) {}
            }
        }

        function createRecentFilesModal() {
            const modal = document.createElement('div');
            modal.className = 'recent-files-modal';
            modal.innerHTML = (
                '<div class="modal-backdrop" onclick="closeRecentFiles()"></div>' +
                '<div class="modal-content">' +
                '  <div class="modal-header">' +
                '    <h3>🕓 קבצים אחרונים</h3>' +
                '    <button class="modal-close" onclick="closeRecentFiles()"><i class="fas fa-times"></i></button>' +
                '  </div>' +
                '  <div class="modal-body" id="recentFilesList">' +
                '    <div class="loading" style="display:inline-block; margin: 0 auto;"></div> טוען...' +
                '  </div>' +
                '</div>'
            );
            return modal;
        }

        // --- Community chooser modal ---
        function openCommunityChooser(ev){
            try { if (ev && ev.preventDefault) ev.preventDefault(); } catch(_){ }
            // Guard: avoid stacking multiple identical modals
            if (document.querySelector('.community-modal')) {
                return;
            }
            const modal = document.createElement('div');
            modal.className = 'community-modal';
            modal.innerHTML = (
                '<div class="modal-backdrop" onclick="closeCommunityChooser()"></div>'+
                '<div class="modal-content">'+
                '  <div class="modal-header">'+
                '    <h3>אוספי הקהילה</h3>'+
                '    <button class="modal-close" onclick="closeCommunityChooser()"><i class="fas fa-times"></i></button>'+
                '  </div>'+
                '  <div class="modal-body" style="display:flex; flex-direction:column; gap:12px;">'+
                '    <a href="/community-library" class="btn btn-secondary btn-icon" style="width:100%; justify-content:flex-start; gap:.75rem;">'+
                '      <span style="font-size:1.2rem;">📳</span>'+
                '      <span>ממשקי משתמשים</span>'+
                '    </a>'+
                '    <a href="/snippets" class="btn btn-secondary btn-icon" style="width:100%; justify-content:flex-start; gap:.75rem;">'+
                '      <span style="font-size:1.2rem;">📃</span>'+
                '      <span>ספריית סניפטים</span>'+
                '    </a>'+
                '  </div>'+
                '</div>'
            );
            document.body.appendChild(modal);
        }
        function closeCommunityChooser(){
            try { const modal = document.querySelector('.community-modal'); if (modal) modal.remove(); } catch(_){ }
        }

        function displayRecentFiles(files, modal) {
            const listContainer = modal.querySelector('#recentFilesList');
            if (!Array.isArray(files) || files.length === 0) {
                listContainer.innerHTML = '<div class="no-files">אין פריטים להצגה</div>';
                return;
            }
            const html = files.slice(0, 10).map(file => (
                '<a href="/file/' + String(file.id || '').replace(/"/g, '') + '" class="recent-file-item">' +
                '  <div class="file-icon">' + getFileIcon(String(file.language || 'text').toLowerCase()) + '</div>' +
                '  <div class="file-info">' +
                '    <div class="file-name">' + escapeHtml(file.filename || '') + '</div>' +
                '    <div class="file-meta">' +
                '      <span>' + formatDate(file.accessed_at) + '</span>' +
                '    </div>' +
                '  </div>' +
                '</a>'
            )).join('');
            listContainer.innerHTML = html;
        }

        function closeRecentFiles() {
            const modal = document.querySelector('.recent-files-modal');
            if (modal) modal.remove();
        }

        async function navigateToWorkspace() {
            try {
                const res = await fetch('/api/collections?limit=100');
                if (!res.ok) {
                    throw new Error('HTTP ' + res.status);
                }
                const data = await res.json();
                if (!data || !data.ok) {
                    throw new Error((data && data.error) || 'שגיאה בטעינת אוספים');
                }
                const collections = Array.isArray(data.collections) ? data.collections : [];
                const workspace = collections.find(c => c && c.name === 'שולחן עבודה');
                if (workspace && workspace.id) {
                    const target = encodeURIComponent(String(workspace.id));
                    window.location.href = `/collections/${target}`;
                    return;
                }
                alert('אוסף שולחן עבודה לא נמצא');
            } catch (err) {
                console.error('Error navigating to workspace:', err);
                alert('שגיאה בטעינת שולחן העבודה');
            }
        }

        function getFileIcon(language) {
            const icons = {
                'python': '🐍',
                'javascript': '📜',
                'typescript': '📜',
                'html': '🌐',
                'css': '🎨',
                'json': '📋',
                'markdown': '📝',
                'text': '📄'
            };
            return icons[language] || '📄';
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = String(str || '');
            return div.innerHTML;
        }

        function formatDate(dateString) {
            try {
                if (!dateString) return '';
                const date = new Date(dateString);
                const now = new Date();
                const diff = now - date;
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(diff / 3600000);
                const days = Math.floor(diff / 86400000);
                if (minutes < 1) return 'כרגע';
                if (minutes < 60) return `לפני ${minutes} דקות`;
                if (hours < 24) return `לפני ${hours} שעות`;
                return `לפני ${days} ימים`;
            } catch (e) { return ''; }
        }

        // פוקוס אוטומטי על חיפוש גלובלי אם הגיעו עם פרמטר מתאים
        document.addEventListener('DOMContentLoaded', function() {
            try {
                const params = new URLSearchParams(window.location.search);
                if (params.get('search') === 'open' && document.getElementById('globalSearchInput')) {
                    document.getElementById('globalSearchInput').focus();
                }
                // Detect Font Awesome failure and add 'no-fa-icons' class
                try {
                    const hasFAHint = !!(
                        window.FontAwesome ||
                        document.querySelector('link[href*="font-awesome"], link[href*="fontawesome"], link[href*="all.min.css"], style[data-fa]')
                    );
                    // Create a real FA icon and inspect computed font-family and ::before content
                    const probe = document.createElement('i');
                    probe.className = 'fas fa-check';
                    probe.style.position = 'absolute';
                    probe.style.left = '-9999px';
                    document.body.appendChild(probe);
                    const cs = getComputedStyle(probe, '::before');
                    const family = (getComputedStyle(probe).fontFamily || '').toLowerCase();
                    const content = cs && (cs.getPropertyValue('content') || '');
                    const looksLikeFA = (family.includes('font awesome') || family.includes('fontawesome')) && content && content !== 'none' && content !== 'normal' && content !== '""';
                    const ok = hasFAHint && looksLikeFA;
                    document.body.classList.toggle('no-fa-icons', !ok);
                    probe.remove();
                } catch (_) {
                    document.body.classList.add('no-fa-icons');
                }
            } catch (e) {}
        });

        // Add to Collection modal helpers
        function getLastCollectionId(){ try { return localStorage.getItem('last_collection_id') || ''; } catch(_) { return ''; } }
        function setLastCollectionId(id){ try { localStorage.setItem('last_collection_id', String(id||'')); } catch(_) {} }
        function renderCollectionOptions(collections, lastSelected){
            const list = Array.isArray(collections) ? collections : [];
            const lastIdStr = String(lastSelected || '').trim();
            const hasLast = lastIdStr && list.some(c => c && c.id !== undefined && String(c.id) === lastIdStr);
            const workspace = list.find(c => c && c.name === 'שולחן עבודה' && c.id);
            const others = list.filter(c => c && c.name !== 'שולחן עבודה' && c.id);

            let selected = hasLast ? lastIdStr : '';
            if (!selected && workspace && workspace.id) {
                selected = String(workspace.id);
            }

            let html = '';
            if (workspace && workspace.id) {
                const isSelected = selected === String(workspace.id);
                html += `<label class="collection-option workspace-collection-option"><input type="radio" name="collectionId" value="${workspace.id}" ${isSelected ? 'checked' : ''}><span>🖥️ ${escapeHtml(workspace.name || '')}</span></label>`;
                if (others.length > 0) {
                    html += '<div class="collection-option-divider">אוספים אחרים:</div>';
                }
            }

            html += others.map(col => {
                if (!col || col.id === undefined) {
                    return '';
                }
                const isSelected = selected === String(col.id);
                return `<label class="collection-option"><input type="radio" name="collectionId" value="${col.id}" ${isSelected ? 'checked' : ''}><span>${escapeHtml(col.name || '')}</span></label>`;
            }).join('');

            if (!html) {
                return '<div class="empty">אין אוספים. צור אוסף חדש במסך "האוספים שלי"</div>';
            }
            return html;
        }
        window.openAddToCollectionModal = async function(fileName){
            const modal = document.getElementById('addToCollectionModal');
            const body = document.getElementById('addToCollectionBody');
            modal.style.display = 'flex';
            // נקה מצב "bulk" ישן כדי שלא יזלוג לפתיחה של קובץ יחיד
            modal.removeAttribute('data-file-names');
            modal.setAttribute('data-file-name', String(fileName||''));
            try {
              const res = await fetch('/api/collections');
              const data = await res.json();
              if (!data || !data.ok) throw new Error(data && data.error || 'שגיאה');
              const last = getLastCollectionId();
              body.innerHTML = renderCollectionOptions(data.collections, last);
            } catch (e) {
              body.innerHTML = '<div class="error">שגיאה בטעינת אוספים</div>';
            }
        }
        // גרסה לבאלק: fileNames=Array<string>
        window.openBulkAddToCollectionModal = async function(fileNames){
            const modal = document.getElementById('addToCollectionModal');
            const body = document.getElementById('addToCollectionBody');
            modal.style.display = 'flex';
            modal.removeAttribute('data-file-name');
            modal.setAttribute('data-file-names', JSON.stringify(Array.isArray(fileNames)?fileNames:[]));
            try {
              const res = await fetch('/api/collections');
              const data = await res.json();
              if (!data || !data.ok) throw new Error(data && data.error || 'שגיאה');
              const last = getLastCollectionId();
              body.innerHTML = renderCollectionOptions(data.collections, last);
            } catch (e) {
              body.innerHTML = '<div class="error">שגיאה בטעינת אוספים</div>';
            }
        }
        window.closeAddToCollectionModal = function(){
            const modal = document.getElementById('addToCollectionModal');
            modal.style.display = 'none';
            modal.removeAttribute('data-file-name');
            modal.removeAttribute('data-file-names');
        }
        window.confirmAddToCollection = async function(){
            const modal = document.getElementById('addToCollectionModal');
            const fileName = modal.getAttribute('data-file-name') || '';
            const bulkNamesRaw = modal.getAttribute('data-file-names') || '';
            const sel = document.querySelector('#addToCollectionBody input[name="collectionId"]:checked');
            if (!sel) { alert('בחר אוסף'); return; }
            const cid = sel.value;
            try {
              let items = [];
              if (bulkNamesRaw) {
                try { const arr = JSON.parse(bulkNamesRaw) || []; items = arr.filter(Boolean).map(n => ({source:'regular', file_name: String(n)})); } catch(_){ items = []; }
              } else if (fileName) {
                items = [{source:'regular', file_name: String(fileName)}];
              }
              if (!items.length) { alert('לא נבחרו קבצים להוספה'); return; }
              const r = await fetch(`/api/collections/${encodeURIComponent(cid)}/items`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({items}) });
              const data = await r.json();
              if (!r.ok || !data.ok) throw new Error(data && data.error || 'שגיאה');
              alert(items.length > 1 ? ('נוספו ' + items.length + ' קבצים לאוסף') : 'נוסף לאוסף בהצלחה');
              try { setLastCollectionId(cid); } catch(_) {}
              try { window.CollectionsUI && CollectionsUI.refreshSidebar && CollectionsUI.refreshSidebar(); } catch(_){ }
              closeAddToCollectionModal();
            } catch (e) {
              alert('שגיאה בהוספה לאוסף');
            }
        }
        function escapeHtml(s){ const d=document.createElement('div'); d.textContent=String(s||''); return d.innerHTML; }
    </script>
    
    {% if uptime_widget_id and uptime_widget_script_url %}
    <script src="{{ uptime_widget_script_url }}" data-id="{{ uptime_widget_id }}" async></script>
    {% endif %}
    <script>
        // Work State persistence: שמירת URL וגלילה לשחזור מצב עבודה
        (function workStatePersistence(){
            const STORAGE_KEY = 'work_state';
            function loadState(){ try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); } catch(_) { return {}; } }
            function saveState(s){ try { localStorage.setItem(STORAGE_KEY, JSON.stringify(s || {})); } catch(_) {} }
            function buildState(){
                return {
                    last_url: window.location.pathname + window.location.search + window.location.hash,
                    scroll_y: Math.max(0, Math.round(window.scrollY || window.pageYOffset || 0)),
                    timestamp: new Date().toISOString(),
                };
            }
            function postServer(s){
                try {
                    // זיהוי התחברות מהשרת (Cookie הסשן הוא HttpOnly ולכן לא זמין ל-JS)
                    const isAuth = {% if _session_user_id %}true{% else %}false{% endif %};
                    if (!isAuth) return;
                    fetch('/api/ui_prefs', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ work_state: s }) }).catch(()=>{});
                } catch(_) {}
            }
            function persistNow(){ const s = buildState(); saveState(s); /* שליחה לשרת תוגבל ע"י מצבר זמן */ tryThrottlePost(s); }
            let lastSent = 0, t;
            function tryThrottlePost(s){
                const now = Date.now();
                if (now - lastSent > 3000) { lastSent = now; postServer(s); }
            }
            function schedulePersist(){
                clearTimeout(t);
                t = setTimeout(() => { const s = buildState(); saveState(s); tryThrottlePost(s); }, 200);
            }

            // Restore only on reload/back-forward or generic entry (/, /dashboard) without intent, once per tab
            try {
                const nav = (performance && performance.getEntriesByType) ? (performance.getEntriesByType('navigation')[0] || null) : null;
                const navType = (nav && nav.type) || '';
                const hasRef = !!document.referrer;
                let sameOriginRef = false;
                try { sameOriginRef = hasRef && (new URL(document.referrer)).origin === window.location.origin; } catch(_) { sameOriginRef = false; }
                const params = new URLSearchParams(window.location.search || '');
                const isShortcutIntent = (params.get('entry') === 'shortcut') || (params.get('no_restore') === '1');
                const isReloadOrBack = (navType === 'reload' || navType === 'back_forward');
                const isExternalEntry = !sameOriginRef;
                const isGenericEntry = (
                    window.location.pathname === '/' ||
                    (window.location.pathname === '/dashboard' && (!window.location.search || window.location.search === '') && (!window.location.hash || window.location.hash === '' || window.location.hash === '#'))
                );
                const allowRestoreCandidate = !sessionStorage.getItem('ws_restored');
                const allowRestore = allowRestoreCandidate && !isShortcutIntent && (
                    isReloadOrBack ||
                    (isExternalEntry && isGenericEntry)
                );
                const st = loadState();
                const current = window.location.pathname + window.location.search + window.location.hash;
                if (allowRestore && st && typeof st.last_url === 'string' && st.last_url.startsWith('/') && st.last_url !== current) {
                    // שחזור אגרסיבי רק בריענון/חזרה או כניסה חיצונית – לא בניווט פנימי
                    sessionStorage.setItem('ws_restored', '1');
                    window.location.replace(st.last_url);
                    return;
                }
                if (st && typeof st.scroll_y === 'number' && st.scroll_y > 0) {
                    window.requestAnimationFrame(() => { try { window.scrollTo({ top: st.scroll_y, behavior: 'instant' }); } catch(_) { window.scrollTo(0, st.scroll_y); } });
                }
            } catch(_) {}

            window.addEventListener('scroll', schedulePersist, { passive: true });
            window.addEventListener('popstate', schedulePersist);
            window.addEventListener('hashchange', schedulePersist);
            window.addEventListener('pagehide', persistNow);
            window.addEventListener('beforeunload', persistNow);
            document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'hidden') persistNow(); });
            document.addEventListener('click', (e) => {
                try {
                    const a = e.target.closest('a[href]');
                    if (!a) return;
                    const href = a.getAttribute('href') || '';
                    if (href.startsWith('/')) { persistNow(); }
                } catch(_) {}
            });
        })();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js" defer></script>
    <script src="{{ url_for('static', filename='js/fun-mode.js') }}?v={{ static_version }}" defer></script>
    <script src="{{ url_for('static', filename='js/utils/animations.js') }}?v={{ static_version }}" defer></script>
    <script src="{{ url_for('static', filename='js/global_search.js') }}?v={{ static_version }}" defer></script>
    <script src="{{ url_for('static', filename='js/dark-mode.js') }}?v={{ static_version }}" defer></script>
    <script src="{{ url_for('static', filename='js/smooth-scroll.js') }}?v={{ static_version }}" defer></script>
    <script type="module" src="{{ url_for('static', filename='js/editor-manager.js') }}?v={{ static_version }}" defer></script>
    <script src="{{ url_for('static', filename='js/collections.js') }}?v={{ static_version }}" defer></script>
    <script>
    (function bootstrapModalPolyfill(){
        if (window.__ck_bootstrap_modal_polyfill) return;
        window.__ck_bootstrap_modal_polyfill = true;

        function closeModal(modalEl) {
            if (!modalEl) return;
            try { modalEl.classList.remove('show'); } catch (_) {}
            try { modalEl.style.display = 'none'; } catch (_) {}
            try { modalEl.setAttribute('aria-hidden', 'true'); } catch (_) {}
            try { document.body.classList.remove('modal-open'); } catch (_) {}
        }

        function openModal(modalEl) {
            if (!modalEl) return;
            try { modalEl.style.display = 'block'; } catch (_) {}
            try { modalEl.classList.add('show'); } catch (_) {}
            try { modalEl.removeAttribute('aria-hidden'); } catch (_) {}
            try { modalEl.setAttribute('aria-modal', 'true'); } catch (_) {}
            try { modalEl.setAttribute('role', 'dialog'); } catch (_) {}
            try { document.body.classList.add('modal-open'); } catch (_) {}
        }

        function ensureClosedByDefault(modalEl) {
            if (!modalEl) return;
            // Make sure server-rendered modals don't appear as "cards"
            closeModal(modalEl);
        }

        // Minimal bootstrap.Modal API used by compare.js and code-tools.js
        window.bootstrap = window.bootstrap || {};
        
        // Modal constructor function
        function ModalPolyfill(el) {
            this.element = el;
            this.show = function() { openModal(el); };
            this.hide = function() { closeModal(el); };
        }
        
        // If bootstrap.Modal is not a constructor function, create our polyfill
        if (typeof window.bootstrap.Modal !== 'function') {
            window.bootstrap.Modal = ModalPolyfill;
        }
        
        if (typeof window.bootstrap.Modal.getInstance !== 'function') {
            window.bootstrap.Modal.getInstance = function(el){
                return new ModalPolyfill(el);
            };
        }

        // Public helpers (useful for debugging)
        window.__ck_modal = {
            open: (selector) => openModal(document.querySelector(selector)),
            close: (selector) => closeModal(document.querySelector(selector)),
        };

        // Close common modals by default if they exist
        document.addEventListener('DOMContentLoaded', function(){
            try { ensureClosedByDefault(document.getElementById('restoreModal')); } catch (_) {}
            try { ensureClosedByDefault(document.getElementById('codeToolsModal')); } catch (_) {}
        });

        document.addEventListener('click', function(e){
            try {
                const opener = e.target.closest('[data-bs-toggle="modal"][data-bs-target]');
                if (opener) {
                    e.preventDefault();
                    const sel = opener.getAttribute('data-bs-target');
                    if (sel) openModal(document.querySelector(sel));
                    return;
                }

                const dismiss = e.target.closest('[data-bs-dismiss="modal"]');
                if (dismiss) {
                    e.preventDefault();
                    closeModal(dismiss.closest('.modal'));
                    return;
                }

                // Click outside dialog closes
                const modalEl = e.target.classList && e.target.classList.contains('modal') ? e.target : null;
                if (modalEl && modalEl.classList.contains('show')) {
                    closeModal(modalEl);
                }
            } catch (_) {}
        }, true);

        document.addEventListener('keydown', function(e){
            try {
                if (e.key !== 'Escape') return;
                const openEl = document.querySelector('.modal.show');
                if (openEl) closeModal(openEl);
            } catch (_) {}
        });
    })();
    </script>
<script>
    (function welcomeModalInit(){
        const modal = document.getElementById('welcomeModal');
        if (!modal) { return; }
        const backdrop = modal.querySelector('.welcome-modal__backdrop');
        const closeBtn = modal.querySelector('.welcome-modal__close');
        const skipBtn = document.getElementById('welcomeSkipBtn');
        const primaryBtn = document.getElementById('welcomePrimaryCta');
        const sendAck = () => {
            try {
                fetch('/api/welcome/ack', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: '{}'
                }).catch(() => {});
            } catch (_) {}
        };
        const removeModal = () => {
            modal.classList.remove('active');
            setTimeout(() => {
                try { modal.remove(); } catch (_) {}
            }, 250);
        };
        const dismiss = (targetUrl) => {
            sendAck();
            removeModal();
            if (targetUrl) {
                window.location.href = targetUrl;
            }
        };
        modal.classList.add('active');
        const bind = (el, handler) => { if (el) { el.addEventListener('click', handler); } };
        bind(backdrop, () => dismiss());
        bind(closeBtn, () => dismiss());
        bind(skipBtn, () => dismiss());
        bind(primaryBtn, (event) => {
            event.preventDefault();
            const href = primaryBtn.getAttribute('href') || primaryBtn.dataset.guideUrl || '';
            dismiss(href);
        });
    })();
</script>

<script>
(function initThemeRipple(){
    if (window.applyThemeChangeWithRipple) { return; }

    const RIPPLE_DURATION_MS = 700;
    const FADE_OUT_MS = 120;

    // צבע רקע למסכה לפי ערכת נושא (מותאם לצבעי ה-bg-primary במערכת)
    const THEME_BACKGROUND_COLORS = {
        'classic': '#6b63ff',
        'ocean': '#1a365d',
        'rose-pine-dawn': '#faf4ed',
        'dark': '#1a1a1a',
        'dim': '#2a2a2a',
        'nebula': '#151a2c',
        'high-contrast': '#000000',
        'custom': '#6b63ff'
    };

    const ALLOWED_UI_THEMES = new Set(Object.keys(THEME_BACKGROUND_COLORS));
    let _timers = [];

    function clearTimers(){
        while (_timers.length) {
            try { clearTimeout(_timers.pop()); } catch (_) {}
        }
    }

    function prefersReducedMotion(){
        try {
            return !!(window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches);
        } catch (_) {
            return false;
        }
    }

    function sanitizeTheme(theme){
        const t = (theme || '').toString().trim().toLowerCase();
        if (ALLOWED_UI_THEMES.has(t)) {
            return t;
        }
        return 'classic';
    }

    function resolvePoint(triggerElement){
        let x = Math.round((window.innerWidth || 0) / 2);
        let y = Math.round((window.innerHeight || 0) / 2);
        try {
            if (triggerElement && typeof triggerElement.getBoundingClientRect === 'function') {
                const rect = triggerElement.getBoundingClientRect();
                x = Math.round(rect.left + rect.width / 2);
                y = Math.round(rect.top + rect.height / 2);
            }
        } catch (_) {}
        return { x, y };
    }

    function applyThemeChangeWithRipple(newTheme, triggerElement, applyThemeFn){
        const theme = sanitizeTheme(newTheme);
        const root = document.documentElement;
        const apply = (typeof applyThemeFn === 'function')
            ? applyThemeFn
            : (t) => { try { root.setAttribute('data-theme', t); } catch (_) {} };

        if (prefersReducedMotion()) {
            apply(theme);
            return;
        }

        const mask = document.getElementById('theme-mask');
        if (!mask) {
            apply(theme);
            return;
        }

        clearTimers();

        const pt = resolvePoint(triggerElement);
        try {
            root.style.setProperty('--toggle-x', `${pt.x}px`);
            root.style.setProperty('--toggle-y', `${pt.y}px`);
            root.style.setProperty('--ripple-radius', '150vmax');
        } catch (_) {}

        try {
            mask.style.background = THEME_BACKGROUND_COLORS[theme] || '#000000';
        } catch (_) {}

        // איפוס מצב קודם (בלי "כיווץ" מורגש)
        try {
            mask.classList.remove('active');
            mask.style.opacity = '0';
            // Force reflow כדי שהמעבר הבא יתחיל נקי
            void mask.offsetWidth;
            mask.style.opacity = '';
        } catch (_) {}

        // התחלת ripple
        try { mask.classList.add('active'); } catch (_) {}

        _timers.push(setTimeout(() => {
            try { apply(theme); } catch (_) {}
            // Fade-out כשהמסכה עדיין מלאה, כדי לא להציג "חזרה אחורה"
            try { mask.style.opacity = '0'; } catch (_) {}
            _timers.push(setTimeout(() => {
                try { mask.classList.remove('active'); } catch (_) {}
                try { mask.style.opacity = '0'; } catch (_) {}
            }, FADE_OUT_MS + 20));
        }, RIPPLE_DURATION_MS));
    }

    window.applyThemeChangeWithRipple = applyThemeChangeWithRipple;
    window.__ckThemeRipple = {
        durationMs: RIPPLE_DURATION_MS,
        allowedThemes: Array.from(ALLOWED_UI_THEMES),
        cancel: () => {
            try { clearTimers(); } catch (_) {}
            try {
                const mask = document.getElementById('theme-mask');
                if (mask) {
                    mask.classList.remove('active');
                    mask.style.opacity = '0';
                }
            } catch (_) {}
        }
    };
})();
</script>

<script>
// מנגנון נעילה קטן כדי למנוע חפיפה בין שכבות Onboarding שונות (Tour / Theme Wizard)
(function initOnboardingLock(){
    if (window.__ckOnboarding) { return; }
    let active = null;
    window.__ckOnboarding = {
        getActive: () => active,
        acquire: (name) => {
            if (active && active !== name) { return false; }
            active = name;
            return true;
        },
        release: (name) => {
            if (active === name) { active = null; }
        }
    };
})();
</script>

<script>
(function initThemeWizard(){
    const wizardEl = document.getElementById('themeWizard');
    const htmlEl = document.documentElement;
    const bodyEl = document.body;
    const isLoggedIn = {{ 'true' if _session_user_id else 'false' }};
    const serverHasSeen = {{ 'true' if onboarding_theme_wizard_seen else 'false' }};
    const serverThemePrefSet = {{ 'true' if ui_theme_pref_set else 'false' }};
    const ALLOWED_PATHS = ['/files'];
    const STORAGE_KEYS = {
        seen: 'theme_wizard_seen',
        userTheme: 'user_theme',
        preference: 'dark_mode_preference'
    };
    const state = {
        isOpen: false,
        initialTheme: null,
        selectedTheme: null,
        focusBeforeOpen: null,
        fallbackTimer: null,
        tourActive: false
    };

    function createFallbackApi(){
        return {
            open: () => false,
            maybeOpen: () => false,
            watchDriver: () => {},
            hasSeen: () => true,
            resetSeen: () => {},
            scheduleFallback: () => {}
        };
    }

    if (!wizardEl) {
        window.ThemeWizard = createFallbackApi();
        return;
    }

    const optionButtons = Array.from(wizardEl.querySelectorAll('[data-theme-option]'));
    const overlayEl = wizardEl.querySelector('[data-theme-wizard-dismiss]');
    const saveBtn = wizardEl.querySelector('[data-action="save"]');
    const skipBtn = wizardEl.querySelector('[data-action="skip"]');
    const closeBtn = wizardEl.querySelector('[data-action="close"]');

    function lsGet(key){
        try { return localStorage.getItem(key); }
        catch (_) { return null; }
    }
    function lsSet(key, value){
        try { localStorage.setItem(key, value); }
        catch (_) {}
    }
    function hasSeen(){
        if (serverHasSeen) {
            return true;
        }
        const v = lsGet(STORAGE_KEYS.seen);
        return v === 'true' || v === '1' || v === 'yes';
    }
    function persistSeenToServer(){
        if (!isLoggedIn) { return; }
        try {
            fetch('/api/ui_prefs', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ onboarding: { theme_wizard_seen: true } })
            }).catch(() => {});
        } catch (_) { /* ignore */ }
    }
    function markSeen(){
        lsSet(STORAGE_KEYS.seen, 'true');
        persistSeenToServer();
    }
    function resetSeen(){
        try { localStorage.removeItem(STORAGE_KEYS.seen); }
        catch (_) {}
    }
    function availableThemes(){
        return optionButtons.map((btn) => btn.dataset.themeOption).filter(Boolean);
    }
    function defaultTheme(){
        const themes = availableThemes();
        if (themes.includes('classic')) {
            return 'classic';
        }
        return themes[0] || 'classic';
    }
    function sanitizeTheme(theme){
        const themes = availableThemes();
        if (theme && themes.includes(theme)) {
            return theme;
        }
        return defaultTheme();
    }
    function previewTheme(theme){
        if (!theme) { return; }
        htmlEl.setAttribute('data-theme', theme);
    }
    function mapDarkModePreference(theme){
        if (theme === 'dark' || theme === 'dim') {
            return theme;
        }
        if (theme === 'classic') {
            return 'light';
        }
        return null;
    }
    function persistTheme(theme){
        if (!theme) { return; }
        lsSet(STORAGE_KEYS.userTheme, theme);
        const darkModePref = mapDarkModePreference(theme);
        if (darkModePref) {
            lsSet(STORAGE_KEYS.preference, darkModePref);
        } else {
            try { localStorage.removeItem(STORAGE_KEYS.preference); }
            catch (_) {}
        }
        try {
            fetch('/api/ui_prefs', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ theme })
            }).catch(() => {});
        } catch (_) { /* ignore */ }
    }
    function shouldAutoShow(){
        if (!isLoggedIn || hasSeen()) {
            return false;
        }
        if (serverThemePrefSet) {
            // אם למשתמש כבר יש Theme ב-DB, אין סיבה לפתוח ויזארד התאמה אישית מחדש
            return false;
        }
        const path = (window.location && window.location.pathname) || '';
        return ALLOWED_PATHS.includes(path);
    }
    function setActiveChoice(theme){
        const choice = sanitizeTheme(theme);
        state.selectedTheme = choice;
        optionButtons.forEach((btn) => {
            const match = btn.dataset.themeOption === choice;
            btn.classList.toggle('is-active', match);
            btn.setAttribute('aria-pressed', String(match));
        });
    }
    function revertPreview(){
        previewTheme(state.selectedTheme || state.initialTheme || defaultTheme());
    }
    function handleKeydown(event){
        if (!state.isOpen) { return; }
        if (event.key === 'Escape') {
            event.preventDefault();
            closeWizard({ persist: false });
            return;
        }
        if (event.key !== 'Tab') {
            return;
        }
        const focusable = wizardEl.querySelectorAll('button, [href], [tabindex]:not([tabindex="-1"])');
        if (!focusable.length) { return; }
        const first = focusable[0];
        const last = focusable[focusable.length - 1];
        if (event.shiftKey) {
            if (document.activeElement === first) {
                event.preventDefault();
                last.focus();
            }
        } else if (document.activeElement === last) {
            event.preventDefault();
            first.focus();
        }
    }
    function isWelcomeBlocking(){
        const modal = document.getElementById('welcomeModal');
        return !!(modal && document.body.contains(modal));
    }
    function waitForWelcome(callback){
        if (!isWelcomeBlocking()) {
            callback();
            return;
        }
        const observer = new MutationObserver(() => {
            if (!isWelcomeBlocking()) {
                observer.disconnect();
                setTimeout(callback, 220);
            }
        });
        observer.observe(document.body, { childList: true, subtree: true });
    }
    function clearFallback(){
        if (state.fallbackTimer) {
            clearTimeout(state.fallbackTimer);
            state.fallbackTimer = null;
        }
    }
    function openWizard(reason, opts = {}){
        if (state.isOpen) { return true; }
        if (!opts.force && !shouldAutoShow()) {
            return false;
        }
        if (state.tourActive) {
            return false;
        }
        try {
            if (window.__ckOnboarding && typeof window.__ckOnboarding.acquire === 'function') {
                if (!window.__ckOnboarding.acquire('theme_wizard')) {
                    return false;
                }
            }
        } catch (_) { /* ignore */ }
        clearFallback();
        state.focusBeforeOpen = document.activeElement;
        state.initialTheme = htmlEl.getAttribute('data-theme') || defaultTheme();
        const storedChoice = lsGet(STORAGE_KEYS.userTheme) || lsGet(STORAGE_KEYS.preference) || state.initialTheme;
        setActiveChoice(storedChoice);
        previewTheme(state.selectedTheme);
        wizardEl.dataset.reason = reason || '';
        wizardEl.classList.add('is-open');
        wizardEl.setAttribute('aria-hidden', 'false');
        bodyEl.classList.add('theme-wizard-open');
        state.isOpen = true;
        document.addEventListener('keydown', handleKeydown, true);
        requestAnimationFrame(() => {
            const focusTarget = wizardEl.querySelector('.theme-wizard-option.is-active') || wizardEl.querySelector('.theme-wizard-option');
            if (focusTarget) {
                try { focusTarget.focus(); } catch (_) {}
            }
        });
        return true;
    }
    function closeWizard({ persist } = {}){
        if (!state.isOpen) { return; }
        wizardEl.classList.remove('is-open');
        wizardEl.setAttribute('aria-hidden', 'true');
        bodyEl.classList.remove('theme-wizard-open');
        document.removeEventListener('keydown', handleKeydown, true);
        // אם המשתמש סגר בלי לשמור – בטל ripple ממתין כדי שלא ידרוס את הרברט
        if (!persist) {
            try {
                if (window.__ckThemeRipple && typeof window.__ckThemeRipple.cancel === 'function') {
                    window.__ckThemeRipple.cancel();
                }
            } catch (_) { /* ignore */ }
        }
        if (persist && state.selectedTheme) {
            persistTheme(state.selectedTheme);
        } else {
            previewTheme(state.initialTheme || defaultTheme());
        }
        markSeen();
        state.isOpen = false;
        try {
            if (window.__ckOnboarding && typeof window.__ckOnboarding.release === 'function') {
                window.__ckOnboarding.release('theme_wizard');
            }
        } catch (_) { /* ignore */ }
        try {
            if (state.focusBeforeOpen && typeof state.focusBeforeOpen.focus === 'function') {
                state.focusBeforeOpen.focus();
            }
        } catch (_) { /* ignore */ }
        state.focusBeforeOpen = null;
    }
    function maybeOpen(reason, opts = {}){
        if (state.isOpen) {
            return false;
        }
        if (state.tourActive) {
            return false;
        }
        const forced = !!opts.force;
        if (!forced && hasSeen()) {
            return false;
        }
        if (!forced && !shouldAutoShow()) {
            return false;
        }
        waitForWelcome(() => { openWizard(reason, { force: true }); });
        return true;
    }
    function scheduleFallback(){
        if (!shouldAutoShow() || state.fallbackTimer || state.tourActive) {
            return;
        }
        state.fallbackTimer = setTimeout(() => {
            state.fallbackTimer = null;
            maybeOpen('fallback');
        }, 9000);
    }
    function watchDriver(driver){
        if (!driver) {
            return;
        }
        // אם הסיור רץ, לא מפעילים fallback של הוויזארד (מונע חפיפה)
        clearFallback();
        state.tourActive = true;
        const handler = () => {
            try {
                if (typeof driver.off === 'function') {
                    driver.off('destroyed', handler);
                }
            } catch (_) { /* ignore */ }
            state.tourActive = false;
            maybeOpen('tour-finished');
        };
        if (typeof driver.on === 'function') {
            try {
                driver.on('destroyed', handler);
            } catch (_) {
                setTimeout(() => handler(), 400);
            }
            return;
        }
        setTimeout(() => handler(), 400);
    }

    optionButtons.forEach((btn) => {
        const theme = btn.dataset.themeOption;
        if (!theme) { return; }
        btn.addEventListener('mouseenter', () => { if (state.isOpen) { previewTheme(theme); } });
        btn.addEventListener('focus', () => { if (state.isOpen) { previewTheme(theme); } });
        btn.addEventListener('mouseleave', () => { if (state.isOpen) { revertPreview(); } });
        btn.addEventListener('blur', () => { if (state.isOpen) { revertPreview(); } });
        btn.addEventListener('click', () => {
            setActiveChoice(theme);
            if (typeof window.applyThemeChangeWithRipple === 'function') {
                window.applyThemeChangeWithRipple(theme, btn, (t) => previewTheme(t));
            } else {
                previewTheme(theme);
            }
        });
        btn.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                setActiveChoice(theme);
                if (typeof window.applyThemeChangeWithRipple === 'function') {
                    window.applyThemeChangeWithRipple(theme, btn, (t) => previewTheme(t));
                } else {
                    previewTheme(theme);
                }
            }
        });
    });

    if (overlayEl) {
        overlayEl.addEventListener('click', () => closeWizard({ persist: false }));
    }
    if (closeBtn) {
        closeBtn.addEventListener('click', () => closeWizard({ persist: false }));
    }
    if (skipBtn) {
        skipBtn.addEventListener('click', () => closeWizard({ persist: false }));
    }
    if (saveBtn) {
        saveBtn.addEventListener('click', () => closeWizard({ persist: true }));
    }

    function handleUrlTrigger(){
        let triggered = false;
        try {
            const params = new URLSearchParams(window.location.search || '');
            const action = (params.get('theme_wizard') || '').toLowerCase();
            if (!action) {
                return false;
            }
            if (action === 'restart' || action === 'start') {
                resetSeen();
                triggered = true;
                waitForWelcome(() => {
                    setTimeout(() => { openWizard('url-param', { force: true }); }, 200);
                });
                try {
                    const url = new URL(window.location.href);
                    url.searchParams.delete('theme_wizard');
                    const search = url.searchParams.toString();
                    const clean = url.pathname + (search ? '?' + search : '') + url.hash;
                    window.history.replaceState({}, document.title, clean);
                } catch (_) { /* ignore */ }
            }
        } catch (_) { /* ignore */ }
        return triggered;
    }

    window.ThemeWizard = {
        open: () => maybeOpen('manual', { force: true }),
        maybeOpen,
        watchDriver,
        hasSeen,
        resetSeen,
        scheduleFallback
    };

    // סנכרון: אם המשתמש כבר ראה בעבר (לוקאלית) אבל אין לנו DB flag, נעדכן לשרת בשקט.
    try {
        if (isLoggedIn && !serverHasSeen && hasSeen()) {
            persistSeenToServer();
        }
    } catch (_) { /* ignore */ }

    // סנכרון ערכת נושא בין טאבים (localStorage storage event)
    window.addEventListener('storage', (event) => {
        try {
            if (!event || !event.key) { return; }
            const key = String(event.key);
            const allowed = (window.__ckThemeRipple && Array.isArray(window.__ckThemeRipple.allowedThemes))
                ? window.__ckThemeRipple.allowedThemes
                : ['classic','ocean','rose-pine-dawn','dark','dim','nebula','high-contrast'];
            const isAllowed = (t) => !!t && allowed.indexOf(t) !== -1;
            const normalize = (v) => (v || '').toString().trim().toLowerCase();

            if (key === STORAGE_KEYS.userTheme) {
                const t = normalize(event.newValue);
                if (isAllowed(t)) {
                    previewTheme(t);
                    // עדכון בחירה רק אם קיימת אופציה בוויזארד
                    if (availableThemes().includes(t)) {
                        setActiveChoice(t);
                    }
                }
                return;
            }

            if (key === STORAGE_KEYS.preference) {
                const pref = normalize(event.newValue);
                if (pref === 'dark' || pref === 'dim') {
                    previewTheme(pref);
                    return;
                }
                if (pref === 'light') {
                    previewTheme('classic');
                    return;
                }
                if (pref === 'auto') {
                    const isDark = !!(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches);
                    previewTheme(isDark ? 'dark' : 'classic');
                    return;
                }
            }
        } catch (_) { /* ignore */ }
    });

    const triggered = handleUrlTrigger();
    if (!triggered) {
        scheduleFallback();
    }
})();
</script>

<script>
/**
 * Theme Picker Modal
 * מודאל בחירת ערכות נושא מתפריט קיצורי הדרך
 */
(function initThemePicker() {
    'use strict';

    const modalEl = document.getElementById('themePickerModal');
    if (!modalEl) return;

    // State
    let allThemes = [];
    let currentFilter = 'all';
    let isLoading = false;
    let currentActiveTheme = null;

    // DOM Elements
    const gridEl = document.getElementById('themePickerGrid');
    const currentNameEl = document.getElementById('currentThemeName');
    const backdropEl = modalEl.querySelector('[data-theme-picker-dismiss]');
    const closeBtn = modalEl.querySelector('[data-action="close-picker"]');
    const closeBtnFooter = modalEl.querySelector('.theme-picker__actions [data-action="close-picker"]');
    const tabBtns = modalEl.querySelectorAll('.theme-picker__tab');

    // ערכות מובנות (Built-in) עם צבעים לתצוגה מקדימה
    const hiddenBuiltinThemeIds = Array.isArray(window.__ckHiddenBuiltinThemes)
        ? window.__ckHiddenBuiltinThemes
        : [];
    const HIDDEN_BUILTIN_THEME_IDS = new Set(
        hiddenBuiltinThemeIds
            .map((id) => String(id).trim().toLowerCase())
            .filter(Boolean)
    );
    const BUILTIN_THEMES = [
        { id: 'nebula', name: 'Nebula', type: 'builtin', emoji: '🌌', colors: ['#1a1b26', '#7aa2f7', '#bb9af7', '#f7768e'] },
        { id: 'classic', name: 'Classic', type: 'builtin', emoji: '🏛️', colors: ['#ffffff', '#333333', '#667eea', '#48bb78'] },
        { id: 'high-contrast', name: 'High Contrast', type: 'builtin', emoji: '⚫️', colors: ['#000000', '#ffffff', '#ffcc00', '#00ff00'] }
    ];

    function escapeHtml(value) {
        const div = document.createElement('div');
        div.textContent = String(value || '');
        return div.innerHTML;
    }

    function escapeAttr(value) {
        return String(value || '')
            .replace(/&/g, '&amp;')
            .replace(/"/g, '&quot;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
    }

    function normalizeThemeId(value) {
        if (value === null || value === undefined) {
            return '';
        }
        return String(value);
    }

    function sanitizeColor(value) {
        const v = String(value || '').trim();
        if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{4}|[0-9a-fA-F]{6}|[0-9a-fA-F]{8})$/.test(v)) {
            return v;
        }
        const rgbMatch = v.match(/^rgb\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*\)$/i);
        if (rgbMatch) {
            const r = Number(rgbMatch[1]);
            const g = Number(rgbMatch[2]);
            const b = Number(rgbMatch[3]);
            if ([r, g, b].every((n) => Number.isFinite(n) && n >= 0 && n <= 255)) {
                return `rgb(${r}, ${g}, ${b})`;
            }
        }
        const rgbaMatch = v.match(/^rgba\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(0|1(?:\.0+)?|0?\.\d+)\s*\)$/i);
        if (rgbaMatch) {
            const r = Number(rgbaMatch[1]);
            const g = Number(rgbaMatch[2]);
            const b = Number(rgbaMatch[3]);
            const a = Number(rgbaMatch[4]);
            if (
                [r, g, b].every((n) => Number.isFinite(n) && n >= 0 && n <= 255)
                && Number.isFinite(a) && a >= 0 && a <= 1
            ) {
                return `rgba(${r}, ${g}, ${b}, ${a})`;
            }
        }
        return null;
    }

    function persistLocalTheme(themeAttr) {
        const t = String(themeAttr || '').trim().toLowerCase();
        try { localStorage.setItem('user_theme', t); } catch (_) {}
        try {
            const darkThemes = ['dark', 'dim', 'ocean', 'nebula', 'high-contrast'];
            const lightThemes = ['classic', 'rose-pine-dawn'];
            if (darkThemes.includes(t)) {
                localStorage.setItem('dark_mode_preference', 'dark');
            } else if (lightThemes.includes(t)) {
                localStorage.setItem('dark_mode_preference', 'light');
            } else {
                localStorage.removeItem('dark_mode_preference');
            }
        } catch (_) {}
    }

    function applyThemeAttributes(themeAttr, themeType, themeId) {
        const html = document.documentElement;
        try { html.setAttribute('data-theme', themeAttr); } catch (_) {}
        try {
            if (themeType === 'custom' && themeId) {
                html.setAttribute('data-theme-custom-id', themeId);
            } else {
                html.removeAttribute('data-theme-custom-id');
            }
        } catch (_) {}
        try {
            const raw = String(themeAttr || '').trim().toLowerCase();
            const isCustomType = themeType === 'shared'
                || themeType === 'custom'
                || raw === 'custom'
                || raw.startsWith('shared:');
            if (isCustomType) {
                html.setAttribute('data-theme-type', 'custom');
            } else {
                html.removeAttribute('data-theme-type');
            }
        } catch (_) {}
    }

    function captureThemeState() {
        const html = document.documentElement;
        const state = {
            themeAttr: html.getAttribute('data-theme') || '',
            themeType: html.getAttribute('data-theme-type') || '',
            themeCustomId: html.getAttribute('data-theme-custom-id') || '',
            userTheme: null,
            darkPref: null
        };
        try { state.userTheme = localStorage.getItem('user_theme'); } catch (_) {}
        try { state.darkPref = localStorage.getItem('dark_mode_preference'); } catch (_) {}
        return state;
    }

    function restoreThemeState(state) {
        if (!state) return;
        const html = document.documentElement;
        try {
            if (state.themeAttr) {
                html.setAttribute('data-theme', state.themeAttr);
            } else {
                html.removeAttribute('data-theme');
            }
        } catch (_) {}
        try {
            if (state.themeType) {
                html.setAttribute('data-theme-type', state.themeType);
            } else {
                html.removeAttribute('data-theme-type');
            }
        } catch (_) {}
        try {
            if (state.themeCustomId) {
                html.setAttribute('data-theme-custom-id', state.themeCustomId);
            } else {
                html.removeAttribute('data-theme-custom-id');
            }
        } catch (_) {}
        try {
            if (state.userTheme === null) {
                localStorage.removeItem('user_theme');
            } else {
                localStorage.setItem('user_theme', state.userTheme);
            }
        } catch (_) {}
        try {
            if (state.darkPref === null) {
                localStorage.removeItem('dark_mode_preference');
            } else {
                localStorage.setItem('dark_mode_preference', state.darkPref);
            }
        } catch (_) {}
    }

    function rememberThemeTransition(themeAttr, themeType) {
        try {
            sessionStorage.setItem('__ck_theme_transition', JSON.stringify({
                target: themeAttr,
                type: themeType,
                ts: Date.now()
            }));
        } catch (_) {}
    }

    function getThemeScope() {
        const raw = String(document.documentElement.getAttribute('data-theme-scope') || '').trim().toLowerCase();
        return raw === 'device' ? 'device' : 'global';
    }

    function getActiveThemeInfo() {
        const raw = normalizeThemeId(document.documentElement.getAttribute('data-theme') || '');
        if (raw.toLowerCase().startsWith('shared:')) {
            return { type: 'shared', id: raw.slice('shared:'.length), raw: raw };
        }
        if (raw.toLowerCase() === 'custom') {
            const customId = String(document.documentElement.getAttribute('data-theme-custom-id') || '').trim();
            return { type: 'custom', id: customId, raw: raw };
        }
        return { type: 'builtin', id: raw, raw: raw };
    }

    /**
     * פתיחת המודאל
     */
    function open() {
        modalEl.classList.add('is-open');
        modalEl.setAttribute('aria-hidden', 'false');
        document.body.classList.add('theme-picker-open');
        
        // סגור את תפריט הקיצורים
        const quickDropdown = document.getElementById('quickAccessDropdown');
        const quickToggle = document.querySelector('.quick-access-toggle');
        if (quickDropdown) quickDropdown.classList.remove('active');
        if (quickToggle) quickToggle.classList.remove('active');
        
        // שחזר פילטר שמור
        restoreFilter();
        
        // טען ערכות אם עדיין לא נטענו
        if (allThemes.length === 0) {
            // loadThemes יקרא ל-detectCurrentTheme בסיום הטעינה
            loadThemes();
        } else {
            // יש כבר ערכות טעונות - רנדר ועדכן את השם הנוכחי
            renderThemes();
            detectCurrentTheme();
        }
    }

    /**
     * סגירת המודאל
     */
    function close() {
        modalEl.classList.remove('is-open');
        modalEl.setAttribute('aria-hidden', 'true');
        document.body.classList.remove('theme-picker-open');
    }

    /**
     * טעינת כל הערכות מה-API
     */
    async function loadThemes() {
        if (isLoading) return;
        isLoading = true;
        allThemes = [...BUILTIN_THEMES];
        
        gridEl.innerHTML = `
            <div class="theme-picker__loading">
                <i class="fas fa-spinner fa-spin"></i>
                <span>טוען ערכות...</span>
            </div>
        `;

        try {
            // טען ערכות מה-API
            const response = await fetch('/api/themes/list', {
                headers: { 'Accept': 'application/json' }
            });
            
            if (!response.ok) throw new Error('Failed to load themes');
            
            const data = await response.json();
            
            if (data.ok && Array.isArray(data.themes)) {
                // הוסף ערכות מה-API (shared + custom)
                data.themes.forEach(theme => {
                    const themeId = normalizeThemeId(theme.id || theme.slug);
                    if (!themeId) {
                        return;
                    }
                    const themeIdLower = String(themeId).trim().toLowerCase();
                    if (theme.type === 'builtin' && HIDDEN_BUILTIN_THEME_IDS.has(themeIdLower)) {
                        return;
                    }
                    // בדוק שזו לא ערכה מובנית כפולה
                    const isBuiltin = BUILTIN_THEMES.some(b => {
                        const builtinId = normalizeThemeId(b.id);
                        return builtinId && builtinId.toLowerCase() === themeIdLower;
                    });
                    if (!isBuiltin) {
                        allThemes.push({
                            id: themeId,
                            name: theme.name,
                            type: String(theme.type || (theme.source === 'shared' ? 'shared' : 'custom')),
                            colors: theme.preview_colors || theme.colors || [],
                            source: theme.source,
                            is_active: theme.is_active
                        });
                    }
                });
            }
            
            isLoading = false;

            // וודא שהמודאל עדיין פתוח לפני רינדור
            if (!modalEl.classList.contains('is-open')) {
                return;
            }

            renderThemes();
            
            // עדכן את שם הערכה הנוכחית עכשיו שיש לנו את כל הנתונים
            detectCurrentTheme();
        } catch (error) {
            console.error('Error loading themes:', error);
            // וודא שהמודאל עדיין פתוח לפני הצגת שגיאה
            if (modalEl.classList.contains('is-open')) {
                gridEl.innerHTML = `
                    <div class="theme-picker__empty">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>שגיאה בטעינת ערכות</p>
                        <button class="btn btn-sm btn-outline-primary" onclick="window.__themePicker.reload()">נסה שוב</button>
                    </div>
                `;
            }
        } finally {
            isLoading = false;
        }
    }

    /**
     * רינדור הערכות לפי הפילטר הנוכחי
     */
    function renderThemes() {
        // וודא שהמודאל עדיין פתוח לפני רינדור
        if (!modalEl.classList.contains('is-open')) {
            return;
        }

        if (isLoading) {
            return;
        }
        
        let filtered = allThemes;
        
        if (currentFilter !== 'all') {
            filtered = allThemes.filter(t => t.type === currentFilter);
        }
        
        if (filtered.length === 0) {
            gridEl.innerHTML = `
                <div class="theme-picker__empty">
                    <i class="fas fa-palette"></i>
                    <p>אין ערכות בקטגוריה זו</p>
                </div>
            `;
            return;
        }
        
        gridEl.innerHTML = filtered.map(theme => {
            const isActive = isThemeActive(theme);
            const typeLabel = getTypeLabel(theme.type);
            const typeIcon = getTypeIcon(theme.type);
            const colors = getPreviewColors(theme);
            const themeId = normalizeThemeId(theme.id);
            const themeType = String(theme.type || '');
            const safeThemeId = escapeAttr(themeId);
            const safeThemeType = escapeAttr(themeType);
            const safeName = escapeHtml(theme.name || '');
            const safeEmoji = escapeHtml(theme.emoji || '');
            const displayName = safeEmoji ? `${safeEmoji} ${safeName}` : safeName;
            
            return `
                <div class="theme-picker__card ${isActive ? 'is-active' : ''}" 
                     role="option" 
                     aria-selected="${isActive}"
                     data-theme-id="${safeThemeId}"
                     data-theme-type="${safeThemeType}"
                     tabindex="0">
                    <div class="theme-picker__preview">
                        ${colors.map(c => `<div class="theme-picker__preview-color" style="background: ${c}"></div>`).join('')}
                    </div>
                    <div class="theme-picker__name">${displayName}</div>
                    <div class="theme-picker__type">
                        <i class="${typeIcon}"></i>
                        ${typeLabel}
                    </div>
                </div>
            `;
        }).join('');
        
        // הוסף event listeners לכרטיסים
        gridEl.querySelectorAll('.theme-picker__card').forEach(card => {
            card.addEventListener('click', () => selectTheme(card.dataset.themeId, card.dataset.themeType));
            card.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    selectTheme(card.dataset.themeId, card.dataset.themeType);
                }
            });
        });
    }

    /**
     * קבלת צבעים לתצוגה מקדימה
     */
    function getPreviewColors(theme) {
        const rawColors = Array.isArray(theme.colors) ? theme.colors : [];
        const safeColors = rawColors.map(sanitizeColor).filter(Boolean);
        const fallback = ['#1a1b26', '#7aa2f7', '#bb9af7', '#f7768e'];
        if (safeColors.length > 0) {
            const filled = [...safeColors];
            fallback.forEach((c) => {
                if (filled.length < 4 && !filled.includes(c)) {
                    filled.push(c);
                }
            });
            return filled.slice(0, 4);
        }
        // צבעי ברירת מחדל
        return fallback;
    }

    /**
     * קבלת תווית סוג הערכה
     */
    function getTypeLabel(type) {
        const labels = {
            builtin: 'מובנית',
            shared: 'ציבורית',
            custom: 'אישית',
            imported: 'מיובאת'
        };
        return labels[type] || escapeHtml(type);
    }

    /**
     * קבלת אייקון סוג הערכה
     */
    function getTypeIcon(type) {
        const icons = {
            builtin: 'fas fa-cube',
            shared: 'fas fa-globe',
            custom: 'fas fa-user',
            imported: 'fas fa-file-import'
        };
        return icons[type] || 'fas fa-palette';
    }

    /**
     * בדיקה האם ערכה פעילה
     */
    function isThemeActive(theme) {
        const themeId = normalizeThemeId(theme.id);
        const active = getActiveThemeInfo();
        if (theme.type === 'shared') {
            return active.type === 'shared' && normalizeThemeId(active.id) === themeId;
        }
        if (theme.type === 'custom') {
            if (active.type === 'custom' && active.id) {
                return normalizeThemeId(active.id) === themeId;
            }
            return !!theme.is_active;
        }
        if (theme.is_active) return true;
        if (active.type === 'builtin' && active.id) {
            return normalizeThemeId(active.id) === themeId;
        }
        return normalizeThemeId(currentActiveTheme) === themeId;
    }

    /**
     * זיהוי הערכה הנוכחית
     */
    function detectCurrentTheme() {
        const active = getActiveThemeInfo();
        currentActiveTheme = active.raw;
        let theme = null;
        if (active.type === 'shared') {
            theme = allThemes.find(t => t.type === 'shared' && normalizeThemeId(t.id) === normalizeThemeId(active.id));
        } else if (active.type === 'custom') {
            if (active.id) {
                theme = allThemes.find(t => t.type === 'custom' && normalizeThemeId(t.id) === normalizeThemeId(active.id));
            }
            if (!theme) {
                theme = allThemes.find(t => t.type === 'custom' && t.is_active);
            }
        } else {
            theme = allThemes.find(t => normalizeThemeId(t.id) === normalizeThemeId(active.id || active.raw));
        }
        if (theme && currentNameEl) {
            currentNameEl.textContent = theme.name;
        } else if (currentNameEl) {
            currentNameEl.textContent = active.raw || '--';
        }
    }

    /**
     * בחירת ערכה והחלתה
     */
    async function selectTheme(themeId, themeType) {
        const normalizedThemeId = normalizeThemeId(themeId);
        if (!normalizedThemeId) return;
        
        // הצג מצב טעינה על הכרטיס
        const card = Array.from(gridEl.querySelectorAll('.theme-picker__card'))
            .find((el) => el.dataset && el.dataset.themeId === normalizedThemeId);
        if (card) {
            card.style.opacity = '0.7';
            card.style.pointerEvents = 'none';
        }
        
        let previousState = null;
        try {
            let endpoint = '';
            let body = null;
            let themeAttr = '';
            let resolvedType = themeType;
            const themeScope = getThemeScope();

            if (resolvedType === 'shared') {
                endpoint = `/api/themes/shared/${encodeURIComponent(normalizedThemeId)}/apply`;
                body = { theme_scope: themeScope };
                themeAttr = `shared:${normalizedThemeId}`;
            } else if (resolvedType === 'custom') {
                endpoint = `/api/themes/${encodeURIComponent(normalizedThemeId)}/activate`;
                body = { theme_scope: themeScope };
                themeAttr = 'custom';
            } else {
                resolvedType = 'builtin';
                endpoint = '/api/ui_prefs';
                body = { theme: normalizedThemeId, theme_scope: themeScope };
                themeAttr = normalizedThemeId;
            }

            previousState = captureThemeState();
            
            // בדיקה אם הערכה הקודמת הייתה custom/shared - במקרה כזה צריך reload גם אם עוברים לערכת builtin
            const prevTheme = (previousState.themeAttr || '').toLowerCase();
            const wasCustomOrShared = prevTheme === 'custom' || prevTheme.startsWith('shared:') || previousState.themeType === 'custom';
            
            // צריך reload אם עוברים ל/מ-ערכות custom/shared
            const shouldReload = resolvedType === 'shared' || resolvedType === 'custom' || wasCustomOrShared;

            applyThemeAttributes(themeAttr, resolvedType, resolvedType === 'custom' ? normalizedThemeId : '');
            persistLocalTheme(themeAttr);
            if (shouldReload) {
                rememberThemeTransition(themeAttr, resolvedType);
            }

            const response = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                body: body ? JSON.stringify(body) : null
            });

            let data = null;
            try { data = await response.json(); } catch (_) {}

            if (!response.ok || !(data && (data.ok || data.success))) {
                throw new Error((data && (data.error || data.message)) || 'Failed to apply theme');
            }

            if (shouldReload) {
                showToast('הערכה הופעלה בהצלחה!', 'success');
                setTimeout(() => {
                    try {
                        const url = new URL(window.location.href);
                        url.searchParams.set('no_cache', '1');
                        window.location.replace(url.toString());
                    } catch (e) {
                        window.location.reload();
                    }
                }, 350);
            } else {
                currentActiveTheme = themeAttr;
                renderThemes();
                detectCurrentTheme();
                showToast('הערכה הופעלה בהצלחה!', 'success');
            }
        } catch (error) {
            console.error('Error applying theme:', error);
            try { restoreThemeState(previousState); } catch (_) {}
            try { sessionStorage.removeItem('__ck_theme_transition'); } catch (_) {}
            renderThemes();
            detectCurrentTheme();
            showToast('שגיאה בהחלת הערכה', 'error');
        } finally {
            if (card) {
                card.style.opacity = '';
                card.style.pointerEvents = '';
            }
        }
    }

    /**
     * הצגת Toast
     */
    function showToast(message, type = 'info') {
        // נסה להשתמש ב-toast קיים
        if (window.showNotification) {
            window.showNotification(message, type);
            return;
        }
        
        // fallback פשוט
        const toast = document.createElement('div');
        toast.className = `simple-toast simple-toast--${type}`;
        toast.textContent = message;
        toast.style.cssText = `
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            padding: 0.75rem 1.5rem;
            background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
            color: white;
            border-radius: 8px;
            z-index: 20000;
            font-size: 0.9rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        `;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    // שמור את הפילטר ב-sessionStorage
    function setFilter(filter) {
        currentFilter = filter;
        sessionStorage.setItem('theme_picker_filter', filter);
        renderThemes();
    }

    // שחזר בעת פתיחה
    function restoreFilter() {
        const saved = sessionStorage.getItem('theme_picker_filter');
        if (saved) {
            currentFilter = saved;
            tabBtns.forEach(btn => {
                const isActive = btn.dataset.filter === saved;
                btn.classList.toggle('active', isActive);
                btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
            });
        }
    }

    // === Event Listeners ===
    
    // סגירה בלחיצה על backdrop
    if (backdropEl) {
        backdropEl.addEventListener('click', close);
    }
    
    // כפתורי סגירה
    if (closeBtn) closeBtn.addEventListener('click', close);
    if (closeBtnFooter) closeBtnFooter.addEventListener('click', close);
    
    // סגירה ב-Escape
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modalEl.classList.contains('is-open')) {
            close();
        }
    });
    
    // טאבים לסינון
    tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            currentFilter = btn.dataset.filter || 'all';
            tabBtns.forEach(b => {
                b.classList.toggle('active', b === btn);
                b.setAttribute('aria-selected', b === btn ? 'true' : 'false');
            });
            setFilter(currentFilter);
        });
    });

    // הוסף ל-event listeners
    gridEl.addEventListener('keydown', (e) => {
        const cards = Array.from(gridEl.querySelectorAll('.theme-picker__card'));
        const current = document.activeElement;
        const idx = cards.indexOf(current);
        
        if (e.key === 'ArrowRight' && idx > 0) {
            cards[idx - 1].focus();
        } else if (e.key === 'ArrowLeft' && idx < cards.length - 1) {
            cards[idx + 1].focus();
        }
    });

    // === Public API ===
    window.__themePicker = {
        open: open,
        close: close,
        reload: loadThemes
    };
    
    // פונקציה גלובלית לפתיחה מהכפתור
    window.openThemePickerModal = open;

})();
</script>

<script>
// Sticky note reminders indicator (persistent UI badge)
(function initStickyRemindersIndicator(){
  function isMobile(){ return window.matchMedia && window.matchMedia('(max-width: 768px)').matches; }
  // ניהול פופ־אפ פעיל והאזנות גלובליות
  let activeReminderPopover = null;
  let removeReminderPopoverListeners = null;
  function ensureBubble(anchor){
    if (!anchor) return null;
    let b = anchor.querySelector('.notif-bubble[data-kind="reminder"]');
    if (b) return b;
    b = document.createElement('span');
    b.className = 'notif-bubble notif-bubble--pulse';
    b.setAttribute('data-kind','reminder');
    b.setAttribute('role','button');
    b.setAttribute('tabindex','0');
    b.setAttribute('aria-label','תזכורות ממתינות לפתקים');
    anchor.style.position = 'relative';
    anchor.appendChild(b);
    return b;
  }
  function removeDot(){
    document.querySelectorAll('.notif-bubble[data-kind="reminder"]').forEach(el => { try { el.remove(); } catch(_) {} });
  }
  function closePopover(){
    try {
      if (removeReminderPopoverListeners) { removeReminderPopoverListeners(); }
    } catch(_) {}
    removeReminderPopoverListeners = null;
    const pop = activeReminderPopover || document.querySelector('.notif-popover[data-kind="reminder"]');
    if (pop) {
      try { pop.removeAttribute('data-open'); pop.setAttribute('aria-hidden','true'); pop.remove(); } catch(_) {}
    }
    activeReminderPopover = null;
  }
  function openPopover(anchor, data){
    if (!anchor) return;
    // סגור מופע קודם אם קיים
    closePopover();
    const pop = document.createElement('div');
    pop.className = 'notif-popover notif-popover--portal';
    pop.setAttribute('data-kind','reminder');
    pop.setAttribute('role','dialog');
    pop.setAttribute('aria-modal','false');
    pop.style.display = 'block';
    document.body.appendChild(pop);
    const count = Number(data && data.count) || 0;
    const items = Array.isArray(data && data.items) ? data.items : [];
    const title = `🔔 יש לך ${count} פתקים שממתינים:`;
    const listHtml = items.map(it => {
      const prev = (it.preview || '').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      return `<li style="list-style:none; margin:4px 0;"><a href="#" data-note-id="${String(it.note_id || '')}" data-file-id="${String(it.file_id || '')}" class="reminder-link" style="text-decoration:none; color:inherit;">• ${prev || 'פתק ללא כותרת'}...</a></li>`;
    }).join('');
    pop.innerHTML = `
      <div class="notif-popover__title">${title}</div>
      <div class="notif-popover__body">
        <ul style="padding:0; margin:0; max-width: 30ch;">${listHtml}</ul>
        <div class="notif-popover__actions">
          <button type="button" class="btn btn-secondary" data-action="snooze-ui">דחה לאחר"כ</button>
          <button type="button" class="btn btn-primary" data-action="close-ui">סגור</button>
        </div>
      </div>
    `;
    pop.setAttribute('data-open','true');
    pop.setAttribute('aria-hidden','false');
    activeReminderPopover = pop;

    // חישוב מיקום יחסי לאייקון הפעמון (RTL/Responsive)
    const place = () => {
      try {
        const rect = anchor.getBoundingClientRect();
        const vw = window.innerWidth || document.documentElement.clientWidth || 0;
        const vh = window.innerHeight || document.documentElement.clientHeight || 0;
        const gap = 8;
        // יישור אופקי לפי כיוון המסמך
        const rtl = (document.documentElement.getAttribute('dir') || '').toLowerCase() === 'rtl'
          || (getComputedStyle(document.documentElement).direction || '').toLowerCase() === 'rtl';
        pop.style.right = 'auto';
        pop.style.left = 'auto';
        let top = Math.round(rect.bottom + gap);
        // הגבלת תחתית המסך – אם אין מקום למטה, נפתח מעל העוגן
        pop.style.top = top + 'px';
        // יש למדוד אחרי הצבה
        const pr = pop.getBoundingClientRect();
        const popW = Math.round(pr.width || 240);
        const popH = Math.round(pr.height || 140);
        if (rtl) {
          const rightPx = Math.max(8, Math.round(vw - rect.right));
          pop.style.right = rightPx + 'px';
        } else {
          let left = Math.round(rect.left);
          left = Math.max(8, Math.min(left, vw - popW - 8));
          pop.style.left = left + 'px';
        }
        const willOverflowBottom = (top + popH) > (vh - 8);
        if (willOverflowBottom) {
          const above = Math.max(8, Math.round(rect.top - gap - popH));
          pop.style.top = above + 'px';
        }
      } catch(_) {}
    };
    place();

    // האזנות: קליק מחוץ/ESC/Resize/Scroll
    const outsideCloser = (e) => {
      try {
        if (!activeReminderPopover) return;
        const target = e.target;
        const isInsidePop = activeReminderPopover.contains(target);
        const isAnchorOrBubble = anchor.contains(target) || (target && (target.closest && target.closest('.notif-bubble[data-kind="reminder"]')));
        if (!isInsidePop && !isAnchorOrBubble) { closePopover(); }
      } catch(_) {}
    };
    const escCloser = (e) => { if (e.key === 'Escape') { closePopover(); } };
    const reposer = () => { if (activeReminderPopover) place(); };
    document.addEventListener('click', outsideCloser, true);
    document.addEventListener('keydown', escCloser, true);
    window.addEventListener('resize', reposer);
    window.addEventListener('scroll', reposer, true);
    removeReminderPopoverListeners = () => {
      document.removeEventListener('click', outsideCloser, true);
      document.removeEventListener('keydown', escCloser, true);
      window.removeEventListener('resize', reposer);
      window.removeEventListener('scroll', reposer, true);
    };

    // Bind actions
    pop.querySelectorAll('a.reminder-link').forEach(a => {
      a.addEventListener('click', async (ev) => {
        ev.preventDefault();
        const noteId = a.getAttribute('data-note-id') || '';
        const fileId = a.getAttribute('data-file-id') || '';
        // best-effort ack
        try { fetch('/api/sticky-notes/reminders/ack', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ note_id: noteId }) }).catch(()=>{}); } catch(_) {}
        // navigate to rendered markdown with deep-link to note
        if (fileId) { window.location.href = '/md/' + encodeURIComponent(fileId) + '?note=' + encodeURIComponent(noteId); }
      });
    });
    const closeBtn = pop.querySelector('[data-action="close-ui"]');
    const snoozeBtn = pop.querySelector('[data-action="snooze-ui"]');
    if (closeBtn) closeBtn.addEventListener('click', () => { closePopover(); removeDot(); });
    if (snoozeBtn) snoozeBtn.addEventListener('click', () => { closePopover(); /* משאיר את הבועה גלויה */ });
  }
  async function poll(){
    try {
      if (!document || (document.visibilityState && document.visibilityState !== 'visible')) {
        return false;
      }
      const r = await fetch('/api/sticky-notes/reminders/summary', { cache: 'no-store', credentials: 'same-origin' });
      if (r && r.status === 429) {
        // Rate limited: אל נשנה UI (כדי לא "להעלים" בועה קיימת), פשוט ננסה שוב מאוחר יותר.
        try { backoffUntil = Date.now() + RATE_LIMIT_BACKOFF_MS; } catch(_) {}
        return true;
      }
      if (!r.ok) { removeDot(); return true; }
      const j = await r.json();
      if (!j || j.ok === false || !j.has_due) { removeDot(); return true; }
      const target = isMobile() ? document.querySelector('.mobile-menu-toggle') : document.querySelector('.nav-link[href="/settings"]');
      const bubble = ensureBubble(target);
      if (!bubble) return true;
      // Update counter
      try { bubble.setAttribute('data-count', String(j.count_due || 0)); } catch(_) {}
      bubble.textContent = String(j.count_due || 1);
      bubble.onclick = async (ev) => {
        ev.preventDefault();
        try {
          const lr = await fetch('/api/sticky-notes/reminders/list?limit=20', { cache: 'no-store', credentials: 'same-origin' });
          const lj = await lr.json().catch(()=>null);
          openPopover(target, (lj && lj.ok) ? lj : { items: [], count: 0 });
        } catch(_) { /* ignore */ }
      };
      bubble.onkeydown = (ev) => { if (ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); bubble.click(); } };
      return true;
    } catch(_) {
      removeDot();
      return false;
    }
  }
  // חשוב: אל נבצע polling כל דקה – זה חוצה את ה-limit (50/שעה) מהר מאוד, במיוחד אם יש כמה טאבים פתוחים.
  const BASE_POLL_MS = 5 * 60 * 1000; // 5 דקות
  const RATE_LIMIT_BACKOFF_MS = 15 * 60 * 1000; // 15 דקות במקרה של 429
  let pollTimer = null;
  let lastPollAt = 0;
  let backoffUntil = 0;

  function scheduleNext(delayMs){
    try { if (pollTimer) clearTimeout(pollTimer); } catch(_) {}
    pollTimer = null;
    // לא נרצה "לנעול" כל דיליי למינימום 30 שניות, כי יש מצבים (טעינה/חזרה לטאב)
    // שבהם כן חשוב לנסות מהר. עדיין נשמור מינימום קטן כדי לא לייצר לופ משוגע.
    const d = Math.max(1000, Number(delayMs || BASE_POLL_MS) || BASE_POLL_MS);
    try { pollTimer = setTimeout(tick, d); } catch(_) {}
  }

  async function tick(){
    const now = Date.now();
    // אם הטאב מוסתר – אל נעדכן lastPollAt (כדי לא ליצור "phantom poll")
    try {
      if (document && document.visibilityState && document.visibilityState !== 'visible') {
        scheduleNext(BASE_POLL_MS);
        return;
      }
    } catch(_) {}

    if (backoffUntil && now < backoffUntil) {
      scheduleNext(backoffUntil - now);
      return;
    }

    // guard: אל תרוץ לעיתים קרובות מדי גם אם schedule/visibility עשה trigger
    if (lastPollAt && (now - lastPollAt) < 30_000) {
      scheduleNext(30_000 - (now - lastPollAt));
      return;
    }

    const didFetch = await poll();
    if (didFetch) {
      lastPollAt = Date.now();
    }

    const now2 = Date.now();
    if (backoffUntil && now2 < backoffUntil) {
      scheduleNext(backoffUntil - now2);
    } else {
      scheduleNext(BASE_POLL_MS);
    }
  }

  try {
    document.addEventListener('visibilitychange', () => {
      try {
        if (document.visibilityState === 'visible') {
          // לא מאפסים backoff על 429 רק בגלל מעבר טאבים.
          // אם אנחנו עדיין בחלון backoff – נכבד אותו ונתזמן לפי הזמן שנותר.
          const now = Date.now();
          if (backoffUntil && now < backoffUntil) {
            scheduleNext(backoffUntil - now);
          } else {
            scheduleNext(1000);
          }
        }
      } catch(_) {}
    });
  } catch(_) {}

  scheduleNext(1000);
})();
</script>

<script>
// Announcement banner initialization — with dynamic fetch fallback
(function initAnnouncementBanner(){
    const container = document.getElementById('announcementBanner');
    const inner = document.getElementById('announcementBannerInner');
    if (!container || !inner) { return; }

    function hide(){
        try {
            container.style.display = 'none';
            container.setAttribute('aria-hidden', 'true');
            container.setAttribute('tabindex', '-1');
        } catch (_) {}
    }
    function show(){
        try {
            container.style.display = '';
            container.setAttribute('aria-hidden', 'false');
        } catch (_) {}
    }

    function escapeHtml(value){
        const div = document.createElement('div');
        div.textContent = String(value || '');
        return div.innerHTML;
    }
    function escapeAttr(value){
        return String(value || '').replace(/"/g, '&quot;');
    }

    function renderContent(entry){
        const build = (item) => {
            const wrap = document.createElement('div');
            wrap.className = 'announcement-banner__content';
            const text = String(item.text || '').trim();
            if (item.link) {
                wrap.innerHTML = `${escapeHtml(text)} <a href="${escapeAttr(item.link)}" target="_blank" rel="noopener">עוד ›</a>`;
            } else {
                wrap.textContent = text;
            }
            return wrap;
        };
        // ניקוי תוכן קיים והצגת פריט יחיד ללא אנימציה/מרקיזה
        inner.innerHTML = '';
        const first = build(entry);
        inner.appendChild(first);
        try { inner.style.animation = 'none'; } catch(_) {}
        try {
            // הבאנר כעת גמיש גובה; אין צורך במרחק/זמן
            const oneHeight = Math.max(1, Math.round(first.getBoundingClientRect().height || 1));
            inner.style.setProperty('--announcement-distance', oneHeight + 'px');
        } catch (_) { /* ignore measurements errors */ }
    }

    async function run(){
        try {
            // Try to fetch active announcement if none injected
            let list = Array.isArray(window.__announcements) ? window.__announcements : [];
            let fetchedFromApi = false;
            if (!list.length) {
                try {
                    const currentPath = (window.location && window.location.pathname) ? window.location.pathname : '/';
                    const resp = await fetch('/api/v1/announcements/active?path=' + encodeURIComponent(currentPath), { cache: 'no-store' });
                    if (resp && resp.ok) {
                        const a = await resp.json();
                        const obj = (a && typeof a === 'object' && 'active' in a) ? a.active : a;
                        if (obj) {
                            window.__announcementEnabled = true;
                            window.__announcements = [{ id: obj.id, text: obj.text, link: obj.link || null }];
                            list = window.__announcements;
                            fetchedFromApi = true;
                        }
                    }
                } catch (_) { /* ignore */ }
            }

            const announcements = (Array.isArray(list) ? list : []).filter((item) => {
                try { return item && typeof item === 'object' && String(item.text || '').trim().length > 0; } catch (_) { return false; }
            });
            if (!announcements.length) {
                hide();
                return;
            }

            // אם זו הכרזת אדמין חדשה – אפס כיבוי מקומי כדי שתוצג שוב
            try {
                const activeId = String(announcements[0]?.id || '');
                const lastId = localStorage.getItem('announcementLastId') || '';
                if (activeId && activeId !== lastId) {
                    try { localStorage.removeItem('announcementBannerOff'); } catch(_) {}
                    try { localStorage.setItem('announcementLastId', activeId); } catch(_) {}
                }
            } catch(_) {}

            // Gating flags apply רק לטיפ שבועי; כאן יש הכרזה פעילה, אז בברירת מחדל מתעלמים מדגלים
            const htmlAttr = (document.documentElement.getAttribute('data-announcement') || '').toLowerCase();
            const globalFlag = (typeof window.__announcementEnabled === 'boolean')
                ? window.__announcementEnabled
                : (typeof window.__weeklyTipEnabled === 'boolean' ? window.__weeklyTipEnabled : true);
            const localKill = (() => {
                try {
                    return localStorage.getItem('announcementBannerOff') === '1'
                        || localStorage.getItem('weeklyTipFeatureOff') === '1';
                } catch (_) { return false; }
            })();
            const gatingBlocked = (!globalFlag || htmlAttr === 'off' || htmlAttr === '0' || localKill);

            // אם נחסם ע"י gating אך קיימת הכרזה פעילה — עקוף את החסימה והצג בכל זאת
            if (gatingBlocked && (fetchedFromApi || announcements.length > 0)) {
                // ממשיכים להצגה בלי hide()
            } else if (gatingBlocked) {
                hide();
                return;
            }

            const activeAnnouncement = announcements[0];
            renderContent(activeAnnouncement);
            const announcementText = String(activeAnnouncement.text || '').trim();
            if (announcementText) {
                container.setAttribute('title', announcementText);
                container.setAttribute('aria-label', announcementText);
            }
            if (activeAnnouncement && activeAnnouncement.link) {
                container.setAttribute('role', 'link');
                container.setAttribute('tabindex', '0');
                try { container.style.cursor = 'pointer'; } catch (_) {}
            } else {
                container.setAttribute('role', 'status');
                container.setAttribute('tabindex', '-1');
                try { container.style.cursor = 'default'; } catch (_) {}
            }
            show();

            const pause = () => { container.classList.add('is-paused'); };
            const resume = () => { container.classList.remove('is-paused'); };
            container.addEventListener('mouseenter', pause);
            container.addEventListener('mouseleave', resume);
            container.addEventListener('focusin', pause);
            container.addEventListener('focusout', resume);

            const openLink = () => {
                if (!activeAnnouncement || !activeAnnouncement.link) { return; }
                const target = String(activeAnnouncement.link);
                try {
                    if (target.startsWith('/')) {
                        window.location.href = target;
                    } else {
                        window.open(target, '_blank', 'noopener');
                    }
                } catch (_) { window.location.href = target; }
            };
            container.addEventListener('click', (event) => {
                if (!activeAnnouncement || !activeAnnouncement.link) { return; }
                event.preventDefault();
                openLink();
            });
            container.addEventListener('keydown', (event) => {
                const key = event.key;
                if ((key === 'Enter' || key === ' ') && activeAnnouncement && activeAnnouncement.link) {
                    event.preventDefault();
                    openLink();
                }
            });
        } catch (_) { hide(); }
    }
    try { run(); } catch (_) { hide(); }
})();
</script>

<script>
// Premium announcement indicator
(function initPremiumAnnouncement(){
    async function fetchMe(){
        try {
            const r = await fetch('/api/me');
            if (!r.ok) return null;
            const j = await r.json();
            return j && j.ok ? j : null;
        } catch (_) { return null; }
    }
    function lsGet(k){ try { return localStorage.getItem(k); } catch(_) { return null; } }
    function lsSet(k,v){ try { localStorage.setItem(k,v); } catch(_) {} }
    function isMobile(){ return window.matchMedia && window.matchMedia('(max-width: 768px)').matches; }
    function createDot(){
        const s = document.createElement('span');
        s.className = 'notif-dot notif-dot--pulse';
        s.setAttribute('role','button');
        s.setAttribute('tabindex','0');
        s.setAttribute('aria-label','התראה חדשה: הפכת לפרימיום');
        s.title = 'התראה: הפכת לפרימיום';
        return s;
    }
    function ensurePopover(anchorEl){
        let pop = anchorEl.querySelector('.notif-popover');
        if (!pop) {
            pop = document.createElement('div');
            pop.className = 'notif-popover';
            pop.setAttribute('role','dialog');
            pop.setAttribute('aria-modal','false');
            pop.setAttribute('aria-hidden','true');
            pop.innerHTML = (
                '<div class="notif-popover__title">💎 הפכת לפרימיום!</div>'+
                '<div class="notif-popover__body">תודה על הפעילות! קיבלת תג פרימיום עם אפשרות לבקשות מיוחדות.</div>'+
                '<div class="notif-popover__actions">'+
                '  <button type="button" class="btn btn-primary" data-action="go">לפרטים</button>'+
                '  <button type="button" class="btn btn-secondary" data-action="close">סגור</button>'+
                '</div>'
            );
            anchorEl.appendChild(pop);
        }
        return pop;
    }
    function openPopover(anchorEl, onGo){
        const pop = ensurePopover(anchorEl);
        pop.setAttribute('data-open','true');
        pop.setAttribute('aria-hidden','false');
        const goBtn = pop.querySelector('[data-action="go"]');
        const closeBtn = pop.querySelector('[data-action="close"]');
        const cleanup = () => {
            document.removeEventListener('click', outsideCloser, true);
            document.removeEventListener('keydown', escCloser, true);
        };
        const outsideCloser = (e) => {
            if (!anchorEl.contains(e.target)) { closePopover(anchorEl); cleanup(); }
        };
        const escCloser = (e) => { if (e.key === 'Escape') { closePopover(anchorEl); cleanup(); } };
        document.addEventListener('click', outsideCloser, true);
        document.addEventListener('keydown', escCloser, true);
        if (goBtn) goBtn.onclick = () => { cleanup(); onGo(); };
        if (closeBtn) closeBtn.onclick = () => { cleanup(); closePopover(anchorEl); };
        try { (goBtn || closeBtn).focus(); } catch(_) {}
        return pop;
    }
    function closePopover(anchorEl){
        const pop = anchorEl.querySelector('.notif-popover');
        if (!pop) return;
        pop.removeAttribute('data-open');
        pop.setAttribute('aria-hidden','true');
    }

    function attachDot(anchorEl, onActivate){
        if (!anchorEl) return;
        const dot = createDot();
        const handler = (ev) => { ev.preventDefault(); onActivate(anchorEl, dot); };
        dot.addEventListener('click', handler);
        dot.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); onActivate(); }});
        anchorEl.appendChild(dot);
        return dot;
    }

    function goToPremium(){
        try { window.location.href = '/settings#account-status'; } catch(_) {}
    }

    (async function(){
        const me = await fetchMe();
        if (!me || !me.roles || !me.roles.is_premium || !me.user || !me.user.user_id) return;
        const uid = String(me.user.user_id);
        const K = 'premium_announce_seen_' + uid;
        if (lsGet(K) === '1') return; // already seen
        const onActivate = (anchorEl, dotEl) => {
            lsSet(K,'1');
            try { dotEl && dotEl.remove(); } catch(_) {}
            openPopover(anchorEl, () => goToPremium());
            // Auto navigate after short delay for convenience
            setTimeout(() => { goToPremium(); }, 1600);
        };
        if (isMobile()) {
            const mobileBtn = document.querySelector('.mobile-menu-toggle');
            if (mobileBtn) { attachDot(mobileBtn, onActivate); return; }
        }
        const settingsLink = document.querySelector('.nav-link[href="/settings"]');
        if (settingsLink) { attachDot(settingsLink, onActivate); }
    })();
})();
</script>

<script>
(function initInteractiveWalkthrough(){
    const STORAGE_KEY = 'codekeeper_walkthrough_v1';
    const AUTO_PATHS = ['/files'];
    const MAX_RETRIES = 5;
    const isLoggedIn = {{ 'true' if _session_user_id else 'false' }};
    const serverHasSeen = {{ 'true' if onboarding_walkthrough_v1_seen else 'false' }};

    function hasSeen(){
        if (serverHasSeen) {
            return true;
        }
        try {
            const v = localStorage.getItem(STORAGE_KEY);
            return v === '1' || v === 'true' || v === 'yes';
        } catch (_) {
            return false;
        }
    }
    function persistSeenToServer(){
        if (!isLoggedIn) { return; }
        try {
            fetch('/api/ui_prefs', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ onboarding: { walkthrough_v1_seen: true } })
            }).catch(() => {});
        } catch (_) { /* ignore */ }
    }
    function markSeen(){
        try { localStorage.setItem(STORAGE_KEY, '1'); }
        catch (_) { /* ignore */ }
        persistSeenToServer();
    }
    function resetSeen(){
        try { localStorage.removeItem(STORAGE_KEY); }
        catch (_) { /* ignore */ }
    }
    function getDriverFactory(){
        if (!window.driver || !window.driver.js || typeof window.driver.js.driver !== 'function') {
            return null;
        }
        return window.driver.js.driver;
    }
    function isElementTourVisible(element){
        if (!element) {
            return false;
        }
        try {
            const rect = element.getBoundingClientRect();
            if (rect.width <= 2 || rect.height <= 2) {
                return false;
            }
            const styles = window.getComputedStyle(element);
            if (!styles) {
                return true;
            }
            if (styles.visibility === 'hidden' || styles.display === 'none') {
                return false;
            }
            const opacity = parseFloat(styles.opacity || '1');
            if (Number.isFinite(opacity) && opacity < 0.05) {
                return false;
            }
            return true;
        } catch (_) {
            return false;
        }
    }
    function buildSteps(){
        const isMobileViewport = (() => {
            try {
                return window.matchMedia && window.matchMedia('(max-width: 768px)').matches;
            } catch (_) {
                return false;
            }
        })();
        const steps = [];
        steps.push({
            popover: {
                title: 'ברוכים הבאים 👋',
                description: 'נעשה סיבוב זריז שיציג את הפעולות החשובות במסך הקבצים.',
            }
        });
        const createBtn = document.getElementById('tourCreateButton');
        if (createBtn) {
            steps.push({
                element: createBtn,
                popover: {
                    title: 'כאן יוצרים קובץ חדש',
                    description: 'לחיצה תפתח את מסך ההעלאה ותאפשר להוסיף קובץ או קטע קוד בלחיצה אחת.',
                    side: 'bottom',
                    align: 'center',
                }
            });
        }
        const searchInput = document.getElementById('globalSearchInput');
        if (searchInput) {
            steps.push({
                element: searchInput,
                popover: {
                    title: 'חיפוש על־כללי',
                    description: 'הקלידו כל מונח ותוכלו למצוא קובץ לפי שם, תוכן, תגיות או שפה תוך שניות.',
                    side: 'bottom',
                    align: 'center',
                }
            });
        }
        const collectionsLink = document.getElementById('tourCollectionsNav');
        if (collectionsLink && !isMobileViewport && isElementTourVisible(collectionsLink)) {
            steps.push({
                element: collectionsLink,
                popover: {
                    title: 'האוספים שלי',
                    description: 'ארגנו קבצים לתיקיות נושאיות, שתפו עם הצוות או הפעילו תצוגות ממוקדות.',
                    side: 'bottom',
                    align: 'center',
                }
            });
        }
        steps.push({
            popover: {
                title: 'זהו, אתם מסודרים 🎉',
                description: 'אם תרצו לחזור עליו, ניתן לאפס את ההדרכה בדפדפן ולהפעיל אותה מחדש בכל רגע.',
            }
        });
        const hasAnchoredStep = steps.some((step) => step.element);
        return hasAnchoredStep ? steps : null;
    }
    function startTour(options = {}, attempt = 0){
        const driverFactory = getDriverFactory();
        if (!driverFactory) {
            if (attempt < MAX_RETRIES) {
                setTimeout(() => startTour(options, attempt + 1), 400);
            }
            return false;
        }
        const steps = buildSteps();
        if (!steps || !steps.length) {
            return false;
        }
        let lockAcquired = false;
        let safetyTimer = null;
        // שחרור נעילה בסיום הסיור (מונע מצב "תקוע" שמונע את הוויזארד)
        const release = () => {
            if (!lockAcquired) { return; }
            lockAcquired = false;
            try {
                if (safetyTimer) {
                    clearTimeout(safetyTimer);
                    safetyTimer = null;
                }
            } catch (_) { /* ignore */ }
            try {
                if (window.__ckOnboarding && typeof window.__ckOnboarding.release === 'function') {
                    window.__ckOnboarding.release('tour');
                }
            } catch (_) { /* ignore */ }
        };
        try {
            if (window.__ckOnboarding && typeof window.__ckOnboarding.acquire === 'function') {
                if (!window.__ckOnboarding.acquire('tour')) {
                    return false;
                }
                lockAcquired = true;
            }
        } catch (_) { /* ignore */ }
        let driver = null;
        try {
            driver = driverFactory({
                animate: true,
                smoothScroll: true,
                showProgress: true,
                stageBackground: 'rgba(8, 16, 32, 0.78)',
                nextBtnText: 'הבא',
                prevBtnText: 'הקודם',
                doneBtnText: 'סיימנו',
                steps,
            });

            // טיימר בטיחות: גם אם אי אפשר לרשום אירועים, לא נשאיר נעילה לנצח
            // (נמנע מצב שבו הוויזארד נחסם לכל הסשן בגלל כשל רישום callback)
            try {
                if (lockAcquired) {
                    safetyTimer = setTimeout(() => release(), 120000);
                }
            } catch (_) { /* ignore */ }

            // 1) ניסיון להירשם לאירוע "destroyed"
            try {
                if (driver && typeof driver.on === 'function') {
                    driver.on('destroyed', release);
                }
            } catch (_) { /* ignore */ }

            // 2) Fallback חזק: עטיפת destroy כדי להבטיח release גם בלי event emitter
            try {
                if (driver && typeof driver.destroy === 'function') {
                    const origDestroy = driver.destroy.bind(driver);
                    driver.destroy = (...args) => {
                        try { return origDestroy(...args); }
                        finally { release(); }
                    };
                }
            } catch (_) { /* ignore */ }

            driver.drive();
        } catch (_) {
            // חשוב: release כאן כדי לא להיתקע עם נעילה אם משהו נשבר לפני שהסיור התחיל באמת
            release();
            return false;
        }
        if (window.ThemeWizard && typeof window.ThemeWizard.watchDriver === 'function') {
            try { window.ThemeWizard.watchDriver(driver); }
            catch (_) { /* ignore */ }
        }
        if (options.auto || options.remember) {
            markSeen();
        }
        return true;
    }
    function waitForWelcomeModal(callback){
        const modal = document.getElementById('welcomeModal');
        if (!modal) {
            callback();
            return;
        }
        const observer = new MutationObserver(() => {
            if (!document.body.contains(modal)) {
                observer.disconnect();
                setTimeout(callback, 300);
            }
        });
        observer.observe(document.body, { childList: true, subtree: true });
    }
    function shouldAutoStart(){
        if (!isLoggedIn || hasSeen()) {
            return false;
        }
        const path = (window.location && window.location.pathname) || '';
        if (!AUTO_PATHS.includes(path)) {
            return false;
        }
        return !!buildSteps();
    }
    function scheduleAutoStart(){
        if (!shouldAutoStart()) {
            return;
        }
        waitForWelcomeModal(() => {
            setTimeout(() => { startTour({ auto: true }); }, 700);
        });
    }
    function exposeControls(){
        try {
            window.CodeKeeperTour = {
                start: () => startTour({ auto: false }),
                reset: () => resetSeen(),
                hasSeen: () => hasSeen(),
            };
        } catch (_) { /* ignore */ }
    }
    function handleUrlTrigger(){
        let triggered = false;
        try {
            const params = new URLSearchParams(window.location.search || '');
            const action = (params.get('tour') || '').toLowerCase();
            if (!action) {
                return false;
            }
            if (action === 'restart' || action === 'start') {
                resetSeen();
                triggered = true;
                waitForWelcomeModal(() => {
                    setTimeout(() => {
                        startTour({ remember: true });
                        try {
                            const url = new URL(window.location.href);
                            url.searchParams.delete('tour');
                            const search = url.searchParams.toString();
                            const clean = url.pathname + (search ? '?' + search : '') + url.hash;
                            window.history.replaceState({}, document.title, clean);
                        } catch (_) {}
                    }, 400);
                });
            }
        } catch (_) { /* ignore */ }
        return triggered;
    }
    function ready(fn){
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', fn, { once: true });
        } else {
            fn();
        }
    }

    ready(() => {
        exposeControls();
        // סנכרון לשרת (כדי למנוע הופעה אקראית במכשיר אחר) אם כבר מסומן לוקאלית
        try {
            if (isLoggedIn && !serverHasSeen && hasSeen()) {
                persistSeenToServer();
            }
        } catch (_) { /* ignore */ }
        const triggered = handleUrlTrigger();
        if (!triggered) {
            scheduleAutoStart();
        }
    });
})();
</script>

    {% if can_impersonate %}
    <script src="{{ url_for('static', filename='js/impersonation.js') }}?v={{ static_version }}"></script>
    {% endif %}
    {% block extra_js %}{% endblock %}
</body>
</html>