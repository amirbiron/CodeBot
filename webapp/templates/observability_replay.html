{% extends "base.html" %}

{% block title %}Incident Replay{% endblock %}

{% block extra_css %}
<style>
.replay-page {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
  color: #fff;
}
.replay-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 1rem;
}
.replay-header h1 {
  font-size: 1.7rem;
  margin: 0;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}
.replay-header .actions {
  display: flex;
  gap: 0.5rem;
}
.replay-header .actions a,
.replay-header .actions button {
  background: rgba(255,255,255,0.08);
  color: #fff;
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 999px;
  padding: 0.45rem 0.9rem;
  text-decoration: none;
  font-size: 0.9rem;
  cursor: pointer;
}
.replay-controls {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  align-items: center;
}
.replay-range-buttons {
  display: flex;
  gap: 0.45rem;
}
.replay-range-buttons button {
  border: none;
  border-radius: 999px;
  padding: 0.35rem 0.85rem;
  background: rgba(255,255,255,0.08);
  color: #fff;
  cursor: pointer;
}
.replay-range-buttons button.active {
  background: linear-gradient(135deg,#ff749c,#ffa34f);
  color: #121826;
  font-weight: 600;
}
.custom-range {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
  align-items: center;
}
.custom-range label {
  font-size: 0.85rem;
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}
.custom-range input {
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 8px;
  color: #fff;
  padding: 0.25rem 0.5rem;
}
.custom-range button {
  border: none;
  border-radius: 999px;
  padding: 0.45rem 1.2rem;
  background: linear-gradient(135deg,#64ffda,#36c2ff);
  color: #0b1224;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 10px 25px rgba(0,0,0,0.35);
  transition: transform 0.15s ease, box-shadow 0.15s ease;
}
.custom-range button:hover {
  transform: translateY(-1px);
  box-shadow: 0 14px 28px rgba(0,0,0,0.45);
}
:root[data-theme="rose-pine-dawn"] .replay-page {
  color: var(--text-primary);
}
:root[data-theme="rose-pine-dawn"] .replay-header h1,
:root[data-theme="rose-pine-dawn"] .replay-header .actions a,
:root[data-theme="rose-pine-dawn"] .replay-header .actions button {
  color: var(--text-primary);
}
:root[data-theme="rose-pine-dawn"] .replay-header .actions a,
:root[data-theme="rose-pine-dawn"] .replay-header .actions button,
:root[data-theme="rose-pine-dawn"] .replay-range-buttons button {
  background: color-mix(in srgb, var(--bg-secondary) 65%, #ffffff 35%);
  border: 1px solid var(--glass-border);
  color: var(--text-primary);
  box-shadow: 0 6px 16px rgba(144,122,169,0.12);
}
:root[data-theme="rose-pine-dawn"] .replay-range-buttons button.active {
  background: linear-gradient(135deg, #d7827e, #907aa9);
  color: #fff;
  border: none;
  box-shadow: 0 10px 20px rgba(144,122,169,0.25);
}
:root[data-theme="rose-pine-dawn"] .custom-range input {
  background: color-mix(in srgb, var(--bg-secondary) 70%, #ffffff 30%);
  border: 1px solid var(--glass-border);
  color: var(--text-primary);
  box-shadow: inset 0 1px 2px rgba(87,82,121,0.12);
}
:root[data-theme="rose-pine-dawn"] .timeline-wrapper {
  background: color-mix(in srgb, #ffffff 75%, var(--bg-secondary) 25%);
  border: 1px solid var(--glass-border);
  box-shadow: 0 14px 32px rgba(144,122,169,0.15);
  color: var(--text-primary);
}
:root[data-theme="rose-pine-dawn"] .timeline-item {
  border-bottom: 1px solid rgba(87,82,121,0.25);
}
:root[data-theme="rose-pine-dawn"] .timeline-item .event-actions a,
:root[data-theme="rose-pine-dawn"] .story-viewer__footer a {
  color: var(--primary);
}
:root[data-theme="rose-pine-dawn"] .story-viewer {
  background: color-mix(in srgb, #ffffff 80%, var(--bg-secondary) 20%);
  border: 1px solid var(--glass-border);
  color: var(--text-primary);
}
.timeline-wrapper {
  background: rgba(18,24,38,0.78);
  border-radius: 18px;
  border: 1px solid rgba(255,255,255,0.08);
  padding: 1.25rem;
  box-shadow: 0 15px 35px rgba(0,0,0,0.35);
}
.replay-layout {
  display: grid;
  grid-template-columns: minmax(0, 2fr) minmax(320px, 1fr);
  gap: 1.25rem;
  align-items: flex-start;
}
.runbook-panel {
  background: rgba(18,24,38,0.78);
  border-radius: 18px;
  border: 1px solid rgba(255,255,255,0.08);
  padding: 1rem;
  min-height: 260px;
  box-shadow: 0 15px 35px rgba(0,0,0,0.35);
}
.runbook-card {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}
.runbook-head {
  display: flex;
  justify-content: space-between;
  gap: 1rem;
}
.runbook-title {
  font-size: 1.05rem;
  font-weight: 600;
  margin: 0;
}
.runbook-desc {
  font-size: 0.85rem;
  opacity: 0.75;
  margin-top: 0.15rem;
}
.runbook-progress {
  text-align: right;
  font-size: 0.9rem;
}
.runbook-progress small {
  display: block;
  font-size: 0.75rem;
  opacity: 0.7;
}
.runbook-steps {
  display: flex;
  flex-direction: column;
  gap: 0.6rem;
}
.runbook-step {
  display: flex;
  gap: 0.6rem;
  border-radius: 12px;
  background: rgba(255,255,255,0.04);
  padding: 0.5rem 0.75rem;
}
.runbook-step input[type="checkbox"] {
  width: 18px;
  height: 18px;
  margin-top: 0.35rem;
}
.runbook-step__title {
  font-size: 0.95rem;
  font-weight: 600;
}
.runbook-step__desc {
  font-size: 0.85rem;
  opacity: 0.8;
  margin-top: 0.15rem;
}
.runbook-actions {
  border-top: 1px solid rgba(255,255,255,0.08);
  padding-top: 0.75rem;
}
.runbook-actions__title {
  font-size: 0.9rem;
  opacity: 0.8;
  margin-bottom: 0.4rem;
}
.runbook-actions__list {
  display: flex;
  flex-wrap: wrap;
  gap: 0.4rem;
}
.runbook-action-btn {
  border: none;
  border-radius: 999px;
  padding: 0.4rem 0.9rem;
  background: linear-gradient(135deg,#64ffda,#36c2ff);
  color: #0b1224;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 12px 24px rgba(12,18,32,0.45);
}
.runbook-empty,
.runbook-error {
  text-align: center;
  opacity: 0.75;
  font-size: 0.9rem;
  padding: 1rem 0;
}
.timeline-item.selected {
  background: rgba(255,255,255,0.05);
  border-radius: 12px;
}
.timeline-list {
  list-style: none;
  margin: 0;
  padding: 0;
}
.timeline-item {
  display: grid;
  grid-template-columns: 120px 1fr;
  gap: 1rem;
  padding: 1rem 0;
  border-bottom: 1px solid rgba(255,255,255,0.08);
}
.timeline-item:last-child {
  border-bottom: none;
}
.timeline-item .event-time {
  font-size: 0.85rem;
  opacity: 0.75;
}
.timeline-item .event-body {
  min-width: 0;
}
.timeline-item .event-title {
  font-size: 1rem;
  margin: 0;
}
.timeline-item .event-meta {
  font-size: 0.85rem;
  opacity: 0.75;
  margin-top: 0.2rem;
  display: flex;
  gap: 0.6rem;
  flex-wrap: wrap;
}
.timeline-item .event-summary {
  margin-top: 0.4rem;
  font-size: 0.9rem;
  opacity: 0.9;
}
.timeline-item .event-actions {
  margin-top: 0.6rem;
}
.timeline-item .event-actions a {
  color: #64ffda;
  text-decoration: none;
  font-size: 0.9rem;
}
.timeline-item[data-type="deployment"] {
  border-color: rgba(255,196,77,0.35);
}
.timeline-item[data-type="chatops"] {
  border-color: rgba(100,255,218,0.35);
}
.story-view-btn {
  border: none;
  border-radius: 999px;
  padding: 0.35rem 0.9rem;
  background: linear-gradient(135deg,#64ffda,#36c2ff);
  color: #0b1224;
  font-weight: 600;
  cursor: pointer;
  margin-inline-end: 0.4rem;
  box-shadow: 0 12px 28px rgba(12,18,32,0.45);
}
.story-view-btn:hover {
  opacity: 0.95;
}
.story-viewer-modal {
  position: fixed;
  inset: 0;
  background: rgba(3,6,12,0.85);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 3200;
}
.story-viewer-modal[hidden] {
  display: none;
}
.story-viewer {
  width: min(700px, 95vw);
  max-height: 92vh;
  overflow-y: auto;
  background: rgba(12,18,32,0.96);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 20px;
  padding: 1.4rem;
  box-shadow: 0 30px 60px rgba(0,0,0,0.6);
}
.story-viewer__header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 1rem;
  margin-bottom: 1rem;
}
.story-viewer__header h3 {
  margin: 0;
}
.story-viewer__meta {
  font-size: 0.85rem;
  opacity: 0.75;
  margin-top: 0.2rem;
}
.story-viewer__close {
  background: transparent;
  border: none;
  color: #fff;
  font-size: 1.2rem;
  cursor: pointer;
}
.story-viewer__row {
  display: flex;
  justify-content: space-between;
  gap: 1rem;
  font-size: 0.9rem;
}
.story-viewer__label {
  opacity: 0.7;
}
.story-viewer__value {
  font-weight: 500;
  white-space: pre-line;
  line-height: 1.5;
}
.story-viewer__section {
  margin-top: 1rem;
}
.story-viewer__section h4 {
  margin: 0 0 0.3rem;
  font-size: 1rem;
}
.story-viewer__list {
  list-style: disc;
  padding-inline-start: 1.2rem;
  margin: 0.4rem 0;
}
.story-viewer__list li {
  white-space: pre-line;
  line-height: 1.5;
}
.story-viewer__muted {
  opacity: 0.65;
}
.story-viewer__footer {
  margin-top: 1.2rem;
  display: flex;
  justify-content: flex-end;
}
.story-viewer__footer a {
  color: #64ffda;
  text-decoration: none;
  font-weight: 500;
}
.empty-state {
  text-align: center;
  padding: 2rem 0;
  opacity: 0.8;
}
@media (max-width: 1200px) {
  .replay-layout {
    grid-template-columns: 1fr;
  }
}
@media (max-width: 768px) {
  .timeline-item {
    grid-template-columns: 1fr;
  }
  .timeline-item .event-time {
    font-weight: 500;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="replay-page" dir="rtl">
  <div class="replay-header">
    <h1>âª Incident Replay</h1>
    <div class="actions">
      <a href="/admin/observability">×—×–×¨×” ×œ×œ×•×—</a>
      <button id="shareReplayBtn">ğŸ”— ×”×¢×ª×§ ×§×™×©×•×¨</button>
    </div>
  </div>

  <div class="replay-controls">
    <div class="replay-range-buttons" id="replayRangeButtons">
      <button data-range="1h">1 ×©×¢×”</button>
      <button data-range="3h">3 ×©×¢×•×ª</button>
      <button data-range="24h">24 ×©×¢×•×ª</button>
      <button data-range="7d">7 ×™××™×</button>
    </div>
    <div class="custom-range">
      <label>
        ×”×ª×—×œ×”
        <input type="datetime-local" id="startInput" value="{{ initial_start|default('', true) }}">
      </label>
      <label>
        ×¡×™×•×
        <input type="datetime-local" id="endInput" value="{{ initial_end|default('', true) }}">
      </label>
      <button id="applyCustomRange">×¢×“×›×Ÿ</button>
    </div>
  </div>

  <div class="replay-layout">
    <div class="timeline-wrapper">
      <div class="timeline-head">
        <div id="timelineSummary" style="font-size:0.9rem; opacity:0.8; margin-bottom:0.8rem;">×˜×•×¢×Ÿ × ×ª×•× ×™×â€¦</div>
      </div>
      <ul class="timeline-list" id="timelineList">
        <li class="empty-state">×˜×•×¢×Ÿ ××™×¨×•×¢×™×â€¦</li>
      </ul>
    </div>
    <div class="runbook-panel" id="runbookPanel">
      <div class="runbook-empty">×‘×—×¨ ××™×¨×•×¢ ×›×“×™ ×œ×˜×¢×•×Ÿ Runbook.</div>
    </div>
  </div>
</div>

<div id="storyViewerModal" class="story-viewer-modal" hidden>
  <div class="story-viewer" role="dialog" aria-modal="true" aria-labelledby="storyViewerTitle">
    <div class="story-viewer__header">
      <div>
        <h3 id="storyViewerTitle">×¡×™×¤×•×¨ ××™×¨×•×¢</h3>
        <div class="story-viewer__meta" id="storyViewerMeta">â€”</div>
      </div>
      <button type="button" class="story-viewer__close" data-story-viewer-close aria-label="×¡×’×•×¨">âœ•</button>
    </div>
    <div class="story-viewer__row">
      <span class="story-viewer__label">×˜×•×•×— ×–××Ÿ</span>
      <span class="story-viewer__value" id="storyViewerWindow">â€”</span>
    </div>
    <div class="story-viewer__row">
      <span class="story-viewer__label">××“×“ ×’×¨×¤×™</span>
      <span class="story-viewer__value" id="storyViewerGraph">â€”</span>
    </div>
    <div class="story-viewer__section">
      <h4>ğŸ‘€ ××” ×¨××™× ×•</h4>
      <p id="storyViewerWhatSaw" class="story-viewer__value">â€”</p>
    </div>
    <div class="story-viewer__section">
      <h4>ğŸ› ï¸ ××” ×¢×©×™× ×•</h4>
      <ul id="storyViewerActions" class="story-viewer__list story-viewer__muted"></ul>
    </div>
    <div class="story-viewer__section">
      <h4>ğŸ’» ×œ×•×’×™× / ×¤×§×•×“×•×ª</h4>
      <ul id="storyViewerLogs" class="story-viewer__list story-viewer__muted"></ul>
    </div>
    <div class="story-viewer__section">
      <h4>ğŸ’¡ ×ª×•×‘× ×•×ª</h4>
      <p id="storyViewerInsights" class="story-viewer__value">â€”</p>
    </div>
    <div class="story-viewer__footer">
      <a id="storyViewerEditLink" target="_blank" rel="noopener">×¤×ª×— ×‘×œ×•×—</a>
    </div>
  </div>
</div>

<script>
(() => {
  const state = {
    range: '{{ default_range|default("3h", true) }}',
    start: '{{ initial_start|default('', true) }}',
    end: '{{ initial_end|default('', true) }}',
    focus: '{{ initial_focus|default('', true) }}',
    selectedEventId: '',
    eventsMap: {}
  };

  const timelineSummaryEl = document.getElementById('timelineSummary');
  const timelineListEl = document.getElementById('timelineList');
  const rangeButtons = document.querySelectorAll('#replayRangeButtons button');
  const storyViewer = createStoryViewer();
  const runbookPanel = document.getElementById('runbookPanel');

  function markActiveRange(rangeValue) {
    rangeButtons.forEach(b => {
      if (b.dataset.range === rangeValue) {
        b.classList.add('active');
      } else {
        b.classList.remove('active');
      }
    });
  }
  markActiveRange(state.range);

  rangeButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      markActiveRange(btn.dataset.range);
      state.range = btn.dataset.range || '3h';
      state.start = '';
      state.end = '';
      document.getElementById('startInput').value = '';
      document.getElementById('endInput').value = '';
      loadTimelineWithGuard();
    });
  });

  document.getElementById('applyCustomRange').addEventListener('click', () => {
    state.range = '';
    markActiveRange('');
    state.start = document.getElementById('startInput').value;
    state.end = document.getElementById('endInput').value;
    loadTimelineWithGuard();
  });

  document.getElementById('shareReplayBtn').addEventListener('click', async () => {
    try {
      const params = new URLSearchParams();
      if (state.range) params.set('timerange', state.range);
      if (state.start) params.set('start', state.start);
      if (state.end) params.set('end', state.end);
      if (state.focus) params.set('focus_ts', state.focus);
      const shareUrl = `${window.location.origin}/admin/observability/replay?${params.toString()}`;
      await navigator.clipboard.writeText(shareUrl);
      showShareToast('×”×§×™×©×•×¨ ×”×•×¢×ª×§ ×œ×œ×•×—');
    } catch (err) {
      console.error('share link failed', err);
    }
  });

  function showShareToast(text) {
    const toast = document.createElement('div');
    toast.textContent = text;
    toast.style.position = 'fixed';
    toast.style.bottom = '24px';
    toast.style.left = '50%';
    toast.style.transform = 'translateX(-50%)';
    toast.style.background = 'rgba(0,0,0,0.7)';
    toast.style.color = '#fff';
    toast.style.padding = '0.6rem 1rem';
    toast.style.borderRadius = '999px';
    toast.style.zIndex = '999';
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2200);
  }

  function setRunbookEmpty(message = '×‘×—×¨ ××™×¨×•×¢ ×›×“×™ ×œ×˜×¢×•×Ÿ Runbook.') {
    if (!runbookPanel) return;
    runbookPanel.dataset.loading = '0';
    runbookPanel.innerHTML = `<div class="runbook-empty">${message}</div>`;
  }

  function setRunbookLoading() {
    if (!runbookPanel) return;
    runbookPanel.dataset.loading = '1';
    runbookPanel.innerHTML = '<div class="runbook-empty">×˜×•×¢×Ÿ Runbookâ€¦</div>';
  }

  function renderRunbookError() {
    setRunbookEmpty('×©×’×™××” ×‘×˜×¢×™× ×ª ×”-Runbook. × ×¡×” ×©×•×‘.');
  }

  function renderRunbookActionButton(action, eventMeta) {
    if (!action || !action.id) return '';
    const eventAlertType = (eventMeta && (eventMeta.alert_type || (eventMeta.metadata && eventMeta.metadata.alert_type))) || '';
    const payload = encodeURIComponent(JSON.stringify({
      action,
      alert: {
        alert_uid: eventMeta.id,
        alert_type: eventAlertType,
        severity: eventMeta.severity,
        timestamp: eventMeta.timestamp,
        summary: eventMeta.summary,
      }
    }));
    return `<button type="button" class="runbook-action-btn" data-qf="${payload}">${action.label || '×¤×¢×•×œ×”'}</button>`;
  }

  function renderRunbookPanel(payload) {
    if (!runbookPanel) return;
    const eventMeta = payload.event || {};
    if (eventMeta.id) {
      state.eventsMap[eventMeta.id] = Object.assign({}, state.eventsMap[eventMeta.id], eventMeta);
      state.selectedEventId = eventMeta.id;
      runbookPanel.dataset.eventId = eventMeta.id;
      highlightSelectedTimeline();
    }
    const runbook = payload.runbook;
    if (!runbook) {
      setRunbookEmpty('×œ× ×”×•×’×“×¨ Runbook ×¡×¤×¦×™×¤×™ ×œ××™×¨×•×¢ ×”×–×”.');
      return;
    }
    const progress = runbook.progress || {};
    const steps = Array.isArray(runbook.steps) ? runbook.steps : [];
    const stepsMarkup = steps.length
      ? steps
          .map(step => {
            const stepId = step.id || '';
            return `
              <label class="runbook-step" data-step="${stepId}">
                <input type="checkbox" ${step.completed ? 'checked' : ''} ${stepId ? '' : 'disabled'}>
                <div>
                  <div class="runbook-step__title">${step.title || '×¦×¢×“'}</div>
                  <div class="runbook-step__desc">${step.description || ''}</div>
                </div>
              </label>
            `;
          })
          .join('')
      : '<div class="runbook-empty">××™×Ÿ ×¦×¢×“×™× ××•×’×“×¨×™×.</div>';
    const actions = Array.isArray(payload.actions) ? payload.actions : [];
    const actionsMarkup = actions.length
      ? `
        <div class="runbook-actions">
          <div class="runbook-actions__title">Quick Fix</div>
          <div class="runbook-actions__list">
            ${actions.map(action => renderRunbookActionButton(action, eventMeta)).join('')}
          </div>
        </div>
      `
      : '';
    runbookPanel.dataset.loading = '0';
    runbookPanel.innerHTML = `
      <div class="runbook-card">
        <div class="runbook-head">
          <div>
            <div class="runbook-title">${runbook.title || 'Runbook'}</div>
            <div class="runbook-desc">${runbook.description || ''}</div>
          </div>
          <div class="runbook-progress">
            <span>${progress.completed || 0}/${progress.total || 0}</span>
            <small>${Math.round(progress.percent || 0)}%</small>
          </div>
        </div>
        <div class="runbook-steps">
          ${stepsMarkup}
        </div>
        ${actionsMarkup}
      </div>
    `;
    const targetEventId = eventMeta.id || state.selectedEventId || '';
    bindRunbookStepToggles(targetEventId, steps, eventMeta);
    bindRunbookActionButtons();
  }

  function serializeEventForApi(evt) {
    if (!evt) return null;
    const meta = Object.assign({}, evt.metadata || {});
    const eventId = evt.id || evt.alert_uid || '';
    if (!eventId) {
      return null;
    }
    if (!meta.alert_type && evt.alert_type) {
      meta.alert_type = evt.alert_type;
    }
    if (evt.endpoint && !meta.endpoint) {
      meta.endpoint = evt.endpoint;
    }
    if (evt.source && !meta.source) {
      meta.source = evt.source;
    }
    return {
      id: eventId,
      type: evt.type,
      severity: evt.severity,
      title: evt.title,
      summary: evt.summary,
      timestamp: evt.timestamp,
      alert_type: evt.alert_type || meta.alert_type,
      endpoint: evt.endpoint || meta.endpoint,
      source: evt.source || meta.source,
      link: evt.link,
      metadata: meta,
    };
  }

  function bindRunbookStepToggles(eventId, steps, eventMeta) {
    if (!runbookPanel || !eventId || !Array.isArray(steps)) return;
    const meta = eventMeta || state.eventsMap[eventId];
    const validSteps = new Set(steps.map(step => step.id).filter(Boolean));
    runbookPanel.querySelectorAll('.runbook-step input[type="checkbox"]').forEach(input => {
      const container = input.closest('.runbook-step');
      const stepId = container ? container.dataset.step : '';
      if (!stepId || !validSteps.has(stepId)) {
        input.disabled = true;
        return;
      }
      input.addEventListener('change', () => {
        updateRunbookStatus(eventId, stepId, input.checked, meta);
      });
    });
  }

  function bindRunbookActionButtons() {
    if (!runbookPanel) return;
    runbookPanel.querySelectorAll('.runbook-action-btn').forEach(btn => {
      if (btn.dataset.bound === '1') return;
      btn.dataset.bound = '1';
      btn.addEventListener('click', () => {
        const payload = btn.dataset.qf;
        if (!payload) return;
        try {
          const parsed = JSON.parse(decodeURIComponent(payload));
          handleRunbookAction(parsed.action, parsed.alert, btn);
        } catch (err) {
          console.error('runbook_action_parse_failed', err);
        }
      });
    });
  }

  async function handleRunbookAction(action, alertMeta, btn) {
    if (!action || !action.id) return;
    try {
      if (btn) btn.disabled = true;
      const kind = (action.type || '').toLowerCase();
      if (kind === 'copy' && action.payload) {
        await navigator.clipboard.writeText(action.payload);
        showShareToast('×”×¤×§×•×“×” ×”×•×¢×ª×§×” ×œ×œ×•×—');
      } else if (action.href) {
        window.open(action.href, '_blank', 'noopener');
      }
      await trackQuickFixAction(action, alertMeta);
    } catch (err) {
      console.error('runbook_action_failed', err);
      showShareToast('×©×’×™××” ×‘×‘×™×¦×•×¢ ×”×¤×¢×•×œ×”');
    } finally {
      if (btn) btn.disabled = false;
    }
  }

  async function trackQuickFixAction(action, alertMeta) {
    try {
      await fetch('/api/observability/quickfix/track', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          action_id: action.id,
          action_label: action.label,
          alert: alertMeta,
        }),
      });
    } catch (err) {
      console.debug('runbook_action_tracking_skipped', err);
    }
  }

  async function updateRunbookStatus(eventId, stepId, completed, eventMeta) {
    try {
      const eventPayload = serializeEventForApi(eventMeta || state.eventsMap[eventId]);
      const res = await fetch(`/api/observability/runbook/${encodeURIComponent(eventId)}/status`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          step_id: stepId,
          completed,
          event: eventPayload,
        }),
      });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const payload = await res.json();
      if (payload.ok === false) throw new Error(payload.error || 'status_failed');
      renderRunbookPanel(payload);
    } catch (err) {
      console.error('runbook_status_failed', err);
      showShareToast('×©××™×¨×ª Runbook × ×›×©×œ×”');
    }
  }

  function createStoryViewer() {
    const modal = document.getElementById('storyViewerModal');
    if (!modal) return null;
    const els = {
      modal,
      title: document.getElementById('storyViewerTitle'),
      meta: document.getElementById('storyViewerMeta'),
      window: document.getElementById('storyViewerWindow'),
      graph: document.getElementById('storyViewerGraph'),
      whatSaw: document.getElementById('storyViewerWhatSaw'),
      actions: document.getElementById('storyViewerActions'),
      logs: document.getElementById('storyViewerLogs'),
      insights: document.getElementById('storyViewerInsights'),
      editLink: document.getElementById('storyViewerEditLink'),
    };

    function closeViewer() {
      modal.hidden = true;
    }

    modal.addEventListener('click', evt => {
      if (evt.target === modal) {
        closeViewer();
      }
    });
    modal.querySelectorAll('[data-story-viewer-close]').forEach(btn => {
      btn.addEventListener('click', closeViewer);
    });
    document.addEventListener('keydown', evt => {
      if (evt.key === 'Escape' && !modal.hidden) {
        closeViewer();
      }
    });

    function setViewerLoading() {
      if (els.title) els.title.textContent = '×˜×•×¢×Ÿ ×¡×™×¤×•×¨...';
      if (els.meta) els.meta.textContent = '';
      if (els.window) els.window.textContent = '...';
      if (els.graph) els.graph.textContent = '...';
      if (els.whatSaw) els.whatSaw.textContent = '';
      if (els.actions) els.actions.innerHTML = '<li class="story-viewer__muted">×˜×•×¢×Ÿ...</li>';
      if (els.logs) els.logs.innerHTML = '';
      if (els.insights) els.insights.textContent = '';
    }

    function setViewerError() {
      if (els.title) els.title.textContent = '×©×’×™××” ×‘×˜×¢×™× ×ª ×”×¡×™×¤×•×¨';
      if (els.meta) els.meta.textContent = '';
      if (els.window) els.window.textContent = 'â€”';
      if (els.graph) els.graph.textContent = 'â€”';
      if (els.actions) els.actions.innerHTML = '<li class="story-viewer__muted">×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ ××ª ×”×¡×™×¤×•×¨</li>';
      if (els.logs) els.logs.innerHTML = '';
      if (els.insights) els.insights.textContent = '';
    }

    function renderList(target, items, emptyText) {
      if (!target) return;
      if (!items.length) {
        target.innerHTML = `<li class="story-viewer__muted">${emptyText}</li>`;
        return;
      }
      target.innerHTML = items.join('');
    }

    function renderStory(story) {
      const data = story || {};
      if (els.title) els.title.textContent = data.alert_name || data.summary || '×¡×™×¤×•×¨ ××™×¨×•×¢';
      const severity = (data.severity || 'info').toUpperCase();
      const uid = data.alert_uid || data.story_id || '';
      if (els.meta) els.meta.textContent = uid ? `[${severity}] ${uid}` : `[${severity}]`;
      if (els.window) els.window.textContent = formatWindowLabel(
        (data.time_window || {}).start,
        (data.time_window || {}).end
      );
      const graph = (data.what_we_saw || {}).graph_snapshot;
      if (els.graph) {
        if (graph && (graph.metric || graph.label)) {
          const points = Array.isArray(graph.series) ? graph.series.length : 0;
          const range = graph.range_minutes != null ? graph.range_minutes : 'â€”';
          els.graph.textContent = `${graph.label || graph.metric} Â· ${points} × ×§×•×“×•×ª Â· ${range} ×“×§'`;
        } else {
          els.graph.textContent = 'â€”';
        }
      }
      if (els.whatSaw) {
        els.whatSaw.textContent = (data.what_we_saw || {}).description || 'â€”';
      }
      const autoActions = ((data.what_we_did || {}).auto_actions || []).map(action => {
        const ts = action.timestamp ? formatTime(action.timestamp) : '';
        const suffix = ts ? ` (${ts})` : '';
        return `<li>${action.label || '×¤×¢×•×œ×”'}${suffix}</li>`;
      });
      if ((data.what_we_did || {}).manual_notes) {
        autoActions.push(`<li>${data.what_we_did.manual_notes}</li>`);
      }
      renderList(els.actions, autoActions, '×œ× ×ª×•×¢×“×• ×¤×¢×•×œ×•×ª');
      const logs = (data.logs || []).map(log => `<li><strong>${log.source || 'log'}:</strong> ${log.content || ''}</li>`);
      renderList(els.logs, logs, '××™×Ÿ ×œ×•×’×™× ×–××™× ×™×');
      if (els.insights) els.insights.textContent = data.insights || 'â€”';
      if (els.editLink) {
        if (data.story_id) {
          const params = new URLSearchParams({ story_id: data.story_id });
          if (data.alert_timestamp) params.set('focus_ts', data.alert_timestamp);
          els.editLink.href = `/admin/observability?${params.toString()}`;
          els.editLink.style.display = 'inline-flex';
        } else {
          els.editLink.style.display = 'none';
        }
      }
    }

    return {
      async open(storyId) {
        if (!storyId) return;
        modal.hidden = false;
        setViewerLoading();
        try {
          const res = await fetch(`/api/observability/stories/${storyId}`);
          if (!res.ok) throw new Error('fetch_failed');
          const payload = await res.json();
          if (payload.ok === false) throw new Error(payload.error || 'fetch_failed');
          renderStory(payload.story || {});
        } catch (err) {
          console.error('story_viewer_load_failed', err);
          setViewerError();
        }
      },
    };
  }

  function formatTime(ts) {
    if (!ts) return 'â€”';
    try {
      return new Date(ts).toLocaleString('he-IL', { hour12: false, timeZone: 'Asia/Jerusalem' });
    } catch (err) {
      return ts;
    }
  }

  function formatWindowLabel(start, end) {
    const startLabel = start ? formatTime(start) : '';
    const endLabel = end ? formatTime(end) : '';
    if (startLabel && endLabel) {
      return `${startLabel} â†’ ${endLabel}`;
    }
    return startLabel || endLabel || 'â€”';
  }

  function buildQuery() {
    const params = new URLSearchParams();
    if (state.range && !(state.start || state.end)) params.set('timerange', state.range);
    if (state.start) params.set('start_time', state.start);
    if (state.end) params.set('end_time', state.end);
    return params.toString();
  }

  function showLoadingState() {
    timelineSummaryEl.textContent = '×˜×•×¢×Ÿ × ×ª×•× ×™×â€¦';
    timelineListEl.innerHTML = '<li class="empty-state">×˜×•×¢×Ÿ ××™×¨×•×¢×™×â€¦</li>';
  }

  function handleTimelineError(err) {
    console.error('replay load failed', err);
    timelineListEl.innerHTML = '<li class="empty-state">×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×.</li>';
    timelineSummaryEl.textContent = '×©×’×™××” ×‘×˜×¢×™× ×ª ×¦×™×¨ ×”×–××Ÿ';
  }

  async function loadTimeline() {
    showLoadingState();
    const query = buildQuery();
    const res = await fetch(`/api/observability/replay?${query}`, {headers: {'Accept': 'application/json'}});
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const payload = await res.json();
    if (payload.ok === false) throw new Error(payload.error || 'replay_error');
    renderTimeline(payload.events || [], payload.counts || {}, payload.window || {});
  }

  function renderTimeline(events, counts, windowInfo) {
    timelineSummaryEl.textContent = `×¡×”"×› ${counts.alerts || 0} ×”×ª×¨××•×ª, ${counts.deployments || 0} ×“×™×¤×œ×•×™×× ×˜×™×, ${counts.chatops || 0} ×¤×¢×•×œ×•×ª ChatOps, ${counts.stories || 0} ×¡×™×¤×•×¨×™×`;
    const list = timelineListEl;
    if (!events.length) {
      list.innerHTML = '<li class="empty-state">×œ× × ××¦××• ××™×¨×•×¢×™× ×‘×˜×•×•×— ×”× ×‘×—×¨.</li>';
      state.eventsMap = {};
      state.selectedEventId = '';
      setRunbookEmpty();
      return;
    }
    state.eventsMap = {};
    list.innerHTML = events.map(evt => {
      if (evt.id) {
        state.eventsMap[evt.id] = evt;
      }
      const metaParts = [];
      if (evt.type === 'deployment') metaParts.push('Deployment');
      if (evt.metadata && evt.metadata.alert_type) metaParts.push(evt.metadata.alert_type);
      if (evt.metadata && evt.metadata.endpoint) metaParts.push(evt.metadata.endpoint);
      if (evt.type === 'story') metaParts.push('Incident Story');
      if (evt.metadata && evt.metadata.has_runbook) metaParts.push('Runbook');
      const actionLabel = evt.type === 'story' ? '×¤×ª×— ×¡×™×¤×•×¨' : '×¤×ª×— ×”×§×©×¨';
      const hasStory = evt.type === 'story' && evt.metadata && evt.metadata.story_id;
      const eventId = evt.id || '';
      const actionMarkup = hasStory
        ? `
            <button type="button" class="story-view-btn" data-story-id="${evt.metadata.story_id}">×¤×ª×— ×¡×™×¤×•×¨</button>
            <a href="${evt.link || '/admin/observability'}" target="_blank" rel="noopener">×¢×¨×•×š ×‘×œ×•×—</a>
          `
        : `<a href="${evt.link || '/admin/observability'}" target="_blank" rel="noopener">${actionLabel}</a>`;
      return `
        <li class="timeline-item" data-type="${evt.type}" data-event-id="${eventId}" tabindex="0">
          <div class="event-time">${formatTime(evt.timestamp)}</div>
          <div class="event-body">
            <div class="event-title">${evt.title || '××™×¨×•×¢'}</div>
            <div class="event-meta">${metaParts.join(' â€¢ ')}</div>
            <div class="event-summary">${evt.summary || ''}</div>
            <div class="event-actions">
              ${actionMarkup}
            </div>
          </div>
        </li>
      `;
    }).join('');
    bindStoryButtons();
    bindTimelineInteractions();
    highlightSelectedTimeline();
    if (!state.selectedEventId) {
      setRunbookEmpty();
    } else if (!state.eventsMap[state.selectedEventId]) {
      state.selectedEventId = '';
      setRunbookEmpty();
    }
  }

  function bindTimelineInteractions() {
    document.querySelectorAll('.timeline-item').forEach(item => {
      if (item.dataset.timelineBound === '1') return;
      item.dataset.timelineBound = '1';
      item.addEventListener('click', () => {
        if (item.dataset.eventId) {
          selectTimelineEvent(item.dataset.eventId);
        }
      });
      item.addEventListener('keydown', evt => {
        if ((evt.key === 'Enter' || evt.key === ' ') && item.dataset.eventId) {
          evt.preventDefault();
          selectTimelineEvent(item.dataset.eventId);
        }
      });
    });
    document.querySelectorAll('.timeline-item .event-actions a').forEach(link => {
      link.addEventListener('click', evt => evt.stopPropagation());
    });
  }

  function highlightSelectedTimeline() {
    document.querySelectorAll('.timeline-item').forEach(item => {
      item.classList.toggle('selected', item.dataset.eventId === state.selectedEventId);
    });
  }

  function selectTimelineEvent(eventId) {
    const evt = state.eventsMap[eventId];
    if (!evt) return;
    state.selectedEventId = eventId;
    state.focus = evt.timestamp || state.focus;
    highlightSelectedTimeline();
    loadRunbookForEvent(evt);
  }

  async function loadRunbookForEvent(evt) {
    if (!evt || !evt.id || !runbookPanel) return;
    runbookPanel.dataset.eventId = evt.id;
    setRunbookLoading();
    try {
      const params = new URLSearchParams();
      if (evt.metadata && evt.metadata.alert_type) params.set('alert_type', evt.metadata.alert_type);
      if (evt.metadata && evt.metadata.endpoint) params.set('endpoint', evt.metadata.endpoint);
      if (evt.metadata && evt.metadata.source) params.set('source', evt.metadata.source);
      if (evt.severity) params.set('severity', evt.severity);
      if (evt.summary) params.set('summary', evt.summary);
      if (evt.title) params.set('title', evt.title);
      if (evt.timestamp) params.set('timestamp', evt.timestamp);
      if (evt.link) params.set('link', evt.link);
      const qs = params.toString();
      const res = await fetch(`/api/observability/runbook/${encodeURIComponent(evt.id)}${qs ? `?${qs}` : ''}`, {
        headers: {'Accept': 'application/json'},
      });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const payload = await res.json();
      if (payload.ok === false) throw new Error(payload.error || 'runbook_error');
      renderRunbookPanel(payload);
    } catch (err) {
      console.error('runbook_load_failed', err);
      renderRunbookError();
    }
  }

  function bindStoryButtons() {
    if (!storyViewer) return;
    document.querySelectorAll('.story-view-btn').forEach(btn => {
      if (btn.dataset.storyBound === '1') return;
      btn.dataset.storyBound = '1';
      btn.addEventListener('click', event => {
        event.stopPropagation();
        const storyId = btn.dataset.storyId;
        if (storyId) {
          storyViewer.open(storyId);
        }
      });
    });
  }

  function loadTimelineWithGuard() {
    loadTimeline().catch(handleTimelineError);
  }

  loadTimelineWithGuard();
})();
</script>
{% endblock %}
