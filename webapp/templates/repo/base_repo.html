{% extends "base.html" %}

{% block favicons %}
<!-- Repo Browser Favicon (only for /repo/*) -->
<link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='icons/repo-favicon.ico') }}?v={{ static_version }}">
<link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='icons/favicon-32.png') }}?v={{ static_version }}">
<link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='icons/favicon-16.png') }}?v={{ static_version }}">
<link rel="shortcut icon" href="{{ url_for('static', filename='icons/repo-favicon.ico') }}?v={{ static_version }}">
{% endblock %}

{% block extra_head %}
<!-- CodeMirror 5 (פשוט יותר לשימוש) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldgutter.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/dialog/dialog.min.css">

<!-- Bootstrap Icons (cdnjs - more reliable) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css">

<!-- Custom Repo Browser Styles -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/repo-browser.css') }}">
{% endblock %}

{% block content %}
<div class="repo-browser-container">
    <!-- Top Search Bar -->
    <div class="repo-search-bar">
        <div class="search-wrapper">
            <i class="bi bi-search search-icon"></i>
            <input type="text" 
                   id="global-search" 
                   class="search-input" 
                   placeholder="חפש קבצים, פונקציות, קוד... (Ctrl+K)"
                   autocomplete="off">
            <div class="search-shortcuts">
                <kbd>Ctrl</kbd><kbd>K</kbd>
            </div>
        </div>
        <div class="repo-info">
            <span class="repo-name">
                <i class="bi bi-github"></i>
                {{ repo_name }}
            </span>
            {% if metadata %}
            <span class="repo-stats">
                <i class="bi bi-file-code"></i> {{ metadata.total_files | default(0) }} files
            </span>
            {% endif %}
        </div>
    </div>

    <!-- Search Results Dropdown -->
    <div id="search-results-dropdown" class="search-results-dropdown hidden">
        <div class="search-results-list"></div>
    </div>

    <!-- Main Content: Split Pane -->
    <div class="repo-main-content">
        <!-- Left: Tree View -->
        <div class="repo-sidebar" id="repo-sidebar">
            <div class="sidebar-header">
                <span class="sidebar-title">
                    <i class="bi bi-folder2-open"></i>
                    Explorer
                </span>
                <div class="sidebar-actions">
                    <button class="btn-icon" id="filter-toggle" title="Filter by type">
                        <i class="bi bi-funnel"></i>
                        <span class="filter-badge" id="filter-badge" style="display: none;">0</span>
                    </button>
                    <button class="btn-icon" id="collapse-all" title="Collapse All">
                        <i class="bi bi-arrows-collapse"></i>
                    </button>
                </div>
            </div>
            
            <!-- File Type Filter Panel -->
            <div class="filter-panel" id="filter-panel" style="display: none;">
                <div class="filter-header">
                    <span>סינון לפי סוג קובץ</span>
                    <div class="filter-actions">
                        <button class="btn-link btn-sm" id="filter-select-all">הכל</button>
                        <button class="btn-link btn-sm" id="filter-clear-all">נקה</button>
                    </div>
                </div>
                <div class="filter-list" id="filter-list">
                    <!-- Will be populated by JavaScript -->
                    <div class="loading-filters">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        <span>טוען...</span>
                    </div>
                </div>
            </div>
            <div class="tree-view-container" id="tree-view">
                {% block tree_content %}
                <!-- Tree will be loaded here -->
                <div class="loading-tree">
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                    <span>Loading...</span>
                </div>
                {% endblock %}
            </div>
            <div class="sidebar-footer">
                {% if metadata %}
                <div class="stats-mini">
                    <span title="Python files"><i class="bi bi-filetype-py"></i> {{ metadata.get('file_types', {}).get('python', 0) }}</span>
                    <span title="JavaScript files"><i class="bi bi-filetype-js"></i> {{ metadata.get('file_types', {}).get('javascript', 0) }}</span>
                    <span title="Total files"><i class="bi bi-files"></i> {{ metadata.total_files | default(0) }}</span>
                </div>
                {% else %}
                <div class="stats-mini">
                    <span class="text-muted">Sync required</span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Resizer -->
        <div class="resizer" id="sidebar-resizer"></div>

        <!-- Right: Code Viewer -->
        <div class="repo-content" id="repo-content">
            {% block code_content %}
            <!-- Content will be loaded here -->
            <div class="welcome-screen">
                <div class="welcome-icon">
                    <i class="bi bi-code-square"></i>
                </div>
                <h3>ברוכים הבאים לדפדפן הקוד</h3>
                <p>בחר קובץ מהעץ משמאל, או השתמש בחיפוש למעלה</p>
                <div class="quick-actions">
                    <button class="btn btn-outline-primary" onclick="focusSearch()">
                        <i class="bi bi-search"></i>
                        חפש (Ctrl+K)
                    </button>
                </div>
            </div>
            {% endblock %}
        </div>
    </div>
</div>

<!-- CodeMirror Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/htmlmixed/htmlmixed.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/css/css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/yaml/yaml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/markdown/markdown.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/shell/shell.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/sql/sql.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldgutter.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/brace-fold.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/indent-fold.min.js"></script>
<!-- Search addon for Ctrl+F -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/search/search.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/search/searchcursor.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/search/jump-to-line.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/dialog/dialog.min.js"></script>

<!-- Custom Scripts -->
<script src="{{ url_for('static', filename='js/repo-browser.js') }}"></script>
{% endblock %}
