{% extends "base.html" %}

{% block title %}{{ file.file_name }} - Code Keeper Bot{% endblock %}

{% block extra_css %}
<style id="syntax-css"></style>
<style>

.source {
    background: #1e1e1e !important;
    border-radius: 10px;
    padding: 1.5rem !important;
    overflow-x: auto;
    font-family: 'Fira Code', 'Consolas', 'Monaco', monospace;
    font-size: 14px;
    line-height: 1.6;
    direction: ltr;
    text-align: left;
    width: 100%;
}
.source .highlight,
.source .highlight pre {
    width: 100% !important;
    max-width: 100% !important;
    overflow: auto;
}

.source pre {
    margin: 0;
}

.linenodiv {
    margin-right: 1rem;
    user-select: none;
    opacity: 0.5;
}

/* ×¤×¨×™×¡×” ×˜×•×‘×” ×™×•×ª×¨ ×œ-Pygments highlighttable (××¡×¤×¨×™ ×©×•×¨×•×ª + ×§×•×“) */
.highlighttable {
    width: 100% !important;
    table-layout: fixed;
    border-collapse: separate;
    border-spacing: 0;
}
.highlighttable td.linenos {
    width: 3.5rem;
    vertical-align: top;
}
.highlighttable td.code {
    width: auto;
    overflow: auto;
}
.highlighttable td.code pre {
    overflow: auto;
}

/* ××™×›×œ ×”×§×•×“ ×™×ª×¤×¨×¡ ×œ×¨×•×—×‘ ××œ× */
.code-container {
    width: 100%;
    overflow: auto;
}

/* ×›×•×ª×¨×ª ××§×˜×¢ ×¢× ×›×¤×ª×•×¨ ×¤×¢×•×œ×” (×œ××¡×š ××œ×) */
.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
    margin-bottom: 1.25rem;
}

/* Editor toolbar */
.editor-toolbar {
    width: 100%;
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 10px;
    padding: 8px;
    margin: 0 0 1rem;
    background: rgba(255, 255, 255, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.18);
    border-radius: 12px;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    position: sticky;
    top: 0;
    z-index: 5;
}

.search-capsule {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 8px;
    flex: 1 1 320px;
    min-width: 240px;
    padding: 6px 10px;
    border-radius: 10px;
    background: rgba(0, 0, 0, 0.25);
    border: 1px solid transparent;
    transition: border-color 0.2s ease, background 0.2s ease;
}

.search-capsule:focus-within {
    border-color: rgba(255, 255, 255, 0.5);
    background: rgba(0, 0, 0, 0.4);
}

.search-input {
    flex: 1 1 200px;
    min-width: 0;
    border: none;
    background: transparent;
    color: #ffffff;
    font-size: 15px;
    padding: 6px 4px;
    outline: none;
}

.search-input::placeholder {
    color: rgba(255, 255, 255, 0.6);
}

.search-count {
    color: rgba(255, 255, 255, 0.85);
    font-size: 13px;
    white-space: nowrap;
    min-width: 48px;
    text-align: center;
    font-variant-numeric: tabular-nums;
}

.divider {
    width: 1px;
    height: 22px;
    background: rgba(255, 255, 255, 0.25);
}

.icon-btn {
    background: transparent;
    border: none;
    color: rgba(255, 255, 255, 0.9);
    width: 34px;
    height: 34px;
    border-radius: 6px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.2s ease;
    font-size: 16px;
}

.icon-btn:hover,
.icon-btn:focus-visible {
    background: rgba(255, 255, 255, 0.15);
}

.fullscreen-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    border-radius: 10px;
    border: 1px solid rgba(255, 255, 255, 0.25);
    background: rgba(255, 255, 255, 0.12);
    color: var(--text-primary, #ffffff);
    font-size: 14px;
    cursor: pointer;
    transition: background 0.2s ease, border-color 0.2s ease;
    white-space: nowrap;
    margin-inline-start: auto;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
}

.fullscreen-btn:hover,
.fullscreen-btn:focus-visible {
    background: rgba(255, 255, 255, 0.22);
    border-color: rgba(255, 255, 255, 0.4);
}
:root[data-theme="rose-pine-dawn"] .fullscreen-btn {
    background: color-mix(in srgb, var(--bg-secondary) 65%, #ffffff 35%);
    border-color: var(--glass-border);
    color: var(--text-primary);
}
:root[data-theme="rose-pine-dawn"] .fullscreen-btn:hover,
:root[data-theme="rose-pine-dawn"] .fullscreen-btn:focus-visible {
    background: color-mix(in srgb, var(--bg-secondary) 45%, #ffffff 55%);
    border-color: rgba(144, 122, 169, 0.5);
}

@media (max-width: 500px) {
    .search-capsule {
        flex-basis: 100%;
        width: 100%;
        min-width: 0;
        order: 2;
    }

    .fullscreen-btn {
        width: auto;
        order: 1;
        margin-inline-start: auto;
    }
}

/* ×›××©×¨ ×”×›×¨×˜×™×¡ ×‘××¡×š ××œ× â€“ ×”×§×•×“ ×™×ª×¤×•×¡ ×›××¢×˜ ××ª ×›×œ ×”×’×•×‘×” */
#codeCard:fullscreen .code-container {
    height: calc(100vh - 120px);
    overflow: auto;
}

.file-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 2rem;
    flex-wrap: wrap;
    gap: 1rem;
}

/* ×›×•×ª×¨×ª ×•×©×•×¨×ª ××™×“×¢: ×× ×™×¢×ª ×’×œ×™×©×” ×•×™×™×©×•×¨ ××œ×™×¤×¡×•×ª */
.file-title-row {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
    min-width: 0; /* ×××¤×©×¨ ××œ×™×¤×¡×•×ª ×‘×¦××¦××™× */
}
.file-icon {
    font-size: 2.25rem; /* ×”×™×” 3rem â€“ ××§×˜×™×Ÿ ×œ×× ×™×¢×ª ×’×œ×™×©×” */
    line-height: 1;
    flex: 0 0 auto;
}
.file-title-wrap {
    min-width: 0;
    display: flex;
    flex-direction: column;
}
.file-title {
    margin: 0;
    font-size: 1.5rem; /* ×’×•×“×œ ×©×§×•×œ ×œ-section-title */
    line-height: 1.2;
    white-space: nowrap; /* ×‘×¨×™×¨×ª ××—×“×œ: ×©×•×¨×” ××—×ª */
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
}
.file-subrow {
    display: flex;
    gap: 1rem;
    margin-top: 0.5rem;
    min-width: 0;
}

.file-info {
    flex: 1;
}

.file-description {
    margin: 1rem 0;
    opacity: 0.9;
    font-size: 1.1rem;
    line-height: 1.5;
    overflow-wrap: anywhere;
}

.file-actions {
    display: flex;
    gap: 0.75rem;
    flex-wrap: nowrap;
    width: 100%;
    align-items: stretch;
}

.file-actions__list {
    display: flex;
    gap: 0.75rem;
    flex-wrap: nowrap;
    flex: 0 1 auto;
    overflow: hidden;
    align-items: stretch;
    min-width: 0;
}

.file-actions__menu {
    position: relative;
    flex: 0 0 auto;
    display: flex;
    align-items: stretch;
}

.file-actions__menu-button {
    min-width: 48px;
    padding-inline: 16px;
    font-size: 1.5rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    flex: 0 0 auto;
}

.file-actions__dropdown {
    position: absolute;
    inset-inline-start: 0;
    top: calc(100% + 8px);
    width: auto;
    min-width: 200px;
    max-width: calc(100vw - 32px);
    background: rgba(255, 255, 255, 0.98);
    color: #1f2937;
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 14px;
    padding: 8px;
    box-shadow: 0 14px 30px rgba(17, 23, 41, 0.16);
    z-index: 20;
}

.file-actions__dropdown[hidden] {
    display: none;
}

.file-actions__menu-section {
    display: flex;
    flex-direction: column;
    gap: 0;
}

.file-actions__menu-divider {
    height: 1px;
    background: rgba(0, 0, 0, 0.1);
    margin: 0;
}

.file-actions__menu-item {
    background: transparent;
    border: none;
    color: #1f2937;
    padding: 12px 14px;
    border-radius: 0;
    cursor: pointer;
    text-align: right;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.95rem;
    transition: background 0.2s ease, color 0.2s ease, border-color 0.2s ease;
}

.file-actions__menu-item:hover,
.file-actions__menu-item:focus-visible {
    background: rgba(102, 126, 234, 0.1);
    color: #111827;
}

.file-actions__menu-item + .file-actions__menu-item {
    border-top: 1px solid rgba(0, 0, 0, 0.1);
}

.file-actions__menu-section .file-actions__menu-item:first-child {
    border-top-right-radius: 12px;
    border-top-left-radius: 12px;
}

.file-actions__menu-section .file-actions__menu-item:last-child {
    border-bottom-right-radius: 12px;
    border-bottom-left-radius: 12px;
}

.file-actions__menu-item.danger {
    color: #d92d20;
}

.file-actions__menu-item.danger:hover,
.file-actions__menu-item.danger:focus-visible {
    background: #fdecec;
    color: #b42318;
}

.file-action--hidden {
    display: none !important;
}

@media (max-width: 768px) {
    .file-actions {
        flex-wrap: wrap;
    }
    .file-actions__list {
        flex-wrap: wrap;
        overflow: visible;
        display: contents;
    }
    .file-actions__menu {
        flex: 0 0 auto;
        align-self: flex-start;
    }
    .file-actions__menu-button {
        flex: 0 0 auto !important;
    }
    .file-actions__menu-button {
        flex: 0 0 auto !important;
    }
}

.file-actions .btn-primary.btn-icon {
    background: rgba(255, 255, 255, 0.95) !important;
    color: #667eea !important;
    border: 1px solid rgba(102, 126, 234, 0.35) !important;
    border-radius: 12px !important;
    padding: 12px 20px !important;
    display: inline-flex !important;
    align-items: center;
    gap: 8px;
    font-size: 15px;
    font-weight: 500;
    white-space: nowrap;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
    transition: all 0.2s ease;
}

.file-actions .btn-primary.btn-icon:hover {
    background: rgba(255, 255, 255, 1) !important;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.18);
}

.file-actions .btn-primary.btn-icon:active {
    transform: translateY(0);
}

.file-actions .btn-primary.btn-icon .fas,
.file-actions .btn-primary.btn-icon i,
.file-actions .btn-primary.btn-icon svg {
    color: #667eea;
}

.file-actions__list .btn.file-action--hidden {
    display: none !important;
}

.file-actions__menu-button .fas {
    color: inherit;
}

.file-meta {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin: 2rem 0;
}

.meta-item {
    background: rgba(255,255,255,0.05);
    padding: 1rem;
    border-radius: 10px;
}

.meta-label {
    font-size: 0.9rem;
    opacity: 0.7;
    margin-bottom: 0.5rem;
}

.meta-value {
    font-size: 1.1rem;
    font-weight: 500;
}

.muted { opacity: 0.7; }

.copy-button {
    position: relative;
}

.copy-feedback {
    position: absolute;
    top: -40px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--success);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 5px;
    font-size: 0.9rem;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
}

.copy-feedback.show {
    opacity: 1;
}

/* ×”×“×’×©×ª ×ª×•×¦××•×ª ×—×™×¤×•×© ×‘×ª×•×š ×§×•×“ */
.md-highlight {
    background: linear-gradient(90deg, #ffd700 0%, #ffed4e 100%);
    color: #000;
    padding: 2px 4px;
    border-radius: 3px;
    font-weight: 600;
}
/* ×—×™×•×•×™ ×œ××•×¤×¢ ×”×¤×¢×™×œ */
.md-highlight.is-active {
    outline: 2px solid #ffd700;
    outline-offset: 1px;
}

/* ×”×¨×—×‘×ª ×”×ª×¦×•×’×” ×œ×¨×•×—×‘ ××œ× ×‘×¢××•×“ ×¦×¤×™×™×” ×‘×§×•×‘×¥ */
.main-content > .container {
    max-width: 100% !important;
    width: 100% !important;
    padding-left: 16px;
    padding-right: 16px;
}

.glass-card,
.file-header,
.file-meta,
.code-container {
    width: 100% !important;
}

/* ×× ×™×¢×ª ×’×œ×™×©×” ×‘×ª×•×›×Ÿ ×›×œ×œ×™ ×©×œ ×”×›×¨×˜×™×¡×™× */
.glass-card p, .glass-card li, .glass-card blockquote {
    overflow-wrap: anywhere;
    word-break: break-word;
}

.source,
.source .highlight,
.source .highlight pre,
.highlighttable {
    width: 100% !important;
    max-width: 100% !important;
}

@media (max-width: 768px) {
    .file-header {
        flex-direction: column;
    }

    .file-title {
        font-size: clamp(1.05rem, 6vw, 1.35rem);
        white-space: normal;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        word-break: break-word;
        overflow-wrap: anywhere;
    }

    .file-description {
        font-size: clamp(0.95rem, 4.8vw, 1.05rem);
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        word-break: break-word;
        overflow-wrap: anywhere;
    }

    .file-actions {
        width: 100%;
        justify-content: stretch;
        column-gap: 0.75rem;
        row-gap: 0.75rem;
    }

    .file-actions__list .btn {
        flex: 1;
    }

    /* ×”×ª×××•×ª ××•×‘×™×™×œ ×œ×ª×¦×•×’×ª ×§×•×“ */
    .source {
        font-size: 12px !important;
        padding: 0.75rem !important;
    }
    .file-icon { font-size: 2rem; }
    .highlighttable td.linenos { width: 2.8rem; }
    .main-content > .container { padding-left: 10px; padding-right: 10px; }
}


/* Mini WebApp: ×©×™×¤×•×¨×™× ×›××©×¨ × ×˜×¢×Ÿ ×‘×ª×•×š ×˜×œ×’×¨× */
body.telegram-mini-app .source { font-size: 12px !important; padding: 0.75rem !important; }
body.telegram-mini-app .main-content > .container { padding-left: 10px !important; padding-right: 10px !important; }
/* Mini App: ×”×§×˜× ×ª ×”×›×•×ª×¨×ª ×•×”××™×™×§×•×Ÿ ×•×× ×™×¢×ª ×’×œ×™×©×” */
body.telegram-mini-app .file-icon { font-size: 1.9rem; }
body.telegram-mini-app .file-title { font-size: 1.125rem; }

.markdown-images-card {
    margin: 2rem 0;
}

.markdown-attachments-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.markdown-attachment {
    position: relative;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid rgba(255,255,255,0.1);
    background: rgba(255,255,255,0.03);
}

.markdown-attachment-open {
    border: none;
    padding: 0;
    width: 100%;
    cursor: pointer;
    background: transparent;
}

.markdown-attachment img {
    width: 100%;
    height: 110px;
    object-fit: cover;
    display: block;
}

.markdown-attachment figcaption {
    padding: 0.5rem;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    font-size: 0.85rem;
    color: var(--text-secondary, rgba(255,255,255,0.8));
}

.markdown-attachment-name {
    font-weight: 600;
    color: var(--text-primary, #ffffff);
    overflow-wrap: anywhere;
}

.markdown-attachment-size {
    font-size: 0.8rem;
    opacity: 0.7;
}

.markdown-image-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.9);
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    z-index: 10000;
}

.markdown-image-overlay.is-open {
    display: flex;
}

.markdown-image-overlay img {
    max-width: 90vw;
    max-height: 80vh;
    border-radius: 14px;
    box-shadow: 0 30px 90px rgba(0,0,0,0.45);
}

.markdown-image-overlay button {
    align-self: flex-end;
    margin-bottom: 1rem;
    border: none;
    background: rgba(255,255,255,0.2);
    color: white;
    padding: 0.35rem 0.9rem;
    border-radius: 999px;
    cursor: pointer;
}

.markdown-image-overlay-caption {
    margin-top: 1rem;
    font-size: 1rem;
    color: rgba(255,255,255,0.85);
    text-align: center;
    max-width: 80vw;
}
</style>
{% endblock %}

{% block content %}
<script type="application/json" id="pygmentsCssData">{{ syntax_css|tojson|safe }}</script>
<div id="fileMeta"
     data-file-name="{{ file.file_name }}"
     data-file-id="{{ file.id }}"
     data-source-url="{{ file.source_url|default('', true) }}"
     style="display:none"></div>
<script>
// ×”×–×¨×§×ª CSS ×©×œ Pygments ×‘×‘×˜×—×” ×œ×ª×•×š style#syntax-css, ×œ×œ× Jinja ×‘×ª×•×š JS
(function(){
    try {
        var dataEl = document.getElementById('pygmentsCssData');
        var css = '';
        if (dataEl) {
            try { css = JSON.parse(dataEl.textContent || '""'); } catch(e) { css = ''; }
        }
        var el = document.getElementById('syntax-css');
        if (el && css) { el.textContent = css; }
    } catch(e) {}
})();
</script>
<div class="file-header">
    <div class="file-info">
        <div class="file-title-row">
            <span class="file-icon">{{ file.icon }}</span>
            <div class="file-title-wrap">
                <h1 class="file-title">{{ file.file_name }}</h1>
                <div class="file-subrow">
                    <span class="badge">{{ file.language }}</span>
                    <span class="muted">×’×¨×¡×” {{ file.version }}</span>
                </div>
            </div>
        </div>
        
        {% if file.description %}
        <p class="file-description">{{ file.description }}</p>
        {% endif %}
        
        {% if file.tags %}
        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin: 1rem 0;">
            {% for tag in file.tags %}
            <span class="badge" style="background: rgba(102, 126, 234, 0.2); border-color: rgba(102, 126, 234, 0.4);">
                #{{ tag }}
            </span>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <div class="file-actions" data-file-actions>
        <div class="file-actions__list" data-actions-list>
            <button id="favoriteBtn"
                    class="btn btn-secondary btn-icon"
                    data-overflow-id="favorite"
                    data-overflow-priority="1"
                    data-menu-label="{{ 'ğŸ’” ×”×¡×¨ ×××•×¢×“×¤×™×' if file.is_favorite else 'â­ ×”×•×¡×£ ×œ××•×¢×“×¤×™×' }}"
                    onclick="toggleFavorite()"
                    aria-pressed="{{ 'true' if file.is_favorite else 'false' }}"
                    title="{{ '×”×¡×¨ ×××•×¢×“×¤×™×' if file.is_favorite else '×”×•×¡×£ ×œ××•×¢×“×¤×™×' }}"
                    aria-label="{{ '×”×¡×¨ ×××•×¢×“×¤×™×' if file.is_favorite else '×”×•×¡×£ ×œ××•×¢×“×¤×™×' }}">
                <span id="favoriteIcon">{{ 'ğŸ’”' if file.is_favorite else 'â­' }}</span>
                <span id="favoriteLabel">{{ '×”×¡×¨ ×××•×¢×“×¤×™×' if file.is_favorite else '×”×•×¡×£ ×œ××•×¢×“×¤×™×' }}</span>
            </button>
            <a href="/edit/{{ file.id }}" class="btn btn-primary btn-icon"
               data-overflow-id="edit"
               data-overflow-priority="2"
               data-menu-label="âœï¸ ×¢×¨×•×š">
                <i class="fas fa-edit"></i>
                ×¢×¨×•×š
            </a>
            <button onclick="copyCode()" class="btn btn-primary btn-icon copy-button"
                    data-overflow-id="copy"
                    data-overflow-priority="3"
                    data-menu-label="ğŸ“‹ ×”×¢×ª×§ ×§×•×“">
                <i class="fas fa-copy"></i>
                ×”×¢×ª×§ ×§×•×“
                <div class="copy-feedback" id="copyFeedback">×”×•×¢×ª×§!</div>
            </button>
            {% if file.language|lower == 'html' or (file.file_name|lower).endswith('.html') or (file.file_name|lower).endswith('.htm') %}
            <a href="/html/{{ file.id }}" class="btn btn-secondary btn-icon"
               data-overflow-id="html"
               data-overflow-priority="5"
               data-menu-label="ğŸŒ ×ª×¦×•×’×ª ×“×¤×“×¤×Ÿ">
                ğŸŒ ×ª×¦×•×’×ª ×“×¤×“×¤×Ÿ
            </a>
            {% endif %}
            {% if file.language|lower == 'markdown' or (file.file_name|lower).endswith('.md') %}
            <a href="/md/{{ file.id }}" class="btn btn-secondary btn-icon"
               data-overflow-id="markdown"
               data-overflow-priority="5"
               data-menu-label="ğŸŒ ×ª×¦×•×’×ª Markdown">
                ğŸŒ ×ª×¦×•×’×ª Markdown
            </a>
            {% endif %}
            <a href="/download/{{ file.id }}" class="btn btn-secondary btn-icon"
               data-overflow-id="download"
               data-overflow-priority="6"
               data-menu-label="â¬‡ï¸ ×”×•×¨×“">
                <i class="fas fa-download" aria-hidden="true"></i>
                <span class="btn-text">×”×•×¨×“</span>
            </a>
            <button class="btn btn-secondary btn-icon"
                    data-overflow-id="collection"
                    data-overflow-priority="7"
                    data-menu-label="ğŸ“ ×”×•×¡×£ ×œ××•×¡×£"
                    onclick="openAddToCollectionModal('{{ file.file_name|escape }}')">
                ğŸ“+ ×”×•×¡×£ ×œ××•×¡×£
            </button>
            <a href="#" onclick="return goBack(event)" class="btn btn-secondary btn-icon"
               data-overflow-id="back"
               data-overflow-priority="8"
               data-menu-label="â†©ï¸ ×—×–×•×¨">
                <i class="fas fa-arrow-right" aria-hidden="true"></i>
                <span class="btn-text">×—×–×•×¨</span>
            </a>
        </div>
        <div class="file-actions__menu">
            <button type="button"
                    id="fileActionsMenuButton"
                    class="btn btn-secondary btn-icon file-actions__menu-button"
                    aria-haspopup="true"
                    aria-expanded="false"
                    aria-label="×¢×•×“ ×¤×¢×•×œ×•×ª">
                â‹®
            </button>
            <div class="file-actions__dropdown" id="fileActionsMenu" role="menu" hidden>
                <div class="file-actions__menu-section">
                    <button type="button" class="file-actions__menu-item" data-menu-action="share">
                        <span>ğŸ“¤ ×©×ª×£ ×§×•×‘×¥</span>
                    </button>
                    {% if file.source_url %}
                    <button type="button"
                            class="file-actions__menu-item"
                            data-menu-action="source"
                            data-source-url="{{ file.source_url|e }}"
                            {% if file.source_url_host %}data-source-host="{{ file.source_url_host|e }}"{% endif %}>
                        <span>ğŸ”— ×œ××§×•×¨{% if file.source_url_host %} ({{ file.source_url_host }}){% endif %}</span>
                    </button>
                    {% endif %}
                    <button type="button" class="file-actions__menu-item" data-menu-action="history">
                        <span>ğŸ• ×”×™×¡×˜×•×¨×™×”</span>
                    </button>
                    <button type="button" class="file-actions__menu-item danger" data-menu-action="trash">
                        <span>ğŸ—‘ï¸ ×”×¢×‘×¨ ×œ×¡×œ</span>
                    </button>
                </div>
                <div class="file-actions__menu-divider" data-dynamic-divider hidden></div>
                <div class="file-actions__menu-section" data-dynamic-actions></div>
            </div>
        </div>
    </div>
</div>

<div class="file-meta glass-card">
    <div class="meta-item">
        <div class="meta-label"><i class="fas fa-weight"></i> ×’×•×“×œ</div>
        <div class="meta-value">{{ file.size }}</div>
    </div>
    <div class="meta-item">
        <div class="meta-label"><i class="fas fa-list-ol"></i> ×©×•×¨×•×ª</div>
        <div class="meta-value">{{ file.lines }}</div>
    </div>
    <div class="meta-item">
        <div class="meta-label"><i class="fas fa-calendar-plus"></i> × ×•×¦×¨</div>
        <div class="meta-value">{{ file.created_at }}</div>
    </div>
    <div class="meta-item">
        <div class="meta-label"><i class="fas fa-calendar-check"></i> ×¢×•×“×›×Ÿ</div>
        <div class="meta-value">{{ file.updated_at }}</div>
    </div>
</div>

{% if file.markdown_images %}
<div class="glass-card markdown-images-card" aria-label="×ª××•× ×•×ª ××¦×•×¨×¤×•×ª">
    <div class="section-header">
        <h2 class="section-title" style="margin:0;">
            <i class="fas fa-image"></i>
            ×ª××•× ×•×ª ××¦×•×¨×¤×•×ª
        </h2>
        <span class="badge">{{ file.markdown_images|length }} ×ª××•× ×•×ª</span>
    </div>
    <div class="markdown-attachments-grid">
        {% for image in file.markdown_images %}
        <figure class="markdown-attachment">
            <button type="button"
                    class="markdown-attachment-open"
                    data-image-url="{{ image.url }}"
                    data-image-name="{{ image.file_name }}"
                    aria-label="×¤×ª×— ××ª {{ image.file_name }}">
                <img src="{{ image.url }}" alt="{{ image.file_name }}">
            </button>
            <figcaption>
                <span class="markdown-attachment-name">{{ image.file_name }}</span>
                <span class="markdown-attachment-size">{{ image.size }}</span>
            </figcaption>
        </figure>
        {% endfor %}
    </div>
</div>
{% endif %}

<div class="glass-card" id="codeCard">
    <div class="section-header">
        <h2 class="section-title" style="margin: 0;">
            <i class="fas fa-code"></i>
            ×§×•×“ ××§×•×¨
        </h2>
    </div>
    <div class="editor-toolbar" id="code-search">
        <div class="search-capsule">
            <input id="codeSearchInput"
                   type="text"
                   class="search-input"
                   placeholder="ğŸ” ×—×¤×© ×‘×§×•×“..."
                   aria-label="×—×™×¤×•×© ×‘×ª×•×š ×”×§×•×“">
            <span id="searchCount"
                  class="search-count"
                  aria-live="polite"></span>
            <div class="divider" aria-hidden="true"></div>
            <button id="prevMatchBtn"
                    type="button"
                    class="icon-btn"
                    title="×”×ª×•×¦××” ×”×§×•×“××ª"
                    aria-label="×”×ª×•×¦××” ×”×§×•×“××ª">â–²</button>
            <button id="nextMatchBtn"
                    type="button"
                    class="icon-btn"
                    title="×”×ª×•×¦××” ×”×‘××”"
                    aria-label="×”×ª×•×¦××” ×”×‘××”">â–¼</button>
            <button id="closeSearchBtn"
                    type="button"
                    class="icon-btn"
                    title="× ×§×” ×—×™×¤×•×©"
                    aria-label="× ×§×” ×—×™×¤×•×©">âœ•</button>
        </div>
        <button id="fullscreenBtn" class="fullscreen-btn" type="button" title="××¡×š ××œ×">
            <span aria-hidden="true">â›¶</span>
            <span>××¡×š ××œ×</span>
        </button>
    </div>
    <div class="code-container">
        {{ highlighted_code|safe }}
    </div>
    {% if raw_code is defined %}
    <textarea id="rawCode" style="position: absolute; left: -9999px; height: 0; opacity: 0;">{{ raw_code }}</textarea>
    {% endif %}
</div>

{# Bookmarks snippet: ×›×¤×ª×•×¨ ×•×¤×× ×œ ×¡×™×× ×™×•×ª #}
{% include 'bookmarks_snippet.html' %}

<div class="markdown-image-overlay" id="markdownImageOverlay" aria-hidden="true">
    <button type="button" id="markdownImageOverlayClose">âœ• ×¡×’×™×¨×”</button>
    <img id="markdownImageOverlayImg" alt="×ª××•× ×” ××¦×•×¨×¤×ª">
    <div class="markdown-image-overlay-caption" id="markdownImageOverlayCaption"></div>
</div>

<div class="glass-card" style="margin-top: 2rem;">
    <h2 class="section-title">
        <i class="fas fa-share-alt"></i>
        ×©×™×ª×•×£
    </h2>
    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <button onclick="shareToTelegram()" class="btn btn-secondary btn-icon">
            <i class="fab fa-telegram"></i>
            ×©×ª×£ ×‘×˜×œ×’×¨×
        </button>
        <button onclick="openShareLinkModal()" class="btn btn-secondary btn-icon">
            <i class="fas fa-link"></i>
            ×”×¢×ª×§ ×§×™×©×•×¨
        </button>
    </div>
</div>

<div id="shareLinkModal" class="share-link-modal" role="dialog" aria-modal="true" aria-labelledby="shareLinkTitle" hidden>
    <div class="share-link-modal__content" role="document">
        <h3 id="shareLinkTitle" class="share-link-modal__title">×‘×—×¨×• ×¡×•×’ ×§×™×©×•×¨</h3>
        <p class="share-link-modal__subtitle">××¤×©×¨ ×œ×™×¦×•×¨ ×§×™×©×•×¨ ×–×× ×™ (×¤×’ ×ª×•×§×£ ××•×˜×•××˜×™×ª) ××• ×§×™×©×•×¨ ×§×‘×•×¢ ×œ×œ× ×ª×¤×•×’×”.</p>
        <div class="share-link-modal__actions">
            <button type="button" class="btn btn-primary" onclick="copyShareLink(false)">
                <i class="fas fa-clock"></i>
                ×§×™×©×•×¨ ×–×× ×™
            </button>
            <button type="button" class="btn btn-secondary" onclick="copyShareLink(true)">
                <i class="fas fa-infinity"></i>
                ×§×™×©×•×¨ ×§×‘×•×¢
            </button>
        </div>
        <button type="button" class="share-link-modal__close" onclick="closeShareLinkModal()" aria-label="×¡×’×•×¨">
            âœ•
        </button>
    </div>
</div>

<div id="historyModal" class="glass-modal" role="dialog" aria-modal="true" aria-labelledby="historyModalTitle" hidden>
    <div class="glass-modal__surface">
        <div class="glass-modal__header">
            <h3 id="historyModalTitle">ğŸ“š ×”×™×¡×˜×•×¨×™×™×ª ×’×¨×¡××•×ª</h3>
            <button type="button" class="glass-modal__close" data-history-close aria-label="×¡×’×•×¨">âœ•</button>
        </div>
        <div id="historyModalBody" class="history-modal__body">
            <div class="history-modal__loading">×˜×•×¢×Ÿ ×”×™×¡×˜×•×¨×™×”...</div>
        </div>
    </div>
</div>

<div id="trashConfirmModal" class="glass-modal" role="dialog" aria-modal="true" aria-labelledby="trashModalTitle" hidden>
    <div class="glass-modal__surface">
        <div class="glass-modal__header">
            <h3 id="trashModalTitle">ğŸ—‘ï¸ ×”×¢×‘×¨ ×œ×¡×œ</h3>
            <button type="button" class="glass-modal__close" data-trash-close aria-label="×¡×’×•×¨">âœ•</button>
        </div>
        <p class="trash-modal__text">×”×§×•×‘×¥ ×–××™×Ÿ ×œ××©×š 30 ×™×•× ×‘×¡×œ ×”××™×—×–×•×¨ ×“×¨×š ×”×‘×•×˜.</p>
        <div class="trash-modal__actions">
            <button type="button" class="btn btn-danger" data-trash-confirm>×›×Ÿ, ×”×¢×‘×¨ ×œ×¡×œ</button>
            <button type="button" class="btn btn-secondary" data-trash-close>×‘×™×˜×•×œ</button>
        </div>
    </div>
</div>

<style>
.share-link-modal {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.55);
    z-index: 9999;
}
.share-link-modal[hidden] {
    display: none;
}
.share-link-modal__content {
    background: #1f2a44;
    border-radius: 16px;
    padding: 1.5rem;
    max-width: 420px;
    width: calc(100% - 2rem);
    color: #fff;
    position: relative;
    box-shadow: 0 12px 30px rgba(0, 0, 0, 0.35);
}
.share-link-modal__title {
    margin: 0 0 0.5rem;
    font-size: 1.3rem;
}
.share-link-modal__subtitle {
    margin: 0 0 1.25rem;
    color: rgba(255, 255, 255, 0.8);
}
.share-link-modal__actions {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}
.share-link-modal__actions .btn {
    flex: 1 1 150px;
}
.share-link-modal__close {
    position: absolute;
    top: 0.75rem;
    left: 0.75rem;
    background: transparent;
    border: none;
    color: rgba(255, 255, 255, 0.7);
    font-size: 1.1rem;
    cursor: pointer;
}
.share-link-modal__close:hover,
.share-link-modal__close:focus {
    color: #fff;
}

.glass-modal {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    padding: 1.5rem;
}

.glass-modal[hidden] {
    display: none;
}

.glass-modal__surface {
    background: rgba(18, 26, 48, 0.96);
    border: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: 16px;
    width: min(520px, 100%);
    max-height: 90vh;
    padding: 1.25rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
}

.glass-modal__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
}

.glass-modal__header h3 {
    margin: 0;
    font-size: 1.25rem;
}

.glass-modal__close {
    border: none;
    background: transparent;
    color: rgba(255, 255, 255, 0.7);
    font-size: 1.1rem;
    cursor: pointer;
}

.glass-modal__close:hover,
.glass-modal__close:focus-visible {
    color: #fff;
}

.history-modal__body {
    overflow-y: auto;
    max-height: 65vh;
}

.history-modal__list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.history-modal__item {
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 12px;
    padding: 0.9rem;
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    background: rgba(255, 255, 255, 0.02);
}

.history-modal__item.is-current {
    border-color: rgba(102, 126, 234, 0.5);
    background: rgba(102, 126, 234, 0.08);
}

.history-modal__info {
    flex: 1;
    min-width: 0;
}

.history-modal__title {
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.history-modal__meta {
    font-size: 0.9rem;
    opacity: 0.8;
}

.history-modal__description {
    margin-top: 0.35rem;
    font-size: 0.95rem;
    opacity: 0.9;
}

.history-modal__actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.history-modal__empty,
.history-modal__loading {
    text-align: center;
    padding: 1.5rem 0;
    opacity: 0.85;
}

.trash-modal__text {
    margin: 0;
    font-size: 1rem;
    line-height: 1.6;
}

.trash-modal__actions {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    justify-content: flex-start;
    margin-top: 1rem;
}

.btn.btn-danger {
    background: rgba(255, 99, 99, 0.2);
    border: 1px solid rgba(255, 99, 99, 0.4);
    color: #ffb3b3;
}

.btn.btn-danger:hover,
.btn.btn-danger:focus-visible {
    background: rgba(255, 99, 99, 0.35);
    color: #fff;
}
</style>

<script>
function copyCode() {
    // ×× ×™×© rawCode ×©× ×©×œ×— ××”×©×¨×ª â€” × ×©×ª××© ×‘×• ×›×“×™ ×œ×”×™×× ×¢ ×××¡×¤×¨×™ ×©×•×¨×•×ª/HTML
    const rawArea = document.getElementById('rawCode');
    let code = rawArea ? rawArea.value : '';
    if (!code) {
        // fallback ×™×©×Ÿ
        const codeLines = document.querySelectorAll('.source .highlight pre span');
        if (codeLines.length > 0) {
            codeLines.forEach(span => {
                if (!span.classList.contains('linenos')) {
                    code += span.textContent;
                }
            });
        } else {
            const codeElement = document.querySelector('.source .highlight pre');
            if (codeElement) {
                const fullText = codeElement.textContent;
                const lines = fullText.split('\n');
                code = lines.map(line => line.replace(/^\s*\d+\s*/, '')).join('\n');
            }
        }
    }

    if (!code) {
        // × ×¡×™×•×Ÿ ××—×¨×•×Ÿ - ×œ×§×—×ª ××ª ×›×œ ×”×˜×§×¡×˜ ××”-highlight div
        const highlightDiv = document.querySelector('.source .highlight');
        if (highlightDiv) {
            // ×™×¦×™×¨×ª clone ×–×× ×™
            const tempDiv = highlightDiv.cloneNode(true);
            // ×”×¡×¨×ª ××œ×× ×˜ ××¡×¤×¨×™ ×”×©×•×¨×•×ª
            const linenosDiv = tempDiv.querySelector('.linenodiv');
            if (linenosDiv) {
                linenosDiv.remove();
            }
            code = tempDiv.textContent || tempDiv.innerText;
        }
    }

    if (code) {
        navigator.clipboard.writeText(code).then(() => {
            const feedback = document.getElementById('copyFeedback');
            feedback.classList.add('show');
            setTimeout(() => {
                feedback.classList.remove('show');
            }, 2000);
        }).catch(err => {
            console.error('Failed to copy:', err);
            // × ×¡×™×•×Ÿ ×—×œ×•×¤×™ ×¢× textarea ×–×× ×™
            const textarea = document.createElement('textarea');
            textarea.value = code;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                const feedback = document.getElementById('copyFeedback');
                feedback.classList.add('show');
                setTimeout(() => {
                    feedback.classList.remove('show');
                }, 2000);
            } catch (err2) {
                alert('×œ× ×”×¦×œ×—× ×• ×œ×”×¢×ª×™×§ ××ª ×”×§×•×“');
            }
            document.body.removeChild(textarea);
        });
    } else {
        alert('×œ× × ××¦× ×§×•×“ ×œ×”×¢×ª×§×”');
    }
}

let shareLinkModalKeyHandler = null;

function openShareLinkModal() {
    const modal = document.getElementById('shareLinkModal');
    if (!modal) {
        copyShareLink(false);
        return;
    }
    modal.hidden = false;
    if (!modal.dataset.boundBackdrop) {
        modal.addEventListener('click', function(ev) {
            if (ev.target === modal) {
                closeShareLinkModal();
            }
        });
        modal.dataset.boundBackdrop = '1';
    }
    if (shareLinkModalKeyHandler) {
        try {
            document.removeEventListener('keydown', shareLinkModalKeyHandler);
        } catch (_) {}
    }
    shareLinkModalKeyHandler = function(ev) {
        try {
            if (ev.key === 'Escape') {
                ev.preventDefault();
                closeShareLinkModal();
            }
        } catch (_) {}
    };
    document.addEventListener('keydown', shareLinkModalKeyHandler);
    setTimeout(() => {
        try {
            const firstButton = modal.querySelector('.share-link-modal__actions button');
            if (firstButton) {
                firstButton.focus();
            }
        } catch (_) {}
    }, 0);
}

function closeShareLinkModal() {
    const modal = document.getElementById('shareLinkModal');
    if (!modal) {
        return;
    }
    modal.hidden = true;
    if (shareLinkModalKeyHandler) {
        document.removeEventListener('keydown', shareLinkModalKeyHandler);
        shareLinkModalKeyHandler = null;
    }
}

async function requestShareLink(permanent) {
    try {
        const resp = await fetch(`/api/share/{{ file.id }}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                type: permanent ? 'permanent' : 'temporary',
                permanent: !!permanent
            })
        });
        const data = await resp.json();
        if (data && data.ok && data.url) {
            return data.url;
        }
    } catch (e) {
        console.error('share create failed', e);
    }
    return window.location.href;
}

async function copyShareLink(permanent) {
    try {
        closeShareLinkModal();
    } catch (_) {}
    const url = await requestShareLink(!!permanent);
    const successMessage = permanent ? '×”×§×™×©×•×¨ ×”×§×‘×•×¢ ×”×•×¢×ª×§!' : '×”×§×™×©×•×¨ ×”×–×× ×™ ×”×•×¢×ª×§!';
    const failureMessage = '×œ× ×”×¦×œ×—× ×• ×œ×”×¢×ª×™×§ ××ª ×”×§×™×©×•×¨';
    try {
        await navigator.clipboard.writeText(url);
        alert(successMessage);
    } catch (err) {
        console.error('Failed to copy:', err);
        alert(failureMessage);
    }
}

async function shareToTelegram() {
    const metaDiv = document.getElementById('fileMeta');
    const fileName = metaDiv ? metaDiv.getAttribute('data-file-name') : '';
    const url = await requestShareLink(false);
    const text = `×‘×“×•×§ ××ª ×”×§×•×‘×¥ ${fileName} ×‘-Code Keeper:`;
    const telegramUrl = `https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`;
    window.open(telegramUrl, '_blank');
}

(function initMarkdownAttachments(){
    const overlay = document.getElementById('markdownImageOverlay');
    const overlayImg = document.getElementById('markdownImageOverlayImg');
    const overlayCaption = document.getElementById('markdownImageOverlayCaption');
    const overlayClose = document.getElementById('markdownImageOverlayClose');
    const triggers = document.querySelectorAll('.markdown-attachment-open');
    if (!overlay || !overlayImg || !overlayCaption || !triggers.length) {
        return;
    }

    const closeOverlay = () => {
        overlay.classList.remove('is-open');
        overlay.setAttribute('aria-hidden', 'true');
        overlayImg.src = '';
        overlayImg.alt = '';
        overlayCaption.textContent = '';
    };

    const openOverlay = (url, name) => {
        overlayImg.src = url;
        overlayImg.alt = name;
        overlayCaption.textContent = name;
        overlay.classList.add('is-open');
        overlay.setAttribute('aria-hidden', 'false');
    };

    triggers.forEach((btn) => {
        btn.addEventListener('click', () => {
            const url = btn.getAttribute('data-image-url');
            const name = btn.getAttribute('data-image-name') || '×ª××•× ×”';
            if (url) {
                openOverlay(url, name);
            }
        });
    });

    if (overlayClose) {
        overlayClose.addEventListener('click', closeOverlay);
    }

    overlay.addEventListener('click', (event) => {
        if (event.target === overlay) {
            closeOverlay();
        }
    });

    document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && overlay.classList.contains('is-open')) {
            closeOverlay();
        }
    });
})();

async function toggleFavorite(){
    try {
        const resp = await fetch(`/api/favorite/toggle/{{ file.id }}`, { method: 'POST' });
        const data = await resp.json();
        if (!resp.ok || !data.ok) throw new Error(data.error || '×©×’×™××” ×‘×¢×“×›×•×Ÿ ××•×¢×“×¤×™×');
        const state = !!data.state;
        const btn = document.getElementById('favoriteBtn');
        const icon = document.getElementById('favoriteIcon');
        const label = document.getElementById('favoriteLabel');
        if (btn) {
            const textLabel = state ? '×”×¡×¨ ×××•×¢×“×¤×™×' : '×”×•×¡×£ ×œ××•×¢×“×¤×™×';
            const menuLabel = state ? 'ğŸ’” ×”×¡×¨ ×××•×¢×“×¤×™×' : 'â­ ×”×•×¡×£ ×œ××•×¢×“×¤×™×';
            btn.setAttribute('aria-pressed', state ? 'true' : 'false');
            btn.setAttribute('title', textLabel);
            btn.setAttribute('aria-label', textLabel);
            btn.setAttribute('data-menu-label', menuLabel);
            if (window.fileActionsOverflow && typeof window.fileActionsOverflow.refreshLabel === 'function') {
                window.fileActionsOverflow.refreshLabel('favorite', menuLabel);
            }
        }
        if (icon) icon.textContent = state ? 'ğŸ’”' : 'â­';
        if (label) label.textContent = state ? '×”×¡×¨ ×××•×¢×“×¤×™×' : '×”×•×¡×£ ×œ××•×¢×“×¤×™×';
        showToast(state ? 'â­ ×”×§×•×‘×¥ × ×•×¡×£ ×œ××•×¢×“×¤×™×' : 'ğŸ’” ×”×§×•×‘×¥ ×”×•×¡×¨ ××”××•×¢×“×¤×™×', state ? 'success' : 'info');
    } catch (e) {
        console.error('favorite toggle failed', e);
        showToast('×©×’×™××” ×‘×¢×“×›×•×Ÿ ××•×¢×“×¤×™×', 'error');
    }
}

function showToast(message, type){
    try {
        if (window.bookmarkManager && window.bookmarkManager.ui) {
            // ×”×©×ª××© ×‘×× ×’× ×•×Ÿ ×”×”×ª×¨××•×ª ×”×§×™×™×
            if (type === 'error') window.bookmarkManager.ui.showError(message);
            else window.bookmarkManager.ui.showNotification(message, type || 'info');
            return;
        }
    } catch(_) {}
    // × ×¤×™×œ×” ×œ××—×•×¨: alert ×§×¦×¨
    try { alert(message); } catch(_) {}
}

// ×”×•×¡×¤×ª ×§×™×¦×•×¨×™ ××§×œ×“×ª
document.addEventListener('keydown', function(e) {
    // Ctrl+C ××• Cmd+C ×œ×”×¢×ª×§×ª ×§×•×“
    if ((e.ctrlKey || e.metaKey) && e.key === 'c' && !window.getSelection().toString()) {
        e.preventDefault();
        copyCode();
    }
    // Escape: ×× ×‘××¡×š ××œ× â€“ ×œ×¦××ª ××× ×•; ××—×¨×ª â€“ ×—×–×¨×” ×œ×¨×©×™××”
    if (e.key === 'Escape') {
        const codeCard = document.getElementById('codeCard');
        if (document.fullscreenElement && document.fullscreenElement === codeCard) {
            e.preventDefault();
            try { document.exitFullscreen(); } catch (err) { /* ignore */ }
            return;
        }
        goBack();
    }
});

// ××¡×š ××œ× ×¢×‘×•×¨ ××™×›×œ ×”×§×•×“
(function(){
    const btn = document.getElementById('fullscreenBtn');
    const card = document.getElementById('codeCard');
    if (!btn || !card) return;

    function isFullscreen(){
        return document.fullscreenElement === card;
    }

    function updateButton(){
        let spans = btn.querySelectorAll('span');
        if (spans.length < 2) {
            btn.replaceChildren();
            const iconSpan = document.createElement('span');
            iconSpan.setAttribute('aria-hidden', 'true');
            const textSpan = document.createElement('span');
            btn.appendChild(iconSpan);
            btn.appendChild(textSpan);
            spans = btn.querySelectorAll('span');
        }

        const iconSpan = spans[0];
        const textSpan = spans[1];
        if (!iconSpan || !textSpan) return;

        if (isFullscreen()) {
            iconSpan.textContent = 'âœ•';
            textSpan.textContent = '×™×¦×™××”';
        } else {
            iconSpan.textContent = 'â›¶';
            textSpan.textContent = '××¡×š ××œ×';
        }
    }

    btn.addEventListener('click', async function(){
        try {
            if (!isFullscreen()) {
                await card.requestFullscreen();
            } else {
                await document.exitFullscreen();
            }
        } catch (e) {
            console.error('fullscreen error', e);
        }
    });

    document.addEventListener('fullscreenchange', updateButton);
    updateButton();
})();

// ×—×–×¨×” ×œ××¡×š ×”×§×•×“× ×‘×¦×•×¨×” ×××™× ×” (×©×•××¨×ª ××¡× × ×™×/×“×¤×“×•×£)
function goBack(ev){
    try { if (ev) ev.preventDefault(); } catch(e){}
    try {
        // ×× ×™×© ×”×™×¡×˜×•×¨×™×” â€“ ×—×–×•×¨ ×¦×¢×“ ××—×“ ×‘×œ×‘×“
        if (window.history && window.history.length > 1) {
            window.history.back();
            return false;
        }
        // ×× ×™×© referrer ×××•×ª×• ×“×•××™×™×Ÿ â€“ × × ×•×•×˜ ××œ×™×•
        if (document.referrer) {
            const ref = new URL(document.referrer, window.location.origin);
            if (ref.origin === window.location.origin) {
                window.location.href = ref.toString();
                return false;
            }
        }
    } catch (e) {}
    // ×‘×¨×™×¨×ª ××—×“×œ: ×¨×©×™××ª ×§×‘×¦×™×
    window.location.href = '/files';
    return false;
}
</script>
<script>
// ×”×“×’×©×ª ×—×™×¤×•×© ×‘×§×•×“ (×‘-Pygments HTML)
(function(){
    try {
        const container = document.querySelector('#codeCard .code-container');
        const input = document.getElementById('codeSearchInput') || document.getElementById('searchInput');
        const clearBtn = document.getElementById('closeSearchBtn') || document.getElementById('codeSearchClear');
        const nextBtn = document.getElementById('nextMatchBtn') || document.getElementById('codeSearchNext');
        const prevBtn = document.getElementById('prevMatchBtn') || document.getElementById('codeSearchPrev');
        const countEl = document.getElementById('searchCount') || document.getElementById('codeSearchCount');
        if (!container || !input || !clearBtn || !countEl) return;
        let justAutoFocused = false;

    // × ×©××•×¨ ××§×•×¨ ×œ×›×œ ×‘×œ×•×§ ×§×•×“/×©×•×¨×© ×”×“×’×©×” ×‘×œ×‘×“ (×œ× ×œ×›×œ ×”××›×•×œ×”)
    (function cacheOriginalPerRoot(){
        const roots = container.querySelectorAll('.highlight, .highlighttable td.code, .source .highlight, pre');
        roots.forEach(root => {
            if (!root.hasAttribute('data-original-html')) {
                root.setAttribute('data-original-html', root.innerHTML);
            }
        });
    })();

        function restore(){
            // ××©×—×–×¨ ×¨×§ ××ª ×©×•×¨×©×™ ×”×§×•×“ ×©×©××¨× ×• ×¢×‘×•×¨× ××§×•×¨, ×œ× ××ª ×›×œ ×”××›×•×œ×”
            const roots = container.querySelectorAll('.highlight, .highlighttable td.code, .source .highlight, pre');
            roots.forEach(root => {
                try {
                    const orig = root.getAttribute('data-original-html');
                    if (orig != null) root.innerHTML = orig;
                } catch(_) {}
            });
        }

        function highlightTerm(term){
            // ×‘×ª×•×š ×”×§×•×“ ×‘×œ×‘×“: ×”×“×’×©×” ×‘×ª×•×š ×”×ª××™× ×©×œ ×”-highlighttable/ .highlight
            let total = 0;
            const codeRoots = container.querySelectorAll('.highlight, .highlighttable td.code, .source .highlight, pre');
            codeRoots.forEach(root => {
                try {
                    const original = root.getAttribute('data-original-html') || root.innerHTML;
                    root.setAttribute('data-original-html', original);
                    if (!term) { root.innerHTML = original; return; }
                    const safe = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    const rx = new RegExp(`(${safe})`, 'gi');
                    const replaced = original.replace(rx, '<span class="md-highlight">$1</span>');
                    root.innerHTML = replaced;
                    total += (original.match(rx) || []).length;
                } catch(_) {}
            });
            return total;
        }

        function updateCount(n, term){
            if (!term) { countEl.textContent = ''; return; }
            const active = container.querySelector('.md-highlight.is-active');
            const activeIndex = active ? (Array.from(container.querySelectorAll('.md-highlight')).indexOf(active) + 1) : 0;
            countEl.textContent = n > 0 ? (activeIndex ? `${activeIndex}/${n}` : `${n} ×ª×•×¦××•×ª`) : '××™×Ÿ ×ª×•×¦××•×ª';
        }

        function setActiveAndScroll(target){
            try {
                container.querySelectorAll('.md-highlight.is-active').forEach(el => el.classList.remove('is-active'));
            } catch(_){}
            if (!target) return;
            try { target.classList.add('is-active'); } catch(_){}
            try { target.scrollIntoView({ behavior:'smooth', block:'center' }); } catch(_){ }
        }

        function focusFirst(){
            const first = container.querySelector('.md-highlight');
            if (first) setActiveAndScroll(first);
        }

        function focusNext(){
            const all = Array.from(container.querySelectorAll('.md-highlight'));
            if (all.length === 0) return;
            const current = container.querySelector('.md-highlight.is-active');
            const idx = current ? all.indexOf(current) : -1;
            const next = all[(idx + 1) % all.length];
            setActiveAndScroll(next);
            updateCount(all.length, input.value.trim());
        }

        function focusPrev(){
            const all = Array.from(container.querySelectorAll('.md-highlight'));
            if (all.length === 0) return;
            const current = container.querySelector('.md-highlight.is-active');
            const idx = current ? all.indexOf(current) : 0;
            const prev = all[(idx - 1 + all.length) % all.length];
            setActiveAndScroll(prev);
            updateCount(all.length, input.value.trim());
        }

        input.addEventListener('input', () => {
            const term = (input.value || '').trim();
            restore();
            const n = highlightTerm(term);
            if (term && n > 0) {
                focusFirst();
                justAutoFocused = true; // ×œ×—×™×¦×” ×¨××©×•× ×” ×¢×œ "×”×‘×" ×œ× ×ª×“×œ×’
            }
            updateCount(n, term);
        });

        clearBtn.addEventListener('click', () => {
            input.value = '';
            restore();
            updateCount(0, '');
            justAutoFocused = false;
        });

        if (nextBtn) {
            nextBtn.addEventListener('click', () => {
                const term = (input.value || '').trim();
                if (!term) return;
                const active = container.querySelector('.md-highlight.is-active');
                if (justAutoFocused || !active) {
                    // ×‘×¤×¢× ×”×¨××©×•× ×” ××—×¨×™ ×—×™×¤×•×©: ×”×©××¨ ×¢×œ ×”×¨××©×•× ×”
                    const first = container.querySelector('.md-highlight');
                    if (first) setActiveAndScroll(first);
                    justAutoFocused = false;
                    updateCount(container.querySelectorAll('.md-highlight').length, term);
                } else {
                    focusNext();
                }
            });
        }

        if (prevBtn) {
            prevBtn.addEventListener('click', () => {
                const term = (input.value || '').trim();
                if (!term) return;
                const active = container.querySelector('.md-highlight.is-active');
                if (justAutoFocused || !active) {
                    // ×™×™×©×•×¨ ×œ×”×ª× ×”×’×•×ª Shift+Enter: ×¢×‘×•×¨ ×œ××•×¤×¢ ×”××—×¨×•×Ÿ
                    focusPrev();
                    justAutoFocused = false;
                } else {
                    focusPrev();
                }
            });
        }

        // ×§×™×¦×•×¨ ××§×©×™×: Enter = ×”×‘× (×¢× Shift = ×§×•×“×)
        input.addEventListener('keydown', (ev) => {
            if (ev.key === 'Enter') {
                ev.preventDefault();
                const all = container.querySelectorAll('.md-highlight');
                if (all.length === 0) return;
                if (ev.shiftKey) {
                    const arr = Array.from(all);
                    const current = container.querySelector('.md-highlight.is-active');
                    const idx = current ? arr.indexOf(current) : 0;
                    const prev = arr[(idx - 1 + arr.length) % arr.length];
                    setActiveAndScroll(prev);
                    // ×™×¦×™××” ×××¦×‘ "××•×§×“ ××•×˜×•××˜×™" ×›×“×™ ×©×”×‘× ×™×ª×§×“× ×›×¨××•×™
                    justAutoFocused = false;
                    updateCount(arr.length, input.value.trim());
                } else {
                    const active = container.querySelector('.md-highlight.is-active');
                    if (justAutoFocused || !active) {
                        const first = container.querySelector('.md-highlight');
                        if (first) setActiveAndScroll(first);
                        justAutoFocused = false;
                        updateCount(all.length, input.value.trim());
                    } else {
                        focusNext();
                    }
                }
            }
        });

        if (nextBtn) {
            nextBtn.addEventListener('click', () => {
                const term = (input.value || '').trim();
                if (!term) return;
                const active = container.querySelector('.md-highlight.is-active');
                if (justAutoFocused || !active) {
                    // ×‘×¤×¢× ×”×¨××©×•× ×” ××—×¨×™ ×—×™×¤×•×©: ×”×©××¨ ×¢×œ ×”×¨××©×•× ×”
                    const first = container.querySelector('.md-highlight');
                    if (first) setActiveAndScroll(first);
                    justAutoFocused = false;
                    updateCount(container.querySelectorAll('.md-highlight').length, term);
                } else {
                    focusNext();
                }
            });
        }

        // ×§×™×¦×•×¨ ××§×©×™×: Enter = ×”×‘× (×¢× Shift = ×§×•×“×)
        input.addEventListener('keydown', (ev) => {
            if (ev.key === 'Enter') {
                ev.preventDefault();
                const all = container.querySelectorAll('.md-highlight');
                if (all.length === 0) return;
                if (ev.shiftKey) {
                    const arr = Array.from(all);
                    const current = container.querySelector('.md-highlight.is-active');
                    const idx = current ? arr.indexOf(current) : 0;
                    const prev = arr[(idx - 1 + arr.length) % arr.length];
                    setActiveAndScroll(prev);
                    // ×™×¦×™××” ×××¦×‘ "××•×§×“ ××•×˜×•××˜×™" ×›×“×™ ×©×”×‘× ×™×ª×§×“× ×›×¨××•×™
                    justAutoFocused = false;
                    updateCount(arr.length, input.value.trim());
                } else {
                    const active = container.querySelector('.md-highlight.is-active');
                    if (justAutoFocused || !active) {
                        const first = container.querySelector('.md-highlight');
                        if (first) setActiveAndScroll(first);
                        justAutoFocused = false;
                        updateCount(all.length, input.value.trim());
                    } else {
                        focusNext();
                    }
                }
            }
        });

        // ×”×•×¡×¨ ×§×•×“ ×›×¤×•×œ ××”××™×™×Ÿ
    } catch(_) {}
})();
</script>
<script>
// ×”×ª×××ª ×©× ×§×•×‘×¥ ××¨×•×š: ×§×•×“× ××¦××¦× ×¤×•× ×˜, ×•×× ×¢×“×™×™×Ÿ ×œ× × ×›× ×¡ â€“ ×××¤×©×¨ ×©×‘×™×¨×” ×¢×“ 2 ×©×•×¨×•×ª
(function(){
    try {
        var el = document.querySelector('.file-title');
        if (!el) return;
        if (!el.getAttribute('title')) {
            el.setAttribute('title', el.textContent || '');
        }
        var sizeRem = 1.5; // ×ª×•×× ×œ-CSS
        var minRem = 1.1;  // ××™× ×™××•× ×¡×‘×™×¨
        el.style.fontSize = sizeRem + 'rem';
        var guard = 0;
        while (guard < 15 && el.scrollWidth > el.clientWidth && sizeRem > minRem) {
            sizeRem -= 0.1;
            el.style.fontSize = sizeRem.toFixed(2) + 'rem';
            guard++;
        }
    // ×× ×¢×“×™×™×Ÿ ×—×•×¨×’, ××¤×©×¨ ×©×‘×™×¨×” ×œ×©×ª×™ ×©×•×¨×•×ª ×œ×›×œ ×”×™×•×ª×¨
    if (el.scrollWidth > el.clientWidth) {
      el.style.whiteSpace = 'normal';
      // × ×™×¡×™×•×Ÿ ×¨××©×•×Ÿ: line-clamp ×¡×˜× ×“×¨×˜×™ ×× × ×ª××š
      el.style.display = 'block';
      el.style.overflow = 'hidden';
      el.style.textOverflow = 'ellipsis';
      el.style.lineClamp = '2';
      el.style.webkitLineClamp = '2';
      el.style.boxOrient = 'vertical';
      el.style.webkitBoxOrient = 'vertical';
      // Fallback ×œ×Ö¾×ª×•××›×™×: ×’×•×‘×” ××§×¡×™××œ×™ ×œ×¤×™ ×©×•×¨×”
      const lh = parseFloat(getComputedStyle(el).lineHeight) || (1.2 * parseFloat(getComputedStyle(el).fontSize));
      el.style.maxHeight = Math.round(lh * 2) + 'px';
    }
    } catch(_) {}
})();
</script>

<script>
(function initFileActionsOverflow(){
    const actionsList = document.querySelector('[data-actions-list]');
    const menuButton = document.getElementById('fileActionsMenuButton');
    const dropdown = document.getElementById('fileActionsMenu');
    const metaEl = document.getElementById('fileMeta');
    const fallbackSourceUrl = metaEl ? (metaEl.getAttribute('data-source-url') || '') : '';
    if (!actionsList || !menuButton || !dropdown) {
        return;
    }
    const dynamicList = dropdown.querySelector('[data-dynamic-actions]');
    const dividerEl = dropdown.querySelector('[data-dynamic-divider]');
    const overflowItems = Array.from(actionsList.querySelectorAll('[data-overflow-id]')).map((el) => {
        const id = el.getAttribute('data-overflow-id');
        if (!id) {
            return null;
        }
        return {
            el,
            id,
            priority: Number(el.getAttribute('data-overflow-priority') || 0),
            label: el.getAttribute('data-menu-label') || (el.textContent || '').trim(),
        };
    }).filter(Boolean);
    const proxies = new Map();
    const viewportPadding = 16;
    const requestFrame = window.requestAnimationFrame || window.webkitRequestAnimationFrame || ((cb) => setTimeout(cb, 16));
    const cancelFrame = window.cancelAnimationFrame || window.webkitCancelAnimationFrame || window.clearTimeout;
    let dropdownRaf = null;
    const container = actionsList.closest('[data-file-actions]') || actionsList.parentElement;
    const menuWrapper = menuButton.closest('.file-actions__menu') || menuButton.parentElement || menuButton;
    const DESKTOP_QUERY = '(min-width: 769px)';
    const MOBILE_QUERY = '(max-width: 768px)';
    const desktopMatch = window.matchMedia ? window.matchMedia(DESKTOP_QUERY) : null;
    const mobileMatch = window.matchMedia ? window.matchMedia(MOBILE_QUERY) : null;
    const WIDTH_GUARD = 12;
    let overflowTimer = null;

    function getViewportSize() {
        const docEl = document.documentElement;
        const width = (window.visualViewport && window.visualViewport.width) ||
            (docEl && docEl.clientWidth) ||
            window.innerWidth ||
            0;
        const height = (window.visualViewport && window.visualViewport.height) ||
            (docEl && docEl.clientHeight) ||
            window.innerHeight ||
            0;
        return { width, height };
    }

    function resetDropdownBounds() {
        dropdown.style.removeProperty('transform');
        dropdown.style.removeProperty('max-width');
        dropdown.style.removeProperty('max-height');
        dropdown.style.overflowY = '';
    }

    function clampDropdownToViewport() {
        if (!dropdown || dropdown.hidden) {
            return;
        }
        if (dropdownRaf) {
            cancelFrame(dropdownRaf);
            dropdownRaf = null;
        }
        dropdownRaf = requestFrame(() => {
            dropdownRaf = null;
            if (!dropdown || dropdown.hidden) {
                return;
            }
            const { width: viewportWidth, height: viewportHeight } = getViewportSize();
            const availableWidth = Math.max(160, viewportWidth - viewportPadding * 2);
            const maxWidth = Math.min(320, availableWidth, viewportWidth);
            if (maxWidth && Number.isFinite(maxWidth)) {
                dropdown.style.maxWidth = `${maxWidth}px`;
            } else {
                dropdown.style.removeProperty('max-width');
            }
            dropdown.style.removeProperty('max-height');
            dropdown.style.overflowY = '';
            dropdown.style.transform = '';
            const rect = dropdown.getBoundingClientRect();
            const overflowRight = Math.max(0, rect.right - (viewportWidth - viewportPadding));
            const overflowLeft = Math.max(0, viewportPadding - rect.left);
            const shift = overflowRight ? -overflowRight : (overflowLeft ? overflowLeft : 0);
            if (shift) {
                dropdown.style.transform = `translateX(${shift}px)`;
            } else {
                dropdown.style.removeProperty('transform');
            }
            const availableHeight = viewportHeight - rect.top - viewportPadding;
            if (availableHeight > 0 && availableHeight < rect.height) {
                dropdown.style.maxHeight = `${Math.max(160, availableHeight)}px`;
                dropdown.style.overflowY = 'auto';
            } else {
                dropdown.style.removeProperty('max-height');
                dropdown.style.overflowY = '';
            }
        });
    }

    function isDesktopView() {
        if (desktopMatch) {
            return desktopMatch.matches;
        }
        const width = (window.visualViewport && window.visualViewport.width) ||
            (document.documentElement && document.documentElement.clientWidth) ||
            window.innerWidth ||
            0;
        return width >= 769;
    }

    function getContainerWidth() {
        if (container) {
            const client = container.clientWidth;
            if (client) {
                return client;
            }
            const rect = container.getBoundingClientRect();
            if (rect && rect.width) {
                return rect.width;
            }
        }
        const rect = actionsList.getBoundingClientRect();
        return actionsList.clientWidth || (rect && rect.width) || 0;
    }

    function getMenuWidth() {
        const btnRect = menuButton.getBoundingClientRect();
        return (btnRect && btnRect.width) ? btnRect.width : 48;
    }

    function getAvailableWidth() {
        const containerWidth = getContainerWidth();
        if (!containerWidth) {
            return 0;
        }
        return Math.max(0, containerWidth - getMenuWidth() - WIDTH_GUARD);
    }

    function getVisibleItems() {
        return overflowItems.filter((item) => item.el && !item.el.classList.contains('file-action--hidden') && item.el.offsetParent !== null);
    }

    function measureContentWidth() {
        const visible = getVisibleItems();
        if (!visible.length) {
            return actionsList.scrollWidth || 0;
        }
        let minStart = Infinity;
        let maxEnd = -Infinity;
        visible.forEach((item) => {
            try {
                const rect = item.el.getBoundingClientRect();
                if (!rect) {
                    return;
                }
                const start = Math.min(rect.left, rect.right);
                const end = Math.max(rect.left, rect.right);
                minStart = Math.min(minStart, start);
                maxEnd = Math.max(maxEnd, end);
            } catch (_) {}
        });
        if (!Number.isFinite(minStart) || !Number.isFinite(maxEnd)) {
            return actionsList.scrollWidth || 0;
        }
        return Math.max(0, maxEnd - minStart);
    }

    function hasOverflow(limit) {
        if (!(limit > 0)) {
            return true;
        }
        return measureContentWidth() > limit;
    }

    function updateDividerVisibility() {
        if (!dividerEl) {
            return;
        }
        if (!dynamicList) {
            dividerEl.hidden = true;
            return;
        }
        dividerEl.hidden = dynamicList.childElementCount === 0;
    }

    function ensureProxy(item) {
        if (!dynamicList) {
            return null;
        }
        let btn = proxies.get(item.id);
        if (!btn) {
            btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'file-actions__menu-item';
            btn.dataset.proxyFor = item.id;
            const textSpan = document.createElement('span');
            textSpan.dataset.menuItemLabel = '1';
            textSpan.textContent = item.label;
            btn.appendChild(textSpan);
            btn.addEventListener('click', (event) => {
                event.preventDefault();
                closeMenu();
                triggerAction(item.el);
            });
            proxies.set(item.id, btn);
        } else {
            const labelEl = btn.querySelector('[data-menu-item-label]') || btn;
            labelEl.textContent = item.label;
        }
        if (!dynamicList.contains(btn)) {
            dynamicList.appendChild(btn);
        }
        btn.hidden = false;
        updateDividerVisibility();
        return btn;
    }

    function showProxy(item, visible) {
        if (!visible) {
            const existing = proxies.get(item.id);
            if (existing) {
                if (typeof existing.remove === 'function') {
                    existing.remove();
                } else if (existing.parentElement) {
                    existing.parentElement.removeChild(existing);
                }
                proxies.delete(item.id);
            }
            updateDividerVisibility();
            return;
        }
        ensureProxy(item);
    }

    function triggerAction(el) {
        if (!el) return;
        if (el.tagName === 'A' && el.href) {
            const target = el.getAttribute('target');
            if (target === '_blank') {
                window.open(el.href, '_blank', 'noopener');
            } else {
                window.location.href = el.href;
            }
            return;
        }
        try {
            el.click();
        } catch (_) {}
    }

    function resetOverflowState() {
        overflowItems.forEach((item) => {
            item.el.classList.remove('file-action--hidden');
            showProxy(item, false);
        });
    }

    function applyOverflow() {
        resetOverflowState();
        if (!isDesktopView()) {
            updateDividerVisibility();
            return;
        }
        const availableWidth = getAvailableWidth();
        const sorted = overflowItems.slice().sort((a, b) => (a.priority || 0) - (b.priority || 0));
        let guard = 0;
        const guardLimit = overflowItems.length + 3;
        while (sorted.length && hasOverflow(availableWidth) && guard < guardLimit) {
            const candidate = sorted.pop();
            if (!candidate) break;
            candidate.el.classList.add('file-action--hidden');
            showProxy(candidate, true);
            guard += 1;
        }
        updateDividerVisibility();
    }

    function runOverflowCycle() {
        applyOverflow();
        clampDropdownToViewport();
    }

    function scheduleOverflowCycle(delay) {
        if (overflowTimer) {
            clearTimeout(overflowTimer);
        }
        overflowTimer = setTimeout(() => {
            overflowTimer = null;
            runOverflowCycle();
        }, typeof delay === 'number' ? delay : 120);
    }

    window.addEventListener('resize', () => scheduleOverflowCycle());
    try {
        window.addEventListener('scroll', clampDropdownToViewport, { passive: true });
    } catch (_) {
        window.addEventListener('scroll', clampDropdownToViewport);
    }
    if (window.visualViewport) {
        try {
            window.visualViewport.addEventListener('resize', clampDropdownToViewport);
            window.visualViewport.addEventListener('scroll', clampDropdownToViewport);
        } catch (_) {}
    }
    if (mobileMatch) {
        const mobileHandler = () => scheduleOverflowCycle(80);
        if (typeof mobileMatch.addEventListener === 'function') {
            mobileMatch.addEventListener('change', mobileHandler);
        } else if (typeof mobileMatch.addListener === 'function') {
            mobileMatch.addListener(mobileHandler);
        }
    }
    if (desktopMatch) {
        const desktopHandler = () => scheduleOverflowCycle(80);
        if (typeof desktopMatch.addEventListener === 'function') {
            desktopMatch.addEventListener('change', desktopHandler);
        } else if (typeof desktopMatch.addListener === 'function') {
            desktopMatch.addListener(desktopHandler);
        }
    }
    if (window.ResizeObserver) {
        try {
            const resizeObserver = new ResizeObserver(() => scheduleOverflowCycle(60));
            resizeObserver.observe(actionsList);
            if (container && container !== actionsList) {
                resizeObserver.observe(container);
            }
        } catch (_) {}
    }
    setTimeout(runOverflowCycle, 80);
    setTimeout(runOverflowCycle, 350);

    function openMenu() {
        dropdown.hidden = false;
        menuButton.setAttribute('aria-expanded', 'true');
        clampDropdownToViewport();
    }
    function closeMenu() {
        dropdown.hidden = true;
        menuButton.setAttribute('aria-expanded', 'false');
        resetDropdownBounds();
    }

    menuButton.addEventListener('click', (event) => {
        event.preventDefault();
        event.stopPropagation();
        if (dropdown.hidden) {
            openMenu();
        } else {
            closeMenu();
        }
    });

    document.addEventListener('click', (event) => {
        if (!dropdown.contains(event.target) && event.target !== menuButton) {
            closeMenu();
        }
    });
    document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
            closeMenu();
        }
    });

    dropdown.querySelectorAll('[data-menu-action]').forEach((btn) => {
        btn.addEventListener('click', (event) => {
            event.preventDefault();
            const action = btn.getAttribute('data-menu-action');
            closeMenu();
            if (action === 'share') {
                openShareLinkModal();
                return;
            }
            if (action === 'history' && typeof window.openHistoryModal === 'function') {
                window.openHistoryModal();
                return;
            }
            if (action === 'trash' && typeof window.openTrashConfirmModal === 'function') {
                window.openTrashConfirmModal();
                return;
            }
            if (action === 'source') {
                const href = btn.getAttribute('data-source-url') || fallbackSourceUrl;
                if (href) {
                    window.open(href, '_blank', 'noopener');
                }
                return;
            }
        });
    });

    window.fileActionsOverflow = {
        refreshLabel(id, newLabel) {
            const entry = overflowItems.find((item) => item.id === id);
            if (!entry) return;
            if (newLabel) {
                entry.label = newLabel;
            } else {
                entry.label = entry.el.getAttribute('data-menu-label') || entry.label;
            }
            entry.el.setAttribute('data-menu-label', entry.label);
            const proxy = proxies.get(id);
            if (proxy) {
                const labelEl = proxy.querySelector('[data-menu-item-label]') || proxy;
                labelEl.textContent = entry.label;
            }
        }
    };
})();
</script>

<script>
(function initHistoryAndTrash(){
    const metaEl = document.getElementById('fileMeta');
    const fileId = metaEl ? (metaEl.getAttribute('data-file-id') || '') : '';
    const historyModal = document.getElementById('historyModal');
    const historyBody = document.getElementById('historyModalBody');
    const trashModal = document.getElementById('trashConfirmModal');
    let historyCache = [];
    let historyLoaded = false;
    let historyLoading = false;
    let trashPending = false;

    function createMessage(text, className) {
        const div = document.createElement('div');
        div.className = className || 'history-modal__empty';
        div.textContent = text;
        return div;
    }

    function setHistoryContent(node) {
        if (!historyBody) return;
        historyBody.innerHTML = '';
        historyBody.appendChild(node);
    }

    function renderHistory(entries) {
        if (!historyBody) return;
        if (!entries.length) {
            setHistoryContent(createMessage('××™×Ÿ ×”×™×¡×˜×•×¨×™×™×ª ×’×¨×¡××•×ª ×–××™× ×”', 'history-modal__empty'));
            return;
        }
        const list = document.createElement('div');
        list.className = 'history-modal__list';
        entries.forEach((entry) => {
            const item = document.createElement('div');
            item.className = 'history-modal__item';
            if (entry.is_current) {
                item.classList.add('is-current');
            }
            const info = document.createElement('div');
            info.className = 'history-modal__info';
            const title = document.createElement('div');
            title.className = 'history-modal__title';
            title.textContent = `×’×¨×¡×” ${entry.version || ''}`;
            info.appendChild(title);
            const meta = document.createElement('div');
            meta.className = 'history-modal__meta';
            const timestamp = entry.updated_at || entry.created_at || '';
            const lines = typeof entry.line_count === 'number' ? entry.line_count : '-';
            const size = entry.size || '';
            meta.textContent = `${timestamp} Â· ${lines} ×©×•×¨×•×ª Â· ${size}`;
            info.appendChild(meta);
            if (entry.description) {
                const desc = document.createElement('div');
                desc.className = 'history-modal__description';
                desc.textContent = entry.description;
                info.appendChild(desc);
            }
            const actions = document.createElement('div');
            actions.className = 'history-modal__actions';
            const restoreBtn = document.createElement('button');
            restoreBtn.type = 'button';
            restoreBtn.className = 'btn btn-secondary';
            if (entry.is_current) {
                restoreBtn.disabled = true;
                restoreBtn.textContent = '×’×¨×¡×” × ×•×›×—×™×ª';
            } else {
                restoreBtn.textContent = '×©×—×–×¨';
                restoreBtn.addEventListener('click', () => handleRestore(entry.version, restoreBtn));
            }
            actions.appendChild(restoreBtn);
            item.appendChild(info);
            item.appendChild(actions);
            list.appendChild(item);
        });
        setHistoryContent(list);
    }

    async function fetchHistory() {
        if (!fileId || !historyModal || !historyBody) {
            return;
        }
        if (historyLoaded) {
            renderHistory(historyCache);
            return;
        }
        if (historyLoading) {
            return;
        }
        historyLoading = true;
        setHistoryContent(createMessage('×˜×•×¢×Ÿ ×”×™×¡×˜×•×¨×™×”...', 'history-modal__loading'));
        try {
            const resp = await fetch(`/api/file/${fileId}/history`);
            const data = await resp.json().catch(() => ({}));
            if (!resp.ok || !data.ok) {
                throw new Error(data.error || '×©×’×™××” ×‘×˜×¢×™× ×ª ×”×™×¡×˜×•×¨×™×”');
            }
            historyCache = Array.isArray(data.versions) ? data.versions : [];
            historyLoaded = true;
            renderHistory(historyCache);
        } catch (err) {
            historyLoaded = false;
            setHistoryContent(createMessage(err.message || '×©×’×™××” ×‘×”×¦×’×ª ×”×™×¡×˜×•×¨×™×”', 'history-modal__empty'));
            throw err;
        } finally {
            historyLoading = false;
        }
    }

    async function handleRestore(version, button) {
        if (!fileId || !version || !button) {
            return;
        }
        button.disabled = true;
        const originalText = button.textContent;
        button.textContent = '××©×—×–×¨...';
        try {
            const resp = await fetch(`/api/file/${fileId}/restore`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ version }),
            });
            const data = await resp.json().catch(() => ({}));
            if (!resp.ok || !data.ok) {
                throw new Error(data.error || '×©×’×™××” ×‘×©×—×–×•×¨ ×”×’×¨×¡×”');
            }
            showToast('×”×’×¨×¡×” ×©×•×—×–×¨×” ×‘×”×¦×œ×—×”', 'success');
            closeHistoryModal();
            const nextId = data.file_id || data.id;
            if (nextId) {
                window.location.href = `/file/${nextId}`;
            } else {
                window.location.reload();
            }
        } catch (err) {
            showToast(err.message || '×©×’×™××” ×‘×©×—×–×•×¨ ×”×’×¨×¡×”', 'error');
            button.disabled = false;
            button.textContent = originalText || '×©×—×–×¨';
        }
    }

    function openHistoryModal() {
        if (!historyModal) {
            return;
        }
        historyModal.hidden = false;
        fetchHistory().catch(() => {});
    }

    function closeHistoryModal() {
        if (!historyModal) {
            return;
        }
        historyModal.hidden = true;
    }

    if (historyModal) {
        historyModal.addEventListener('click', (event) => {
            if (event.target === historyModal) {
                closeHistoryModal();
            }
        });
        historyModal.querySelectorAll('[data-history-close]').forEach((btn) => {
            btn.addEventListener('click', closeHistoryModal);
        });
    }

    window.openHistoryModal = openHistoryModal;

    function openTrashConfirmModal() {
        if (!trashModal) return;
        trashModal.hidden = false;
    }

    function closeTrashConfirmModal() {
        if (!trashModal) return;
        trashModal.hidden = true;
        const confirmBtn = trashModal.querySelector('[data-trash-confirm]');
        if (confirmBtn) {
            confirmBtn.disabled = false;
        }
        trashPending = false;
    }

    async function confirmTrash() {
        if (!trashModal || !fileId || trashPending) {
            return;
        }
        const confirmBtn = trashModal.querySelector('[data-trash-confirm]');
        trashPending = true;
        if (confirmBtn) {
            confirmBtn.disabled = true;
        }
        try {
            const resp = await fetch(`/api/file/${fileId}/trash`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
            });
            const data = await resp.json().catch(() => ({}));
            if (!resp.ok || !data.ok) {
                throw new Error(data.error || '×©×’×™××” ×‘×”×¢×‘×¨×” ×œ×¡×œ');
            }
            showToast(data.message || '×”×§×•×‘×¥ ×”×•×¢×‘×¨ ×œ×¡×œ ×”××™×—×–×•×¨', 'success');
            closeTrashConfirmModal();
            setTimeout(() => { window.location.href = '/files'; }, 1100);
        } catch (err) {
            showToast(err.message || '×©×’×™××” ×‘×”×¢×‘×¨×” ×œ×¡×œ', 'error');
            trashPending = false;
            if (confirmBtn) {
                confirmBtn.disabled = false;
            }
        }
    }

    if (trashModal) {
        trashModal.addEventListener('click', (event) => {
            if (event.target === trashModal) {
                closeTrashConfirmModal();
            }
        });
        trashModal.querySelectorAll('[data-trash-close]').forEach((btn) => {
            btn.addEventListener('click', closeTrashConfirmModal);
        });
        const confirmBtn = trashModal.querySelector('[data-trash-confirm]');
        if (confirmBtn) {
            confirmBtn.addEventListener('click', confirmTrash);
        }
    }

    window.openTrashConfirmModal = openTrashConfirmModal;
})();
</script>
{% endblock %}