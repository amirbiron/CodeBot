{% extends "base.html" %}

{% block title %}{{ file.file_name }} - Code Keeper Bot{% endblock %}

{% block extra_css %}
<style id="syntax-css"></style>
<style>

.source {
    background: #1e1e1e !important;
    border-radius: 10px;
    padding: 1.5rem !important;
    overflow-x: auto;
    font-family: 'Fira Code', 'Consolas', 'Monaco', monospace;
    font-size: 14px;
    line-height: 1.6;
    direction: ltr;
    text-align: left;
    width: 100%;
}
.source .highlight,
.source .highlight pre {
    width: 100% !important;
    max-width: 100% !important;
    overflow: auto;
}

.source pre {
    margin: 0;
}

.linenodiv {
    margin-right: 1rem;
    user-select: none;
    opacity: 0.5;
}

/* פריסה טובה יותר ל-Pygments highlighttable (מספרי שורות + קוד) */
.highlighttable {
    width: 100% !important;
    table-layout: fixed;
    border-collapse: separate;
    border-spacing: 0;
}
.highlighttable td.linenos {
    width: 3.5rem;
    vertical-align: top;
}
.highlighttable td.code {
    width: auto;
    overflow: auto;
}
.highlighttable td.code pre {
    overflow: auto;
}

/* מיכל הקוד יתפרס לרוחב מלא */
.code-container {
    width: 100%;
    overflow: auto;
}

/* כותרת מקטע עם כפתור פעולה (למסך מלא) */
.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
}

/* כאשר הכרטיס במסך מלא – הקוד יתפוס כמעט את כל הגובה */
#codeCard:fullscreen .code-container {
    height: calc(100vh - 120px);
    overflow: auto;
}

.file-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 2rem;
    flex-wrap: wrap;
    gap: 1rem;
}

/* כותרת ושורת מידע: מניעת גלישה ויישור אליפסות */
.file-title-row {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
    min-width: 0; /* מאפשר אליפסות בצאצאים */
}
.file-icon {
    font-size: 2.25rem; /* היה 3rem – מקטין למניעת גלישה */
    line-height: 1;
    flex: 0 0 auto;
}
.file-title-wrap {
    min-width: 0;
    display: flex;
    flex-direction: column;
}
.file-title {
    margin: 0;
    font-size: 1.5rem; /* גודל שקול ל-section-title */
    line-height: 1.2;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
}
.file-subrow {
    display: flex;
    gap: 1rem;
    margin-top: 0.5rem;
    min-width: 0;
}

.file-info {
    flex: 1;
}

.file-actions {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.file-meta {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin: 2rem 0;
}

.meta-item {
    background: rgba(255,255,255,0.05);
    padding: 1rem;
    border-radius: 10px;
}

.meta-label {
    font-size: 0.9rem;
    opacity: 0.7;
    margin-bottom: 0.5rem;
}

.meta-value {
    font-size: 1.1rem;
    font-weight: 500;
}

.muted { opacity: 0.7; }

.copy-button {
    position: relative;
}

.copy-feedback {
    position: absolute;
    top: -40px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--success);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 5px;
    font-size: 0.9rem;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
}

.copy-feedback.show {
    opacity: 1;
}

/* הדגשת תוצאות חיפוש בתוך קוד */
.md-highlight {
    background: linear-gradient(90deg, #ffd700 0%, #ffed4e 100%);
    color: #000;
    padding: 2px 4px;
    border-radius: 3px;
    font-weight: 600;
}

/* הרחבת התצוגה לרוחב מלא בעמוד צפייה בקובץ */
.main-content > .container {
    max-width: 100% !important;
    width: 100% !important;
    padding-left: 16px;
    padding-right: 16px;
}

.glass-card,
.file-header,
.file-meta,
.code-container {
    width: 100% !important;
}

.source,
.source .highlight,
.source .highlight pre,
.highlighttable {
    width: 100% !important;
    max-width: 100% !important;
}

@media (max-width: 768px) {
    .file-header {
        flex-direction: column;
    }
    
    .file-actions {
        width: 100%;
        justify-content: stretch;
    }
    
    .file-actions .btn {
        flex: 1;
    }
    
    /* התאמות מובייל לתצוגת קוד */
    .source {
        font-size: 12px !important;
        padding: 0.75rem !important;
    }
    .file-icon { font-size: 2rem; }
    .file-title { font-size: 1.25rem; }
    .highlighttable td.linenos { width: 2.8rem; }
    .main-content > .container { padding-left: 10px; padding-right: 10px; }
}


/* Mini WebApp: שיפורים כאשר נטען בתוך טלגרם */
body.telegram-mini-app .source { font-size: 12px !important; padding: 0.75rem !important; }
body.telegram-mini-app .main-content > .container { padding-left: 10px !important; padding-right: 10px !important; }
/* Mini App: הקטנת הכותרת והאייקון ומניעת גלישה */
body.telegram-mini-app .file-icon { font-size: 1.9rem; }
body.telegram-mini-app .file-title { font-size: 1.125rem; }
</style>
{% endblock %}

{% block content %}
<script type="application/json" id="pygmentsCssData">{{ syntax_css|tojson|safe }}</script>
<div id="fileMeta" data-file-name="{{ file.file_name }}" style="display:none"></div>
<script>
// הזרקת CSS של Pygments בבטחה לתוך style#syntax-css, ללא Jinja בתוך JS
(function(){
    try {
        var dataEl = document.getElementById('pygmentsCssData');
        var css = '';
        if (dataEl) {
            try { css = JSON.parse(dataEl.textContent || '""'); } catch(e) { css = ''; }
        }
        var el = document.getElementById('syntax-css');
        if (el && css) { el.textContent = css; }
    } catch(e) {}
})();
</script>
<div class="file-header">
    <div class="file-info">
        <div class="file-title-row">
            <span class="file-icon">{{ file.icon }}</span>
            <div class="file-title-wrap">
                <h1 class="file-title">{{ file.file_name }}</h1>
                <div class="file-subrow">
                    <span class="badge">{{ file.language }}</span>
                    <span class="muted">גרסה {{ file.version }}</span>
                </div>
            </div>
        </div>
        
        {% if file.description %}
        <p style="margin: 1rem 0; opacity: 0.9; font-size: 1.1rem;">{{ file.description }}</p>
        {% endif %}
        
        {% if file.tags %}
        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin: 1rem 0;">
            {% for tag in file.tags %}
            <span class="badge" style="background: rgba(102, 126, 234, 0.2); border-color: rgba(102, 126, 234, 0.4);">
                #{{ tag }}
            </span>
            {% endfor %}
        </div>
        {% endif %}
    </div>
    
    <div class="file-actions">
        <a href="/edit/{{ file.id }}" class="btn btn-primary btn-icon">
            <i class="fas fa-edit"></i>
            ערוך
        </a>
        <button onclick="copyCode()" class="btn btn-primary btn-icon copy-button">
            <i class="fas fa-copy"></i>
            העתק קוד
            <div class="copy-feedback" id="copyFeedback">הועתק!</div>
        </button>
        {% if file.language|lower == 'html' or (file.file_name|lower).endswith('.html') or (file.file_name|lower).endswith('.htm') %}
        <a href="/html/{{ file.id }}" class="btn btn-secondary btn-icon">🌐 תצוגת דפדפן</a>
        {% endif %}
        {% if file.language|lower == 'markdown' or (file.file_name|lower).endswith('.md') %}
        <a href="/md/{{ file.id }}" class="btn btn-secondary btn-icon">🌐 תצוגת Markdown</a>
        {% endif %}
        <a href="/download/{{ file.id }}" class="btn btn-secondary btn-icon">
            <i class="fas fa-download"></i>
            הורד
        </a>
        <a href="#" onclick="return goBack(event)" class="btn btn-secondary btn-icon">
            <i class="fas fa-arrow-right"></i>
            חזור
        </a>
    </div>
</div>

<div class="file-meta glass-card">
    <div class="meta-item">
        <div class="meta-label"><i class="fas fa-weight"></i> גודל</div>
        <div class="meta-value">{{ file.size }}</div>
    </div>
    <div class="meta-item">
        <div class="meta-label"><i class="fas fa-list-ol"></i> שורות</div>
        <div class="meta-value">{{ file.lines }}</div>
    </div>
    <div class="meta-item">
        <div class="meta-label"><i class="fas fa-calendar-plus"></i> נוצר</div>
        <div class="meta-value">{{ file.created_at }}</div>
    </div>
    <div class="meta-item">
        <div class="meta-label"><i class="fas fa-calendar-check"></i> עודכן</div>
        <div class="meta-value">{{ file.updated_at }}</div>
    </div>
</div>

<div class="glass-card" id="codeCard">
    <div class="section-header">
        <h2 class="section-title" style="margin: 0;">
            <i class="fas fa-code"></i>
            קוד מקור
        </h2>
        <button id="fullscreenBtn" class="btn btn-secondary btn-icon" title="מסך מלא">
            <i class="fas fa-expand"></i>
            מסך מלא
        </button>
    </div>
    <div class="search-bar" id="code-search" style="display:flex;gap:.5rem;align-items:center;background:linear-gradient(135deg,#2d4a7c 0%,#3d5a8c 100%);padding:.75rem;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.2);margin-bottom:.75rem;">
        <input id="codeSearchInput" type="text" placeholder="🔍 חפש בקוד..." style="flex:1;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);border-radius:8px;padding:.6rem .8rem;color:#fff;font-size:.95rem;outline:none;">
        <span id="codeSearchCount" class="result-count" style="color:rgba(255,255,255,.9);font-size:.85rem;padding:.35rem .6rem;background:rgba(255,255,255,.12);border-radius:6px;min-width:60px;text-align:center;"></span>
        <button id="codeSearchClear" type="button" class="btn btn-secondary btn-icon" title="נקה" style="background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);">✕</button>
    </div>
    <div class="code-container">
        {{ highlighted_code|safe }}
    </div>
    {% if raw_code is defined %}
    <textarea id="rawCode" style="position: absolute; left: -9999px; height: 0; opacity: 0;">{{ raw_code }}</textarea>
    {% endif %}
</div>

<div class="glass-card" style="margin-top: 2rem;">
    <h2 class="section-title">
        <i class="fas fa-share-alt"></i>
        שיתוף
    </h2>
    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <button onclick="shareToTelegram()" class="btn btn-secondary btn-icon">
            <i class="fab fa-telegram"></i>
            שתף בטלגרם
        </button>
        <button onclick="copyLink()" class="btn btn-secondary btn-icon">
            <i class="fas fa-link"></i>
            העתק קישור
        </button>
    </div>
</div>

<script>
function copyCode() {
    // אם יש rawCode שנשלח מהשרת — נשתמש בו כדי להימנע ממספרי שורות/HTML
    const rawArea = document.getElementById('rawCode');
    let code = rawArea ? rawArea.value : '';
    if (!code) {
        // fallback ישן
        const codeLines = document.querySelectorAll('.source .highlight pre span');
        if (codeLines.length > 0) {
            codeLines.forEach(span => {
                if (!span.classList.contains('linenos')) {
                    code += span.textContent;
                }
            });
        } else {
            const codeElement = document.querySelector('.source .highlight pre');
            if (codeElement) {
                const fullText = codeElement.textContent;
                const lines = fullText.split('\n');
                code = lines.map(line => line.replace(/^\s*\d+\s*/, '')).join('\n');
            }
        }
    }
    
    if (!code) {
        // נסיון אחרון - לקחת את כל הטקסט מה-highlight div
        const highlightDiv = document.querySelector('.source .highlight');
        if (highlightDiv) {
            // יצירת clone זמני
            const tempDiv = highlightDiv.cloneNode(true);
            // הסרת אלמנט מספרי השורות
            const linenosDiv = tempDiv.querySelector('.linenodiv');
            if (linenosDiv) {
                linenosDiv.remove();
            }
            code = tempDiv.textContent || tempDiv.innerText;
        }
    }
    
    if (code) {
        navigator.clipboard.writeText(code).then(() => {
            const feedback = document.getElementById('copyFeedback');
            feedback.classList.add('show');
            setTimeout(() => {
                feedback.classList.remove('show');
            }, 2000);
        }).catch(err => {
            console.error('Failed to copy:', err);
            // נסיון חלופי עם textarea זמני
            const textarea = document.createElement('textarea');
            textarea.value = code;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                const feedback = document.getElementById('copyFeedback');
                feedback.classList.add('show');
                setTimeout(() => {
                    feedback.classList.remove('show');
                }, 2000);
            } catch (err2) {
                alert('לא הצלחנו להעתיק את הקוד');
            }
            document.body.removeChild(textarea);
        });
    } else {
        alert('לא נמצא קוד להעתקה');
    }
}

async function ensurePublicLink() {
    try {
        const resp = await fetch(`/api/share/{{ file.id }}`, { method: 'POST' });
        const data = await resp.json();
        if (data && data.ok && data.url) {
            return data.url;
        }
        // fallback: קישור הנוכחי
        return window.location.href;
    } catch (e) {
        console.error('share create failed', e);
        return window.location.href;
    }
}

async function copyLink() {
    const url = await ensurePublicLink();
    navigator.clipboard.writeText(url).then(() => {
        alert('הקישור הציבורי הועתק!');
    }).catch(err => {
        console.error('Failed to copy:', err);
        alert('לא הצלחנו להעתיק את הקישור');
    });
}

async function shareToTelegram() {
    var metaDiv = document.getElementById('fileMeta');
    const fileName = metaDiv ? metaDiv.getAttribute('data-file-name') : '';
    const url = await ensurePublicLink();
    const text = `בדוק את הקובץ ${fileName} ב-Code Keeper:\n${url}`;
    const telegramUrl = `https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`;
    window.open(telegramUrl, '_blank');
}

// הוספת קיצורי מקלדת
document.addEventListener('keydown', function(e) {
    // Ctrl+C או Cmd+C להעתקת קוד
    if ((e.ctrlKey || e.metaKey) && e.key === 'c' && !window.getSelection().toString()) {
        e.preventDefault();
        copyCode();
    }
    // Escape: אם במסך מלא – לצאת ממנו; אחרת – חזרה לרשימה
    if (e.key === 'Escape') {
        const codeCard = document.getElementById('codeCard');
        if (document.fullscreenElement && document.fullscreenElement === codeCard) {
            e.preventDefault();
            try { document.exitFullscreen(); } catch (err) { /* ignore */ }
            return;
        }
        goBack();
    }
});

// מסך מלא עבור מיכל הקוד
(function(){
    const btn = document.getElementById('fullscreenBtn');
    const card = document.getElementById('codeCard');
    if (!btn || !card) return;

    function isFullscreen(){
        return document.fullscreenElement === card;
    }

    function updateButton(){
        const icon = btn.querySelector('i');
        if (isFullscreen()) {
            btn.innerHTML = '<i class="fas fa-compress"></i> יציאה ממסך מלא';
        } else {
            btn.innerHTML = '<i class="fas fa-expand"></i> מסך מלא';
        }
    }

    btn.addEventListener('click', async function(){
        try {
            if (!isFullscreen()) {
                await card.requestFullscreen();
            } else {
                await document.exitFullscreen();
            }
        } catch (e) {
            console.error('fullscreen error', e);
        }
    });

    document.addEventListener('fullscreenchange', updateButton);
    updateButton();
})();

// חזרה למסך הקודם בצורה אמינה (שומרת מסננים/דפדוף)
function goBack(ev){
    try { if (ev) ev.preventDefault(); } catch(e){}
    try {
        // אם יש היסטוריה – חזור צעד אחד בלבד
        if (window.history && window.history.length > 1) {
            window.history.back();
            return false;
        }
        // אם יש referrer מאותו דומיין – ננווט אליו
        if (document.referrer) {
            const ref = new URL(document.referrer, window.location.origin);
            if (ref.origin === window.location.origin) {
                window.location.href = ref.toString();
                return false;
            }
        }
    } catch (e) {}
    // ברירת מחדל: רשימת קבצים
    window.location.href = '/files';
    return false;
}
</script>
<script>
// הדגשת חיפוש בקוד (ב-Pygments HTML)
(function(){
    try {
        const container = document.querySelector('#codeCard .code-container');
        const input = document.getElementById('codeSearchInput');
        const clearBtn = document.getElementById('codeSearchClear');
        const countEl = document.getElementById('codeSearchCount');
        if (!container || !input || !clearBtn || !countEl) return;

        // שמירת HTML מקורי
        container.setAttribute('data-original-html', container.innerHTML);

        function restore(){
            try { container.innerHTML = container.getAttribute('data-original-html') || container.innerHTML; } catch(_) {}
        }

        function highlightTerm(term){
            // בתוך הקוד בלבד: הדגשה בתוך התאים של ה-highlighttable/ .highlight
            let total = 0;
            const codeRoots = container.querySelectorAll('.highlight, .highlighttable td.code, .source .highlight, pre');
            codeRoots.forEach(root => {
                try {
                    const original = root.getAttribute('data-original-html') || root.innerHTML;
                    root.setAttribute('data-original-html', original);
                    if (!term) { root.innerHTML = original; return; }
                    const safe = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    const rx = new RegExp(`(${safe})`, 'gi');
                    const replaced = original.replace(rx, '<span class="md-highlight">$1</span>');
                    root.innerHTML = replaced;
                    total += (original.match(rx) || []).length;
                } catch(_) {}
            });
            return total;
        }

        function updateCount(n, term){
            if (!term) { countEl.textContent = ''; return; }
            countEl.textContent = n > 0 ? `${n} תוצאות` : 'אין תוצאות';
        }

        function scrollToFirst(){
            const first = container.querySelector('.md-highlight');
            if (first) try { first.scrollIntoView({ behavior:'smooth', block:'center' }); } catch(_){ }
        }

        input.addEventListener('input', () => {
            const term = (input.value || '').trim();
            restore();
            const n = highlightTerm(term);
            updateCount(n, term);
            if (term && n > 0) scrollToFirst();
        });

        clearBtn.addEventListener('click', () => {
            input.value = '';
            restore();
            updateCount(0, '');
        });
    } catch(_) {}
})();
</script>
{% endblock %}