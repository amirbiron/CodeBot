{% extends "base.html" %}

{% block title %}{{ file.file_name }} - Code Keeper Bot{% endblock %}

{% block extra_css %}
<style>
{{ syntax_css }}

.source {
    background: #1e1e1e !important;
    border-radius: 10px;
    padding: 1.5rem !important;
    overflow-x: auto;
    font-family: 'Fira Code', 'Consolas', 'Monaco', monospace;
    font-size: 14px;
    line-height: 1.6;
    direction: ltr;
    text-align: left;
    width: 100%;
}
.source .highlight,
.source .highlight pre {
    width: 100% !important;
    max-width: 100% !important;
    overflow: auto;
}

.source pre {
    margin: 0;
}

.linenodiv {
    margin-right: 1rem;
    user-select: none;
    opacity: 0.5;
}

/* ×¤×¨×™×¡×” ×˜×•×‘×” ×™×•×ª×¨ ×œ-Pygments highlighttable (××¡×¤×¨×™ ×©×•×¨×•×ª + ×§×•×“) */
.highlighttable {
    width: 100% !important;
    table-layout: fixed;
    border-collapse: separate;
    border-spacing: 0;
}
.highlighttable td.linenos {
    width: 3.5rem;
    vertical-align: top;
}
.highlighttable td.code {
    width: auto;
    overflow: auto;
}
.highlighttable td.code pre {
    overflow: auto;
}

/* ××™×›×œ ×”×§×•×“ ×™×ª×¤×¨×¡ ×œ×¨×•×—×‘ ××œ× */
.code-container {
    width: 100%;
    overflow: auto;
}

/* ×›×•×ª×¨×ª ××§×˜×¢ ×¢× ×›×¤×ª×•×¨ ×¤×¢×•×œ×” (×œ××¡×š ××œ×) */
.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
}

/* ×›××©×¨ ×”×›×¨×˜×™×¡ ×‘××¡×š ××œ× â€“ ×”×§×•×“ ×™×ª×¤×•×¡ ×›××¢×˜ ××ª ×›×œ ×”×’×•×‘×” */
#codeCard:fullscreen .code-container {
    height: calc(100vh - 120px);
    overflow: auto;
}

.file-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 2rem;
    flex-wrap: wrap;
    gap: 1rem;
}

.file-info {
    flex: 1;
}

.file-actions {
    display: flex;
    gap: 1rem;
}

.file-meta {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin: 2rem 0;
}

.meta-item {
    background: rgba(255,255,255,0.05);
    padding: 1rem;
    border-radius: 10px;
}

.meta-label {
    font-size: 0.9rem;
    opacity: 0.7;
    margin-bottom: 0.5rem;
}

.meta-value {
    font-size: 1.1rem;
    font-weight: 500;
}

.copy-button {
    position: relative;
}

.copy-feedback {
    position: absolute;
    top: -40px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--success);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 5px;
    font-size: 0.9rem;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
}

.copy-feedback.show {
    opacity: 1;
}

/* ×”×¨×—×‘×ª ×”×ª×¦×•×’×” ×œ×¨×•×—×‘ ××œ× ×‘×¢××•×“ ×¦×¤×™×™×” ×‘×§×•×‘×¥ */
.main-content > .container {
    max-width: 100% !important;
    width: 100% !important;
    padding-left: 16px;
    padding-right: 16px;
}

.glass-card,
.file-header,
.file-meta,
.code-container {
    width: 100% !important;
}

.source,
.source .highlight,
.source .highlight pre,
.highlighttable {
    width: 100% !important;
    max-width: 100% !important;
}

@media (max-width: 768px) {
    .file-header {
        flex-direction: column;
    }
    
    .file-actions {
        width: 100%;
        justify-content: stretch;
    }
    
    .file-actions .btn {
        flex: 1;
    }
    
    /* ×”×ª×××•×ª ××•×‘×™×™×œ ×œ×ª×¦×•×’×ª ×§×•×“ */
    .source {
        font-size: 12px !important;
        padding: 0.75rem !important;
    }
    .highlighttable td.linenos { width: 2.8rem; }
    .main-content > .container { padding-left: 10px; padding-right: 10px; }
}


/* Mini WebApp: ×©×™×¤×•×¨×™× ×›××©×¨ × ×˜×¢×Ÿ ×‘×ª×•×š ×˜×œ×’×¨× */
body.telegram-mini-app .source { font-size: 12px !important; padding: 0.75rem !important; }
body.telegram-mini-app .main-content > .container { padding-left: 10px !important; padding-right: 10px !important; }
</style>
{% endblock %}

{% block content %}
<div class="file-header">
    <div class="file-info">
        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
            <span style="font-size: 3rem;">{{ file.icon }}</span>
            <div>
                <h1 style="margin: 0;">{{ file.file_name }}</h1>
                <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                    <span class="badge">{{ file.language }}</span>
                    <span style="opacity: 0.7;">×’×¨×¡×” {{ file.version }}</span>
                </div>
            </div>
        </div>
        
        {% if file.description %}
        <p style="margin: 1rem 0; opacity: 0.9; font-size: 1.1rem;">{{ file.description }}</p>
        {% endif %}
        
        {% if file.tags %}
        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin: 1rem 0;">
            {% for tag in file.tags %}
            <span class="badge" style="background: rgba(102, 126, 234, 0.2); border-color: rgba(102, 126, 234, 0.4);">
                #{{ tag }}
            </span>
            {% endfor %}
        </div>
        {% endif %}
    </div>
    
    <div class="file-actions">
        <button onclick="copyCode()" class="btn btn-primary btn-icon copy-button">
            <i class="fas fa-copy"></i>
            ×”×¢×ª×§ ×§×•×“
            <div class="copy-feedback" id="copyFeedback">×”×•×¢×ª×§!</div>
        </button>
        {% if file.language|lower == 'html' or (file.file_name|lower).endswith('.html') or (file.file_name|lower).endswith('.htm') %}
        <a href="/html/{{ file.id }}" class="btn btn-secondary btn-icon">
            ğŸŒ ×ª×¦×•×’×ª ×“×¤×“×¤×Ÿ
        </a>
        {% endif %}
        <a href="/download/{{ file.id }}" class="btn btn-secondary btn-icon">
            <i class="fas fa-download"></i>
            ×”×•×¨×“
        </a>
        <a href="/files" class="btn btn-secondary btn-icon">
            <i class="fas fa-arrow-right"></i>
            ×—×–×•×¨
        </a>
    </div>
</div>

<div class="file-meta glass-card">
    <div class="meta-item">
        <div class="meta-label"><i class="fas fa-weight"></i> ×’×•×“×œ</div>
        <div class="meta-value">{{ file.size }}</div>
    </div>
    <div class="meta-item">
        <div class="meta-label"><i class="fas fa-list-ol"></i> ×©×•×¨×•×ª</div>
        <div class="meta-value">{{ file.lines }}</div>
    </div>
    <div class="meta-item">
        <div class="meta-label"><i class="fas fa-calendar-plus"></i> × ×•×¦×¨</div>
        <div class="meta-value">{{ file.created_at }}</div>
    </div>
    <div class="meta-item">
        <div class="meta-label"><i class="fas fa-calendar-check"></i> ×¢×•×“×›×Ÿ</div>
        <div class="meta-value">{{ file.updated_at }}</div>
    </div>
</div>

<div class="glass-card" id="codeCard">
    <div class="section-header">
        <h2 class="section-title" style="margin: 0;">
            <i class="fas fa-code"></i>
            ×§×•×“ ××§×•×¨
        </h2>
        <button id="fullscreenBtn" class="btn btn-secondary btn-icon" title="××¡×š ××œ×">
            <i class="fas fa-expand"></i>
            ××¡×š ××œ×
        </button>
    </div>
    <div class="code-container">
        {{ highlighted_code|safe }}
    </div>
    {% if raw_code is defined %}
    <textarea id="rawCode" style="position: absolute; left: -9999px; height: 0; opacity: 0;">{{ raw_code }}</textarea>
    {% endif %}
</div>

<div class="glass-card" style="margin-top: 2rem;">
    <h2 class="section-title">
        <i class="fas fa-share-alt"></i>
        ×©×™×ª×•×£
    </h2>
    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <button onclick="shareToTelegram()" class="btn btn-secondary btn-icon">
            <i class="fab fa-telegram"></i>
            ×©×ª×£ ×‘×˜×œ×’×¨×
        </button>
        <button onclick="copyLink()" class="btn btn-secondary btn-icon">
            <i class="fas fa-link"></i>
            ×”×¢×ª×§ ×§×™×©×•×¨
        </button>
    </div>
</div>

<script>
function copyCode() {
    // ×× ×™×© rawCode ×©× ×©×œ×— ××”×©×¨×ª â€” × ×©×ª××© ×‘×• ×›×“×™ ×œ×”×™×× ×¢ ×××¡×¤×¨×™ ×©×•×¨×•×ª/HTML
    const rawArea = document.getElementById('rawCode');
    let code = rawArea ? rawArea.value : '';
    if (!code) {
        // fallback ×™×©×Ÿ
        const codeLines = document.querySelectorAll('.source .highlight pre span');
        if (codeLines.length > 0) {
            codeLines.forEach(span => {
                if (!span.classList.contains('linenos')) {
                    code += span.textContent;
                }
            });
        } else {
            const codeElement = document.querySelector('.source .highlight pre');
            if (codeElement) {
                const fullText = codeElement.textContent;
                const lines = fullText.split('\n');
                code = lines.map(line => line.replace(/^\s*\d+\s*/, '')).join('\n');
            }
        }
    }
    
    if (!code) {
        // × ×¡×™×•×Ÿ ××—×¨×•×Ÿ - ×œ×§×—×ª ××ª ×›×œ ×”×˜×§×¡×˜ ××”-highlight div
        const highlightDiv = document.querySelector('.source .highlight');
        if (highlightDiv) {
            // ×™×¦×™×¨×ª clone ×–×× ×™
            const tempDiv = highlightDiv.cloneNode(true);
            // ×”×¡×¨×ª ××œ×× ×˜ ××¡×¤×¨×™ ×”×©×•×¨×•×ª
            const linenosDiv = tempDiv.querySelector('.linenodiv');
            if (linenosDiv) {
                linenosDiv.remove();
            }
            code = tempDiv.textContent || tempDiv.innerText;
        }
    }
    
    if (code) {
        navigator.clipboard.writeText(code).then(() => {
            const feedback = document.getElementById('copyFeedback');
            feedback.classList.add('show');
            setTimeout(() => {
                feedback.classList.remove('show');
            }, 2000);
        }).catch(err => {
            console.error('Failed to copy:', err);
            // × ×¡×™×•×Ÿ ×—×œ×•×¤×™ ×¢× textarea ×–×× ×™
            const textarea = document.createElement('textarea');
            textarea.value = code;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                const feedback = document.getElementById('copyFeedback');
                feedback.classList.add('show');
                setTimeout(() => {
                    feedback.classList.remove('show');
                }, 2000);
            } catch (err2) {
                alert('×œ× ×”×¦×œ×—× ×• ×œ×”×¢×ª×™×§ ××ª ×”×§×•×“');
            }
            document.body.removeChild(textarea);
        });
    } else {
        alert('×œ× × ××¦× ×§×•×“ ×œ×”×¢×ª×§×”');
    }
}

async function ensurePublicLink() {
    try {
        const resp = await fetch(`/api/share/{{ file.id }}`, { method: 'POST' });
        const data = await resp.json();
        if (data && data.ok && data.url) {
            return data.url;
        }
        // fallback: ×§×™×©×•×¨ ×”× ×•×›×—×™
        return window.location.href;
    } catch (e) {
        console.error('share create failed', e);
        return window.location.href;
    }
}

async function copyLink() {
    const url = await ensurePublicLink();
    navigator.clipboard.writeText(url).then(() => {
        alert('×”×§×™×©×•×¨ ×”×¦×™×‘×•×¨×™ ×”×•×¢×ª×§!');
    }).catch(err => {
        console.error('Failed to copy:', err);
        alert('×œ× ×”×¦×œ×—× ×• ×œ×”×¢×ª×™×§ ××ª ×”×§×™×©×•×¨');
    });
}

async function shareToTelegram() {
    const fileName = {{ file.file_name|tojson }};
    const url = await ensurePublicLink();
    const text = `×‘×“×•×§ ××ª ×”×§×•×‘×¥ ${fileName} ×‘-Code Keeper:\n${url}`;
    const telegramUrl = `https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`;
    window.open(telegramUrl, '_blank');
}

// ×”×•×¡×¤×ª ×§×™×¦×•×¨×™ ××§×œ×“×ª
document.addEventListener('keydown', function(e) {
    // Ctrl+C ××• Cmd+C ×œ×”×¢×ª×§×ª ×§×•×“
    if ((e.ctrlKey || e.metaKey) && e.key === 'c' && !window.getSelection().toString()) {
        e.preventDefault();
        copyCode();
    }
    // Escape: ×× ×‘××¡×š ××œ× â€“ ×œ×¦××ª ××× ×•; ××—×¨×ª â€“ ×—×–×¨×” ×œ×¨×©×™××”
    if (e.key === 'Escape') {
        const codeCard = document.getElementById('codeCard');
        if (document.fullscreenElement && document.fullscreenElement === codeCard) {
            e.preventDefault();
            try { document.exitFullscreen(); } catch (err) { /* ignore */ }
            return;
        }
        window.location.href = '/files';
    }
});

// ××¡×š ××œ× ×¢×‘×•×¨ ××™×›×œ ×”×§×•×“
(function(){
    const btn = document.getElementById('fullscreenBtn');
    const card = document.getElementById('codeCard');
    if (!btn || !card) return;

    function isFullscreen(){
        return document.fullscreenElement === card;
    }

    function updateButton(){
        const icon = btn.querySelector('i');
        if (isFullscreen()) {
            btn.innerHTML = '<i class="fas fa-compress"></i> ×™×¦×™××” ×××¡×š ××œ×';
        } else {
            btn.innerHTML = '<i class="fas fa-expand"></i> ××¡×š ××œ×';
        }
    }

    btn.addEventListener('click', async function(){
        try {
            if (!isFullscreen()) {
                await card.requestFullscreen();
            } else {
                await document.exitFullscreen();
            }
        } catch (e) {
            console.error('fullscreen error', e);
        }
    });

    document.addEventListener('fullscreenchange', updateButton);
    updateButton();
})();
</script>
{% endblock %}