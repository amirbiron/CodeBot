{% extends "base.html" %}

{% block title %}{{ file.file_name }} - Code Keeper Bot{% endblock %}

{% block extra_css %}
<style>
{{ syntax_css }}

.source {
    background: #1e1e1e !important;
    border-radius: 10px;
    padding: 1.5rem !important;
    overflow-x: auto;
    font-family: 'Fira Code', 'Consolas', 'Monaco', monospace;
    font-size: 14px;
    line-height: 1.6;
    direction: ltr;
    text-align: left;
    width: 100%;
}

.source pre {
    margin: 0;
}

.linenodiv {
    margin-right: 1rem;
    user-select: none;
    opacity: 0.5;
}

/* פריסה טובה יותר ל-Pygments highlighttable (מספרי שורות + קוד) */
.highlighttable {
    width: 100% !important;
    table-layout: fixed;
}
.highlighttable td.linenos {
    width: 3.5rem;
    vertical-align: top;
}
.highlighttable td.code {
    width: auto;
}

/* מיכל הקוד יתפרס לרוחב מלא */
.code-container {
    width: 100%;
    overflow: auto;
}

.file-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 2rem;
    flex-wrap: wrap;
    gap: 1rem;
}

.file-info {
    flex: 1;
}

.file-actions {
    display: flex;
    gap: 1rem;
}

.file-meta {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin: 2rem 0;
}

.meta-item {
    background: rgba(255,255,255,0.05);
    padding: 1rem;
    border-radius: 10px;
}

.meta-label {
    font-size: 0.9rem;
    opacity: 0.7;
    margin-bottom: 0.5rem;
}

.meta-value {
    font-size: 1.1rem;
    font-weight: 500;
}

.copy-button {
    position: relative;
}

.copy-feedback {
    position: absolute;
    top: -40px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--success);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 5px;
    font-size: 0.9rem;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
}

.copy-feedback.show {
    opacity: 1;
}

@media (max-width: 768px) {
    .file-header {
        flex-direction: column;
    }
    
    .file-actions {
        width: 100%;
        justify-content: stretch;
    }
    
    .file-actions .btn {
        flex: 1;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="file-header">
    <div class="file-info">
        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
            <span style="font-size: 3rem;">{{ file.icon }}</span>
            <div>
                <h1 style="margin: 0;">{{ file.file_name }}</h1>
                <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                    <span class="badge">{{ file.language }}</span>
                    <span style="opacity: 0.7;">גרסה {{ file.version }}</span>
                </div>
            </div>
        </div>
        
        {% if file.description %}
        <p style="margin: 1rem 0; opacity: 0.9; font-size: 1.1rem;">{{ file.description }}</p>
        {% endif %}
        
        {% if file.tags %}
        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin: 1rem 0;">
            {% for tag in file.tags %}
            <span class="badge" style="background: rgba(102, 126, 234, 0.2); border-color: rgba(102, 126, 234, 0.4);">
                #{{ tag }}
            </span>
            {% endfor %}
        </div>
        {% endif %}
    </div>
    
    <div class="file-actions">
        <button onclick="copyCode()" class="btn btn-primary btn-icon copy-button">
            <i class="fas fa-copy"></i>
            העתק קוד
            <div class="copy-feedback" id="copyFeedback">הועתק!</div>
        </button>
        <a href="/download/{{ file.id }}" class="btn btn-secondary btn-icon">
            <i class="fas fa-download"></i>
            הורד
        </a>
        <a href="/files" class="btn btn-secondary btn-icon">
            <i class="fas fa-arrow-right"></i>
            חזור
        </a>
    </div>
</div>

<div class="file-meta glass-card">
    <div class="meta-item">
        <div class="meta-label"><i class="fas fa-weight"></i> גודל</div>
        <div class="meta-value">{{ file.size }}</div>
    </div>
    <div class="meta-item">
        <div class="meta-label"><i class="fas fa-list-ol"></i> שורות</div>
        <div class="meta-value">{{ file.lines }}</div>
    </div>
    <div class="meta-item">
        <div class="meta-label"><i class="fas fa-calendar-plus"></i> נוצר</div>
        <div class="meta-value">{{ file.created_at }}</div>
    </div>
    <div class="meta-item">
        <div class="meta-label"><i class="fas fa-calendar-check"></i> עודכן</div>
        <div class="meta-value">{{ file.updated_at }}</div>
    </div>
</div>

<div class="glass-card">
    <h2 class="section-title">
        <i class="fas fa-code"></i>
        קוד מקור
    </h2>
    <div class="code-container">
        {{ highlighted_code|safe }}
    </div>
    {% if raw_code is defined %}
    <textarea id="rawCode" style="position: absolute; left: -9999px; height: 0; opacity: 0;">{{ raw_code }}</textarea>
    {% endif %}
</div>

<div class="glass-card" style="margin-top: 2rem;">
    <h2 class="section-title">
        <i class="fas fa-share-alt"></i>
        שיתוף
    </h2>
    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <button onclick="shareToTelegram()" class="btn btn-secondary btn-icon">
            <i class="fab fa-telegram"></i>
            שתף בטלגרם
        </button>
        <button onclick="copyLink()" class="btn btn-secondary btn-icon">
            <i class="fas fa-link"></i>
            העתק קישור
        </button>
    </div>
</div>

<script>
function copyCode() {
    // אם יש rawCode שנשלח מהשרת — נשתמש בו כדי להימנע ממספרי שורות/HTML
    const rawArea = document.getElementById('rawCode');
    let code = rawArea ? rawArea.value : '';
    if (!code) {
        // fallback ישן
        const codeLines = document.querySelectorAll('.source .highlight pre span');
        if (codeLines.length > 0) {
            codeLines.forEach(span => {
                if (!span.classList.contains('linenos')) {
                    code += span.textContent;
                }
            });
        } else {
            const codeElement = document.querySelector('.source .highlight pre');
            if (codeElement) {
                const fullText = codeElement.textContent;
                const lines = fullText.split('\n');
                code = lines.map(line => line.replace(/^\s*\d+\s*/, '')).join('\n');
            }
        }
    }
    
    if (!code) {
        // נסיון אחרון - לקחת את כל הטקסט מה-highlight div
        const highlightDiv = document.querySelector('.source .highlight');
        if (highlightDiv) {
            // יצירת clone זמני
            const tempDiv = highlightDiv.cloneNode(true);
            // הסרת אלמנט מספרי השורות
            const linenosDiv = tempDiv.querySelector('.linenodiv');
            if (linenosDiv) {
                linenosDiv.remove();
            }
            code = tempDiv.textContent || tempDiv.innerText;
        }
    }
    
    if (code) {
        navigator.clipboard.writeText(code).then(() => {
            const feedback = document.getElementById('copyFeedback');
            feedback.classList.add('show');
            setTimeout(() => {
                feedback.classList.remove('show');
            }, 2000);
        }).catch(err => {
            console.error('Failed to copy:', err);
            // נסיון חלופי עם textarea זמני
            const textarea = document.createElement('textarea');
            textarea.value = code;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                const feedback = document.getElementById('copyFeedback');
                feedback.classList.add('show');
                setTimeout(() => {
                    feedback.classList.remove('show');
                }, 2000);
            } catch (err2) {
                alert('לא הצלחנו להעתיק את הקוד');
            }
            document.body.removeChild(textarea);
        });
    } else {
        alert('לא נמצא קוד להעתקה');
    }
}

function copyLink() {
    const url = window.location.href;
    navigator.clipboard.writeText(url).then(() => {
        alert('הקישור הועתק!');
    }).catch(err => {
        console.error('Failed to copy:', err);
        alert('לא הצלחנו להעתיק את הקישור');
    });
}

function shareToTelegram() {
    const fileName = {{ file.file_name|tojson }};
    const url = window.location.href;
    const text = `בדוק את הקובץ ${fileName} ב-Code Keeper:\n${url}`;
    const telegramUrl = `https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`;
    window.open(telegramUrl, '_blank');
}

// הוספת קיצורי מקלדת
document.addEventListener('keydown', function(e) {
    // Ctrl+C או Cmd+C להעתקת קוד
    if ((e.ctrlKey || e.metaKey) && e.key === 'c' && !window.getSelection().toString()) {
        e.preventDefault();
        copyCode();
    }
    // Escape לחזרה לרשימה
    if (e.key === 'Escape') {
        window.location.href = '/files';
    }
});
</script>
{% endblock %}