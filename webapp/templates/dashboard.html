{% extends "base.html" %}

{% block title %}×“×©×‘×•×¨×“ - Code Keeper Bot{% endblock %}

{% block content %}
<h1 class="page-title">×“×©×‘×•×¨×“</h1>

<div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 3rem;">
    <div class="glass-card stat-card">
        <div class="stat-icon" style="font-size: 2.5rem; margin-bottom: 1rem;">ğŸ“</div>
        <div class="stat-value" style="font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem;">{{ stats.total_files }}</div>
        <div class="stat-label" style="opacity: 0.8;">×¡×š ×”×›×œ ×§×‘×¦×™×</div>
    </div>

    <div class="glass-card stat-card">
        <div class="stat-icon" style="font-size: 2.5rem; margin-bottom: 1rem;">ğŸ’¾</div>
        <div class="stat-value" style="font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem;">{{ stats.total_size }}</div>
        <div class="stat-label" style="opacity: 0.8;">× ×¤×— ×›×•×œ×œ</div>
    </div>

    <div class="glass-card stat-card">
        <div class="stat-icon" style="font-size: 2.5rem; margin-bottom: 1rem;">ğŸ†</div>
        <div class="stat-value" style="font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem;">
            {% if stats.top_languages %}
                {{ stats.top_languages[0].icon }} {{ stats.top_languages[0].name }}
            {% else %}
                -
            {% endif %}
        </div>
        <div class="stat-label" style="opacity: 0.8;">×”×©×¤×” ×”×¤×•×¤×•×œ×¨×™×ª ×‘×™×•×ª×¨</div>
    </div>

    <div class="glass-card stat-card">
        <div class="stat-icon" style="font-size: 2.5rem; margin-bottom: 1rem;">â°</div>
        <div class="stat-value" style="font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem;">
            {% if stats.recent_files %}
                ×”×™×•×
            {% else %}
                -
            {% endif %}
        </div>
        <div class="stat-label" style="opacity: 0.8;">×¤×¢×™×œ×•×ª ××—×¨×•× ×”</div>
    </div>
</div>

<div class="dashboard-grid {{ 'has-last-commit' if user_is_admin and last_commit else 'no-last-commit' }}">
    {% if pinned_files %}
    <section class="pinned-section glass-card widget-pinned" id="pinnedFiles">
        <div class="pinned-header">
            <h2 class="section-title">
                <i class="fas fa-thumbtack"></i>
                ×§×‘×¦×™× × ×¢×•×¦×™×
            </h2>
            <span class="badge" data-pinned-count data-max-pinned="{{ max_pinned }}">{{ pinned_files|length }}/{{ max_pinned }}</span>
        </div>
        
        <div class="pinned-grid" data-pinned-grid>
            {% for file in pinned_files %}
            <a href="/file/{{ file.id }}" class="pinned-card" data-pinned-card data-file-id="{{ file.id }}">
                <div class="pinned-card__icon">{{ file.icon }}</div>
                <div class="pinned-card__content">
                    <div class="pinned-card__name" title="{{ file.file_name }}">
                        {{ file.file_name }}
                    </div>
                    <div class="pinned-card__meta">
                        <span class="lang-badge" data-lang="{{ file.language|lower }}">{{ file.language }}</span>
                        {% if file.lines %}
                        <span class="pinned-card__lines">{{ file.lines }} ×©×•×¨×•×ª</span>
                        {% endif %}
                    </div>
                    {% if file.description %}
                    <div class="pinned-card__note">{{ file.description }}</div>
                    {% endif %}
                </div>
                <button type="button"
                        class="pinned-card__unpin"
                        data-unpin-file="{{ file.id }}"
                        title="×”×¡×¨ ×× ×¢×•×¦×™×"
                        aria-label="×”×¡×¨ ×× ×¢×•×¦×™×"
                        onclick="event.preventDefault(); event.stopPropagation(); unpinFile('{{ file.id }}');">
                    âœ•
                </button>
            </a>
            {% endfor %}
        </div>
        
        {% if pinned_files|length < max_pinned %}
        <p class="pinned-hint">
            ğŸ’¡ × ×™×ª×Ÿ ×œ× ×¢×•×¥ ×¢×“ {{ max_pinned }} ×§×‘×¦×™×. × ×¢×¥ ×§×‘×¦×™× ×“×¨×š ×ª×¤×¨×™×˜ â‹® ×‘×¢××•×“ ×”×§×•×‘×¥.
        </p>
        {% endif %}
    </section>
    {% endif %}
    <div class="glass-card languages-card widget-languages widget-languages--top">
        <h2 class="section-title">
            <i class="fas fa-code"></i>
            ×©×¤×•×ª ×ª×›× ×•×ª
        </h2>
        {% if stats.top_languages %}
        <div class="languages-list">
            {% for lang in stats.top_languages %}
            <div class="language-item">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <span style="font-size: 1.5rem;">{{ lang.icon }}</span>
                    <span style="font-weight: 500;">{{ lang.name }}</span>
                </div>
                <div class="badge">{{ lang.count }} ×§×‘×¦×™×</div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p style="opacity: 0.7;">××™×Ÿ ×¢×“×™×™×Ÿ ×§×‘×¦×™×</p>
        {% endif %}
    </div>

    <div class="glass-card whats-new-card widget-whats-new" data-whats-new-card>
        <h2 class="section-title">
            <i class="fas fa-wand-magic-sparkles"></i>
            ××” ×—×“×©
        </h2>
        {% if whats_new.has_features %}
        <div class="whats-new-list" data-whats-new-list>
            {% for feature in whats_new.features %}
            <div class="whats-new-item">
                <div class="feature-content">
                    <span class="feature-icon">{{ feature.icon }}</span>
                    <div class="feature-details">
                        <div class="feature-title">
                            {{ feature.title }}
                            {% if feature.badge %}
                            <span class="feature-badge">{{ feature.badge }}</span>
                            {% endif %}
                        </div>
                        {% if feature.description %}
                        <div class="feature-description">{{ feature.description }}</div>
                        {% endif %}
                        <div class="feature-time">{{ feature.relative_time }}</div>
                    </div>
                </div>
                {% if feature.link %}
                <a href="{{ feature.link }}" class="btn btn-secondary btn-sm" title="×œ××™×“×¢ × ×•×¡×£">
                    <i class="fas fa-arrow-left"></i>
                </a>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% if whats_new.has_more %}
        <div class="whats-new-load-more">
            <button
                type="button"
                class="btn btn-secondary btn-icon load-more-whats-new"
                data-offset="{{ whats_new.next_offset }}"
                data-remaining="{{ whats_new.remaining }}"
            >
                <i class="fas fa-plus"></i>
                ×˜×¢×Ÿ ×¢×•×“ {{ whats_new.remaining }} ×¢×“×›×•× ×™×
            </button>
        </div>
        {% endif %}
        {% else %}
        <p style="opacity: 0.7;">××™×Ÿ ×¢×“×›×•× ×™× ×—×“×©×™× ×›×¨×’×¢</p>
        {% endif %}
    </div>

    {% if user_is_admin and last_commit %}
    {# === ×‘×œ×•×§ ×§×•××™×˜ ××—×¨×•×Ÿ (××“××™×Ÿ ×‘×œ×‘×“) === #}
    <div class="glass-card last-commit-card widget-last-commit">
        <h2 class="section-title">
            <i class="fas fa-code-commit"></i>
            ×§×•××™×˜ ××—×¨×•×Ÿ
        </h2>

        <div class="commit-header">
            <div class="commit-info">
                <div class="commit-sha">
                    <code>{{ last_commit.sha_short }}</code>
                </div>
                <div class="commit-message" title="{{ last_commit.message }}">
                    {{ last_commit.message[:80] }}{% if last_commit.message|length > 80 %}...{% endif %}
                </div>
                <div class="commit-meta">
                    <span class="commit-author">
                        <i class="fas fa-user"></i> {{ last_commit.author }}
                    </span>
                    <span class="commit-date">
                        <i class="fas fa-clock"></i>
                        {% if last_commit.date_israel_str %}
                            {{ last_commit.date_israel_str }} (×™×©×¨××œ)
                        {% elif last_commit.date %}
                            {{ last_commit.date[:10] }}
                        {% else %}
                            -
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>

        {% if last_commit.files %}
        <div class="changed-files-list" data-last-commit-files>
            <div class="files-header">
                <span>×§×‘×¦×™× ×©×”×©×ª× ×•</span>
                <span class="files-count badge">{{ last_commit.total_files }}</span>
            </div>
            {% for file in last_commit.files %}
            <a class="changed-file-item status-{{ file.status }}" href="/repo/?repo={{ repo_name|urlencode }}&file={{ file.path|urlencode }}" title="{{ file.path }}">
                <div class="file-info">
                    <span class="file-icon">{{ file.file_icon }}</span>
                    <span class="file-name" title="{{ file.path }}">{{ file.name }}</span>
                </div>
                <div class="file-status">
                    <span class="status-icon" title="{{ file.status_label }}">{{ file.status_icon }}</span>
                </div>
            </a>
            {% endfor %}

            {% if last_commit.truncated %}
            <div class="more-files">
                <button
                    type="button"
                    class="btn btn-secondary btn-icon load-more-commit-files"
                    data-sha="{{ last_commit.sha }}"
                    data-offset="{{ last_commit.files|length }}"
                    data-total="{{ last_commit.total_files }}"
                    data-repo="{{ repo_name }}"
                >
                    <i class="fas fa-plus"></i>
                    ×˜×¢×Ÿ ×¢×•×“ {{ last_commit.total_files - last_commit.files|length }} ×§×‘×¦×™×
                </button>
            </div>
            {% endif %}
        </div>
        {% else %}
        <p class="no-changes">××™×Ÿ ×§×‘×¦×™× ×©×”×©×ª× ×•</p>
        {% endif %}

        <div class="commit-actions">
            <a href="/repo/" class="btn btn-secondary btn-icon">
                <i class="fas fa-folder-tree"></i>
                ×“×¤×“×¤×Ÿ ×§×•×“
            </a>
            {% if last_commit.sync_time %}
            <small class="sync-time">
                ×¡×•× ×›×¨×Ÿ: {{ last_commit.sync_time.strftime('%d/%m %H:%M') if last_commit.sync_time else '×œ× ×™×“×•×¢' }}
            </small>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<section class="activity-section {{ 'has-last-commit' if user_is_admin and last_commit else 'no-last-commit' }}" id="activity-timeline">
    <div class="activity-header">
        <div class="activity-title">
            <h2 class="section-title">
                <i class="fas fa-bolt"></i>
                ×”×™×¡×˜×•×¨×™×™×ª ×¤×¢×•×œ×•×ª
            </h2>
            <p class="activity-subtitle">×§×— ×”×—×œ×˜×•×ª ××”×™×¨×•×ª ×¢× ×ª××•× ×ª ××¦×‘ ×©×œ ×©××™×¨×•×ª, ×¤×•×© ×•×’×™×‘×•×™×™×</p>
        </div>
        {% if activity_timeline.filters %}
        <div class="timeline-filters desktop-only">
            {% for filter in activity_timeline.filters %}
            <button type="button"
                    class="timeline-filter-btn{% if loop.first %} is-active{% endif %}"
                    data-filter="{{ filter.id }}">
                <span>{{ filter.label }}</span>
                <span class="filter-count">{{ filter.count }}</span>
            </button>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <div class="activity-cards{% if files_need_attention and files_need_attention.has_items %} has-attention{% endif %}" data-activity-cards data-active-filter="all">
        <article class="activity-card timeline-card glass-card widget-timeline" data-card="timeline" data-expanded="false">
            <header class="timeline-card-header">
                <div>
                    <h3>×¤×™×“ ××—×¨×•×Ÿ</h3>
                </div>
                <button class="timeline-expand mobile-only" type="button" data-timeline-expand>
                    <span>×”×¦×’ ×”×›×•×œ</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
            </header>

            <div class="timeline-feed mobile-only" data-timeline-feed>
                {% if activity_timeline.has_events %}
                    {% for event in activity_timeline.feed %}
                        {% if loop.index <= activity_timeline.compact_limit %}
                        <article class="timeline-item" data-timeline-event data-group="{{ event.group }}" data-accent="{{ event.accent }}">
                            <div class="timeline-marker"></div>
                            <div class="timeline-item-body">
                                <div class="timeline-item-header">
                                    <div class="timeline-icon">{{ event.icon }}</div>
                                    <div class="timeline-texts">
                                        <div class="timeline-title">{{ event.title }}</div>
                                        <div class="timeline-subtitle">{{ event.subtitle }}</div>
                                    </div>
                                    <div class="timeline-time">{{ event.relative_time }}</div>
                                </div>
                                <div class="timeline-item-footer">
                                    {% if event.badge %}
                                    <span class="timeline-badge timeline-badge-{{ event.badge_variant|default('neutral') }}">{{ event.badge }}</span>
                                    {% endif %}
                                    {% if event.href %}
                                    <a class="timeline-link" href="{{ event.href }}">×¤×ª×—</a>
                                    {% endif %}
                                </div>
                            </div>
                        </article>
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <p class="timeline-empty">×¢×•×“ ×œ× ×©××¨×ª ×§×‘×¦×™×, ×¤×ª×§×™× ××• ×ª×–×›×•×¨×•×ª. ×›×œ ×¤×¢×•×œ×” ×—×“×©×” ×ª×•×¤×™×¢ ×›××Ÿ.</p>
                {% endif %}
            </div>

            <div class="timeline-groups" data-timeline-groups>
                {% if activity_timeline.groups %}
                    {% for group in activity_timeline.groups %}
                    <div class="timeline-group" data-group="{{ group.id }}">
                        <button class="group-toggle" type="button" data-group-toggle>
                            <div class="group-info">
                                <span class="group-icon">{{ group.icon }}</span>
                                <div>
                                    <div class="group-title">{{ group.title }}</div>
                                    <div class="group-summary">{{ group.summary }}</div>
                                </div>
                            </div>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="group-items">
                            {% for event in group.events %}
                            <article class="timeline-item" data-timeline-event data-group="{{ group.id }}" data-accent="{{ event.accent }}">
                                <div class="timeline-marker"></div>
                                <div class="timeline-item-body">
                                    <div class="timeline-item-header">
                                        <div class="timeline-icon">{{ event.icon }}</div>
                                        <div class="timeline-texts">
                                            <div class="timeline-title">{{ event.title }}</div>
                                            <div class="timeline-subtitle">{{ event.subtitle }}</div>
                                        </div>
                                        <div class="timeline-time">{{ event.relative_time }}</div>
                                    </div>
                                    <div class="timeline-item-footer">
                                        {% if event.badge %}
                                        <span class="timeline-badge timeline-badge-{{ event.badge_variant|default('neutral') }}">{{ event.badge }}</span>
                                        {% endif %}
                                        {% if event.href %}
                                        <a class="timeline-link" href="{{ event.href }}">×¤×ª×—</a>
                                        {% endif %}
                                    </div>
                                </div>
                            </article>
                            {% endfor %}
                            {% if group.id == 'files' and group.has_more %}
                            <div class="timeline-load-more-wrap">
                                <button
                                    type="button"
                                    class="btn btn-secondary btn-icon timeline-load-more-files"
                                    data-offset="{{ group.shown|default(group.events|length) }}"
                                    data-total="{{ group.total_recent|default(0) }}"
                                >
                                    <i class="fas fa-plus"></i>
                                    ×˜×¢×Ÿ ×¢×•×“ {{ 12 if (group.total_recent - (group.shown|default(group.events|length))) > 12 else (group.total_recent - (group.shown|default(group.events|length))) }} ×§×‘×¦×™×
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="timeline-empty">××™×Ÿ × ×ª×•× ×™ ×¤×¢×™×œ×•×ª ×–××™× ×™×.</p>
                {% endif %}
            </div>
        </article>

        <article class="activity-card push-card glass-card widget-push" data-card="push">
            <header class="mini-card-header">
                <div class="card-icon">ğŸ“£</div>
                <div>
                    <h3>×”×’×“×¨×•×ª ×¤×•×©</h3>
                    <span class="status-pill status-{{ push_card.status_variant|default('neutral') }}">{{ push_card.status_text }}</span>
                </div>
            </header>
            <ul class="push-stats">
                <li>
                    <span>×× ×•×™×™× ×¤×¢×™×œ×™×</span>
                    <strong>{{ push_card.subscriptions }}</strong>
                </li>
                <li>
                    <span>×ª×–×›×•×¨×•×ª ×‘×”××ª× ×”</span>
                    <strong>{{ push_card.pending_count }}</strong>
                </li>
                <li>
                    <span>×©×œ×™×—×” ××—×¨×•× ×”</span>
                    {% if push_card.last_push %}
                    <strong>{{ push_card.last_push.title }}</strong>
                    <small>{{ push_card.last_push.relative_time }}</small>
                    {% else %}
                    <strong>×œ× × ×©×œ×—×• ×”×ª×¨××•×ª</strong>
                    {% endif %}
                </li>
                <li>
                    <span>×”×ª×–×›×•×¨×ª ×”×‘××”</span>
                    {% if push_card.next_reminder %}
                    <strong>{{ push_card.next_reminder.title }}</strong>
                    <small>{{ push_card.next_reminder.relative_time }}</small>
                    {% else %}
                    <strong>××™×Ÿ ×ª×–××•×Ÿ ×¢×ª×™×“×™</strong>
                    {% endif %}
                </li>
            </ul>
            <a href="{{ push_card.cta_href }}" class="btn btn-secondary btn-icon">
                <i class="fas fa-sliders-h"></i>
                {{ push_card.cta_label }}
            </a>
        </article>

        <article class="activity-card notes-card glass-card widget-notes" data-card="notes">
            <header class="mini-card-header">
                <div class="card-icon">ğŸ—’ï¸</div>
                <div>
                    <h3>×¤×ª×§×™× ××—×¨×•× ×™×</h3>
                    <p>×”×¤×ª×§×™× ×©×¢×•×“×›× ×• ×œ××—×¨×•× ×” ××• ×××ª×™× ×™× ×œ×ª×–×›×•×¨×ª</p>
                </div>
            </header>
            {% if notes_snapshot.has_notes %}
            <ul class="notes-list">
                {% for note in notes_snapshot.notes %}
                <li>
                    <div class="note-title">{{ note.title }}</div>
                    <div class="note-meta">
                        {{ note.file_name }}
                        <span>Â·</span>
                        <span>{{ note.relative_time }}</span>
                    </div>
                    {% if note.file_url %}
                    <a class="note-link" href="{{ note.file_url }}">×¤×ª×— ×§×•×‘×¥</a>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
            {% if notes_snapshot.total > notes_snapshot.notes|length %}
            <p class="notes-more">×•×¢×•×“ {{ notes_snapshot.total - notes_snapshot.notes|length }} ×¤×ª×§×™× ×××ª×™× ×™×</p>
            {% endif %}
            {% else %}
            <p class="timeline-empty">×¢×•×“ ×œ× ×”×•×¡×¤×ª ×¤×ª×§×™× ×œ×”×¦×’×ª ×”××¦×‘. ×ª×•×›×œ ×œ×”×•×¡×™×£ ×¤×ª×§ ×“×¨×š ×ª×¦×•×’×ª Markdown ×©×œ ×§×•×‘×¥.</p>
            <a class="note-link" href="/files">×¤×ª×— ×§×•×‘×¥ ×—×“×©</a>
            {% endif %}
        </article>
        {# === ×•×•×™×“×’'×˜: ×§×‘×¦×™× ×©×“×•×¨×©×™× ×˜×™×¤×•×œ === #}
        {% if files_need_attention and files_need_attention.has_items %}
        <article class="activity-card glass-card attention-card widget-attention" data-attention-widget>
            <header class="attention-header">
                <h2 class="section-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    ×§×‘×¦×™× ×©×“×•×¨×©×™× ×˜×™×¤×•×œ
                </h2>
                <span class="badge badge-warning" data-attention-total-badge>
                    {{ files_need_attention.total_missing + files_need_attention.total_stale }}
                </span>
            </header>

            {# --- ×§×‘×•×¦×” 1: ×—×¡×¨ ×ª×™××•×¨/×ª×’×™×•×ª --- #}
            {% if files_need_attention.missing_metadata %}
            <section class="attention-group" data-group="missing">
                <h3 class="attention-group__title">
                    <span class="attention-group__icon">ğŸ“</span>
                    ×—×¡×¨ ×ª×™××•×¨ ××• ×ª×’×™×•×ª
                    <span class="attention-group__count" data-group-count="missing">
                        ({{ files_need_attention.shown_missing }}{% if files_need_attention.total_missing > files_need_attention.shown_missing %}/{{ files_need_attention.total_missing }}{% endif %})
                    </span>
                </h3>
                <ul class="attention-list" data-attention-list="missing">
                    {% for file in files_need_attention.missing_metadata %}
                    <li class="attention-item" data-file-id="{{ file.id }}">
                        <div class="attention-item__info">
                            <span class="attention-item__icon">{{ file.icon }}</span>
                            <div class="attention-item__details">
                                <a href="/file/{{ file.id }}" class="attention-item__name">{{ file.file_name }}</a>
                                <span class="attention-item__reason">{{ file.reason_text }}</span>
                            </div>
                        </div>
                        <div class="attention-item__actions">
                            <button type="button" 
                                    class="btn btn-sm btn-icon attention-quick-edit"
                                    data-action="quick-edit"
                                    data-file-id="{{ file.id }}"
                                    data-file-name="{{ file.file_name | e }}"
                                    data-current-desc="{{ file.description | tojson | forceescape }}"
                                    data-current-tags="{{ (file.tags_full | join(',')) | tojson | forceescape }}"
                                    title="×¢×¨×™×›×” ××”×™×¨×”">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button type="button"
                                    class="btn btn-sm btn-icon attention-dismiss"
                                    data-action="dismiss"
                                    data-file-id="{{ file.id }}"
                                    title="×˜×¤×œ ×××•×—×¨ ×™×•×ª×¨">
                                <i class="fas fa-clock"></i>
                            </button>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
                {% if files_need_attention.total_missing > files_need_attention.shown_missing %}
                <p class="attention-more">
                    ×•×¢×•×“ {{ files_need_attention.total_missing - files_need_attention.shown_missing }} ×§×‘×¦×™× × ×•×¡×¤×™×...
                    <a href="/files?filter=missing_metadata" class="attention-more-link">×”×¦×’ ×”×›×œ</a>
                </p>
                {% endif %}
            </section>
            {% endif %}

            {# --- ×§×‘×•×¦×” 2: ×œ× ×¢×•×“×›×Ÿ ×–××Ÿ ×¨×‘ --- #}
            {% if files_need_attention.stale_files %}
            <section class="attention-group" data-group="stale">
                <h3 class="attention-group__title">
                    <span class="attention-group__icon">â°</span>
                    ×œ× ×¢×•×“×›×Ÿ ×–××Ÿ ×¨×‘
                    <span class="attention-group__count" data-group-count="stale">
                        ({{ files_need_attention.shown_stale }}{% if files_need_attention.total_stale > files_need_attention.shown_stale %}/{{ files_need_attention.total_stale }}{% endif %})
                    </span>
                </h3>
                <ul class="attention-list" data-attention-list="stale">
                    {% for file in files_need_attention.stale_files %}
                    <li class="attention-item" data-file-id="{{ file.id }}">
                        <div class="attention-item__info">
                            <span class="attention-item__icon">{{ file.icon }}</span>
                            <div class="attention-item__details">
                                <a href="/file/{{ file.id }}" class="attention-item__name">{{ file.file_name }}</a>
                                <span class="attention-item__reason">{{ file.reason_text }}</span>
                            </div>
                        </div>
                        <div class="attention-item__actions">
                            <a href="/edit/{{ file.id }}" 
                               class="btn btn-sm btn-icon"
                               title="×¤×ª×— ×œ×¢×¨×™×›×”">
                                <i class="fas fa-external-link-alt"></i>
                            </a>
                            <button type="button"
                                    class="btn btn-sm btn-icon attention-dismiss"
                                    data-action="dismiss"
                                    data-file-id="{{ file.id }}"
                                    title="×˜×¤×œ ×××•×—×¨ ×™×•×ª×¨">
                                <i class="fas fa-clock"></i>
                            </button>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
                {% if files_need_attention.total_stale > files_need_attention.shown_stale %}
                <p class="attention-more">
                    ×•×¢×•×“ {{ files_need_attention.total_stale - files_need_attention.shown_stale }} ×§×‘×¦×™× × ×•×¡×¤×™×...
                    <a href="/files?filter=stale&days={{ files_need_attention.settings.stale_days }}" class="attention-more-link">×”×¦×’ ×”×›×œ</a>
                </p>
                {% endif %}
            </section>
            {% endif %}

            {# --- ×”×’×“×¨×•×ª --- #}
            <footer class="attention-footer">
                <span class="attention-footer-hint">
                    âš™ï¸ ×§×•×‘×¥ × ×—×©×‘ "×™×©×Ÿ" ××—×¨×™ {{ files_need_attention.settings.stale_days }} ×™××™×
                </span>
                <a href="/settings#attention" class="attention-settings-link">
                    <i class="fas fa-cog"></i>
                    ×”×’×“×¨×•×ª
                </a>
            </footer>
        </article>
        {% endif %}
        <article class="activity-card languages-card glass-card widget-languages widget-languages--activity">
            <h2 class="section-title">
                <i class="fas fa-code"></i>
                ×©×¤×•×ª ×ª×›× ×•×ª
            </h2>
            {% if stats.top_languages %}
            <div class="languages-list">
                {% for lang in stats.top_languages %}
                <div class="language-item">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 1.5rem;">{{ lang.icon }}</span>
                        <span style="font-weight: 500;">{{ lang.name }}</span>
                    </div>
                    <div class="badge">{{ lang.count }} ×§×‘×¦×™×</div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p style="opacity: 0.7;">××™×Ÿ ×¢×“×™×™×Ÿ ×§×‘×¦×™×</p>
            {% endif %}
        </article>
    </div>
    {% if files_need_attention and files_need_attention.has_items %}

    {# --- ××•×“×œ ×¢×¨×™×›×” ××”×™×¨×” (Quick Edit Modal) --- #}
    <div class="attention-modal" id="attentionQuickEditModal" data-quick-edit-modal hidden>
        <div class="modal-backdrop" data-modal-close></div>
        <div class="modal-content glass-card">
            <header class="modal-header">
                <h3>×¢×¨×™×›×” ××”×™×¨×”</h3>
                <button type="button" class="modal-close" data-modal-close aria-label="×¡×’×•×¨">
                    <i class="fas fa-times"></i>
                </button>
            </header>
            <form class="modal-body" data-quick-edit-form>
                <input type="hidden" name="file_id" data-field="file_id">
                <p class="quick-edit-file-name" data-field="file_name_display"></p>
                <div class="form-group">
                    <label for="quickEditDescription">×ª×™××•×¨</label>
                    <input type="text" 
                           id="quickEditDescription" 
                           name="description" 
                           class="form-field"
                           maxlength="500"
                           placeholder="××” ×”×§×•×‘×¥ ×¢×•×©×”? (×ª×™××•×¨ ×§×¦×¨)">
                </div>
                <div class="form-group">
                    <label for="quickEditTags">×ª×’×™×•×ª</label>
                    <input type="text" 
                           id="quickEditTags" 
                           name="tags" 
                           class="form-field"
                           placeholder="utils, helper, api">
                    <small class="form-hint">×”×¤×¨×“ ×ª×’×™×•×ª ×‘×¤×¡×™×§×™× (Comma-separated)</small>
                </div>
            </form>
            <footer class="modal-footer">
                <button type="button" class="btn btn-secondary" data-modal-close>×‘×™×˜×•×œ</button>
                <button type="button" class="btn btn-primary" data-action="save-quick-edit">
                    <i class="fas fa-save"></i>
                    ×©××•×¨
                </button>
            </footer>
        </div>
    </div>

    {# --- ××•×“×œ ×“×—×™×™×” (Dismiss Modal) --- #}
    <div class="attention-modal" id="attentionDismissModal" data-dismiss-modal hidden>
        <div class="modal-backdrop" data-modal-close></div>
        <div class="modal-content glass-card modal-content--small">
            <header class="modal-header">
                <h3>×“×—×” ×œ×˜×™×¤×•×œ ×××•×—×¨</h3>
                <button type="button" class="modal-close" data-modal-close aria-label="×¡×’×•×¨">
                    <i class="fas fa-times"></i>
                </button>
            </header>
            <div class="modal-body">
                <input type="hidden" data-field="dismiss_file_id">
                <p>×”×¡×ª×¨ ×§×•×‘×¥ ×–×” ××”×¨×©×™××” ×œ××©×š:</p>
                <div class="dismiss-options">
                    <button type="button" class="btn btn-secondary dismiss-option" data-days="7">×©×‘×•×¢</button>
                    <button type="button" class="btn btn-secondary dismiss-option" data-days="30">×—×•×“×©</button>
                    <button type="button" class="btn btn-secondary dismiss-option" data-days="90">3 ×—×•×“×©×™×</button>
                    <button type="button" class="btn btn-secondary dismiss-option" data-days="0" data-forever="true">×œ×ª××™×“</button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</section>

<div class="quick-actions glass-card" style="margin-top: 2rem; text-align: center;">
    <h2 class="section-title">×¤×¢×•×œ×•×ª ××”×™×¨×•×ª</h2>
    <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
        <a href="https://t.me/{{ bot_username }}" target="_blank" class="btn btn-primary btn-icon">
            <i class="fab fa-telegram"></i>
            ×¤×ª×— ××ª ×”×‘×•×˜
        </a>
        <a href="/files" class="btn btn-secondary btn-icon">
            <i class="fas fa-folder"></i>
            ×›×œ ×”×§×‘×¦×™×
        </a>
        <button onclick="refreshStats()" class="btn btn-secondary btn-icon">
            <i class="fas fa-sync"></i>
            ×¨×¢× ×Ÿ × ×ª×•× ×™×
        </button>
    </div>
</div>

<style>
.stat-card {
    text-align: center;
    transition: transform 0.3s;
}

.stat-card:hover {
    transform: translateY(-5px);
}

.language-item,
.file-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    background: rgba(255,255,255,0.05);
    border-radius: 10px;
    margin-bottom: 0.5rem;
    border: 1px solid rgba(255,255,255,0.08);
    transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
}
:root[data-theme="rose-pine-dawn"] .language-item,
:root[data-theme="rose-pine-dawn"] .file-item {
    background: color-mix(in srgb, var(--bg-secondary) 75%, #ffffff 25%);
    border: 1px solid rgba(87,82,121,0.25);
    box-shadow: 0 8px 18px rgba(144,122,169,0.12);
}

.language-item:hover,
.file-item:hover {
    background: rgba(255,255,255,0.1) !important;
}
:root[data-theme="rose-pine-dawn"] .language-item:hover,
:root[data-theme="rose-pine-dawn"] .file-item:hover {
    background: color-mix(in srgb, var(--bg-secondary) 65%, #ffffff 35%) !important;
}

/* === Pinned Files Section === */
.pinned-section {
    margin-bottom: 0;
    border-right: 3px solid #f59e0b;
}

.pinned-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.pinned-header .section-title {
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.pinned-header .section-title i {
    color: #f59e0b;
}

.pinned-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1rem;
    width: 100%;
}

.pinned-card {
    position: relative;
    display: flex;
    gap: 1rem;
    padding: 1rem;
    background: rgba(245, 158, 11, 0.08);
    border: 1px solid rgba(245, 158, 11, 0.2);
    border-radius: 12px;
    text-decoration: none;
    color: inherit;
    transition: all 0.2s ease;
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
    min-width: 0;
}

.pinned-card:hover {
    background: rgba(245, 158, 11, 0.15);
    border-color: rgba(245, 158, 11, 0.35);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.15);
}

.pinned-card__icon {
    font-size: 2rem;
    flex-shrink: 0;
}

.pinned-card__content {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
}

.pinned-card__name {
    font-weight: 600;
    font-size: 1rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.pinned-card__meta {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.85rem;
}

.pinned-card__lines {
    opacity: 0.7;
}

.pinned-card__note {
    font-size: 0.85rem;
    opacity: 0.75;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.pinned-card__unpin {
    position: absolute;
    top: 0.5rem;
    left: 0.5rem;
    width: 24px;
    height: 24px;
    border: none;
    background: rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.6);
    border-radius: 50%;
    font-size: 0.8rem;
    cursor: pointer;
    opacity: 0;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.pinned-card:hover .pinned-card__unpin {
    opacity: 1;
}

.pinned-card__unpin:hover {
    background: rgba(239, 68, 68, 0.3);
    color: #fca5a5;
}

.pinned-hint {
    margin-top: 1rem;
    font-size: 0.9rem;
    opacity: 0.7;
    text-align: center;
}

/* Rose Pine Dawn overrides */
:root[data-theme="rose-pine-dawn"] .pinned-section {
    border-right-color: #ea9d34;
}

:root[data-theme="rose-pine-dawn"] .pinned-header .section-title i {
    color: #ea9d34;
}

:root[data-theme="rose-pine-dawn"] .pinned-card {
    background: rgba(234, 157, 52, 0.1);
    border-color: rgba(234, 157, 52, 0.25);
}

:root[data-theme="rose-pine-dawn"] .pinned-card:hover {
    background: rgba(234, 157, 52, 0.18);
    border-color: rgba(234, 157, 52, 0.4);
}

@media (max-width: 768px) {
    .pinned-grid {
        grid-template-columns: 1fr;
    }
    
    .pinned-card__unpin {
        opacity: 1;
    }
}

/* === What's New Card === */
.whats-new-card {
    border-right: 3px solid #8b5cf6;
}

.whats-new-card .section-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.whats-new-card .section-title i {
    color: #8b5cf6;
}

.whats-new-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.whats-new-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    background: rgba(139, 92, 246, 0.08);
    border-radius: 10px;
    border: 1px solid rgba(139, 92, 246, 0.15);
    transition: all 0.2s ease;
}

.whats-new-item:hover {
    background: rgba(139, 92, 246, 0.15);
    border-color: rgba(139, 92, 246, 0.25);
}

.feature-content {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    flex: 1;
    min-width: 0;
}

.feature-icon {
    font-size: 1.5rem;
    flex-shrink: 0;
}

.feature-details {
    flex: 1;
    min-width: 0;
}

.feature-title {
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.feature-badge {
    font-size: 0.7rem;
    padding: 0.15rem 0.5rem;
    background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
    color: white;
    border-radius: 999px;
    font-weight: 500;
}

.feature-description {
    font-size: 0.85rem;
    opacity: 0.8;
    margin-top: 0.25rem;
    line-height: 1.4;
}

.feature-time {
    font-size: 0.75rem;
    opacity: 0.6;
    margin-top: 0.35rem;
}

.btn-sm {
    padding: 0.4rem 0.6rem !important;
    font-size: 0.85rem;
}

.whats-new-load-more {
    margin-top: 1rem;
    text-align: center;
}

.load-more-whats-new {
    width: 100%;
    justify-content: center;
    gap: 0.5rem;
}

/* Rose Pine Dawn overrides for What's New */
:root[data-theme="rose-pine-dawn"] .whats-new-card {
    border-right-color: #907aa9;
}

:root[data-theme="rose-pine-dawn"] .whats-new-card .section-title i {
    color: #907aa9;
}

:root[data-theme="rose-pine-dawn"] .whats-new-item {
    background: rgba(144, 122, 169, 0.1);
    border-color: rgba(144, 122, 169, 0.2);
}

:root[data-theme="rose-pine-dawn"] .whats-new-item:hover {
    background: rgba(144, 122, 169, 0.18);
    border-color: rgba(144, 122, 169, 0.3);
}

:root[data-theme="rose-pine-dawn"] .feature-badge {
    background: linear-gradient(135deg, #907aa9 0%, #b4a7c7 100%);
}

.dashboard-grid {
    display: grid;
    gap: 2rem;
    grid-template-columns: 1fr;
    grid-template-areas:
        "pinned"
        "lastcommit"
        "whatsnew";
}

.dashboard-grid.no-last-commit {
    grid-template-areas:
        "pinned"
        "whatsnew";
}

.widget-pinned { grid-area: pinned; }
.widget-whats-new { grid-area: whatsnew; }
.widget-last-commit { grid-area: lastcommit; }
.widget-languages--top { grid-area: languages-top; display: none; }
.widget-languages--activity { display: block; }

@media (min-width: 769px) and (max-width: 1199px) {
    .dashboard-grid.has-last-commit {
        grid-template-columns: repeat(2, minmax(0, 1fr));
        grid-template-areas:
            "pinned whatsnew"
            "lastcommit languages-top";
    }

    .dashboard-grid.no-last-commit {
        grid-template-columns: repeat(2, minmax(0, 1fr));
        grid-template-areas:
            "pinned whatsnew"
            "pinned languages-top";
    }

    .widget-languages--top { display: block; }
    .widget-languages--activity { display: none; }

    .activity-cards {
        display: grid;
        grid-template-columns: minmax(0, 2fr) minmax(0, 1fr);
        grid-template-areas:
            "timeline push"
            "timeline notes";
        gap: 1rem;
        overflow-x: visible;
        scroll-snap-type: none;
    }

    .widget-timeline { grid-area: timeline; }
    .widget-push { grid-area: push; }
    .widget-notes { grid-area: notes; }
}

@media (min-width: 1200px) {
    .dashboard-grid.has-last-commit {
        grid-template-columns: repeat(3, minmax(0, 1fr));
        grid-template-areas: "pinned whatsnew lastcommit";
    }

    .dashboard-grid.no-last-commit {
        grid-template-columns: repeat(3, minmax(0, 1fr));
        grid-template-areas: "pinned whatsnew languages-top";
    }

    .dashboard-grid.no-last-commit .widget-languages--top { display: block; }
    .dashboard-grid.has-last-commit .widget-languages--top { display: none; }

    .widget-languages--activity { display: block; }
    .activity-section.no-last-commit .widget-languages--activity { display: none; }

    .activity-cards {
        display: grid;
        grid-template-columns: minmax(0, 2fr) minmax(0, 1fr);
        grid-template-areas:
            "timeline push"
            "timeline notes"
            "timeline languages";
        gap: 1rem;
        overflow-x: visible;
        scroll-snap-type: none;
    }

    .activity-section.no-last-commit .activity-cards {
        grid-template-areas:
            "timeline push"
            "timeline notes";
    }

    .widget-timeline { grid-area: timeline; }
    .widget-push { grid-area: push; }
    .widget-notes { grid-area: notes; }
    .widget-languages--activity { grid-area: languages; }

    .activity-cards .widget-push,
    .activity-cards .widget-notes,
    .activity-cards .widget-languages--activity {
        align-self: start;
    }
}
/* === Last Commit Card (Admin Only) === */
.last-commit-card {
    border-right: 3px solid #10b981;
}

.commit-header {
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.commit-sha code {
    background: rgba(16, 185, 129, 0.2);
    padding: 0.25rem 0.5rem;
    border-radius: 6px;
    font-family: monospace;
    font-size: 0.9rem;
    color: #10b981;
}

.commit-message {
    font-weight: 600;
    margin: 0.75rem 0 0.5rem;
    line-height: 1.4;
}

.commit-meta {
    display: flex;
    gap: 1.5rem;
    font-size: 0.85rem;
    opacity: 0.75;
}

.commit-meta i {
    margin-left: 0.25rem;
}

.changed-files-list {
    margin-top: 1rem;
}

.files-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
    font-weight: 500;
}

.changed-file-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0.75rem;
    background: rgba(255,255,255,0.03);
    border-radius: 8px;
    margin-bottom: 0.35rem;
    border-right: 3px solid transparent;
    text-decoration: none;
    color: inherit;
}

.changed-file-item:hover {
    background: rgba(255,255,255,0.08);
}

.changed-file-item.status-added {
    border-right-color: #10b981;
}

.changed-file-item.status-modified {
    border-right-color: #f59e0b;
}

.changed-file-item.status-deleted {
    border-right-color: #ef4444;
    opacity: 0.7;
}

.changed-file-item.status-renamed {
    border-right-color: #8b5cf6;
}

.changed-file-item.status-copied {
    border-right-color: #3b82f6;
}

.file-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    overflow: hidden;
}

.file-icon {
    font-size: 1.1rem;
}

.file-name {
    font-family: monospace;
    font-size: 0.85rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 200px;
}

.status-icon {
    font-size: 0.9rem;
}

.more-files {
    text-align: center;
    padding: 0.5rem;
    opacity: 0.7;
    font-size: 0.85rem;
}

.load-more-commit-files {
    width: 100%;
    justify-content: center;
    gap: 0.5rem;
    opacity: 1;
}

.commit-actions {
    margin-top: 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.sync-time {
    opacity: 0.6;
    font-size: 0.8rem;
}

.no-changes {
    opacity: 0.7;
    text-align: center;
    padding: 1rem;
}

/* Rose Pine Dawn overrides */
:root[data-theme="rose-pine-dawn"] .commit-sha code {
    background: rgba(86, 148, 159, 0.15);
    color: #286983;
}

:root[data-theme="rose-pine-dawn"] .last-commit-card {
    border-right-color: #56949f;
}

:root[data-theme="rose-pine-dawn"] .changed-file-item {
    background: rgba(255,255,255,0.4);
}

:root[data-theme="rose-pine-dawn"] .changed-file-item.status-added {
    border-right-color: #56949f;
}

:root[data-theme="rose-pine-dawn"] .changed-file-item.status-modified {
    border-right-color: #ea9d34;
}

:root[data-theme="rose-pine-dawn"] .changed-file-item.status-deleted {
    border-right-color: #b4637a;
}

:root[data-theme="rose-pine-dawn"] .changed-file-item.status-renamed {
    border-right-color: #907aa9;
}

.activity-section {
    margin-top: 2rem;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.activity-header {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    gap: 1rem;
    align-items: flex-start;
}

.activity-subtitle {
    margin: 0.35rem 0 0;
    opacity: 0.75;
    font-size: 0.95rem;
}

.activity-cards {
    display: flex;
    gap: 1rem;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    padding-bottom: 0.5rem;
}

.activity-card {
    min-width: calc(100% - 1.5rem);
    scroll-snap-align: start;
}

.timeline-card-header {
    display: flex;
    justify-content: space-between;
    gap: 1rem;
    align-items: flex-start;
}

.timeline-feed,
.timeline-groups {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.timeline-groups {
    display: none;
}

.timeline-card[data-expanded="true"] .timeline-groups {
    display: flex;
}

.timeline-card[data-expanded="true"] .timeline-feed {
    display: none;
}

.timeline-item {
    position: relative;
    padding: 1rem 2.2rem 1rem 1rem;
    border-radius: 14px;
    background: rgba(255,255,255,0.02);
    border-right: 3px solid rgba(255,255,255,0.08);
}

.timeline-marker {
    position: absolute;
    top: 1.1rem;
    right: 0.4rem;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #c084fc;
    box-shadow: 0 0 0 4px rgba(192,132,252,0.2);
}

.timeline-item[data-accent="timeline-accent-push"] .timeline-marker {
    background: #fb923c;
    box-shadow: 0 0 0 4px rgba(251,146,60,0.2);
}

.timeline-item-header {
    display: flex;
    gap: 0.75rem;
    align-items: flex-start;
    justify-content: space-between;
}

.timeline-icon {
    font-size: 1.25rem;
}

.timeline-texts {
    flex: 1;
    text-align: right;
}

.timeline-title,
.timeline-subtitle,
.note-title,
.note-meta,
.timeline-link {
    word-break: break-word;
    overflow-wrap: anywhere;
}

.timeline-title {
    font-weight: 600;
}

.timeline-subtitle {
    font-size: 0.9rem;
    opacity: 0.75;
}

.timeline-time {
    white-space: nowrap;
    font-size: 0.85rem;
    opacity: 0.65;
}

.timeline-item-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 0.75rem;
    gap: 1rem;
}

.timeline-badge {
    border-radius: 999px;
    padding: 0.15rem 0.9rem;
    font-size: 0.8rem;
    background: rgba(255,255,255,0.12);
}

.timeline-badge-code {
    background: rgba(168,85,247,0.2);
    color: #f3e8ff;
}

.timeline-badge-info {
    background: rgba(59,130,246,0.2);
    color: #dbeafe;
}

.timeline-badge-warning {
    background: rgba(251,191,36,0.2);
    color: #fef9c3;
}

.timeline-badge-neutral {
    background: rgba(148,163,184,0.2);
    color: #e2e8f0;
}

.timeline-link {
    color: #a5b4fc;
    font-weight: 600;
    font-size: 0.85rem;
}

.timeline-empty {
    opacity: 0.7;
    text-align: center;
}

.timeline-expand {
    width: 100%;
    margin-top: 1rem;
    background: rgba(255,255,255,0.05);
    border: none;
    color: inherit;
    border-radius: 10px;
    padding: 0.75rem 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.timeline-load-more-wrap {
    margin-top: 0.5rem;
    display: flex;
}

.timeline-load-more-files {
    width: 100%;
    justify-content: center;
    gap: 0.5rem;
}

.timeline-group {
    border-radius: 14px;
    background: rgba(255,255,255,0.02);
}

.group-toggle {
    width: 100%;
    border: none;
    background: transparent;
    color: inherit;
    padding: 1rem 1.25rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
}

.group-info {
    display: flex;
    gap: 0.75rem;
    align-items: center;
}

.group-items {
    display: none;
    flex-direction: column;
    gap: 1rem;
    padding: 0 1.25rem 1.25rem;
}

.timeline-group.is-open .group-items {
    display: flex;
}

.timeline-item.is-hidden-by-filter,
.timeline-group.is-hidden-by-filter {
    display: none !important;
}

.mobile-only {
    display: block;
}

.desktop-only {
    display: none;
}

.timeline-filter-btn {
    background: rgba(255,255,255,0.05);
    border: 1px solid transparent;
    color: inherit;
    border-radius: 999px;
    padding: 0.45rem 0.9rem;
    display: flex;
    gap: 0.4rem;
    align-items: center;
}

.timeline-filter-btn.is-active {
    border-color: rgba(167,139,250,0.4);
    background: rgba(129,140,248,0.15);
}

.filter-count {
    font-size: 0.85rem;
    opacity: 0.8;
}

.mini-card-header {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    margin-bottom: 1rem;
}

.card-icon {
    width: 44px;
    height: 44px;
    border-radius: 12px;
    display: grid;
    place-items: center;
    font-size: 1.4rem;
    background: rgba(255,255,255,0.08);
}

.status-pill {
    display: inline-flex;
    padding: 0.1rem 0.75rem;
    border-radius: 999px;
    font-size: 0.8rem;
}

.status-success {
    background: rgba(34,197,94,0.2);
    color: #bbf7d0;
}

.status-warning {
    background: rgba(251,191,36,0.2);
    color: #fef3c7;
}

.status-danger {
    background: rgba(248,113,113,0.2);
    color: #fecaca;
}

.status-neutral {
    background: rgba(148,163,184,0.2);
    color: #e2e8f0;
}

.push-stats {
    list-style: none;
    padding: 0;
    margin: 0 0 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.push-stats li {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 0.5rem;
}

.push-stats strong {
    font-size: 1rem;
}

.notes-list {
    list-style: none;
    padding: 0;
    margin: 0 0 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.85rem;
}

.note-title {
    font-weight: 600;
}

.note-meta {
    font-size: 0.85rem;
    opacity: 0.75;
}

.note-link {
    font-size: 0.85rem;
    color: #a5b4fc;
}

.notes-more {
    font-size: 0.85rem;
    opacity: 0.75;
}

@media (max-width: 700px) {
    .activity-cards {
        flex-direction: column;
        overflow: visible;
        scroll-snap-type: none;
    }

    .activity-card {
        min-width: 100%;
    }
}

@media (min-width: 900px) {
    .activity-card {
        min-width: 0;
        scroll-snap-align: unset;
    }

    .timeline-card .timeline-feed,
    .timeline-expand {
        display: none !important;
    }

    .timeline-card .timeline-groups {
        display: flex !important;
    }

    .mobile-only {
        display: none !important;
    }

    .desktop-only {
        display: flex !important;
        gap: 0.5rem;
    }
}

/* === Dashboard grid layout === */
.dashboard-grid {
    display: grid;
    gap: 2rem;
    grid-template-columns: 1fr;
    grid-template-areas:
        "pinned"
        "lastcommit"
        "whatsnew";
}

.dashboard-grid.no-last-commit {
    grid-template-areas:
        "pinned"
        "whatsnew";
}

.widget-pinned { grid-area: pinned; }
.widget-whats-new { grid-area: whatsnew; }
.widget-last-commit { grid-area: lastcommit; }
.widget-languages--top { grid-area: languages-top; display: none; }
.widget-languages--activity { display: block; }

@media (min-width: 769px) and (max-width: 1199px) {
    .dashboard-grid.has-last-commit {
        grid-template-columns: repeat(2, minmax(0, 1fr));
        grid-template-areas:
            "pinned whatsnew"
            "lastcommit languages-top";
    }

    .dashboard-grid.no-last-commit {
        grid-template-columns: repeat(2, minmax(0, 1fr));
        grid-template-areas:
            "pinned whatsnew"
            "pinned languages-top";
    }

    .widget-languages--top { display: block; }
    .widget-languages--activity { display: none; }

    .activity-cards {
        display: grid;
        grid-template-columns: minmax(0, 2fr) minmax(0, 1fr);
        grid-template-areas:
            "timeline push"
            "timeline notes";
        gap: 1rem;
        overflow-x: visible;
        scroll-snap-type: none;
    }

    .widget-timeline { grid-area: timeline; }
    .widget-push { grid-area: push; }
    .widget-notes { grid-area: notes; }
}

@media (min-width: 1200px) {
    .dashboard-grid.has-last-commit {
        grid-template-columns: repeat(3, minmax(0, 1fr));
        grid-template-areas: "pinned whatsnew lastcommit";
    }

    .dashboard-grid.no-last-commit {
        grid-template-columns: repeat(3, minmax(0, 1fr));
        grid-template-areas: "pinned whatsnew languages-top";
    }

    .dashboard-grid.no-last-commit .widget-languages--top { display: block; }
    .dashboard-grid.has-last-commit .widget-languages--top { display: none; }

    .widget-languages--activity { display: block; }
    .activity-section.no-last-commit .widget-languages--activity { display: none; }

    .activity-cards {
        display: grid;
        grid-template-columns: minmax(0, 2fr) minmax(0, 1fr);
        grid-template-areas:
            "timeline push"
            "timeline notes"
            "timeline languages";
        gap: 1rem;
        overflow-x: visible;
        scroll-snap-type: none;
    }

    .activity-section.no-last-commit .activity-cards {
        grid-template-areas:
            "timeline push"
            "timeline notes";
    }

    .widget-timeline { grid-area: timeline; }
    .widget-push { grid-area: push; }
    .widget-notes { grid-area: notes; }
    .widget-languages--activity { grid-area: languages; }

    .activity-cards .widget-push,
    .activity-cards .widget-notes,
    .activity-cards .widget-languages--activity {
        align-self: start;
    }
}

/* Rose Pine Dawn Overrides for Dashboard Visibility */
:root[data-theme="rose-pine-dawn"] .timeline-badge-code {
    background: rgba(144, 122, 169, 0.15);
    color: #575279;
}
:root[data-theme="rose-pine-dawn"] .timeline-badge-info {
    background: rgba(86, 148, 159, 0.15);
    color: #286983;
}
:root[data-theme="rose-pine-dawn"] .timeline-badge-warning {
    background: rgba(234, 157, 52, 0.15);
    color: #907aa9;
}
:root[data-theme="rose-pine-dawn"] .timeline-badge-neutral {
    background: rgba(242, 233, 225, 0.6);
    color: #797593;
}

:root[data-theme="rose-pine-dawn"] .status-success {
    background: rgba(86, 148, 159, 0.2);
    color: #286983;
}
:root[data-theme="rose-pine-dawn"] .status-warning {
    background: rgba(234, 157, 52, 0.2);
    color: #b4637a;
}
:root[data-theme="rose-pine-dawn"] .status-danger {
    background: rgba(180, 99, 122, 0.2);
    color: #b4637a;
}
:root[data-theme="rose-pine-dawn"] .status-neutral {
    background: rgba(242, 233, 225, 0.6);
    color: #575279;
}

:root[data-theme="rose-pine-dawn"] .timeline-link,
:root[data-theme="rose-pine-dawn"] .note-link {
    color: var(--primary);
}

:root[data-theme="rose-pine-dawn"] .timeline-item {
    background: rgba(255, 255, 255, 0.5);
    border-right-color: rgba(144, 122, 169, 0.15);
}
/* === Attention Widget === */
.attention-card {
    border-right: 3px solid #f59e0b;
}

.attention-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.attention-header .section-title {
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.attention-header .section-title i {
    color: #f59e0b;
}

.badge-warning {
    background: rgba(245, 158, 11, 0.2);
    color: #fbbf24;
    padding: 0.25rem 0.75rem;
    border-radius: 999px;
    font-size: 0.85rem;
    font-weight: 600;
}

.attention-group {
    margin-bottom: 1.5rem;
}

.attention-group:last-of-type {
    margin-bottom: 0.5rem;
}

.attention-group__title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.attention-group__icon {
    font-size: 1.2rem;
}

.attention-group__count {
    font-weight: 400;
    opacity: 0.7;
    font-size: 0.9rem;
}

.attention-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.attention-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    background: rgba(255, 255, 255, 0.03);
    border-radius: 10px;
    border: 1px solid rgba(255, 255, 255, 0.08);
    transition: all 0.2s ease;
}

.attention-item:hover {
    background: rgba(255, 255, 255, 0.06);
    border-color: rgba(245, 158, 11, 0.3);
}

.attention-item__info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex: 1;
    min-width: 0;
    width: 100%;
}

.attention-item__icon {
    font-size: 1.5rem;
    flex-shrink: 0;
}

.attention-item__details {
    display: flex;
    flex-direction: column;
    gap: 0.2rem;
    min-width: 0;
    width: 100%;
}

.attention-item__name {
    font-weight: 500;
    color: inherit;
    text-decoration: none;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: block;
    max-width: 100%;
}

.attention-item__name:hover {
    color: #fbbf24;
}

.attention-item__reason {
    font-size: 0.8rem;
    opacity: 0.7;
    color: #f59e0b;
}

.attention-item__actions {
    display: flex;
    gap: 0.5rem;
    flex-shrink: 0;
}

.attention-item__actions .btn {
    padding: 0.4rem 0.6rem;
    opacity: 0.7;
    transition: opacity 0.2s;
}

.attention-item:hover .attention-item__actions .btn {
    opacity: 1;
}

.attention-more {
    font-size: 0.85rem;
    opacity: 0.7;
    text-align: center;
    margin-top: 0.75rem;
}

.attention-more-link {
    color: #fbbf24;
    margin-right: 0.5rem;
}

.attention-footer {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.attention-footer-hint {
    font-size: 0.8rem;
    opacity: 0.6;
}

.attention-settings-link {
    font-size: 0.85rem;
    color: inherit;
    opacity: 0.7;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
}

.attention-settings-link:hover {
    opacity: 1;
    color: #fbbf24;
}

/* Quick Edit Modal */
.attention-modal {
    position: fixed;
    inset: 0;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.attention-modal[hidden] {
    display: none;
}

.attention-modal .modal-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
}

.attention-modal .modal-content {
    position: relative;
    width: 90%;
    max-width: 450px;
    max-height: 90vh;
    overflow-y: auto;
    padding: 0;
}

.attention-modal .modal-content--small {
    max-width: 320px;
}

.attention-modal .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.attention-modal .modal-header h3 {
    margin: 0;
    font-size: 1.1rem;
}

.attention-modal .modal-close {
    background: none;
    border: none;
    color: inherit;
    font-size: 1.2rem;
    cursor: pointer;
    opacity: 0.7;
}

.attention-modal .modal-close:hover {
    opacity: 1;
}

.attention-modal .modal-body {
    padding: 1.5rem;
}

.attention-modal .form-group {
    margin-bottom: 1rem;
}

.attention-modal .form-group:last-child {
    margin-bottom: 0;
}

.attention-modal .form-group label {
    display: block;
    margin-bottom: 0.4rem;
    font-weight: 500;
}

.attention-modal .form-hint {
    display: block;
    margin-top: 0.3rem;
    font-size: 0.8rem;
    opacity: 0.7;
}

.attention-modal .modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
    padding: 1rem 1.5rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.quick-edit-file-name {
    font-weight: 600;
    margin: 0 0 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    font-family: monospace;
}

/* Dismiss Modal */
.dismiss-options {
    display: flex;
    gap: 0.75rem;
    margin-top: 1rem;
}

.dismiss-option {
    flex: 1;
}

/* Rose Pine Dawn overrides */
::root[data-theme="rose-pine-dawn"] .attention-card {
    border-right-color: #ea9d34;
}

::root[data-theme="rose-pine-dawn"] .attention-header .section-title i {
    color: #ea9d34;
}

::root[data-theme="rose-pine-dawn"] .badge-warning {
    background: rgba(234, 157, 52, 0.15);
    color: #ea9d34;
}

::root[data-theme="rose-pine-dawn"] .attention-item {
    background: rgba(255, 255, 255, 0.4);
    border-color: rgba(87, 82, 121, 0.15);
}

::root[data-theme="rose-pine-dawn"] .attention-item:hover {
    background: rgba(255, 255, 255, 0.5);
    border-color: rgba(234, 157, 52, 0.4);
}

::root[data-theme="rose-pine-dawn"] .attention-item__reason {
    color: #ea9d34;
}

::root[data-theme="rose-pine-dawn"] .attention-item__name:hover,
::root[data-theme="rose-pine-dawn"] .attention-settings-link:hover,
::root[data-theme="rose-pine-dawn"] .attention-more-link {
    color: #ea9d34;
}

/* Animation for item removal */
.attention-item.is-removing {
    opacity: 0;
    transform: translateX(-10px);
    transition: opacity 0.3s, transform 0.3s;
}

/* Grid placement */
.widget-attention {
    grid-area: attention;
}

@media (min-width: 769px) and (max-width: 1199px) {
    .activity-cards.has-attention {
        grid-template-areas:
            "timeline push"
            "timeline notes"
            "timeline attention";
    }
}

@media (min-width: 1200px) {
    .activity-cards.has-attention {
        grid-template-areas:
            "timeline push"
            "timeline notes"
            "timeline attention"
            "timeline languages";
    }
    
    .activity-section.no-last-commit .activity-cards.has-attention {
        grid-template-areas:
            "timeline push"
            "timeline notes"
            "timeline attention";
    }
    
    .activity-cards .widget-attention {
        align-self: start;
    }
}

@media (max-width: 768px) {
    .attention-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.75rem;
    }
    
    .attention-item__actions {
        width: 100%;
        justify-content: flex-end;
    }
    
    .dismiss-options {
        flex-direction: column;
    }
}
</style>

<script>
async function unpinFile(fileId) {
    try {
        const resp = await fetch(`/api/pin/toggle/${fileId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        const data = await resp.json();
        
        if (!resp.ok || !data.ok) {
            alert(data.error || '×©×’×™××” ×‘×”×¡×¨×ª × ×¢×™×¦×”');
            return;
        }

        if (data.is_pinned === true) {
            alert('×”×§×•×‘×¥ ×¢×“×™×™×Ÿ × ×¢×•×¥. × ×¡×” ×œ×¨×¢× ×Ÿ ××ª ×”×¢××•×“.');
            return;
        }
        
        const badge = document.querySelector('[data-pinned-count]');
        const maxPinned = badge ? parseInt(badge.getAttribute('data-max-pinned') || '0', 10) : 0;
        if (badge && typeof data.count === 'number') {
            const maxText = maxPinned || (badge.textContent || '').split('/')[1];
            badge.textContent = `${data.count}/${maxText}`.trim();
        }
        
        // ×”×¡×¨ ××ª ×”×›×¨×˜×™×¡ ××”-DOM
        const card = document.querySelector(`[data-pinned-card][data-file-id="${fileId}"]`);
        if (card) {
            card.style.opacity = '0';
            card.style.transform = 'scale(0.9)';
            setTimeout(() => {
                card.remove();
                
                // ×× ××™×Ÿ ×™×•×ª×¨ × ×¢×•×¦×™×, ×”×¡×ª×¨ ××ª ×›×œ ×”×§×˜×¢
                const grid = document.querySelector('[data-pinned-grid]');
                if (grid && grid.children.length === 0) {
                    const section = document.getElementById('pinnedFiles');
                    if (section) section.remove();
                }
            }, 200);
        }
        
    } catch (e) {
        console.error('unpin failed', e);
        alert('×©×’×™××” ×‘×”×¡×¨×ª × ×¢×™×¦×”');
    }
}

function refreshStats() {
    const btn = event.target;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ××¨×¢× ×Ÿ...';
    btn.disabled = true;
    
    fetch('/api/stats')
        .then(response => response.json())
        .then(data => {
            // ×‘×¢×ª×™×“: ×¢×“×›×•×Ÿ ×”× ×ª×•× ×™× ×‘×“×£
            location.reload();
        })
        .catch(error => {
            console.error('Error:', error);
            btn.innerHTML = '<i class="fas fa-sync"></i> ×¨×¢× ×Ÿ × ×ª×•× ×™×';
            btn.disabled = false;
        });
}

document.addEventListener('DOMContentLoaded', () => {
    const timelineCard = document.querySelector('[data-card="timeline"]');
    const activityWrapper = document.querySelector('[data-activity-cards]');
    if (!timelineCard || !activityWrapper) {
        return;
    }

    const filterButtons = activityWrapper.querySelectorAll('.timeline-filter-btn[data-filter]');
    const timelineEvents = timelineCard.querySelectorAll('[data-timeline-event]');

    const applyFilter = (filter) => {
        timelineCard.querySelectorAll('.timeline-group').forEach(group => {
            const groupId = group.getAttribute('data-group');
            const hide = filter !== 'all' && filter !== groupId;
            group.classList.toggle('is-hidden-by-filter', hide);
        });
        timelineEvents.forEach(eventEl => {
            const groupId = eventEl.getAttribute('data-group');
            const hide = filter !== 'all' && filter !== groupId;
            eventEl.classList.toggle('is-hidden-by-filter', hide);
        });
        activityWrapper.setAttribute('data-active-filter', filter);
    };

    filterButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            filterButtons.forEach(other => other.classList.toggle('is-active', other === btn));
            applyFilter(btn.getAttribute('data-filter') || 'all');
        });
    });

    const expandBtn = timelineCard.querySelector('[data-timeline-expand]');
    if (expandBtn) {
        expandBtn.addEventListener('click', () => {
            timelineCard.dataset.manualExpand = 'true';
            timelineCard.setAttribute('data-expanded', 'true');
            timelineCard.querySelectorAll('.timeline-group').forEach(group => group.classList.add('is-open'));
            expandBtn.style.display = 'none';
        });
    }

    timelineCard.querySelectorAll('[data-group-toggle]').forEach(toggle => {
        toggle.addEventListener('click', () => {
            const parent = toggle.closest('.timeline-group');
            if (parent) {
                parent.classList.toggle('is-open');
            }
        });
    });

    const mq = window.matchMedia('(min-width: 900px)');
    const syncDesktop = () => {
        if (mq.matches) {
            timelineCard.setAttribute('data-expanded', 'true');
            timelineCard.querySelectorAll('.timeline-group').forEach(group => group.classList.add('is-open'));
        } else if (!timelineCard.dataset.manualExpand) {
            timelineCard.setAttribute('data-expanded', 'false');
            timelineCard.querySelectorAll('.timeline-group').forEach(group => group.classList.remove('is-open'));
        }
    };
    try {
        mq.addEventListener('change', syncDesktop);
    } catch (err) {
        mq.addListener(syncDesktop);
    }
    syncDesktop();
});

document.addEventListener('DOMContentLoaded', () => {
    const btn = document.querySelector('.load-more-commit-files[data-sha]');
    const list = document.querySelector('[data-last-commit-files]');
    if (!btn || !list) return;

    const repoName = btn.dataset.repo || 'CodeBot';

    const appendFileRow = (file) => {
        const path = (file && file.path ? String(file.path) : '').trim();
        if (!path) return;

        const a = document.createElement('a');
        a.className = `changed-file-item status-${file.status || 'unknown'}`;
        a.href = `/repo/?repo=${encodeURIComponent(repoName)}&file=${encodeURIComponent(path)}`;
        a.title = path;

        const info = document.createElement('div');
        info.className = 'file-info';

        const fileIcon = document.createElement('span');
        fileIcon.className = 'file-icon';
        fileIcon.textContent = String(file.file_icon || 'ğŸ“„');

        const name = document.createElement('span');
        name.className = 'file-name';
        name.title = path;
        name.textContent = String(file.name || path.split('/').pop() || path);

        info.appendChild(fileIcon);
        info.appendChild(name);

        const statusWrap = document.createElement('div');
        statusWrap.className = 'file-status';

        const statusIcon = document.createElement('span');
        statusIcon.className = 'status-icon';
        statusIcon.title = String(file.status_label || '');
        statusIcon.textContent = String(file.status_icon || 'â“');

        statusWrap.appendChild(statusIcon);

        a.appendChild(info);
        a.appendChild(statusWrap);

        const moreEl = list.querySelector('.more-files');
        if (moreEl && moreEl.parentNode === list) {
            list.insertBefore(a, moreEl);
        } else {
            list.appendChild(a);
        }
    };

    const setButtonLabel = (remaining) => {
        const rem = Math.max(0, parseInt(remaining || '0', 10) || 0);
        if (rem <= 0) {
            btn.remove();
            return;
        }
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-plus"></i> ' + `×˜×¢×Ÿ ×¢×•×“ ${rem} ×§×‘×¦×™×`;
    };

    btn.addEventListener('click', async () => {
        const sha = (btn.dataset.sha || '').trim();
        const offset = parseInt(btn.dataset.offset || '0', 10) || 0;
        const limit = 50;

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ×˜×•×¢×Ÿ...';

        try {
            const qs = new URLSearchParams({
                sha,
                offset: String(offset),
                limit: String(limit),
            });
            const resp = await fetch(`/api/dashboard/last-commit-files?${qs.toString()}`, {
                headers: { 'Accept': 'application/json' },
            });
            const data = await resp.json();
            if (!resp.ok || !data || data.ok !== true) {
                throw new Error((data && data.error) ? String(data.error) : 'load_failed');
            }

            const files = Array.isArray(data.files) ? data.files : [];
            files.forEach(appendFileRow);

            const newOffset = offset + files.length;
            btn.dataset.offset = String(newOffset);

            const total = parseInt(data.total_files || btn.dataset.total || '0', 10) || 0;
            const remaining = Math.max(0, total - newOffset);
            setButtonLabel(remaining);
        } catch (e) {
            console.error('Failed to load more commit files:', e);
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> × ×¡×” ×©×•×‘';
        }
    });
});

document.addEventListener('DOMContentLoaded', () => {
    const loadMoreButtons = document.querySelectorAll('.timeline-load-more-files[data-offset]');
    if (!loadMoreButtons.length) return;

    const createTimelineItem = (event) => {
        const article = document.createElement('article');
        article.className = 'timeline-item';
        article.setAttribute('data-timeline-event', '');
        article.setAttribute('data-group', 'files');
        if (event && event.accent) {
            article.setAttribute('data-accent', String(event.accent));
        }

        const marker = document.createElement('div');
        marker.className = 'timeline-marker';

        const body = document.createElement('div');
        body.className = 'timeline-item-body';

        const header = document.createElement('div');
        header.className = 'timeline-item-header';

        const icon = document.createElement('div');
        icon.className = 'timeline-icon';
        icon.textContent = String(event.icon || 'ğŸ“');

        const texts = document.createElement('div');
        texts.className = 'timeline-texts';

        const title = document.createElement('div');
        title.className = 'timeline-title';
        title.textContent = String(event.title || '');

        const subtitle = document.createElement('div');
        subtitle.className = 'timeline-subtitle';
        subtitle.textContent = String(event.subtitle || '');

        texts.appendChild(title);
        texts.appendChild(subtitle);

        const time = document.createElement('div');
        time.className = 'timeline-time';
        time.textContent = String(event.relative_time || '');

        header.appendChild(icon);
        header.appendChild(texts);
        header.appendChild(time);

        const footer = document.createElement('div');
        footer.className = 'timeline-item-footer';

        if (event.badge) {
            const badge = document.createElement('span');
            const variant = String(event.badge_variant || 'neutral');
            badge.className = `timeline-badge timeline-badge-${variant}`;
            badge.textContent = String(event.badge);
            footer.appendChild(badge);
        }

        if (event.href) {
            const a = document.createElement('a');
            a.className = 'timeline-link';
            a.href = String(event.href);
            a.textContent = '×¤×ª×—';
            footer.appendChild(a);
        }

        body.appendChild(header);
        body.appendChild(footer);
        article.appendChild(marker);
        article.appendChild(body);
        return article;
    };

    const updateButtonLabel = (btn, remaining) => {
        const rem = Math.max(0, parseInt(remaining || '0', 10) || 0);
        if (rem <= 0) {
            btn.closest('.timeline-load-more-wrap')?.remove();
            return;
        }
        const toLoad = Math.min(12, rem);
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-plus"></i> ' + `×˜×¢×Ÿ ×¢×•×“ ${toLoad} ×§×‘×¦×™×`;
    };

    loadMoreButtons.forEach((btn) => {
        btn.addEventListener('click', async () => {
            const offset = parseInt(btn.dataset.offset || '0', 10) || 0;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ×˜×•×¢×Ÿ...';

            try {
                const qs = new URLSearchParams({
                    offset: String(offset),
                    limit: '12',
                });
                const resp = await fetch(`/api/dashboard/activity/files?${qs.toString()}`, {
                    headers: { 'Accept': 'application/json' },
                });
                const data = await resp.json();
                if (!resp.ok || !data || data.ok !== true) {
                    throw new Error((data && data.error) ? String(data.error) : 'load_failed');
                }

                const events = Array.isArray(data.events) ? data.events : [];
                const group = btn.closest('.timeline-group[data-group="files"]');
                const groupItems = group ? group.querySelector('.group-items') : null;
                const wrap = btn.closest('.timeline-load-more-wrap');
                if (groupItems) {
                    events.forEach((ev) => {
                        const item = createTimelineItem(ev);
                        if (wrap && wrap.parentNode === groupItems) {
                            groupItems.insertBefore(item, wrap);
                        } else {
                            groupItems.appendChild(item);
                        }
                    });
                }

                btn.dataset.offset = String(data.next_offset || (offset + events.length));
                updateButtonLabel(btn, data.remaining);
            } catch (e) {
                console.error('Failed to load more file activity:', e);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> × ×¡×” ×©×•×‘';
            }
        });
    });
});

// === What's New: Load More ===
document.addEventListener('DOMContentLoaded', () => {
    const btn = document.querySelector('.load-more-whats-new[data-offset]');
    const list = document.querySelector('[data-whats-new-list]');
    if (!btn || !list) return;

    const createFeatureItem = (feature) => {
        const item = document.createElement('div');
        item.className = 'whats-new-item';

        const content = document.createElement('div');
        content.className = 'feature-content';

        const icon = document.createElement('span');
        icon.className = 'feature-icon';
        icon.textContent = String(feature.icon || 'âœ¨');

        const details = document.createElement('div');
        details.className = 'feature-details';

        const titleWrap = document.createElement('div');
        titleWrap.className = 'feature-title';
        titleWrap.textContent = String(feature.title || '');

        if (feature.badge) {
            const badge = document.createElement('span');
            badge.className = 'feature-badge';
            badge.textContent = String(feature.badge);
            titleWrap.appendChild(badge);
        }

        details.appendChild(titleWrap);

        if (feature.description) {
            const desc = document.createElement('div');
            desc.className = 'feature-description';
            desc.textContent = String(feature.description);
            details.appendChild(desc);
        }

        const time = document.createElement('div');
        time.className = 'feature-time';
        time.textContent = String(feature.relative_time || '');
        details.appendChild(time);

        content.appendChild(icon);
        content.appendChild(details);
        item.appendChild(content);

        if (feature.link) {
            const link = document.createElement('a');
            link.className = 'btn btn-secondary btn-sm';
            link.href = String(feature.link);
            link.title = '×œ××™×“×¢ × ×•×¡×£';
            link.innerHTML = '<i class="fas fa-arrow-left"></i>';
            item.appendChild(link);
        }

        return item;
    };

    const updateButton = (remaining) => {
        const rem = Math.max(0, parseInt(remaining || '0', 10) || 0);
        if (rem <= 0) {
            btn.closest('.whats-new-load-more')?.remove();
            return;
        }
        btn.disabled = false;
        btn.innerHTML = `<i class="fas fa-plus"></i> ×˜×¢×Ÿ ×¢×•×“ ${rem} ×¢×“×›×•× ×™×`;
    };

    btn.addEventListener('click', async () => {
        const offset = parseInt(btn.dataset.offset || '0', 10) || 0;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ×˜×•×¢×Ÿ...';

        try {
            const qs = new URLSearchParams({
                offset: String(offset),
                limit: '5',
                max_days: '180',
            });
            const resp = await fetch(`/api/dashboard/whats-new?${qs.toString()}`, {
                headers: { 'Accept': 'application/json' },
            });
            const data = await resp.json();
            if (!resp.ok || !data || data.ok !== true) {
                throw new Error((data && data.error) ? String(data.error) : 'load_failed');
            }

            const features = Array.isArray(data.features) ? data.features : [];
            const loadMoreWrap = btn.closest('.whats-new-load-more');
            features.forEach((feat) => {
                const item = createFeatureItem(feat);
                if (loadMoreWrap && loadMoreWrap.parentNode) {
                    loadMoreWrap.parentNode.insertBefore(item, loadMoreWrap);
                } else {
                    list.appendChild(item);
                }
            });

            btn.dataset.offset = String(data.next_offset || (offset + features.length));
            btn.dataset.remaining = String(data.remaining || 0);
            updateButton(data.remaining);
        } catch (e) {
            console.error('Failed to load more features:', e);
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> × ×¡×” ×©×•×‘';
        }
    });
});

// === Attention Widget: Quick Edit & Dismiss ===
document.addEventListener('DOMContentLoaded', () => {
    const widget = document.querySelector('[data-attention-widget]');
    if (!widget) return;

    const quickEditModal = document.getElementById('attentionQuickEditModal');
    const dismissModal = document.getElementById('attentionDismissModal');
    const quickEditForm = quickEditModal?.querySelector('[data-quick-edit-form]');
    const saveBtn = quickEditModal?.querySelector('[data-action="save-quick-edit"]');

    // === ×¤×ª×™×—×ª ××•×“×œ ×¢×¨×™×›×” ××”×™×¨×” ===
    // ××©×ª× ×™× ×œ×©××™×¨×ª ×”×¢×¨×›×™× ×”××§×•×¨×™×™× (×œ×× ×™×¢×ª ××™×‘×•×“ × ×ª×•× ×™×)
    // ×—×©×•×‘: ×× ×”××©×ª××© ×œ× ×©×™× ×” ×©×“×”, ×œ× × ×©×œ×— ××•×ª×• ×œ×©×¨×ª
    let originalDescription = '';
    let originalTags = '';

    widget.addEventListener('click', (e) => {
        const editBtn = e.target.closest('[data-action="quick-edit"]');
        if (editBtn && quickEditModal && quickEditForm) {
            const fileId = editBtn.dataset.fileId;
            const fileName = editBtn.dataset.fileName || '';
            // ×”×¢×¨×›×™× ××’×™×¢×™× ×›-JSON escaped, ×¦×¨×™×š ×œ×¤×¨×¡×¨
            let currentDesc = '';
            let currentTags = '';
            try {
                currentDesc = JSON.parse(editBtn.dataset.currentDesc || '""');
            } catch { currentDesc = ''; }
            try {
                // ×›××Ÿ ××’×™×¢×•×ª ×›×œ ×”×ª×’×™×•×ª (tags_full), ×œ× ×¨×§ 5 ×”×¨××©×•× ×•×ª
                currentTags = JSON.parse(editBtn.dataset.currentTags || '""');
            } catch { currentTags = ''; }

            // ×©××™×¨×ª ×”×¢×¨×›×™× ×”××§×•×¨×™×™× ×œ×”×©×•×•××” ×‘×¢×ª ×©××™×¨×”
            originalDescription = currentDesc;
            originalTags = currentTags;

            quickEditForm.querySelector('[data-field="file_id"]').value = fileId;
            quickEditForm.querySelector('[data-field="file_name_display"]').textContent = fileName;
            quickEditForm.querySelector('#quickEditDescription').value = currentDesc;
            quickEditForm.querySelector('#quickEditTags').value = currentTags;

            quickEditModal.hidden = false;
            quickEditForm.querySelector('#quickEditDescription').focus();
        }
    });

    // === ×¡×’×™×¨×ª ××•×“×œ×™× ===
    [quickEditModal, dismissModal].forEach(modal => {
        modal?.querySelectorAll('[data-modal-close]').forEach(btn => {
            btn.addEventListener('click', () => {
                modal.hidden = true;
            });
        });
    });

    // === ESC ×œ×¡×’×™×¨×ª ××•×“×œ×™× ===
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            if (quickEditModal && !quickEditModal.hidden) quickEditModal.hidden = true;
            if (dismissModal && !dismissModal.hidden) dismissModal.hidden = true;
        }
    });

    // === ×©××™×¨×” ××”×™×¨×” ===
    saveBtn?.addEventListener('click', async () => {
        if (!quickEditForm) return;

        const fileId = quickEditForm.querySelector('[data-field="file_id"]').value;
        const newDescription = quickEditForm.querySelector('#quickEditDescription').value.trim();
        const newTagsRaw = quickEditForm.querySelector('#quickEditTags').value.trim();

        // ×‘× ×™×™×ª payload - ×©×•×œ×—×™× ×¨×§ ×©×“×•×ª ×©×”×©×ª× ×•!
        // ×–×” ××•× ×¢ ××™×‘×•×“ × ×ª×•× ×™× (×œ××©×œ ×ª×’×™×•×ª ×©×œ× ×”×•×¦×’×• ×‘××œ×•××Ÿ)
        const payload = {};
        
        if (newDescription !== originalDescription) {
            payload.description = newDescription;
        }
        
        if (newTagsRaw !== originalTags) {
            payload.tags = newTagsRaw ? newTagsRaw.split(',').map(t => t.trim()).filter(Boolean) : [];
        }

        // ×× ×œ× ×”×©×ª× ×” ×›×œ×•×, ××™×Ÿ ××” ×œ×©××•×¨
        if (Object.keys(payload).length === 0) {
            quickEditModal.hidden = true;
            showToast('×œ× ×‘×•×¦×¢×• ×©×™× ×•×™×™×', 'info');
            return;
        }

        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ×©×•××¨...';

        try {
            const resp = await fetch(`/api/file/${fileId}/quick-update`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await resp.json();

            if (!resp.ok || !data.ok) {
                throw new Error(data.error || '×©×’×™××” ×‘×©××™×¨×”');
            }

            // ×”×¡×¨×ª ×”×¤×¨×™×˜ ××”×¨×©×™××” (×•×™×–×•××œ×™×ª)
            removeAttentionItem(fileId);
            quickEditModal.hidden = true;

            showToast('× ×©××¨ ×‘×”×¦×œ×—×”!', 'success');

        } catch (err) {
            console.error('Quick update failed:', err);
            showToast(err.message || '×©×’×™××” ×‘×©××™×¨×”', 'error');
        } finally {
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="fas fa-save"></i> ×©××•×¨';
        }
    });

    // === ×¤×ª×™×—×ª ××•×“×œ ×“×—×™×™×” ===
    widget.addEventListener('click', (e) => {
        const dismissBtn = e.target.closest('[data-action="dismiss"]');
        if (!dismissBtn || !dismissModal) return;

        const fileId = dismissBtn.dataset.fileId;
        dismissModal.querySelector('[data-field="dismiss_file_id"]').value = fileId;
        dismissModal.hidden = false;
    });

    // === ×‘×—×™×¨×ª ×ª×§×•×¤×ª ×“×—×™×™×” ===
    dismissModal?.querySelectorAll('.dismiss-option[data-days]').forEach(btn => {
        btn.addEventListener('click', async () => {
            const fileId = dismissModal.querySelector('[data-field="dismiss_file_id"]').value;
            const isForever = btn.dataset.forever === 'true';
            const days = isForever ? 0 : Math.max(parseInt(btn.dataset.days, 10) || 30, 1);

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const payload = isForever ? { forever: true } : { days };
                const resp = await fetch(`/api/file/${fileId}/dismiss-attention`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await resp.json();

                if (!resp.ok || !data.ok) {
                    throw new Error(data.error || '×©×’×™××” ×‘×“×—×™×™×”');
                }

                removeAttentionItem(fileId);
                dismissModal.hidden = true;
                
                const daysText = isForever ? '×œ×ª××™×“' : (days === 7 ? '×©×‘×•×¢' : days === 30 ? '×—×•×“×©' : `${days} ×™××™×`);
                showToast(`× ×“×—×” ×œ-${daysText}`, 'info');

            } catch (err) {
                console.error('Dismiss failed:', err);
                showToast(err.message || '×©×’×™××” ×‘×“×—×™×™×”', 'error');
            } finally {
                btn.disabled = false;
                // Reset button text based on days
                const daysMap = { 7: '×©×‘×•×¢', 30: '×—×•×“×©', 90: '3 ×—×•×“×©×™×' };
                if (btn.dataset.forever === 'true') {
                    btn.textContent = '×œ×ª××™×“';
                } else {
                    btn.textContent = daysMap[btn.dataset.days] || `${btn.dataset.days} ×™××™×`;
                }
            }
        });
    });

    /**
     * ×›×™×•×•×¥ ×©× ×§×•×‘×¥ ×›×š ×©×™×™×›× ×¡ ×‘×©×•×¨×” ××—×ª,
     * ×•×¨×§ ×× ××’×™×¢ ×œ×’×•×“×œ ××™× ×™××œ×™ ×•×¢×“×™×™×Ÿ ××™×Ÿ ××§×•× - × ×©××™×¨ ... (ellipsis).
     */
    function fitAttentionNames() {
        const nameEls = widget.querySelectorAll('.attention-item__name');
        nameEls.forEach((el) => {
            if (!el || el.clientWidth === 0) return;
            const computed = window.getComputedStyle(el);
            const baseSize = parseFloat(el.dataset.baseFontSize || computed.fontSize || '16');
            if (!el.dataset.baseFontSize) {
                el.dataset.baseFontSize = String(baseSize);
            }
            const minSize = 12; // ××™× ×™××•× ×§×¨×™×
            let size = baseSize;
            el.style.fontSize = `${size}px`;
            // ×× ×›×‘×¨ × ×›× ×¡, ××™×Ÿ ×¦×•×¨×š ×œ×›×•×•×¥
            if (el.scrollWidth <= el.clientWidth) return;
            // ×›×™×•×•×¥ ×”×“×¨×’×ª×™ ×¢×“ ×©××ª××™× ××• ×¢×“ ××™× ×™××•×
            while (size > minSize && el.scrollWidth > el.clientWidth) {
                size -= 0.5;
                el.style.fontSize = `${size}px`;
            }
        });
    }

    let resizeTimer = null;
    window.addEventListener('resize', () => {
        if (resizeTimer) window.clearTimeout(resizeTimer);
        resizeTimer = window.setTimeout(() => {
            fitAttentionNames();
        }, 150);
    });

    // ×¨×™×¦×” ×¨××©×•× ×™×ª
    fitAttentionNames();

    /**
     * ×”×¡×¨×ª ×¤×¨×™×˜ ××”×¨×©×™××” (×•×™×–×•××œ×™×ª ×‘×œ×‘×“).
     * 
     * ×”×¢×¨×” ×—×©×•×‘×”: ×”×¡×¤×™×¨×•×ª (total) ×©××’×™×¢×•×ª ××”×©×¨×ª ×œ× ××ª×¢×“×›× ×•×ª ×›××Ÿ.
     * ×”-Badge ×”×›×•×œ×œ ××•×¤×—×ª ×•×™×–×•××œ×™×ª, ××‘×œ ×”×¡×¤×™×¨×•×ª ×‘×›×•×ª×¨×•×ª ×”×§×‘×•×¦×•×ª
     * × ×©××¨×•×ª ×›×¤×™ ×©×”×™×• (××• ××¦×™×’×•×ª "××•×¦×’×™× X ××ª×•×š Y").
     * ×œ×¡× ×›×¨×•×Ÿ ××œ× ×™×© ×œ×¨×¢× ×Ÿ ××ª ×”×“×£.
     */
    function removeAttentionItem(fileId) {
        const item = widget.querySelector(`.attention-item[data-file-id="${fileId}"]`);
        if (item) {
            item.classList.add('is-removing');
            setTimeout(() => {
                item.remove();
                updateVisualCounts();
            }, 300);
        }
    }

    /**
     * ×¢×“×›×•×Ÿ ×¡×¤×™×¨×•×ª ×•×™×–×•××œ×™ ×‘×œ×‘×“.
     * ××¢×“×›×Ÿ ××ª ×”-Badge ×”×›×•×œ×œ ×‘×”×ª×‘×¡×¡ ×¢×œ ××¡×¤×¨ ×”×¤×¨×™×˜×™× ×©× ×•×ª×¨×• ×‘-DOM.
     * ×”×¡×¤×™×¨×•×ª ×‘×›×•×ª×¨×•×ª ×”×§×‘×•×¦×•×ª ×œ× ××©×ª× ×•×ª (×›×™ ×”×Ÿ ××¦×™×’×•×ª total ××”×©×¨×ª).
     */
    function updateVisualCounts() {
        const allItems = widget.querySelectorAll('.attention-item:not(.is-removing)');
        const totalBadge = widget.querySelector('[data-attention-total-badge]');
        
        if (totalBadge) {
            totalBadge.textContent = allItems.length;
        }

        // ×”×¡×ª×¨ ×§×‘×•×¦×” ×¨×™×§×”
        widget.querySelectorAll('[data-attention-list]').forEach(list => {
            const group = list.closest('.attention-group');
            const items = list.querySelectorAll('.attention-item:not(.is-removing)');
            
            if (items.length === 0 && group) {
                group.style.display = 'none';
            }
        });

        // ×”×¡×ª×¨ ××ª ×›×œ ×”×•×•×™×“×’'×˜ ×× ××™×Ÿ ×¤×¨×™×˜×™×
        if (allItems.length === 0) {
            widget.style.display = 'none';
        }

        fitAttentionNames();
    }

    function showToast(message, type = 'info') {
        // ×©×™××•×© ×‘××¢×¨×›×ª Toast ×§×™×™××ª ×× ×™×©
        if (typeof window.showNotification === 'function') {
            window.showNotification(message, type);
        } else if (typeof window.Toastify === 'function') {
            Toastify({
                text: message,
                duration: 3000,
                gravity: 'bottom',
                position: 'right',
                className: `toast-${type}`
            }).showToast();
        } else {
            console.log(`[${type}] ${message}`);
        }
    }
});
</script>
{% endblock %}
