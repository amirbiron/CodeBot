{% extends "base.html" %}

{% block title %}×“×©×‘×•×¨×“ - Code Keeper Bot{% endblock %}

{% block content %}
<h1 class="page-title">×“×©×‘×•×¨×“</h1>

<div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 3rem;">
    <div class="glass-card stat-card">
        <div class="stat-icon" style="font-size: 2.5rem; margin-bottom: 1rem;">ğŸ“</div>
        <div class="stat-value" style="font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem;">{{ stats.total_files }}</div>
        <div class="stat-label" style="opacity: 0.8;">×¡×š ×”×›×œ ×§×‘×¦×™×</div>
    </div>

    <div class="glass-card stat-card">
        <div class="stat-icon" style="font-size: 2.5rem; margin-bottom: 1rem;">ğŸ’¾</div>
        <div class="stat-value" style="font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem;">{{ stats.total_size }}</div>
        <div class="stat-label" style="opacity: 0.8;">× ×¤×— ×›×•×œ×œ</div>
    </div>

    <div class="glass-card stat-card">
        <div class="stat-icon" style="font-size: 2.5rem; margin-bottom: 1rem;">ğŸ†</div>
        <div class="stat-value" style="font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem;">
            {% if stats.top_languages %}
                {{ stats.top_languages[0].icon }} {{ stats.top_languages[0].name }}
            {% else %}
                -
            {% endif %}
        </div>
        <div class="stat-label" style="opacity: 0.8;">×”×©×¤×” ×”×¤×•×¤×•×œ×¨×™×ª ×‘×™×•×ª×¨</div>
    </div>

    <div class="glass-card stat-card">
        <div class="stat-icon" style="font-size: 2.5rem; margin-bottom: 1rem;">â°</div>
        <div class="stat-value" style="font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem;">
            {% if stats.recent_files %}
                ×”×™×•×
            {% else %}
                -
            {% endif %}
        </div>
        <div class="stat-label" style="opacity: 0.8;">×¤×¢×™×œ×•×ª ××—×¨×•× ×”</div>
    </div>
</div>

<div class="dashboard-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 2rem;">
    <div class="glass-card">
        <h2 class="section-title">
            <i class="fas fa-code"></i>
            ×©×¤×•×ª ×ª×›× ×•×ª
        </h2>
        {% if stats.top_languages %}
        <div class="languages-list">
            {% for lang in stats.top_languages %}
            <div class="language-item">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <span style="font-size: 1.5rem;">{{ lang.icon }}</span>
                    <span style="font-weight: 500;">{{ lang.name }}</span>
                </div>
                <div class="badge">{{ lang.count }} ×§×‘×¦×™×</div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p style="opacity: 0.7;">××™×Ÿ ×¢×“×™×™×Ÿ ×§×‘×¦×™×</p>
        {% endif %}
    </div>

    <div class="glass-card whats-new-card">
        <h2 class="section-title">
            <i class="fas fa-sparkles"></i>
            ××” ×—×“×©
        </h2>
        {% if whats_new.has_features %}
        <div class="whats-new-list">
            {% for feature in whats_new.features %}
            <div class="whats-new-item">
                <div class="feature-content">
                    <span class="feature-icon">{{ feature.icon }}</span>
                    <div class="feature-details">
                        <div class="feature-title">
                            {{ feature.title }}
                            {% if feature.badge %}
                            <span class="feature-badge">{{ feature.badge }}</span>
                            {% endif %}
                        </div>
                        {% if feature.description %}
                        <div class="feature-description">{{ feature.description }}</div>
                        {% endif %}
                        <div class="feature-time">{{ feature.relative_time }}</div>
                    </div>
                </div>
                {% if feature.link %}
                <a href="{{ feature.link }}" class="btn btn-secondary btn-sm" title="×œ××™×“×¢ × ×•×¡×£">
                    <i class="fas fa-arrow-left"></i>
                </a>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p style="opacity: 0.7;">××™×Ÿ ×¢×“×›×•× ×™× ×—×“×©×™× ×›×¨×’×¢</p>
        {% endif %}
    </div>

    {% if user_is_admin and last_commit %}
    {# === ×‘×œ×•×§ ×§×•××™×˜ ××—×¨×•×Ÿ (××“××™×Ÿ ×‘×œ×‘×“) === #}
    <div class="glass-card last-commit-card">
        <h2 class="section-title">
            <i class="fas fa-code-commit"></i>
            ×§×•××™×˜ ××—×¨×•×Ÿ
        </h2>

        <div class="commit-header">
            <div class="commit-info">
                <div class="commit-sha">
                    <code>{{ last_commit.sha_short }}</code>
                </div>
                <div class="commit-message" title="{{ last_commit.message }}">
                    {{ last_commit.message[:80] }}{% if last_commit.message|length > 80 %}...{% endif %}
                </div>
                <div class="commit-meta">
                    <span class="commit-author">
                        <i class="fas fa-user"></i> {{ last_commit.author }}
                    </span>
                    <span class="commit-date">
                        <i class="fas fa-clock"></i> {{ last_commit.date[:10] }}
                    </span>
                </div>
            </div>
        </div>

        {% if last_commit.files %}
        <div class="changed-files-list" data-last-commit-files>
            <div class="files-header">
                <span>×§×‘×¦×™× ×©×”×©×ª× ×•</span>
                <span class="files-count badge">{{ last_commit.total_files }}</span>
            </div>
            {% for file in last_commit.files %}
            <a class="changed-file-item status-{{ file.status }}" href="/repo/?file={{ file.path|urlencode }}" title="{{ file.path }}">
                <div class="file-info">
                    <span class="file-icon">{{ file.file_icon }}</span>
                    <span class="file-name" title="{{ file.path }}">{{ file.name }}</span>
                </div>
                <div class="file-status">
                    <span class="status-icon" title="{{ file.status_label }}">{{ file.status_icon }}</span>
                </div>
            </a>
            {% endfor %}

            {% if last_commit.truncated %}
            <div class="more-files">
                <button
                    type="button"
                    class="btn btn-secondary btn-icon load-more-commit-files"
                    data-sha="{{ last_commit.sha }}"
                    data-offset="{{ last_commit.files|length }}"
                    data-total="{{ last_commit.total_files }}"
                >
                    <i class="fas fa-plus"></i>
                    ×˜×¢×Ÿ ×¢×•×“ {{ last_commit.total_files - last_commit.files|length }} ×§×‘×¦×™×
                </button>
            </div>
            {% endif %}
        </div>
        {% else %}
        <p class="no-changes">××™×Ÿ ×§×‘×¦×™× ×©×”×©×ª× ×•</p>
        {% endif %}

        <div class="commit-actions">
            <a href="/repo/" class="btn btn-secondary btn-icon">
                <i class="fas fa-folder-tree"></i>
                ×“×¤×“×¤×Ÿ ×§×•×“
            </a>
            {% if last_commit.sync_time %}
            <small class="sync-time">
                ×¡×•× ×›×¨×Ÿ: {{ last_commit.sync_time.strftime('%d/%m %H:%M') if last_commit.sync_time else '×œ× ×™×“×•×¢' }}
            </small>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<section class="activity-section" id="activity-timeline">
    <div class="activity-header">
        <div class="activity-title">
            <h2 class="section-title">
                <i class="fas fa-bolt"></i>
                ×”×™×¡×˜×•×¨×™×™×ª ×¤×¢×•×œ×•×ª
            </h2>
            <p class="activity-subtitle">×§×— ×”×—×œ×˜×•×ª ××”×™×¨×•×ª ×¢× ×ª××•× ×ª ××¦×‘ ×©×œ ×©××™×¨×•×ª, ×¤×•×© ×•×’×™×‘×•×™×™×</p>
        </div>
        {% if activity_timeline.filters %}
        <div class="timeline-filters desktop-only">
            {% for filter in activity_timeline.filters %}
            <button type="button"
                    class="timeline-filter-btn{% if loop.first %} is-active{% endif %}"
                    data-filter="{{ filter.id }}">
                <span>{{ filter.label }}</span>
                <span class="filter-count">{{ filter.count }}</span>
            </button>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <div class="activity-cards" data-activity-cards data-active-filter="all">
        <article class="activity-card timeline-card glass-card" data-card="timeline" data-expanded="false">
            <header class="timeline-card-header">
                <div>
                    <h3>×¤×™×“ ××—×¨×•×Ÿ</h3>
                </div>
                <button class="timeline-expand mobile-only" type="button" data-timeline-expand>
                    <span>×”×¦×’ ×”×›×•×œ</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
            </header>

            <div class="timeline-feed mobile-only" data-timeline-feed>
                {% if activity_timeline.has_events %}
                    {% for event in activity_timeline.feed %}
                        {% if loop.index <= activity_timeline.compact_limit %}
                        <article class="timeline-item" data-timeline-event data-group="{{ event.group }}" data-accent="{{ event.accent }}">
                            <div class="timeline-marker"></div>
                            <div class="timeline-item-body">
                                <div class="timeline-item-header">
                                    <div class="timeline-icon">{{ event.icon }}</div>
                                    <div class="timeline-texts">
                                        <div class="timeline-title">{{ event.title }}</div>
                                        <div class="timeline-subtitle">{{ event.subtitle }}</div>
                                    </div>
                                    <div class="timeline-time">{{ event.relative_time }}</div>
                                </div>
                                <div class="timeline-item-footer">
                                    {% if event.badge %}
                                    <span class="timeline-badge timeline-badge-{{ event.badge_variant|default('neutral') }}">{{ event.badge }}</span>
                                    {% endif %}
                                    {% if event.href %}
                                    <a class="timeline-link" href="{{ event.href }}">×¤×ª×—</a>
                                    {% endif %}
                                </div>
                            </div>
                        </article>
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <p class="timeline-empty">×¢×•×“ ×œ× ×©××¨×ª ×§×‘×¦×™×, ×¤×ª×§×™× ××• ×ª×–×›×•×¨×•×ª. ×›×œ ×¤×¢×•×œ×” ×—×“×©×” ×ª×•×¤×™×¢ ×›××Ÿ.</p>
                {% endif %}
            </div>

            <div class="timeline-groups" data-timeline-groups>
                {% if activity_timeline.groups %}
                    {% for group in activity_timeline.groups %}
                    <div class="timeline-group" data-group="{{ group.id }}">
                        <button class="group-toggle" type="button" data-group-toggle>
                            <div class="group-info">
                                <span class="group-icon">{{ group.icon }}</span>
                                <div>
                                    <div class="group-title">{{ group.title }}</div>
                                    <div class="group-summary">{{ group.summary }}</div>
                                </div>
                            </div>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="group-items">
                            {% for event in group.events %}
                            <article class="timeline-item" data-timeline-event data-group="{{ group.id }}" data-accent="{{ event.accent }}">
                                <div class="timeline-marker"></div>
                                <div class="timeline-item-body">
                                    <div class="timeline-item-header">
                                        <div class="timeline-icon">{{ event.icon }}</div>
                                        <div class="timeline-texts">
                                            <div class="timeline-title">{{ event.title }}</div>
                                            <div class="timeline-subtitle">{{ event.subtitle }}</div>
                                        </div>
                                        <div class="timeline-time">{{ event.relative_time }}</div>
                                    </div>
                                    <div class="timeline-item-footer">
                                        {% if event.badge %}
                                        <span class="timeline-badge timeline-badge-{{ event.badge_variant|default('neutral') }}">{{ event.badge }}</span>
                                        {% endif %}
                                        {% if event.href %}
                                        <a class="timeline-link" href="{{ event.href }}">×¤×ª×—</a>
                                        {% endif %}
                                    </div>
                                </div>
                            </article>
                            {% endfor %}
                            {% if group.id == 'files' and group.has_more %}
                            <div class="timeline-load-more-wrap">
                                <button
                                    type="button"
                                    class="btn btn-secondary btn-icon timeline-load-more-files"
                                    data-offset="{{ group.shown|default(group.events|length) }}"
                                    data-total="{{ group.total_recent|default(0) }}"
                                >
                                    <i class="fas fa-plus"></i>
                                    ×˜×¢×Ÿ ×¢×•×“ {{ 12 if (group.total_recent - (group.shown|default(group.events|length))) > 12 else (group.total_recent - (group.shown|default(group.events|length))) }} ×§×‘×¦×™×
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="timeline-empty">××™×Ÿ × ×ª×•× ×™ ×¤×¢×™×œ×•×ª ×–××™× ×™×.</p>
                {% endif %}
            </div>
        </article>

        <article class="activity-card push-card glass-card" data-card="push">
            <header class="mini-card-header">
                <div class="card-icon">ğŸ“£</div>
                <div>
                    <h3>×”×’×“×¨×•×ª ×¤×•×©</h3>
                    <span class="status-pill status-{{ push_card.status_variant|default('neutral') }}">{{ push_card.status_text }}</span>
                </div>
            </header>
            <ul class="push-stats">
                <li>
                    <span>×× ×•×™×™× ×¤×¢×™×œ×™×</span>
                    <strong>{{ push_card.subscriptions }}</strong>
                </li>
                <li>
                    <span>×ª×–×›×•×¨×•×ª ×‘×”××ª× ×”</span>
                    <strong>{{ push_card.pending_count }}</strong>
                </li>
                <li>
                    <span>×©×œ×™×—×” ××—×¨×•× ×”</span>
                    {% if push_card.last_push %}
                    <strong>{{ push_card.last_push.title }}</strong>
                    <small>{{ push_card.last_push.relative_time }}</small>
                    {% else %}
                    <strong>×œ× × ×©×œ×—×• ×”×ª×¨××•×ª</strong>
                    {% endif %}
                </li>
                <li>
                    <span>×”×ª×–×›×•×¨×ª ×”×‘××”</span>
                    {% if push_card.next_reminder %}
                    <strong>{{ push_card.next_reminder.title }}</strong>
                    <small>{{ push_card.next_reminder.relative_time }}</small>
                    {% else %}
                    <strong>××™×Ÿ ×ª×–××•×Ÿ ×¢×ª×™×“×™</strong>
                    {% endif %}
                </li>
            </ul>
            <a href="{{ push_card.cta_href }}" class="btn btn-secondary btn-icon">
                <i class="fas fa-sliders-h"></i>
                {{ push_card.cta_label }}
            </a>
        </article>

        <article class="activity-card notes-card glass-card" data-card="notes">
            <header class="mini-card-header">
                <div class="card-icon">ğŸ—’ï¸</div>
                <div>
                    <h3>×¤×ª×§×™× ××—×¨×•× ×™×</h3>
                    <p>×”×¤×ª×§×™× ×©×¢×•×“×›× ×• ×œ××—×¨×•× ×” ××• ×××ª×™× ×™× ×œ×ª×–×›×•×¨×ª</p>
                </div>
            </header>
            {% if notes_snapshot.has_notes %}
            <ul class="notes-list">
                {% for note in notes_snapshot.notes %}
                <li>
                    <div class="note-title">{{ note.title }}</div>
                    <div class="note-meta">
                        {{ note.file_name }}
                        <span>Â·</span>
                        <span>{{ note.relative_time }}</span>
                    </div>
                    {% if note.file_url %}
                    <a class="note-link" href="{{ note.file_url }}">×¤×ª×— ×§×•×‘×¥</a>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
            {% if notes_snapshot.total > notes_snapshot.notes|length %}
            <p class="notes-more">×•×¢×•×“ {{ notes_snapshot.total - notes_snapshot.notes|length }} ×¤×ª×§×™× ×××ª×™× ×™×</p>
            {% endif %}
            {% else %}
            <p class="timeline-empty">×¢×•×“ ×œ× ×”×•×¡×¤×ª ×¤×ª×§×™× ×œ×”×¦×’×ª ×”××¦×‘. ×ª×•×›×œ ×œ×”×•×¡×™×£ ×¤×ª×§ ×“×¨×š ×ª×¦×•×’×ª Markdown ×©×œ ×§×•×‘×¥.</p>
            <a class="note-link" href="/files">×¤×ª×— ×§×•×‘×¥ ×—×“×©</a>
            {% endif %}
        </article>
    </div>
</section>

<div class="quick-actions glass-card" style="margin-top: 2rem; text-align: center;">
    <h2 class="section-title">×¤×¢×•×œ×•×ª ××”×™×¨×•×ª</h2>
    <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
        <a href="https://t.me/{{ bot_username }}" target="_blank" class="btn btn-primary btn-icon">
            <i class="fab fa-telegram"></i>
            ×¤×ª×— ××ª ×”×‘×•×˜
        </a>
        <a href="/files" class="btn btn-secondary btn-icon">
            <i class="fas fa-folder"></i>
            ×›×œ ×”×§×‘×¦×™×
        </a>
        <button onclick="refreshStats()" class="btn btn-secondary btn-icon">
            <i class="fas fa-sync"></i>
            ×¨×¢× ×Ÿ × ×ª×•× ×™×
        </button>
    </div>
</div>

<style>
.stat-card {
    text-align: center;
    transition: transform 0.3s;
}

.stat-card:hover {
    transform: translateY(-5px);
}

.language-item,
.file-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    background: rgba(255,255,255,0.05);
    border-radius: 10px;
    margin-bottom: 0.5rem;
    border: 1px solid rgba(255,255,255,0.08);
    transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
}
:root[data-theme="rose-pine-dawn"] .language-item,
:root[data-theme="rose-pine-dawn"] .file-item {
    background: color-mix(in srgb, var(--bg-secondary) 75%, #ffffff 25%);
    border: 1px solid rgba(87,82,121,0.25);
    box-shadow: 0 8px 18px rgba(144,122,169,0.12);
}

.language-item:hover,
.file-item:hover {
    background: rgba(255,255,255,0.1) !important;
}
:root[data-theme="rose-pine-dawn"] .language-item:hover,
:root[data-theme="rose-pine-dawn"] .file-item:hover {
    background: color-mix(in srgb, var(--bg-secondary) 65%, #ffffff 35%) !important;
}

/* === What's New Card === */
.whats-new-card {
    border-right: 3px solid #8b5cf6;
}

.whats-new-card .section-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.whats-new-card .section-title i {
    color: #8b5cf6;
}

.whats-new-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.whats-new-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    background: rgba(139, 92, 246, 0.08);
    border-radius: 10px;
    border: 1px solid rgba(139, 92, 246, 0.15);
    transition: all 0.2s ease;
}

.whats-new-item:hover {
    background: rgba(139, 92, 246, 0.15);
    border-color: rgba(139, 92, 246, 0.25);
}

.feature-content {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    flex: 1;
    min-width: 0;
}

.feature-icon {
    font-size: 1.5rem;
    flex-shrink: 0;
}

.feature-details {
    flex: 1;
    min-width: 0;
}

.feature-title {
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.feature-badge {
    font-size: 0.7rem;
    padding: 0.15rem 0.5rem;
    background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
    color: white;
    border-radius: 999px;
    font-weight: 500;
}

.feature-description {
    font-size: 0.85rem;
    opacity: 0.8;
    margin-top: 0.25rem;
    line-height: 1.4;
}

.feature-time {
    font-size: 0.75rem;
    opacity: 0.6;
    margin-top: 0.35rem;
}

.btn-sm {
    padding: 0.4rem 0.6rem !important;
    font-size: 0.85rem;
}

/* Rose Pine Dawn overrides for What's New */
:root[data-theme="rose-pine-dawn"] .whats-new-card {
    border-right-color: #907aa9;
}

:root[data-theme="rose-pine-dawn"] .whats-new-card .section-title i {
    color: #907aa9;
}

:root[data-theme="rose-pine-dawn"] .whats-new-item {
    background: rgba(144, 122, 169, 0.1);
    border-color: rgba(144, 122, 169, 0.2);
}

:root[data-theme="rose-pine-dawn"] .whats-new-item:hover {
    background: rgba(144, 122, 169, 0.18);
    border-color: rgba(144, 122, 169, 0.3);
}

:root[data-theme="rose-pine-dawn"] .feature-badge {
    background: linear-gradient(135deg, #907aa9 0%, #b4a7c7 100%);
}

@media (max-width: 768px) {
    .dashboard-grid {
        grid-template-columns: 1fr !important;
    }
}

/* === Last Commit Card (Admin Only) === */
.last-commit-card {
    border-right: 3px solid #10b981;
}

.commit-header {
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.commit-sha code {
    background: rgba(16, 185, 129, 0.2);
    padding: 0.25rem 0.5rem;
    border-radius: 6px;
    font-family: monospace;
    font-size: 0.9rem;
    color: #10b981;
}

.commit-message {
    font-weight: 600;
    margin: 0.75rem 0 0.5rem;
    line-height: 1.4;
}

.commit-meta {
    display: flex;
    gap: 1.5rem;
    font-size: 0.85rem;
    opacity: 0.75;
}

.commit-meta i {
    margin-left: 0.25rem;
}

.changed-files-list {
    margin-top: 1rem;
}

.files-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
    font-weight: 500;
}

.changed-file-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0.75rem;
    background: rgba(255,255,255,0.03);
    border-radius: 8px;
    margin-bottom: 0.35rem;
    border-right: 3px solid transparent;
    text-decoration: none;
    color: inherit;
}

.changed-file-item:hover {
    background: rgba(255,255,255,0.08);
}

.changed-file-item.status-added {
    border-right-color: #10b981;
}

.changed-file-item.status-modified {
    border-right-color: #f59e0b;
}

.changed-file-item.status-deleted {
    border-right-color: #ef4444;
    opacity: 0.7;
}

.changed-file-item.status-renamed {
    border-right-color: #8b5cf6;
}

.changed-file-item.status-copied {
    border-right-color: #3b82f6;
}

.file-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    overflow: hidden;
}

.file-icon {
    font-size: 1.1rem;
}

.file-name {
    font-family: monospace;
    font-size: 0.85rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 200px;
}

.status-icon {
    font-size: 0.9rem;
}

.more-files {
    text-align: center;
    padding: 0.5rem;
    opacity: 0.7;
    font-size: 0.85rem;
}

.load-more-commit-files {
    width: 100%;
    justify-content: center;
    gap: 0.5rem;
    opacity: 1;
}

.commit-actions {
    margin-top: 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.sync-time {
    opacity: 0.6;
    font-size: 0.8rem;
}

.no-changes {
    opacity: 0.7;
    text-align: center;
    padding: 1rem;
}

/* Rose Pine Dawn overrides */
:root[data-theme="rose-pine-dawn"] .commit-sha code {
    background: rgba(86, 148, 159, 0.15);
    color: #286983;
}

:root[data-theme="rose-pine-dawn"] .last-commit-card {
    border-right-color: #56949f;
}

:root[data-theme="rose-pine-dawn"] .changed-file-item {
    background: rgba(255,255,255,0.4);
}

:root[data-theme="rose-pine-dawn"] .changed-file-item.status-added {
    border-right-color: #56949f;
}

:root[data-theme="rose-pine-dawn"] .changed-file-item.status-modified {
    border-right-color: #ea9d34;
}

:root[data-theme="rose-pine-dawn"] .changed-file-item.status-deleted {
    border-right-color: #b4637a;
}

:root[data-theme="rose-pine-dawn"] .changed-file-item.status-renamed {
    border-right-color: #907aa9;
}

.activity-section {
    margin-top: 2rem;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.activity-header {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    gap: 1rem;
    align-items: flex-start;
}

.activity-subtitle {
    margin: 0.35rem 0 0;
    opacity: 0.75;
    font-size: 0.95rem;
}

.activity-cards {
    display: flex;
    gap: 1rem;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    padding-bottom: 0.5rem;
}

.activity-card {
    min-width: calc(100% - 1.5rem);
    scroll-snap-align: start;
}

.timeline-card-header {
    display: flex;
    justify-content: space-between;
    gap: 1rem;
    align-items: flex-start;
}

.timeline-feed,
.timeline-groups {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.timeline-groups {
    display: none;
}

.timeline-card[data-expanded="true"] .timeline-groups {
    display: flex;
}

.timeline-card[data-expanded="true"] .timeline-feed {
    display: none;
}

.timeline-item {
    position: relative;
    padding: 1rem 2.2rem 1rem 1rem;
    border-radius: 14px;
    background: rgba(255,255,255,0.02);
    border-right: 3px solid rgba(255,255,255,0.08);
}

.timeline-marker {
    position: absolute;
    top: 1.1rem;
    right: 0.4rem;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #c084fc;
    box-shadow: 0 0 0 4px rgba(192,132,252,0.2);
}

.timeline-item[data-accent="timeline-accent-push"] .timeline-marker {
    background: #fb923c;
    box-shadow: 0 0 0 4px rgba(251,146,60,0.2);
}

.timeline-item-header {
    display: flex;
    gap: 0.75rem;
    align-items: flex-start;
    justify-content: space-between;
}

.timeline-icon {
    font-size: 1.25rem;
}

.timeline-texts {
    flex: 1;
    text-align: right;
}

.timeline-title,
.timeline-subtitle,
.note-title,
.note-meta,
.timeline-link {
    word-break: break-word;
    overflow-wrap: anywhere;
}

.timeline-title {
    font-weight: 600;
}

.timeline-subtitle {
    font-size: 0.9rem;
    opacity: 0.75;
}

.timeline-time {
    white-space: nowrap;
    font-size: 0.85rem;
    opacity: 0.65;
}

.timeline-item-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 0.75rem;
    gap: 1rem;
}

.timeline-badge {
    border-radius: 999px;
    padding: 0.15rem 0.9rem;
    font-size: 0.8rem;
    background: rgba(255,255,255,0.12);
}

.timeline-badge-code {
    background: rgba(168,85,247,0.2);
    color: #f3e8ff;
}

.timeline-badge-info {
    background: rgba(59,130,246,0.2);
    color: #dbeafe;
}

.timeline-badge-warning {
    background: rgba(251,191,36,0.2);
    color: #fef9c3;
}

.timeline-badge-neutral {
    background: rgba(148,163,184,0.2);
    color: #e2e8f0;
}

.timeline-link {
    color: #a5b4fc;
    font-weight: 600;
    font-size: 0.85rem;
}

.timeline-empty {
    opacity: 0.7;
    text-align: center;
}

.timeline-expand {
    width: 100%;
    margin-top: 1rem;
    background: rgba(255,255,255,0.05);
    border: none;
    color: inherit;
    border-radius: 10px;
    padding: 0.75rem 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.timeline-load-more-wrap {
    margin-top: 0.5rem;
    display: flex;
}

.timeline-load-more-files {
    width: 100%;
    justify-content: center;
    gap: 0.5rem;
}

.timeline-group {
    border-radius: 14px;
    background: rgba(255,255,255,0.02);
}

.group-toggle {
    width: 100%;
    border: none;
    background: transparent;
    color: inherit;
    padding: 1rem 1.25rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
}

.group-info {
    display: flex;
    gap: 0.75rem;
    align-items: center;
}

.group-items {
    display: none;
    flex-direction: column;
    gap: 1rem;
    padding: 0 1.25rem 1.25rem;
}

.timeline-group.is-open .group-items {
    display: flex;
}

.timeline-item.is-hidden-by-filter,
.timeline-group.is-hidden-by-filter {
    display: none !important;
}

.mobile-only {
    display: block;
}

.desktop-only {
    display: none;
}

.timeline-filter-btn {
    background: rgba(255,255,255,0.05);
    border: 1px solid transparent;
    color: inherit;
    border-radius: 999px;
    padding: 0.45rem 0.9rem;
    display: flex;
    gap: 0.4rem;
    align-items: center;
}

.timeline-filter-btn.is-active {
    border-color: rgba(167,139,250,0.4);
    background: rgba(129,140,248,0.15);
}

.filter-count {
    font-size: 0.85rem;
    opacity: 0.8;
}

.mini-card-header {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    margin-bottom: 1rem;
}

.card-icon {
    width: 44px;
    height: 44px;
    border-radius: 12px;
    display: grid;
    place-items: center;
    font-size: 1.4rem;
    background: rgba(255,255,255,0.08);
}

.status-pill {
    display: inline-flex;
    padding: 0.1rem 0.75rem;
    border-radius: 999px;
    font-size: 0.8rem;
}

.status-success {
    background: rgba(34,197,94,0.2);
    color: #bbf7d0;
}

.status-warning {
    background: rgba(251,191,36,0.2);
    color: #fef3c7;
}

.status-danger {
    background: rgba(248,113,113,0.2);
    color: #fecaca;
}

.status-neutral {
    background: rgba(148,163,184,0.2);
    color: #e2e8f0;
}

.push-stats {
    list-style: none;
    padding: 0;
    margin: 0 0 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.push-stats li {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 0.5rem;
}

.push-stats strong {
    font-size: 1rem;
}

.notes-list {
    list-style: none;
    padding: 0;
    margin: 0 0 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.85rem;
}

.note-title {
    font-weight: 600;
}

.note-meta {
    font-size: 0.85rem;
    opacity: 0.75;
}

.note-link {
    font-size: 0.85rem;
    color: #a5b4fc;
}

.notes-more {
    font-size: 0.85rem;
    opacity: 0.75;
}

@media (max-width: 700px) {
    .activity-cards {
        flex-direction: column;
        overflow: visible;
        scroll-snap-type: none;
    }

    .activity-card {
        min-width: 100%;
    }
}

@media (min-width: 900px) {
    .activity-cards {
        display: grid;
        grid-template-columns: minmax(0, 2fr) minmax(0, 1fr);
        grid-template-rows: auto auto;
        overflow: visible;
    }

    .activity-card {
        min-width: 0;
        scroll-snap-align: unset;
    }

    .timeline-card {
        grid-row: span 2;
    }

    .timeline-card .timeline-feed,
    .timeline-expand {
        display: none !important;
    }

    .timeline-card .timeline-groups {
        display: flex !important;
    }

    .mobile-only {
        display: none !important;
    }

    .desktop-only {
        display: flex !important;
        gap: 0.5rem;
    }
}

/* Rose Pine Dawn Overrides for Dashboard Visibility */
:root[data-theme="rose-pine-dawn"] .timeline-badge-code {
    background: rgba(144, 122, 169, 0.15);
    color: #575279;
}
:root[data-theme="rose-pine-dawn"] .timeline-badge-info {
    background: rgba(86, 148, 159, 0.15);
    color: #286983;
}
:root[data-theme="rose-pine-dawn"] .timeline-badge-warning {
    background: rgba(234, 157, 52, 0.15);
    color: #907aa9;
}
:root[data-theme="rose-pine-dawn"] .timeline-badge-neutral {
    background: rgba(242, 233, 225, 0.6);
    color: #797593;
}

:root[data-theme="rose-pine-dawn"] .status-success {
    background: rgba(86, 148, 159, 0.2);
    color: #286983;
}
:root[data-theme="rose-pine-dawn"] .status-warning {
    background: rgba(234, 157, 52, 0.2);
    color: #b4637a;
}
:root[data-theme="rose-pine-dawn"] .status-danger {
    background: rgba(180, 99, 122, 0.2);
    color: #b4637a;
}
:root[data-theme="rose-pine-dawn"] .status-neutral {
    background: rgba(242, 233, 225, 0.6);
    color: #575279;
}

:root[data-theme="rose-pine-dawn"] .timeline-link,
:root[data-theme="rose-pine-dawn"] .note-link {
    color: var(--primary);
}

:root[data-theme="rose-pine-dawn"] .timeline-item {
    background: rgba(255, 255, 255, 0.5);
    border-right-color: rgba(144, 122, 169, 0.15);
}
</style>

<script>
function refreshStats() {
    const btn = event.target;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ××¨×¢× ×Ÿ...';
    btn.disabled = true;
    
    fetch('/api/stats')
        .then(response => response.json())
        .then(data => {
            // ×‘×¢×ª×™×“: ×¢×“×›×•×Ÿ ×”× ×ª×•× ×™× ×‘×“×£
            location.reload();
        })
        .catch(error => {
            console.error('Error:', error);
            btn.innerHTML = '<i class="fas fa-sync"></i> ×¨×¢× ×Ÿ × ×ª×•× ×™×';
            btn.disabled = false;
        });
}

document.addEventListener('DOMContentLoaded', () => {
    const timelineCard = document.querySelector('[data-card="timeline"]');
    const activityWrapper = document.querySelector('[data-activity-cards]');
    if (!timelineCard || !activityWrapper) {
        return;
    }

    const filterButtons = activityWrapper.querySelectorAll('.timeline-filter-btn[data-filter]');
    const timelineEvents = timelineCard.querySelectorAll('[data-timeline-event]');

    const applyFilter = (filter) => {
        timelineCard.querySelectorAll('.timeline-group').forEach(group => {
            const groupId = group.getAttribute('data-group');
            const hide = filter !== 'all' && filter !== groupId;
            group.classList.toggle('is-hidden-by-filter', hide);
        });
        timelineEvents.forEach(eventEl => {
            const groupId = eventEl.getAttribute('data-group');
            const hide = filter !== 'all' && filter !== groupId;
            eventEl.classList.toggle('is-hidden-by-filter', hide);
        });
        activityWrapper.setAttribute('data-active-filter', filter);
    };

    filterButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            filterButtons.forEach(other => other.classList.toggle('is-active', other === btn));
            applyFilter(btn.getAttribute('data-filter') || 'all');
        });
    });

    const expandBtn = timelineCard.querySelector('[data-timeline-expand]');
    if (expandBtn) {
        expandBtn.addEventListener('click', () => {
            timelineCard.dataset.manualExpand = 'true';
            timelineCard.setAttribute('data-expanded', 'true');
            timelineCard.querySelectorAll('.timeline-group').forEach(group => group.classList.add('is-open'));
            expandBtn.style.display = 'none';
        });
    }

    timelineCard.querySelectorAll('[data-group-toggle]').forEach(toggle => {
        toggle.addEventListener('click', () => {
            const parent = toggle.closest('.timeline-group');
            if (parent) {
                parent.classList.toggle('is-open');
            }
        });
    });

    const mq = window.matchMedia('(min-width: 900px)');
    const syncDesktop = () => {
        if (mq.matches) {
            timelineCard.setAttribute('data-expanded', 'true');
            timelineCard.querySelectorAll('.timeline-group').forEach(group => group.classList.add('is-open'));
        } else if (!timelineCard.dataset.manualExpand) {
            timelineCard.setAttribute('data-expanded', 'false');
            timelineCard.querySelectorAll('.timeline-group').forEach(group => group.classList.remove('is-open'));
        }
    };
    try {
        mq.addEventListener('change', syncDesktop);
    } catch (err) {
        mq.addListener(syncDesktop);
    }
    syncDesktop();
});

document.addEventListener('DOMContentLoaded', () => {
    const btn = document.querySelector('.load-more-commit-files[data-sha]');
    const list = document.querySelector('[data-last-commit-files]');
    if (!btn || !list) return;

    const appendFileRow = (file) => {
        const path = (file && file.path ? String(file.path) : '').trim();
        if (!path) return;

        const a = document.createElement('a');
        a.className = `changed-file-item status-${file.status || 'unknown'}`;
        a.href = `/repo/?file=${encodeURIComponent(path)}`;
        a.title = path;

        const info = document.createElement('div');
        info.className = 'file-info';

        const fileIcon = document.createElement('span');
        fileIcon.className = 'file-icon';
        fileIcon.textContent = String(file.file_icon || 'ğŸ“„');

        const name = document.createElement('span');
        name.className = 'file-name';
        name.title = path;
        name.textContent = String(file.name || path.split('/').pop() || path);

        info.appendChild(fileIcon);
        info.appendChild(name);

        const statusWrap = document.createElement('div');
        statusWrap.className = 'file-status';

        const statusIcon = document.createElement('span');
        statusIcon.className = 'status-icon';
        statusIcon.title = String(file.status_label || '');
        statusIcon.textContent = String(file.status_icon || 'â“');

        statusWrap.appendChild(statusIcon);

        a.appendChild(info);
        a.appendChild(statusWrap);

        const moreEl = list.querySelector('.more-files');
        if (moreEl && moreEl.parentNode === list) {
            list.insertBefore(a, moreEl);
        } else {
            list.appendChild(a);
        }
    };

    const setButtonLabel = (remaining) => {
        const rem = Math.max(0, parseInt(remaining || '0', 10) || 0);
        if (rem <= 0) {
            btn.remove();
            return;
        }
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-plus"></i> ' + `×˜×¢×Ÿ ×¢×•×“ ${rem} ×§×‘×¦×™×`;
    };

    btn.addEventListener('click', async () => {
        const sha = (btn.dataset.sha || '').trim();
        const offset = parseInt(btn.dataset.offset || '0', 10) || 0;
        const limit = 50;

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ×˜×•×¢×Ÿ...';

        try {
            const qs = new URLSearchParams({
                sha,
                offset: String(offset),
                limit: String(limit),
            });
            const resp = await fetch(`/api/dashboard/last-commit-files?${qs.toString()}`, {
                headers: { 'Accept': 'application/json' },
            });
            const data = await resp.json();
            if (!resp.ok || !data || data.ok !== true) {
                throw new Error((data && data.error) ? String(data.error) : 'load_failed');
            }

            const files = Array.isArray(data.files) ? data.files : [];
            files.forEach(appendFileRow);

            const newOffset = offset + files.length;
            btn.dataset.offset = String(newOffset);

            const total = parseInt(data.total_files || btn.dataset.total || '0', 10) || 0;
            const remaining = Math.max(0, total - newOffset);
            setButtonLabel(remaining);
        } catch (e) {
            console.error('Failed to load more commit files:', e);
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> × ×¡×” ×©×•×‘';
        }
    });
});

document.addEventListener('DOMContentLoaded', () => {
    const loadMoreButtons = document.querySelectorAll('.timeline-load-more-files[data-offset]');
    if (!loadMoreButtons.length) return;

    const createTimelineItem = (event) => {
        const article = document.createElement('article');
        article.className = 'timeline-item';
        article.setAttribute('data-timeline-event', '');
        article.setAttribute('data-group', 'files');
        if (event && event.accent) {
            article.setAttribute('data-accent', String(event.accent));
        }

        const marker = document.createElement('div');
        marker.className = 'timeline-marker';

        const body = document.createElement('div');
        body.className = 'timeline-item-body';

        const header = document.createElement('div');
        header.className = 'timeline-item-header';

        const icon = document.createElement('div');
        icon.className = 'timeline-icon';
        icon.textContent = String(event.icon || 'ğŸ“');

        const texts = document.createElement('div');
        texts.className = 'timeline-texts';

        const title = document.createElement('div');
        title.className = 'timeline-title';
        title.textContent = String(event.title || '');

        const subtitle = document.createElement('div');
        subtitle.className = 'timeline-subtitle';
        subtitle.textContent = String(event.subtitle || '');

        texts.appendChild(title);
        texts.appendChild(subtitle);

        const time = document.createElement('div');
        time.className = 'timeline-time';
        time.textContent = String(event.relative_time || '');

        header.appendChild(icon);
        header.appendChild(texts);
        header.appendChild(time);

        const footer = document.createElement('div');
        footer.className = 'timeline-item-footer';

        if (event.badge) {
            const badge = document.createElement('span');
            const variant = String(event.badge_variant || 'neutral');
            badge.className = `timeline-badge timeline-badge-${variant}`;
            badge.textContent = String(event.badge);
            footer.appendChild(badge);
        }

        if (event.href) {
            const a = document.createElement('a');
            a.className = 'timeline-link';
            a.href = String(event.href);
            a.textContent = '×¤×ª×—';
            footer.appendChild(a);
        }

        body.appendChild(header);
        body.appendChild(footer);
        article.appendChild(marker);
        article.appendChild(body);
        return article;
    };

    const updateButtonLabel = (btn, remaining) => {
        const rem = Math.max(0, parseInt(remaining || '0', 10) || 0);
        if (rem <= 0) {
            btn.closest('.timeline-load-more-wrap')?.remove();
            return;
        }
        const toLoad = Math.min(12, rem);
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-plus"></i> ' + `×˜×¢×Ÿ ×¢×•×“ ${toLoad} ×§×‘×¦×™×`;
    };

    loadMoreButtons.forEach((btn) => {
        btn.addEventListener('click', async () => {
            const offset = parseInt(btn.dataset.offset || '0', 10) || 0;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ×˜×•×¢×Ÿ...';

            try {
                const qs = new URLSearchParams({
                    offset: String(offset),
                    limit: '12',
                });
                const resp = await fetch(`/api/dashboard/activity/files?${qs.toString()}`, {
                    headers: { 'Accept': 'application/json' },
                });
                const data = await resp.json();
                if (!resp.ok || !data || data.ok !== true) {
                    throw new Error((data && data.error) ? String(data.error) : 'load_failed');
                }

                const events = Array.isArray(data.events) ? data.events : [];
                const group = btn.closest('.timeline-group[data-group="files"]');
                const groupItems = group ? group.querySelector('.group-items') : null;
                const wrap = btn.closest('.timeline-load-more-wrap');
                if (groupItems) {
                    events.forEach((ev) => {
                        const item = createTimelineItem(ev);
                        if (wrap && wrap.parentNode === groupItems) {
                            groupItems.insertBefore(item, wrap);
                        } else {
                            groupItems.appendChild(item);
                        }
                    });
                }

                btn.dataset.offset = String(data.next_offset || (offset + events.length));
                updateButtonLabel(btn, data.remaining);
            } catch (e) {
                console.error('Failed to load more file activity:', e);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> × ×¡×” ×©×•×‘';
            }
        });
    });
});
</script>
{% endblock %}