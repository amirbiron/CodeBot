{% extends "base.html" %}

{% block title %}דשבורד קאש - Code Keeper Bot{% endblock %}

{% block content %}
<h1 class="page-title">
  <i class="fas fa-database"></i>
  דשבורד ביצועי Cache
</h1>

<div class="glass-card" id="statusCard" style="display:none;"></div>

<div class="glass-card">
  <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:1rem;">
    <div class="stat-card" style="background: rgba(255,255,255,0.06); border-radius:12px; padding:1rem;">
      <div style="opacity:.8; font-size:.9rem;">Hit Rate</div>
      <div id="hitRateVal" style="font-size:1.8rem; font-weight:700;">—%</div>
      <div style="opacity:.7; font-size:.85rem;">יעד: ≥ 80%</div>
    </div>
    <div class="stat-card" style="background: rgba(255,255,255,0.06); border-radius:12px; padding:1rem;">
      <div style="opacity:.8; font-size:.9rem;">Hits</div>
      <div id="hitsVal" style="font-size:1.8rem; font-weight:700;">—</div>
    </div>
    <div class="stat-card" style="background: rgba(255,255,255,0.06); border-radius:12px; padding:1rem;">
      <div style="opacity:.8; font-size:.9rem;">Misses</div>
      <div id="missesVal" style="font-size:1.8rem; font-weight:700;">—</div>
    </div>
    <div class="stat-card" style="background: rgba(255,255,255,0.06); border-radius:12px; padding:1rem;">
      <div style="opacity:.8; font-size:.9rem;">Avg Latency</div>
      <div id="latencyVal" style="font-size:1.8rem; font-weight:700;">— ms</div>
    </div>
    <div class="stat-card" style="background: rgba(255,255,255,0.06); border-radius:12px; padding:1rem;">
      <div style="opacity:.8; font-size:.9rem;">Used Memory</div>
      <div id="memVal" style="font-size:1.8rem; font-weight:700;">—</div>
    </div>
  </div>
</div>

<div class="glass-card">
  <h2 class="section-title"><i class="fas fa-chart-line"></i> Hit Rate – 5 דקות אחרונות</h2>
  <canvas id="hitRateChart" height="120"></canvas>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function(){
  const STATUS_OK = 'ok';
  const MAX_POINTS = 60; // 5 דקות @ 5s
  const POLL_MS = 5000;

  const statusCard = document.getElementById('statusCard');
  const elHitRate = document.getElementById('hitRateVal');
  const elHits = document.getElementById('hitsVal');
  const elMisses = document.getElementById('missesVal');
  const elLatency = document.getElementById('latencyVal');
  const elMem = document.getElementById('memVal');

  const ctx = document.getElementById('hitRateChart').getContext('2d');
  const chartData = { labels: [], datasets: [{
      label: 'Hit Rate %', data: [], tension: 0.2,
      borderColor: 'rgba(72, 187, 120, 1)', backgroundColor: 'rgba(72, 187, 120, 0.15)', fill: true, pointRadius: 0
  }]};
  const chart = new Chart(ctx, { type: 'line', data: chartData, options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { min: 0, max: 100, ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.15)' } },
        x: { ticks: { color: '#fff' }, grid: { display: false } }
      }
  }});

  function colorForHitRate(v){
    if (v === null || v === undefined) return '#fff';
    if (v >= 80) return getComputedStyle(document.documentElement).getPropertyValue('--success') || '#48bb78';
    if (v >= 50) return getComputedStyle(document.documentElement).getPropertyValue('--warning') || '#ed8936';
    return getComputedStyle(document.documentElement).getPropertyValue('--danger') || '#f56565';
  }

  function updateCards(data){
    try {
      const status = (data && data.status) || 'disabled';
      const m = (data && data.metrics) || {};
      const enabled = !!data.enabled;

      // הודעת סטטוס
      if (!enabled) {
        statusCard.style.display = 'block';
        statusCard.className = 'glass-card alert-info';
        statusCard.innerHTML = '<strong>Redis כבוי:</strong> מציג ערכים 0 בלבד. ניתן להמשיך לעבוד כרגיל.';
      } else {
        statusCard.style.display = 'none';
        statusCard.innerHTML = '';
      }

      const hr = Number(m.hit_rate || 0);
      elHitRate.textContent = hr.toFixed(2) + '%';
      elHitRate.style.color = colorForHitRate(hr);
      elHits.textContent = String(m.hits || 0);
      elMisses.textContent = String(m.misses || 0);
      elLatency.textContent = (Number(m.avg_latency_ms || 0)).toFixed(2) + ' ms';
      elMem.textContent = String(m.used_memory || '0');
    } catch (e) {}
  }

  function pushChartPoint(hitRate){
    try {
      const ts = new Date();
      const label = ts.toLocaleTimeString([], { hour12: false, minute: '2-digit', second: '2-digit' });
      chartData.labels.push(label);
      chartData.datasets[0].data.push(Number(hitRate || 0));
      if (chartData.labels.length > MAX_POINTS) {
        chartData.labels.shift();
        chartData.datasets[0].data.shift();
      }
      chart.update('none');
    } catch (e) {}
  }

  async function poll(){
    try {
      const res = await fetch('/api/cache/metrics', { headers: { 'Accept': 'application/json' }});
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();
      updateCards(data);
      const hr = (data && data.metrics && data.metrics.hit_rate) || 0;
      pushChartPoint(hr);
    } catch (e) {
      // לא משתיק את ה-UI; נסה שוב בפול הבא
    } finally {
      setTimeout(poll, POLL_MS);
    }
  }

  // התחלה מידית + נקודת התחלה על הגרף
  (async function init(){
    try { await poll(); } catch (e) { setTimeout(poll, POLL_MS); }
  })();
})();
</script>
{% endblock %}
