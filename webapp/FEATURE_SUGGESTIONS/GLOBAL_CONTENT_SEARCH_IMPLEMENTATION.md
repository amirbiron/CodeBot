# ××“×¨×™×š ××™××•×©: ×—×™×¤×•×© ×’×œ×•×‘×œ×™ ×‘×ª×•×›×Ÿ ×§×‘×¦×™×

## ×ª×™××•×¨ ×”×¤×™×¦'×¨
×”×•×¡×¤×ª ×™×›×•×œ×ª ×—×™×¤×•×© ×’×œ×•×‘×œ×™ ×‘×ª×•×›×Ÿ ×›×œ ×”×§×‘×¦×™× ×©×œ ×”××©×ª××©, ×‘× ×•×¡×£ ×œ×—×™×¤×•×© ×”×§×™×™× ×‘×§×•×‘×¥ ×‘×•×“×“. 
×”×¤×™×¦'×¨ ×××¤×©×¨ ×œ××¦×•× ×‘××”×™×¨×•×ª ×§×˜×¢×™ ×§×•×“, ×˜×§×¡×˜ ××• ×“×¤×•×¡×™× ×‘×›×œ ×”×§×‘×¦×™× ×”×©××•×¨×™×.

## ×¡×˜×˜×•×¡ × ×•×›×—×™
- âœ… ×§×™×™××ª ×ª×©×ª×™×ª ××œ××” ×©×œ ×× ×•×¢ ×—×™×¤×•×© ×‘-`/workspace/search_engine.py`
- âœ… ×”×× ×•×¢ ×›×•×œ×œ ×¤×•× ×§×¦×™×” `_content_search` ×œ×—×™×¤×•×© ×‘×ª×•×›×Ÿ
- âœ… ×§×™×™× ××™× ×“×§×¡ ××•×˜×•××˜×™ ×œ×‘×™×¦×•×¢×™× ×˜×•×‘×™×
- â³ ×—×¡×¨: endpoint ×‘-webapp ×•×××©×§ ××©×ª××©

## ××¨×›×™×˜×§×˜×•×¨×”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      ×××©×§ ××©×ª××© (UI)        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ ×ª×™×‘×ª ×—×™×¤×•×© ×’×œ×•×‘×œ×™ â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    API Endpoint             â”‚
â”‚  /api/search/global         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Search Engine            â”‚
â”‚  search_engine.search()     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  SearchIndex      â”‚       â”‚
â”‚  â”‚  - word_index     â”‚       â”‚
â”‚  â”‚  - function_index â”‚       â”‚
â”‚  â”‚  - language_index â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Database             â”‚
â”‚    get_user_files()         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ×©×œ×‘×™ ××™××•×©

### ×©×œ×‘ 1: ×”×•×¡×¤×ª Dependencies ×•Imports

**×§×•×‘×¥:** `webapp/requirements.txt`

**×”×•×¡×¤×ª ×ª×œ×•×™×•×ª × ×•×¡×¤×•×ª:**
```txt
flask-limiter==3.5.0  # Rate limiting
tenacity==8.2.3  # Retry logic
prometheus-client==0.19.0  # Metrics
sentry-sdk[flask]==1.39.1  # Error monitoring (××•×¤×¦×™×•× ×œ×™)
```

**×§×•×‘×¥:** `webapp/app.py`

**Imports ×‘×¨××© ×”×§×•×‘×¥:**
```python
from search_engine import search_engine, SearchType, SearchFilter, SortOrder
from flask_limiter import Limiter
from flask_limiter.util import get_remote_address
from tenacity import retry, stop_after_attempt, wait_exponential
from prometheus_client import Counter, Histogram, Gauge, generate_latest
import time
import hashlib

# Optional: Sentry integration
try:
    import sentry_sdk
    from sentry_sdk.integrations.flask import FlaskIntegration
    SENTRY_ENABLED = True
except ImportError:
    SENTRY_ENABLED = False
```

### ×©×œ×‘ 2: ×”×’×“×¨×ª Rate Limiting ×•-Metrics

**×§×•×‘×¥:** `webapp/app.py`

**××—×¨×™ ×™×¦×™×¨×ª ×”-app instance:**
```python
# Rate Limiting Configuration
limiter = Limiter(
    app=app,
    key_func=lambda: session.get('user_id') if 'user_id' in session else get_remote_address(),
    default_limits=["200 per day", "50 per hour"],
    storage_uri="memory://",
)

# Prometheus Metrics
search_counter = Counter('search_requests_total', 'Total number of search requests', ['search_type', 'status'])
search_duration = Histogram('search_duration_seconds', 'Search request duration in seconds')
search_results_count = Histogram('search_results_count', 'Number of results returned')
cache_hits = Counter('search_cache_hits_total', 'Total number of cache hits')
cache_misses = Counter('search_cache_misses_total', 'Total number of cache misses')
active_indexes = Gauge('search_active_indexes', 'Number of active search indexes')

# Optional: Sentry Configuration
if SENTRY_ENABLED and config.SENTRY_DSN:
    sentry_sdk.init(
        dsn=config.SENTRY_DSN,
        integrations=[FlaskIntegration()],
        traces_sample_rate=0.1,
        environment=config.ENVIRONMENT
    )
```

### ×©×œ×‘ 3: ××™××•×© API Endpoint ××ª×§×“×

**×§×•×‘×¥:** `webapp/app.py`

**××™×§×•×:** ××—×¨×™ ×©××¨ ×”-API endpoints

```python
# Helper function for safe search with retry logic
@retry(
    stop=stop_after_attempt(3),
    wait=wait_exponential(multiplier=1, min=1, max=10),
    retry_error_callback=lambda retry_state: logger.warning(f"Search retry attempt {retry_state.attempt_number}")
)
def safe_search(user_id, query, **kwargs):
    """×‘×™×¦×•×¢ ×—×™×¤×•×© ×¢× retry logic ×•-circuit breaker"""
    return search_engine.search(user_id, query, **kwargs)

@app.route('/api/search/global', methods=['POST'])
@login_required
@limiter.limit("30 per minute")  # ×”×’×‘×œ×” ×¡×¤×¦×™×¤×™×ª ×œ×—×™×¤×•×©
def global_content_search():
    """×—×™×¤×•×© ×’×œ×•×‘×œ×™ ×‘×ª×•×›×Ÿ ×›×œ ×”×§×‘×¦×™× ×¢× monitoring ×•-error handling ××ª×§×“×"""
    
    start_time = time.time()
    user_id = session['user_id']
    
    try:
        data = request.get_json()
        
        # Dynamic rate limiting based on query length
        query = data.get('query', '').strip()
        if len(query) > 100:
            # ×”×’×‘×œ×” ××—××™×¨×” ×™×•×ª×¨ ×œ×©××™×œ×ª×•×ª ××¨×•×›×•×ª
            limiter.limit("5 per minute")(lambda: None)()
        
        # Validation
        if not query:
            search_counter.labels(search_type='invalid', status='error').inc()
            return jsonify({'error': '× × ×œ×”×–×™×Ÿ ×˜×§×¡×˜ ×œ×—×™×¤×•×©'}), 400
        
        if len(query) > 500:
            search_counter.labels(search_type='invalid', status='error').inc()
            return jsonify({'error': '×”×©××™×œ×ª×” ××¨×•×›×” ××“×™ (××§×¡×™××•× 500 ×ª×•×•×™×)'}), 400
        
        # Parameters
        search_type_str = data.get('search_type', 'content')
        search_types = {
            'content': SearchType.CONTENT,
            'regex': SearchType.REGEX,
            'fuzzy': SearchType.FUZZY,
            'function': SearchType.FUNCTION,
            'text': SearchType.TEXT
        }
        search_type = search_types.get(search_type_str, SearchType.CONTENT)
        
        # Check cache first
        cache_key = hashlib.md5(
            f"{user_id}:{query}:{search_type_str}:{data.get('filters', {})}:{data.get('sort', 'relevance')}".encode()
        ).hexdigest()
        
        cached_results = get_cached_search(user_id, cache_key)
        if cached_results:
            cache_hits.inc()
            search_counter.labels(search_type=search_type_str, status='cache_hit').inc()
            logger.info(f"Cache hit for user {user_id}, query: {query[:50]}")
            return jsonify(cached_results)
        
        cache_misses.inc()
        
        # Filters
        filter_data = data.get('filters', {})
        filters = SearchFilter(
            languages=filter_data.get('languages', []),
            tags=filter_data.get('tags', []),
            date_from=filter_data.get('date_from'),
            date_to=filter_data.get('date_to'),
            min_size=filter_data.get('min_size'),
            max_size=filter_data.get('max_size'),
            has_functions=filter_data.get('has_functions'),
            has_classes=filter_data.get('has_classes'),
            file_pattern=filter_data.get('file_pattern')
        )
        
        # Validate regex pattern if regex search
        if search_type == SearchType.REGEX:
            try:
                import re
                re.compile(query)
            except re.error as e:
                search_counter.labels(search_type='regex', status='invalid_pattern').inc()
                return jsonify({'error': f'×‘×™×˜×•×™ ×¨×’×•×œ×¨×™ ×œ× ×ª×§×™×Ÿ: {str(e)}'}), 400
        
        # Sorting
        sort_str = data.get('sort', 'relevance')
        sort_orders = {
            'relevance': SortOrder.RELEVANCE,
            'date_desc': SortOrder.DATE_DESC,
            'date_asc': SortOrder.DATE_ASC,
            'name_asc': SortOrder.NAME_ASC,
            'name_desc': SortOrder.NAME_DESC,
            'size_desc': SortOrder.SIZE_DESC,
            'size_asc': SortOrder.SIZE_ASC
        }
        sort_order = sort_orders.get(sort_str, SortOrder.RELEVANCE)
        
        # Pagination
        page = max(1, data.get('page', 1))
        limit = min(100, data.get('limit', 50))
        
        # Execute search with retry logic
        try:
            results = safe_search(
                user_id=user_id,
                query=query,
                search_type=search_type,
                filters=filters,
                sort_order=sort_order,
                limit=min(1000, limit * page)  # Cap total results
            )
        except Exception as search_error:
            # Log to Sentry if available
            if SENTRY_ENABLED:
                with sentry_sdk.push_scope() as scope:
                    scope.set_user({"id": user_id})
                    scope.set_context("search", {
                        "query": query,
                        "type": search_type_str,
                        "filters": filter_data
                    })
                    sentry_sdk.capture_exception(search_error)
            
            search_counter.labels(search_type=search_type_str, status='error').inc()
            logger.error(f"Search failed for user {user_id}: {search_error}")
            raise
        
        # Update metrics
        search_results_count.observe(len(results))
        active_indexes.set(len(search_engine.indexes))
        
        # Paginate results
        start_idx = (page - 1) * limit
        end_idx = start_idx + limit
        paginated_results = results[start_idx:end_idx]
        
        # Convert to JSON
        response_data = {
            'success': True,
            'query': query,
            'total_results': len(results),
            'page': page,
            'per_page': limit,
            'search_time': round(time.time() - start_time, 3),
            'cached': False,
            'results': [
                {
                    'file_id': hashlib.md5(f"{user_id}:{r.file_name}".encode()).hexdigest(),
                    'file_name': r.file_name,
                    'language': r.programming_language,
                    'tags': r.tags,
                    'score': round(r.relevance_score, 2),
                    'snippet': r.snippet_preview[:200] if r.snippet_preview else '',
                    'highlights': r.highlight_ranges,
                    'matches': r.matches[:5] if r.matches else [],
                    'updated_at': r.updated_at.isoformat(),
                    'size': len(r.content)
                }
                for r in paginated_results
            ]
        }
        
        # Cache the results
        set_cached_search(user_id, cache_key, response_data)
        
        # Log successful search
        search_counter.labels(search_type=search_type_str, status='success').inc()
        logger.info(f"Search completed for user {user_id}: {len(results)} results in {response_data['search_time']}s")
        
        return jsonify(response_data)
        
    except Exception as e:
        search_counter.labels(search_type='unknown', status='error').inc()
        
        # Enhanced error logging
        error_context = {
            'user_id': user_id,
            'query': query[:100] if 'query' in locals() else 'N/A',
            'search_type': search_type_str if 'search_type_str' in locals() else 'N/A',
            'error': str(e),
            'traceback': traceback.format_exc()
        }
        logger.error(f"Global search error: {error_context}")
        
        # Send to Sentry if available
        if SENTRY_ENABLED:
            sentry_sdk.capture_exception(e)
        
        return jsonify({'error': '××™×¨×¢×” ×©×’×™××” ×‘×—×™×¤×•×©', 'details': str(e) if app.debug else None}), 500
        
    finally:
        # Record search duration
        search_duration.observe(time.time() - start_time)


@app.route('/api/search/suggestions', methods=['GET'])
@login_required
def search_suggestions():
    """×”×¦×¢×•×ª ×”×©×œ××” ××•×˜×•××˜×™×ª ×œ×—×™×¤×•×©"""
    try:
        partial = request.args.get('q', '').strip()
        if len(partial) < 2:
            return jsonify({'suggestions': []})
        
        suggestions = search_engine.suggest_completions(
            user_id=session['user_id'],
            partial_query=partial,
            limit=10
        )
        
        return jsonify({'suggestions': suggestions})
        
    except Exception as e:
        logger.error(f"×©×’×™××” ×‘×”×¦×¢×•×ª ×—×™×¤×•×©: {e}")
        return jsonify({'suggestions': []})
```

### ×©×œ×‘ 2: ×”×•×¡×¤×ª ×××©×§ ××©×ª××©

#### 2.1 ×”×•×¡×¤×ª ×ª×™×‘×ª ×—×™×¤×•×© ×’×œ×•×‘×œ×™

**×§×•×‘×¥:** `webapp/templates/files.html` ××• `webapp/templates/dashboard.html`

**××™×§×•×:** ×‘×¨××© ×”×¢××•×“, ××—×¨×™ ×”×›×•×ª×¨×ª

```html
<!-- ×—×™×¤×•×© ×’×œ×•×‘×œ×™ ×‘×ª×•×›×Ÿ -->
<div class="card mb-4">
    <div class="card-body">
        <h5 class="card-title">ğŸ” ×—×™×¤×•×© ×’×œ×•×‘×œ×™ ×‘×›×œ ×”×§×‘×¦×™×</h5>
        
        <div class="row">
            <div class="col-md-8">
                <div class="input-group">
                    <input type="text" 
                           id="globalSearchInput" 
                           class="form-control"
                           placeholder="×—×¤×© ×˜×§×¡×˜, ×§×•×“ ××• ×‘×™×˜×•×™ ×¨×’×•×œ×¨×™ ×‘×›×œ ×”×§×‘×¦×™×..."
                           autocomplete="off">
                    <div class="input-group-append">
                        <button class="btn btn-primary" 
                                onclick="performGlobalSearch()"
                                id="searchBtn">
                            <i class="fas fa-search"></i> ×—×¤×©
                        </button>
                    </div>
                </div>
                <!-- ×”×¦×¢×•×ª ××•×˜×•××˜×™×•×ª -->
                <div id="searchSuggestions" class="list-group position-absolute w-100" 
                     style="z-index: 1000; display: none;"></div>
            </div>
            
            <div class="col-md-4">
                <button class="btn btn-outline-secondary btn-sm" 
                        onclick="toggleAdvancedSearch()">
                    <i class="fas fa-cog"></i> ×—×™×¤×•×© ××ª×§×“×
                </button>
            </div>
        </div>
        
        <!-- ××¤×©×¨×•×™×•×ª ××ª×§×“××•×ª -->
        <div id="advancedSearchOptions" class="mt-3" style="display: none;">
            <div class="row">
                <div class="col-md-3">
                    <label>×¡×•×’ ×—×™×¤×•×©:</label>
                    <select id="searchType" class="form-control form-control-sm">
                        <option value="content">×ª×•×›×Ÿ</option>
                        <option value="text">×˜×§×¡×˜ (××™×œ×™×)</option>
                        <option value="regex">×‘×™×˜×•×™ ×¨×’×•×œ×¨×™</option>
                        <option value="fuzzy">×—×™×¤×•×© ××˜×•×©×˜×©</option>
                        <option value="function">×©××•×ª ×¤×•× ×§×¦×™×•×ª</option>
                    </select>
                </div>
                
                <div class="col-md-3">
                    <label>×©×¤×•×ª ×ª×›× ×•×ª:</label>
                    <select id="filterLanguages" class="form-control form-control-sm" multiple>
                        <option value="python">Python</option>
                        <option value="javascript">JavaScript</option>
                        <option value="java">Java</option>
                        <option value="cpp">C++</option>
                        <option value="html">HTML</option>
                        <option value="css">CSS</option>
                        <option value="sql">SQL</option>
                    </select>
                </div>
                
                <div class="col-md-3">
                    <label>××™×•×Ÿ ×œ×¤×™:</label>
                    <select id="sortOrder" class="form-control form-control-sm">
                        <option value="relevance">×¨×œ×•×•× ×˜×™×•×ª</option>
                        <option value="date_desc">×ª××¨×™×š (×—×“×© ×œ×™×©×Ÿ)</option>
                        <option value="date_asc">×ª××¨×™×š (×™×©×Ÿ ×œ×—×“×©)</option>
                        <option value="name_asc">×©× ×§×•×‘×¥ (×-×ª)</option>
                        <option value="size_desc">×’×•×“×œ (×’×“×•×œ ×œ×§×˜×Ÿ)</option>
                    </select>
                </div>
                
                <div class="col-md-3">
                    <label>×ª×•×¦××•×ª ×œ×¢××•×“:</label>
                    <select id="resultsPerPage" class="form-control form-control-sm">
                        <option value="10">10</option>
                        <option value="20" selected>20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ××–×•×¨ ×ª×•×¦××•×ª ×—×™×¤×•×© -->
<div id="searchResultsContainer" style="display: none;">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">×ª×•×¦××•×ª ×—×™×¤×•×©</h5>
            <button class="btn btn-sm btn-outline-secondary" onclick="clearSearch()">
                <i class="fas fa-times"></i> × ×§×” ×—×™×¤×•×©
            </button>
        </div>
        <div class="card-body">
            <div id="searchInfo" class="mb-3"></div>
            <div id="searchResults"></div>
            <div id="searchPagination" class="mt-3"></div>
        </div>
    </div>
</div>
```

#### 2.2 JavaScript ×œ×˜×™×¤×•×œ ×‘×—×™×¤×•×©

**×§×•×‘×¥ ×—×“×©:** `webapp/static/js/global_search.js`

```javascript
// ××©×ª× ×™ ××¦×‘
let currentSearchQuery = '';
let currentSearchPage = 1;
let searchTimeout = null;
let suggestionsTimeout = null;

// ××ª×—×•×œ
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('globalSearchInput');
    
    // ×—×™×¤×•×© ×‘×œ×—×™×¦×ª Enter
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            performGlobalSearch();
        }
    });
    
    // ×”×¦×¢×•×ª ××•×˜×•××˜×™×•×ª
    searchInput.addEventListener('input', function(e) {
        clearTimeout(suggestionsTimeout);
        const query = e.target.value.trim();
        
        if (query.length >= 2) {
            suggestionsTimeout = setTimeout(() => {
                fetchSuggestions(query);
            }, 300);
        } else {
            hideSuggestions();
        }
    });
    
    // ×”×¡×ª×¨×ª ×”×¦×¢×•×ª ×‘×œ×—×™×¦×” ×”×—×•×¦×”
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#globalSearchInput') && 
            !e.target.closest('#searchSuggestions')) {
            hideSuggestions();
        }
    });
});

// ×‘×™×¦×•×¢ ×—×™×¤×•×©
async function performGlobalSearch(page = 1) {
    const query = document.getElementById('globalSearchInput').value.trim();
    
    if (!query) {
        showNotification('× × ×œ×”×–×™×Ÿ ×˜×§×¡×˜ ×œ×—×™×¤×•×©', 'warning');
        return;
    }
    
    // ×©××™×¨×ª ××¦×‘
    currentSearchQuery = query;
    currentSearchPage = page;
    
    // ×”×¦×’×ª ××¦×‘ ×˜×¢×™× ×”
    const searchBtn = document.getElementById('searchBtn');
    const originalBtnText = searchBtn.innerHTML;
    searchBtn.disabled = true;
    searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ××—×¤×©...';
    
    try {
        // ×‘× ×™×™×ª ×‘×§×©×”
        const searchData = {
            query: query,
            search_type: document.getElementById('searchType')?.value || 'content',
            page: page,
            limit: parseInt(document.getElementById('resultsPerPage')?.value || '20'),
            sort: document.getElementById('sortOrder')?.value || 'relevance'
        };
        
        // ×”×•×¡×¤×ª ×¤×™×œ×˜×¨×™× ×× × ×‘×—×¨×•
        const selectedLanguages = getSelectedValues('filterLanguages');
        if (selectedLanguages.length > 0) {
            searchData.filters = { languages: selectedLanguages };
        }
        
        // ×©×œ×™×—×ª ×‘×§×©×”
        const response = await fetch('/api/search/global', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(searchData)
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            displaySearchResults(data);
        } else {
            showNotification(data.error || '××™×¨×¢×” ×©×’×™××” ×‘×—×™×¤×•×©', 'error');
        }
        
    } catch (error) {
        console.error('Search error:', error);
        showNotification('××™×¨×¢×” ×©×’×™××” ×‘×—×™×¤×•×©', 'error');
    } finally {
        searchBtn.disabled = false;
        searchBtn.innerHTML = originalBtnText;
        hideSuggestions();
    }
}

// ×”×¦×’×ª ×ª×•×¦××•×ª ×—×™×¤×•×©
function displaySearchResults(data) {
    const container = document.getElementById('searchResultsContainer');
    const info = document.getElementById('searchInfo');
    const results = document.getElementById('searchResults');
    const pagination = document.getElementById('searchPagination');
    
    // ×”×¦×’×ª ××™×“×¢ ×›×œ×œ×™
    info.innerHTML = `
        <div class="alert alert-info">
            × ××¦××• <strong>${data.total_results}</strong> ×ª×•×¦××•×ª ×¢×‘×•×¨: 
            <strong>"${escapeHtml(data.query)}"</strong>
            (××¦×™×’ ${data.results.length} ×ª×•×¦××•×ª)
        </div>
    `;
    
    // ×”×¦×’×ª ×ª×•×¦××•×ª
    if (data.results.length === 0) {
        results.innerHTML = '<p class="text-muted">×œ× × ××¦××• ×ª×•×¦××•×ª ×”×ª×•×××•×ª ×œ×—×™×¤×•×©</p>';
    } else {
        results.innerHTML = data.results.map(result => createResultCard(result)).join('');
    }
    
    // ×¢×™××•×“
    createPagination(pagination, data);
    
    // ×”×¦×’×ª ×”×§×•× ×˜×™×™× ×¨
    container.style.display = 'block';
    
    // ×’×œ×™×œ×” ×œ×ª×•×¦××•×ª
    container.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// ×™×¦×™×¨×ª ×›×¨×˜×™×¡ ×ª×•×¦××”
function createResultCard(result) {
    const highlightedSnippet = highlightText(result.snippet, result.highlights);
    const fileIcon = getFileIcon(result.language);
    
    return `
        <div class="search-result-card mb-3 p-3 border rounded">
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <h6 class="mb-1">
                        ${fileIcon}
                        <a href="/file/${result.file_id}" target="_blank">
                            ${escapeHtml(result.file_name)}
                        </a>
                        <span class="badge badge-secondary ml-2">${result.language}</span>
                    </h6>
                    
                    ${result.tags.length > 0 ? `
                        <div class="mb-2">
                            ${result.tags.map(tag => 
                                `<span class="badge badge-info mr-1">${escapeHtml(tag)}</span>`
                            ).join('')}
                        </div>
                    ` : ''}
                    
                    <div class="code-snippet bg-light p-2 rounded">
                        <pre class="mb-0"><code>${highlightedSnippet}</code></pre>
                    </div>
                    
                    ${result.matches && result.matches.length > 0 ? `
                        <small class="text-muted">
                            ${result.matches.length} ×”×ª×××•×ª 
                            (×©×•×¨×•×ª: ${result.matches.map(m => m.line).join(', ')})
                        </small>
                    ` : ''}
                </div>
                
                <div class="text-right ml-3">
                    <div class="text-muted small">
                        <div>×¦×™×•×Ÿ: ${result.score}</div>
                        <div>×’×•×“×œ: ${formatFileSize(result.size)}</div>
                        <div>×¢×“×›×•×Ÿ: ${formatDate(result.updated_at)}</div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// ×¡×™××•×Ÿ ×˜×§×¡×˜ ×©× ××¦×
function highlightText(text, highlights) {
    if (!text || !highlights || highlights.length === 0) {
        return escapeHtml(text);
    }
    
    let result = escapeHtml(text);
    
    // ××™×™×Ÿ highlights ×œ×¤×™ ××™×§×•× ×‘×¡×“×¨ ×™×•×¨×“ (××”×¡×•×£ ×œ×”×ª×—×œ×”)
    highlights.sort((a, b) => b[0] - a[0]);
    
    highlights.forEach(([start, end]) => {
        const before = result.substring(0, start);
        const match = result.substring(start, end);
        const after = result.substring(end);
        result = before + `<mark class="bg-warning">${match}</mark>` + after;
    });
    
    return result;
}

// ×¢×™××•×“
function createPagination(container, data) {
    const totalPages = Math.ceil(data.total_results / data.per_page);
    const currentPage = data.page;
    
    if (totalPages <= 1) {
        container.innerHTML = '';
        return;
    }
    
    let html = '<nav><ul class="pagination justify-content-center">';
    
    // ×›×¤×ª×•×¨ ×§×•×“×
    html += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="performGlobalSearch(${currentPage - 1}); return false;">
                <i class="fas fa-chevron-right"></i>
            </a>
        </li>
    `;
    
    // ××¡×¤×¨×™ ×¢××•×“×™×
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        html += `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="performGlobalSearch(${i}); return false;">
                    ${i}
                </a>
            </li>
        `;
    }
    
    // ×›×¤×ª×•×¨ ×”×‘×
    html += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="performGlobalSearch(${currentPage + 1}); return false;">
                <i class="fas fa-chevron-left"></i>
            </a>
        </li>
    `;
    
    html += '</ul></nav>';
    container.innerHTML = html;
}

// ×”×¦×¢×•×ª ××•×˜×•××˜×™×•×ª
async function fetchSuggestions(query) {
    try {
        const response = await fetch(`/api/search/suggestions?q=${encodeURIComponent(query)}`);
        const data = await response.json();
        
        if (data.suggestions && data.suggestions.length > 0) {
            showSuggestions(data.suggestions);
        } else {
            hideSuggestions();
        }
    } catch (error) {
        console.error('Suggestions error:', error);
        hideSuggestions();
    }
}

function showSuggestions(suggestions) {
    const container = document.getElementById('searchSuggestions');
    
    container.innerHTML = suggestions.map(suggestion => `
        <a href="#" class="list-group-item list-group-item-action" 
           onclick="selectSuggestion('${escapeHtml(suggestion)}'); return false;">
            <i class="fas fa-search text-muted"></i> ${escapeHtml(suggestion)}
        </a>
    `).join('');
    
    container.style.display = 'block';
}

function hideSuggestions() {
    document.getElementById('searchSuggestions').style.display = 'none';
}

function selectSuggestion(suggestion) {
    document.getElementById('globalSearchInput').value = suggestion;
    hideSuggestions();
    performGlobalSearch();
}

// ×—×™×¤×•×© ××ª×§×“×
function toggleAdvancedSearch() {
    const options = document.getElementById('advancedSearchOptions');
    options.style.display = options.style.display === 'none' ? 'block' : 'none';
}

// × ×™×§×•×™ ×—×™×¤×•×©
function clearSearch() {
    document.getElementById('globalSearchInput').value = '';
    document.getElementById('searchResultsContainer').style.display = 'none';
    currentSearchQuery = '';
    currentSearchPage = 1;
}

// ×¤×•× ×§×¦×™×•×ª ×¢×–×¨
function getSelectedValues(selectId) {
    const select = document.getElementById(selectId);
    if (!select) return [];
    
    return Array.from(select.selectedOptions).map(option => option.value);
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function getFileIcon(language) {
    const icons = {
        'python': 'ğŸ',
        'javascript': 'ğŸ“œ',
        'java': 'â˜•',
        'cpp': 'âš™ï¸',
        'html': 'ğŸŒ',
        'css': 'ğŸ¨',
        'sql': 'ğŸ—„ï¸',
        'json': 'ğŸ“‹',
        'xml': 'ğŸ“„',
        'markdown': 'ğŸ“'
    };
    return icons[language.toLowerCase()] || 'ğŸ“„';
}

function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString('he-IL', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function showNotification(message, type = 'info') {
    // ×× ×™×© ××¢×¨×›×ª ×”×ª×¨××•×ª ×§×™×™××ª
    if (typeof toastr !== 'undefined') {
        toastr[type](message);
    } else {
        alert(message);
    }
}
```

#### 2.3 ×”×•×¡×¤×ª ×¡×’× ×•× ×•×ª CSS

**×§×•×‘×¥ ×—×“×©:** `webapp/static/css/global_search.css`

```css
/* ×¡×’× ×•× ×•×ª ×œ×—×™×¤×•×© ×’×œ×•×‘×œ×™ */

/* ×ª×™×‘×ª ×—×™×¤×•×© */
#globalSearchInput {
    font-size: 16px;
    padding: 10px 15px;
}

#globalSearchInput:focus {
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
}

/* ×”×¦×¢×•×ª ××•×˜×•××˜×™×•×ª */
#searchSuggestions {
    max-height: 300px;
    overflow-y: auto;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    margin-top: 2px;
    border-radius: 4px;
}

#searchSuggestions .list-group-item {
    padding: 8px 15px;
    cursor: pointer;
    border-left: none;
    border-right: none;
}

#searchSuggestions .list-group-item:hover {
    background-color: #f8f9fa;
}

#searchSuggestions .list-group-item:first-child {
    border-top: none;
}

/* ×›×¨×˜×™×¡ ×ª×•×¦××” */
.search-result-card {
    transition: all 0.3s ease;
    background: white;
}

.search-result-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

.search-result-card h6 a {
    color: #007bff;
    text-decoration: none;
    font-weight: 600;
}

.search-result-card h6 a:hover {
    text-decoration: underline;
}

/* ×§×˜×¢ ×§×•×“ */
.code-snippet {
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    font-size: 13px;
    max-height: 200px;
    overflow: auto;
    position: relative;
}

.code-snippet pre {
    white-space: pre-wrap;
    word-wrap: break-word;
}

.code-snippet mark {
    background-color: #ffeb3b;
    color: #000;
    padding: 2px 4px;
    border-radius: 2px;
    font-weight: bold;
}

/* ××¤×©×¨×•×™×•×ª ××ª×§×“××•×ª */
#advancedSearchOptions {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 4px;
    margin-top: 15px;
}

#advancedSearchOptions label {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 5px;
    color: #495057;
}

/* ×¢×™××•×“ */
.pagination {
    margin-top: 20px;
}

.pagination .page-link {
    color: #007bff;
    border-color: #dee2e6;
}

.pagination .page-item.active .page-link {
    background-color: #007bff;
    border-color: #007bff;
}

.pagination .page-item.disabled .page-link {
    color: #6c757d;
    background-color: #fff;
}

/* ×× ×™××¦×™×” ×œ×˜×¢×™× ×” */
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.fa-spin {
    animation: spin 1s linear infinite;
}

/* ×ª××™×›×” ×‘-Dark Mode */
@media (prefers-color-scheme: dark) {
    .search-result-card {
        background: #2b2b2b;
        color: #e0e0e0;
    }
    
    .code-snippet {
        background-color: #1e1e1e !important;
        color: #d4d4d4;
    }
    
    #advancedSearchOptions {
        background-color: #2b2b2b;
        color: #e0e0e0;
    }
    
    .search-result-card h6 a {
        color: #4db8ff;
    }
}

/* ×¨×¡×¤×•× ×¡×™×‘×™×•×ª */
@media (max-width: 768px) {
    #advancedSearchOptions .row {
        flex-direction: column;
    }
    
    #advancedSearchOptions .col-md-3 {
        margin-bottom: 10px;
    }
    
    .search-result-card {
        padding: 10px !important;
    }
    
    .search-result-card .d-flex {
        flex-direction: column;
    }
    
    .search-result-card .text-right {
        text-align: left !important;
        margin-left: 0 !important;
        margin-top: 10px;
    }
}
```

### ×©×œ×‘ 3: ×”×•×¡×¤×ª ×”×§×•×‘×¦×™× ×œ×ª×‘× ×™×ª ×”×‘×¡×™×¡

**×§×•×‘×¥:** `webapp/templates/base.html`

**××™×§×•×:** ×‘×ª×•×š ×”-`<head>`

```html
<!-- CSS ×œ×—×™×¤×•×© ×’×œ×•×‘×œ×™ -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/global_search.css') }}">
```

**××™×§×•×:** ×œ×¤× ×™ ×¡×’×™×¨×ª `</body>`

```html
<!-- JavaScript ×œ×—×™×¤×•×© ×’×œ×•×‘×œ×™ -->
<script src="{{ url_for('static', filename='js/global_search.js') }}"></script>
```

### ×©×œ×‘ 4: ××•×¤×˜×™××™×–×¦×™×•×ª ×•×‘×™×¦×•×¢×™×

#### 4.1 ×¢×“×›×•×Ÿ ××™× ×“×§×¡ ××•×˜×•××˜×™

**×§×•×‘×¥:** `webapp/app.py`

**×”×•×¡×¤×” ×‘×¤×•× ×§×¦×™×•×ª upload ×•edit:**

```python
def invalidate_search_index(user_id):
    """××—×™×§×ª ××™× ×“×§×¡ ×—×™×¤×•×© ×œ××—×¨ ×©×™× ×•×™ ×‘×§×‘×¦×™×"""
    if hasattr(search_engine, 'indexes') and user_id in search_engine.indexes:
        del search_engine.indexes[user_id]

# ×‘×¡×•×£ ×¤×•× ×§×¦×™×™×ª upload_file:
invalidate_search_index(user_id)

# ×‘×¡×•×£ ×¤×•× ×§×¦×™×™×ª edit_file_page (××—×¨×™ ×©××™×¨×” ××•×¦×œ×—×ª):
invalidate_search_index(user_id)

# ×‘×¡×•×£ ×¤×•× ×§×¦×™×™×ª delete_file:
invalidate_search_index(user_id)
```

#### 4.2 Caching ×œ×©×™×¤×•×¨ ×‘×™×¦×•×¢×™×

```python
from functools import lru_cache
from datetime import datetime, timedelta

# Cache ×œ×ª×•×¦××•×ª ×—×™×¤×•×©
search_cache = {}

def get_cached_search(user_id, cache_key):
    """×‘×“×™×§×ª cache ×œ×—×™×¤×•×©"""
    if user_id not in search_cache:
        return None
    
    cached = search_cache[user_id].get(cache_key)
    if not cached:
        return None
    
    # ×‘×“×•×§ ×× ×¤×’ ×ª×•×§×£ (5 ×“×§×•×ª)
    if datetime.now() - cached['time'] > timedelta(minutes=5):
        del search_cache[user_id][cache_key]
        return None
    
    return cached['results']

def set_cached_search(user_id, cache_key, results):
    """×©××™×¨×ª ×ª×•×¦××•×ª ×‘-cache"""
    if user_id not in search_cache:
        search_cache[user_id] = {}
    
    search_cache[user_id][cache_key] = {
        'time': datetime.now(),
        'results': results
    }
```

### ×©×œ×‘ 5: ×‘×“×™×§×•×ª

#### 5.1 ×‘×“×™×§×•×ª ×™×—×™×“×”

**×§×•×‘×¥ ×—×“×©:** `tests/test_global_search.py`

```python
import pytest
from webapp.app import app
from search_engine import search_engine, SearchType

class TestGlobalSearch:
    
    def test_search_endpoint_requires_login(self, client):
        """×‘×“×™×§×” ×©×”-endpoint ×“×•×¨×© ×”×ª×—×‘×¨×•×ª"""
        response = client.post('/api/search/global', 
                              json={'query': 'test'})
        assert response.status_code == 401
    
    def test_search_with_empty_query(self, client, logged_in_user):
        """×‘×“×™×§×ª ×—×™×¤×•×© ×¢× ×©××™×œ×ª×” ×¨×™×§×”"""
        response = client.post('/api/search/global', 
                              json={'query': ''})
        assert response.status_code == 400
        assert 'error' in response.json
    
    def test_successful_search(self, client, logged_in_user, sample_files):
        """×‘×“×™×§×ª ×—×™×¤×•×© ××•×¦×œ×—"""
        response = client.post('/api/search/global',
                              json={'query': 'function'})
        assert response.status_code == 200
        data = response.json
        assert 'results' in data
        assert 'total_results' in data
    
    def test_search_with_filters(self, client, logged_in_user, sample_files):
        """×‘×“×™×§×ª ×—×™×¤×•×© ×¢× ×¤×™×œ×˜×¨×™×"""
        response = client.post('/api/search/global',
                              json={
                                  'query': 'test',
                                  'filters': {
                                      'languages': ['python']
                                  }
                              })
        assert response.status_code == 200
        data = response.json
        # ×‘×“×•×§ ×©×›×œ ×”×ª×•×¦××•×ª ×”×Ÿ Python
        for result in data['results']:
            assert result['language'] == 'python'
    
    def test_search_pagination(self, client, logged_in_user, many_files):
        """×‘×“×™×§×ª ×¢×™××•×“ ×‘×ª×•×¦××•×ª"""
        # ×¢××•×“ ×¨××©×•×Ÿ
        response1 = client.post('/api/search/global',
                               json={'query': 'code', 'page': 1, 'limit': 10})
        data1 = response1.json
        
        # ×¢××•×“ ×©× ×™
        response2 = client.post('/api/search/global',
                               json={'query': 'code', 'page': 2, 'limit': 10})
        data2 = response2.json
        
        # ×•×“× ×©×”×ª×•×¦××•×ª ×©×•× ×•×ª
        assert data1['results'][0]['file_id'] != data2['results'][0]['file_id']
```

#### 5.2 ×‘×“×™×§×•×ª ××™× ×˜×’×¨×¦×™×”

```python
def test_full_search_flow():
    """×‘×“×™×§×ª ×ª×”×œ×™×š ×—×™×¤×•×© ××œ×"""
    # 1. ×”×¢×œ×” ×§×•×‘×¥
    # 2. ×‘×¦×¢ ×—×™×¤×•×©
    # 3. ×•×“× ×©×”×§×•×‘×¥ × ××¦×
    # 4. ×¢×¨×•×š ×§×•×‘×¥
    # 5. ×‘×¦×¢ ×—×™×¤×•×© ×—×“×©
    # 6. ×•×“× ×©×”×©×™× ×•×™×™× ××©×ª×§×¤×™×
    pass
```

### ×©×œ×‘ 6: ×ª×™×¢×•×“ ×œ××©×ª××©

#### ×”×•×¡×¤×ª ×”×¡×‘×¨ ×‘×¢××•×“ ×”×¢×–×¨×”

```html
<h3>×—×™×¤×•×© ×’×œ×•×‘×œ×™ ×‘×§×‘×¦×™×</h3>
<p>×”××¢×¨×›×ª ×××¤×©×¨×ª ×—×™×¤×•×© ××”×™×¨ ×•×—×›× ×‘×›×œ ×”×§×‘×¦×™× ×©×œ×š:</p>

<h4>×¡×•×’×™ ×—×™×¤×•×©:</h4>
<ul>
    <li><strong>×—×™×¤×•×© ×ª×•×›×Ÿ:</strong> ××—×¤×© ××ª ×”×˜×§×¡×˜ ×”××“×•×™×§ ×‘×ª×•×›×Ÿ ×”×§×‘×¦×™×</li>
    <li><strong>×—×™×¤×•×© ×˜×§×¡×˜:</strong> ××—×¤×© ××™×œ×™× ×‘×•×“×“×•×ª ×¢× ×”×ª×××” ×—×œ×§×™×ª</li>
    <li><strong>×‘×™×˜×•×™ ×¨×’×•×œ×¨×™:</strong> ×—×™×¤×•×© ××ª×§×“× ×¢× regex</li>
    <li><strong>×—×™×¤×•×© ××˜×•×©×˜×©:</strong> ××•×¦× ×”×ª×××•×ª ×“×•××•×ª (×œ× ××“×•×™×§×•×ª)</li>
    <li><strong>×©××•×ª ×¤×•× ×§×¦×™×•×ª:</strong> ××—×¤×© ×”×’×“×¨×•×ª ×¤×•× ×§×¦×™×•×ª ×‘×§×•×“</li>
</ul>

<h4>×˜×™×¤×™× ×œ×—×™×¤×•×© ×™×¢×™×œ:</h4>
<ul>
    <li>×”×©×ª××© ×‘××¨×›××•×ª ×œ×—×™×¤×•×© ×‘×™×˜×•×™ ××“×•×™×§: "user login"</li>
    <li>×”×©×ª××© ×‘-* ×œ×—×™×¤×•×© wildcard: user*</li>
    <li>×¡× ×Ÿ ×œ×¤×™ ×©×¤×ª ×ª×›× ×•×ª ×œ×”×§×˜× ×ª ×”×ª×•×¦××•×ª</li>
    <li>××™×™×Ÿ ×œ×¤×™ ×ª××¨×™×š ×œ××¦×™××ª ×§×‘×¦×™× ×¢×“×›× ×™×™×</li>
</ul>

<h4>×§×™×¦×•×¨×™ ××§×œ×“×ª:</h4>
<ul>
    <li><kbd>Ctrl</kbd> + <kbd>K</kbd> - ×¤×ª×— ×—×™×¤×•×© ××”×™×¨</li>
    <li><kbd>Enter</kbd> - ×‘×¦×¢ ×—×™×¤×•×©</li>
    <li><kbd>Esc</kbd> - ×¡×’×•×¨ ×—×™×¤×•×©</li>
</ul>
```

## ×©×œ×‘ 7: ×”×•×¡×¤×ª Health Check ×•-Monitoring Endpoints

**×§×•×‘×¥:** `webapp/app.py`

```python
@app.route('/api/search/health', methods=['GET'])
def search_health_check():
    """×‘×“×™×§×ª ×ª×§×™× ×•×ª ×× ×•×¢ ×”×—×™×¤×•×© - endpoint ×¦×™×‘×•×¨×™ ×œmonitoring"""
    try:
        # Test basic search engine functionality
        test_user_id = -1  # Special test user ID
        
        # Check if search engine is responsive
        search_engine.get_index(test_user_id)
        
        # Check metrics collection
        metrics_ok = search_counter._value is not None
        
        health_status = {
            'status': 'healthy',
            'timestamp': datetime.now().isoformat(),
            'checks': {
                'search_engine': 'ok',
                'metrics': 'ok' if metrics_ok else 'degraded',
                'cache': 'ok' if len(search_cache) < 1000 else 'warning',  # Warn if cache is too large
                'indexes': len(search_engine.indexes)
            }
        }
        
        return jsonify(health_status), 200
        
    except Exception as e:
        logger.error(f"Health check failed: {e}")
        return jsonify({
            'status': 'unhealthy',
            'timestamp': datetime.now().isoformat(),
            'error': str(e)
        }), 503

@app.route('/metrics')
def metrics_endpoint():
    """Prometheus metrics endpoint"""
    # Update gauge metrics
    active_indexes.set(len(search_engine.indexes))
    
    # Generate Prometheus format metrics
    return generate_latest(), 200, {'Content-Type': 'text/plain; charset=utf-8'}

@app.route('/admin/search/stats')
@login_required
@admin_required  # ×”×•×¡×£ decorator ×œ×× ×”×œ×™× ×‘×œ×‘×“
def search_statistics():
    """×“×£ ×¡×˜×˜×™×¡×˜×™×§×•×ª ×—×™×¤×•×© ×œ×× ×”×œ×™×"""
    if not session.get('is_admin'):
        return redirect(url_for('index'))
    
    # Calculate statistics
    total_searches = sum(search_counter._samples())
    cache_hit_rate = 0
    if total_searches > 0:
        cache_hit_rate = (cache_hits._value / total_searches) * 100 if cache_hits._value else 0
    
    avg_search_time = 0
    if search_duration._count:
        avg_search_time = search_duration._sum / search_duration._count
    
    stats = {
        'total_searches': total_searches,
        'searches_today': search_counter._value,  # Reset daily
        'cache_hit_rate': round(cache_hit_rate, 2),
        'avg_search_time': round(avg_search_time, 3),
        'active_indexes': len(search_engine.indexes),
        'cache_size': len(search_cache),
        'top_queries': get_top_queries(),  # Implement if needed
        'search_types_distribution': get_search_types_distribution(),
        'errors_count': search_counter.labels(search_type='unknown', status='error')._value
    }
    
    return render_template('admin/search_stats.html', stats=stats)

def get_top_queries(limit=10):
    """Get most popular search queries"""
    # This would need a separate tracking mechanism
    # For now, return empty list
    return []

def get_search_types_distribution():
    """Get distribution of search types used"""
    distribution = {}
    for search_type in ['content', 'regex', 'fuzzy', 'function', 'text']:
        count = search_counter.labels(search_type=search_type, status='success')._value
        if count:
            distribution[search_type] = count
    return distribution
```

### ×©×œ×‘ 8: ×ª×‘× ×™×ª HTML ×œ×“×£ ×”×¡×˜×˜×™×¡×˜×™×§×•×ª

**×§×•×‘×¥ ×—×“×©:** `webapp/templates/admin/search_stats.html`

```html
{% extends "base.html" %}

{% block title %}×¡×˜×˜×™×¡×˜×™×§×•×ª ×—×™×¤×•×© - ×× ×”×œ{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×•×ª ××¢×¨×›×ª ×”×—×™×¤×•×©</h2>
    
    <div class="row mt-4">
        <!-- ×›×¨×˜×™×¡×™ ×¡×˜×˜×™×¡×˜×™×§×” -->
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">×¡×”"×› ×—×™×¤×•×©×™×</h5>
                    <h2 class="text-primary">{{ stats.total_searches }}</h2>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">Cache Hit Rate</h5>
                    <h2 class="text-success">{{ stats.cache_hit_rate }}%</h2>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">×–××Ÿ ×—×™×¤×•×© ×××•×¦×¢</h5>
                    <h2 class="text-info">{{ stats.avg_search_time }}s</h2>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">××™× ×“×§×¡×™× ×¤×¢×™×œ×™×</h5>
                    <h2 class="text-warning">{{ stats.active_indexes }}</h2>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <!-- ×’×¨×£ ×”×ª×¤×œ×’×•×ª ×¡×•×’×™ ×—×™×¤×•×© -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>×”×ª×¤×œ×’×•×ª ×¡×•×’×™ ×—×™×¤×•×©</h5>
                </div>
                <div class="card-body">
                    <canvas id="searchTypesChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- ×¨×©×™××ª ×©××™×œ×ª×•×ª ×¤×•×¤×•×œ×¨×™×•×ª -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>×©××™×œ×ª×•×ª ×¤×•×¤×•×œ×¨×™×•×ª</h5>
                </div>
                <div class="card-body">
                    {% if stats.top_queries %}
                    <ul class="list-group">
                        {% for query in stats.top_queries %}
                        <li class="list-group-item d-flex justify-content-between">
                            <span>{{ query.text }}</span>
                            <span class="badge badge-primary">{{ query.count }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-muted">××™×Ÿ × ×ª×•× ×™× ×–××™× ×™×</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- ××™×“×¢ × ×•×¡×£ -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>××™×“×¢ ××¢×¨×›×ª</h5>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-3">×’×•×“×œ Cache</dt>
                        <dd class="col-sm-9">{{ stats.cache_size }} ×¢×¨×›×™×</dd>
                        
                        <dt class="col-sm-3">×©×’×™××•×ª</dt>
                        <dd class="col-sm-9">
                            <span class="badge badge-danger">{{ stats.errors_count }}</span>
                        </dd>
                        
                        <dt class="col-sm-3">Health Check</dt>
                        <dd class="col-sm-9">
                            <a href="/api/search/health" target="_blank" class="btn btn-sm btn-info">
                                ×‘×“×•×§ ×ª×§×™× ×•×ª
                            </a>
                        </dd>
                        
                        <dt class="col-sm-3">Prometheus Metrics</dt>
                        <dd class="col-sm-9">
                            <a href="/metrics" target="_blank" class="btn btn-sm btn-secondary">
                                ×¦×¤×” ×‘-Metrics
                            </a>
                        </dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// ×’×¨×£ ×”×ª×¤×œ×’×•×ª ×¡×•×’×™ ×—×™×¤×•×©
const ctx = document.getElementById('searchTypesChart').getContext('2d');
const searchTypesData = {{ stats.search_types_distribution | tojson }};

new Chart(ctx, {
    type: 'pie',
    data: {
        labels: Object.keys(searchTypesData),
        datasets: [{
            data: Object.values(searchTypesData),
            backgroundColor: [
                '#007bff',
                '#28a745',
                '#ffc107',
                '#dc3545',
                '#6c757d'
            ]
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Auto-refresh every 30 seconds
setTimeout(() => location.reload(), 30000);
</script>
{% endblock %}
```

## ×‘×“×™×§×•×ª ×§×‘×œ×” (Acceptance Criteria)

### ×¤×•× ×§×¦×™×•× ×œ×™×•×ª ×‘×¡×™×¡×™×ª
- [ ] × ×™×ª×Ÿ ×œ×—×¤×© ×˜×§×¡×˜ ×‘×›×œ ×”×§×‘×¦×™×
- [ ] ×ª×•×¦××•×ª ××•×¦×’×•×ª ×¢× ×§×˜×¢×™ ×ª×¦×•×’×” ××§×“×™××”
- [ ] ×”×˜×§×¡×˜ ×©× ××¦× ××•×“×’×© ×‘×ª×•×¦××•×ª
- [ ] × ×™×ª×Ÿ ×œ×¡× ×Ÿ ×œ×¤×™ ×©×¤×ª ×ª×›× ×•×ª
- [ ] × ×™×ª×Ÿ ×œ××™×™×Ÿ ×ª×•×¦××•×ª (×¨×œ×•×•× ×˜×™×•×ª/×ª××¨×™×š/×©×)
- [ ] ×¢×™××•×“ ×¢×•×‘×“ ×œ×ª×•×¦××•×ª ×¨×‘×•×ª
- [ ] ×”×¦×¢×•×ª ××•×˜×•××˜×™×•×ª ××•×¤×™×¢×•×ª ×‘×–××Ÿ ×”×§×œ×“×”
- [ ] × ×™×ª×Ÿ ×œ×—×¤×© ×¢× ×‘×™×˜×•×™×™× ×¨×’×•×œ×¨×™×™×
- [ ] ×”××™× ×“×§×¡ ××ª×¢×“×›×Ÿ ××•×˜×•××˜×™×ª ×‘×©×™× ×•×™ ×§×‘×¦×™×
- [ ] ×‘×™×¦×•×¢×™× ×¡×‘×™×¨×™× ×’× ×¢× ×××•×ª ×§×‘×¦×™×

### Production-Ready Features
- [ ] Rate limiting ×¢×•×‘×“ ×•××•× ×¢ spam
- [ ] ××¢×¨×›×ª Cache ××¤×—×™×ª×” ×¢×•××¡
- [ ] Retry logic ××˜×¤×œ ×‘×›×©×œ×™× ×–×× ×™×™×
- [ ] Error monitoring ×¢× Sentry (×× ××•×’×“×¨)
- [ ] Prometheus metrics × ××¡×¤×™×
- [ ] Health check endpoint ×–××™×Ÿ
- [ ] ×“×£ ×¡×˜×˜×™×¡×˜×™×§×•×ª ×œ×× ×”×œ×™×
- [ ] ×œ×•×’×™× ××¤×•×¨×˜×™× ×œ×›×œ ×¤×¢×•×œ×”
- [ ] ×ª××™×›×” ×‘-regex validation
- [ ] ×”×’×‘×œ×ª ××•×¨×š query (500 ×ª×•×•×™×)

## ×©×™×§×•×œ×™ ×‘×™×¦×•×¢×™×

### ××’×‘×œ×•×ª ××•××œ×¦×•×ª:
- ××§×¡×™××•× 1000 ×§×‘×¦×™× ×œ×¡×¨×™×§×” ×‘×—×™×¤×•×©
- ××§×¡×™××•× 100 ×ª×•×¦××•×ª ×‘×¢××•×“
- ×–××Ÿ ×ª×’×•×‘×” ××§×¡×™××œ×™: 3 ×©× ×™×•×ª
- ×’×•×“×œ ××™× ×“×§×¡ ××§×¡×™××œ×™: 50MB ×œ××©×ª××©

### ××•×¤×˜×™××™×–×¦×™×•×ª:
- ×©×™××•×© ×‘××™× ×“×§×¡ ××™×œ×™× ×œ×—×™×¤×•×© ××”×™×¨
- Cache ×œ×ª×•×¦××•×ª ×—×™×¤×•×© × ×¤×•×¦×•×ª
- Lazy loading ×œ×§×‘×¦×™× ×’×“×•×œ×™×
- ×“×—×™×¡×ª ××™× ×“×§×¡ ×‘×–×™×›×¨×•×Ÿ

## ××‘×˜×—×”

### ×‘×“×™×§×•×ª ×§×œ×˜:
- ×¡× ×™×˜×¦×™×” ×©×œ query ×œ×× ×™×¢×ª XSS
- ×”×’×‘×œ×ª ××•×¨×š query ×œ-500 ×ª×•×•×™×
- ×× ×™×¢×ª ReDoS ×‘×‘×™×˜×•×™×™× ×¨×’×•×œ×¨×™×™×
- Rate limiting ×œ×‘×§×©×•×ª ×—×™×¤×•×©

### ×”×¨×©××•×ª:
- ×‘×“×™×§×ª user_id ×‘×›×œ ×‘×§×©×”
- ×× ×™×¢×ª ×’×™×©×” ×œ×§×‘×¦×™× ×©×œ ××©×ª××©×™× ××—×¨×™×
- ×œ×•×’ ×œ×›×œ ×¤×¢×•×œ×•×ª ×”×—×™×¤×•×©

## ×ª×•×¡×¤×•×ª ×¢×ª×™×“×™×•×ª ××¤×©×¨×™×•×ª

1. **×—×™×¤×•×© ×¡×× ×˜×™** - ×©×™××•×© ×‘-embeddings ×œ×—×™×¤×•×© ×œ×¤×™ ××©××¢×•×ª
2. **×—×™×¤×•×© ×‘×”×™×¡×˜×•×¨×™×”** - ×—×™×¤×•×© ×‘×’×¨×¡××•×ª ×§×•×“××•×ª ×©×œ ×§×‘×¦×™×
3. **×—×™×¤×•×© ××ª×§×“× ×¢× ××•×¤×¨×˜×•×¨×™×** - AND, OR, NOT
4. **×©××™×¨×ª ×—×™×¤×•×©×™×** - ×—×™×¤×•×©×™× ×©××•×¨×™× ×•××•×¢×“×¤×™×
5. **×—×™×¤×•×© ×§×•×œ×™** - ×”×›×ª×‘×” ×§×•×œ×™×ª ×œ×—×™×¤×•×©
6. **×—×™×¤×•×© ×‘×ª××•× ×•×ª** - OCR ×œ×§×‘×¦×™ ×ª××•× ×”
7. **××™× ×˜×’×¨×¦×™×” ×¢× IDE** - plugin ×œ-VSCode
8. **×—×™×¤×•×© ×—×›×** - ×”×¦×¢×•×ª ×¢×œ ×¡××š ×”×™×¡×˜×•×¨×™×™×ª ×—×™×¤×•×©×™×

## Configuration Template ×œProduction

**×§×•×‘×¥:** `webapp/config.py`

```python
# Search Configuration
SEARCH_CONFIG = {
    'ENABLE_CACHE': True,
    'CACHE_TTL_SECONDS': 300,  # 5 minutes
    'MAX_CACHE_SIZE': 1000,
    'MAX_QUERY_LENGTH': 500,
    'MAX_RESULTS_PER_PAGE': 100,
    'DEFAULT_RESULTS_PER_PAGE': 20,
    'INDEX_REBUILD_INTERVAL': 1800,  # 30 minutes
    'ENABLE_METRICS': True,
    'ENABLE_HEALTH_CHECK': True,
}

# Rate Limiting Configuration
RATELIMIT_STORAGE_URL = 'redis://localhost:6379'  # Use Redis in production
RATELIMIT_DEFAULT = "200 per day, 50 per hour"
RATELIMIT_SEARCH = "30 per minute"
RATELIMIT_SEARCH_HEAVY = "5 per minute"  # For complex queries

# Monitoring Configuration
SENTRY_DSN = os.environ.get('SENTRY_DSN', '')  # Set via environment variable
PROMETHEUS_ENABLED = True
ENVIRONMENT = os.environ.get('ENV', 'development')  # development/staging/production

# Admin Users (for statistics page)
ADMIN_USER_IDS = [1, 2, 3]  # Replace with actual admin user IDs
```

## Docker Compose ×œ×¡×‘×™×‘×ª Production

**×§×•×‘×¥:** `docker-compose.yml`

```yaml
version: '3.8'

services:
  web:
    build: .
    ports:
      - "5000:5000"
    environment:
      - FLASK_ENV=production
      - SENTRY_DSN=${SENTRY_DSN}
      - REDIS_URL=redis://redis:6379
    depends_on:
      - redis
      - prometheus
    volumes:
      - ./data:/app/data
    restart: unless-stopped

  redis:
    image: redis:alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    restart: unless-stopped

  prometheus:
    image: prom/prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    restart: unless-stopped

  grafana:
    image: grafana/grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana-dashboards:/etc/grafana/provisioning/dashboards
    depends_on:
      - prometheus
    restart: unless-stopped

volumes:
  redis-data:
  prometheus-data:
  grafana-data:
```

## Prometheus Configuration

**×§×•×‘×¥:** `prometheus.yml`

```yaml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'flask-app'
    static_configs:
      - targets: ['web:5000']
    metrics_path: '/metrics'
```

## Grafana Dashboard JSON

**×§×•×‘×¥:** `grafana-dashboards/search-dashboard.json`

```json
{
  "dashboard": {
    "title": "Search Engine Monitoring",
    "panels": [
      {
        "title": "Search Requests Rate",
        "targets": [
          {
            "expr": "rate(search_requests_total[5m])"
          }
        ]
      },
      {
        "title": "Search Duration",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, search_duration_seconds_bucket)"
          }
        ]
      },
      {
        "title": "Cache Hit Rate",
        "targets": [
          {
            "expr": "rate(search_cache_hits_total[5m]) / (rate(search_cache_hits_total[5m]) + rate(search_cache_misses_total[5m]))"
          }
        ]
      },
      {
        "title": "Active Indexes",
        "targets": [
          {
            "expr": "search_active_indexes"
          }
        ]
      }
    ]
  }
}
```

## ×¡×™×›×•×

×”×¤×™×¦'×¨ ××•×¡×™×£ ×¢×¨×š ××©××¢×•×ª×™ ×œ××¢×¨×›×ª ×•×××¤×©×¨ ×œ××©×ª××©×™× ×œ××¦×•× ×‘××”×™×¨×•×ª ×§×•×“ ×•×˜×§×¡×˜ ×‘×›×œ ×”×§×‘×¦×™× ×©×œ×”×. ×”××™××•×© ×›×•×œ×œ:

### ×¨××ª ×”×‘×¡×™×¡
- ×—×™×¤×•×© ×’×œ×•×‘×œ×™ ××œ× ×‘×›×œ ×”×§×‘×¦×™×
- ×ª××™×›×” ×‘×¡×•×’×™ ×—×™×¤×•×© ××’×•×•× ×™×
- ×××©×§ ××©×ª××© ××™× ×˜×•××™×˜×™×‘×™
- ×”×¦×¢×•×ª ××•×˜×•××˜×™×•×ª ×•×¡×™× ×•×Ÿ ××ª×§×“×

### ×¨××ª Production
- **Rate Limiting** - ×× ×™×¢×ª × ×™×¦×•×œ ×œ×¨×¢×”
- **Caching** - ×©×™×¤×•×¨ ×‘×™×¦×•×¢×™× ××©××¢×•×ª×™
- **Retry Logic** - ×˜×™×¤×•×œ ×‘×›×©×œ×™× ×–×× ×™×™×
- **Error Monitoring** - ××¢×§×‘ ××—×¨ ×‘×¢×™×•×ª ×‘×–××Ÿ ×××ª
- **Metrics & Monitoring** - × ×™×˜×•×¨ ×‘×™×¦×•×¢×™× ××œ×
- **Health Checks** - ×‘×“×™×§×•×ª ×ª×§×™× ×•×ª ××•×˜×•××˜×™×•×ª
- **Admin Dashboard** - ×××©×§ × ×™×”×•×œ ×œ×¡×˜×˜×™×¡×˜×™×§×•×ª

### ×–×× ×™ ×¤×™×ª×•×— ××©×•×¢×¨×™×
- **××™××•×© ×‘×¡×™×¡×™**: 2-3 ×™××™×
- **×ª×•×¡×¤×•×ª Production**: 1-2 ×™××™× × ×•×¡×¤×™×
- **×¡×”"×›**: 3-5 ×™××™× ×œ×¤×ª×¨×•×Ÿ ××œ×

### ××•×¨×›×‘×•×ª
- **×‘×¡×™×¡**: ×‘×™× ×•× ×™×ª
- **Production Features**: ×‘×™× ×•× ×™×ª-×’×‘×•×”×”

### ×”×©×¤×¢×”
- **×—×•×•×™×™×ª ××©×ª××©**: ×’×‘×•×”×” ×××•×“
- **×‘×™×¦×•×¢×™×**: ×©×™×¤×•×¨ ××©××¢×•×ª×™ ×¢× caching
- **×××™× ×•×ª**: ×’×‘×•×”×” ×××•×“ ×¢× monitoring ×•-retry logic

×”××™××•×© ×”××œ× ×”×•×¤×š ××ª ×”×¤×™×¦'×¨ ×"×¢×•×‘×“" ×œ"production-ready" ×¢× ×›×œ ××” ×©× ×“×¨×© ×œ××¢×¨×›×ª ××§×¦×•×¢×™×ª ×•×××™× ×”.