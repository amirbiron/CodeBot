# ××“×¨×™×š ××™××•×©: ×¤×ª×§×™× ×“×‘×™×§×™× ××™× ×œ×™×™×Ÿ ×‘×ª×¦×•×’×ª Markdown

## ğŸ“Œ ×¡×§×™×¨×” ×›×œ×œ×™×ª

### ××˜×¨×ª ×”×¤×™×¦'×¨
×”×•×¡×¤×ª ××¢×¨×›×ª ×¤×ª×§×™× ×“×‘×™×§×™× (Sticky Notes) ××™× ×œ×™×™×Ÿ ×œ×ª×¦×•×’×ª Markdown (`md_preview.html`), ×”×××¤×©×¨×ª ×œ××©×ª××©×™× ×œ×”×•×¡×™×£ ×”×¢×¨×•×ª ××™×©×™×•×ª ×¢×œ ×’×‘×™ ××¡××›×™× ×œ×œ× ×¢×¨×™×›×ª ×”×§×•×‘×¥ ×”××§×•×¨×™.

### ×™×ª×¨×•× ×•×ª ××¨×›×–×™×™×
- **×¨×™×©×•× ×”×¢×¨×•×ª ××”×™×¨** - ×œ×œ× ×¦×•×¨×š ×‘×¢×¨×™×›×ª ×”××¡××š
- **×”×§×©×¨ ×•×™×–×•××œ×™** - ×”×¤×ª×§×™× ××¢×•×’× ×™× ×œ×©×•×¨×•×ª ×¡×¤×¦×™×¤×™×•×ª
- **××™×©×™ ×•×¤×¨×˜×™** - ×›×œ ××©×ª××© ×¨×•××” ×¨×§ ××ª ×”×¤×ª×§×™× ×©×œ×•
- **×××©×§ × ×•×—** - ×’×¨×™×¨×”, ×©×™× ×•×™ ×’×•×“×œ ×•××™×–×¢×•×¨

### ××’×‘×œ×•×ª ×•×¡×§×•×¤
- **×ª×¦×•×’×ª Markdown ×‘×œ×‘×“** - ×œ× ×‘×¢×•×¨×š ×”×˜×§×¡×˜ ××• ×‘×§×‘×¦×™ ×§×•×“
- **×¤×¨-××©×ª××© ×•×¤×¨-×§×•×‘×¥** - ×œ×œ× ×©×™×ª×•×£ ×‘×™×Ÿ ××©×ª××©×™×
- **×œ×œ× ×¡× ×›×¨×•×Ÿ ×‘×–××Ÿ ×××ª** - ×¢×“×›×•×Ÿ ×‘×˜×¢×™× ×” ××—×“×©
- **×œ× ×›×œ×•×œ ×‘×™×™×¦×•×** - ×œ× ××•×“×¤×¡ ××• ××™×•×¦× ×¢× ×”××¡××š

---

## ğŸ—ï¸ ××¨×›×™×˜×§×˜×•×¨×ª ×”××¢×¨×›×ª

### ×¨×›×™×‘×™× ×¢×™×§×¨×™×™×

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Frontend (Client)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ StickyNotes  â”‚  â”‚  NoteEditor â”‚              â”‚
â”‚  â”‚   Manager    â”‚  â”‚  Component  â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚         â”‚                 â”‚                      â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                  â–¼                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚   LocalStorage / IndexedDB   â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Backend (Server)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  Notes API   â”‚  â”‚   Database  â”‚              â”‚
â”‚  â”‚  Endpoint    â”‚  â”‚   (SQLite)  â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ××•×“×œ × ×ª×•× ×™×

```typescript
interface StickyNote {
  id: string;              // UUID
  user_id: number;         // ××–×”×” ××©×ª××©
  file_path: string;       // × ×ª×™×‘ ×”×§×•×‘×¥ ×”××œ×
  content: string;         // ×ª×•×›×Ÿ ×”×¤×ª×§
  line_start: number;      // ×©×•×¨×ª ×”×ª×—×œ×”
  line_end?: number;       // ×©×•×¨×ª ×¡×™×•× (××•×¤×¦×™×•× ×œ×™)
  position: {              // ××™×§×•× ×¢×œ ×”××¡×š
    x: number;
    y: number;
  };
  size: {                  // ×’×•×“×œ ×”×¤×ª×§
    width: number;
    height: number;
  };
  color: string;           // ×¦×‘×¢ ×¨×§×¢ (#FFFFCC)
  is_minimized: boolean;   // ×¡×˜×˜×•×¡ ××™×–×¢×•×¨
  created_at: string;      // ISO 8601
  updated_at: string;      // ISO 8601
}
```

---

## ğŸ’¾ ××™××•×© Backend

### 1. ×¡×›××ª ××¡×“ × ×ª×•× ×™×

```sql
CREATE TABLE IF NOT EXISTS sticky_notes (
    id TEXT PRIMARY KEY,
    user_id INTEGER NOT NULL,
    file_path TEXT NOT NULL,
    content TEXT NOT NULL,
    line_start INTEGER NOT NULL,
    line_end INTEGER,
    position_x INTEGER DEFAULT 100,
    position_y INTEGER DEFAULT 100,
    width INTEGER DEFAULT 250,
    height INTEGER DEFAULT 200,
    color TEXT DEFAULT '#FFFFCC',
    is_minimized BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    INDEX idx_user_file (user_id, file_path)
);
```

### 2. API Endpoints

```python
# webapp/api/sticky_notes.py

from flask import Blueprint, request, jsonify, g
from database import get_db
import uuid
from datetime import datetime

sticky_notes_bp = Blueprint('sticky_notes', __name__)

@sticky_notes_bp.route('/api/notes/<file_path>', methods=['GET'])
@require_auth
def get_notes(file_path):
    """×§×‘×œ×ª ×›×œ ×”×¤×ª×§×™× ×©×œ ×”××©×ª××© ×œ×§×•×‘×¥ ××¡×•×™×"""
    db = get_db()
    notes = db.execute("""
        SELECT * FROM sticky_notes 
        WHERE user_id = ? AND file_path = ?
        ORDER BY line_start, created_at
    """, (g.user['id'], file_path)).fetchall()
    
    return jsonify([dict(note) for note in notes])

@sticky_notes_bp.route('/api/notes', methods=['POST'])
@require_auth
def create_note():
    """×™×¦×™×¨×ª ×¤×ª×§ ×—×“×©"""
    data = request.json
    note_id = str(uuid.uuid4())
    
    db = get_db()
    db.execute("""
        INSERT INTO sticky_notes (
            id, user_id, file_path, content, 
            line_start, line_end, position_x, position_y,
            width, height, color, is_minimized
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    """, (
        note_id,
        g.user['id'],
        data['file_path'],
        data['content'],
        data['line_start'],
        data.get('line_end'),
        data.get('position', {}).get('x', 100),
        data.get('position', {}).get('y', 100),
        data.get('size', {}).get('width', 250),
        data.get('size', {}).get('height', 200),
        data.get('color', '#FFFFCC'),
        False
    ))
    db.commit()
    
    return jsonify({'id': note_id}), 201

@sticky_notes_bp.route('/api/notes/<note_id>', methods=['PUT'])
@require_auth
def update_note(note_id):
    """×¢×“×›×•×Ÿ ×¤×ª×§ ×§×™×™×"""
    data = request.json
    db = get_db()
    
    # ×•×™×“×•× ×‘×¢×œ×•×ª
    note = db.execute(
        "SELECT * FROM sticky_notes WHERE id = ? AND user_id = ?",
        (note_id, g.user['id'])
    ).fetchone()
    
    if not note:
        return jsonify({'error': 'Note not found'}), 404
    
    # ×¢×“×›×•×Ÿ ×”×©×“×•×ª
    db.execute("""
        UPDATE sticky_notes 
        SET content = ?, 
            position_x = ?, 
            position_y = ?,
            width = ?, 
            height = ?,
            is_minimized = ?,
            updated_at = CURRENT_TIMESTAMP
        WHERE id = ? AND user_id = ?
    """, (
        data.get('content', note['content']),
        data.get('position', {}).get('x', note['position_x']),
        data.get('position', {}).get('y', note['position_y']),
        data.get('size', {}).get('width', note['width']),
        data.get('size', {}).get('height', note['height']),
        data.get('is_minimized', note['is_minimized']),
        note_id,
        g.user['id']
    ))
    db.commit()
    
    return jsonify({'success': True})

@sticky_notes_bp.route('/api/notes/<note_id>', methods=['DELETE'])
@require_auth
def delete_note(note_id):
    """××—×™×§×ª ×¤×ª×§"""
    db = get_db()
    
    result = db.execute(
        "DELETE FROM sticky_notes WHERE id = ? AND user_id = ?",
        (note_id, g.user['id'])
    )
    db.commit()
    
    if result.rowcount == 0:
        return jsonify({'error': 'Note not found'}), 404
    
    return jsonify({'success': True})
```

---

## ğŸ¨ ××™××•×© Frontend

### 1. ×× ×”×œ ×”×¤×ª×§×™× ×”×¨××©×™

```javascript
// webapp/static/js/sticky-notes.js

class StickyNotesManager {
    constructor(filePath, userId) {
        this.filePath = filePath;
        this.userId = userId;
        this.notes = new Map();
        this.activeNote = null;
        this.lineOffsets = new Map(); // ××™×¤×•×™ ×©×•×¨×•×ª ×œ××™×§×•× ×‘×“×£
        
        this.init();
    }
    
    async init() {
        // ×—×™×©×•×‘ ××™×§×•××™ ×”×©×•×¨×•×ª ×‘×“×£
        this.calculateLineOffsets();
        
        // ×˜×¢×™× ×ª ×¤×ª×§×™× ×§×™×™××™×
        await this.loadNotes();
        
        // ×™×¦×™×¨×ª ×›×¤×ª×•×¨ FAB
        this.createFAB();
        
        // ×”××–× ×” ×œ××™×¨×•×¢×™ ×’×œ×™×œ×”
        this.attachScrollListener();
        
        // ×”××–× ×” ×œ×©×™× ×•×™ ×’×•×“×œ ×”×—×œ×•×Ÿ
        window.addEventListener('resize', () => this.recalculatePositions());
    }
    
    calculateLineOffsets() {
        // ××¦×™××ª ×›×œ ××œ×× ×˜×™ ×”×©×•×¨×•×ª ×‘××¡××š
        const lineElements = document.querySelectorAll('[data-line-number]');
        lineElements.forEach(el => {
            const lineNum = parseInt(el.dataset.lineNumber);
            const rect = el.getBoundingClientRect();
            this.lineOffsets.set(lineNum, {
                top: rect.top + window.scrollY,
                left: rect.left,
                height: rect.height
            });
        });
    }
    
    async loadNotes() {
        try {
            const response = await fetch(`/api/notes/${encodeURIComponent(this.filePath)}`);
            const notes = await response.json();
            
            notes.forEach(noteData => {
                this.createNoteElement(noteData);
            });
        } catch (error) {
            console.error('Failed to load notes:', error);
        }
    }
    
    createFAB() {
        const fab = document.createElement('button');
        fab.className = 'sticky-note-fab';
        fab.innerHTML = 'â•';
        fab.title = '×”×•×¡×£ ×¤×ª×§ ×“×‘×™×§';
        fab.onclick = () => this.createNewNote();
        
        document.body.appendChild(fab);
    }
    
    async createNewNote() {
        // ×–×™×”×•×™ ×”×©×•×¨×” ×”× ×•×›×—×™×ª ×‘×”×ª×× ×œ×’×œ×™×œ×”
        const currentLine = this.getCurrentVisibleLine();
        
        const noteData = {
            file_path: this.filePath,
            line_start: currentLine,
            content: '',
            position: { x: 100, y: window.scrollY + 100 },
            size: { width: 250, height: 200 },
            color: '#FFFFCC'
        };
        
        // ×©×œ×™×—×” ×œ×©×¨×ª
        const response = await fetch('/api/notes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(noteData)
        });
        
        const result = await response.json();
        noteData.id = result.id;
        
        // ×™×¦×™×¨×ª ×”××œ×× ×˜
        const noteElement = this.createNoteElement(noteData);
        noteElement.querySelector('textarea').focus();
    }
    
    createNoteElement(noteData) {
        const note = new StickyNote(noteData, this);
        this.notes.set(noteData.id, note);
        return note.element;
    }
    
    getCurrentVisibleLine() {
        const scrollTop = window.scrollY;
        const viewportHeight = window.innerHeight;
        const midPoint = scrollTop + (viewportHeight / 2);
        
        let closestLine = 1;
        let minDistance = Infinity;
        
        this.lineOffsets.forEach((offset, lineNum) => {
            const distance = Math.abs(offset.top - midPoint);
            if (distance < minDistance) {
                minDistance = distance;
                closestLine = lineNum;
            }
        });
        
        return closestLine;
    }
    
    attachScrollListener() {
        let scrollTimeout;
        window.addEventListener('scroll', () => {
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(() => {
                this.updateNotesVisibility();
            }, 100);
        });
    }
    
    updateNotesVisibility() {
        const scrollTop = window.scrollY;
        const viewportHeight = window.innerHeight;
        
        this.notes.forEach(note => {
            const lineOffset = this.lineOffsets.get(note.data.line_start);
            if (lineOffset) {
                const isVisible = lineOffset.top >= scrollTop && 
                                 lineOffset.top <= scrollTop + viewportHeight;
                note.setVisible(isVisible);
            }
        });
    }
    
    recalculatePositions() {
        this.calculateLineOffsets();
        this.notes.forEach(note => note.updatePosition());
    }
    
    async deleteNote(noteId) {
        if (!confirm('×”×× ×œ××—×•×§ ××ª ×”×¤×ª×§?')) {
            return;
        }
        
        try {
            await fetch(`/api/notes/${noteId}`, { method: 'DELETE' });
            const note = this.notes.get(noteId);
            if (note) {
                note.destroy();
                this.notes.delete(noteId);
            }
        } catch (error) {
            console.error('Failed to delete note:', error);
        }
    }
}
```

### 2. ××—×œ×§×ª ×”×¤×ª×§ ×”×‘×•×“×“

```javascript
// webapp/static/js/sticky-note.js

class StickyNote {
    constructor(data, manager) {
        this.data = data;
        this.manager = manager;
        this.element = null;
        this.isDragging = false;
        this.isResizing = false;
        this.dragOffset = { x: 0, y: 0 };
        this.saveTimeout = null;
        
        this.create();
    }
    
    create() {
        // ×™×¦×™×¨×ª ××‘× ×” ×”-DOM
        this.element = document.createElement('div');
        this.element.className = 'sticky-note';
        this.element.dataset.noteId = this.data.id;
        this.element.style.cssText = `
            position: absolute;
            left: ${this.data.position.x}px;
            top: ${this.data.position.y}px;
            width: ${this.data.size.width}px;
            height: ${this.data.size.height}px;
            background-color: ${this.data.color};
            box-shadow: 2px 2px 10px rgba(0,0,0,0.2);
            border: 1px solid #E6D600;
            border-radius: 3px;
            padding: 10px;
            z-index: 1000;
            display: ${this.data.is_minimized ? 'none' : 'flex'};
            flex-direction: column;
        `;
        
        // ×›×•×ª×¨×ª ×•×¤×§×“×™×
        const header = document.createElement('div');
        header.className = 'sticky-note-header';
        header.style.cssText = `
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            cursor: move;
            user-select: none;
        `;
        
        const title = document.createElement('span');
        title.textContent = `×©×•×¨×” ${this.data.line_start}`;
        title.style.fontSize = '12px';
        title.style.color = '#666';
        
        const controls = document.createElement('div');
        controls.className = 'sticky-note-controls';
        
        // ×›×¤×ª×•×¨ ××™×–×¢×•×¨
        const minimizeBtn = document.createElement('button');
        minimizeBtn.innerHTML = 'âˆ’';
        minimizeBtn.className = 'sticky-note-btn minimize';
        minimizeBtn.onclick = () => this.toggleMinimize();
        
        // ×›×¤×ª×•×¨ ××—×™×§×”
        const deleteBtn = document.createElement('button');
        deleteBtn.innerHTML = 'Ã—';
        deleteBtn.className = 'sticky-note-btn delete';
        deleteBtn.onclick = () => this.manager.deleteNote(this.data.id);
        
        controls.appendChild(minimizeBtn);
        controls.appendChild(deleteBtn);
        header.appendChild(title);
        header.appendChild(controls);
        
        // ××–×•×¨ ×ª×•×›×Ÿ
        const content = document.createElement('textarea');
        content.className = 'sticky-note-content';
        content.value = this.data.content;
        content.placeholder = '×”×§×œ×“ ×”×¢×¨×”...';
        content.style.cssText = `
            flex: 1;
            border: none;
            background: transparent;
            resize: none;
            outline: none;
            font-family: inherit;
            font-size: 14px;
        `;
        
        // ×”××–× ×” ×œ×©×™× ×•×™×™×
        content.addEventListener('input', () => this.handleContentChange());
        
        // ×™×“×™×ª ×’×¨×™×¨×ª ×’×•×“×œ
        const resizeHandle = document.createElement('div');
        resizeHandle.className = 'sticky-note-resize';
        resizeHandle.style.cssText = `
            position: absolute;
            bottom: 0;
            right: 0;
            width: 15px;
            height: 15px;
            cursor: nwse-resize;
            background: linear-gradient(135deg, transparent 50%, #ccc 50%);
        `;
        
        // ×”×¨×›×‘×ª ×”××œ×× ×˜×™×
        this.element.appendChild(header);
        this.element.appendChild(content);
        this.element.appendChild(resizeHandle);
        
        // ×”×•×¡×¤×” ×œ××¡××š
        document.body.appendChild(this.element);
        
        // ××™×¨×•×¢×™ ×’×¨×™×¨×”
        this.attachDragEvents(header);
        this.attachResizeEvents(resizeHandle);
        
        // ×× ×××•×–×¢×¨, ×”×¦×’ ×¨×§ ×›×•×ª×¨×ª
        if (this.data.is_minimized) {
            this.minimize();
        }
    }
    
    attachDragEvents(header) {
        header.addEventListener('mousedown', (e) => {
            this.isDragging = true;
            this.dragOffset = {
                x: e.clientX - this.element.offsetLeft,
                y: e.clientY - this.element.offsetTop
            };
            
            this.element.style.zIndex = '1001';
            e.preventDefault();
        });
        
        document.addEventListener('mousemove', (e) => {
            if (!this.isDragging) return;
            
            const newX = e.clientX - this.dragOffset.x;
            const newY = e.clientY - this.dragOffset.y;
            
            this.element.style.left = `${newX}px`;
            this.element.style.top = `${newY}px`;
            
            this.data.position = { x: newX, y: newY };
            this.scheduleSave();
        });
        
        document.addEventListener('mouseup', () => {
            if (this.isDragging) {
                this.isDragging = false;
                this.element.style.zIndex = '1000';
            }
        });
    }
    
    attachResizeEvents(handle) {
        handle.addEventListener('mousedown', (e) => {
            this.isResizing = true;
            this.resizeStart = {
                x: e.clientX,
                y: e.clientY,
                width: this.element.offsetWidth,
                height: this.element.offsetHeight
            };
            e.preventDefault();
            e.stopPropagation();
        });
        
        document.addEventListener('mousemove', (e) => {
            if (!this.isResizing) return;
            
            const newWidth = this.resizeStart.width + (e.clientX - this.resizeStart.x);
            const newHeight = this.resizeStart.height + (e.clientY - this.resizeStart.y);
            
            this.element.style.width = `${Math.max(150, newWidth)}px`;
            this.element.style.height = `${Math.max(100, newHeight)}px`;
            
            this.data.size = {
                width: Math.max(150, newWidth),
                height: Math.max(100, newHeight)
            };
            
            this.scheduleSave();
        });
        
        document.addEventListener('mouseup', () => {
            this.isResizing = false;
        });
    }
    
    handleContentChange() {
        const textarea = this.element.querySelector('textarea');
        this.data.content = textarea.value;
        this.scheduleSave();
    }
    
    scheduleSave() {
        clearTimeout(this.saveTimeout);
        this.saveTimeout = setTimeout(() => this.save(), 500);
    }
    
    async save() {
        try {
            await fetch(`/api/notes/${this.data.id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(this.data)
            });
        } catch (error) {
            console.error('Failed to save note:', error);
        }
    }
    
    toggleMinimize() {
        if (this.data.is_minimized) {
            this.expand();
        } else {
            this.minimize();
        }
    }
    
    minimize() {
        this.data.is_minimized = true;
        this.element.style.height = '30px';
        this.element.querySelector('textarea').style.display = 'none';
        this.element.querySelector('.sticky-note-resize').style.display = 'none';
        this.element.querySelector('.minimize').innerHTML = 'â–¡';
        this.scheduleSave();
    }
    
    expand() {
        this.data.is_minimized = false;
        this.element.style.height = `${this.data.size.height}px`;
        this.element.querySelector('textarea').style.display = 'block';
        this.element.querySelector('.sticky-note-resize').style.display = 'block';
        this.element.querySelector('.minimize').innerHTML = 'âˆ’';
        this.scheduleSave();
    }
    
    setVisible(isVisible) {
        this.element.style.display = isVisible ? 
            (this.data.is_minimized ? 'block' : 'flex') : 'none';
    }
    
    updatePosition() {
        const lineOffset = this.manager.lineOffsets.get(this.data.line_start);
        if (lineOffset) {
            // ×¢×“×›×•×Ÿ ××™×§×•× ×× ×›×™ ×‘×”×ª×× ×œ×©×•×¨×”
            const relativeY = this.data.position.y - lineOffset.top;
            this.element.style.top = `${lineOffset.top + relativeY}px`;
        }
    }
    
    destroy() {
        this.element.remove();
    }
}
```

### 3. ×¡×’× ×•× ×•×ª CSS

```css
/* webapp/static/css/sticky-notes.css */

/* ×›×¤×ª×•×¨ FAB ×œ×™×¦×™×¨×ª ×¤×ª×§ */
.sticky-note-fab {
    position: fixed;
    left: 20px;
    top: 50%;
    transform: translateY(-50%);
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: #FFD700;
    color: #333;
    border: 2px solid #FFC700;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    font-size: 24px;
    cursor: pointer;
    transition: all 0.3s ease;
    z-index: 999;
}

.sticky-note-fab:hover {
    background: #FFC700;
    transform: translateY(-50%) scale(1.1);
    box-shadow: 0 6px 8px rgba(0,0,0,0.15);
}

/* ×¡×’× ×•×Ÿ ×”×¤×ª×§ */
.sticky-note {
    font-family: 'Segoe UI', Tahoma, sans-serif;
    transition: opacity 0.3s ease;
}

.sticky-note:hover {
    box-shadow: 3px 3px 15px rgba(0,0,0,0.3);
}

.sticky-note-header {
    border-bottom: 1px solid rgba(0,0,0,0.1);
    padding-bottom: 5px;
}

.sticky-note-controls {
    display: flex;
    gap: 5px;
}

.sticky-note-btn {
    width: 20px;
    height: 20px;
    border: none;
    background: transparent;
    cursor: pointer;
    font-size: 16px;
    line-height: 1;
    color: #666;
    transition: color 0.2s ease;
}

.sticky-note-btn:hover {
    color: #333;
}

.sticky-note-btn.delete:hover {
    color: #d32f2f;
}

.sticky-note-content {
    padding: 5px;
    line-height: 1.4;
}

.sticky-note-resize {
    opacity: 0.5;
    transition: opacity 0.2s ease;
}

.sticky-note:hover .sticky-note-resize {
    opacity: 1;
}

/* ×× ×™××¦×™×•×ª */
@keyframes noteAppear {
    from {
        opacity: 0;
        transform: scale(0.8);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

.sticky-note {
    animation: noteAppear 0.3s ease-out;
}

/* ×ª××™×›×” ×‘-Dark Mode */
@media (prefers-color-scheme: dark) {
    .sticky-note {
        background-color: #3a3a3a !important;
        border-color: #555 !important;
        color: #e0e0e0;
    }
    
    .sticky-note-btn {
        color: #aaa;
    }
    
    .sticky-note-btn:hover {
        color: #fff;
    }
    
    .sticky-note-fab {
        background: #555;
        border-color: #666;
        color: #e0e0e0;
    }
}

/* ×”×“×¤×¡×” - ×”×¡×ª×¨×ª ×¤×ª×§×™× */
@media print {
    .sticky-note,
    .sticky-note-fab {
        display: none !important;
    }
}
```

### 4. ××ª×—×•×œ ×‘××¡××š HTML

```html
<!-- webapp/templates/md_preview.html -->

<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>{{ title }}</title>
    <link rel="stylesheet" href="/static/css/markdown.css">
    <link rel="stylesheet" href="/static/css/sticky-notes.css">
</head>
<body>
    <div id="markdown-content">
        <!-- ×ª×•×›×Ÿ ×”-Markdown ×¢× ××¡×¤×¨×™ ×©×•×¨×•×ª -->
        {{ rendered_markdown|safe }}
    </div>
    
    <!-- ×¡×§×¨×™×¤×˜×™× -->
    <script src="/static/js/sticky-note.js"></script>
    <script src="/static/js/sticky-notes.js"></script>
    
    <script>
        // ××ª×—×•×œ ××¢×¨×›×ª ×”×¤×ª×§×™×
        document.addEventListener('DOMContentLoaded', () => {
            const filePath = '{{ file_path }}';
            const userId = {{ current_user.id }};
            
            // ×™×¦×™×¨×ª ×× ×”×œ ×”×¤×ª×§×™×
            window.stickyNotesManager = new StickyNotesManager(filePath, userId);
        });
    </script>
</body>
</html>
```

---

## ğŸ”§ ××•×¤×˜×™××™×–×¦×™×•×ª ×•×˜×™×¤×™×

### 1. ×©××™×¨×ª × ×ª×•× ×™× ××§×•××™×ª

```javascript
// ×©××™×¨×” ×‘-LocalStorage ×œ×‘×™×¦×•×¢×™× ××©×•×¤×¨×™×
class LocalStorageCache {
    constructor(userId, filePath) {
        this.key = `sticky-notes-${userId}-${filePath}`;
    }
    
    save(notes) {
        localStorage.setItem(this.key, JSON.stringify(notes));
    }
    
    load() {
        const cached = localStorage.getItem(this.key);
        return cached ? JSON.parse(cached) : [];
    }
    
    clear() {
        localStorage.removeItem(this.key);
    }
}
```

### 2. Debouncing ×œ×©××™×¨×”

```javascript
class DebouncedSave {
    constructor(saveFunction, delay = 500) {
        this.saveFunction = saveFunction;
        this.delay = delay;
        this.timeout = null;
        this.pending = new Map();
    }
    
    schedule(noteId, data) {
        this.pending.set(noteId, data);
        
        clearTimeout(this.timeout);
        this.timeout = setTimeout(() => {
            this.flush();
        }, this.delay);
    }
    
    async flush() {
        if (this.pending.size === 0) return;
        
        const batch = Array.from(this.pending.entries());
        this.pending.clear();
        
        // ×©××™×¨×” ×‘×¦'×× ×§ ××—×“
        await this.saveFunction(batch);
    }
}
```

### 3. ×× ×™×¢×ª ×”×ª× ×’×©×•×™×•×ª

```javascript
// × ×¢×™×œ×” ××•×¤×˜×™××™×¡×˜×™×ª ×œ×× ×™×¢×ª ×“×¨×™×¡×•×ª
class OptimisticLocking {
    constructor() {
        this.versions = new Map();
    }
    
    async updateNote(noteId, data) {
        const currentVersion = this.versions.get(noteId) || 0;
        
        const response = await fetch(`/api/notes/${noteId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'If-Match': currentVersion.toString()
            },
            body: JSON.stringify(data)
        });
        
        if (response.status === 409) {
            // ×§×•× ×¤×œ×™×§×˜ - ×˜×¢×Ÿ ××—×“×©
            await this.reloadNote(noteId);
            throw new Error('Conflict detected, please retry');
        }
        
        const newVersion = response.headers.get('ETag');
        this.versions.set(noteId, parseInt(newVersion));
    }
}
```

---

## ğŸš€ ×”×¨×—×‘×•×ª ×¢×ª×™×“×™×•×ª

### 1. ×ª××™×›×” ×‘-Markdown ×‘×ª×•×š ×¤×ª×§×™×
```javascript
// ×©×™××•×© ×‘-marked.js ×œ×¨×™× ×“×•×¨ Markdown
const renderedContent = marked.parse(noteContent);
```

### 2. ×ª×’×™×•×ª ×•×§×˜×’×•×¨×™×•×ª
```sql
ALTER TABLE sticky_notes ADD COLUMN tags TEXT;
ALTER TABLE sticky_notes ADD COLUMN category TEXT;
```

### 3. ×—×™×¤×•×© ×‘×¤×ª×§×™×
```python
@sticky_notes_bp.route('/api/notes/search', methods=['GET'])
def search_notes():
    query = request.args.get('q')
    results = db.execute("""
        SELECT * FROM sticky_notes 
        WHERE user_id = ? AND content LIKE ?
    """, (g.user['id'], f'%{query}%'))
    return jsonify([dict(r) for r in results])
```

### 4. ×™×™×¦×•× ×¤×ª×§×™×
```javascript
function exportNotes() {
    const notes = Array.from(manager.notes.values());
    const data = notes.map(n => ({
        line: n.data.line_start,
        content: n.data.content
    }));
    
    const blob = new Blob([JSON.stringify(data, null, 2)], 
                          {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `notes-${filePath}.json`;
    a.click();
}
```

### 5. ×©×™×ª×•×£ ×¤×ª×§×™× (××—×•×¥ ×œ×¡×§×•×¤ ×”× ×•×›×—×™)
```python
# ×˜×‘×œ×ª ×©×™×ª×•×£
CREATE TABLE note_sharing (
    note_id TEXT,
    shared_with_user_id INTEGER,
    permission TEXT DEFAULT 'read',
    FOREIGN KEY (note_id) REFERENCES sticky_notes(id),
    FOREIGN KEY (shared_with_user_id) REFERENCES users(id)
);
```

---

## ğŸ”’ ××‘×˜×—×”

### ×‘×“×™×§×•×ª ×—×©×•×‘×•×ª

1. **××™××•×ª ××©×ª××©** - ×›×œ ×¤×¢×•×œ×” ××•×•×“××ª ×–×”×•×ª ×”××©×ª××©
2. **×‘×¢×œ×•×ª ×¢×œ ×¤×ª×§×™×** - ××©×ª××© ×™×›×•×œ ×œ×¢×¨×•×š ×¨×§ ×¤×ª×§×™× ×©×œ×•
3. **×¡× ×™×˜×¦×™×”** - × ×™×§×•×™ ×ª×•×›×Ÿ ×”×¤×ª×§×™× ××¤× ×™ XSS
4. **Rate Limiting** - ×”×’×‘×œ×ª ×›××•×ª ×”×¤×ª×§×™× ×•×”×¢×“×›×•× ×™×

```python
# middleware ×œ××™××•×ª
def require_auth(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if not g.user:
            return jsonify({'error': 'Authentication required'}), 401
        return f(*args, **kwargs)
    return decorated_function

# ×¡× ×™×˜×¦×™×”
import bleach
def sanitize_content(content):
    return bleach.clean(content, tags=[], strip=True)
```

---

## âœ… ×‘×“×™×§×•×ª

### ×‘×“×™×§×•×ª ×™×—×™×“×”

```python
# tests/test_sticky_notes.py

def test_create_note(client, auth):
    auth.login()
    response = client.post('/api/notes', json={
        'file_path': '/test.md',
        'content': 'Test note',
        'line_start': 10
    })
    assert response.status_code == 201
    assert 'id' in response.json

def test_unauthorized_access(client):
    response = client.get('/api/notes/test.md')
    assert response.status_code == 401

def test_note_isolation(client, auth, other_user):
    # ××©×ª××© A ×™×•×¦×¨ ×¤×ª×§
    auth.login()
    note_id = create_note(client)
    
    # ××©×ª××© B ×œ× ×™×›×•×œ ×œ×¨××•×ª ××•×ª×•
    auth.logout()
    other_user.login()
    response = client.get(f'/api/notes/{note_id}')
    assert response.status_code == 404
```

### ×‘×“×™×§×•×ª E2E

```javascript
// tests/e2e/sticky-notes.test.js

describe('Sticky Notes', () => {
    it('should create a new note on FAB click', async () => {
        await page.click('.sticky-note-fab');
        const note = await page.$('.sticky-note');
        expect(note).toBeTruthy();
    });
    
    it('should save content on blur', async () => {
        const note = await createNote();
        await note.type('textarea', 'Test content');
        await page.click('body'); // Trigger blur
        
        await page.reload();
        const content = await page.$eval('textarea', el => el.value);
        expect(content).toBe('Test content');
    });
    
    it('should drag note to new position', async () => {
        const note = await createNote();
        const initialPos = await note.boundingBox();
        
        await page.mouse.drag(
            {x: initialPos.x + 10, y: initialPos.y + 10},
            {x: initialPos.x + 100, y: initialPos.y + 100}
        );
        
        const newPos = await note.boundingBox();
        expect(newPos.x).toBeGreaterThan(initialPos.x);
    });
});
```

---

## ğŸ“‹ ×¦'×§×œ×™×¡×˜ ×œ××™××•×©

### ×©×œ×‘ 1: ×ª×©×ª×™×ª (Backend)
- [ ] ×™×¦×™×¨×ª ×˜×‘×œ×ª `sticky_notes` ×‘××¡×“ ×”× ×ª×•× ×™×
- [ ] ××™××•×© API endpoints (GET, POST, PUT, DELETE)
- [ ] ×”×•×¡×¤×ª middleware ×œ××™××•×ª
- [ ] ×‘×“×™×§×•×ª ×™×—×™×“×” ×œ-API

### ×©×œ×‘ 2: ×××©×§ ××©×ª××© (Frontend)
- [ ] ×™×¦×™×¨×ª ××—×œ×§×ª `StickyNotesManager`
- [ ] ×™×¦×™×¨×ª ××—×œ×§×ª `StickyNote`
- [ ] ×”×•×¡×¤×ª ×¡×’× ×•× ×•×ª CSS
- [ ] ××™× ×˜×’×¨×¦×™×” ×¢× `md_preview.html`

### ×©×œ×‘ 3: ×¤×™×¦'×¨×™× ×‘×¡×™×¡×™×™×
- [ ] ×™×¦×™×¨×ª ×¤×ª×§×™× ×—×“×©×™×
- [ ] ×¢×¨×™×›×ª ×ª×•×›×Ÿ
- [ ] ×’×¨×™×¨×ª ×¤×ª×§×™×
- [ ] ×©×™× ×•×™ ×’×•×“×œ
- [ ] ××™×–×¢×•×¨/×”×¨×—×‘×”
- [ ] ××—×™×§×ª ×¤×ª×§×™×

### ×©×œ×‘ 4: ××•×¤×˜×™××™×–×¦×™×•×ª
- [ ] Debouncing ×œ×©××™×¨×”
- [ ] LocalStorage caching
- [ ] Lazy loading ×œ×¤×ª×§×™×
- [ ] × ×¢×™×œ×” ××•×¤×˜×™××™×¡×˜×™×ª

### ×©×œ×‘ 5: ×‘×“×™×§×•×ª ×•-QA
- [ ] ×‘×“×™×§×•×ª ×™×—×™×“×”
- [ ] ×‘×“×™×§×•×ª ××™× ×˜×’×¨×¦×™×”
- [ ] ×‘×“×™×§×•×ª E2E
- [ ] ×‘×“×™×§×•×ª ×‘×™×¦×•×¢×™×
- [ ] ×‘×“×™×§×•×ª ××‘×˜×—×”

### ×©×œ×‘ 6: ×ª×™×¢×•×“ ×•×©×™×¤×•×¨×™×
- [ ] ×ª×™×¢×•×“ ×œ××©×ª××©
- [ ] ×ª×™×¢×•×“ ×œ××¤×ª×—×™×
- [ ] ×‘×™×§×•×¨×ª ×§×•×“
- [ ] ××©×•×‘ ××©×ª××©×™×

---

## ğŸ¯ ×¡×™×›×•×

××“×¨×™×š ×–×” ××¡×¤×§ ×ª×›× ×•×Ÿ ××œ× ×œ××™××•×© ×¤×™×¦'×¨ ×”×¤×ª×§×™× ×”×“×‘×™×§×™×. ×”××™××•×© ××ª××§×“ ×‘:

1. **×¤×©×˜×•×ª** - ×××©×§ ××™× ×˜×•××™×˜×™×‘×™ ×•× ×§×™
2. **×‘×™×¦×•×¢×™×** - ×©××™×¨×” ×—×›××” ×•-caching
3. **××‘×˜×—×”** - ×‘×™×“×•×“ ××œ× ×‘×™×Ÿ ××©×ª××©×™×
4. **×’××™×©×•×ª** - ××¤×©×¨×•×ª ×œ×”×¨×—×‘×” ×‘×¢×ª×™×“

×”×¤×™×¦'×¨ ××•×¡×™×£ ×¢×¨×š ××©××¢×•×ª×™ ×œ××©×ª××©×™× ×”××¢×•× ×™×™× ×™× ×œ×”×•×¡×™×£ ×”×¢×¨×•×ª ××™×©×™×•×ª ×œ××¡××›×™ Markdown ×œ×œ× ×¢×¨×™×›×ª ×”×§×‘×¦×™× ×”××§×•×¨×™×™×, ×ª×•×š ×©××™×¨×” ×¢×œ ×—×•×•×™×™×ª ××©×ª××© ×—×œ×§×” ×•××™× ×˜×•××™×˜×™×‘×™×ª.