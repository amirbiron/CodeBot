# ===================================
# Code Keeper Bot - Render Configuration
# בוט שומר קבצי קוד - הגדרות Render
# ===================================

services:
  # ===================================
  # Prometheus (לנטר את ה-WebApp)
  # ===================================
  - type: web
    name: code-keeper-prometheus
    env: docker
    plan: starter
    dockerfilePath: docker/prometheus/Dockerfile
    envVars:
      - key: WEBAPP_HOST
        value: code-keeper-webapp.onrender.com
      - key: ALERTMANAGER_TARGET
        # Render ייצור את השירות בשם code-keeper-alertmanager ולכן הדומיין יהיה predictable
        value: code-keeper-alertmanager.onrender.com:443
      - key: PORT
        value: 9090
    autoDeploy: true
    healthCheckPath: /-/ready

  - type: web
    name: code-keeper-alertmanager
    env: docker
    plan: starter
    dockerfilePath: docker/alertmanager/Dockerfile
    envVars:
      - key: PORT
        value: 9093
      - key: ALERT_WEBHOOK_URL
        value: https://code-keeper-webapp.onrender.com/alertmanager/webhook
    autoDeploy: true
    healthCheckPath: /-/ready

  # (אין כאן שירותי בוט/ווב־אפ – מניחים שהם כבר קיימים ברנדר)

# ===================================
# אפשרויות נוספות לעתיד
# ===================================

# עבור Redis (אם נדרש בעתיד)
# - type: redis
#   name: code-keeper-redis
#   plan: free
#   region: oregon

# עבור PostgreSQL (אם נדרש בעתיד)  
# - type: pserv
#   name: code-keeper-postgres
#   env: postgresql
#   plan: free
#   region: oregon

# עבור Static Site (דוקומנטציה)
# - type: web
#   name: code-keeper-docs
#   env: static
#   buildCommand: |
#     cd docs
#     npm install
#     npm run build
#   staticPublishPath: docs/build
#   pullRequestPreviewsEnabled: true

# ===================================
# הוראות הגדרה ב-Render.com
# ===================================

# שלב 1: צור שירות חדש
# 1. עבור ל-https://render.com
# 2. התחבר עם GitHub
# 3. לחץ "New Web Service"
# 4. בחר repository
# 5. מלא את הפרטים:
#    - Name: code-keeper-bot
#    - Region: Oregon (או הקרוב אליך)
#    - Branch: main
#    - Build Command: pip install -r requirements/production.txt
#    - Start Command: python main.py

# שלב 2: הגדר משתני סביבה
# ב-Service Settings → Environment:
# BOT_TOKEN=your_telegram_bot_token
# MONGODB_URL=mongodb+srv://user:pass@cluster.mongodb.net/dbname
# GITHUB_TOKEN=your_github_token (אופציונלי)
# PASTEBIN_API_KEY=your_pastebin_key (אופציונלי)

# שלב 3: Deploy!
# Render יפרוס אוטומטי כל push ל-main

# ===================================
# MongoDB Atlas Setup
# ===================================

# 1. עבור ל-https://cloud.mongodb.com
# 2. צור חשבון חדש (חינם)
# 3. צור cluster חדש:
#    - Provider: AWS
#    - Region: US East (N. Virginia) - הכי קרוב לRender Oregon
#    - Tier: M0 Sandbox (Free Forever)
# 4. צור משתמש DB:
#    - Username: codekeeper
#    - Password: [generate strong password]
# 5. הגדר Network Access:
#    - Allow Access From Anywhere (0.0.0.0/0)
#    - או הוסף את IP של Render אם ידוע
# 6. קבל Connection String:
#    - Connect → Drivers → Python
#    - Copy connection string
#    - החלף <password> בסיסמה האמיתית

# ===================================
# הגדרות מתקדמות
# ===================================

# הפעלת Custom Domain (בתשלום):
# 1. הוסף CNAME record: bot.yourdomain.com → your-app.onrender.com
# 2. ב-Render: Settings → Custom Domains → Add Domain

# SSL Certificate:
# Render מספק HTTPS אוטומטי עם Let's Encrypt

# Monitoring:
# Render מספק built-in metrics, logs, ו-health checks

# Scaling:
# Free tier: 512MB RAM, יירדם אחרי 15 דק' חוסר פעילות
# Starter ($7/month): 512MB RAM, תמיד פעיל
# Standard ($25/month): 2GB RAM, תמיד פעיל

# ===================================
# טיפים לאופטימיזציה
# ===================================

# 1. מינימיזציה של dependencies ב-requirements.txt
# 2. שימוש ב-gunicorn עבור production (אם נדרש)
# 3. הגדרת health check endpoint
# 4. שימוש ב-Redis לקאש (אם הבוט גדל)
# 5. מעבר ל-Starter plan אם הבוט פופולרי

# ===================================
# דיבוג ופתרון בעיות
# ===================================

# צפייה בלוגים:
# Render Dashboard → Service → Logs

# בדיקת health:
# curl https://your-app.onrender.com/health

# Debug build issues:
# עקוב אחר Build Logs ב-Render Dashboard

# MongoDB connection issues:
# בדוק שה-IP של Render מורשה ב-Atlas Network Access
# וודא שהסיסמה ב-connection string נכונה (ללא @ או : מיוחדים)

# Environment variables:
# בדוק ש-BOT_TOKEN מוגדר נכון ללא רווחים מיותרים