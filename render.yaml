# ===================================
# Code Keeper Bot - Render Configuration
# בוט שומר קבצי קוד - הגדרות Render
# ===================================

services:
  # ===================================
  # Prometheus (לנטר את ה-WebApp)
  # ===================================
  - type: web
    name: code-keeper-prometheus
    env: docker
    plan: starter
    dockerfilePath: docker/prometheus/Dockerfile
    envVars:
      - key: WEBAPP_HOST
        # חובה לעדכן לפני deploy: כתובת Render של ה-WebApp (ללא https://)
        value: __REPLACE_WITH_WEBAPP_HOST__
      - key: ALERTMANAGER_TARGET
        # חובה לעדכן לפני deploy: כתובת Render של Alertmanager (ללא https://)
        value: __REPLACE_WITH_ALERTMANAGER_HOST__
      - key: PORT
        value: 9090
    autoDeploy: true
    healthCheckPath: /-/ready

  - type: web
    name: code-keeper-alertmanager
    env: docker
    plan: starter
    dockerfilePath: docker/alertmanager/Dockerfile
    envVars:
      - key: PORT
        value: 9093
      - key: ALERT_WEBHOOK_URL
        # Webhook of your webapp to forward alerts to Telegram
        value: https://your-webapp.onrender.com/alertmanager/webhook
    autoDeploy: true
    healthCheckPath: /-/ready

    # ===================================
    # Code Keeper Bot - Web Service (Python Bot)
    # ===================================
    - type: web
      name: code-keeper-bot
      env: python
      region: oregon # או virginia, frankfurt, singapore
      plan: free # או starter ($7/month) עבור always-on

      # הגדרות בנייה
      buildCommand: |
        pip install --upgrade pip
        # Install, generate constraints, and re-install with constraints
        pip install -r requirements/production.txt
        pip freeze | sort > constraints.txt
        pip install -r requirements/production.txt -c constraints.txt

      # פקודת הפעלה
      startCommand: python main.py

      # הגדרות runtime
      runtime: python3.11

      # Health check
      healthCheckPath: /health

      # משתני סביבה (ערכים ברגישים יוגדרו בRender Dashboard)
      envVars:
        - key: PYTHON_VERSION
          value: 3.11
        - key: PYTHONUNBUFFERED
          value: 1
        - key: LOG_LEVEL
          value: INFO
        - key: MAX_CODE_SIZE
          value: 100000
        - key: MAX_FILES_PER_USER
          value: 1000
        - key: HIGHLIGHT_THEME
          value: github-dark
        # OpenTelemetry – אל תשאירו localhost בענן; עדכנו בדשבורד פר סביבה
        # דוגמה ל-staging (Tempo ב-cluster):
        # - key: OTEL_EXPORTER_OTLP_ENDPOINT
        #   value: https://otlp.staging.example.com:4317
        # - key: OTEL_EXPORTER_INSECURE
        #   value: false
        - key: RATE_LIMIT_SHADOW_MODE
          value: true
        - key: RATE_LIMIT_STRATEGY
          value: moving-window
        - key: ENABLE_METRICS
          value: true
        - key: AUTO_BACKUP_ENABLED
          value: true
        - key: BACKUP_FREQUENCY_HOURS
          value: 24
        - key: MAX_BACKUPS_TO_KEEP
          value: 7
        - key: BACKUPS_DIR
          value: /data/backups
        - key: BACKUPS_STORAGE
          value: fs

        # משתני רגישים - יוגדרו בRender Dashboard:
        # BOT_TOKEN
        # MONGODB_URL (MongoDB Atlas)
        # GITHUB_TOKEN
        # PASTEBIN_API_KEY
        # ADMIN_USER_IDS
        # SENTRY_DSN

      # Auto-deploy מ-Git
      autoDeploy: true

      # הגדרות נוספות
      scaling:
        minInstances: 1
        maxInstances: 1

      disks:
        - name: backups
          mountPath: /data
          sizeGB: 1

    # ===================================
    # Code Keeper Web App - Web Service
    # ===================================
    - type: web
      name: code-keeper-webapp
      env: python
      region: oregon
      plan: free

      # הגדרות בנייה
      buildCommand: |
        cd webapp
        pip install --upgrade pip
        # Install project root requirements for webapp too
        pip install -r ../requirements/production.txt
        pip freeze | sort > ../constraints.txt
        pip install -r ../requirements/production.txt -c ../constraints.txt

      # פקודת הפעלה
      startCommand: cd webapp && gunicorn app:app --bind 0.0.0.0:$PORT

      # הגדרות runtime
      runtime: python3.11

      # Health check
      healthCheckPath: /

      # משתני סביבה
      envVars:
        - key: PYTHON_VERSION
          value: 3.11
        - key: PYTHONUNBUFFERED
          value: 1
        - key: LOG_LEVEL
          value: INFO
        # OpenTelemetry – אל תשאירו localhost בענן; עדכנו בדשבורד פר סביבה
        # דוגמה ל-staging (Tempo ב-cluster):
        # - key: OTEL_EXPORTER_OTLP_ENDPOINT
        #   value: https://otlp.staging.example.com:4317
        # - key: OTEL_EXPORTER_INSECURE
        #   value: false
        - key: RATE_LIMIT_SHADOW_MODE
          value: true
        - key: RATE_LIMIT_STRATEGY
          value: moving-window
        - key: ENABLE_METRICS
          value: true

        # משתני רגישים - יוגדרו בRender Dashboard:
        # SECRET_KEY (for Flask sessions)
        # BOT_TOKEN (same as bot)
        # MONGODB_URL (same as bot)
        # BOT_USERNAME
        # WEBAPP_URL
        # UPTIME_PROVIDER (betteruptime/uptimerobot)
        # UPTIME_API_KEY
        # UPTIME_MONITOR_ID
        # UPTIME_STATUS_URL
        # UPTIME_WIDGET_ID
        # UPTIME_WIDGET_SCRIPT_URL
        # UPTIME_CACHE_TTL_SECONDS

      # Auto-deploy מ-Git
      autoDeploy: true

      # הגדרות נוספות
      scaling:
        minInstances: 1
        maxInstances: 1

# ===================================
# אפשרויות נוספות לעתיד
# ===================================

# עבור Redis (אם נדרש בעתיד)
# - type: redis
#   name: code-keeper-redis
#   plan: free
#   region: oregon

# עבור PostgreSQL (אם נדרש בעתיד)  
# - type: pserv
#   name: code-keeper-postgres
#   env: postgresql
#   plan: free
#   region: oregon

# עבור Static Site (דוקומנטציה)
# - type: web
#   name: code-keeper-docs
#   env: static
#   buildCommand: |
#     cd docs
#     npm install
#     npm run build
#   staticPublishPath: docs/build
#   pullRequestPreviewsEnabled: true

# ===================================
# הוראות הגדרה ב-Render.com
# ===================================

# שלב 1: צור שירות חדש
# 1. עבור ל-https://render.com
# 2. התחבר עם GitHub
# 3. לחץ "New Web Service"
# 4. בחר repository
# 5. מלא את הפרטים:
#    - Name: code-keeper-bot
#    - Region: Oregon (או הקרוב אליך)
#    - Branch: main
#    - Build Command: pip install -r requirements/production.txt
#    - Start Command: python main.py

# שלב 2: הגדר משתני סביבה
# ב-Service Settings → Environment:
# BOT_TOKEN=your_telegram_bot_token
# MONGODB_URL=mongodb+srv://user:pass@cluster.mongodb.net/dbname
# GITHUB_TOKEN=your_github_token (אופציונלי)
# PASTEBIN_API_KEY=your_pastebin_key (אופציונלי)

# שלב 3: Deploy!
# Render יפרוס אוטומטי כל push ל-main

# ===================================
# MongoDB Atlas Setup
# ===================================

# 1. עבור ל-https://cloud.mongodb.com
# 2. צור חשבון חדש (חינם)
# 3. צור cluster חדש:
#    - Provider: AWS
#    - Region: US East (N. Virginia) - הכי קרוב לRender Oregon
#    - Tier: M0 Sandbox (Free Forever)
# 4. צור משתמש DB:
#    - Username: codekeeper
#    - Password: [generate strong password]
# 5. הגדר Network Access:
#    - Allow Access From Anywhere (0.0.0.0/0)
#    - או הוסף את IP של Render אם ידוע
# 6. קבל Connection String:
#    - Connect → Drivers → Python
#    - Copy connection string
#    - החלף <password> בסיסמה האמיתית

# ===================================
# הגדרות מתקדמות
# ===================================

# הפעלת Custom Domain (בתשלום):
# 1. הוסף CNAME record: bot.yourdomain.com → your-app.onrender.com
# 2. ב-Render: Settings → Custom Domains → Add Domain

# SSL Certificate:
# Render מספק HTTPS אוטומטי עם Let's Encrypt

# Monitoring:
# Render מספק built-in metrics, logs, ו-health checks

# Scaling:
# Free tier: 512MB RAM, יירדם אחרי 15 דק' חוסר פעילות
# Starter ($7/month): 512MB RAM, תמיד פעיל
# Standard ($25/month): 2GB RAM, תמיד פעיל

# ===================================
# טיפים לאופטימיזציה
# ===================================

# 1. מינימיזציה של dependencies ב-requirements.txt
# 2. שימוש ב-gunicorn עבור production (אם נדרש)
# 3. הגדרת health check endpoint
# 4. שימוש ב-Redis לקאש (אם הבוט גדל)
# 5. מעבר ל-Starter plan אם הבוט פופולרי

# ===================================
# דיבוג ופתרון בעיות
# ===================================

# צפייה בלוגים:
# Render Dashboard → Service → Logs

# בדיקת health:
# curl https://your-app.onrender.com/health

# Debug build issues:
# עקוב אחר Build Logs ב-Render Dashboard

# MongoDB connection issues:
# בדוק שה-IP של Render מורשה ב-Atlas Network Access
# וודא שהסיסמה ב-connection string נכונה (ללא @ או : מיוחדים)

# Environment variables:
# בדוק ש-BOT_TOKEN מוגדר נכון ללא רווחים מיותרים