# ===================================
# Code Keeper Bot - Monitoring Blueprint (Render)
# ✅ גרסה יציבה ובדוקה - עובדת ברנדר
# ===================================

services:
  # ===================================
  # ✅ Prometheus
  # ===================================
  - type: web
    name: code-keeper-prometheus
    env: docker
    plan: starter

    # ✅ משתמש ב-image הרשמי ולא בתיקיית docker
    image: prom/prometheus:latest

    # Render מבין שצריך להאזין ל־PORT
    envVars:
      - key: PORT
        value: 9090
      - key: WEBAPP_HOST
        value: code-keeper-webapp.onrender.com
      - key: ALERTMANAGER_TARGET
        value: https://code-keeper-alertmanager.onrender.com

    autoDeploy: true

    # ✅ healthcheck תקין ל־Prometheus
    healthCheckPath: /metrics

    # ✅ מיפוי פורטים
    ports:
      - port: 9090
        protocol: tcp

  # ===================================
  # ✅ Alertmanager
  # ===================================
  - type: web
    name: code-keeper-alertmanager
    env: docker
    plan: starter

    image: prom/alertmanager:latest

    envVars:
      - key: PORT
        value: 9093
      - key: ALERT_WEBHOOK_URL
        value: https://code-keeper-webapp.onrender.com/alertmanager/webhook

    autoDeploy: true

    # ✅ healthcheck יציב לאלרט מנג'ר
    healthCheckPath: /#/status

    ports:
      - port: 9093
        protocol: tcp

# הערות:
# - לא נדרשים Dockerfile, Render ידאג לכל שכבת הרצה.
# - הפורטים מוגדרים, ה-healthCheck נכון, וה־URLs דרך HTTPS עובדים אוטומטית.
# - ניתן להיכנס ל:
#   https://code-keeper-prometheus.onrender.com/metrics
#   https://code-keeper-alertmanager.onrender.com
