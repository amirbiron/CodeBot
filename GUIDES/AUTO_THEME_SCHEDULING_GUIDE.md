# ××“×¨×™×š ××™××•×© - ×ª×—×œ×•×¤×ª ×¢×¨×›×•×ª × ×•×©× ××•×˜×•××˜×™×ª ×œ×¤×™ ×©×¢×•×ª ×‘×™×××”

**×ª××¨×™×š**: ×™× ×•××¨ 2026  
**×’×¨×¡×”**: 1.1  
**×¡×˜×˜×•×¡**: ××“×¨×™×š ××™××•×©

---

## ğŸ“‹ ×ª×•×›×Ÿ ×¢× ×™×™× ×™×

1. [×¡×§×™×¨×” ×›×œ×œ×™×ª](#×¡×§×™×¨×”-×›×œ×œ×™×ª)
2. [×”×—×œ×˜×•×ª ×¢×™×¦×•×‘ ××¨×›×–×™×•×ª](#×”×—×œ×˜×•×ª-×¢×™×¦×•×‘-××¨×›×–×™×•×ª)
3. [××¨×›×™×˜×§×˜×•×¨×”](#××¨×›×™×˜×§×˜×•×¨×”)
4. [×©×œ×‘ 1: ×¢×“×›×•×Ÿ ××‘× ×” ×”× ×ª×•× ×™×](#×©×œ×‘-1-×¢×“×›×•×Ÿ-××‘× ×”-×”× ×ª×•× ×™×)
5. [×©×œ×‘ 2: ×™×¦×™×¨×ª API Backend](#×©×œ×‘-2-×™×¦×™×¨×ª-api-backend)
6. [×©×œ×‘ 3: ××™××•×© ×”×œ×•×’×™×§×” ×‘×¦×“ ×”×œ×§×•×—](#×©×œ×‘-3-××™××•×©-×”×œ×•×’×™×§×”-×‘×¦×“-×”×œ×§×•×—)
7. [×©×œ×‘ 4: ×¢×“×›×•×Ÿ ×××©×§ ×”××©×ª××©](#×©×œ×‘-4-×¢×“×›×•×Ÿ-×××©×§-×”××©×ª××©)
8. [×©×œ×‘ 5: ××™× ×˜×’×¨×¦×™×” ×¢× ×”××¢×¨×›×ª ×”×§×™×™××ª](#×©×œ×‘-5-××™× ×˜×’×¨×¦×™×”-×¢×-×”××¢×¨×›×ª-×”×§×™×™××ª)
9. [×©×œ×‘ 6: ×‘×“×™×§×•×ª](#×©×œ×‘-6-×‘×“×™×§×•×ª)
10. [×©×™×§×•×œ×™ UX ×•× ×’×™×©×•×ª](#×©×™×§×•×œ×™-ux-×•× ×’×™×©×•×ª)
11. [×¡×™×›×•×](#×¡×™×›×•×)

---

## ×¡×§×™×¨×” ×›×œ×œ×™×ª

### ××” ×”×¤×™×¦'×¨ ×¢×•×©×”?

×××¤×©×¨ ×œ××©×ª××©×™× ×œ×”×’×“×™×¨ ×ª×—×œ×•×¤×” ××•×˜×•××˜×™×ª ×‘×™×Ÿ ×¢×¨×›×•×ª × ×•×©× ×œ×¤×™ ×©×¢×•×ª ×‘×™×××”:

- **×¢×¨×›×ª ×™×•×** (Day Theme): ××•×¤×¢×œ×ª ×‘×©×¢×•×ª ×”×™×•× ×©×”××©×ª××© ×”×’×“×™×¨
- **×¢×¨×›×ª ×œ×™×œ×”** (Night Theme): ××•×¤×¢×œ×ª ×‘×©×¢×•×ª ×”×œ×™×œ×” ×©×”××©×ª××© ×”×’×“×™×¨
- **××¦×‘ ×™×“× ×™**: ×”××©×ª××© ×™×›×•×œ ×œ×›×‘×•×ª ××ª ×”××•×˜×•××¦×™×” ×•×œ×‘×—×•×¨ ×¢×¨×›×” ×§×‘×•×¢×”

### ×“×•×’××” ×œ×ª×¨×—×™×© ×©×™××•×©

> ×™×•×¡×™ ××¢×“×™×£ ×¢×¨×›×” ×‘×”×™×¨×” (Classic) ×‘×™×•× ×›×“×™ ×œ×¢×‘×•×“ ×‘×¡×‘×™×‘×” ××•××¨×ª,  
> ×•×‘×œ×™×œ×” ×”×•× ×¢×•×‘×¨ ×œ×¢×¨×›×” ×›×”×” (Dark) ×›×“×™ ×œ×”×¤×—×™×ª ×¢×•××¡ ×¢×œ ×”×¢×™× ×™×™×.  
> ×”×•× ××’×“×™×¨: ×™×•× = 07:00-20:00, ×œ×™×œ×” = 20:00-07:00.

### ×™×ª×¨×•× ×•×ª

- âœ… ×”×¤×—×ª×ª ×¢×•××¡ ×¢×œ ×”×¢×™× ×™×™× ×‘×©×¢×•×ª ×”×œ×™×œ×”
- âœ… ×”×ª×××” ××•×˜×•××˜×™×ª ×œ×œ× ×¦×•×¨×š ×‘×”×—×œ×¤×” ×™×“× ×™×ª
- âœ… ×’××™×©×•×ª ××œ××” ×œ×‘×—×™×¨×ª ×©×¢×•×ª ×•×¢×¨×›×•×ª
- âœ… ×ª××™×›×” ×‘×›×œ ×¡×•×’×™ ×”×¢×¨×›×•×ª (Built-in, Shared, Custom)

---

## ×”×—×œ×˜×•×ª ×¢×™×¦×•×‘ ××¨×›×–×™×•×ª

×œ×¤× ×™ ×”××™××•×©, ×—×©×•×‘ ×œ×”×’×“×™×¨ ××¡×¤×¨ ×”×—×œ×˜×•×ª ××•×¦×¨×™×•×ª:

### 1. ××§×•×¨ ×”×××ª ×œ×–××Ÿ: ×”×œ×§×•×— (Client-Side)

**×”×‘×¢×™×”**: ×”×©×¨×ª ×¨×¥ ×‘-UTC, ××‘×œ ×”××©×ª××© ×¨×•××” ×©×¢×•×Ÿ ××§×•××™.

**×”×”×—×œ×˜×”**: 
- **×”×œ×§×•×—** ×”×•× ××§×•×¨ ×”×××ª ×œ×—×™×©×•×‘ ×”×ª×§×•×¤×” ×”× ×•×›×—×™×ª (×™×•×/×œ×™×œ×”)
- ×”×©×¨×ª **×œ× ××—×©×‘** ×•×œ× ××¢×“×›×Ÿ ××ª `ui_prefs.theme` ×‘×–××Ÿ ×©××™×¨×ª ×”×’×“×¨×•×ª
- ×”×©×¨×ª ×¨×§ ×©×•××¨ ××ª ×”×”×’×“×¨×•×ª ×•××—×–×™×¨ ××•×ª×Ÿ ×œ×œ×§×•×—

**×™×ª×¨×•× ×•×ª**:
- âœ… ×”××©×ª××© ×¨×•××” ××ª ××” ×©×”×•× ××¦×¤×” ×œ×¨××•×ª ×œ×¤×™ ×”×©×¢×•×Ÿ ×©×œ×•
- âœ… ××™×Ÿ ×¦×•×¨×š ×œ×©××•×¨ timezone ×‘×”×¢×“×¤×•×ª
- âœ… ×¤×©×•×˜ ×™×•×ª×¨ ×œ××™××•×© ×•×œ×ª×—×–×•×§×”

### 2. ×˜×•×•×— ×©×¢×•×ª ×™×•×: ×œ×œ× ×—×¦×™×™×ª ×—×¦×•×ª

**×”×‘×¢×™×”**: ×× ×”××©×ª××© ××’×“×™×¨ ×™×•× = `20:00 â†’ 07:00`, ×–×” ××‘×œ×‘×œ - ×”×× ×–×” "×™×•×" ××• "×œ×™×œ×”"?

**×”×”×—×œ×˜×”**:
- **×©×¢×•×ª ×™×•× ×—×™×™×‘×•×ª ×œ×”×™×•×ª ×¨×¦×™×¤×•×ª** (day_start < day_end)
- ×œ× ×××¤×©×¨×™× ×”×’×“×¨×ª ×™×•× ×©×—×•×¦×” ×—×¦×•×ª
- ×•×•×œ×™×“×¦×™×” ×—×•×¡××ª: ×× `day_start >= day_end` â†’ ×©×’×™××”

**×“×•×’×××•×ª ×—×•×§×™×•×ª**:
- ×™×•×: 06:00 â†’ 20:00 âœ…
- ×™×•×: 08:00 â†’ 18:00 âœ…
- ×™×•×: 00:00 â†’ 12:00 âœ… (××©××¨×ª ×œ×™×œ×” ×”×¤×•×›×”)

**×“×•×’×××•×ª ×œ× ×—×•×§×™×•×ª**:
- ×™×•×: 20:00 â†’ 07:00 âŒ (×—×•×¦×” ×—×¦×•×ª)
- ×™×•×: 12:00 â†’ 12:00 âŒ (0 ×“×§×•×ª)

### 3. ×”×ª× ×”×’×•×ª ×‘×¢×ª ×©×™× ×•×™ ×™×“× ×™ (Override)

**×”×‘×¢×™×”**: ××” ×§×•×¨×” ×× ×”××©×ª××© ×œ×•×—×¥ ×™×“× ×™×ª ×¢×œ "×›×”×”" ×‘×–××Ÿ ×©×”×ª×–××•×Ÿ ×¤×¢×™×œ?

**×”×”×—×œ×˜×”**: **Override ×–×× ×™ ×¢×“ ×”××¢×‘×¨ ×”×‘×**
- ×”××©×ª××© ×™×›×•×œ ×œ×©× ×•×ª ×™×“× ×™×ª ×‘×›×œ ×¨×’×¢
- ×”×©×™× ×•×™ ×”×™×“× ×™ × ×©××¨ ×‘-`localStorage` ×›-`manual_override`
- ×‘×¨×’×¢ ×©××’×™×¢ ×–××Ÿ ×”××¢×‘×¨ ×”×‘×, ×”-override ××ª×‘×˜×œ ×•×”×ª×–××•×Ÿ ×—×•×–×¨ ×œ×¤×¢×•×œ
- ×”×•×“×¢×ª UI ××™×™×“×¢×ª: "×”×ª×–××•×Ÿ ×¤×¢×™×œ. ×”×©×™× ×•×™ ×™×—×–×™×§ ×¢×“ XX:XX"

### 4. ×©××™×¨×ª ××–×”×” ×¢×¨×›×” ××œ×

**×”×‘×¢×™×”**: "custom" ×”×•× ×œ× ××–×”×” ×¢×¨×›×” ×××™×ª×™, ××œ× ×§×˜×’×•×¨×™×”.

**×”×”×—×œ×˜×”**:
- ×œ×©××•×¨ ×ª××™×“ ××ª ×”××–×”×” ×”××œ× ×©×œ ×”×¢×¨×›×”
- ×¤×•×¨××˜: `builtin:<name>`, `shared:<id>`, `custom:<id>`
- ×œ×•×•×œ×™×“×¦×™×” ××•×œ DB ×× ×”×¢×¨×›×” ×§×™×™××ª (shared/custom)

**×“×•×’×××•×ª**:
```json
{
  "day_theme": "builtin:classic",
  "night_theme": "builtin:dark"
}
// ××•
{
  "day_theme": "shared:abc123",
  "night_theme": "custom:my-theme-uuid"
}
```

### 5. ×˜×™×™××¨ ×—×›× ×‘××§×•× Polling

**×”×‘×¢×™×”**: `setInterval` ×›×œ ×“×§×” ×–×” ×¢×•×‘×“, ××‘×œ ×œ× ××•×¤×˜×™××œ×™.

**×”×”×—×œ×˜×”**:
- ×œ×—×©×‘ ××ª ×”×–××Ÿ ×”××“×•×™×§ ×¢×“ ×”××¢×‘×¨ ×”×‘×
- ×œ×”×’×“×™×¨ `setTimeout` ×œ××™×¨×•×¢ ×”×¡×¤×¦×™×¤×™
- ×œ××—×¨ ×›×œ ××¢×‘×¨, ×œ×—×©×‘ ××—×“×© ××ª ×”×˜×™×™××¨ ×”×‘×
- Timer ×’×™×‘×•×™ ×›×œ 5 ×“×§×•×ª ×œ××§×¨×” ×©×œ drift

---

## ××¨×›×™×˜×§×˜×•×¨×”

### ×ª×¨×©×™× ×–×¨×™××”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    User Settings Page                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Enable Auto â”‚  â”‚ Day Theme   â”‚  â”‚ Start/End Hours     â”‚  â”‚
â”‚  â”‚   Toggle    â”‚  â”‚ Selector    â”‚  â”‚ Time Pickers        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                â”‚                     â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                â”‚                     â”‚
          â–¼                â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    API Layer (Flask)                         â”‚
â”‚                                                              â”‚
â”‚  POST /api/theme-schedule                                    â”‚
â”‚  GET  /api/theme-schedule                                    â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MongoDB                                   â”‚
â”‚                                                              â”‚
â”‚  users.ui_prefs.theme_schedule: {                           â”‚
â”‚    enabled: true,                                            â”‚
â”‚    day_theme: "classic",                                     â”‚
â”‚    night_theme: "dark",                                      â”‚
â”‚    day_start: "07:00",                                       â”‚
â”‚    day_end: "20:00"                                          â”‚
â”‚  }                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Client-Side Logic (JavaScript)                 â”‚
â”‚                                                              â”‚
â”‚  1. Load schedule settings on page load                      â”‚
â”‚  2. Calculate current period (day/night)                     â”‚
â”‚  3. Apply appropriate theme                                  â”‚
â”‚  4. Set timer for next transition                            â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ××‘× ×” ×”×§×‘×¦×™×

```
webapp/
â”œâ”€â”€ themes_api.py              # ×”×•×¡×¤×ª endpoints ×—×“×©×™×
â”œâ”€â”€ static/
â”‚   â””â”€â”€ js/
â”‚       â””â”€â”€ theme-scheduler.js # ×œ×•×’×™×§×” ×¦×“ ×œ×§×•×— (×§×•×‘×¥ ×—×“×©)
â””â”€â”€ templates/
    â””â”€â”€ settings/
        â””â”€â”€ theme_schedule.html # ×××©×§ ×”×’×“×¨×•×ª (×§×•×‘×¥ ×—×“×©)
```

---

## ×©×œ×‘ 1: ×¢×“×›×•×Ÿ ××‘× ×” ×”× ×ª×•× ×™×

### 1.1 ×¡×›××ª MongoDB

×”×•×¡×£ ×œ××•×‘×™×™×§×˜ `ui_prefs` ×©×œ ×”××©×ª××©:

```javascript
// users collection - ui_prefs schema extension
{
  "user_id": 123456,
  "ui_prefs": {
    "theme": "classic",           // ×¢×¨×›×” × ×•×›×—×™×ª (×§×™×™×)
    "font_scale": 1.0,            // (×§×™×™×)
    
    // ğŸ†• ×”×’×“×¨×•×ª ×ª×–××•×Ÿ ×¢×¨×›×•×ª
    "theme_schedule": {
      "enabled": false,           // ×”×× ×”×ª×–××•×Ÿ ××•×¤×¢×œ
      "day_theme": "builtin:classic",   // ×¢×¨×›×ª ×™×•× (××–×”×” ××œ×)
      "night_theme": "builtin:dark",    // ×¢×¨×›×ª ×œ×™×œ×” (××–×”×” ××œ×)
      "day_start": "07:00",       // ×©×¢×ª ×”×ª×—×œ×ª ×™×•× (HH:MM)
      "day_end": "20:00"          // ×©×¢×ª ×¡×™×•× ×™×•× (HH:MM) - ×—×™×™×‘ ×œ×”×™×•×ª > day_start
    }
  }
}
```

**×¤×•×¨××˜ ××–×”×” ×¢×¨×›×”**:
- `builtin:<name>` - ×¢×¨×›×•×ª ××•×‘× ×•×ª (classic, dark, dim, etc.)
- `shared:<id>` - ×¢×¨×›×•×ª ×¦×™×‘×•×¨×™×•×ª ××”×¡×¤×¨×™×™×”
- `custom:<uuid>` - ×¢×¨×›×•×ª ××•×ª×××•×ª ××™×©×™×ª ×©×œ ×”××©×ª××©

### 1.2 ×¢×¨×›×™ ×‘×¨×™×¨×ª ××—×“×œ

```python
# services/constants.py ××• webapp/themes_api.py

DEFAULT_THEME_SCHEDULE = {
    "enabled": False,
    "day_theme": "builtin:classic",
    "night_theme": "builtin:dark",
    "day_start": "07:00",
    "day_end": "20:00",
}

# ×¢×¨×›×•×ª × ×•×©× ××•×‘× ×•×ª (Built-in)
BUILTIN_THEMES = {
    "classic", "dark", "dim", "nebula", "ocean", 
    "forest", "rose-pine-dawn", "high-contrast"
}

# Prefixes ×—×•×§×™×™× ×œ××–×”×” ×¢×¨×›×”
VALID_THEME_PREFIXES = ("builtin:", "shared:", "custom:")
```

### 1.3 ×•×•×œ×™×“×¦×™×”

```python
import re
from datetime import datetime
from typing import Optional

def validate_time_format(time_str: str) -> bool:
    """×‘×•×“×§ ×©×¤×•×¨××˜ ×”×©×¢×” ×ª×§×™×Ÿ (HH:MM)."""
    if not time_str or not isinstance(time_str, str):
        return False
    pattern = r"^([01]?[0-9]|2[0-3]):([0-5][0-9])$"
    return bool(re.match(pattern, time_str.strip()))


def time_to_minutes(time_str: str) -> int:
    """×××™×¨ ××—×¨×•×–×ª ×©×¢×” ×œ××¡×¤×¨ ×“×§×•×ª ××—×¦×•×ª."""
    parts = time_str.strip().split(":")
    return int(parts[0]) * 60 + int(parts[1])


def validate_theme_identifier(theme_id: str, db=None, user_id: Optional[int] = None) -> tuple[bool, str]:
    """
    ××××ª ××–×”×” ×¢×¨×›×” ××œ×.
    
    Args:
        theme_id: ××–×”×” ×‘×¤×•×¨××˜ prefix:value
        db: ×—×™×‘×•×¨ ×œ-DB (××•×¤×¦×™×•× ×œ×™, ×œ×‘×“×™×§×ª ×§×™×•×)
        user_id: ××–×”×” ××©×ª××© (× ×“×¨×© ×œ×‘×“×™×§×ª custom themes)
    
    Returns:
        (is_valid, error_message)
    """
    if not theme_id or not isinstance(theme_id, str):
        return False, "missing_theme_id"
    
    theme_id = theme_id.strip().lower()
    
    # ×‘×“×™×§×ª prefix
    if not any(theme_id.startswith(p) for p in VALID_THEME_PREFIXES):
        return False, "invalid_theme_prefix"
    
    # ×‘×“×™×§×ª builtin
    if theme_id.startswith("builtin:"):
        name = theme_id.split(":", 1)[1]
        if name not in BUILTIN_THEMES:
            return False, "unknown_builtin_theme"
        return True, ""
    
    # ×‘×“×™×§×ª shared (××•×¤×¦×™×•× ×œ×™ - × ×’×“ DB)
    if theme_id.startswith("shared:"):
        if db is not None:
            shared_id = theme_id.split(":", 1)[1]
            exists = db.shared_themes.find_one(
                {"_id": shared_id, "is_active": True},
                {"_id": 1}
            )
            if not exists:
                return False, "shared_theme_not_found"
        return True, ""
    
    # ×‘×“×™×§×ª custom (××•×¤×¦×™×•× ×œ×™ - × ×’×“ DB)
    if theme_id.startswith("custom:"):
        if db is not None and user_id:
            custom_id = theme_id.split(":", 1)[1]
            exists = db.users.find_one(
                {"user_id": user_id, "custom_themes.id": custom_id},
                {"_id": 1}
            )
            if not exists:
                return False, "custom_theme_not_found"
        return True, ""
    
    return False, "invalid_theme_id"


def validate_theme_schedule(schedule: dict, db=None, user_id: Optional[int] = None) -> tuple[bool, str]:
    """
    ××××ª ××ª ×”×’×“×¨×•×ª ×ª×–××•×Ÿ ×”×¢×¨×›×•×ª.
    
    Returns:
        (is_valid, error_message)
    """
    if not isinstance(schedule, dict):
        return False, "invalid_format"
    
    # ×‘×“×™×§×ª enabled
    if "enabled" in schedule and not isinstance(schedule["enabled"], bool):
        return False, "invalid_enabled_value"
    
    # ×‘×“×™×§×ª ×¢×¨×›×•×ª × ×•×©×
    for key in ("day_theme", "night_theme"):
        if key in schedule:
            is_valid, error = validate_theme_identifier(
                schedule[key], db=db, user_id=user_id
            )
            if not is_valid:
                return False, f"{key}_{error}"
    
    # ×‘×“×™×§×ª ×©×¢×•×ª
    day_start = schedule.get("day_start")
    day_end = schedule.get("day_end")
    
    if day_start is not None:
        if not validate_time_format(day_start):
            return False, "invalid_day_start_format"
    
    if day_end is not None:
        if not validate_time_format(day_end):
            return False, "invalid_day_end_format"
    
    # ğŸ”’ ×•×•×œ×™×“×¦×™×” ×§×¨×™×˜×™×ª: day_start ×—×™×™×‘ ×œ×”×™×•×ª ×§×˜×Ÿ ×-day_end
    if day_start and day_end:
        start_mins = time_to_minutes(day_start)
        end_mins = time_to_minutes(day_end)
        
        if start_mins >= end_mins:
            return False, "day_start_must_be_before_day_end"
        
        # ××™× ×™××•× ×©×¢×” ××—×ª ×©×œ ×™×•×
        if end_mins - start_mins < 60:
            return False, "day_range_too_short"
    
    return True, ""
```

---

## ×©×œ×‘ 2: ×™×¦×™×¨×ª API Backend

### 2.1 ×”×•×¡×¤×” ×œ-`themes_api.py`

×”×•×¡×£ ××ª ×”×§×•×“ ×”×‘× ×œ×§×•×‘×¥ `webapp/themes_api.py`:

```python
# ============================================================
# Theme Schedule API - ×ª×–××•×Ÿ ×¢×¨×›×•×ª ×œ×¤×™ ×©×¢×•×ª
# ============================================================

DEFAULT_THEME_SCHEDULE = {
    "enabled": False,
    "day_theme": "classic",
    "night_theme": "dark",
    "day_start": "07:00",
    "day_end": "20:00",
}

ALLOWED_SCHEDULE_THEMES = {
    "classic", "dark", "dim", "nebula", "ocean",
    "forest", "rose-pine-dawn", "high-contrast", "custom"
}


def _validate_time_format(time_str: str) -> bool:
    """×‘×•×“×§ ×©×¤×•×¨××˜ ×”×©×¢×” ×ª×§×™×Ÿ (HH:MM)."""
    if not time_str or not isinstance(time_str, str):
        return False
    import re
    pattern = r"^([01]?[0-9]|2[0-3]):([0-5][0-9])$"
    return bool(re.match(pattern, time_str.strip()))


def _validate_theme_schedule(schedule: dict) -> tuple[bool, str]:
    """××××ª ××ª ×”×’×“×¨×•×ª ×ª×–××•×Ÿ ×”×¢×¨×›×•×ª."""
    if not isinstance(schedule, dict):
        return False, "invalid_format"

    if "enabled" in schedule and not isinstance(schedule["enabled"], bool):
        return False, "invalid_enabled_value"

    for key in ("day_theme", "night_theme"):
        if key in schedule:
            theme = schedule[key]
            if not isinstance(theme, str):
                return False, f"invalid_{key}"
            theme_lower = theme.lower().strip()
            if not (theme_lower in ALLOWED_SCHEDULE_THEMES or 
                    theme_lower.startswith("shared:") or
                    theme_lower == "custom"):
                return False, f"invalid_{key}"

    for key in ("day_start", "day_end"):
        if key in schedule:
            if not _validate_time_format(schedule[key]):
                return False, f"invalid_{key}_format"

    return True, ""


@themes_bp.route("/schedule", methods=["GET"])
@require_auth
def get_theme_schedule():
    """
    ×§×‘×œ×ª ×”×’×“×¨×•×ª ×ª×–××•×Ÿ ×¢×¨×›×•×ª ×”× ×•×©×.
    
    Response:
    {
        "ok": true,
        "schedule": {
            "enabled": false,
            "day_theme": "classic",
            "night_theme": "dark",
            "day_start": "07:00",
            "day_end": "20:00"
        }
    }
    """
    user_id = get_current_user_id()
    if not user_id:
        return jsonify({"ok": False, "error": "unauthorized"}), 401

    try:
        db_ref = get_db()
        user_doc = db_ref.users.find_one(
            {"user_id": int(user_id)},
            {"ui_prefs.theme_schedule": 1}
        ) or {}

        ui_prefs = user_doc.get("ui_prefs") or {}
        schedule = ui_prefs.get("theme_schedule") or {}

        # ××™×–×•×’ ×¢× ×‘×¨×™×¨×•×ª ××—×“×œ
        merged_schedule = {**DEFAULT_THEME_SCHEDULE, **schedule}

        return jsonify({"ok": True, "schedule": merged_schedule})

    except Exception as e:
        logger.exception("get_theme_schedule failed: %s", e)
        return jsonify({"ok": False, "error": "database_error"}), 500


@themes_bp.route("/schedule", methods=["POST"])
@require_auth
def update_theme_schedule():
    """
    ×¢×“×›×•×Ÿ ×”×’×“×¨×•×ª ×ª×–××•×Ÿ ×¢×¨×›×•×ª ×”× ×•×©×.
    
    Request body:
    {
        "enabled": true,
        "day_theme": "builtin:classic",
        "night_theme": "builtin:dark",
        "day_start": "07:00",
        "day_end": "20:00"
    }
    
    Response:
    {
        "ok": true,
        "message": "×”×’×“×¨×•×ª ×”×ª×–××•×Ÿ × ×©××¨×•",
        "schedule": { ... }
    }
    
    ×”×¢×¨×” ×—×©×•×‘×”:
    - ×”×©×¨×ª ×œ× ××—×©×‘ ××ª ×”×¢×¨×›×” ×”× ×•×›×—×™×ª ×•×œ× ××¢×“×›×Ÿ ui_prefs.theme
    - ×”×œ×§×•×— ×”×•× ××§×•×¨ ×”×××ª ×œ×–××Ÿ (×©×¢×•×Ÿ ××§×•××™ ×©×œ ×”××©×ª××©)
    - day_start ×—×™×™×‘ ×œ×”×™×•×ª ×§×˜×Ÿ ×-day_end (××™×Ÿ ×ª××™×›×” ×‘×˜×•×•×— ×©×—×•×¦×” ×—×¦×•×ª)
    """
    user_id = get_current_user_id()
    if not user_id:
        return jsonify({"ok": False, "error": "unauthorized"}), 401

    data = request.get_json(silent=True) or {}

    try:
        db_ref = get_db()
        
        # ×•×•×œ×™×“×¦×™×” ××œ××” ×›×•×œ×œ ×‘×“×™×§×ª ×§×™×•× ×¢×¨×›×•×ª ×‘-DB
        is_valid, error_msg = _validate_theme_schedule(
            data, db=db_ref, user_id=int(user_id)
        )
        if not is_valid:
            # ××™×¤×•×™ ×©×’×™××•×ª ×œ×¢×‘×¨×™×ª
            error_messages = {
                "invalid_format": "×¤×•×¨××˜ ×œ× ×ª×§×™×Ÿ",
                "invalid_enabled_value": "×¢×¨×š enabled ×œ× ×ª×§×™×Ÿ",
                "day_theme_missing_theme_id": "×—×¡×¨ ××–×”×” ×¢×¨×›×ª ×™×•×",
                "day_theme_invalid_theme_prefix": "×¤×•×¨××˜ ×¢×¨×›×ª ×™×•× ×œ× ×ª×§×™×Ÿ",
                "day_theme_unknown_builtin_theme": "×¢×¨×›×ª ×™×•× ×œ× ×§×™×™××ª",
                "day_theme_shared_theme_not_found": "×¢×¨×›×ª ×™×•× ×©×™×ª×•×¤×™×ª ×œ× × ××¦××”",
                "day_theme_custom_theme_not_found": "×¢×¨×›×ª ×™×•× ××•×ª×××ª ×œ× × ××¦××”",
                "night_theme_missing_theme_id": "×—×¡×¨ ××–×”×” ×¢×¨×›×ª ×œ×™×œ×”",
                "night_theme_invalid_theme_prefix": "×¤×•×¨××˜ ×¢×¨×›×ª ×œ×™×œ×” ×œ× ×ª×§×™×Ÿ",
                "night_theme_unknown_builtin_theme": "×¢×¨×›×ª ×œ×™×œ×” ×œ× ×§×™×™××ª",
                "night_theme_shared_theme_not_found": "×¢×¨×›×ª ×œ×™×œ×” ×©×™×ª×•×¤×™×ª ×œ× × ××¦××”",
                "night_theme_custom_theme_not_found": "×¢×¨×›×ª ×œ×™×œ×” ××•×ª×××ª ×œ× × ××¦××”",
                "invalid_day_start_format": "×¤×•×¨××˜ ×©×¢×ª ×”×ª×—×œ×” ×œ× ×ª×§×™×Ÿ (× ×“×¨×© HH:MM)",
                "invalid_day_end_format": "×¤×•×¨××˜ ×©×¢×ª ×¡×™×•× ×œ× ×ª×§×™×Ÿ (× ×“×¨×© HH:MM)",
                "day_start_must_be_before_day_end": "×©×¢×ª ×”×ª×—×œ×” ×—×™×™×‘×ª ×œ×”×™×•×ª ×œ×¤× ×™ ×©×¢×ª ×”×¡×™×•×",
                "day_range_too_short": "×˜×•×•×— ×”×™×•× ×—×™×™×‘ ×œ×”×™×•×ª ×œ×¤×—×•×ª ×©×¢×”",
            }
            message = error_messages.get(error_msg, error_msg)
            return jsonify({"ok": False, "error": error_msg, "message": message}), 400

        now_utc = datetime.now(timezone.utc)

        # ×§×¨×™××” ×§×•×“××ª ×œ×§×‘×œ×ª ×¢×¨×›×™× ×§×™×™××™×
        user_doc = db_ref.users.find_one(
            {"user_id": int(user_id)},
            {"ui_prefs.theme_schedule": 1}
        ) or {}

        existing_schedule = (user_doc.get("ui_prefs") or {}).get("theme_schedule") or {}

        # ××™×–×•×’: ×‘×¨×™×¨×•×ª ××—×“×œ <- ×§×™×™× <- ×—×“×©
        new_schedule = {
            **DEFAULT_THEME_SCHEDULE,
            **existing_schedule,
        }

        # ×¢×“×›×•×Ÿ ×¨×§ ×©×“×•×ª ×©× ×©×œ×—×•
        if "enabled" in data:
            new_schedule["enabled"] = bool(data["enabled"])
        if "day_theme" in data:
            new_schedule["day_theme"] = str(data["day_theme"]).strip().lower()
        if "night_theme" in data:
            new_schedule["night_theme"] = str(data["night_theme"]).strip().lower()
        if "day_start" in data:
            new_schedule["day_start"] = str(data["day_start"]).strip()
        if "day_end" in data:
            new_schedule["day_end"] = str(data["day_end"]).strip()

        # ×©××™×¨×” - ×œ×œ× ×¢×“×›×•×Ÿ ui_prefs.theme (×”×œ×§×•×— ×™×¢×©×” ×–××ª)
        db_ref.users.update_one(
            {"user_id": int(user_id)},
            {
                "$set": {
                    "ui_prefs.theme_schedule": new_schedule,
                    "updated_at": now_utc,
                }
            },
            upsert=True,
        )

        return jsonify({
            "ok": True,
            "message": "×”×’×“×¨×•×ª ×”×ª×–××•×Ÿ × ×©××¨×•",
            "schedule": new_schedule,
        })

    except Exception as e:
        logger.exception("update_theme_schedule failed: %s", e)
        return jsonify({"ok": False, "error": "database_error"}), 500


def _extract_theme_name(theme_id: str) -> str:
    """
    ××—×œ×¥ ××ª ×©× ×”×¢×¨×›×” ××”××–×”×” ×”××œ×.
    ×œ×“×•×’××”: "builtin:dark" -> "dark", "shared:abc123" -> "shared:abc123"
    """
    if not theme_id:
        return "classic"
    
    if theme_id.startswith("builtin:"):
        return theme_id.split(":", 1)[1]
    
    # ×¢×‘×•×¨ shared/custom, ××—×–×™×¨×™× ××ª ×”××–×”×” ×”××œ× (×”-JS ×™×˜×¤×œ ×‘×–×”)
    return theme_id
```

**×”×¢×¨×” ×—×©×•×‘×”**: ×”×©×¨×ª ×œ× ××—×©×‘ ××ª ×”×¢×¨×›×” ×”× ×•×›×—×™×ª ×œ×¤×™ ×–××Ÿ. ×›×œ ×”×—×™×©×•×‘×™× ××ª×‘×¦×¢×™× ×‘×¦×“ ×”×œ×§×•×— (×¨××” ×©×œ×‘ 3).

---

## ×©×œ×‘ 3: ××™××•×© ×”×œ×•×’×™×§×” ×‘×¦×“ ×”×œ×§×•×—

### 3.1 ×™×¦×™×¨×ª `theme-scheduler.js`

×¦×•×¨ ×§×•×‘×¥ ×—×“×©: `webapp/static/js/theme-scheduler.js`

```javascript
/**
 * Theme Scheduler - ×ª×–××•×Ÿ ××•×˜×•××˜×™ ×©×œ ×¢×¨×›×•×ª × ×•×©× ×œ×¤×™ ×©×¢×•×ª
 * 
 * ×¢×§×¨×•× ×•×ª ××¨×›×–×™×™×:
 * 1. ×”×œ×§×•×— ×”×•× ××§×•×¨ ×”×××ª ×œ×–××Ÿ (×©×¢×•×Ÿ ××§×•××™)
 * 2. day_start < day_end ×ª××™×“ (××™×Ÿ ×—×¦×™×™×ª ×—×¦×•×ª)
 * 3. ×˜×™×™××¨ ×—×›× - setTimeout ×œ××™×¨×•×¢ ×”×‘×, ×œ× polling
 * 4. ×ª××™×›×” ×‘-override ×™×“× ×™ ×–×× ×™
 */

(function() {
    'use strict';

    // === ×§×‘×•×¢×™× ===
    const STORAGE_KEY = 'theme_schedule_cache';
    const OVERRIDE_KEY = 'theme_manual_override';
    const CACHE_MAX_AGE_MS = 24 * 60 * 60 * 1000; // 24 ×©×¢×•×ª
    const BACKUP_CHECK_INTERVAL = 5 * 60 * 1000; // ×’×™×‘×•×™ ×›×œ 5 ×“×§×•×ª

    // === ××¦×‘ ===
    let currentSchedule = null;
    let nextChangeTimer = null;
    let backupTimer = null;

    // === ×¢×–×¨: ×–××Ÿ ===

    /**
     * ×”××¨×ª ××—×¨×•×–×ª ×©×¢×” ×œ××¡×¤×¨ ×“×§×•×ª ××—×¦×•×ª
     */
    function timeToMinutes(timeStr) {
        if (!timeStr || typeof timeStr !== 'string') return 0;
        const parts = timeStr.split(':');
        return (parseInt(parts[0], 10) || 0) * 60 + (parseInt(parts[1], 10) || 0);
    }

    /**
     * ×”××¨×ª ×“×§×•×ª ×œ×¤×•×¨××˜ ×©×¢×”
     */
    function formatMinutesToTime(minutes) {
        const hours = Math.floor(minutes / 60) % 24;
        const mins = minutes % 60;
        return `${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}`;
    }

    /**
     * ×§×‘×œ×ª ×”×©×¢×” ×”× ×•×›×—×™×ª ×›××¡×¤×¨ ×“×§×•×ª
     */
    function getCurrentMinutes() {
        const now = new Date();
        return now.getHours() * 60 + now.getMinutes();
    }

    /**
     * ×—×™×©×•×‘ ××¡×¤×¨ ××™×œ×™×©× ×™×•×ª ×¢×“ ×©×¢×” ××¡×•×™××ª
     */
    function getMillisecondsUntil(targetMinutes) {
        const now = new Date();
        const currentMins = now.getHours() * 60 + now.getMinutes();
        const currentSecs = now.getSeconds();
        
        let diffMins;
        if (targetMinutes > currentMins) {
            diffMins = targetMinutes - currentMins;
        } else {
            // ××—×¨
            diffMins = (24 * 60 - currentMins) + targetMinutes;
        }
        
        // ×”××¨×” ×œ××™×œ×™×©× ×™×•×ª, ××™× ×•×¡ ×”×©× ×™×•×ª ×©×›×‘×¨ ×¢×‘×¨×•
        return (diffMins * 60 - currentSecs) * 1000;
    }

    // === ×¢×–×¨: ××–×”×” ×¢×¨×›×” ===

    /**
     * ×—×™×œ×•×¥ ×©× ×”×¢×¨×›×” ××”××–×”×” ×”××œ×
     * "builtin:dark" -> "dark"
     * "shared:abc123" -> × ×©××¨ ×›××• ×©×”×•× (× ×˜×¤×œ ×‘-applyTheme)
     */
    function extractThemeName(themeId) {
        if (!themeId) return 'classic';
        
        if (themeId.startsWith('builtin:')) {
            return themeId.split(':', 2)[1];
        }
        // shared/custom - ××—×–×™×¨×™× ××ª ×”-id ×”××œ×
        return themeId;
    }

    // === ×œ×•×’×™×§×” ××¨×›×–×™×ª ===

    /**
     * ×—×™×©×•×‘ ×”×ª×§×•×¤×” ×”× ×•×›×—×™×ª (×™×•×/×œ×™×œ×”) ×•×”×¢×¨×›×” ×”××ª××™××”
     * 
     * ×”× ×—×”: day_start < day_end (×›×‘×¨ ×¢×‘×¨ ×•×•×œ×™×“×¦×™×” ×‘×©×¨×ª)
     */
    function calculateCurrentPeriod(schedule) {
        if (!schedule || !schedule.enabled) {
            return { period: null, theme: null, nextChangeIn: null, nextChangeAt: null };
        }

        const currentMins = getCurrentMinutes();
        const dayStart = timeToMinutes(schedule.day_start || '07:00');
        const dayEnd = timeToMinutes(schedule.day_end || '20:00');
        
        // ×œ×•×’×™×§×” ×¤×©×•×˜×”: ×™×•× = ×‘×ª×•×š ×”×˜×•×•×— [dayStart, dayEnd)
        const isDay = currentMins >= dayStart && currentMins < dayEnd;
        
        // ×”×¢×¨×›×” ×”× ×•×›×—×™×ª
        const themeId = isDay ? schedule.day_theme : schedule.night_theme;
        const theme = extractThemeName(themeId || (isDay ? 'builtin:classic' : 'builtin:dark'));
        
        // ×–××Ÿ ×”××¢×‘×¨ ×”×‘×
        const nextChangeAt = isDay ? dayEnd : dayStart;
        const nextChangeIn = getMillisecondsUntil(nextChangeAt);

        return {
            period: isDay ? 'day' : 'night',
            theme: theme,
            themeId: themeId, // ×”××–×”×” ×”××œ×
            nextChangeIn: nextChangeIn, // ×‘××™×œ×™×©× ×™×•×ª
            nextChangeAt: formatMinutesToTime(nextChangeAt),
        };
    }

    // === Override ×™×“× ×™ ===

    /**
     * ×‘×“×™×§×” ×× ×™×© override ×™×“× ×™ ×¤×¢×™×œ
     */
    function getManualOverride() {
        try {
            const data = localStorage.getItem(OVERRIDE_KEY);
            if (!data) return null;
            
            const override = JSON.parse(data);
            const now = Date.now();
            
            // ×‘×“×™×§×” ×× ×”-override ×¢×“×™×™×Ÿ ×ª×§×£
            if (override.expiresAt && override.expiresAt > now) {
                return override;
            }
            
            // ×¤×’ ×ª×•×§×£ - ××•×—×§×™×
            localStorage.removeItem(OVERRIDE_KEY);
            return null;
        } catch (e) {
            return null;
        }
    }

    /**
     * ×”×’×“×¨×ª override ×™×“× ×™ (×–×× ×™ ×¢×“ ×”××¢×‘×¨ ×”×‘×)
     */
    function setManualOverride(theme) {
        if (!currentSchedule || !currentSchedule.enabled) return;
        
        const result = calculateCurrentPeriod(currentSchedule);
        if (!result.nextChangeIn) return;
        
        const override = {
            theme: theme,
            setAt: Date.now(),
            expiresAt: Date.now() + result.nextChangeIn,
            expiresAtFormatted: result.nextChangeAt,
        };
        
        try {
            localStorage.setItem(OVERRIDE_KEY, JSON.stringify(override));
        } catch (e) {
            // ignore
        }
        
        // ×”×•×“×¢×” ×œ××©×ª××©
        showOverrideNotification(result.nextChangeAt);
    }

    /**
     * ×‘×™×˜×•×œ override ×™×“× ×™
     */
    function clearManualOverride() {
        try {
            localStorage.removeItem(OVERRIDE_KEY);
        } catch (e) {
            // ignore
        }
    }

    /**
     * ×”×¦×’×ª ×”×•×“×¢×” ×¢×œ override
     */
    function showOverrideNotification(expiresAt) {
        // ×‘×“×™×§×” ×× ×›×‘×¨ ×™×© toast
        const existing = document.querySelector('.theme-override-toast');
        if (existing) existing.remove();
        
        const toast = document.createElement('div');
        toast.className = 'theme-override-toast';
        toast.innerHTML = `
            <i class="fas fa-info-circle"></i>
            <span>×”×ª×–××•×Ÿ ×”××•×˜×•××˜×™ ×¤×¢×™×œ. ×”×©×™× ×•×™ ×”×™×“× ×™ ×™×ª×‘×˜×œ ×‘-${expiresAt}</span>
            <button onclick="this.parentElement.remove()" class="toast-close">&times;</button>
        `;
        toast.style.cssText = `
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--warning, #f59e0b);
            color: #000;
            padding: 0.75rem 1rem;
            border-radius: 10px;
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            animation: fadeInUp 0.3s ease-out;
        `;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 5000);
    }

    // === ×”×—×œ×ª ×¢×¨×›×” ===

    /**
     * ×”×—×œ×ª ×¢×¨×›×ª × ×•×©×
     */
    function applyTheme(theme, options = {}) {
        if (!theme) return;
        
        const { source = 'scheduler', force = false } = options;
        const html = document.documentElement;
        const currentTheme = html.getAttribute('data-theme');

        // ×‘×“×™×§×ª override ×™×“× ×™ (×¨×§ ×× ×œ× force)
        if (!force && source === 'scheduler') {
            const override = getManualOverride();
            if (override) {
                // ×™×© override ×¤×¢×™×œ - ×œ× ××©× ×™×
                console.log(`[ThemeScheduler] Manual override active until ${override.expiresAtFormatted}`);
                return;
            }
        }

        // ×¨×§ ×× ×™×© ×©×™× ×•×™
        if (currentTheme === theme && !force) return;

        console.log(`[ThemeScheduler] Applying theme: ${theme} (source: ${source})`);

        // ×¢×“×›×•×Ÿ ×”-HTML attribute
        html.setAttribute('data-theme', theme);

        // ×¢×“×›×•×Ÿ cookie (×œ×˜×¢×™× ×” ×”×‘××”)
        try {
            document.cookie = `ui_theme=${theme}; path=/; max-age=31536000; SameSite=Lax`;
        } catch (e) {
            // ignore
        }

        // ××™×¨×•×¢ ×œ×¢×“×›×•×Ÿ ×§×•××¤×•× × ×˜×™× ××—×¨×™×
        window.dispatchEvent(new CustomEvent('themeChanged', {
            detail: { theme, source }
        }));

        // ×¢×“×›×•×Ÿ ×”-DarkMode toggle button
        updateToggleButton(theme);
    }

    /**
     * ×¢×“×›×•×Ÿ ×›×¤×ª×•×¨ toggle
     */
    function updateToggleButton(theme) {
        const toggleBtn = document.getElementById('darkModeToggle');
        const icon = document.getElementById('darkModeIcon');
        if (!toggleBtn || !icon) return;
        
        const icons = {
            'classic': 'fa-sun',
            'dark': 'fa-moon',
            'dim': 'fa-cloud-moon',
            'ocean': 'fa-water',
            'forest': 'fa-tree',
            'nebula': 'fa-star',
        };
        icon.className = 'fas ' + (icons[theme] || 'fa-palette');
    }

    // === ××˜××•×Ÿ ===

    /**
     * ×©××™×¨×” ×‘××˜××•×Ÿ ××§×•××™
     */
    function saveToCache(schedule) {
        try {
            const cacheData = {
                schedule: schedule,
                fetchedAt: Date.now(),
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(cacheData));
        } catch (e) {
            // ignore
        }
    }

    /**
     * ×˜×¢×™× ×” ×××˜××•×Ÿ ××§×•××™
     */
    function loadFromCache() {
        try {
            const data = localStorage.getItem(STORAGE_KEY);
            if (!data) return null;
            
            const cached = JSON.parse(data);
            
            // ×‘×“×™×§×ª ×ª×•×§×£ (24 ×©×¢×•×ª)
            if (cached.fetchedAt && (Date.now() - cached.fetchedAt) > CACHE_MAX_AGE_MS) {
                console.log('[ThemeScheduler] Cache expired, will fetch fresh data');
                return null;
            }
            
            return cached.schedule;
        } catch (e) {
            return null;
        }
    }

    // === ×ª×§×©×•×¨×ª ×¢× ×”×©×¨×ª ===

    /**
     * ×˜×¢×™× ×ª ×”×’×“×¨×•×ª ××”×©×¨×ª
     */
    async function loadSchedule() {
        try {
            const response = await fetch('/api/themes/schedule', {
                method: 'GET',
                credentials: 'same-origin',
            });

            if (!response.ok) {
                console.warn('[ThemeScheduler] Failed to load schedule, using cache');
                return loadFromCache();
            }

            const data = await response.json();
            if (data.ok && data.schedule) {
                currentSchedule = data.schedule;
                saveToCache(data.schedule);
                return data.schedule;
            }
        } catch (e) {
            console.warn('[ThemeScheduler] Network error, using cache:', e.message);
        }

        // Fallback ×œ××˜××•×Ÿ
        const cached = loadFromCache();
        if (cached) {
            currentSchedule = cached;
        }
        return cached;
    }

    /**
     * ×©××™×¨×ª ×”×’×“×¨×•×ª ×œ×©×¨×ª
     */
    async function saveSchedule(schedule) {
        try {
            const response = await fetch('/api/themes/schedule', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify(schedule),
            });

            const data = await response.json();
            if (data.ok) {
                currentSchedule = data.schedule || schedule;
                saveToCache(currentSchedule);
                
                // ×‘×™×˜×•×œ override ×§×•×“×
                clearManualOverride();

                // ×¢×“×›×•×Ÿ ××¢×§×‘
                if (currentSchedule.enabled) {
                    startMonitoring();
                } else {
                    stopMonitoring();
                }

                return { success: true, schedule: currentSchedule };
            } else {
                return { success: false, error: data.error, message: data.message };
            }
        } catch (e) {
            console.error('[ThemeScheduler] Save error:', e);
            return { success: false, error: 'network_error' };
        }
    }

    // === × ×™×”×•×œ ×˜×™×™××¨×™× ===

    /**
     * ×”×’×“×¨×ª ×˜×™×™××¨ ×œ××™×¨×•×¢ ×”×‘×
     */
    function scheduleNextChange() {
        // × ×™×§×•×™ ×˜×™×™××¨ ×§×•×“×
        if (nextChangeTimer) {
            clearTimeout(nextChangeTimer);
            nextChangeTimer = null;
        }

        if (!currentSchedule || !currentSchedule.enabled) return;

        const result = calculateCurrentPeriod(currentSchedule);
        if (!result.nextChangeIn) return;

        console.log(`[ThemeScheduler] Next change in ${Math.round(result.nextChangeIn / 60000)} minutes (at ${result.nextChangeAt})`);

        // ×˜×™×™××¨ ×œ××™×¨×•×¢ ×”×‘×
        nextChangeTimer = setTimeout(() => {
            console.log(`[ThemeScheduler] Time to switch!`);
            
            // ×‘×™×˜×•×œ override (×”×’×™×¢ ×–××Ÿ ×”××¢×‘×¨)
            clearManualOverride();
            
            // ×”×—×œ×ª ×”×¢×¨×›×” ×”×—×“×©×”
            const newResult = calculateCurrentPeriod(currentSchedule);
            if (newResult.theme) {
                applyTheme(newResult.theme, { force: true });
            }
            
            // ×ª×–××•×Ÿ ×”××™×¨×•×¢ ×”×‘×
            scheduleNextChange();
            
        }, result.nextChangeIn + 1000); // +1 ×©× ×™×™×” ×œ×•×•×“× ×©×¢×‘×¨× ×• ××ª × ×§×•×“×ª ×”××¢×‘×¨
    }

    /**
     * ×”×ª×—×œ×ª ××¢×§×‘
     */
    function startMonitoring() {
        // ×¢×¦×™×¨×ª ×˜×™×™××¨×™× ×§×•×“××™×
        stopMonitoring();

        if (!currentSchedule || !currentSchedule.enabled) return;

        // ×”×—×œ×ª ×”×¢×¨×›×” ×”× ×•×›×—×™×ª
        const result = calculateCurrentPeriod(currentSchedule);
        if (result.theme) {
            applyTheme(result.theme);
        }

        // ×ª×–××•×Ÿ ×”××¢×‘×¨ ×”×‘×
        scheduleNextChange();

        // Timer ×’×™×‘×•×™ (×œ××§×¨×” ×©×œ drift ××• ×—×–×¨×” ×-sleep)
        backupTimer = setInterval(() => {
            if (!currentSchedule?.enabled) return;
            
            const override = getManualOverride();
            if (override) {
                // ×‘×“×™×§×” ×× ×”-override ×¤×’
                if (override.expiresAt <= Date.now()) {
                    clearManualOverride();
                    const newResult = calculateCurrentPeriod(currentSchedule);
                    if (newResult.theme) {
                        applyTheme(newResult.theme, { force: true });
                    }
                }
                return;
            }
            
            // ×‘×“×™×§×ª ×”×ª×××”
            const result = calculateCurrentPeriod(currentSchedule);
            const currentTheme = document.documentElement.getAttribute('data-theme');
            if (result.theme && result.theme !== currentTheme) {
                console.log('[ThemeScheduler] Backup check detected mismatch, fixing...');
                applyTheme(result.theme);
                scheduleNextChange();
            }
        }, BACKUP_CHECK_INTERVAL);
    }

    /**
     * ×¢×¦×™×¨×ª ××¢×§×‘
     */
    function stopMonitoring() {
        if (nextChangeTimer) {
            clearTimeout(nextChangeTimer);
            nextChangeTimer = null;
        }
        if (backupTimer) {
            clearInterval(backupTimer);
            backupTimer = null;
        }
    }

    // === ××ª×—×•×œ ===

    async function init() {
        console.log('[ThemeScheduler] Initializing...');
        
        // ×˜×¢×™× ×ª ×”×’×“×¨×•×ª
        await loadSchedule();

        // ×”×ª×—×œ×ª ××¢×§×‘ ×× ××•×¤×¢×œ
        if (currentSchedule && currentSchedule.enabled) {
            startMonitoring();
        }
    }

    // ×”×¤×¢×œ×” ×‘×˜×¢×™× ×ª ×”×“×£
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }

    // ×”××–× ×” ×œ×©×™× ×•×™×™ visibility (×—×–×¨×” ×œ×˜××‘)
    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible' && currentSchedule?.enabled) {
            // ×‘×“×™×§×” ×× ×¦×¨×™×š ×œ×¢×“×›×Ÿ
            const override = getManualOverride();
            if (!override) {
                const result = calculateCurrentPeriod(currentSchedule);
                const currentTheme = document.documentElement.getAttribute('data-theme');
                if (result.theme && result.theme !== currentTheme) {
                    applyTheme(result.theme);
                }
            }
            // ×¨×¢× ×•×Ÿ ×˜×™×™××¨
            scheduleNextChange();
        }
    });

    // === API ×’×œ×•×‘×œ×™ ===

    window.ThemeScheduler = {
        // ×¤×¢×•×œ×•×ª ×‘×¡×™×¡×™×•×ª
        load: loadSchedule,
        save: saveSchedule,
        
        // ××¦×‘ × ×•×›×—×™
        getSchedule: () => currentSchedule,
        getCurrentPeriod: () => calculateCurrentPeriod(currentSchedule),
        isEnabled: () => currentSchedule?.enabled ?? false,
        
        // ××¢×§×‘
        start: startMonitoring,
        stop: stopMonitoring,
        
        // Override ×™×“× ×™
        setOverride: setManualOverride,
        clearOverride: clearManualOverride,
        getOverride: getManualOverride,
        
        // ×”×—×œ×ª ×¢×¨×›×” (×œ×©×™××•×© ×—×™×¦×•× ×™)
        applyTheme: (theme) => applyTheme(theme, { source: 'manual' }),
    };

})();
```

### 3.2 ×”×•×¡×¤×” ×œ-`base.html`

×”×•×¡×£ ××ª ×”×§×•×‘×¥ ××—×¨×™ `dark-mode.js`:

```html
<!-- Theme Scheduler - ×ª×–××•×Ÿ ×¢×¨×›×•×ª ×œ×¤×™ ×©×¢×•×ª -->
{% if session.user_id %}
<script src="{{ url_for('static', filename='js/theme-scheduler.js') }}?v={{ static_version }}" defer></script>
{% endif %}
```

---

## ×©×œ×‘ 4: ×¢×“×›×•×Ÿ ×××©×§ ×”××©×ª××©

### 4.1 ×™×¦×™×¨×ª `theme_schedule.html`

×¦×•×¨ ×§×•×‘×¥ ×—×“×©: `webapp/templates/settings/theme_schedule.html`

```html
{% extends "base.html" %}

{% block title %}×ª×–××•×Ÿ ×¢×¨×›×•×ª × ×•×©× - Code Keeper Bot{% endblock %}

{% block content %}
<h1 class="page-title">
    <i class="fas fa-clock"></i>
    ×ª×–××•×Ÿ ×¢×¨×›×•×ª × ×•×©× ××•×˜×•××˜×™
</h1>

<div class="theme-schedule-container">
    <div class="glass-card schedule-card">
        <div class="schedule-header">
            <h2>
                <i class="fas fa-sun"></i>
                <i class="fas fa-moon"></i>
                ×”×—×œ×¤×” ××•×˜×•××˜×™×ª ×™×•×/×œ×™×œ×”
            </h2>
            <p class="text-muted">
                ×”×’×“×¨ ×¢×¨×›×•×ª × ×•×©× ×©×•× ×•×ª ×œ×©×¢×•×ª ×”×™×•× ×•×”×œ×™×œ×”.
                ×”××¢×¨×›×ª ×ª×—×œ×™×£ ×‘×™× ×™×”×Ÿ ××•×˜×•××˜×™×ª.
            </p>
        </div>

        <div class="schedule-form">
            <!-- ×”×¤×¢×œ×”/×›×™×‘×•×™ -->
            <div class="form-group toggle-group">
                <label class="toggle-label" for="scheduleEnabled">
                    <span class="toggle-text">×”×¤×¢×œ ×ª×–××•×Ÿ ××•×˜×•××˜×™</span>
                    <div class="toggle-switch">
                        <input type="checkbox" id="scheduleEnabled" class="toggle-input">
                        <span class="toggle-slider"></span>
                    </div>
                </label>
            </div>

            <!-- ×”×’×“×¨×•×ª (××•×¦×’×•×ª ×¨×§ ×›×©×”×ª×–××•×Ÿ ××•×¤×¢×œ) -->
            <div id="scheduleSettings" class="schedule-settings" style="display: none;">
                
                <!-- ×¢×¨×›×ª ×™×•× -->
                <div class="form-group">
                    <label for="dayTheme">
                        <i class="fas fa-sun" style="color: #f59e0b;"></i>
                        ×¢×¨×›×ª ×™×•×
                    </label>
                    <select id="dayTheme" class="form-control theme-select">
                        <optgroup label="×¢×¨×›×•×ª ×‘×”×™×¨×•×ª">
                            <option value="builtin:classic">×§×œ××¡×™ (×‘×”×™×¨)</option>
                            <option value="builtin:ocean">××•×§×™×™× ×•×¡</option>
                            <option value="builtin:forest">×™×¢×¨</option>
                            <option value="builtin:rose-pine-dawn">Rose Pine Dawn</option>
                        </optgroup>
                        <optgroup label="×¢×¨×›×•×ª ×›×”×•×ª">
                            <option value="builtin:dark">×›×”×”</option>
                            <option value="builtin:dim">××¢×•××¢×</option>
                            <option value="builtin:nebula">×¢×¨×¤×™×œ×™×ª</option>
                        </optgroup>
                        <!-- ×¢×¨×›×•×ª ××•×ª×××•×ª/×©×™×ª×•×¤×™×•×ª ×™×ª×•×•×¡×¤×• ×“×™× ××™×ª -->
                    </select>
                </div>

                <!-- ×¢×¨×›×ª ×œ×™×œ×” -->
                <div class="form-group">
                    <label for="nightTheme">
                        <i class="fas fa-moon" style="color: #6366f1;"></i>
                        ×¢×¨×›×ª ×œ×™×œ×”
                    </label>
                    <select id="nightTheme" class="form-control theme-select">
                        <optgroup label="×¢×¨×›×•×ª ×›×”×•×ª">
                            <option value="builtin:dark">×›×”×”</option>
                            <option value="builtin:dim">××¢×•××¢×</option>
                            <option value="builtin:nebula">×¢×¨×¤×™×œ×™×ª</option>
                            <option value="builtin:high-contrast">× ×™×’×•×“×™×•×ª ×’×‘×•×”×”</option>
                        </optgroup>
                        <optgroup label="×¢×¨×›×•×ª ×‘×”×™×¨×•×ª">
                            <option value="builtin:classic">×§×œ××¡×™ (×‘×”×™×¨)</option>
                            <option value="builtin:ocean">××•×§×™×™× ×•×¡</option>
                            <option value="builtin:forest">×™×¢×¨</option>
                        </optgroup>
                        <!-- ×¢×¨×›×•×ª ××•×ª×××•×ª/×©×™×ª×•×¤×™×•×ª ×™×ª×•×•×¡×¤×• ×“×™× ××™×ª -->
                    </select>
                </div>

                <!-- ×˜×•×•×— ×©×¢×•×ª ×™×•× -->
                <div class="form-group time-range-group">
                    <label>
                        <i class="fas fa-clock"></i>
                        ×©×¢×•×ª ×™×•×
                    </label>
                    <div class="time-range">
                        <div class="time-input-wrapper">
                            <label for="dayStart" class="time-label">×Ö¾</label>
                            <input type="time" id="dayStart" class="form-control time-input" value="07:00">
                        </div>
                        <span class="time-separator">×¢×“</span>
                        <div class="time-input-wrapper">
                            <label for="dayEnd" class="time-label">×¢×“</label>
                            <input type="time" id="dayEnd" class="form-control time-input" value="20:00">
                        </div>
                    </div>
                    <small class="text-muted" id="timeRangeHint">
                        ×›×œ ×”×©×¢×•×ª ××—×•×¥ ×œ×˜×•×•×— ×–×” ×™×™×—×©×‘×• ×›×œ×™×œ×”
                    </small>
                    <div id="timeRangeError" class="form-error" style="display: none;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>×©×¢×ª ×”×”×ª×—×œ×” ×—×™×™×‘×ª ×œ×”×™×•×ª ×œ×¤× ×™ ×©×¢×ª ×”×¡×™×•×</span>
                    </div>
                </div>

                <!-- ×ª×¦×•×’×” ××§×“×™××” -->
                <div class="schedule-preview">
                    <div class="preview-item day-preview">
                        <div class="preview-icon">
                            <i class="fas fa-sun"></i>
                        </div>
                        <div class="preview-info">
                            <strong>×™×•×</strong>
                            <span id="dayPreviewTime">07:00 - 20:00</span>
                        </div>
                        <div class="preview-theme" id="dayPreviewTheme">
                            ×§×œ××¡×™
                        </div>
                    </div>
                    <div class="preview-item night-preview">
                        <div class="preview-icon">
                            <i class="fas fa-moon"></i>
                        </div>
                        <div class="preview-info">
                            <strong>×œ×™×œ×”</strong>
                            <span id="nightPreviewTime">20:00 - 07:00</span>
                        </div>
                        <div class="preview-theme" id="nightPreviewTheme">
                            ×›×”×”
                        </div>
                    </div>
                </div>

                <!-- ×¡×˜×˜×•×¡ × ×•×›×—×™ -->
                <div class="current-status" id="currentStatus" style="display: none;">
                    <i class="fas fa-info-circle"></i>
                    <span id="statusText">×›×¨×’×¢: ×¢×¨×›×ª ×™×•× (×§×œ××¡×™)</span>
                    <span id="nextChangeText" class="next-change">×©×™× ×•×™ ×”×‘×: 20:00</span>
                </div>
            </div>

            <!-- ×›×¤×ª×•×¨×™× -->
            <div class="form-actions">
                <button type="button" id="saveScheduleBtn" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    ×©××•×¨ ×”×’×“×¨×•×ª
                </button>
                <button type="button" id="testScheduleBtn" class="btn btn-secondary" style="display: none;">
                    <i class="fas fa-play"></i>
                    ×‘×“×•×§ ×¢×›×©×™×•
                </button>
            </div>
        </div>
    </div>

    <!-- ××™×“×¢ × ×•×¡×£ -->
    <div class="glass-card info-card">
        <h3>
            <i class="fas fa-lightbulb"></i>
            ××™×š ×–×” ×¢×•×‘×“?
        </h3>
        <ul class="info-list">
            <li>
                <i class="fas fa-check"></i>
                ×‘×—×¨ ×¢×¨×›×ª × ×•×©× ×‘×”×™×¨×” ×œ×©×¢×•×ª ×”×™×•×
            </li>
            <li>
                <i class="fas fa-check"></i>
                ×‘×—×¨ ×¢×¨×›×ª × ×•×©× ×›×”×” ×œ×©×¢×•×ª ×”×œ×™×œ×”
            </li>
            <li>
                <i class="fas fa-check"></i>
                ×”×’×“×¨ ××ª ×˜×•×•×— ×”×©×¢×•×ª ×œ×¤×™ ×”×”×¢×“×¤×” ×©×œ×š
            </li>
            <li>
                <i class="fas fa-check"></i>
                ×”××¢×¨×›×ª ×ª×—×œ×™×£ ××•×˜×•××˜×™×ª ×‘×™×Ÿ ×”×¢×¨×›×•×ª
            </li>
        </ul>
        <p class="text-muted small">
            <i class="fas fa-info-circle"></i>
            ×”×©×¢×•×ª ××‘×•×¡×¡×•×ª ×¢×œ ×”×©×¢×•×Ÿ ×”××§×•××™ ×©×œ ×”×“×¤×“×¤×Ÿ ×©×œ×š.
        </p>
    </div>
</div>

<style>
.theme-schedule-container {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: 1.5rem;
    max-width: 1000px;
    margin: 0 auto;
}

@media (max-width: 800px) {
    .theme-schedule-container {
        grid-template-columns: 1fr;
    }
}

.schedule-card {
    padding: 1.5rem;
}

.schedule-header h2 {
    margin: 0 0 0.5rem 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.schedule-header h2 i {
    font-size: 1.1em;
}

.schedule-header h2 i.fa-sun {
    color: #f59e0b;
}

.schedule-header h2 i.fa-moon {
    color: #6366f1;
}

/* Toggle Switch */
.toggle-group {
    margin: 1.5rem 0;
}

.toggle-label {
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    padding: 1rem;
    background: var(--glass);
    border: 1px solid var(--glass-border);
    border-radius: 12px;
    transition: all 0.2s;
}

.toggle-label:hover {
    background: var(--glass-hover);
}

.toggle-text {
    font-weight: 600;
    color: var(--text-primary);
}

.toggle-switch {
    position: relative;
    width: 52px;
    height: 28px;
}

.toggle-input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--bg-tertiary);
    transition: 0.3s;
    border-radius: 28px;
    border: 1px solid var(--glass-border);
}

.toggle-slider:before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 3px;
    bottom: 3px;
    background: white;
    transition: 0.3s;
    border-radius: 50%;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.toggle-input:checked + .toggle-slider {
    background: var(--primary);
    border-color: var(--primary);
}

.toggle-input:checked + .toggle-slider:before {
    transform: translateX(24px);
}

/* Schedule Settings */
.schedule-settings {
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.form-group {
    margin-bottom: 1.25rem;
}

.form-group label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: var(--text-primary);
}

.theme-select {
    width: 100%;
    padding: 0.75rem 1rem;
    border-radius: 10px;
    border: 1px solid var(--glass-border);
    background: var(--glass);
    color: var(--text-primary);
    font-size: 1rem;
    cursor: pointer;
}

.theme-select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
}

/* Time Range */
.time-range {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.time-input-wrapper {
    flex: 1;
}

.time-label {
    display: none;
}

.time-input {
    width: 100%;
    padding: 0.75rem;
    border-radius: 10px;
    border: 1px solid var(--glass-border);
    background: var(--glass);
    color: var(--text-primary);
    font-size: 1rem;
}

.time-input:focus {
    outline: none;
    border-color: var(--primary);
}

.time-separator {
    color: var(--text-muted);
    font-weight: 500;
}

/* Preview */
.schedule-preview {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin: 1.5rem 0;
    padding: 1rem;
    background: var(--bg-secondary);
    border-radius: 12px;
}

.preview-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem;
    border-radius: 10px;
    background: var(--glass);
}

.day-preview {
    border-left: 3px solid #f59e0b;
}

.night-preview {
    border-left: 3px solid #6366f1;
}

.preview-icon {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background: var(--bg-tertiary);
}

.day-preview .preview-icon {
    color: #f59e0b;
}

.night-preview .preview-icon {
    color: #6366f1;
}

.preview-info {
    flex: 1;
}

.preview-info strong {
    display: block;
    color: var(--text-primary);
}

.preview-info span {
    font-size: 0.85rem;
    color: var(--text-muted);
}

.preview-theme {
    padding: 0.35rem 0.75rem;
    border-radius: 20px;
    background: var(--primary);
    color: white;
    font-size: 0.85rem;
    font-weight: 500;
}

/* Current Status */
.current-status {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem;
    background: rgba(99, 102, 241, 0.1);
    border: 1px solid rgba(99, 102, 241, 0.3);
    border-radius: 10px;
    color: var(--text-primary);
    margin-top: 1rem;
}

.current-status i {
    color: var(--primary);
}

.next-change {
    margin-right: auto;
    font-size: 0.85rem;
    color: var(--text-muted);
}

/* Actions */
.form-actions {
    display: flex;
    gap: 1rem;
    margin-top: 1.5rem;
}

.form-actions .btn {
    flex: 1;
}

/* Info Card */
.info-card {
    padding: 1.5rem;
    height: fit-content;
}

.info-card h3 {
    margin: 0 0 1rem 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.info-card h3 i {
    color: #f59e0b;
}

.info-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.info-list li {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
    color: var(--text-secondary);
}

.info-list li i {
    color: var(--success);
    margin-top: 0.2em;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', async function() {
    const enabledToggle = document.getElementById('scheduleEnabled');
    const settingsDiv = document.getElementById('scheduleSettings');
    const dayThemeSelect = document.getElementById('dayTheme');
    const nightThemeSelect = document.getElementById('nightTheme');
    const dayStartInput = document.getElementById('dayStart');
    const dayEndInput = document.getElementById('dayEnd');
    const timeRangeError = document.getElementById('timeRangeError');
    const timeRangeHint = document.getElementById('timeRangeHint');
    const saveBtn = document.getElementById('saveScheduleBtn');
    const testBtn = document.getElementById('testScheduleBtn');
    const currentStatus = document.getElementById('currentStatus');
    const statusText = document.getElementById('statusText');
    const nextChangeText = document.getElementById('nextChangeText');

    // Theme names mapping
    const themeNames = {
        'builtin:classic': '×§×œ××¡×™',
        'builtin:dark': '×›×”×”',
        'builtin:dim': '××¢×•××¢×',
        'builtin:nebula': '×¢×¨×¤×™×œ×™×ª',
        'builtin:ocean': '××•×§×™×™× ×•×¡',
        'builtin:forest': '×™×¢×¨',
        'builtin:rose-pine-dawn': 'Rose Pine Dawn',
        'builtin:high-contrast': '× ×™×’×•×“×™×•×ª ×’×‘×•×”×”',
    };

    // ×”××¨×ª ×©×¢×” ×œ××¡×¤×¨ ×“×§×•×ª ×œ×¦×•×¨×š ×”×©×•×•××”
    function timeToMinutes(timeStr) {
        if (!timeStr) return 0;
        const parts = timeStr.split(':');
        return parseInt(parts[0], 10) * 60 + parseInt(parts[1], 10);
    }

    // ×•×•×œ×™×“×¦×™×” ×©×œ ×˜×•×•×— ×©×¢×•×ª
    function validateTimeRange() {
        const startMins = timeToMinutes(dayStartInput.value);
        const endMins = timeToMinutes(dayEndInput.value);
        
        const isValid = startMins < endMins;
        const isTooShort = (endMins - startMins) < 60;
        
        if (!isValid) {
            timeRangeError.style.display = 'flex';
            timeRangeError.querySelector('span').textContent = 
                '×©×¢×ª ×”×”×ª×—×œ×” ×—×™×™×‘×ª ×œ×”×™×•×ª ×œ×¤× ×™ ×©×¢×ª ×”×¡×™×•×';
            timeRangeHint.style.display = 'none';
            saveBtn.disabled = true;
            return false;
        }
        
        if (isTooShort) {
            timeRangeError.style.display = 'flex';
            timeRangeError.querySelector('span').textContent = 
                '×˜×•×•×— ×”×™×•× ×—×™×™×‘ ×œ×”×™×•×ª ×œ×¤×—×•×ª ×©×¢×” ××—×ª';
            timeRangeHint.style.display = 'none';
            saveBtn.disabled = true;
            return false;
        }
        
        timeRangeError.style.display = 'none';
        timeRangeHint.style.display = 'block';
        saveBtn.disabled = false;
        return true;
    }

    // ×˜×¢×™× ×ª ×¢×¨×›×•×ª ××•×ª×××•×ª/×©×™×ª×•×¤×™×•×ª ×œ×ª×•×š ×”-select
    async function loadCustomThemes() {
        try {
            // ×˜×¢×™× ×ª ×¢×¨×›×•×ª ××•×ª×××•×ª ××™×©×™×ª
            const customResp = await fetch('/api/themes', { credentials: 'same-origin' });
            if (customResp.ok) {
                const customData = await customResp.json();
                if (customData.ok && customData.themes?.length > 0) {
                    addThemesToSelect(customData.themes, 'custom', '×¢×¨×›×•×ª ××•×ª×××•×ª ××™×©×™×ª');
                }
            }
        } catch (e) {
            console.warn('Failed to load custom themes:', e);
        }
    }

    // ×”×•×¡×¤×ª ×¢×¨×›×•×ª ×œ-select
    function addThemesToSelect(themes, prefix, groupLabel) {
        const optgroup = document.createElement('optgroup');
        optgroup.label = groupLabel;
        
        themes.forEach(theme => {
            const option = document.createElement('option');
            option.value = `${prefix}:${theme.id}`;
            option.textContent = theme.name;
            optgroup.appendChild(option);
            
            // ×”×•×¡×¤×” ×œ××™×¤×•×™ ×©××•×ª
            themeNames[`${prefix}:${theme.id}`] = theme.name;
        });
        
        dayThemeSelect.appendChild(optgroup.cloneNode(true));
        nightThemeSelect.appendChild(optgroup);
    }

    // ×˜×¢×™× ×ª ×”×’×“×¨×•×ª ×§×™×™××•×ª
    async function loadSettings() {
        if (typeof ThemeScheduler !== 'undefined') {
            const schedule = await ThemeScheduler.load();
            if (schedule) {
                enabledToggle.checked = schedule.enabled;
                dayThemeSelect.value = schedule.day_theme || 'builtin:classic';
                nightThemeSelect.value = schedule.night_theme || 'builtin:dark';
                dayStartInput.value = schedule.day_start || '07:00';
                dayEndInput.value = schedule.day_end || '20:00';
                validateTimeRange();
                updateUI();
            }
        }
    }

    // ×¢×“×›×•×Ÿ ×××©×§
    function updateUI() {
        const enabled = enabledToggle.checked;
        settingsDiv.style.display = enabled ? 'block' : 'none';
        testBtn.style.display = enabled ? 'inline-flex' : 'none';
        
        if (enabled) {
            updatePreview();
            updateCurrentStatus();
        }
    }

    // ×¢×“×›×•×Ÿ ×ª×¦×•×’×” ××§×“×™××”
    function updatePreview() {
        const dayStart = dayStartInput.value || '07:00';
        const dayEnd = dayEndInput.value || '20:00';
        const dayTheme = dayThemeSelect.value;
        const nightTheme = nightThemeSelect.value;

        document.getElementById('dayPreviewTime').textContent = `${dayStart} - ${dayEnd}`;
        document.getElementById('nightPreviewTime').textContent = `${dayEnd} - ${dayStart}`;
        document.getElementById('dayPreviewTheme').textContent = 
            themeNames[dayTheme] || dayTheme.split(':').pop();
        document.getElementById('nightPreviewTheme').textContent = 
            themeNames[nightTheme] || nightTheme.split(':').pop();
    }

    // ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ × ×•×›×—×™
    function updateCurrentStatus() {
        if (typeof ThemeScheduler !== 'undefined' && ThemeScheduler.isEnabled()) {
            const result = ThemeScheduler.getCurrentPeriod();
            const override = ThemeScheduler.getOverride();
            
            if (result && result.period) {
                currentStatus.style.display = 'flex';
                const periodName = result.period === 'day' ? '×™×•×' : '×œ×™×œ×”';
                const themeName = themeNames[result.themeId] || result.theme;
                
                if (override) {
                    statusText.innerHTML = `
                        <span style="color: var(--warning);">
                            <i class="fas fa-hand-paper"></i>
                            ×©×™× ×•×™ ×™×“× ×™ ×¤×¢×™×œ
                        </span>`;
                    nextChangeText.textContent = `×™×ª×‘×˜×œ ×‘-${override.expiresAtFormatted}`;
                } else {
                    statusText.textContent = `×›×¨×’×¢: ×¢×¨×›×ª ${periodName} (${themeName})`;
                    nextChangeText.textContent = `×©×™× ×•×™ ×”×‘×: ${result.nextChangeAt}`;
                }
            } else {
                currentStatus.style.display = 'none';
            }
        } else {
            currentStatus.style.display = 'none';
        }
    }

    // ×©××™×¨×”
    async function saveSettings() {
        // ×•×•×œ×™×“×¦×™×” ×œ×¤× ×™ ×©××™×¨×”
        if (!validateTimeRange()) {
            showToast('×× × ×ª×§×Ÿ ××ª ×˜×•×•×— ×”×©×¢×•×ª', 'error');
            return;
        }
        
        const schedule = {
            enabled: enabledToggle.checked,
            day_theme: dayThemeSelect.value,
            night_theme: nightThemeSelect.value,
            day_start: dayStartInput.value,
            day_end: dayEndInput.value,
        };

        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ×©×•××¨...';

        try {
            if (typeof ThemeScheduler !== 'undefined') {
                const result = await ThemeScheduler.save(schedule);
                if (result.success) {
                    showToast('×”×”×’×“×¨×•×ª × ×©××¨×• ×‘×”×¦×œ×—×”!', 'success');
                    updateCurrentStatus();
                } else {
                    showToast(result.message || result.error || '×©×’×™××” ×‘×©××™×¨×”', 'error');
                }
            }
        } catch (e) {
            showToast('×©×’×™××” ×‘×©××™×¨×”', 'error');
        }

        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="fas fa-save"></i> ×©××•×¨ ×”×’×“×¨×•×ª';
    }

    // ×‘×“×™×§×” ×¢×›×©×™×•
    function testNow() {
        if (typeof ThemeScheduler !== 'undefined') {
            // ×‘×™×˜×•×œ override ×× ×™×©
            ThemeScheduler.clearOverride();
            
            // ×”×—×œ×ª ×”×¢×¨×›×” ×œ×¤×™ ×”×ª×–××•×Ÿ
            const result = ThemeScheduler.getCurrentPeriod();
            if (result.theme) {
                ThemeScheduler.applyTheme(result.theme);
            }
            
            updateCurrentStatus();
            showToast('×”×¢×¨×›×” ×¢×•×“×›× ×” ×œ×¤×™ ×”×ª×–××•×Ÿ ×”× ×•×›×—×™', 'success');
        }
    }

    // Toast
    function showToast(message, type = 'info') {
        // ×”×¡×¨×ª toast ×§×•×“×
        document.querySelectorAll('.schedule-toast').forEach(t => t.remove());
        
        const toast = document.createElement('div');
        toast.className = `schedule-toast toast-${type}`;
        toast.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> 
            ${message}
        `;
        toast.style.cssText = `
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 0.75rem 1.5rem;
            background: ${type === 'success' ? 'var(--success, #22c55e)' : 'var(--error, #ef4444)'};
            color: white;
            border-radius: 10px;
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            animation: fadeInUp 0.3s ease-out;
        `;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
    }

    // Event Listeners
    enabledToggle.addEventListener('change', updateUI);
    dayThemeSelect.addEventListener('change', updatePreview);
    nightThemeSelect.addEventListener('change', updatePreview);
    dayStartInput.addEventListener('change', () => {
        validateTimeRange();
        updatePreview();
    });
    dayEndInput.addEventListener('change', () => {
        validateTimeRange();
        updatePreview();
    });
    saveBtn.addEventListener('click', saveSettings);
    testBtn.addEventListener('click', testNow);

    // ×˜×¢×™× ×” ×¨××©×•× ×™×ª
    await loadCustomThemes();
    await loadSettings();
    
    // ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×›×œ 30 ×©× ×™×•×ª
    setInterval(updateCurrentStatus, 30000);
});
</script>

<style>
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateX(-50%) translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
}

.form-error {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.5rem;
    padding: 0.5rem 0.75rem;
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
    border-radius: 8px;
    color: var(--error, #ef4444);
    font-size: 0.85rem;
}

.form-error i {
    flex-shrink: 0;
}
</style>
{% endblock %}
```

### 4.2 ×”×•×¡×¤×ª Route ×‘-`app.py`

```python
@app.route('/settings/theme-schedule')
def theme_schedule_page():
    """×“×£ ×”×’×“×¨×•×ª ×ª×–××•×Ÿ ×¢×¨×›×•×ª × ×•×©×."""
    if 'user_id' not in session:
        return redirect(url_for('login'))
    return render_template('settings/theme_schedule.html')
```

### 4.3 ×”×•×¡×¤×ª ×§×™×©×•×¨ ×‘×ª×¤×¨×™×˜ ×”×”×’×“×¨×•×ª

×¢×“×›×Ÿ ××ª `settings.html` ××• ××ª ×”×ª×¤×¨×™×˜ ×”×¨××©×™:

```html
<a href="/settings/theme-schedule" class="settings-link">
    <i class="fas fa-clock"></i>
    ×ª×–××•×Ÿ ×¢×¨×›×•×ª × ×•×©×
    <span class="badge badge-new">×—×“×©</span>
</a>
```

---

## ×©×œ×‘ 5: ××™× ×˜×’×¨×¦×™×” ×¢× ×”××¢×¨×›×ª ×”×§×™×™××ª

### 5.1 ×¢×“×›×•×Ÿ `dark-mode.js`

×”×•×¡×£ ×ª××™×›×” ×‘×ª×–××•×Ÿ ×•-override ×œ××•×“×•×œ ×”×§×™×™×:

```javascript
// ×¢×“×›×Ÿ ××ª ×”×¤×•× ×§×¦×™×” toggleDarkMode() ×‘-dark-mode.js

function toggleDarkMode() {
    const current = loadPreference();
    let next;
    switch (current) {
        case 'auto': next = 'dark'; break;
        case 'dark': next = 'dim'; break;
        case 'dim': next = 'light'; break;
        case 'light':
        default: next = 'auto'; break;
    }
    
    savePreference(next);
    
    // ğŸ†• ×× ×™×© ×ª×–××•×Ÿ ×¤×¢×™×œ, ×”×’×“×¨ override ×–×× ×™
    if (typeof ThemeScheduler !== 'undefined' && ThemeScheduler.isEnabled()) {
        const themeName = (next === 'auto') 
            ? (getSystemPreference() === 'dark' ? 'dark' : 'classic')
            : (next === 'light' ? 'classic' : next);
        
        ThemeScheduler.setOverride(themeName);
        applyTheme(themeName);
    } else {
        // ×”×ª× ×”×’×•×ª ×¨×’×™×œ×”
        if (loadPreference()) { updateTheme(); }
    }
    
    updateToggleButton(next);
    syncToServer(next);
}

// ×¢×“×›×Ÿ ××ª ×”×¤×•× ×§×¦×™×” updateTheme()

function updateTheme() {
    // ğŸ†• ×‘×“×™×§×” ×× ×™×© ×ª×–××•×Ÿ ×¤×¢×™×œ (×•×œ× override)
    if (typeof ThemeScheduler !== 'undefined' && ThemeScheduler.isEnabled()) {
        const override = ThemeScheduler.getOverride();
        if (!override) {
            // ×”×ª×–××•×Ÿ ×¤×¢×™×œ ×•××™×Ÿ override - ×”-scheduler ××˜×¤×œ ×‘×–×”
            return;
        }
        // ×™×© override - × ××©×™×š ×œ×˜×¤×œ ×›×¨×’×™×œ
    }
    
    const preference = loadPreference();
    if (!preference) {
        return; // ××™×Ÿ ×”×¢×“×¤×” ×©××•×¨×” - × ×›×‘×“ ××ª ×¢×¨×š ×”×©×¨×ª
    }
    
    if (preference === 'auto') {
        applyTheme('auto');
        // ... ×”××–× ×” ×œ×©×™× ×•×™×™ ××¢×¨×›×ª ...
    } else {
        const normalized = normalizePreferenceValue(preference);
        applyTheme(normalized || preference);
    }
}
```

### 5.2 ×¢×“×›×•×Ÿ `_inject_globals` ×‘-`app.py`

×”×•×¡×£ ××ª ×”×’×“×¨×•×ª ×”×ª×–××•×Ÿ ×œ-template context:

```python
def _inject_globals():
    # ... ×§×•×“ ×§×™×™× ...
    
    # Theme Schedule
    theme_schedule = None
    try:
        if user_id and user_doc:
            ts = (user_doc.get('ui_prefs') or {}).get('theme_schedule')
            if isinstance(ts, dict) and ts.get('enabled'):
                theme_schedule = ts
    except Exception:
        theme_schedule = None
    
    return {
        # ... ×©××¨ ×”××©×ª× ×™× ...
        'theme_schedule': theme_schedule,
    }
```

### 5.3 ×”×•×¡×¤×ª Script ×‘-`base.html` ×œ×× ×™×¢×ª FOUC

×”×•×¡×£ ×‘-`<head>` ×œ×¤× ×™ ×˜×¢×™× ×ª CSS:

```html
<script>
    // Theme Schedule - ×× ×™×¢×ª FOUC
    // ×”×¢×¨×”: ×”×œ×•×’×™×§×” ×× ×™×—×” ×©-day_start < day_end ×ª××™×“ (××™×Ÿ ×—×¦×™×™×ª ×—×¦×•×ª)
    (function() {
        try {
            // ×‘×“×™×§×ª override ×™×“× ×™ ×§×•×“×
            var override = localStorage.getItem('theme_manual_override');
            if (override) {
                override = JSON.parse(override);
                if (override && override.expiresAt > Date.now() && override.theme) {
                    document.documentElement.setAttribute('data-theme', override.theme);
                    return;
                }
            }
            
            // ×˜×¢×™× ×ª ×”×’×“×¨×•×ª ×ª×–××•×Ÿ
            var cached = localStorage.getItem('theme_schedule_cache');
            if (!cached) return;
            
            var data = JSON.parse(cached);
            var schedule = data.schedule || data; // ×ª××™×›×” ×‘×¤×•×¨××˜ ×™×©×Ÿ ×•×—×“×©
            
            if (!schedule || !schedule.enabled) return;
            
            // ×‘×“×™×§×ª ×ª×•×§×£ cache (24 ×©×¢×•×ª)
            if (data.fetchedAt && (Date.now() - data.fetchedAt) > 86400000) return;
            
            var now = new Date();
            var currentMins = now.getHours() * 60 + now.getMinutes();
            
            function timeToMins(t) {
                if (!t) return 0;
                var p = t.split(':');
                return parseInt(p[0], 10) * 60 + parseInt(p[1], 10);
            }
            
            var dayStart = timeToMins(schedule.day_start || '07:00');
            var dayEnd = timeToMins(schedule.day_end || '20:00');
            
            // ×œ×•×’×™×§×” ×¤×©×•×˜×”: ×™×•× = ×‘×ª×•×š ×”×˜×•×•×— [dayStart, dayEnd)
            var isDay = currentMins >= dayStart && currentMins < dayEnd;
            
            var themeId = isDay ? schedule.day_theme : schedule.night_theme;
            if (!themeId) return;
            
            // ×—×™×œ×•×¥ ×©× ×”×¢×¨×›×” ××”××–×”×” ×”××œ×
            var theme = themeId.indexOf(':') > -1 
                ? themeId.split(':')[1] 
                : themeId;
            
            // ×¢×‘×•×¨ shared/custom, × ×©×ª××© ×‘××–×”×” ×›××• ×©×”×•× (×”-CSS ×™×˜×¤×œ)
            if (themeId.startsWith('shared:') || themeId.startsWith('custom:')) {
                theme = themeId;
            }
            
            if (theme) {
                document.documentElement.setAttribute('data-theme', theme);
            }
        } catch(e) {
            // ×©×§×˜ - ×œ× × ×¨×¦×” ×œ×©×‘×•×¨ ××ª ×”×“×£
        }
    })();
</script>
```

---

## ×©×œ×‘ 6: ×‘×“×™×§×•×ª

### 6.1 Unit Tests

×¦×•×¨ ×§×•×‘×¥: `tests/test_theme_schedule.py`

```python
"""×‘×“×™×§×•×ª ×œ××¢×¨×›×ª ×ª×–××•×Ÿ ×¢×¨×›×•×ª × ×•×©×."""

import pytest
from datetime import datetime
from unittest.mock import patch, MagicMock


class TestTimeValidation:
    """×‘×“×™×§×•×ª ×•×•×œ×™×“×¦×™×” ×©×œ ×©×¢×•×ª."""

    def test_valid_time_format(self):
        from webapp.themes_api import validate_time_format
        
        assert validate_time_format("07:00") is True
        assert validate_time_format("23:59") is True
        assert validate_time_format("00:00") is True
        assert validate_time_format("12:30") is True
        assert validate_time_format("9:00") is True  # ×—×“-×¡×¤×¨×ª×™

    def test_invalid_time_format(self):
        from webapp.themes_api import validate_time_format
        
        assert validate_time_format("25:00") is False
        assert validate_time_format("12:60") is False
        assert validate_time_format("abc") is False
        assert validate_time_format("") is False
        assert validate_time_format(None) is False
        assert validate_time_format("12:00:00") is False  # ×¢× ×©× ×™×•×ª


class TestThemeIdentifierValidation:
    """×‘×“×™×§×•×ª ×•×•×œ×™×“×¦×™×” ×©×œ ××–×”×™ ×¢×¨×›×•×ª."""

    def test_valid_builtin_themes(self):
        from webapp.themes_api import validate_theme_identifier
        
        assert validate_theme_identifier("builtin:classic")[0] is True
        assert validate_theme_identifier("builtin:dark")[0] is True
        assert validate_theme_identifier("builtin:dim")[0] is True
        assert validate_theme_identifier("builtin:nebula")[0] is True

    def test_invalid_builtin_theme(self):
        from webapp.themes_api import validate_theme_identifier
        
        is_valid, error = validate_theme_identifier("builtin:nonexistent")
        assert is_valid is False
        assert error == "unknown_builtin_theme"

    def test_invalid_prefix(self):
        from webapp.themes_api import validate_theme_identifier
        
        is_valid, error = validate_theme_identifier("invalid:theme")
        assert is_valid is False
        assert error == "invalid_theme_prefix"

    def test_shared_theme_format(self):
        from webapp.themes_api import validate_theme_identifier
        
        # ×‘×œ×™ DB, ××—×–×™×¨ ×ª×§×™×Ÿ (×œ× ×™×›×•×œ×™× ×œ×‘×“×•×§ ×§×™×•×)
        assert validate_theme_identifier("shared:abc123")[0] is True

    def test_custom_theme_format(self):
        from webapp.themes_api import validate_theme_identifier
        
        # ×‘×œ×™ DB, ××—×–×™×¨ ×ª×§×™×Ÿ
        assert validate_theme_identifier("custom:my-uuid")[0] is True


class TestScheduleValidation:
    """×‘×“×™×§×•×ª ×•×•×œ×™×“×¦×™×” ×©×œ ×ª×–××•×Ÿ ××œ×."""

    def test_valid_schedule(self):
        from webapp.themes_api import _validate_theme_schedule
        
        schedule = {
            "enabled": True,
            "day_theme": "builtin:classic",
            "night_theme": "builtin:dark",
            "day_start": "07:00",
            "day_end": "20:00",
        }
        
        is_valid, error = _validate_theme_schedule(schedule)
        assert is_valid is True
        assert error == ""

    def test_day_start_after_day_end_rejected(self):
        """×•×•×œ×™×“×¦×™×”: day_start ×—×™×™×‘ ×œ×”×™×•×ª ×œ×¤× ×™ day_end."""
        from webapp.themes_api import _validate_theme_schedule
        
        schedule = {
            "day_start": "20:00",
            "day_end": "07:00",  # ×œ×¤× ×™ day_start!
        }
        
        is_valid, error = _validate_theme_schedule(schedule)
        assert is_valid is False
        assert error == "day_start_must_be_before_day_end"

    def test_day_range_too_short(self):
        """×•×•×œ×™×“×¦×™×”: ×˜×•×•×— ×™×•× ××™× ×™××œ×™ ×©×¢×”."""
        from webapp.themes_api import _validate_theme_schedule
        
        schedule = {
            "day_start": "12:00",
            "day_end": "12:30",  # ×¨×§ 30 ×“×§×•×ª
        }
        
        is_valid, error = _validate_theme_schedule(schedule)
        assert is_valid is False
        assert error == "day_range_too_short"

    def test_same_start_and_end_rejected(self):
        """×•×•×œ×™×“×¦×™×”: ××•×ª×” ×©×¢×” ×”×ª×—×œ×” ×•×¡×™×•×."""
        from webapp.themes_api import _validate_theme_schedule
        
        schedule = {
            "day_start": "12:00",
            "day_end": "12:00",
        }
        
        is_valid, error = _validate_theme_schedule(schedule)
        assert is_valid is False
        assert error == "day_start_must_be_before_day_end"


class TestAPIEndpoints:
    """×‘×“×™×§×•×ª API."""

    @pytest.fixture
    def client(self, app):
        return app.test_client()

    def test_get_schedule_unauthorized(self, client):
        """×‘×“×™×§×” ×©× ×“×¨×© ×œ×•×’×™×Ÿ."""
        response = client.get('/api/themes/schedule')
        assert response.status_code == 401

    def test_get_schedule_authorized(self, client, logged_in_user):
        """×‘×“×™×§×ª ×§×‘×œ×ª ×”×’×“×¨×•×ª."""
        response = client.get('/api/themes/schedule')
        assert response.status_code == 200
        data = response.get_json()
        assert data['ok'] is True
        assert 'schedule' in data
        # ×‘×“×™×§×ª ×¢×¨×›×™ ×‘×¨×™×¨×ª ××—×“×œ
        assert data['schedule']['enabled'] is False
        assert data['schedule']['day_theme'] == 'builtin:classic'

    def test_update_schedule_valid(self, client, logged_in_user):
        """×‘×“×™×§×ª ×¢×“×›×•×Ÿ ×”×’×“×¨×•×ª ×ª×§×™× ×•×ª."""
        response = client.post('/api/themes/schedule', json={
            "enabled": True,
            "day_theme": "builtin:ocean",
            "night_theme": "builtin:dim",
            "day_start": "08:00",
            "day_end": "19:00",
        })
        assert response.status_code == 200
        data = response.get_json()
        assert data['ok'] is True
        assert data['schedule']['enabled'] is True

    def test_update_schedule_invalid_time_range(self, client, logged_in_user):
        """×‘×“×™×§×ª ×“×—×™×™×ª ×˜×•×•×— ×©×¢×•×ª ×œ× ×ª×§×™×Ÿ."""
        response = client.post('/api/themes/schedule', json={
            "day_start": "20:00",
            "day_end": "08:00",  # ×œ×¤× ×™ day_start
        })
        assert response.status_code == 400
        data = response.get_json()
        assert data['ok'] is False
        assert "day_start_must_be_before_day_end" in data['error']

    def test_update_schedule_invalid_theme(self, client, logged_in_user):
        """×‘×“×™×§×ª ×“×—×™×™×ª ×¢×¨×›×” ×œ× ×§×™×™××ª."""
        response = client.post('/api/themes/schedule', json={
            "day_theme": "builtin:nonexistent",
        })
        assert response.status_code == 400
        data = response.get_json()
        assert data['ok'] is False
        assert "unknown_builtin_theme" in data['error']
```

### 6.2 Integration Tests

```python
"""×‘×“×™×§×•×ª ××™× ×˜×’×¨×¦×™×” ×œ×ª×–××•×Ÿ ×¢×¨×›×•×ª."""

import pytest
from playwright.sync_api import Page


class TestThemeScheduleUI:
    """×‘×“×™×§×•×ª ×××©×§ ××©×ª××©."""

    def test_schedule_page_loads(self, page: Page, logged_in_session):
        """×‘×“×™×§×” ×©×“×£ ×”×”×’×“×¨×•×ª × ×˜×¢×Ÿ."""
        page.goto('/settings/theme-schedule')
        assert page.locator('h1').text_content() == '×ª×–××•×Ÿ ×¢×¨×›×•×ª × ×•×©× ××•×˜×•××˜×™'

    def test_toggle_enables_settings(self, page: Page, logged_in_session):
        """×‘×“×™×§×” ×©×”×”×¤×¢×œ×” ××¦×™×’×” ××ª ×”×”×’×“×¨×•×ª."""
        page.goto('/settings/theme-schedule')
        
        settings = page.locator('#scheduleSettings')
        assert settings.is_hidden()
        
        page.locator('#scheduleEnabled').click()
        assert settings.is_visible()

    def test_save_schedule(self, page: Page, logged_in_session):
        """×‘×“×™×§×ª ×©××™×¨×ª ×”×’×“×¨×•×ª."""
        page.goto('/settings/theme-schedule')
        
        page.locator('#scheduleEnabled').click()
        page.locator('#dayTheme').select_option('ocean')
        page.locator('#nightTheme').select_option('dim')
        page.locator('#saveScheduleBtn').click()
        
        # ×‘×“×™×§×” ×©×”×•×“×¢×ª ×”×¦×œ×—×” ××•×¦×’×ª
        toast = page.locator('.toast-success')
        assert toast.is_visible()
```

---

## ×©×™×§×•×œ×™ UX ×•× ×’×™×©×•×ª

### 7.1 × ×’×™×©×•×ª (A11y)

```html
<!-- ×”×•×¡×£ ×ª×›×•× ×•×ª × ×’×™×©×•×ª -->
<input 
    type="checkbox" 
    id="scheduleEnabled" 
    class="toggle-input"
    role="switch"
    aria-checked="false"
    aria-label="×”×¤×¢×œ ×ª×–××•×Ÿ ××•×˜×•××˜×™ ×©×œ ×¢×¨×›×•×ª × ×•×©×">

<select 
    id="dayTheme" 
    class="form-control theme-select"
    aria-label="×‘×—×¨ ×¢×¨×›×ª × ×•×©× ×œ×©×¢×•×ª ×”×™×•×">
```

### 7.2 ×”×•×“×¢×•×ª ×œ××©×ª××©

```javascript
// ×”×•×“×¢×” ×›×©×”×ª×–××•×Ÿ ××©×ª× ×”
window.addEventListener('themeChanged', (e) => {
    if (e.detail.source === 'scheduler') {
        const theme = e.detail.theme;
        const isDay = ['classic', 'ocean', 'forest', 'rose-pine-dawn'].includes(theme);
        
        // ×”×¦×’ ×”×•×“×¢×” ×¢×“×™× ×” (optional)
        console.log(`×¢×¨×›×ª × ×•×©× ×¢×•×“×›× ×” ×œ${isDay ? '×™×•×' : '×œ×™×œ×”'}: ${theme}`);
    }
});
```

### 7.3 ×”×ª×××” ×œ××•×‘×™×™×œ

```css
@media (max-width: 600px) {
    .time-range {
        flex-direction: column;
    }
    
    .time-separator {
        padding: 0.5rem 0;
    }
    
    .schedule-preview {
        padding: 0.75rem;
    }
    
    .preview-item {
        flex-wrap: wrap;
    }
    
    .preview-theme {
        width: 100%;
        text-align: center;
        margin-top: 0.5rem;
    }
}
```

---

## ×¡×™×›×•×

### ×§×‘×¦×™× ×©×¦×¨×™×š ×œ×™×¦×•×¨/×œ×¢×¨×•×š:

| ×§×•×‘×¥ | ×¤×¢×•×œ×” | ×ª×™××•×¨ |
|------|-------|-------|
| `webapp/themes_api.py` | ×¢×¨×™×›×” | ×”×•×¡×¤×ª API endpoints |
| `webapp/static/js/theme-scheduler.js` | ×™×¦×™×¨×” | ×œ×•×’×™×§×” ×¦×“ ×œ×§×•×— |
| `webapp/templates/settings/theme_schedule.html` | ×™×¦×™×¨×” | ×××©×§ ×”×’×“×¨×•×ª |
| `webapp/templates/base.html` | ×¢×¨×™×›×” | Script ×œ×× ×™×¢×ª FOUC + ×˜×¢×™× ×ª JS |
| `webapp/app.py` | ×¢×¨×™×›×” | Route + inject globals |
| `webapp/static/js/dark-mode.js` | ×¢×¨×™×›×” | ××™× ×˜×’×¨×¦×™×” ×¢× ×”×ª×–××•×Ÿ |
| `tests/test_theme_schedule.py` | ×™×¦×™×¨×” | ×‘×“×™×§×•×ª |

### ×ª×¨×©×™× ×–×¨×™××” ××¡×›×:

```
User enables schedule â†’ Settings saved to DB
                              â†“
Page loads â†’ JS checks schedule â†’ Calculates current period
                              â†“
                   Applies correct theme
                              â†“
Timer runs every minute â†’ Checks if period changed
                              â†“
              If changed â†’ Applies new theme
```

### ×ª×›×•× ×•×ª ×¢×ª×™×“×™×•×ª ××¤×©×¨×™×•×ª:

1. **×ª×–××•×Ÿ ××‘×•×¡×¡ ××™×§×•×**: ×©×™××•×© ×‘-Geolocation API ×œ×—×™×©×•×‘ ×–×¨×™×—×”/×©×§×™×¢×”
2. **×¢×¨×›×•×ª ×œ×¤×™ ×™×•× ×‘×©×‘×•×¢**: ×¢×¨×›×•×ª ×©×•× ×•×ª ×œ×¡×•×¤"×©
3. **×ª×–××•×Ÿ ××ª×§×“×**: ×™×•×ª×¨ ××©× ×™ ×¤×¨×§×™ ×–××Ÿ (×‘×•×§×¨/×¦×”×¨×™×™×/×¢×¨×‘/×œ×™×œ×”)
4. **×¡× ×›×¨×•×Ÿ ×¢× ××¢×¨×›×ª ×”×”×¤×¢×œ×”**: ×©×™××•×© ×‘-`prefers-color-scheme-schedule` (×¢×ª×™×“×™)

---

## Changelog

### v1.1 (×™× ×•××¨ 2026)
- **×ª×™×§×•×Ÿ**: ×”×œ×§×•×— ×”×•× ××§×•×¨ ×”×××ª ×œ×–××Ÿ (×œ× ×”×©×¨×ª)
- **×ª×™×§×•×Ÿ**: ×—×¡×™××ª ×˜×•×•×— ×™×•× ×©×—×•×¦×” ×—×¦×•×ª ×‘×•×•×œ×™×“×¦×™×”
- **×©×™×¤×•×¨**: ×˜×™×™××¨ ×—×›× (`setTimeout`) ×‘××§×•× polling
- **×©×™×¤×•×¨**: ×ª××™×›×” ×‘-override ×™×“× ×™ ×–×× ×™
- **×©×™×¤×•×¨**: ××–×”×” ×¢×¨×›×” ××œ× (builtin:/shared:/custom:)
- **×©×™×¤×•×¨**: cache ×¢× last_fetched_at
- **×©×™×¤×•×¨**: ×”×•×“×¢×•×ª ×©×’×™××” ×‘×¢×‘×¨×™×ª

### v1.0 (×™× ×•××¨ 2026)
- ××™××•×© ×¨××©×•× ×™

---

**× ×•×¦×¨ ×¢×œ ×™×“×™**: Background Agent  
**×ª××¨×™×š**: ×™× ×•××¨ 2026  
**×’×¨×¡×”**: 1.1
