# ××“×¨×™×š ××™××•×© - ×ª×—×œ×•×¤×ª ×¢×¨×›×•×ª × ×•×©× ××•×˜×•××˜×™×ª ×œ×¤×™ ×©×¢×•×ª ×‘×™×××”

**×ª××¨×™×š**: ×™× ×•××¨ 2026  
**×’×¨×¡×”**: 1.0  
**×¡×˜×˜×•×¡**: ××“×¨×™×š ××™××•×©

---

## ğŸ“‹ ×ª×•×›×Ÿ ×¢× ×™×™× ×™×

1. [×¡×§×™×¨×” ×›×œ×œ×™×ª](#×¡×§×™×¨×”-×›×œ×œ×™×ª)
2. [××¨×›×™×˜×§×˜×•×¨×”](#××¨×›×™×˜×§×˜×•×¨×”)
3. [×©×œ×‘ 1: ×¢×“×›×•×Ÿ ××‘× ×” ×”× ×ª×•× ×™×](#×©×œ×‘-1-×¢×“×›×•×Ÿ-××‘× ×”-×”× ×ª×•× ×™×)
4. [×©×œ×‘ 2: ×™×¦×™×¨×ª API Backend](#×©×œ×‘-2-×™×¦×™×¨×ª-api-backend)
5. [×©×œ×‘ 3: ××™××•×© ×”×œ×•×’×™×§×” ×‘×¦×“ ×”×œ×§×•×—](#×©×œ×‘-3-××™××•×©-×”×œ×•×’×™×§×”-×‘×¦×“-×”×œ×§×•×—)
6. [×©×œ×‘ 4: ×¢×“×›×•×Ÿ ×××©×§ ×”××©×ª××©](#×©×œ×‘-4-×¢×“×›×•×Ÿ-×××©×§-×”××©×ª××©)
7. [×©×œ×‘ 5: ××™× ×˜×’×¨×¦×™×” ×¢× ×”××¢×¨×›×ª ×”×§×™×™××ª](#×©×œ×‘-5-××™× ×˜×’×¨×¦×™×”-×¢×-×”××¢×¨×›×ª-×”×§×™×™××ª)
8. [×©×œ×‘ 6: ×‘×“×™×§×•×ª](#×©×œ×‘-6-×‘×“×™×§×•×ª)
9. [×©×™×§×•×œ×™ UX ×•× ×’×™×©×•×ª](#×©×™×§×•×œ×™-ux-×•× ×’×™×©×•×ª)
10. [×¡×™×›×•×](#×¡×™×›×•×)

---

## ×¡×§×™×¨×” ×›×œ×œ×™×ª

### ××” ×”×¤×™×¦'×¨ ×¢×•×©×”?

×××¤×©×¨ ×œ××©×ª××©×™× ×œ×”×’×“×™×¨ ×ª×—×œ×•×¤×” ××•×˜×•××˜×™×ª ×‘×™×Ÿ ×¢×¨×›×•×ª × ×•×©× ×œ×¤×™ ×©×¢×•×ª ×‘×™×××”:

- **×¢×¨×›×ª ×™×•×** (Day Theme): ××•×¤×¢×œ×ª ×‘×©×¢×•×ª ×”×™×•× ×©×”××©×ª××© ×”×’×“×™×¨
- **×¢×¨×›×ª ×œ×™×œ×”** (Night Theme): ××•×¤×¢×œ×ª ×‘×©×¢×•×ª ×”×œ×™×œ×” ×©×”××©×ª××© ×”×’×“×™×¨
- **××¦×‘ ×™×“× ×™**: ×”××©×ª××© ×™×›×•×œ ×œ×›×‘×•×ª ××ª ×”××•×˜×•××¦×™×” ×•×œ×‘×—×•×¨ ×¢×¨×›×” ×§×‘×•×¢×”

### ×“×•×’××” ×œ×ª×¨×—×™×© ×©×™××•×©

> ×™×•×¡×™ ××¢×“×™×£ ×¢×¨×›×” ×‘×”×™×¨×” (Classic) ×‘×™×•× ×›×“×™ ×œ×¢×‘×•×“ ×‘×¡×‘×™×‘×” ××•××¨×ª,  
> ×•×‘×œ×™×œ×” ×”×•× ×¢×•×‘×¨ ×œ×¢×¨×›×” ×›×”×” (Dark) ×›×“×™ ×œ×”×¤×—×™×ª ×¢×•××¡ ×¢×œ ×”×¢×™× ×™×™×.  
> ×”×•× ××’×“×™×¨: ×™×•× = 07:00-20:00, ×œ×™×œ×” = 20:00-07:00.

### ×™×ª×¨×•× ×•×ª

- âœ… ×”×¤×—×ª×ª ×¢×•××¡ ×¢×œ ×”×¢×™× ×™×™× ×‘×©×¢×•×ª ×”×œ×™×œ×”
- âœ… ×”×ª×××” ××•×˜×•××˜×™×ª ×œ×œ× ×¦×•×¨×š ×‘×”×—×œ×¤×” ×™×“× ×™×ª
- âœ… ×’××™×©×•×ª ××œ××” ×œ×‘×—×™×¨×ª ×©×¢×•×ª ×•×¢×¨×›×•×ª
- âœ… ×ª××™×›×” ×‘×›×œ ×¡×•×’×™ ×”×¢×¨×›×•×ª (Built-in, Shared, Custom)

---

## ××¨×›×™×˜×§×˜×•×¨×”

### ×ª×¨×©×™× ×–×¨×™××”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    User Settings Page                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Enable Auto â”‚  â”‚ Day Theme   â”‚  â”‚ Start/End Hours     â”‚  â”‚
â”‚  â”‚   Toggle    â”‚  â”‚ Selector    â”‚  â”‚ Time Pickers        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                â”‚                     â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                â”‚                     â”‚
          â–¼                â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    API Layer (Flask)                         â”‚
â”‚                                                              â”‚
â”‚  POST /api/theme-schedule                                    â”‚
â”‚  GET  /api/theme-schedule                                    â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MongoDB                                   â”‚
â”‚                                                              â”‚
â”‚  users.ui_prefs.theme_schedule: {                           â”‚
â”‚    enabled: true,                                            â”‚
â”‚    day_theme: "classic",                                     â”‚
â”‚    night_theme: "dark",                                      â”‚
â”‚    day_start: "07:00",                                       â”‚
â”‚    day_end: "20:00"                                          â”‚
â”‚  }                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Client-Side Logic (JavaScript)                 â”‚
â”‚                                                              â”‚
â”‚  1. Load schedule settings on page load                      â”‚
â”‚  2. Calculate current period (day/night)                     â”‚
â”‚  3. Apply appropriate theme                                  â”‚
â”‚  4. Set timer for next transition                            â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ××‘× ×” ×”×§×‘×¦×™×

```
webapp/
â”œâ”€â”€ themes_api.py              # ×”×•×¡×¤×ª endpoints ×—×“×©×™×
â”œâ”€â”€ static/
â”‚   â””â”€â”€ js/
â”‚       â””â”€â”€ theme-scheduler.js # ×œ×•×’×™×§×” ×¦×“ ×œ×§×•×— (×§×•×‘×¥ ×—×“×©)
â””â”€â”€ templates/
    â””â”€â”€ settings/
        â””â”€â”€ theme_schedule.html # ×××©×§ ×”×’×“×¨×•×ª (×§×•×‘×¥ ×—×“×©)
```

---

## ×©×œ×‘ 1: ×¢×“×›×•×Ÿ ××‘× ×” ×”× ×ª×•× ×™×

### 1.1 ×¡×›××ª MongoDB

×”×•×¡×£ ×œ××•×‘×™×™×§×˜ `ui_prefs` ×©×œ ×”××©×ª××©:

```javascript
// users collection - ui_prefs schema extension
{
  "user_id": 123456,
  "ui_prefs": {
    "theme": "classic",           // ×¢×¨×›×” × ×•×›×—×™×ª (×§×™×™×)
    "font_scale": 1.0,            // (×§×™×™×)
    
    // ğŸ†• ×”×’×“×¨×•×ª ×ª×–××•×Ÿ ×¢×¨×›×•×ª
    "theme_schedule": {
      "enabled": false,           // ×”×× ×”×ª×–××•×Ÿ ××•×¤×¢×œ
      "day_theme": "classic",     // ×¢×¨×›×ª ×™×•×
      "night_theme": "dark",      // ×¢×¨×›×ª ×œ×™×œ×”
      "day_start": "07:00",       // ×©×¢×ª ×”×ª×—×œ×ª ×™×•× (HH:MM)
      "day_end": "20:00"          // ×©×¢×ª ×¡×™×•× ×™×•× (HH:MM)
    }
  }
}
```

### 1.2 ×¢×¨×›×™ ×‘×¨×™×¨×ª ××—×“×œ

```python
# services/constants.py ××• webapp/themes_api.py

DEFAULT_THEME_SCHEDULE = {
    "enabled": False,
    "day_theme": "classic",
    "night_theme": "dark",
    "day_start": "07:00",
    "day_end": "20:00",
}

# ×¢×¨×›×•×ª × ×•×©× ××•×ª×¨×•×ª (×›×•×œ×œ shared ×•custom)
ALLOWED_SCHEDULE_THEMES = {
    "classic", "dark", "dim", "nebula", "ocean", 
    "forest", "rose-pine-dawn", "high-contrast", "custom"
}
```

### 1.3 ×•×•×œ×™×“×¦×™×”

```python
import re
from datetime import datetime

def validate_time_format(time_str: str) -> bool:
    """×‘×•×“×§ ×©×¤×•×¨××˜ ×”×©×¢×” ×ª×§×™×Ÿ (HH:MM)."""
    if not time_str or not isinstance(time_str, str):
        return False
    pattern = r"^([01]?[0-9]|2[0-3]):([0-5][0-9])$"
    return bool(re.match(pattern, time_str.strip()))

def validate_theme_schedule(schedule: dict) -> tuple[bool, str]:
    """
    ××××ª ××ª ×”×’×“×¨×•×ª ×ª×–××•×Ÿ ×”×¢×¨×›×•×ª.
    
    Returns:
        (is_valid, error_message)
    """
    if not isinstance(schedule, dict):
        return False, "invalid_format"
    
    # ×‘×“×™×§×ª enabled
    if "enabled" in schedule and not isinstance(schedule["enabled"], bool):
        return False, "invalid_enabled_value"
    
    # ×‘×“×™×§×ª ×¢×¨×›×•×ª × ×•×©×
    for key in ("day_theme", "night_theme"):
        if key in schedule:
            theme = schedule[key]
            if not isinstance(theme, str):
                return False, f"invalid_{key}"
            # ××¤×©×¨ ×’× ×¢×¨×›×•×ª shared:xxx ××• custom
            if not (theme in ALLOWED_SCHEDULE_THEMES or 
                    theme.startswith("shared:") or
                    theme == "custom"):
                return False, f"invalid_{key}"
    
    # ×‘×“×™×§×ª ×©×¢×•×ª
    for key in ("day_start", "day_end"):
        if key in schedule:
            if not validate_time_format(schedule[key]):
                return False, f"invalid_{key}_format"
    
    return True, ""
```

---

## ×©×œ×‘ 2: ×™×¦×™×¨×ª API Backend

### 2.1 ×”×•×¡×¤×” ×œ-`themes_api.py`

×”×•×¡×£ ××ª ×”×§×•×“ ×”×‘× ×œ×§×•×‘×¥ `webapp/themes_api.py`:

```python
# ============================================================
# Theme Schedule API - ×ª×–××•×Ÿ ×¢×¨×›×•×ª ×œ×¤×™ ×©×¢×•×ª
# ============================================================

DEFAULT_THEME_SCHEDULE = {
    "enabled": False,
    "day_theme": "classic",
    "night_theme": "dark",
    "day_start": "07:00",
    "day_end": "20:00",
}

ALLOWED_SCHEDULE_THEMES = {
    "classic", "dark", "dim", "nebula", "ocean",
    "forest", "rose-pine-dawn", "high-contrast", "custom"
}


def _validate_time_format(time_str: str) -> bool:
    """×‘×•×“×§ ×©×¤×•×¨××˜ ×”×©×¢×” ×ª×§×™×Ÿ (HH:MM)."""
    if not time_str or not isinstance(time_str, str):
        return False
    import re
    pattern = r"^([01]?[0-9]|2[0-3]):([0-5][0-9])$"
    return bool(re.match(pattern, time_str.strip()))


def _validate_theme_schedule(schedule: dict) -> tuple[bool, str]:
    """××××ª ××ª ×”×’×“×¨×•×ª ×ª×–××•×Ÿ ×”×¢×¨×›×•×ª."""
    if not isinstance(schedule, dict):
        return False, "invalid_format"

    if "enabled" in schedule and not isinstance(schedule["enabled"], bool):
        return False, "invalid_enabled_value"

    for key in ("day_theme", "night_theme"):
        if key in schedule:
            theme = schedule[key]
            if not isinstance(theme, str):
                return False, f"invalid_{key}"
            theme_lower = theme.lower().strip()
            if not (theme_lower in ALLOWED_SCHEDULE_THEMES or 
                    theme_lower.startswith("shared:") or
                    theme_lower == "custom"):
                return False, f"invalid_{key}"

    for key in ("day_start", "day_end"):
        if key in schedule:
            if not _validate_time_format(schedule[key]):
                return False, f"invalid_{key}_format"

    return True, ""


@themes_bp.route("/schedule", methods=["GET"])
@require_auth
def get_theme_schedule():
    """
    ×§×‘×œ×ª ×”×’×“×¨×•×ª ×ª×–××•×Ÿ ×¢×¨×›×•×ª ×”× ×•×©×.
    
    Response:
    {
        "ok": true,
        "schedule": {
            "enabled": false,
            "day_theme": "classic",
            "night_theme": "dark",
            "day_start": "07:00",
            "day_end": "20:00"
        }
    }
    """
    user_id = get_current_user_id()
    if not user_id:
        return jsonify({"ok": False, "error": "unauthorized"}), 401

    try:
        db_ref = get_db()
        user_doc = db_ref.users.find_one(
            {"user_id": int(user_id)},
            {"ui_prefs.theme_schedule": 1}
        ) or {}

        ui_prefs = user_doc.get("ui_prefs") or {}
        schedule = ui_prefs.get("theme_schedule") or {}

        # ××™×–×•×’ ×¢× ×‘×¨×™×¨×•×ª ××—×“×œ
        merged_schedule = {**DEFAULT_THEME_SCHEDULE, **schedule}

        return jsonify({"ok": True, "schedule": merged_schedule})

    except Exception as e:
        logger.exception("get_theme_schedule failed: %s", e)
        return jsonify({"ok": False, "error": "database_error"}), 500


@themes_bp.route("/schedule", methods=["POST"])
@require_auth
def update_theme_schedule():
    """
    ×¢×“×›×•×Ÿ ×”×’×“×¨×•×ª ×ª×–××•×Ÿ ×¢×¨×›×•×ª ×”× ×•×©×.
    
    Request body:
    {
        "enabled": true,
        "day_theme": "classic",
        "night_theme": "dark",
        "day_start": "07:00",
        "day_end": "20:00"
    }
    
    Response:
    {
        "ok": true,
        "message": "×”×’×“×¨×•×ª ×”×ª×–××•×Ÿ × ×©××¨×•",
        "schedule": { ... }
    }
    """
    user_id = get_current_user_id()
    if not user_id:
        return jsonify({"ok": False, "error": "unauthorized"}), 401

    data = request.get_json(silent=True) or {}

    # ×•×•×œ×™×“×¦×™×”
    is_valid, error_msg = _validate_theme_schedule(data)
    if not is_valid:
        return jsonify({"ok": False, "error": error_msg}), 400

    try:
        db_ref = get_db()
        now_utc = datetime.now(timezone.utc)

        # ×§×¨×™××” ×§×•×“××ª ×œ×§×‘×œ×ª ×¢×¨×›×™× ×§×™×™××™×
        user_doc = db_ref.users.find_one(
            {"user_id": int(user_id)},
            {"ui_prefs.theme_schedule": 1}
        ) or {}

        existing_schedule = (user_doc.get("ui_prefs") or {}).get("theme_schedule") or {}

        # ××™×–×•×’: ×‘×¨×™×¨×•×ª ××—×“×œ <- ×§×™×™× <- ×—×“×©
        new_schedule = {
            **DEFAULT_THEME_SCHEDULE,
            **existing_schedule,
        }

        # ×¢×“×›×•×Ÿ ×¨×§ ×©×“×•×ª ×©× ×©×œ×—×•
        if "enabled" in data:
            new_schedule["enabled"] = bool(data["enabled"])
        if "day_theme" in data:
            new_schedule["day_theme"] = str(data["day_theme"]).strip().lower()
        if "night_theme" in data:
            new_schedule["night_theme"] = str(data["night_theme"]).strip().lower()
        if "day_start" in data:
            new_schedule["day_start"] = str(data["day_start"]).strip()
        if "day_end" in data:
            new_schedule["day_end"] = str(data["day_end"]).strip()

        # ×©××™×¨×”
        db_ref.users.update_one(
            {"user_id": int(user_id)},
            {
                "$set": {
                    "ui_prefs.theme_schedule": new_schedule,
                    "updated_at": now_utc,
                }
            },
            upsert=True,
        )

        # ×× ×”×ª×–××•×Ÿ ××•×¤×¢×œ, ×¢×“×›×Ÿ ×’× ××ª ×”×¢×¨×›×” ×”× ×•×›×—×™×ª
        if new_schedule.get("enabled"):
            current_theme = _calculate_current_scheduled_theme(new_schedule)
            if current_theme:
                db_ref.users.update_one(
                    {"user_id": int(user_id)},
                    {"$set": {"ui_prefs.theme": current_theme}},
                )

        return jsonify({
            "ok": True,
            "message": "×”×’×“×¨×•×ª ×”×ª×–××•×Ÿ × ×©××¨×•",
            "schedule": new_schedule,
        })

    except Exception as e:
        logger.exception("update_theme_schedule failed: %s", e)
        return jsonify({"ok": False, "error": "database_error"}), 500


@themes_bp.route("/schedule/current", methods=["GET"])
@require_auth
def get_current_scheduled_theme():
    """
    ×§×‘×œ×ª ×”×¢×¨×›×” ×”× ×•×›×—×™×ª ×œ×¤×™ ×”×ª×–××•×Ÿ (×œ×œ× ×©×™× ×•×™ ×‘-DB).
    ×©×™××•×©×™ ×œ×œ×•×’×™×§×” ×¦×“ ×œ×§×•×—.
    
    Response:
    {
        "ok": true,
        "is_scheduled": true,
        "current_theme": "dark",
        "period": "night",
        "next_change_at": "07:00"
    }
    """
    user_id = get_current_user_id()
    if not user_id:
        return jsonify({"ok": False, "error": "unauthorized"}), 401

    try:
        db_ref = get_db()
        user_doc = db_ref.users.find_one(
            {"user_id": int(user_id)},
            {"ui_prefs.theme_schedule": 1}
        ) or {}

        schedule = (user_doc.get("ui_prefs") or {}).get("theme_schedule") or {}

        if not schedule.get("enabled"):
            return jsonify({
                "ok": True,
                "is_scheduled": False,
                "current_theme": None,
                "period": None,
                "next_change_at": None,
            })

        current_theme, period, next_change = _calculate_scheduled_theme_details(schedule)

        return jsonify({
            "ok": True,
            "is_scheduled": True,
            "current_theme": current_theme,
            "period": period,
            "next_change_at": next_change,
        })

    except Exception as e:
        logger.exception("get_current_scheduled_theme failed: %s", e)
        return jsonify({"ok": False, "error": "database_error"}), 500


def _calculate_current_scheduled_theme(schedule: dict) -> Optional[str]:
    """××—×©×‘ ××ª ×”×¢×¨×›×” ×”× ×•×›×—×™×ª ×œ×¤×™ ×ª×–××•×Ÿ ×•×©×¢×” × ×•×›×—×™×ª."""
    if not schedule or not schedule.get("enabled"):
        return None

    try:
        from datetime import datetime

        now = datetime.now()
        current_time = now.strftime("%H:%M")

        day_start = schedule.get("day_start", "07:00")
        day_end = schedule.get("day_end", "20:00")

        # ×‘×“×™×§×” ×× ×× ×—× ×• ×‘×˜×•×•×— ×”×™×•×
        if day_start <= day_end:
            # ×˜×•×•×— ×¨×’×™×œ (×œ××©×œ 07:00-20:00)
            is_day = day_start <= current_time < day_end
        else:
            # ×˜×•×•×— ×¢×•×‘×¨ ×—×¦×•×ª (×œ××©×œ 20:00-07:00 = ×œ×™×œ×”)
            is_day = current_time >= day_start or current_time < day_end

        if is_day:
            return schedule.get("day_theme", "classic")
        else:
            return schedule.get("night_theme", "dark")

    except Exception:
        return None


def _calculate_scheduled_theme_details(schedule: dict) -> tuple[str, str, str]:
    """
    ××—×©×‘ ×¤×¨×˜×™× ××œ××™× ×¢×œ ×”×ª×–××•×Ÿ ×”× ×•×›×—×™.
    
    Returns:
        (current_theme, period, next_change_time)
    """
    from datetime import datetime

    now = datetime.now()
    current_time = now.strftime("%H:%M")

    day_start = schedule.get("day_start", "07:00")
    day_end = schedule.get("day_end", "20:00")
    day_theme = schedule.get("day_theme", "classic")
    night_theme = schedule.get("night_theme", "dark")

    if day_start <= day_end:
        is_day = day_start <= current_time < day_end
        next_change = day_end if is_day else day_start
    else:
        is_day = current_time >= day_start or current_time < day_end
        next_change = day_end if is_day else day_start

    if is_day:
        return day_theme, "day", next_change
    else:
        return night_theme, "night", next_change
```

---

## ×©×œ×‘ 3: ××™××•×© ×”×œ×•×’×™×§×” ×‘×¦×“ ×”×œ×§×•×—

### 3.1 ×™×¦×™×¨×ª `theme-scheduler.js`

×¦×•×¨ ×§×•×‘×¥ ×—×“×©: `webapp/static/js/theme-scheduler.js`

```javascript
/**
 * Theme Scheduler - ×ª×–××•×Ÿ ××•×˜×•××˜×™ ×©×œ ×¢×¨×›×•×ª × ×•×©× ×œ×¤×™ ×©×¢×•×ª
 * 
 * ×”×¤×™×¦'×¨ ×××¤×©×¨ ×œ××©×ª××© ×œ×”×’×“×™×¨ ×¢×¨×›×ª ×™×•× ×•×¢×¨×›×ª ×œ×™×œ×”,
 * ×•×”××¢×¨×›×ª ××—×œ×™×¤×” ×‘×™× ×™×”×Ÿ ××•×˜×•××˜×™×ª ×œ×¤×™ ×”×©×¢×•×ª ×©×”×•×’×“×¨×•.
 */

(function() {
    'use strict';

    const STORAGE_KEY = 'theme_schedule_cache';
    const CHECK_INTERVAL = 60000; // ×‘×“×™×§×” ×›×œ ×“×§×”
    let checkTimer = null;
    let currentSchedule = null;

    /**
     * ×˜×¢×™× ×ª ×”×’×“×¨×•×ª ×ª×–××•×Ÿ ××”×©×¨×ª
     */
    async function loadSchedule() {
        try {
            const response = await fetch('/api/themes/schedule', {
                method: 'GET',
                credentials: 'same-origin',
            });

            if (!response.ok) {
                console.warn('Failed to load theme schedule');
                return null;
            }

            const data = await response.json();
            if (data.ok && data.schedule) {
                currentSchedule = data.schedule;
                // ×©××™×¨×” ×‘××˜××•×Ÿ ××§×•××™
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(data.schedule));
                } catch (e) {
                    // ignore localStorage errors
                }
                return data.schedule;
            }
        } catch (e) {
            console.warn('Error loading theme schedule:', e);
        }

        // × ×™×¡×™×•×Ÿ ×œ×˜×¢×•×Ÿ ×××˜××•×Ÿ ××§×•××™
        try {
            const cached = localStorage.getItem(STORAGE_KEY);
            if (cached) {
                currentSchedule = JSON.parse(cached);
                return currentSchedule;
            }
        } catch (e) {
            // ignore
        }

        return null;
    }

    /**
     * ×”××¨×ª ××—×¨×•×–×ª ×©×¢×” ×œ××¡×¤×¨ ×“×§×•×ª ××ª×—×™×œ×ª ×”×™×•×
     * @param {string} timeStr - ×©×¢×” ×‘×¤×•×¨××˜ "HH:MM"
     * @returns {number} - ××¡×¤×¨ ×“×§×•×ª ××—×¦×•×ª
     */
    function timeToMinutes(timeStr) {
        if (!timeStr || typeof timeStr !== 'string') return 0;
        const parts = timeStr.split(':');
        const hours = parseInt(parts[0], 10) || 0;
        const minutes = parseInt(parts[1], 10) || 0;
        return hours * 60 + minutes;
    }

    /**
     * ×§×‘×œ×ª ×”×©×¢×” ×”× ×•×›×—×™×ª ×›××¡×¤×¨ ×“×§×•×ª
     * @returns {number}
     */
    function getCurrentMinutes() {
        const now = new Date();
        return now.getHours() * 60 + now.getMinutes();
    }

    /**
     * ×—×™×©×•×‘ ×× ×× ×—× ×• ×‘×ª×§×•×¤×ª ×™×•× ××• ×œ×™×œ×”
     * @param {Object} schedule - ×”×’×“×¨×•×ª ×”×ª×–××•×Ÿ
     * @returns {Object} - { period: 'day'|'night', theme: string, nextChangeIn: number }
     */
    function calculateCurrentPeriod(schedule) {
        if (!schedule || !schedule.enabled) {
            return { period: null, theme: null, nextChangeIn: null };
        }

        const currentMins = getCurrentMinutes();
        const dayStart = timeToMinutes(schedule.day_start || '07:00');
        const dayEnd = timeToMinutes(schedule.day_end || '20:00');
        const dayTheme = schedule.day_theme || 'classic';
        const nightTheme = schedule.night_theme || 'dark';

        let isDay;
        let nextChangeAt;

        if (dayStart <= dayEnd) {
            // ×˜×•×•×— ×¨×’×™×œ (×œ××©×œ 07:00-20:00)
            isDay = currentMins >= dayStart && currentMins < dayEnd;
            nextChangeAt = isDay ? dayEnd : dayStart;
        } else {
            // ×˜×•×•×— ×¢×•×‘×¨ ×—×¦×•×ª (×œ××©×œ 22:00-06:00 = ×œ×™×œ×”)
            isDay = currentMins >= dayStart || currentMins < dayEnd;
            nextChangeAt = isDay ? dayEnd : dayStart;
        }

        // ×—×™×©×•×‘ ×–××Ÿ ×¢×“ ×”×©×™× ×•×™ ×”×‘× (×‘×“×§×•×ª)
        let nextChangeIn;
        if (nextChangeAt > currentMins) {
            nextChangeIn = nextChangeAt - currentMins;
        } else {
            // ×”×©×™× ×•×™ ×”×‘× ××—×¨
            nextChangeIn = (24 * 60 - currentMins) + nextChangeAt;
        }

        return {
            period: isDay ? 'day' : 'night',
            theme: isDay ? dayTheme : nightTheme,
            nextChangeIn: nextChangeIn, // ×‘×“×§×•×ª
            nextChangeAt: formatMinutesToTime(nextChangeAt),
        };
    }

    /**
     * ×”××¨×ª ×“×§×•×ª ×œ×¤×•×¨××˜ ×©×¢×”
     */
    function formatMinutesToTime(minutes) {
        const hours = Math.floor(minutes / 60) % 24;
        const mins = minutes % 60;
        return `${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}`;
    }

    /**
     * ×”×—×œ×ª ×¢×¨×›×ª × ×•×©×
     * @param {string} theme - ×©× ×”×¢×¨×›×”
     */
    function applyTheme(theme) {
        if (!theme) return;

        const html = document.documentElement;
        const currentTheme = html.getAttribute('data-theme');

        // ×¨×§ ×× ×™×© ×©×™× ×•×™
        if (currentTheme === theme) return;

        console.log(`[ThemeScheduler] Switching to ${theme} theme`);

        // ×¢×“×›×•×Ÿ ×”-HTML attribute
        html.setAttribute('data-theme', theme);

        // ×¢×“×›×•×Ÿ cookie (×œ×˜×¢×™× ×” ×”×‘××”)
        try {
            document.cookie = `ui_theme=${theme}; path=/; max-age=31536000; SameSite=Lax`;
        } catch (e) {
            // ignore
        }

        // ××™×¨×•×¢ ×œ×¢×“×›×•×Ÿ ×§×•××¤×•× × ×˜×™× ××—×¨×™×
        window.dispatchEvent(new CustomEvent('themeChanged', {
            detail: { theme, source: 'scheduler' }
        }));

        // ×¢×“×›×•×Ÿ ×”-DarkMode module ×× ×§×™×™×
        if (window.DarkMode && typeof window.DarkMode.set === 'function') {
            // ×œ× × ×§×¨× ×œ-set ×›×“×™ ×œ×× ×•×¢ ×œ×•×œ××” ××™× ×¡×•×¤×™×ª
            // ×¨×§ × ×¢×“×›×Ÿ ××ª ×”-toggle button
            const toggleBtn = document.getElementById('darkModeToggle');
            const icon = document.getElementById('darkModeIcon');
            if (toggleBtn && icon) {
                const icons = {
                    'classic': 'fa-sun',
                    'dark': 'fa-moon',
                    'dim': 'fa-cloud-moon',
                };
                icon.className = 'fas ' + (icons[theme] || 'fa-palette');
            }
        }
    }

    /**
     * ×‘×“×™×§×” ×•×¢×“×›×•×Ÿ ×”×¢×¨×›×” ×œ×¤×™ ×”×ª×–××•×Ÿ
     */
    async function checkAndApply() {
        // ×˜×¢×™× ×” ×¨××©×•× ×™×ª ×× ×¦×¨×™×š
        if (!currentSchedule) {
            await loadSchedule();
        }

        if (!currentSchedule || !currentSchedule.enabled) {
            return;
        }

        const result = calculateCurrentPeriod(currentSchedule);
        if (result.theme) {
            applyTheme(result.theme);
        }

        // ×œ×•×’ ×œ×“×™×‘×•×’
        if (result.nextChangeAt) {
            console.log(`[ThemeScheduler] Current: ${result.period}, Next change at: ${result.nextChangeAt}`);
        }
    }

    /**
     * ×”×ª×—×œ×ª ××¢×§×‘ ××•×˜×•××˜×™
     */
    function startMonitoring() {
        // ×¢×¦×™×¨×ª ×˜×™×™××¨ ×§×™×™×
        if (checkTimer) {
            clearInterval(checkTimer);
        }

        // ×‘×“×™×§×” ×¨××©×•× ×™×ª
        checkAndApply();

        // ×‘×“×™×§×” ×ª×§×•×¤×ª×™×ª
        checkTimer = setInterval(checkAndApply, CHECK_INTERVAL);
    }

    /**
     * ×¢×¦×™×¨×ª ××¢×§×‘
     */
    function stopMonitoring() {
        if (checkTimer) {
            clearInterval(checkTimer);
            checkTimer = null;
        }
    }

    /**
     * ×¢×“×›×•×Ÿ ×”×’×“×¨×•×ª ×ª×–××•×Ÿ ×œ×©×¨×ª
     * @param {Object} schedule - ×”×’×“×¨×•×ª ×—×“×©×•×ª
     */
    async function saveSchedule(schedule) {
        try {
            const response = await fetch('/api/themes/schedule', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify(schedule),
            });

            const data = await response.json();
            if (data.ok) {
                currentSchedule = data.schedule || schedule;
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(currentSchedule));
                } catch (e) {
                    // ignore
                }

                // ×”×¤×¢×œ×”/×›×™×‘×•×™ ××¢×§×‘ ×œ×¤×™ ×”×¦×•×¨×š
                if (currentSchedule.enabled) {
                    startMonitoring();
                } else {
                    stopMonitoring();
                }

                return { success: true, schedule: currentSchedule };
            } else {
                return { success: false, error: data.error };
            }
        } catch (e) {
            console.error('Error saving theme schedule:', e);
            return { success: false, error: 'network_error' };
        }
    }

    /**
     * ××ª×—×•×œ
     */
    async function init() {
        // ×˜×¢×™× ×ª ×”×’×“×¨×•×ª
        await loadSchedule();

        // ×”×ª×—×œ×ª ××¢×§×‘ ×× ×”×ª×–××•×Ÿ ××•×¤×¢×œ
        if (currentSchedule && currentSchedule.enabled) {
            startMonitoring();
        }
    }

    // ×”×¤×¢×œ×” ×‘×˜×¢×™× ×ª ×”×“×£
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }

    // ×”××–× ×” ×œ×©×™× ×•×™×™ visibility (×›×©×”××©×ª××© ×—×•×–×¨ ×œ×˜××‘)
    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible' && currentSchedule?.enabled) {
            checkAndApply();
        }
    });

    // ×—×©×™×¤×ª API ×’×œ×•×‘×œ×™
    window.ThemeScheduler = {
        load: loadSchedule,
        save: saveSchedule,
        check: checkAndApply,
        getCurrentPeriod: () => calculateCurrentPeriod(currentSchedule),
        getSchedule: () => currentSchedule,
        start: startMonitoring,
        stop: stopMonitoring,
    };

})();
```

### 3.2 ×”×•×¡×¤×” ×œ-`base.html`

×”×•×¡×£ ××ª ×”×§×•×‘×¥ ××—×¨×™ `dark-mode.js`:

```html
<!-- Theme Scheduler - ×ª×–××•×Ÿ ×¢×¨×›×•×ª ×œ×¤×™ ×©×¢×•×ª -->
{% if session.user_id %}
<script src="{{ url_for('static', filename='js/theme-scheduler.js') }}?v={{ static_version }}" defer></script>
{% endif %}
```

---

## ×©×œ×‘ 4: ×¢×“×›×•×Ÿ ×××©×§ ×”××©×ª××©

### 4.1 ×™×¦×™×¨×ª `theme_schedule.html`

×¦×•×¨ ×§×•×‘×¥ ×—×“×©: `webapp/templates/settings/theme_schedule.html`

```html
{% extends "base.html" %}

{% block title %}×ª×–××•×Ÿ ×¢×¨×›×•×ª × ×•×©× - Code Keeper Bot{% endblock %}

{% block content %}
<h1 class="page-title">
    <i class="fas fa-clock"></i>
    ×ª×–××•×Ÿ ×¢×¨×›×•×ª × ×•×©× ××•×˜×•××˜×™
</h1>

<div class="theme-schedule-container">
    <div class="glass-card schedule-card">
        <div class="schedule-header">
            <h2>
                <i class="fas fa-sun"></i>
                <i class="fas fa-moon"></i>
                ×”×—×œ×¤×” ××•×˜×•××˜×™×ª ×™×•×/×œ×™×œ×”
            </h2>
            <p class="text-muted">
                ×”×’×“×¨ ×¢×¨×›×•×ª × ×•×©× ×©×•× ×•×ª ×œ×©×¢×•×ª ×”×™×•× ×•×”×œ×™×œ×”.
                ×”××¢×¨×›×ª ×ª×—×œ×™×£ ×‘×™× ×™×”×Ÿ ××•×˜×•××˜×™×ª.
            </p>
        </div>

        <div class="schedule-form">
            <!-- ×”×¤×¢×œ×”/×›×™×‘×•×™ -->
            <div class="form-group toggle-group">
                <label class="toggle-label" for="scheduleEnabled">
                    <span class="toggle-text">×”×¤×¢×œ ×ª×–××•×Ÿ ××•×˜×•××˜×™</span>
                    <div class="toggle-switch">
                        <input type="checkbox" id="scheduleEnabled" class="toggle-input">
                        <span class="toggle-slider"></span>
                    </div>
                </label>
            </div>

            <!-- ×”×’×“×¨×•×ª (××•×¦×’×•×ª ×¨×§ ×›×©×”×ª×–××•×Ÿ ××•×¤×¢×œ) -->
            <div id="scheduleSettings" class="schedule-settings" style="display: none;">
                
                <!-- ×¢×¨×›×ª ×™×•× -->
                <div class="form-group">
                    <label for="dayTheme">
                        <i class="fas fa-sun" style="color: #f59e0b;"></i>
                        ×¢×¨×›×ª ×™×•×
                    </label>
                    <select id="dayTheme" class="form-control theme-select">
                        <option value="classic">×§×œ××¡×™ (×‘×”×™×¨)</option>
                        <option value="ocean">××•×§×™×™× ×•×¡</option>
                        <option value="forest">×™×¢×¨</option>
                        <option value="rose-pine-dawn">Rose Pine Dawn</option>
                    </select>
                </div>

                <!-- ×¢×¨×›×ª ×œ×™×œ×” -->
                <div class="form-group">
                    <label for="nightTheme">
                        <i class="fas fa-moon" style="color: #6366f1;"></i>
                        ×¢×¨×›×ª ×œ×™×œ×”
                    </label>
                    <select id="nightTheme" class="form-control theme-select">
                        <option value="dark">×›×”×”</option>
                        <option value="dim">××¢×•××¢×</option>
                        <option value="nebula">×¢×¨×¤×™×œ×™×ª</option>
                        <option value="high-contrast">× ×™×’×•×“×™×•×ª ×’×‘×•×”×”</option>
                    </select>
                </div>

                <!-- ×˜×•×•×— ×©×¢×•×ª ×™×•× -->
                <div class="form-group time-range-group">
                    <label>
                        <i class="fas fa-clock"></i>
                        ×©×¢×•×ª ×™×•×
                    </label>
                    <div class="time-range">
                        <div class="time-input-wrapper">
                            <label for="dayStart" class="time-label">×Ö¾</label>
                            <input type="time" id="dayStart" class="form-control time-input" value="07:00">
                        </div>
                        <span class="time-separator">×¢×“</span>
                        <div class="time-input-wrapper">
                            <label for="dayEnd" class="time-label">×¢×“</label>
                            <input type="time" id="dayEnd" class="form-control time-input" value="20:00">
                        </div>
                    </div>
                    <small class="text-muted">
                        ×›×œ ×”×©×¢×•×ª ××—×•×¥ ×œ×˜×•×•×— ×–×” ×™×™×—×©×‘×• ×›×œ×™×œ×”
                    </small>
                </div>

                <!-- ×ª×¦×•×’×” ××§×“×™××” -->
                <div class="schedule-preview">
                    <div class="preview-item day-preview">
                        <div class="preview-icon">
                            <i class="fas fa-sun"></i>
                        </div>
                        <div class="preview-info">
                            <strong>×™×•×</strong>
                            <span id="dayPreviewTime">07:00 - 20:00</span>
                        </div>
                        <div class="preview-theme" id="dayPreviewTheme">
                            ×§×œ××¡×™
                        </div>
                    </div>
                    <div class="preview-item night-preview">
                        <div class="preview-icon">
                            <i class="fas fa-moon"></i>
                        </div>
                        <div class="preview-info">
                            <strong>×œ×™×œ×”</strong>
                            <span id="nightPreviewTime">20:00 - 07:00</span>
                        </div>
                        <div class="preview-theme" id="nightPreviewTheme">
                            ×›×”×”
                        </div>
                    </div>
                </div>

                <!-- ×¡×˜×˜×•×¡ × ×•×›×—×™ -->
                <div class="current-status" id="currentStatus" style="display: none;">
                    <i class="fas fa-info-circle"></i>
                    <span id="statusText">×›×¨×’×¢: ×¢×¨×›×ª ×™×•× (×§×œ××¡×™)</span>
                    <span id="nextChangeText" class="next-change">×©×™× ×•×™ ×”×‘×: 20:00</span>
                </div>
            </div>

            <!-- ×›×¤×ª×•×¨×™× -->
            <div class="form-actions">
                <button type="button" id="saveScheduleBtn" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    ×©××•×¨ ×”×’×“×¨×•×ª
                </button>
                <button type="button" id="testScheduleBtn" class="btn btn-secondary" style="display: none;">
                    <i class="fas fa-play"></i>
                    ×‘×“×•×§ ×¢×›×©×™×•
                </button>
            </div>
        </div>
    </div>

    <!-- ××™×“×¢ × ×•×¡×£ -->
    <div class="glass-card info-card">
        <h3>
            <i class="fas fa-lightbulb"></i>
            ××™×š ×–×” ×¢×•×‘×“?
        </h3>
        <ul class="info-list">
            <li>
                <i class="fas fa-check"></i>
                ×‘×—×¨ ×¢×¨×›×ª × ×•×©× ×‘×”×™×¨×” ×œ×©×¢×•×ª ×”×™×•×
            </li>
            <li>
                <i class="fas fa-check"></i>
                ×‘×—×¨ ×¢×¨×›×ª × ×•×©× ×›×”×” ×œ×©×¢×•×ª ×”×œ×™×œ×”
            </li>
            <li>
                <i class="fas fa-check"></i>
                ×”×’×“×¨ ××ª ×˜×•×•×— ×”×©×¢×•×ª ×œ×¤×™ ×”×”×¢×“×¤×” ×©×œ×š
            </li>
            <li>
                <i class="fas fa-check"></i>
                ×”××¢×¨×›×ª ×ª×—×œ×™×£ ××•×˜×•××˜×™×ª ×‘×™×Ÿ ×”×¢×¨×›×•×ª
            </li>
        </ul>
        <p class="text-muted small">
            <i class="fas fa-info-circle"></i>
            ×”×©×¢×•×ª ××‘×•×¡×¡×•×ª ×¢×œ ×”×©×¢×•×Ÿ ×”××§×•××™ ×©×œ ×”×“×¤×“×¤×Ÿ ×©×œ×š.
        </p>
    </div>
</div>

<style>
.theme-schedule-container {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: 1.5rem;
    max-width: 1000px;
    margin: 0 auto;
}

@media (max-width: 800px) {
    .theme-schedule-container {
        grid-template-columns: 1fr;
    }
}

.schedule-card {
    padding: 1.5rem;
}

.schedule-header h2 {
    margin: 0 0 0.5rem 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.schedule-header h2 i {
    font-size: 1.1em;
}

.schedule-header h2 i.fa-sun {
    color: #f59e0b;
}

.schedule-header h2 i.fa-moon {
    color: #6366f1;
}

/* Toggle Switch */
.toggle-group {
    margin: 1.5rem 0;
}

.toggle-label {
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    padding: 1rem;
    background: var(--glass);
    border: 1px solid var(--glass-border);
    border-radius: 12px;
    transition: all 0.2s;
}

.toggle-label:hover {
    background: var(--glass-hover);
}

.toggle-text {
    font-weight: 600;
    color: var(--text-primary);
}

.toggle-switch {
    position: relative;
    width: 52px;
    height: 28px;
}

.toggle-input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--bg-tertiary);
    transition: 0.3s;
    border-radius: 28px;
    border: 1px solid var(--glass-border);
}

.toggle-slider:before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 3px;
    bottom: 3px;
    background: white;
    transition: 0.3s;
    border-radius: 50%;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.toggle-input:checked + .toggle-slider {
    background: var(--primary);
    border-color: var(--primary);
}

.toggle-input:checked + .toggle-slider:before {
    transform: translateX(24px);
}

/* Schedule Settings */
.schedule-settings {
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.form-group {
    margin-bottom: 1.25rem;
}

.form-group label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: var(--text-primary);
}

.theme-select {
    width: 100%;
    padding: 0.75rem 1rem;
    border-radius: 10px;
    border: 1px solid var(--glass-border);
    background: var(--glass);
    color: var(--text-primary);
    font-size: 1rem;
    cursor: pointer;
}

.theme-select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
}

/* Time Range */
.time-range {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.time-input-wrapper {
    flex: 1;
}

.time-label {
    display: none;
}

.time-input {
    width: 100%;
    padding: 0.75rem;
    border-radius: 10px;
    border: 1px solid var(--glass-border);
    background: var(--glass);
    color: var(--text-primary);
    font-size: 1rem;
}

.time-input:focus {
    outline: none;
    border-color: var(--primary);
}

.time-separator {
    color: var(--text-muted);
    font-weight: 500;
}

/* Preview */
.schedule-preview {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin: 1.5rem 0;
    padding: 1rem;
    background: var(--bg-secondary);
    border-radius: 12px;
}

.preview-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem;
    border-radius: 10px;
    background: var(--glass);
}

.day-preview {
    border-left: 3px solid #f59e0b;
}

.night-preview {
    border-left: 3px solid #6366f1;
}

.preview-icon {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background: var(--bg-tertiary);
}

.day-preview .preview-icon {
    color: #f59e0b;
}

.night-preview .preview-icon {
    color: #6366f1;
}

.preview-info {
    flex: 1;
}

.preview-info strong {
    display: block;
    color: var(--text-primary);
}

.preview-info span {
    font-size: 0.85rem;
    color: var(--text-muted);
}

.preview-theme {
    padding: 0.35rem 0.75rem;
    border-radius: 20px;
    background: var(--primary);
    color: white;
    font-size: 0.85rem;
    font-weight: 500;
}

/* Current Status */
.current-status {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem;
    background: rgba(99, 102, 241, 0.1);
    border: 1px solid rgba(99, 102, 241, 0.3);
    border-radius: 10px;
    color: var(--text-primary);
    margin-top: 1rem;
}

.current-status i {
    color: var(--primary);
}

.next-change {
    margin-right: auto;
    font-size: 0.85rem;
    color: var(--text-muted);
}

/* Actions */
.form-actions {
    display: flex;
    gap: 1rem;
    margin-top: 1.5rem;
}

.form-actions .btn {
    flex: 1;
}

/* Info Card */
.info-card {
    padding: 1.5rem;
    height: fit-content;
}

.info-card h3 {
    margin: 0 0 1rem 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.info-card h3 i {
    color: #f59e0b;
}

.info-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.info-list li {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
    color: var(--text-secondary);
}

.info-list li i {
    color: var(--success);
    margin-top: 0.2em;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', async function() {
    const enabledToggle = document.getElementById('scheduleEnabled');
    const settingsDiv = document.getElementById('scheduleSettings');
    const dayThemeSelect = document.getElementById('dayTheme');
    const nightThemeSelect = document.getElementById('nightTheme');
    const dayStartInput = document.getElementById('dayStart');
    const dayEndInput = document.getElementById('dayEnd');
    const saveBtn = document.getElementById('saveScheduleBtn');
    const testBtn = document.getElementById('testScheduleBtn');
    const currentStatus = document.getElementById('currentStatus');
    const statusText = document.getElementById('statusText');
    const nextChangeText = document.getElementById('nextChangeText');

    // Theme names mapping
    const themeNames = {
        'classic': '×§×œ××¡×™',
        'dark': '×›×”×”',
        'dim': '××¢×•××¢×',
        'nebula': '×¢×¨×¤×™×œ×™×ª',
        'ocean': '××•×§×™×™× ×•×¡',
        'forest': '×™×¢×¨',
        'rose-pine-dawn': 'Rose Pine Dawn',
        'high-contrast': '× ×™×’×•×“×™×•×ª ×’×‘×•×”×”',
    };

    // ×˜×¢×™× ×ª ×”×’×“×¨×•×ª ×§×™×™××•×ª
    async function loadSettings() {
        if (typeof ThemeScheduler !== 'undefined') {
            const schedule = await ThemeScheduler.load();
            if (schedule) {
                enabledToggle.checked = schedule.enabled;
                dayThemeSelect.value = schedule.day_theme || 'classic';
                nightThemeSelect.value = schedule.night_theme || 'dark';
                dayStartInput.value = schedule.day_start || '07:00';
                dayEndInput.value = schedule.day_end || '20:00';
                updateUI();
            }
        }
    }

    // ×¢×“×›×•×Ÿ ×××©×§
    function updateUI() {
        const enabled = enabledToggle.checked;
        settingsDiv.style.display = enabled ? 'block' : 'none';
        testBtn.style.display = enabled ? 'inline-flex' : 'none';
        
        if (enabled) {
            updatePreview();
            updateCurrentStatus();
        }
    }

    // ×¢×“×›×•×Ÿ ×ª×¦×•×’×” ××§×“×™××”
    function updatePreview() {
        const dayStart = dayStartInput.value || '07:00';
        const dayEnd = dayEndInput.value || '20:00';
        const dayTheme = dayThemeSelect.value;
        const nightTheme = nightThemeSelect.value;

        document.getElementById('dayPreviewTime').textContent = `${dayStart} - ${dayEnd}`;
        document.getElementById('nightPreviewTime').textContent = `${dayEnd} - ${dayStart}`;
        document.getElementById('dayPreviewTheme').textContent = themeNames[dayTheme] || dayTheme;
        document.getElementById('nightPreviewTheme').textContent = themeNames[nightTheme] || nightTheme;
    }

    // ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ × ×•×›×—×™
    function updateCurrentStatus() {
        if (typeof ThemeScheduler !== 'undefined') {
            const result = ThemeScheduler.getCurrentPeriod();
            if (result && result.period) {
                currentStatus.style.display = 'flex';
                const periodName = result.period === 'day' ? '×™×•×' : '×œ×™×œ×”';
                const themeName = themeNames[result.theme] || result.theme;
                statusText.textContent = `×›×¨×’×¢: ×¢×¨×›×ª ${periodName} (${themeName})`;
                nextChangeText.textContent = `×©×™× ×•×™ ×”×‘×: ${result.nextChangeAt}`;
            } else {
                currentStatus.style.display = 'none';
            }
        }
    }

    // ×©××™×¨×”
    async function saveSettings() {
        const schedule = {
            enabled: enabledToggle.checked,
            day_theme: dayThemeSelect.value,
            night_theme: nightThemeSelect.value,
            day_start: dayStartInput.value,
            day_end: dayEndInput.value,
        };

        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ×©×•××¨...';

        try {
            if (typeof ThemeScheduler !== 'undefined') {
                const result = await ThemeScheduler.save(schedule);
                if (result.success) {
                    showToast('×”×”×’×“×¨×•×ª × ×©××¨×• ×‘×”×¦×œ×—×”!', 'success');
                    updateCurrentStatus();
                } else {
                    showToast('×©×’×™××” ×‘×©××™×¨×”: ' + (result.error || '×× × × ×¡×” ×©×•×‘'), 'error');
                }
            }
        } catch (e) {
            showToast('×©×’×™××” ×‘×©××™×¨×”', 'error');
        }

        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="fas fa-save"></i> ×©××•×¨ ×”×’×“×¨×•×ª';
    }

    // ×‘×“×™×§×” ×¢×›×©×™×•
    function testNow() {
        if (typeof ThemeScheduler !== 'undefined') {
            ThemeScheduler.check();
            updateCurrentStatus();
            showToast('×”×¢×¨×›×” ×¢×•×“×›× ×” ×œ×¤×™ ×”×ª×–××•×Ÿ ×”× ×•×›×—×™', 'success');
        }
    }

    // Toast
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : 'exclamation-circle'}"></i> ${message}`;
        toast.style.cssText = `
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 0.75rem 1.5rem;
            background: ${type === 'success' ? 'var(--success)' : 'var(--error)'};
            color: white;
            border-radius: 10px;
            z-index: 9999;
            animation: fadeInUp 0.3s ease-out;
        `;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    // Event Listeners
    enabledToggle.addEventListener('change', updateUI);
    dayThemeSelect.addEventListener('change', updatePreview);
    nightThemeSelect.addEventListener('change', updatePreview);
    dayStartInput.addEventListener('change', updatePreview);
    dayEndInput.addEventListener('change', updatePreview);
    saveBtn.addEventListener('click', saveSettings);
    testBtn.addEventListener('click', testNow);

    // ×˜×¢×™× ×” ×¨××©×•× ×™×ª
    await loadSettings();
});
</script>

<style>
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateX(-50%) translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
}
</style>
{% endblock %}
```

### 4.2 ×”×•×¡×¤×ª Route ×‘-`app.py`

```python
@app.route('/settings/theme-schedule')
def theme_schedule_page():
    """×“×£ ×”×’×“×¨×•×ª ×ª×–××•×Ÿ ×¢×¨×›×•×ª × ×•×©×."""
    if 'user_id' not in session:
        return redirect(url_for('login'))
    return render_template('settings/theme_schedule.html')
```

### 4.3 ×”×•×¡×¤×ª ×§×™×©×•×¨ ×‘×ª×¤×¨×™×˜ ×”×”×’×“×¨×•×ª

×¢×“×›×Ÿ ××ª `settings.html` ××• ××ª ×”×ª×¤×¨×™×˜ ×”×¨××©×™:

```html
<a href="/settings/theme-schedule" class="settings-link">
    <i class="fas fa-clock"></i>
    ×ª×–××•×Ÿ ×¢×¨×›×•×ª × ×•×©×
    <span class="badge badge-new">×—×“×©</span>
</a>
```

---

## ×©×œ×‘ 5: ××™× ×˜×’×¨×¦×™×” ×¢× ×”××¢×¨×›×ª ×”×§×™×™××ª

### 5.1 ×¢×“×›×•×Ÿ `dark-mode.js`

×”×•×¡×£ ×ª××™×›×” ×‘×ª×–××•×Ÿ ×œ××•×“×•×œ ×”×§×™×™×:

```javascript
// ×”×•×¡×£ ×‘×ª×•×š ×”×¤×•× ×§×¦×™×” updateTheme() ×‘-dark-mode.js

function updateTheme() {
    // ×‘×“×™×§×” ×× ×™×© ×ª×–××•×Ÿ ×¤×¢×™×œ
    if (typeof ThemeScheduler !== 'undefined') {
        const schedule = ThemeScheduler.getSchedule();
        if (schedule && schedule.enabled) {
            // ×”×ª×–××•×Ÿ ×¤×¢×™×œ - ×œ× × ×“×¨×•×¡ ××ª ×”×‘×—×™×¨×” ×©×œ×•
            return;
        }
    }
    
    // ... ×©××¨ ×”×§×•×“ ×”×§×™×™× ...
}
```

### 5.2 ×¢×“×›×•×Ÿ `_inject_globals` ×‘-`app.py`

×”×•×¡×£ ××ª ×”×’×“×¨×•×ª ×”×ª×–××•×Ÿ ×œ-template context:

```python
def _inject_globals():
    # ... ×§×•×“ ×§×™×™× ...
    
    # Theme Schedule
    theme_schedule = None
    try:
        if user_id and user_doc:
            ts = (user_doc.get('ui_prefs') or {}).get('theme_schedule')
            if isinstance(ts, dict) and ts.get('enabled'):
                theme_schedule = ts
    except Exception:
        theme_schedule = None
    
    return {
        # ... ×©××¨ ×”××©×ª× ×™× ...
        'theme_schedule': theme_schedule,
    }
```

### 5.3 ×”×•×¡×¤×ª Script ×‘-`base.html` ×œ×× ×™×¢×ª FOUC

×”×•×¡×£ ×‘-`<head>` ×œ×¤× ×™ ×˜×¢×™× ×ª CSS:

```html
<script>
    // Theme Schedule - ×× ×™×¢×ª FOUC
    (function() {
        try {
            var schedule = localStorage.getItem('theme_schedule_cache');
            if (schedule) {
                schedule = JSON.parse(schedule);
                if (schedule && schedule.enabled) {
                    var now = new Date();
                    var currentMins = now.getHours() * 60 + now.getMinutes();
                    
                    function timeTomins(t) {
                        var p = t.split(':');
                        return parseInt(p[0],10)*60 + parseInt(p[1],10);
                    }
                    
                    var dayStart = timeTomins(schedule.day_start || '07:00');
                    var dayEnd = timeTomins(schedule.day_end || '20:00');
                    var isDay = (dayStart <= dayEnd) 
                        ? (currentMins >= dayStart && currentMins < dayEnd)
                        : (currentMins >= dayStart || currentMins < dayEnd);
                    
                    var theme = isDay ? schedule.day_theme : schedule.night_theme;
                    if (theme) {
                        document.documentElement.setAttribute('data-theme', theme);
                    }
                }
            }
        } catch(e) {}
    })();
</script>
```

---

## ×©×œ×‘ 6: ×‘×“×™×§×•×ª

### 6.1 Unit Tests

×¦×•×¨ ×§×•×‘×¥: `tests/test_theme_schedule.py`

```python
"""×‘×“×™×§×•×ª ×œ××¢×¨×›×ª ×ª×–××•×Ÿ ×¢×¨×›×•×ª × ×•×©×."""

import pytest
from datetime import datetime
from unittest.mock import patch, MagicMock


class TestThemeScheduleValidation:
    """×‘×“×™×§×•×ª ×•×•×œ×™×“×¦×™×”."""

    def test_valid_time_format(self):
        from webapp.themes_api import _validate_time_format
        
        assert _validate_time_format("07:00") is True
        assert _validate_time_format("23:59") is True
        assert _validate_time_format("00:00") is True
        assert _validate_time_format("12:30") is True

    def test_invalid_time_format(self):
        from webapp.themes_api import _validate_time_format
        
        assert _validate_time_format("25:00") is False
        assert _validate_time_format("12:60") is False
        assert _validate_time_format("abc") is False
        assert _validate_time_format("") is False
        assert _validate_time_format(None) is False

    def test_valid_schedule(self):
        from webapp.themes_api import _validate_theme_schedule
        
        schedule = {
            "enabled": True,
            "day_theme": "classic",
            "night_theme": "dark",
            "day_start": "07:00",
            "day_end": "20:00",
        }
        
        is_valid, error = _validate_theme_schedule(schedule)
        assert is_valid is True
        assert error == ""

    def test_invalid_theme(self):
        from webapp.themes_api import _validate_theme_schedule
        
        schedule = {
            "day_theme": "invalid_theme",
        }
        
        is_valid, error = _validate_theme_schedule(schedule)
        assert is_valid is False
        assert "invalid_day_theme" in error


class TestThemeCalculation:
    """×‘×“×™×§×•×ª ×—×™×©×•×‘ ×¢×¨×›×” × ×•×›×—×™×ª."""

    def test_daytime_normal_range(self):
        """×‘×“×™×§×” ×‘×˜×•×•×— ×¨×’×™×œ (×™×•× ×‘×©×¢×•×ª ×‘×•×§×¨)."""
        from webapp.themes_api import _calculate_current_scheduled_theme
        
        schedule = {
            "enabled": True,
            "day_theme": "classic",
            "night_theme": "dark",
            "day_start": "07:00",
            "day_end": "20:00",
        }
        
        # Mock datetime ×œ×©×¢×” 12:00
        with patch('webapp.themes_api.datetime') as mock_dt:
            mock_now = MagicMock()
            mock_now.strftime.return_value = "12:00"
            mock_dt.now.return_value = mock_now
            
            result = _calculate_current_scheduled_theme(schedule)
            assert result == "classic"

    def test_nighttime_normal_range(self):
        """×‘×“×™×§×” ×‘×˜×•×•×— ×¨×’×™×œ (×œ×™×œ×”)."""
        from webapp.themes_api import _calculate_current_scheduled_theme
        
        schedule = {
            "enabled": True,
            "day_theme": "classic",
            "night_theme": "dark",
            "day_start": "07:00",
            "day_end": "20:00",
        }
        
        with patch('webapp.themes_api.datetime') as mock_dt:
            mock_now = MagicMock()
            mock_now.strftime.return_value = "22:00"
            mock_dt.now.return_value = mock_now
            
            result = _calculate_current_scheduled_theme(schedule)
            assert result == "dark"

    def test_disabled_schedule(self):
        """×‘×“×™×§×” ×›×©×”×ª×–××•×Ÿ ××›×•×‘×”."""
        from webapp.themes_api import _calculate_current_scheduled_theme
        
        schedule = {
            "enabled": False,
            "day_theme": "classic",
            "night_theme": "dark",
        }
        
        result = _calculate_current_scheduled_theme(schedule)
        assert result is None


class TestAPIEndpoints:
    """×‘×“×™×§×•×ª API."""

    @pytest.fixture
    def client(self, app):
        return app.test_client()

    def test_get_schedule_unauthorized(self, client):
        """×‘×“×™×§×” ×©× ×“×¨×© ×œ×•×’×™×Ÿ."""
        response = client.get('/api/themes/schedule')
        assert response.status_code == 401

    def test_get_schedule_authorized(self, client, logged_in_user):
        """×‘×“×™×§×ª ×§×‘×œ×ª ×”×’×“×¨×•×ª."""
        response = client.get('/api/themes/schedule')
        assert response.status_code == 200
        data = response.get_json()
        assert data['ok'] is True
        assert 'schedule' in data

    def test_update_schedule(self, client, logged_in_user):
        """×‘×“×™×§×ª ×¢×“×›×•×Ÿ ×”×’×“×¨×•×ª."""
        response = client.post('/api/themes/schedule', json={
            "enabled": True,
            "day_theme": "classic",
            "night_theme": "dark",
            "day_start": "08:00",
            "day_end": "19:00",
        })
        assert response.status_code == 200
        data = response.get_json()
        assert data['ok'] is True
```

### 6.2 Integration Tests

```python
"""×‘×“×™×§×•×ª ××™× ×˜×’×¨×¦×™×” ×œ×ª×–××•×Ÿ ×¢×¨×›×•×ª."""

import pytest
from playwright.sync_api import Page


class TestThemeScheduleUI:
    """×‘×“×™×§×•×ª ×××©×§ ××©×ª××©."""

    def test_schedule_page_loads(self, page: Page, logged_in_session):
        """×‘×“×™×§×” ×©×“×£ ×”×”×’×“×¨×•×ª × ×˜×¢×Ÿ."""
        page.goto('/settings/theme-schedule')
        assert page.locator('h1').text_content() == '×ª×–××•×Ÿ ×¢×¨×›×•×ª × ×•×©× ××•×˜×•××˜×™'

    def test_toggle_enables_settings(self, page: Page, logged_in_session):
        """×‘×“×™×§×” ×©×”×”×¤×¢×œ×” ××¦×™×’×” ××ª ×”×”×’×“×¨×•×ª."""
        page.goto('/settings/theme-schedule')
        
        settings = page.locator('#scheduleSettings')
        assert settings.is_hidden()
        
        page.locator('#scheduleEnabled').click()
        assert settings.is_visible()

    def test_save_schedule(self, page: Page, logged_in_session):
        """×‘×“×™×§×ª ×©××™×¨×ª ×”×’×“×¨×•×ª."""
        page.goto('/settings/theme-schedule')
        
        page.locator('#scheduleEnabled').click()
        page.locator('#dayTheme').select_option('ocean')
        page.locator('#nightTheme').select_option('dim')
        page.locator('#saveScheduleBtn').click()
        
        # ×‘×“×™×§×” ×©×”×•×“×¢×ª ×”×¦×œ×—×” ××•×¦×’×ª
        toast = page.locator('.toast-success')
        assert toast.is_visible()
```

---

## ×©×™×§×•×œ×™ UX ×•× ×’×™×©×•×ª

### 7.1 × ×’×™×©×•×ª (A11y)

```html
<!-- ×”×•×¡×£ ×ª×›×•× ×•×ª × ×’×™×©×•×ª -->
<input 
    type="checkbox" 
    id="scheduleEnabled" 
    class="toggle-input"
    role="switch"
    aria-checked="false"
    aria-label="×”×¤×¢×œ ×ª×–××•×Ÿ ××•×˜×•××˜×™ ×©×œ ×¢×¨×›×•×ª × ×•×©×">

<select 
    id="dayTheme" 
    class="form-control theme-select"
    aria-label="×‘×—×¨ ×¢×¨×›×ª × ×•×©× ×œ×©×¢×•×ª ×”×™×•×">
```

### 7.2 ×”×•×“×¢×•×ª ×œ××©×ª××©

```javascript
// ×”×•×“×¢×” ×›×©×”×ª×–××•×Ÿ ××©×ª× ×”
window.addEventListener('themeChanged', (e) => {
    if (e.detail.source === 'scheduler') {
        const theme = e.detail.theme;
        const isDay = ['classic', 'ocean', 'forest', 'rose-pine-dawn'].includes(theme);
        
        // ×”×¦×’ ×”×•×“×¢×” ×¢×“×™× ×” (optional)
        console.log(`×¢×¨×›×ª × ×•×©× ×¢×•×“×›× ×” ×œ${isDay ? '×™×•×' : '×œ×™×œ×”'}: ${theme}`);
    }
});
```

### 7.3 ×”×ª×××” ×œ××•×‘×™×™×œ

```css
@media (max-width: 600px) {
    .time-range {
        flex-direction: column;
    }
    
    .time-separator {
        padding: 0.5rem 0;
    }
    
    .schedule-preview {
        padding: 0.75rem;
    }
    
    .preview-item {
        flex-wrap: wrap;
    }
    
    .preview-theme {
        width: 100%;
        text-align: center;
        margin-top: 0.5rem;
    }
}
```

---

## ×¡×™×›×•×

### ×§×‘×¦×™× ×©×¦×¨×™×š ×œ×™×¦×•×¨/×œ×¢×¨×•×š:

| ×§×•×‘×¥ | ×¤×¢×•×œ×” | ×ª×™××•×¨ |
|------|-------|-------|
| `webapp/themes_api.py` | ×¢×¨×™×›×” | ×”×•×¡×¤×ª API endpoints |
| `webapp/static/js/theme-scheduler.js` | ×™×¦×™×¨×” | ×œ×•×’×™×§×” ×¦×“ ×œ×§×•×— |
| `webapp/templates/settings/theme_schedule.html` | ×™×¦×™×¨×” | ×××©×§ ×”×’×“×¨×•×ª |
| `webapp/templates/base.html` | ×¢×¨×™×›×” | Script ×œ×× ×™×¢×ª FOUC + ×˜×¢×™× ×ª JS |
| `webapp/app.py` | ×¢×¨×™×›×” | Route + inject globals |
| `webapp/static/js/dark-mode.js` | ×¢×¨×™×›×” | ××™× ×˜×’×¨×¦×™×” ×¢× ×”×ª×–××•×Ÿ |
| `tests/test_theme_schedule.py` | ×™×¦×™×¨×” | ×‘×“×™×§×•×ª |

### ×ª×¨×©×™× ×–×¨×™××” ××¡×›×:

```
User enables schedule â†’ Settings saved to DB
                              â†“
Page loads â†’ JS checks schedule â†’ Calculates current period
                              â†“
                   Applies correct theme
                              â†“
Timer runs every minute â†’ Checks if period changed
                              â†“
              If changed â†’ Applies new theme
```

### ×ª×›×•× ×•×ª ×¢×ª×™×“×™×•×ª ××¤×©×¨×™×•×ª:

1. **×ª×–××•×Ÿ ××‘×•×¡×¡ ××™×§×•×**: ×©×™××•×© ×‘-Geolocation API ×œ×—×™×©×•×‘ ×–×¨×™×—×”/×©×§×™×¢×”
2. **×¢×¨×›×•×ª ×œ×¤×™ ×™×•× ×‘×©×‘×•×¢**: ×¢×¨×›×•×ª ×©×•× ×•×ª ×œ×¡×•×¤"×©
3. **×ª×–××•×Ÿ ××ª×§×“×**: ×™×•×ª×¨ ××©× ×™ ×¤×¨×§×™ ×–××Ÿ (×‘×•×§×¨/×¦×”×¨×™×™×/×¢×¨×‘/×œ×™×œ×”)
4. **×¡× ×›×¨×•×Ÿ ×¢× ××¢×¨×›×ª ×”×”×¤×¢×œ×”**: ×©×™××•×© ×‘-`prefers-color-scheme-schedule` (×¢×ª×™×“×™)

---

**× ×•×¦×¨ ×¢×œ ×™×“×™**: Background Agent  
**×ª××¨×™×š**: ×™× ×•××¨ 2026  
**×’×¨×¡×”**: 1.0
