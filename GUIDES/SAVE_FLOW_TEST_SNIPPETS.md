# בדיקות ידניות לזרימת שמירה בבוט (save_flow)

מסמך זה מרכז קטעי קוד ותסריטי בדיקה מומלצים ל־/save, גם במסלול הישן וגם במסלול החדש (ארכיטקטורה שכבתית) המופעל בדגל.

## הפעלת המסלול החדש (פיילוט)

1. הגדר משתנה סביבה לפני הרצת הבוט:
   - `USE_NEW_SAVE_FLOW=1`
2. הרץ כרגיל. אם הדגל לא מוגדר, הבוט יעבוד במסלול הישן ללא שינוי.

המסלול החדש מחליף את בדיקת קובץ קיים ואת שמירת הקובץ דרך שכבות Application/Domain/Infrastructure, עם תאימות מלאה למסכי ההצלחה הקיימים.

---

## תסריט בסיסי – Python

- פקודה: `/save`
- קוד:
```python
def add(a, b):
    return a + b

if __name__ == "__main__":
    print(add(2, 3))
```
- שם קובץ: `script.py`
- הערה: אופציונלי
- צפוי:
  - שפה מזוהה: `python`
  - נרמול שורות ל־LF, הסרת רווחי סוף שורה
  - שמירה מוצלחת + הופעת כפתורי פעולה

## תסריט בסיסי – JavaScript

- קוד:
```javascript
function hello(name) {
  console.log(`hello, ${name}`)
}
hello('world')
```
- שם קובץ: `app.js`
- צפוי: `javascript`

## TypeScript קצר

```typescript
const sum = (a: number, b: number) => a + b;
export default sum;
```
- שם קובץ: `sum.ts`
- צפוי: `typescript`

## HTML קצר

```html
<!doctype html>
<html>
  <head><meta charset="utf-8" /></head>
  <body><h1>שלום</h1></body>
</html>
```
- שם קובץ: `index.html`
- צפוי: `html`

---

## נרמול – תווים נסתרים וכיווניות

1) לוגיקת נרמול של תווי כיווניות/רוחב־אפס:

- קוד (הדבק באמת את התו הנסתר U+200E בין hello ל-world):
```python
print("hello‎world")
```
- שם קובץ: `bidi.py`
- צפוי: תווי כיווניות יוסרו; יוצג `helloworld` בקוד הנשמר.

2) לוגיקת נרמול של רצפים מילוליים (escaped) של יוניקוד:

- קוד (כולל רצף מילולי):
```python
text = "hidden=\u200B"
print(text)
```
- שם קובץ: `escaped_hidden.py`
- צפוי: הרצף `\u200B` המייצג תו מוסתר (Cf) יוסר בטקסט הנשמר.

3) רווח קשיח (NBSP):

- קוד (הדבק NBSP U+00A0 בין שני המילים):
```python
print("foo bar")
```
- שם קובץ: `nbsp.py`
- צפוי: NBSP יוחלף ברווח רגיל.

4) סוף שורה ו־CRLF:

- קוד עם CRLF (Windows) ורווחים בסוף שורה – אפשר להדביק:
```python
print("a")  \r\n
print("b")  
```
- שם קובץ: `eol.py`
- צפוי: המרה ל־LF והסרת רווחי סוף שורה.

> הערה: ייתכנו שינויים קלים בתצוגת אימוג'ים כאשר יש ואריאציות יוניקוד (Variation Selectors), זה תקין לשלב זה.

---

## בדיקת אזהרת סודות (Long Collect)

במצב איסוף ארוך (תפריט “✍️ איסוף קוד ארוך”):

1. שלח קטע עם טוקן GitHub:
```text
ghp_abcdefghijklmnopqrstuvwxyz1234567890abcd
```
2. אמורה להופיע אזהרה על זיהוי דפוס סודי. איחד/י עם `/done` והמשך לשם קובץ.

---

## בדיקת שם קובץ, כפילויות וגרסאות

1. שמור קובץ בשם `dup.py` עם:
```python
print("v1")
```
2. נסה לשמור שוב `dup.py` עם:
```python
print("v2")
```
3. צפוי: במסך בחירת שם יופיע מסר “קובץ קיים” ואופציות (החלף/שנה שם/בטל). אם מחליפים, גרסה צריכה לעלות (בדוק בתפריט “📚 היסטוריה”).

---

## הערות ארוכות וחיתוך

- בתיבת ההערה, הדבק טקסט ארוך מאוד (> 280 תווים). הצפוי: ההערה תיחתך באופן אלגנטי והממשק מציין זאת.

---

## בדיקות רגרסיה במסלול הישן

כבה את הדגל `USE_NEW_SAVE_FLOW` והריץ את אותם תסריטים:
- ודא שההתנהגות זהה פונקציונלית (זיהוי שפה, נרמול, כפתורי פעולה, היסטוריית גרסאות).
- שים לב להבדלים קלים אפשריים בנרמול תווים נסתרים – זה צפוי ומנוטר.

---

## צ'קליסט קבלה מהירה

- [ ] שמירה מוצלחת ל־Python/JS/TS/HTML
- [ ] נרמול: כיווניות, NBSP, רווחי סוף שורה, CRLF → LF
- [ ] אזהרת סודות ב־Long Collect
- [ ] כפילויות: מסר ואופציות תקינים
- [ ] גרסאות: עלייה ב־version ונראות בהיסטוריה
- [ ] זמנים/ביצועים: אין האטה חריגה לעומת הבייסליין

---

## תקלות שכדאי לשים אליהן לב

- חריגות `save_file_failed`, `db_*_error` בלוגים
- זיהוי שפה לא צפוי (בעיקר קבצים לא סטנדרטיים)
- תלונות על “נעלמו תווים” (RTL/ריווח) – פתחו אישו עם קטע מינימלי משחזר

