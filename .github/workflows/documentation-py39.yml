name: 📖 Build Documentation (Python 3.11 Compatible)

on:
  workflow_dispatch:
  push:
    branches: [develop]
    paths:
      - '**.py'
      - 'docs/**'
      - 'requirements/*.txt'

env:
  PYTHON_VERSION: '3.11'
  SPHINX_BUILD_DIR: docs/_build/html

jobs:
  build-docs-py39:
    name: 🔨 Build Documentation (Python 3.11)
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: 🐍 Setup Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: 📦 Install documentation dependencies
      run: |
        python -m pip install --upgrade pip
        # Install docs deps (conf.py mocks heavy imports)
        pip install -r docs/requirements.txt 2>/dev/null || true
        
        # Try to install project dependencies (production-only)
        pip install -r requirements/production.txt 2>/dev/null || true
        # Install docs extra requirements (includes mermaid and addons)
        pip install -r docs/requirements.txt 2>/dev/null || true
    
    - name: 🔨 Build HTML documentation
      run: |
        cd docs
        # Build docs
        sphinx-build -b html . _build/html --keep-going -j auto
      env:
        SPHINX_MOCK_IMPORTS: true
        BOT_TOKEN: dummy_token_for_docs
        MONGODB_URL: mongodb://localhost:27017/test
    
    - name: 💾 Upload documentation artifacts
      uses: actions/upload-artifact@v4
      with:
        name: documentation-html-py39
        path: ${{ env.SPHINX_BUILD_DIR }}
        retention-days: 7
    
    - name: 📝 Generate summary
      run: |
        echo "### 📖 Documentation Build (Python 3.11)" >> $GITHUB_STEP_SUMMARY
        echo "- **Python Version**: ${{ env.PYTHON_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Sphinx Version**: $(sphinx-build --version 2>&1 | head -1)" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ✅ Success" >> $GITHUB_STEP_SUMMARY