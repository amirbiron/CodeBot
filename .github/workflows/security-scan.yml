name: "ðŸ”’ Security Scan"

on:
  schedule:
    - cron: '0 2 1 * *'
  workflow_dispatch:

jobs:
  security-scan:
    name: "ðŸ›¡ï¸ Security Analysis"
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read
      issues: write
    steps:
      - uses: actions/checkout@v4

      - name: "ðŸ” CodeQL Analysis"
        uses: github/codeql-action/init@v3
        with:
          languages: python

      - name: "ðŸ—ï¸ Autobuild"
        uses: github/codeql-action/autobuild@v3

      - name: "ðŸ” Perform CodeQL Analysis"
        uses: github/codeql-action/analyze@v3

      - name: "ðŸ“£ Post scan summary as Issue"
        id: scan_summary
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const link = `https://github.com/${owner}/${repo}/security/code-scanning`;
            let alerts = [];
            let body = '';
            try {
              alerts = await github.paginate(
                github.rest.codeScanning.listAlertsForRepo,
                { owner, repo, state: 'open', per_page: 100 }
              );
              const sevCounts = { critical: 0, high: 0, medium: 0, low: 0, warning: 0, error: 0, note: 0, unknown: 0 };
              for (const a of alerts) {
                const sev = (a.rule && (a.rule.security_severity_level || a.rule.severity)) || a.severity || 'unknown';
                const key = String(sev).toLowerCase();
                if (Object.prototype.hasOwnProperty.call(sevCounts, key)) sevCounts[key] += 1; else sevCounts.unknown += 1;
              }
              const total = alerts.length;
              body = [
                `×“×•×— ×¡×¨×™×§×ª ××‘×˜×—×” (CodeQL) ×”×•×©×œ×.`,
                `\n\n×§×™×©×•×¨×™×: [Code Scanning](${link})` ,
                `\n\n×¡×™×›×•× ×”×ª×¨××•×ª ×¤×ª×•×—×•×ª:`,
                `\n- ×§×¨×™×˜×™: ${sevCounts.critical}`,
                `\n- ×’×‘×•×”: ${sevCounts.high}`,
                `\n- ×‘×™× ×•× ×™: ${sevCounts.medium}`,
                `\n- × ×ž×•×š: ${sevCounts.low}`,
                `\n- ××–×”×¨×”: ${sevCounts.warning}`,
                `\n- ×©×’×™××”: ${sevCounts.error}`,
                `\n- ×”×¢×¨×”: ${sevCounts.note}`,
                `\n- ×œ× ×™×“×•×¢: ${sevCounts.unknown}`,
                `\n\n×¡×”"×›: ${total}`
              ].join('');
            } catch (err) {
              core.warning(`Failed to fetch Code Scanning alerts: ${err.message}`);
              body = [
                `×“×•×— ×¡×¨×™×§×ª ××‘×˜×—×” (CodeQL) ×”×•×©×œ×.`,
                `\n\n×§×™×©×•×¨×™×: [Code Scanning](${link})`,
                `\n\n×œ× × ×™×ª×Ÿ ×”×™×” ×œ×ž×©×•×š ×”×ª×¨××•×ª ×“×¨×š ×”â€‘API. ×‘×“×§×• ×™×“× ×™×ª ×‘×œ×©×•× ×™×ª Security.`
              ].join('');
            }
            const title = 'ðŸ›¡ï¸ Security Scan Summary';
            // Try to find existing open issue with same title (avoid label dependency)
            const existing = await github.rest.issues.listForRepo({ owner, repo, state: 'open', per_page: 100 });
            const match = (existing.data || []).find(i => i.title === title);
            if (match) {
              await github.rest.issues.update({ owner, repo, issue_number: match.number, body });
            } else {
              await github.rest.issues.create({ owner, repo, title, body });
            }
            return body;

      - name: "ðŸ“¨ Notify Telegram"
        if: ${{ secrets.TELEGRAM_BOT_TOKEN != '' && secrets.TELEGRAM_CHAT_ID != '' }}
        run: |
          MSG="${{ steps.scan_summary.outputs.result }}"
          curl -sS -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            --data-urlencode "text=${MSG}"