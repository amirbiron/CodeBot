Cache Inspector (Admin Redis Dashboard)
=======================================

מה זה ולמה זה קיים?
--------------------
**Cache Inspector** הוא מסך אדמין שמציג נראות (observability) ל-Redis cache:
סטטיסטיקות שימוש, חיפוש מפתחות בצורה בטוחה, צפייה ב-TTL, ומחיקות מבוקרות.

המטרה היא לתת לאדמין דרך מהירה להבין עומסים/Latency ובעיות קאש, בלי לבצע פעולות מסוכנות
כמו ``KEYS *`` על Redis גדול.

איך נכנסים
----------
- **UI**: מתוך מסך Settings > "כלי אדמין"
- **URL**: ``GET /admin/cache-inspector``

הרשאות
-------
- המסך וכל פעולות הניהול הן **Admin-only**.
- משתמש לא אדמין יקבל **403** (גם אם הוא לא מחובר).

יכולות עיקריות
--------------

סטטיסטיקות Redis
^^^^^^^^^^^^^^^^
המסך מציג (לפי זמינות Redis):
- Memory usage
- Hit rate
- Total keys
- Connected clients

חיפוש מפתחות לפי Pattern עם Limit
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
- החיפוש מתבצע עם **SCAN** (לא ``KEYS``).
- ניתן להזין ``pattern`` כמו ``user:*`` ולקבוע ``limit``.
- ``limit`` מוגבל עד **500** כדי למנוע עומס.
- אם יש יותר תוצאות מה-limit, המסך מסמן שיש עוד (best-effort).

TTL + סטטוס מפתח
^^^^^^^^^^^^^^^^
לכל מפתח מוצג TTL והסטטוס:
- **Active**: TTL גדול מ-60 שניות
- **Expiring**: TTL עד 60 שניות
- **Persistent**: ללא TTL (Redis מחזיר ``-1``)
- **Expired**: לא קיים (Redis מחזיר ``-2``)

פעולות מחיקה
^^^^^^^^^^^^

מחיקת מפתח בודד
"""""""""""""""
- מתוך הטבלה (כפתור מחיקה ליד מפתח).
- יש אישור בסיסי בדפדפן לפני השליחה.

מחיקת תבנית (Pattern delete)
""""""""""""""""""""""""""""
- מתבצע עם **SCAN+DEL** ובתקציב זמן (ראו "בטיחות וביצועים").
- מחיקה של ``*`` או ``**`` **חסומה** (כדי למנוע "מחיקה של הכל" בטעות).
  במקרה כזה צריך להשתמש ב-"נקה הכל".

Clear All (נקה הכל)
"""""""""""""""""""
- יש **אישור כפול**:
  - Modal במסך ("אזהרה")
  - ובקריאת API נשלח ``{"confirm": true}``

רגישות מידע (Masking)
----------------------
כדי להימנע מדליפה של מידע רגיש דרך המסך:

- **הסתרת ערכים**: למפתחות שמזוהים כרגישים (למשל כאלו שמכילים ``session:``, ``token:``, ``auth:``, ``secret:``, ``password:``, ``credential:``, ``api_key:``)
  הערך לא מוצג ומוחזר כ-``[SENSITIVE - HIDDEN]``.
- ההסתרה חלה גם על תצוגה מקדימה וגם על פרטים מלאים של מפתח.

בטיחות וביצועים
----------------
- **ללא KEYS**: חיפוש ומחיקה לפי תבנית מבוצעים עם SCAN בלבד.
- **Budget-time**: פעולות מחיקה ארוכות נעצרות אחרי תקציב זמן כדי לא לתקוע תהליך:

  - ``CACHE_CLEAR_BUDGET_SECONDS``: תקציב לניקוי מלא (Clear All)
  - ``CACHE_DELETE_PATTERN_BUDGET_SECONDS``: תקציב למחיקת תבנית (אם לא מוגדר, נופל ל-``CACHE_CLEAR_BUDGET_SECONDS``)

לרשימת המשתנים המלאה: :doc:`/environment-variables`.

API Endpoints (רפרנס קצר)
-------------------------
- ``GET /admin/cache-inspector`` – דף ה-UI (Admin-only)
- ``POST /admin/cache-inspector/delete`` – מחיקת מפתח/תבנית (Admin-only)
  - דוגמה למחיקת מפתח:

    .. code-block:: json

       {"key": "user_files:..."}

  - דוגמה למחיקת תבנית:

    .. code-block:: json

       {"pattern": "user:*"}

- ``POST /admin/cache-inspector/clear-all`` – ניקוי מלא (Admin-only)

  .. code-block:: json

     {"confirm": true}

- ``GET /api/cache/stats`` – סטטיסטיקות כלליות (ציבורי למוניטורינג; ללא מפתחות)
- ``GET /admin/cache-inspector/key/<key>`` – פרטים על מפתח (Admin-only; הערך מוסתר אם רגיש)

תקלות נפוצות
------------
- **Redis מושבת/לא זמין**: המסך יציג ערכים כמו ``N/A`` / הודעת שגיאה, ולא יציג רשימת מפתחות.
- **אין הרשאות**: מי שאינו אדמין יקבל **403**.

ראו גם
-------
- :doc:`/webapp/caching`
