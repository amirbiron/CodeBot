

<!DOCTYPE html>
<html class="writer-html5" lang="he" data-content_root="../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>bot_handlers &mdash; תיעוד Code Keeper Bot 1.0.0</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=2d7a82d5" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=0062297a"></script>
      <script src="../_static/doctools.js?v=9a2dae69"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/translations.js?v=714bf7a6"></script>
      <script src="https://unpkg.com/mermaid@10.2.0/dist/mermaid.min.js"></script>
      <script>mermaid.initialize({startOnLoad:true});</script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="אינדקס" href="../genindex.html" />
    <link rel="search" title="חיפוש" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Code Keeper Bot
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">למפתחים ולסוכני AI:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quickstart-ai.html">התחלה מהירה - סוכני AI</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#id1">מטרה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#id2">מה אסור</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#id3">מה מותר ומומלץ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#id4">פורמטי ציטוט קוד</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#tmp">מחיקה בטוחה (רק ב-/tmp)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#pr">קומיטים ו-PR</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#id5">קישורים מהירים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">התחלה מהירה - מפתחים</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#id2">מטרה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#id3">שלב 1: התקנה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#env">שלב 2: הגדרת .env</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#id4">שלב 3: הרצה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#id5">מה הלאה?</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart-contrib.html">Quickstart לתרומה</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-contrib.html#id1">מטרה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-contrib.html#id2">צעדי הכנה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-contrib.html#id3">סביבת פיתוח</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-contrib.html#id4">הרצת טסטים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-contrib.html#stubs">על ה‑Stubs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-contrib.html#id5">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ai-guidelines.html">הנחיות מלאות לסוכני AI</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../ai-guidelines.html#id1">מגבלות קריטיות</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../ai-guidelines.html#id2">הרצת פקודות</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../ai-guidelines.html#id3">כלי קבצים מאושרים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ai-guidelines.html#id4">עקרונות עריכת קוד</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ai-guidelines.html#pull-requests">קומיטים ו-Pull Requests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ai-guidelines.html#id5">עבודה עם טסטים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ai-guidelines.html#id6">קישורים מהירים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../doc-authoring.html">Doc Authoring Guide (Sphinx/RTD)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../doc-authoring.html#id1">מטרות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../doc-authoring.html#id2">מדיניות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../doc-authoring.html#id3">טיפים מהירים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../doc-authoring.html#id4">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../style-glossary.html">Style &amp; Naming Glossary</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../style-glossary.html#id1">מטרות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../style-glossary.html#id2">מיפוי מונחים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../style-glossary.html#id3">כללים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../style-glossary.html#id4">עוגני תיעוד</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../versioning-stable-anchors.html">Versioning &amp; Stable Anchors</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../versioning-stable-anchors.html#id1">מדיניות עוגנים יציבים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../versioning-stable-anchors.html#whats-new">What’s New</a></li>
<li class="toctree-l2"><a class="reference internal" href="../versioning-stable-anchors.html#anchors">דוגמת Anchors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../versioning-stable-anchors.html#id2">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../whats-new.html">What’s New</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../whats-new.html#id1">2025-10-15</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../architecture.html">ארכיטקטורה</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#id2">סקירה כללית</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#id3">תרשים רכיבים (תמציתי)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#id4">מבנה תיקיות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#id5">זרימות מרכזיות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#id6">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">מדריך תרומה</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../contributing.html#id2">מטרה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributing.html#id3">כללים כלליים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributing.html#workflow">Workflow בסיסי</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributing.html#id4">דוגמאות שימושיות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributing.html#id5">קישורים</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">מדריכים בסיסיים:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">התקנה והגדרה</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#id2">דרישות מערכת</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#id3">התקנה מהירה</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#id4">1. שכפל את הריפוזיטורי</a></li>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#id5">2. התקן תלויות</a></li>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#id6">3. הגדר משתני סביבה</a></li>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#id7">4. הפעל את הבוט</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#docker">התקנה עם Docker</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#image">1. בנה את ה-Image</a></li>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#docker-compose">2. הפעל עם Docker Compose</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#mongodb">הגדרת MongoDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#telegram-bot">הגדרת Telegram Bot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#id8">הגדרות מתקדמות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#id9">בדיקת התקנה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#id10">פתרון בעיות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#id11">תמיכה</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../configuration.html">הגדרות תצורה</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#id2">קובץ התצורה הראשי</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#id3">משתני סביבה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#id4">הגדרות מתקדמות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#mongodb">הגדרת MongoDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#redis-cache">הגדרת Redis Cache</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#id5">הגדרות אבטחה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#id6">תצורה לסביבות שונות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#env">דוגמת קובץ .env מלא</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#id7">טיפים וטריקים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../environment-variables.html">משתני סביבה - רפרנס</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../environment-variables.html#id2">טבלה מרכזית</a></li>
<li class="toctree-l2"><a class="reference internal" href="../environment-variables.html#id3">דוגמאות קונפיגורציה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../environment-variables.html#id4">קישורים</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../api/main.html">main module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/config.html">config module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/config.html#config.BotConfig"><code class="docutils literal notranslate"><span class="pre">BotConfig</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.BOT_TOKEN"><code class="docutils literal notranslate"><span class="pre">BotConfig.BOT_TOKEN</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MONGODB_URL"><code class="docutils literal notranslate"><span class="pre">BotConfig.MONGODB_URL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.DATABASE_NAME"><code class="docutils literal notranslate"><span class="pre">BotConfig.DATABASE_NAME</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.REDIS_URL"><code class="docutils literal notranslate"><span class="pre">BotConfig.REDIS_URL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.CACHE_ENABLED"><code class="docutils literal notranslate"><span class="pre">BotConfig.CACHE_ENABLED</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.GITHUB_TOKEN"><code class="docutils literal notranslate"><span class="pre">BotConfig.GITHUB_TOKEN</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.PASTEBIN_API_KEY"><code class="docutils literal notranslate"><span class="pre">BotConfig.PASTEBIN_API_KEY</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MAX_CODE_SIZE"><code class="docutils literal notranslate"><span class="pre">BotConfig.MAX_CODE_SIZE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MAX_FILES_PER_USER"><code class="docutils literal notranslate"><span class="pre">BotConfig.MAX_FILES_PER_USER</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.SUPPORTED_LANGUAGES"><code class="docutils literal notranslate"><span class="pre">BotConfig.SUPPORTED_LANGUAGES</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.RECYCLE_TTL_DAYS"><code class="docutils literal notranslate"><span class="pre">BotConfig.RECYCLE_TTL_DAYS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.PUBLIC_BASE_URL"><code class="docutils literal notranslate"><span class="pre">BotConfig.PUBLIC_BASE_URL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.WEBAPP_URL"><code class="docutils literal notranslate"><span class="pre">BotConfig.WEBAPP_URL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MAINTENANCE_MODE"><code class="docutils literal notranslate"><span class="pre">BotConfig.MAINTENANCE_MODE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MAINTENANCE_MESSAGE"><code class="docutils literal notranslate"><span class="pre">BotConfig.MAINTENANCE_MESSAGE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MAINTENANCE_AUTO_WARMUP_SECS"><code class="docutils literal notranslate"><span class="pre">BotConfig.MAINTENANCE_AUTO_WARMUP_SECS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.RATE_LIMIT_PER_MINUTE"><code class="docutils literal notranslate"><span class="pre">BotConfig.RATE_LIMIT_PER_MINUTE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.HIGHLIGHT_THEME"><code class="docutils literal notranslate"><span class="pre">BotConfig.HIGHLIGHT_THEME</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.GIT_CHECKPOINT_PREFIX"><code class="docutils literal notranslate"><span class="pre">BotConfig.GIT_CHECKPOINT_PREFIX</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.GOOGLE_CLIENT_ID"><code class="docutils literal notranslate"><span class="pre">BotConfig.GOOGLE_CLIENT_ID</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.GOOGLE_CLIENT_SECRET"><code class="docutils literal notranslate"><span class="pre">BotConfig.GOOGLE_CLIENT_SECRET</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.GOOGLE_OAUTH_SCOPES"><code class="docutils literal notranslate"><span class="pre">BotConfig.GOOGLE_OAUTH_SCOPES</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.GOOGLE_TOKEN_REFRESH_MARGIN_SECS"><code class="docutils literal notranslate"><span class="pre">BotConfig.GOOGLE_TOKEN_REFRESH_MARGIN_SECS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.DRIVE_MENU_V2"><code class="docutils literal notranslate"><span class="pre">BotConfig.DRIVE_MENU_V2</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.DOCUMENTATION_URL"><code class="docutils literal notranslate"><span class="pre">BotConfig.DOCUMENTATION_URL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.BOT_LABEL"><code class="docutils literal notranslate"><span class="pre">BotConfig.BOT_LABEL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.DRIVE_ADD_HASH"><code class="docutils literal notranslate"><span class="pre">BotConfig.DRIVE_ADD_HASH</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.NORMALIZE_CODE_ON_SAVE"><code class="docutils literal notranslate"><span class="pre">BotConfig.NORMALIZE_CODE_ON_SAVE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.METRICS_DB_ENABLED"><code class="docutils literal notranslate"><span class="pre">BotConfig.METRICS_DB_ENABLED</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.METRICS_COLLECTION"><code class="docutils literal notranslate"><span class="pre">BotConfig.METRICS_COLLECTION</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.METRICS_BATCH_SIZE"><code class="docutils literal notranslate"><span class="pre">BotConfig.METRICS_BATCH_SIZE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.METRICS_FLUSH_INTERVAL_SEC"><code class="docutils literal notranslate"><span class="pre">BotConfig.METRICS_FLUSH_INTERVAL_SEC</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.__init__"><code class="docutils literal notranslate"><span class="pre">BotConfig.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/config.html#config.load_config"><code class="docutils literal notranslate"><span class="pre">load_config()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/bot_handlers.html">bot_handlers module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/conversation_handlers.html">conversation_handlers module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/database.html">database package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/database.html#submodules">Submodules</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/database.manager.html">database.manager module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/database.models.html">database.models module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/database.repository.html">database.repository module</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/services.html">services package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/services.html#submodules">Submodules</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/services.backup_service.html">services.backup_service module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/services.code_service.html">services.code_service module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/services.github_service.html">services.github_service module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/services.google_drive_service.html">services.google_drive_service module</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/handlers.html">handlers package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/handlers.html#subpackages">Subpackages</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.github.html">handlers.github package</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/handlers.html#submodules">Submodules</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.file_view.html">handlers.file_view module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.pagination.html">handlers.pagination module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.save_flow.html">handlers.save_flow module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.states.html">handlers.states module</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/utils.html">utils module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.CodeErrorLogger"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CodeErrorLogger.__init__"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CodeErrorLogger.log_code_processing_error"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger.log_code_processing_error()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CodeErrorLogger.log_code_activity"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger.log_code_activity()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CodeErrorLogger.log_validation_failure"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger.log_validation_failure()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CodeErrorLogger.log_sanitization_success"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger.log_sanitization_success()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.TimeUtils"><code class="docutils literal notranslate"><span class="pre">TimeUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TimeUtils.format_relative_time"><code class="docutils literal notranslate"><span class="pre">TimeUtils.format_relative_time()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TimeUtils.parse_date_string"><code class="docutils literal notranslate"><span class="pre">TimeUtils.parse_date_string()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TimeUtils.get_time_ranges"><code class="docutils literal notranslate"><span class="pre">TimeUtils.get_time_ranges()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.TextUtils"><code class="docutils literal notranslate"><span class="pre">TextUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils.truncate_text"><code class="docutils literal notranslate"><span class="pre">TextUtils.truncate_text()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils.escape_markdown"><code class="docutils literal notranslate"><span class="pre">TextUtils.escape_markdown()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils.clean_filename"><code class="docutils literal notranslate"><span class="pre">TextUtils.clean_filename()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils.extract_hashtags"><code class="docutils literal notranslate"><span class="pre">TextUtils.extract_hashtags()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils.highlight_text"><code class="docutils literal notranslate"><span class="pre">TextUtils.highlight_text()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils.format_file_size"><code class="docutils literal notranslate"><span class="pre">TextUtils.format_file_size()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils.pluralize_hebrew"><code class="docutils literal notranslate"><span class="pre">TextUtils.pluralize_hebrew()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.SecurityUtils"><code class="docutils literal notranslate"><span class="pre">SecurityUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.SecurityUtils.generate_secure_token"><code class="docutils literal notranslate"><span class="pre">SecurityUtils.generate_secure_token()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.SecurityUtils.hash_content"><code class="docutils literal notranslate"><span class="pre">SecurityUtils.hash_content()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.SecurityUtils.validate_user_input"><code class="docutils literal notranslate"><span class="pre">SecurityUtils.validate_user_input()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.SecurityUtils.sanitize_code"><code class="docutils literal notranslate"><span class="pre">SecurityUtils.sanitize_code()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils"><code class="docutils literal notranslate"><span class="pre">TelegramUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.send_typing_action"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.send_typing_action()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.send_document_action"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.send_document_action()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.safe_answer"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.safe_answer()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.get_user_mention"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.get_user_mention()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.split_long_message"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.split_long_message()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.safe_edit_message_text"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.safe_edit_message_text()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.safe_edit_message_reply_markup"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.safe_edit_message_reply_markup()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.extract_message_text_preserve_markdown"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.extract_message_text_preserve_markdown()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.CallbackQueryGuard"><code class="docutils literal notranslate"><span class="pre">CallbackQueryGuard</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CallbackQueryGuard.DEFAULT_WINDOW_SECONDS"><code class="docutils literal notranslate"><span class="pre">CallbackQueryGuard.DEFAULT_WINDOW_SECONDS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CallbackQueryGuard.should_block"><code class="docutils literal notranslate"><span class="pre">CallbackQueryGuard.should_block()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CallbackQueryGuard.should_block_async"><code class="docutils literal notranslate"><span class="pre">CallbackQueryGuard.should_block_async()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.AsyncUtils"><code class="docutils literal notranslate"><span class="pre">AsyncUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.AsyncUtils.run_with_timeout"><code class="docutils literal notranslate"><span class="pre">AsyncUtils.run_with_timeout()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.AsyncUtils.batch_process"><code class="docutils literal notranslate"><span class="pre">AsyncUtils.batch_process()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.PerformanceUtils"><code class="docutils literal notranslate"><span class="pre">PerformanceUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.PerformanceUtils.timing_decorator"><code class="docutils literal notranslate"><span class="pre">PerformanceUtils.timing_decorator()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.PerformanceUtils.measure_time"><code class="docutils literal notranslate"><span class="pre">PerformanceUtils.measure_time()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.ValidationUtils"><code class="docutils literal notranslate"><span class="pre">ValidationUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.ValidationUtils.is_valid_filename"><code class="docutils literal notranslate"><span class="pre">ValidationUtils.is_valid_filename()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.ValidationUtils.is_safe_code"><code class="docutils literal notranslate"><span class="pre">ValidationUtils.is_safe_code()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.FileUtils"><code class="docutils literal notranslate"><span class="pre">FileUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.FileUtils.download_file"><code class="docutils literal notranslate"><span class="pre">FileUtils.download_file()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.FileUtils.get_file_extension"><code class="docutils literal notranslate"><span class="pre">FileUtils.get_file_extension()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.FileUtils.get_mime_type"><code class="docutils literal notranslate"><span class="pre">FileUtils.get_mime_type()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.FileUtils.create_temp_file"><code class="docutils literal notranslate"><span class="pre">FileUtils.create_temp_file()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.ConfigUtils"><code class="docutils literal notranslate"><span class="pre">ConfigUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.ConfigUtils.load_json_config"><code class="docutils literal notranslate"><span class="pre">ConfigUtils.load_json_config()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.ConfigUtils.save_json_config"><code class="docutils literal notranslate"><span class="pre">ConfigUtils.save_json_config()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.CacheUtils"><code class="docutils literal notranslate"><span class="pre">CacheUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CacheUtils.set"><code class="docutils literal notranslate"><span class="pre">CacheUtils.set()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CacheUtils.get"><code class="docutils literal notranslate"><span class="pre">CacheUtils.get()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CacheUtils.delete"><code class="docutils literal notranslate"><span class="pre">CacheUtils.delete()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CacheUtils.clear"><code class="docutils literal notranslate"><span class="pre">CacheUtils.clear()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.get_memory_usage"><code class="docutils literal notranslate"><span class="pre">get_memory_usage()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.setup_logging"><code class="docutils literal notranslate"><span class="pre">setup_logging()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.generate_summary_stats"><code class="docutils literal notranslate"><span class="pre">generate_summary_stats()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.detect_language_from_filename"><code class="docutils literal notranslate"><span class="pre">detect_language_from_filename()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.get_language_emoji"><code class="docutils literal notranslate"><span class="pre">get_language_emoji()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.SensitiveDataFilter"><code class="docutils literal notranslate"><span class="pre">SensitiveDataFilter</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.SensitiveDataFilter.filter"><code class="docutils literal notranslate"><span class="pre">SensitiveDataFilter.filter()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.install_sensitive_filter"><code class="docutils literal notranslate"><span class="pre">install_sensitive_filter()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.normalize_code"><code class="docutils literal notranslate"><span class="pre">normalize_code()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/modules.html">workspace</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/activity_reporter.html">activity_reporter module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/activity_reporter.html#activity_reporter.get_mongo_client"><code class="docutils literal notranslate"><span class="pre">get_mongo_client()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/activity_reporter.html#activity_reporter.close_mongo_client"><code class="docutils literal notranslate"><span class="pre">close_mongo_client()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/activity_reporter.html#activity_reporter.SimpleActivityReporter"><code class="docutils literal notranslate"><span class="pre">SimpleActivityReporter</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/activity_reporter.html#activity_reporter.create_reporter"><code class="docutils literal notranslate"><span class="pre">create_reporter()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/autocomplete_manager.html">autocomplete_manager module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/autocomplete_manager.html#autocomplete_manager.AutocompleteManager"><code class="docutils literal notranslate"><span class="pre">AutocompleteManager</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/backup_menu_handler.html">backup_menu_handler module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/backup_menu_handler.html#backup_menu_handler.emit_event"><code class="docutils literal notranslate"><span class="pre">emit_event()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/backup_menu_handler.html#backup_menu_handler.BackupMenuHandler"><code class="docutils literal notranslate"><span class="pre">BackupMenuHandler</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/batch_commands.html">batch_commands module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_commands.html#batch_commands.batch_analyze_command"><code class="docutils literal notranslate"><span class="pre">batch_analyze_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_commands.html#batch_commands.batch_validate_command"><code class="docutils literal notranslate"><span class="pre">batch_validate_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_commands.html#batch_commands.job_status_command"><code class="docutils literal notranslate"><span class="pre">job_status_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_commands.html#batch_commands.large_file_command"><code class="docutils literal notranslate"><span class="pre">large_file_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_commands.html#batch_commands.handle_batch_callbacks"><code class="docutils literal notranslate"><span class="pre">handle_batch_callbacks()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_commands.html#batch_commands.setup_batch_handlers"><code class="docutils literal notranslate"><span class="pre">setup_batch_handlers()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/batch_processor.html">batch_processor module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_processor.html#batch_processor.BatchJob"><code class="docutils literal notranslate"><span class="pre">BatchJob</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_processor.html#batch_processor.BatchProcessor"><code class="docutils literal notranslate"><span class="pre">BatchProcessor</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/bot_handlers.html">bot_handlers module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/cache_commands.html">cache_commands module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_commands.html#cache_commands.cache_stats_command"><code class="docutils literal notranslate"><span class="pre">cache_stats_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_commands.html#cache_commands.clear_cache_command"><code class="docutils literal notranslate"><span class="pre">clear_cache_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_commands.html#cache_commands.setup_cache_handlers"><code class="docutils literal notranslate"><span class="pre">setup_cache_handlers()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/cache_manager.html">cache_manager module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_manager.html#cache_manager.CacheManager"><code class="docutils literal notranslate"><span class="pre">CacheManager</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_manager.html#cache_manager.cached"><code class="docutils literal notranslate"><span class="pre">cached()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_manager.html#cache_manager.async_cached"><code class="docutils literal notranslate"><span class="pre">async_cached()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/code_preview.html">code_preview module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/code_preview.html#code_preview.CodePreviewManager"><code class="docutils literal notranslate"><span class="pre">CodePreviewManager</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/code_processor.html">code_processor module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/config.html">config module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig"><code class="docutils literal notranslate"><span class="pre">BotConfig</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.load_config"><code class="docutils literal notranslate"><span class="pre">load_config()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/conftest.html">conftest module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/conftest.html#conftest.pytest_addoption"><code class="docutils literal notranslate"><span class="pre">pytest_addoption()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conftest.html#conftest.pytest_configure"><code class="docutils literal notranslate"><span class="pre">pytest_configure()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conftest.html#conftest.pytest_collection_modifyitems"><code class="docutils literal notranslate"><span class="pre">pytest_collection_modifyitems()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conftest.html#conftest.pytest_runtest_makereport"><code class="docutils literal notranslate"><span class="pre">pytest_runtest_makereport()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conftest.html#conftest.pytest_sessionfinish"><code class="docutils literal notranslate"><span class="pre">pytest_sessionfinish()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html">conversation_handlers module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/database.html">database package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/database.html#submodules">Submodules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/file_manager.html">file_manager module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/file_manager.html#file_manager.BackupInfo"><code class="docutils literal notranslate"><span class="pre">BackupInfo</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/file_manager.html#file_manager.BackupManager"><code class="docutils literal notranslate"><span class="pre">BackupManager</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/fix_telegram_parse_error.html">fix_telegram_parse_error module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/fix_telegram_parse_error.html#fix_telegram_parse_error.clean_for_telegram"><code class="docutils literal notranslate"><span class="pre">clean_for_telegram()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/fix_telegram_parse_error.html#fix_telegram_parse_error.apply_fix"><code class="docutils literal notranslate"><span class="pre">apply_fix()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/fix_telegram_parse_error.html#fix_telegram_parse_error.wrap_edit_message_calls"><code class="docutils literal notranslate"><span class="pre">wrap_edit_message_calls()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/github_menu_handler.html">github_menu_handler module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/github_menu_handler.html#github_menu_handler.emit_event"><code class="docutils literal notranslate"><span class="pre">emit_event()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_menu_handler.html#github_menu_handler.safe_html_escape"><code class="docutils literal notranslate"><span class="pre">safe_html_escape()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_menu_handler.html#github_menu_handler.format_bytes"><code class="docutils literal notranslate"><span class="pre">format_bytes()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_menu_handler.html#github_menu_handler.GitHubMenuHandler"><code class="docutils literal notranslate"><span class="pre">GitHubMenuHandler</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/github_upload_fix.html">github_upload_fix module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/github_upload_fix.html#github_upload_fix.github_upload_new_file"><code class="docutils literal notranslate"><span class="pre">github_upload_new_file()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_upload_fix.html#github_upload_fix.handle_document_fixed"><code class="docutils literal notranslate"><span class="pre">handle_document_fixed()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_upload_fix.html#github_upload_fix.upload_to_github_fixed"><code class="docutils literal notranslate"><span class="pre">upload_to_github_fixed()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_upload_fix.html#github_upload_fix.setup_minimal_commands"><code class="docutils literal notranslate"><span class="pre">setup_minimal_commands()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_upload_fix.html#github_upload_fix.stats_command_secured"><code class="docutils literal notranslate"><span class="pre">stats_command_secured()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_upload_fix.html#github_upload_fix.check_commands"><code class="docutils literal notranslate"><span class="pre">check_commands()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/handlers.html">handlers package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.html#subpackages">Subpackages</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.html#submodules">Submodules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/i18n.html">i18n package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/i18n.html#submodules">Submodules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/integrations.html">integrations module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/large_files_handler.html">large_files_handler module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/large_files_handler.html#large_files_handler.LargeFilesHandler"><code class="docutils literal notranslate"><span class="pre">LargeFilesHandler</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/lazy_loader.html">lazy_loader module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/lazy_loader.html#lazy_loader.FileChunk"><code class="docutils literal notranslate"><span class="pre">FileChunk</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/lazy_loader.html#lazy_loader.LazyLoader"><code class="docutils literal notranslate"><span class="pre">LazyLoader</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html">main module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/repo_analyzer.html">repo_analyzer module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/repo_analyzer.html#repo_analyzer.emit_event"><code class="docutils literal notranslate"><span class="pre">emit_event()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/repo_analyzer.html#repo_analyzer.RepoAnalyzer"><code class="docutils literal notranslate"><span class="pre">RepoAnalyzer</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/search_engine.html">search_engine module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/secret_manager.html">secret_manager module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/secret_manager.html#secret_manager.encrypt_secret"><code class="docutils literal notranslate"><span class="pre">encrypt_secret()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/secret_manager.html#secret_manager.decrypt_secret"><code class="docutils literal notranslate"><span class="pre">decrypt_secret()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/services.html">services package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/services.html#submodules">Submodules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/terminal_commands.html">terminal_commands module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/terminal_commands.html#terminal_commands.emit_event"><code class="docutils literal notranslate"><span class="pre">emit_event()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/terminal_commands.html#terminal_commands.run_in_sandbox"><code class="docutils literal notranslate"><span class="pre">run_in_sandbox()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/terminal_commands.html#terminal_commands.terminal_enter"><code class="docutils literal notranslate"><span class="pre">terminal_enter()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/terminal_commands.html#terminal_commands.terminal_exit"><code class="docutils literal notranslate"><span class="pre">terminal_exit()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/terminal_commands.html#terminal_commands.terminal_run_command"><code class="docutils literal notranslate"><span class="pre">terminal_run_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/terminal_commands.html#terminal_commands.terminal_command"><code class="docutils literal notranslate"><span class="pre">terminal_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/terminal_commands.html#terminal_commands.setup_terminal_handlers"><code class="docutils literal notranslate"><span class="pre">setup_terminal_handlers()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/test_basic.html">test_basic module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/test_basic.html#test_basic.test_python_version"><code class="docutils literal notranslate"><span class="pre">test_python_version()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/test_basic.html#test_basic.test_import_main"><code class="docutils literal notranslate"><span class="pre">test_import_main()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/test_basic.html#test_basic.test_environment"><code class="docutils literal notranslate"><span class="pre">test_environment()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/test_basic.html#test_basic.test_basic_calculation"><code class="docutils literal notranslate"><span class="pre">test_basic_calculation()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/test_basic.html#test_basic.TestRequirements"><code class="docutils literal notranslate"><span class="pre">TestRequirements</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/user_stats.html">user_stats module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/user_stats.html#user_stats.UserStats"><code class="docutils literal notranslate"><span class="pre">UserStats</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html">utils module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CodeErrorLogger"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TimeUtils"><code class="docutils literal notranslate"><span class="pre">TimeUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils"><code class="docutils literal notranslate"><span class="pre">TextUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.SecurityUtils"><code class="docutils literal notranslate"><span class="pre">SecurityUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils"><code class="docutils literal notranslate"><span class="pre">TelegramUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CallbackQueryGuard"><code class="docutils literal notranslate"><span class="pre">CallbackQueryGuard</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.AsyncUtils"><code class="docutils literal notranslate"><span class="pre">AsyncUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.PerformanceUtils"><code class="docutils literal notranslate"><span class="pre">PerformanceUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.ValidationUtils"><code class="docutils literal notranslate"><span class="pre">ValidationUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.FileUtils"><code class="docutils literal notranslate"><span class="pre">FileUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.ConfigUtils"><code class="docutils literal notranslate"><span class="pre">ConfigUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CacheUtils"><code class="docutils literal notranslate"><span class="pre">CacheUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.get_memory_usage"><code class="docutils literal notranslate"><span class="pre">get_memory_usage()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.setup_logging"><code class="docutils literal notranslate"><span class="pre">setup_logging()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.generate_summary_stats"><code class="docutils literal notranslate"><span class="pre">generate_summary_stats()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.detect_language_from_filename"><code class="docutils literal notranslate"><span class="pre">detect_language_from_filename()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.get_language_emoji"><code class="docutils literal notranslate"><span class="pre">get_language_emoji()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.SensitiveDataFilter"><code class="docutils literal notranslate"><span class="pre">SensitiveDataFilter</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.install_sensitive_filter"><code class="docutils literal notranslate"><span class="pre">install_sensitive_filter()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.normalize_code"><code class="docutils literal notranslate"><span class="pre">normalize_code()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../modules/index.html">מודולים ראשיים</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#file-management">File Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#github-integration">GitHub Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#backup-system">Backup System</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#code-processing">Code Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#search-engine">Search Engine</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#repository-analysis">Repository Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#batch-processing">Batch Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#large-files-handling">Large Files Handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#cache-management">Cache Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#user-statistics">User Statistics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#activity-reporting">Activity Reporting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#utilities">Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#lazy-loading">Lazy Loading</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#integrations">Integrations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#terminal-commands">Terminal Commands</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#autocomplete-manager">Autocomplete Manager</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../handlers/index.html">Handlers</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#show-command">Show Command</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../handlers/show.html">Show Command</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../handlers/show.html#show">מפרט פקודת <cite>/show</cite></a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/show.html#html">דוגמת תגובת HTML</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/show.html#id1">הערות יישום</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/show.html#id2">קישורים</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#drive-menu">Drive Menu</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../handlers/drive_menu.html">Drive Menu V2</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../handlers/drive_menu.html#id1">סקירה</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/drive_menu.html#id2">דגל פיצ’ר</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/drive_menu.html#id3">זרימות עיקריות</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/drive_menu.html#device-flow">התחברות (Device Flow)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/drive_menu.html#id4">טיפול שגיאות</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/drive_menu.html#id5">ניטור</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/drive_menu.html#module-handlers.drive.menu">API (autodoc)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#file-view-handler">File View Handler</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../handlers/index.html#file-view-handler-module">File View Handler Module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#pagination-handler">Pagination Handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#save-flow-handler">Save Flow Handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#states-handler">States Handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#github-handlers">GitHub Handlers</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../services/index.html">Services</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../services/index.html#code-service">Code Service</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../services/index.html#code-service-module">Code Service Module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../services/index.html#github-service">GitHub Service</a></li>
<li class="toctree-l2"><a class="reference internal" href="../services/index.html#backup-service">Backup Service</a></li>
<li class="toctree-l2"><a class="reference internal" href="../services/index.html#google-drive-service">Google Drive Service</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../services/google_drive_service.html">Google Drive Service</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../services/google_drive_service.html#id1">סקירה</a></li>
<li class="toctree-l4"><a class="reference internal" href="../services/google_drive_service.html#oauth">הערות OAuth</a></li>
<li class="toctree-l4"><a class="reference internal" href="../services/google_drive_service.html#id2">מבני קבצים</a></li>
<li class="toctree-l4"><a class="reference internal" href="../services/google_drive_service.html#api-autodoc">API (autodoc)</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../database/index.html">Database</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../database/index.html#database-manager">Database Manager</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/index.html#models">Models</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../database/index.html#codesnippet-model">CodeSnippet Model</a></li>
<li class="toctree-l3"><a class="reference internal" href="../database/index.html#databasemanager-class">DatabaseManager Class</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../database/index.html#database-operations">Database Operations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../database/index.html#save-operations">Save Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../database/index.html#search-operations">Search Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../database/index.html#delete-operations">Delete Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../database/index.html#statistics-operations">Statistics Operations</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../database/indexing.html">MongoDB Indexing Cookbook</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#id1">למה?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#id2">אינדקסים מומלצים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#python-pymongo">מתכונים (Python / PyMongo)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#explain-mongo-shell">בדיקות explain (Mongo Shell)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#explain">מה לחפש ב-explain?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#id3">בדיקת קיום אינדקסים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#id4">שיטות עבודה מומלצות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#id5">דוגמאות נוספות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#gotchas">Gotchas נפוצים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../database/cursor-pagination.html">Cursor-based Pagination (created_at / _id)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#id1">למה?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#id2">עקרונות מיון יציב</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#python">קידוד/פענוח קורסור (Python)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#id3">תבנית שאילתה (חדש → ישן)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#pymongo">PyMongo – דוגמה מלאה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#id4">דפדוף לאחור (ישן → חדש)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#copypaste">בדיקות ידניות (Copy‑Paste)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#id5">שיטות עבודה מומלצות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#gotchas">Gotchas נפוצים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#id6">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../database-schema.html">Database Schema</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../database-schema.html#collections">Collections</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../database-schema.html#code-snippets"><code class="docutils literal notranslate"><span class="pre">code_snippets</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../database-schema.html#users"><code class="docutils literal notranslate"><span class="pre">users</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../database-schema.html#bookmarks"><code class="docutils literal notranslate"><span class="pre">bookmarks</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../database-schema.html#sessions-webapp"><code class="docutils literal notranslate"><span class="pre">sessions</span></code> (WebApp)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../database-schema.html#indexes">Indexes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database-schema.html#relationships">Relationships</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database-schema.html#id1">קישורים</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">עזרה ודוגמאות:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../examples.html">דוגמאות שימוש</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#id2">שימוש בסיסי</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id3">יצירת אפליקציית בוט</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id4">שמירת קוד חדש</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id5">חיפוש קוד</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#handlers">שימוש ב-Handlers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#command-handler">יצירת Command Handler</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#conversation-handler">יצירת Conversation Handler</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#services">שימוש ב-Services</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id6">זיהוי שפת תכנות</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id7">ניתוח קוד</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#github">אינטגרציה עם GitHub</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#gist">העלאת קוד ל-Gist</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#gists">שליפת Gists של משתמש</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#id8">עבודה עם מסד הנתונים</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id9">ביצוע שאילתות מורכבות</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id10">עדכון קבצים</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id11">סטטיסטיקות</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#id12">טיפול בשגיאות</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id13">טיפול בשגיאות בסיסי</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#retry-logic">Retry Logic</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#id14">בדיקות</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id15">בדיקת יחידה</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id16">בדיקת אינטגרציה</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#id17">דוגמאות מתקדמות</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id18">עיבוד באצווה</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id19">קאשינג</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../testing.html">Testing Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#quickstart">🚀 Quickstart לטסטים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#id1">הנחיות קריטיות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#stubs">טעינת Stubs לטלגרם</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#tmp-path">דוגמת שימוש ב‑tmp_path</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#id2">מחיקה בטוחה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#pytest-cov">כיסוי בדיקות (pytest-cov)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#ci">CI נתמך</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#performance">בדיקות ביצועים (Performance)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#id3">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../performance-tests.html">בדיקות ביצועים (Performance Tests)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../performance-tests.html#id1">מטרה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance-tests.html#id2">סימון טסטים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance-tests.html#id3">הרצה מקומית</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance-tests.html#ci-github-actions">CI / GitHub Actions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance-tests.html#id4">דוחות וזמני ריצה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance-tests.html#id5">טיפים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ci-cd.html">CI/CD Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../ci-cd.html#id1">חוקים קשיחים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ci-cd.html#id2">סטטוסים נדרשים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ci-cd.html#ci-overview">ריכוז CI (Overview)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ci-cd.html#id3">בדיקות מומלצות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ci-cd.html#id4">בנייה של התיעוד</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ci-cd.html#id5">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../conversation-handlers.html">Conversation Handlers &amp; States</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#id1">סקירה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#states">רשימת States (מבחר בפועל)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#save-flow">Save Flow (תרשים מצבים)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#github-flow">GitHub Flow (תרשים מצבים)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#handler">דוגמת Handler תמציתית</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#id2">טבלת זרימות מלאה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#id3">קישורים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#id4">דוגמאות קוד תמציתיות (ממשיות)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#save">Save – שלבים עיקריים</a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#github">GitHub – תפריט ושיחת העלאה</a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#backup">Backup – תפריט</a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#drive">Drive – תפריט</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#id5">מוקשים נפוצים ופתרונות</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#query-answer"><code class="docutils literal notranslate"><span class="pre">query.answer()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#message-is-not-modified">עריכת הודעות בבטחה – ”Message is not modified“</a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#filters">Filters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#persistent-data-context-user-data">Persistent data (<code class="docutils literal notranslate"><span class="pre">context.user_data</span></code>)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#id6">דוגמאות טסטים קצרות</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#id7">Save – התחלה וזרימה בסיסית</a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#github-upload-conv-handler">GitHub – upload_conv_handler</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting.html">Troubleshooting Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#id1">שגיאות נפוצות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#importerror-telegram-conversationhandler-filters">ImportError בזמן טסטים (telegram / ConversationHandler / filters)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#parse-mode">שגיאות parse_mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#id2">דיבוג מהיר</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#mongodb">בדיקת חיבור MongoDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#id3">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../development.html">Development Workflow</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../development.html#handler">הוספת Handler חדש</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development.html#endpoint-webapp">הוספת Endpoint ל‑WebApp</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development.html#schema">עדכון Schema במסד הנתונים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development.html#id1">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../integrations.html">Integrations</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../integrations.html#github-api">GitHub API</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../integrations.html#gist">יצירת Gist (דוגמה)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../integrations.html#google-drive-oauth-flow">Google Drive (OAuth Flow)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integrations.html#telegram-webhooks-vs-polling">Telegram Webhooks vs Polling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integrations.html#id1">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../security.html">Security Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../security.html#id1">סודות ופרטיות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security.html#id2">הצפנת טוקנים (דוגמה)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security.html#csrf-webapp">CSRF ב‑WebApp</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security.html#rate-limiting">Rate Limiting (דוגמה)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security.html#id3">קישורים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security.html#id4">אבטחת הודעות בטלגרם</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../user/bookmarks.html">סימניות (Bookmarks)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../user/bookmarks.html#id1">מהן סימניות?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/bookmarks.html#id2">איך להוסיף סימנייה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/bookmarks.html#id3">פאנל הסימניות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/bookmarks.html#anchor">Anchor יציב</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/bookmarks.html#id4">מגבלות, אבטחה ופרטיות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/bookmarks.html#api">API קצר (למפתחים)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/bookmarks.html#id5">הערות שימושיות</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../user/share_code.html">שיתוף קוד (חשוב)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#id2">מה זה עושה?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#id3">איפה הכפתור מופיע?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#id4">איך זה עובד (זרימה)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#env">דרישות סביבתיות (ENV)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#id5">מגבלות והתנהגות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#id6">הודעות הצלחה/שגיאה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#troubleshooting">Troubleshooting קצר</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#id7">דוגמאות (טקסטואליות)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../user/github_browse.html">עיון בקוד GitHub (כולל חיפוש בשם קובץ)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../user/github_browse.html#id1">שורת כלים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/github_browse.html#id2">תוצאות חיפוש</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/github_browse.html#id3">ניווט ריפו</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../user/download_repo.html">הורדת ריפו</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../user/download_repo.html#id2">מה בדיוק מוריד</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/download_repo.html#id3">מגבלות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/download_repo.html#id4">הודעות נפוצות</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">WebApp:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../webapp/overview.html">המיני Web App (סקירה)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/overview.html#id1">מה נותן?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/overview.html#id2">כתובת והרשאות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/overview.html#env">הגדרות ENV</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/overview.html#id3">קישורים ותמונות מסך</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/caching.html">Caching &amp; HTTP Validators (ETag / Last-Modified / 304)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#id1">למה זה חשוב?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#id2">עקרונות בסיס</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#flask-werkzeug">מתכון: Flask + werkzeug</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#copypaste">בדיקות ידניות (Copy‑Paste)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#checklist">Checklist למימוש נכון</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#gotchas">Gotchas נפוצים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#cache-control">שילוב עם Cache-Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#id3">קישורים נוספים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/static-checklist.html">Static Performance &amp; Security Checklist (gzip/br, Cache, SRI)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/static-checklist.html#id1">מטרה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/static-checklist.html#br-gzip">דחיסה (br/gzip)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/static-checklist.html#cache-control">כותרות Cache-Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/static-checklist.html#subresource-integrity-sri">Subresource Integrity (SRI)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/static-checklist.html#copypaste">בדיקות ידניות (Copy‑Paste)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/static-checklist.html#best-practices">Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/static-checklist.html#gotchas">Gotchas</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/api-reference.html">WebApp API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/api-reference.html#endpoints">Endpoints</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/api-reference.html#authentication-flow">Authentication Flow</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/api-reference.html#response-schema-example">Response Schema Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/api-reference.html#errors">Errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/api-reference.html#id1">קישורים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/api-reference.html#files">מסנן ושדות קלט ל-<code class="docutils literal notranslate"><span class="pre">/files</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../webapp/api-reference.html#id2">טבלת פרמטרים</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/api-reference.html#id3">דוגמאות בקשה</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/api-reference.html#id4">דוגמאות תגובה</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/bulk-actions.html">Bulk actions (בחירה מרובה)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/bulk-actions.html#id1">סקירה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/bulk-actions.html#endpoints">Endpoints</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../webapp/bulk-actions.html#post-api-files-bulk-favorite"><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/api/files/bulk-favorite</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/bulk-actions.html#post-api-files-bulk-unfavorite"><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/api/files/bulk-unfavorite</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/bulk-actions.html#post-api-files-bulk-tag"><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/api/files/bulk-tag</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/bulk-actions.html#post-api-files-create-zip"><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/api/files/create-zip</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/bulk-actions.html#post-api-files-bulk-delete-soft-delete"><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/api/files/bulk-delete</span></code> (Soft Delete)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/bulk-actions.html#post-api-files-create-share-link"><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/api/files/create-share-link</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/bulk-actions.html#id2">שגיאות נפוצות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/bulk-actions.html#id3">הערות למפתחים</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Observability</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../observability.html">אובזרווביליות (Observability)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../observability.html#id1">מטרות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability.html#id2">קהלי יעד</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability.html#id3">תצורה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability.html#id4">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../logging_schema.html">סכמת לוגים ואירועים (Observability)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../logging_schema.html#id1">שדות חובה בכל אירוע</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logging_schema.html#id2">שדות מומלצים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logging_schema.html#id3">אירועים מרכזיים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logging_schema.html#sampling">דגימה (Sampling)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logging_schema.html#id4">פרטיות</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../metrics.html">מדדים (Metrics)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../metrics.html#id1">נקודת קצה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metrics.html#id2">מטריקות קיימות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metrics.html#promql">דוגמאות PromQL</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../alerts.html">התראות (Alerts)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../alerts.html#id1">חוקי התראה לדוגמה</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../sentry.html">Sentry</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../sentry.html#id1">הפעלה (משתני סביבה)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sentry.html#id2">עקרונות</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../runbooks/logging-levels.html">שינוי רמות לוגים</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/logging-levels.html#debug">מתי להעלות ל-DEBUG</a></li>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/logging-levels.html#id2">טיפ</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ChatOps</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../chatops/overview.html">ChatOps – סקירה כללית</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../chatops/overview.html#id1">עקרונות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/overview.html#id2">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../chatops/commands.html">פקודות ChatOps</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#status">/status</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#errors">/errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#triage">/triage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#predict">/predict</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#rate-limit">/rate_limit</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../chatops/playbooks.html">Playbooks – תרחישים נפוצים</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../chatops/playbooks.html#p95-latency">p95 Latency עלה מעל הסף</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/playbooks.html#error-rate-1">Error Rate &gt; 1%</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/playbooks.html#memory-usage">Memory Usage מטפס</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/playbooks.html#id1">שירות חיצוני איטי</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/playbooks.html#repeated-incident-15">Repeated Incident תחת 15 דק«</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../chatops/permissions.html">הרשאות ו-Rate Limit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chatops/troubleshooting.html">פתרון תקלות (FAQ)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chatops/faq.html">שאלות נפוצות</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Observability – Advanced</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../observability/events_catalog.html">קטלוג אירועים קנוניים</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../observability/events_catalog.html#github">GitHub</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/events_catalog.html#db">DB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/events_catalog.html#web-share">Web/Share</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/events_catalog.html#alerts">Alerts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/events_catalog.html#repo-analyzer">Repo Analyzer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/events_catalog.html#business">Business</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../observability/error_codes.html">מילון קודי שגיאה (Error Codes)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../observability/error_codes.html#id1">דוגמאות מיפוי</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/error_codes.html#id2">הנחיות</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../observability/metrics_promql.html">שאילתות PromQL שימושיות</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../observability/metrics_promql.html#latency">זמן תגובה (Latency)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/metrics_promql.html#id1">שיעור שגיאות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/metrics_promql.html#id2">אירועי ביזנס</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../observability/alerts_playbook.html">Playbook קצר להתראות</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../observability/alerts_playbook.html#id1">זרימה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/alerts_playbook.html#id2">קישורים בקוד</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/alerts_playbook.html#id3">דגשים</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Code Keeper Bot</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">bot_handlers</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>הראה קוד מקור ל bot_handlers</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">פקודות מתקדמות לבוט שומר קבצי קוד</span>
<span class="sd">Advanced Bot Handlers for Code Keeper Bot</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">html</span>
<span class="kn">import</span> <span class="nn">secrets</span>
<span class="kn">import</span> <span class="nn">telegram.error</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">from</span> <span class="nn">telegram</span> <span class="kn">import</span> <span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">,</span> <span class="n">InlineKeyboardMarkup</span><span class="p">,</span> <span class="n">InputFile</span><span class="p">,</span>
                      <span class="n">Update</span><span class="p">,</span> <span class="n">ReplyKeyboardMarkup</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">telegram.constants</span> <span class="kn">import</span> <span class="n">ParseMode</span>
<span class="kn">from</span> <span class="nn">telegram.ext</span> <span class="kn">import</span> <span class="n">CallbackQueryHandler</span><span class="p">,</span> <span class="n">CommandHandler</span><span class="p">,</span> <span class="n">ContextTypes</span>
<span class="kn">from</span> <span class="nn">telegram.ext</span> <span class="kn">import</span> <span class="n">ApplicationHandlerStop</span>

<span class="kn">from</span> <span class="nn">services</span> <span class="kn">import</span> <span class="n">code_service</span> <span class="k">as</span> <span class="n">code_processor</span>
<span class="kn">from</span> <span class="nn">config</span> <span class="kn">import</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">CodeSnippet</span><span class="p">,</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">conversation_handlers</span> <span class="kn">import</span> <span class="n">MAIN_KEYBOARD</span>
<span class="c1"># Reporter מוזרק בזמן ריצה כדי למנוע יצירה בזמן import</span>
<span class="k">class</span> <span class="nc">_NoopReporter</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">report_activity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>

<span class="n">reporter</span> <span class="o">=</span> <span class="n">_NoopReporter</span><span class="p">()</span>

<div class="viewcode-block" id="set_activity_reporter">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.set_activity_reporter">[תיעוד]</a>
<span class="k">def</span> <span class="nf">set_activity_reporter</span><span class="p">(</span><span class="n">new_reporter</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">reporter</span>
    <span class="n">reporter</span> <span class="o">=</span> <span class="n">new_reporter</span> <span class="ow">or</span> <span class="n">_NoopReporter</span><span class="p">()</span></div>

<span class="kn">import</span> <span class="nn">json</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">aiohttp</span>  <span class="c1"># for GitHub rate limit check</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
    <span class="n">aiohttp</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>

<span class="c1"># ChatOps helpers: sensitive command throttling and permissions integration</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">chatops.ratelimit</span> <span class="kn">import</span> <span class="n">limit_sensitive</span>  <span class="c1"># type: ignore</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
    <span class="k">def</span> <span class="nf">limit_sensitive</span><span class="p">(</span><span class="n">_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
        <span class="k">def</span> <span class="nf">_decorator</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">fn</span>
        <span class="k">return</span> <span class="n">_decorator</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">chatops.permissions</span> <span class="kn">import</span> <span class="p">(</span>
        <span class="n">admin_required</span><span class="p">,</span>
        <span class="n">chat_allowlist_required</span><span class="p">,</span>
        <span class="n">is_admin</span> <span class="k">as</span> <span class="n">_perm_is_admin</span><span class="p">,</span>
    <span class="p">)</span>  <span class="c1"># type: ignore</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
    <span class="n">_perm_is_admin</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>
    <span class="k">def</span> <span class="nf">admin_required</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
        <span class="k">return</span> <span class="n">fn</span>
    <span class="k">def</span> <span class="nf">chat_allowlist_required</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
        <span class="k">return</span> <span class="n">fn</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">os</span> <span class="k">as</span> <span class="nn">_os</span>

<div class="viewcode-block" id="AdvancedBotHandlers">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers">[תיעוד]</a>
<span class="k">class</span> <span class="nc">AdvancedBotHandlers</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;פקודות מתקדמות של הבוט&quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="AdvancedBotHandlers.__init__">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.__init__">[תיעוד]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">application</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span> <span class="o">=</span> <span class="n">application</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_advanced_handlers</span><span class="p">()</span></div>

    
<div class="viewcode-block" id="AdvancedBotHandlers.setup_advanced_handlers">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.setup_advanced_handlers">[תיעוד]</a>
    <span class="k">def</span> <span class="nf">setup_advanced_handlers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;הגדרת handlers מתקדמים&quot;&quot;&quot;</span>
        
        <span class="c1"># פקודות ניהול קבצים</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;show&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_command</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;edit&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">edit_command</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;delete&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_command</span><span class="p">))</span>
        <span class="c1"># self.application.add_handler(CommandHandler(&quot;rename&quot;, self.rename_command))</span>
        <span class="c1"># self.application.add_handler(CommandHandler(&quot;copy&quot;, self.copy_command))</span>
        <span class="c1"># מועדפים</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;favorite&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">favorite_command</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;fav&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">favorite_command</span><span class="p">))</span>  <span class="c1"># קיצור דרך</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;favorites&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">favorites_command</span><span class="p">))</span>
        
        <span class="c1"># פקודות גרסאות</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;versions&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">versions_command</span><span class="p">))</span>
        <span class="c1"># self.application.add_handler(CommandHandler(&quot;restore&quot;, self.restore_command))</span>
        <span class="c1"># self.application.add_handler(CommandHandler(&quot;diff&quot;, self.diff_command))</span>
        
        <span class="c1"># פקודות שיתוף</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;share&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">share_command</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;share_help&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">share_help_command</span><span class="p">))</span>
        <span class="c1"># self.application.add_handler(CommandHandler(&quot;export&quot;, self.export_command))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;download&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_command</span><span class="p">))</span>
        
        <span class="c1"># פקודות ניתוח</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;analyze&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_command</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;validate&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_command</span><span class="p">))</span>
        <span class="c1"># self.application.add_handler(CommandHandler(&quot;minify&quot;, self.minify_command))</span>
        
        <span class="c1"># פקודות ארגון</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;tags&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags_command</span><span class="p">))</span>
        <span class="c1"># self.application.add_handler(CommandHandler(&quot;languages&quot;, self.languages_command))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;recent&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">recent_command</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">info_command</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;broadcast&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">broadcast_command</span><span class="p">))</span>
        <span class="c1"># חיפוש</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;search&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_command</span><span class="p">))</span>
        <span class="c1"># ChatOps MVP + Stage 2 commands</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span>
            <span class="s2">&quot;status&quot;</span><span class="p">,</span>
            <span class="n">chat_allowlist_required</span><span class="p">(</span><span class="n">admin_required</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status_command</span><span class="p">))</span>
        <span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span>
            <span class="s2">&quot;observe&quot;</span><span class="p">,</span>
            <span class="n">chat_allowlist_required</span><span class="p">(</span><span class="n">admin_required</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">observe_command</span><span class="p">))</span>
        <span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span>
            <span class="s2">&quot;triage&quot;</span><span class="p">,</span>
            <span class="n">chat_allowlist_required</span><span class="p">(</span><span class="n">admin_required</span><span class="p">(</span><span class="n">limit_sensitive</span><span class="p">(</span><span class="s2">&quot;triage&quot;</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">triage_command</span><span class="p">)))</span>
        <span class="p">))</span>
        <span class="c1"># Observability v6 – Predictive Health</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;predict&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_command</span><span class="p">))</span>
        <span class="c1"># Observability v7 – Prediction accuracy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;accuracy&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">accuracy_command</span><span class="p">))</span>
        <span class="c1"># פקודת מנהל להצגת קישור ל-Sentry</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span>
            <span class="s2">&quot;sen&quot;</span><span class="p">,</span>
            <span class="n">chat_allowlist_required</span><span class="p">(</span><span class="n">admin_required</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sentry_command</span><span class="p">))</span>
        <span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span>
            <span class="s2">&quot;errors&quot;</span><span class="p">,</span>
            <span class="n">chat_allowlist_required</span><span class="p">(</span><span class="n">admin_required</span><span class="p">(</span><span class="n">limit_sensitive</span><span class="p">(</span><span class="s2">&quot;errors&quot;</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">errors_command</span><span class="p">)))</span>
        <span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span>
            <span class="s2">&quot;rate_limit&quot;</span><span class="p">,</span>
            <span class="n">chat_allowlist_required</span><span class="p">(</span><span class="n">admin_required</span><span class="p">(</span><span class="n">limit_sensitive</span><span class="p">(</span><span class="s2">&quot;rate_limit&quot;</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">rate_limit_command</span><span class="p">)))</span>
        <span class="p">))</span>
        <span class="c1"># GitHub Backoff controls (admins)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span>
            <span class="s2">&quot;enable_backoff&quot;</span><span class="p">,</span>
            <span class="n">chat_allowlist_required</span><span class="p">(</span><span class="n">admin_required</span><span class="p">(</span><span class="n">limit_sensitive</span><span class="p">(</span><span class="s2">&quot;enable_backoff&quot;</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">enable_backoff_command</span><span class="p">)))</span>
        <span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span>
            <span class="s2">&quot;disable_backoff&quot;</span><span class="p">,</span>
            <span class="n">chat_allowlist_required</span><span class="p">(</span><span class="n">admin_required</span><span class="p">(</span><span class="n">limit_sensitive</span><span class="p">(</span><span class="s2">&quot;disable_backoff&quot;</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">disable_backoff_command</span><span class="p">)))</span>
        <span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span>
            <span class="s2">&quot;uptime&quot;</span><span class="p">,</span>
            <span class="n">chat_allowlist_required</span><span class="p">(</span><span class="n">admin_required</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uptime_command</span><span class="p">))</span>
        <span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span>
            <span class="s2">&quot;alerts&quot;</span><span class="p">,</span>
            <span class="n">chat_allowlist_required</span><span class="p">(</span><span class="n">admin_required</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alerts_command</span><span class="p">))</span>
        <span class="p">))</span>
        <span class="c1"># Observability v5 – incident memory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span>
            <span class="s2">&quot;incidents&quot;</span><span class="p">,</span>
            <span class="n">chat_allowlist_required</span><span class="p">(</span><span class="n">admin_required</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">incidents_command</span><span class="p">))</span>
        <span class="p">))</span>
        
        <span class="c1"># Callback handlers לכפתורים</span>
        <span class="c1"># Guard הגלובלי התשתיתי מתווסף ב-main.py; כאן נשאר רק ה-handler הכללי</span>
        <span class="c1"># חשוב: הוספה בקבוצה מאוחרת, כדי לתת עדיפות ל-handlers ספציפיים (למשל מועדפים)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CallbackQueryHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_callback_query</span><span class="p">),</span> <span class="n">group</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="c1"># סביבת בדיקות עם add_handler ללא פרמטר group</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CallbackQueryHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_callback_query</span><span class="p">))</span>
        <span class="c1"># Handler מוקדם וממוקד לטוגל מועדפים כדי להבטיח קליטה מיידית</span>
        <span class="n">toggle_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;^(fav_toggle_id:|fav_toggle_tok:)&#39;</span>
        <span class="n">toggle_handler</span> <span class="o">=</span> <span class="n">CallbackQueryHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_callback_query</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="n">toggle_pattern</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">toggle_handler</span><span class="p">,</span> <span class="n">group</span><span class="o">=-</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">toggle_handler</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to register favorites toggle CallbackQueryHandler: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Handler ממוקד עם קדימות גבוהה לכפתורי /share</span>
        <span class="n">share_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;^(share_gist_|share_pastebin_|share_internal_|share_gist_multi:|share_internal_multi:|cancel_share)&#39;</span>
        <span class="n">share_handler</span> <span class="o">=</span> <span class="n">CallbackQueryHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_callback_query</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="n">share_pattern</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">share_handler</span><span class="p">,</span> <span class="n">group</span><span class="o">=-</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="c1"># סביבת בדיקות/סטאב שבה add_handler לא תומך בפרמטר group</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">share_handler</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># אל תבלע חריגות שקטות – דווח ללוג כדי לא לשבור את כפתורי השיתוף</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to register share CallbackQueryHandler: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="AdvancedBotHandlers.show_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.show_command">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">show_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;הצגת קטע קוד עם הדגשת תחביר&quot;&quot;&quot;</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;📄 אנא ציין שם קובץ:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;דוגמה: `/show script.py`&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">file_data</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_data</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;❌ קובץ `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">` לא נמצא.&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># קבל את הקוד המקורי בבטחה; ודא שתמיד יש מחרוזת קוד</span>
        <span class="n">code_raw</span> <span class="o">=</span> <span class="nb">str</span><span class="p">((</span><span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
        <span class="n">language</span> <span class="o">=</span> <span class="nb">str</span><span class="p">((</span><span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;programming_language&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># highlight_code עשוי להחזיר מחרוזת ריקה במקרי קצה — ניפול חזרה לקוד המקורי</span>
            <span class="n">original_code</span> <span class="o">=</span> <span class="n">code_processor</span><span class="o">.</span><span class="n">highlight_code</span><span class="p">(</span><span class="n">code_raw</span><span class="p">,</span> <span class="n">language</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">original_code</span> <span class="o">=</span> <span class="n">code_raw</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">original_code</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="n">original_code</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">original_code</span> <span class="o">=</span> <span class="n">code_raw</span>
        
        <span class="c1"># בצע הימלטות לתוכן הקוד כדי למנוע שגיאות</span>
        <span class="n">escaped_code</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">original_code</span><span class="p">)</span>
        <span class="n">language_html</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">language</span><span class="p">)</span>

        <span class="c1"># עטוף את הקוד הנקי בתגיות &lt;pre&gt;&lt;code&gt; שטלגרם תומך בהן</span>
        <span class="n">response_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;&lt;b&gt;File:&lt;/b&gt; &lt;code&gt;</span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">file_name</span><span class="p">)))</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span>
<span class="s2">&lt;b&gt;Language:&lt;/b&gt; </span><span class="si">{</span><span class="n">language_html</span><span class="si">}</span>

<span class="s2">&lt;pre&gt;&lt;code&gt;</span><span class="si">{</span><span class="n">escaped_code</span><span class="si">}</span><span class="s2">&lt;/code&gt;&lt;/pre&gt;</span>
<span class="s2">&quot;&quot;&quot;</span>
        
        <span class="c1"># --- מבנה הכפתורים החדש והנקי ---</span>
        <span class="n">file_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">,</span> <span class="n">file_name</span><span class="p">))</span>
        <span class="c1"># כפתור מועדפים בהתאם למצב הנוכחי</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">is_fav_now</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">is_favorite</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">is_fav_now</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">fav_text</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;💔 הסר ממועדפים&quot;</span> <span class="k">if</span> <span class="n">is_fav_now</span> <span class="k">else</span> <span class="s2">&quot;⭐ הוסף למועדפים&quot;</span><span class="p">)</span>
        <span class="c1"># הקפדה על מגבלת 64 בתים ב-callback_data + הימנעות מתווים בעייתיים</span>
        <span class="c1"># העדפה ל-ID אם קיים; אחרת טוקן קצר עם מיפוי ב-user_data</span>
        <span class="n">has_id</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_raw_id</span> <span class="o">=</span> <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">_raw_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">has_id</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">file_id_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">_raw_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">has_id</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">file_id_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">has_id</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="s2">&quot;fav_toggle_id:&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_id_str</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">60</span><span class="p">:</span>
            <span class="n">fav_cb</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;fav_toggle_id:</span><span class="si">{</span><span class="n">file_id_str</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">token</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">token</span> <span class="o">=</span> <span class="s2">&quot;t&quot;</span>  <span class="c1"># fallback קצר</span>
            <span class="c1"># קיצור טוקן לשימוש ב-callback_data ושמירת המיפוי תחת המפתח המקוצר</span>
            <span class="n">short_tok</span> <span class="o">=</span> <span class="p">(</span><span class="n">token</span><span class="p">[:</span><span class="mi">24</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;t&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tokens_map</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fav_tokens&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
                <span class="n">tokens_map</span><span class="p">[</span><span class="n">short_tok</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_name</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;fav_tokens&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tokens_map</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">fav_cb</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;fav_toggle_tok:</span><span class="si">{</span><span class="n">short_tok</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">buttons</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🗑️ מחיקה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;delete_</span><span class="si">{</span><span class="n">file_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;✏️ עריכה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;edit_</span><span class="si">{</span><span class="n">file_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="p">[</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📝 ערוך הערה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;edit_note_</span><span class="si">{</span><span class="n">file_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;💾 הורדה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;download_</span><span class="si">{</span><span class="n">file_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="p">[</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🌐 שיתוף&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;share_</span><span class="si">{</span><span class="n">file_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="p">[</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">fav_text</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="n">fav_cb</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">]</span>
        <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">buttons</span><span class="p">)</span>
        <span class="c1"># ---------------------------------</span>
        
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">response_text</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s1">&#39;HTML&#39;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdvancedBotHandlers.favorite_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.favorite_command">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">favorite_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;הוספה/הסרה של קובץ מהמועדפים: /favorite &lt;file_name&gt;&quot;&quot;&quot;</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;🔖 &lt;b&gt;הוספה/הסרה ממועדפים&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;שימוש: &lt;code&gt;/favorite &amp;lt;file_name&amp;gt;&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;דוגמה:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;&lt;code&gt;/favorite config.py&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;או שלח &lt;code&gt;/favorites&lt;/code&gt; לצפייה בכל המועדפים&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">snippet</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">snippet</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;❌ הקובץ &lt;code&gt;</span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/code&gt; לא נמצא.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;שלח &lt;code&gt;/list&lt;/code&gt; לרשימת הקבצים שלך.&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="n">new_state</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">toggle_favorite</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        <span class="c1"># אם המתודה מחזירה None, זו שגיאה</span>
        <span class="k">if</span> <span class="n">new_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;❌ שגיאה בעדכון מועדפים. נסה שוב מאוחר יותר.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">language</span> <span class="o">=</span> <span class="n">snippet</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;programming_language&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
        <span class="n">emoji</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">get_language_emoji</span>
            <span class="n">emoji</span> <span class="o">=</span> <span class="n">get_language_emoji</span><span class="p">(</span><span class="n">language</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">emoji</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">new_state</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;⭐ &lt;b&gt;נוסף למועדפים!&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;📁 קובץ: &lt;code&gt;</span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">emoji</span><span class="si">}</span><span class="s2"> שפה: </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">language</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;לא ידוע&#39;</span><span class="p">)</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;💡 גש במהירות עם &lt;code&gt;/favorites&lt;/code&gt;&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;💔 &lt;b&gt;הוסר מהמועדפים&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;📁 קובץ: &lt;code&gt;</span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;ניתן להוסיף שוב מאוחר יותר.&quot;</span>
            <span class="p">)</span>
        <span class="c1"># כפתורים מהירים</span>
        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📋 הצג קובץ&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;view_direct_</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;⭐ כל המועדפים&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;favorites_list&quot;</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">]</span>
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">))</span></div>


<div class="viewcode-block" id="AdvancedBotHandlers.favorites_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.favorites_command">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">favorites_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;רשימת המועדפים של המשתמש: /favorites&quot;&quot;&quot;</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">favorites</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_favorites</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">favorites</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;💭 אין לך מועדפים כרגע.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;✨ הוסף מועדף ראשון עם &lt;code&gt;/favorite &amp;lt;שם&amp;gt;&lt;/code&gt;&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;⭐ &lt;b&gt;המועדפים שלך&lt;/b&gt;&quot;</span><span class="p">]</span>
        <span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">TimeUtils</span><span class="p">,</span> <span class="n">get_language_emoji</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">fav</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">favorites</span><span class="p">[:</span><span class="mi">10</span><span class="p">],</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">fav</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">lang</span> <span class="o">=</span> <span class="n">fav</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;programming_language&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">rel</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fa</span> <span class="o">=</span> <span class="n">fav</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;favorited_at&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">fav</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;updated_at&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">fav</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;created_at&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">fa</span><span class="p">:</span>
                    <span class="n">rel</span> <span class="o">=</span> <span class="n">TimeUtils</span><span class="o">.</span><span class="n">format_relative_time</span><span class="p">(</span><span class="n">fa</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">rel</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">emoji</span> <span class="o">=</span> <span class="n">get_language_emoji</span><span class="p">(</span><span class="n">lang</span><span class="p">)</span>
            <span class="n">line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">emoji</span><span class="si">}</span><span class="s2"> &lt;code&gt;</span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span>
            <span class="k">if</span> <span class="n">rel</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; • </span><span class="si">{</span><span class="n">rel</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">favorites</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">➕ ועוד </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">favorites</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">10</span><span class="si">}</span><span class="s2"> קבצים...&quot;</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="c1"># כפתורי קיצור לקבצים (עד 5 ראשונים)</span>
        <span class="n">buttons</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fav</span> <span class="ow">in</span> <span class="n">favorites</span><span class="p">[:</span><span class="mi">5</span><span class="p">]:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">fav</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">latest</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
                <span class="n">fid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">latest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">fid</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="n">fid</span><span class="p">:</span>
                <span class="n">cb</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;view_direct_id:</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">safe_name</span> <span class="o">=</span> <span class="p">(</span><span class="n">fname</span><span class="p">[:</span><span class="mi">45</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;...&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">48</span> <span class="k">else</span> <span class="n">fname</span>
                <span class="n">cb</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;view_direct_</span><span class="si">{</span><span class="n">safe_name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">buttons</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📄 </span><span class="si">{</span><span class="n">fname</span><span class="p">[:</span><span class="mi">20</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="n">cb</span><span class="p">)])</span>
        <span class="c1"># פעולות כלליות</span>
        <span class="n">actions_row</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📥 ייצוא JSON&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;export_favorites&quot;</span><span class="p">),</span>
            <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📊 סטטיסטיקה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;favorites_stats&quot;</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">buttons</span><span class="p">:</span>
            <span class="n">buttons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">actions_row</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">buttons</span> <span class="o">=</span> <span class="p">[</span><span class="n">actions_row</span><span class="p">]</span>
        <span class="c1"># שליחת הודעה ארוכה בצורה בטוחה (פיצול למספר הודעות אם צריך)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_long_message</span><span class="p">(</span>
            <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
            <span class="n">message</span><span class="p">,</span>
            <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">,</span>
            <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">buttons</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># אם יש יותר מ-10 מועדפים, שלח את השאר כהודעות נוספות — מפוצלות בבטחה</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">favorites</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">rest_lines</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">get_language_emoji</span> <span class="k">as</span> <span class="n">_gle</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">fav</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">favorites</span><span class="p">[</span><span class="mi">10</span><span class="p">:],</span> <span class="mi">11</span><span class="p">):</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="n">fav</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">lang</span> <span class="o">=</span> <span class="n">fav</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;programming_language&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">rest_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">_gle</span><span class="p">(</span><span class="n">lang</span><span class="p">)</span><span class="si">}</span><span class="s2"> &lt;code&gt;</span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span><span class="p">)</span>
            <span class="n">rest_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rest_lines</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rest_text</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_long_message</span><span class="p">(</span>
                    <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
                    <span class="n">rest_text</span><span class="p">,</span>
                    <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="p">)</span></div>

    
<div class="viewcode-block" id="AdvancedBotHandlers.edit_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.edit_command">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">edit_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;עריכת קטע קוד קיים&quot;&quot;&quot;</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;✏️ אנא ציין שם קובץ לעריכה:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;דוגמה: `/edit script.py`&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">file_data</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_data</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;❌ קובץ `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">` לא נמצא.&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># שמירת מידע לעריכה</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;editing_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;file_name&#39;</span><span class="p">:</span> <span class="n">file_name</span><span class="p">,</span>
            <span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
            <span class="s1">&#39;original_data&#39;</span><span class="p">:</span> <span class="n">file_data</span>
        <span class="p">}</span>
        
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;✏️ **עריכת קובץ:** `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">`</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;**קוד נוכחי:**</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;```</span><span class="si">{</span><span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;programming_language&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">```</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;🔄 אנא שלח את הקוד החדש:&quot;</span><span class="p">,</span>
            <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
        <span class="p">)</span></div>

    
<div class="viewcode-block" id="AdvancedBotHandlers.delete_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.delete_command">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">delete_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;מחיקת קטע קוד&quot;&quot;&quot;</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;🗑️ אנא ציין שם קובץ למחיקה:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;דוגמה: `/delete script.py`&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">file_data</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_data</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;❌ קובץ `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">` לא נמצא.&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># כפתורי אישור</span>
        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;✅ כן, מחק&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;confirm_delete_</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;❌ ביטול&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;cancel_delete&quot;</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">]</span>
        <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
        
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;🗑️ **אישור מחיקה**</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;האם אתה בטוח שברצונך למחוק את `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">`?</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;פעולה זו תמחק את כל הגרסאות של הקובץ ולא ניתן לבטל אותה!&quot;</span><span class="p">,</span>
            <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span><span class="p">,</span>
            <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span>
        <span class="p">)</span></div>

    
<div class="viewcode-block" id="AdvancedBotHandlers.versions_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.versions_command">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">versions_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;הצגת כל גרסאות הקובץ&quot;&quot;&quot;</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;🔢 אנא ציין שם קובץ:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;דוגמה: `/versions script.py`&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">versions</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_all_versions</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">versions</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;❌ קובץ `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">` לא נמצא.&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">response</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;🔢 **גרסאות עבור:** `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">`</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        
        <span class="k">for</span> <span class="n">version_data</span> <span class="ow">in</span> <span class="n">versions</span><span class="p">:</span>
            <span class="n">is_latest</span> <span class="o">=</span> <span class="n">version_data</span> <span class="o">==</span> <span class="n">versions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;🟢 נוכחית&quot;</span> <span class="k">if</span> <span class="n">is_latest</span> <span class="k">else</span> <span class="s2">&quot;🔵 ישנה&quot;</span>
            
            <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;**גרסה </span><span class="si">{</span><span class="n">version_data</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">** </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;📅 </span><span class="si">{</span><span class="n">version_data</span><span class="p">[</span><span class="s1">&#39;updated_at&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/%m/%Y %H:%M&#39;</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;📏 </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">version_data</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> תווים</span><span class="se">\n</span><span class="s2">&quot;</span>
            
            <span class="k">if</span> <span class="n">version_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">):</span>
                <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;📝 </span><span class="si">{</span><span class="n">version_data</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            
            <span class="n">response</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        
        <span class="c1"># כפתורי פעולה</span>
        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">version_data</span> <span class="ow">in</span> <span class="n">versions</span><span class="p">[:</span><span class="mi">5</span><span class="p">]:</span>  <span class="c1"># מקסימום 5 גרסאות בכפתורים</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;📄 גרסה </span><span class="si">{</span><span class="n">version_data</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;show_version_</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">version_data</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">),</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;🔄 שחזר&quot;</span><span class="p">,</span>
                    <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;restore_version_</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">version_data</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="p">])</span>
        
        <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
        
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
            <span class="n">response</span><span class="p">,</span>
            <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span><span class="p">,</span>
            <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span>
        <span class="p">)</span></div>

    
<div class="viewcode-block" id="AdvancedBotHandlers.analyze_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.analyze_command">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">analyze_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ניתוח מתקדם של קטע קוד&quot;&quot;&quot;</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;📊 אנא ציין שם קובץ לניתוח:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;דוגמה: `/analyze script.py`&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">file_data</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_data</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;❌ קובץ `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">` לא נמצא.&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">code</span> <span class="o">=</span> <span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span>
        <span class="n">language</span> <span class="o">=</span> <span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;programming_language&#39;</span><span class="p">]</span>
        
        <span class="c1"># ניתוח הקוד</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="n">code_processor</span><span class="o">.</span><span class="n">get_code_stats</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="n">functions</span> <span class="o">=</span> <span class="n">code_processor</span><span class="o">.</span><span class="n">extract_functions</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">language</span><span class="p">)</span>
        
        <span class="n">response</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">📊 **ניתוח קוד עבור:** `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">`</span>

<span class="s2">📏 **מדדי גודל:**</span>
<span class="s2">• סה&quot;כ שורות: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;total_lines&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">• שורות קוד: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;code_lines&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">• שורות הערות: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;comment_lines&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">• שורות ריקות: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;blank_lines&#39;</span><span class="p">]</span><span class="si">}</span>

<span class="s2">📝 **מדדי תוכן:**</span>
<span class="s2">• תווים: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;characters&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">• מילים: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;words&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">• תווים ללא רווחים: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;characters_no_spaces&#39;</span><span class="p">]</span><span class="si">}</span>

<span class="s2">🔧 **מבנה קוד:**</span>
<span class="s2">• פונקציות: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;functions&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">• מחלקות: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;classes&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">• ניקוד מורכבות: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;complexity_score&#39;</span><span class="p">]</span><span class="si">}</span>

<span class="s2">📖 **קריאות:**</span>
<span class="s2">• ניקוד קריאות: </span><span class="si">{</span><span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;readability_score&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;לא זמין&#39;</span><span class="p">)</span><span class="si">}</span>
<span class="s2">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="n">functions</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">🔧 **פונקציות שנמצאו:**</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">functions</span><span class="p">[:</span><span class="mi">10</span><span class="p">]:</span>  <span class="c1"># מקסימום 10 פונקציות</span>
                <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;• `</span><span class="si">{</span><span class="n">func</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">()` (שורה </span><span class="si">{</span><span class="n">func</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">functions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;• ועוד </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">functions</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">10</span><span class="si">}</span><span class="s2"> פונקציות...</span><span class="se">\n</span><span class="s2">&quot;</span>
        
        <span class="c1"># הצעות לשיפור</span>
        <span class="n">suggestions</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">if</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;comment_lines&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;total_lines&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">:</span>
            <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;💡 הוסף יותר הערות לקוד&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;functions&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;total_lines&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
            <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;💡 שקול לחלק את הקוד לפונקציות&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;complexity_score&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;total_lines&#39;</span><span class="p">]:</span>
            <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;💡 הקוד מורכב - שקול פישוט&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">suggestions</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">💡 **הצעות לשיפור:**</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">suggestion</span> <span class="ow">in</span> <span class="n">suggestions</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;• </span><span class="si">{</span><span class="n">suggestion</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdvancedBotHandlers.status_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.status_command">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">status_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;/status – בדיקות בריאות בסיסיות: DB, Redis, GitHub API&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># הרשאות: אדמינים בלבד</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_admin</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;❌ פקודה זמינה למנהלים בלבד&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="c1"># DB status - בדיקת פינג אמיתית ל-MongoDB</span>
            <span class="n">db_ok</span> <span class="o">=</span> <span class="k">await</span> <span class="n">check_db_connection</span><span class="p">()</span>

            <span class="c1"># Redis status</span>
            <span class="n">redis_ok</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">cache_manager</span> <span class="kn">import</span> <span class="n">cache</span> <span class="k">as</span> <span class="n">_cache</span>
                <span class="n">redis_ok</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">_cache</span><span class="p">,</span> <span class="s1">&#39;is_enabled&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">redis_ok</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># GitHub API rate limit (optional)</span>
            <span class="n">gh_status</span> <span class="o">=</span> <span class="s2">&quot;unknown&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">aiohttp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;GITHUB_TOKEN&quot;</span><span class="p">):</span>
                    <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
                        <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;https://api.github.com/rate_limit&quot;</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;token </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;GITHUB_TOKEN&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">})</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                            <span class="n">remaining</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resources&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;core&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;remaining&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                            <span class="n">limit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resources&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;core&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;limit&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                            <span class="n">used_pct</span> <span class="o">=</span> <span class="p">(</span><span class="mi">100</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">remaining</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span> <span class="k">if</span> <span class="n">limit</span> <span class="k">else</span> <span class="mi">0</span>
                            <span class="n">gh_status</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">remaining</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">limit</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">used_pct</span><span class="si">}</span><span class="s2">% used)&quot;</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">gh_status</span> <span class="o">=</span> <span class="s2">&quot;error&quot;</span>

            <span class="k">def</span> <span class="nf">_emoji</span><span class="p">(</span><span class="n">ok</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;🟢&quot;</span> <span class="k">if</span> <span class="n">ok</span> <span class="k">else</span> <span class="s2">&quot;🔴&quot;</span>

            <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;📋 Status</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;DB: </span><span class="si">{</span><span class="n">_emoji</span><span class="p">(</span><span class="n">db_ok</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Redis: </span><span class="si">{</span><span class="n">_emoji</span><span class="p">(</span><span class="n">redis_ok</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;GitHub: </span><span class="si">{</span><span class="n">gh_status</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה ב-/status: </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdvancedBotHandlers.sentry_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.sentry_command">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">sentry_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;/sen – מחזיר קישור ל-Sentry (מנהלים בלבד)&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_admin</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;❌ פקודה זמינה למנהלים בלבד&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="c1"># עדיפות ל-ENV ישיר של קישור דאשבורד</span>
            <span class="n">dashboard</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SENTRY_DASHBOARD_URL&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SENTRY_PROJECT_URL&quot;</span><span class="p">)</span>
            <span class="n">dsn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SENTRY_DSN&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
            <span class="n">url</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">dashboard</span><span class="p">:</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">dashboard</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># ננסה לגזור דומיין מה-DSN (ללא זליגת סודות)</span>
                <span class="n">host</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlparse</span>
                    <span class="n">parsed</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">dsn</span><span class="p">)</span>
                    <span class="n">host</span> <span class="o">=</span> <span class="p">(</span><span class="n">parsed</span><span class="o">.</span><span class="n">hostname</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;ingest.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">parsed</span><span class="o">.</span><span class="n">hostname</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">host</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">org</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SENTRY_ORG&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SENTRY_ORG_SLUG&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">host</span> <span class="ow">and</span> <span class="n">org</span><span class="p">:</span>
                    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2">/organizations/</span><span class="si">{</span><span class="n">org</span><span class="si">}</span><span class="s2">/issues/&quot;</span>
                <span class="k">elif</span> <span class="n">host</span><span class="p">:</span>
                    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2">/&quot;</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;ℹ️ Sentry לא מוגדר בסביבה זו.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">safe_url</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🔗 Sentry: </span><span class="si">{</span><span class="n">safe_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה ב-/sen: </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdvancedBotHandlers.uptime_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.uptime_command">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">uptime_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;/uptime – אחוז זמינות כולל לפי metrics&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># הרשאות: אדמינים בלבד</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_admin</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;❌ פקודה זמינה למנהלים בלבד&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">metrics</span> <span class="kn">import</span> <span class="n">get_uptime_percentage</span>  <span class="c1"># type: ignore</span>
                <span class="n">uptime</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">get_uptime_percentage</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">uptime</span> <span class="o">=</span> <span class="mf">100.0</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⏱️ Uptime: </span><span class="si">{</span><span class="n">uptime</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה ב-/uptime: </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdvancedBotHandlers.observe_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.observe_command">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">observe_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;/observe – סיכום חי מתוך /metrics ו-/alerts (24h/5m)&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># הרשאות: אדמינים בלבד</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_admin</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;❌ פקודה זמינה למנהלים בלבד&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="c1"># Uptime</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">metrics</span> <span class="kn">import</span> <span class="n">get_uptime_percentage</span>  <span class="c1"># type: ignore</span>
                <span class="n">uptime</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">get_uptime_percentage</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">uptime</span> <span class="o">=</span> <span class="mf">100.0</span>

            <span class="c1"># Error rate &amp; Active users &amp; alerts via internal helpers and endpoints</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Prefer internal metrics helpers when available</span>
                <span class="kn">from</span> <span class="nn">alert_manager</span> <span class="kn">import</span> <span class="n">get_current_error_rate_percent</span>  <span class="c1"># type: ignore</span>
                <span class="n">error_rate</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">get_current_error_rate_percent</span><span class="p">(</span><span class="n">window_sec</span><span class="o">=</span><span class="mi">5</span> <span class="o">*</span> <span class="mi">60</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">error_rate</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="c1"># Active users gauge – best-effort via Prometheus isn&#39;t available directly here;</span>
            <span class="c1"># we maintain a rough number in memory in metrics via note_active_user, not per 24h.</span>
            <span class="c1"># For ChatOps, provide a conservative placeholder if not available.</span>
            <span class="n">active_users</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Attempt to import the in-memory set if exposed (best-effort)</span>
                <span class="kn">from</span> <span class="nn">metrics</span> <span class="kn">import</span> <span class="n">codebot_active_users_total</span>  <span class="c1"># type: ignore</span>
                <span class="k">if</span> <span class="n">codebot_active_users_total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Prometheus Gauge does not expose value portably; leave 0 if unavailable</span>
                    <span class="n">active_users</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">active_users</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Alerts count (24h) using internal_alerts buffer (approx, not persisted)</span>
            <span class="n">alerts_24h</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">critical_24h</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">internal_alerts</span> <span class="kn">import</span> <span class="n">get_recent_alerts</span>  <span class="c1"># type: ignore</span>
                <span class="n">items</span> <span class="o">=</span> <span class="n">get_recent_alerts</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
                <span class="c1"># Filter by timestamp (ISO) last 24h</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
                <span class="n">day_ago</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span> <span class="o">-</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">3600</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">ts</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ts&#39;</span><span class="p">)</span>
                        <span class="n">t</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ts</span><span class="p">))</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span> <span class="k">if</span> <span class="n">ts</span> <span class="k">else</span> <span class="mf">0.0</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">t</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;=</span> <span class="n">day_ago</span><span class="p">:</span>
                        <span class="n">alerts_24h</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;severity&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;critical&#39;</span><span class="p">:</span>
                            <span class="n">critical_24h</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">alerts_24h</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">critical_24h</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;🔍 Observability Overview</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Uptime: </span><span class="si">{</span><span class="n">uptime</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Error Rate: </span><span class="si">{</span><span class="n">error_rate</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Active Users: </span><span class="si">{</span><span class="n">active_users</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Alerts (24h): </span><span class="si">{</span><span class="n">alerts_24h</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">critical_24h</span><span class="si">}</span><span class="s2"> critical)&quot;</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה ב-/observe: </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdvancedBotHandlers.alerts_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.alerts_command">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">alerts_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;/alerts – הצג 5 ההתראות האחרונות מהמערכת הפנימית&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># הרשאות: אדמינים בלבד</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_admin</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;❌ פקודה זמינה למנהלים בלבד&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">internal_alerts</span> <span class="kn">import</span> <span class="n">get_recent_alerts</span>  <span class="c1"># type: ignore</span>
                <span class="n">items</span> <span class="o">=</span> <span class="n">get_recent_alerts</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">items</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;ℹ️ אין התראות אחרונות&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;🚨 התראות אחרונות:&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;alert&#39;</span><span class="p">)</span>
                <span class="n">sev</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;severity&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;info&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                <span class="n">summary</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;summary&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. [</span><span class="si">{</span><span class="n">sev</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> – </span><span class="si">{</span><span class="n">summary</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה ב-/alerts: </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdvancedBotHandlers.incidents_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.incidents_command">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">incidents_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;/incidents – 5 התקלות האחרונות (שם, זמן, טיפול)&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_admin</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;❌ פקודה זמינה למנהלים בלבד&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">remediation_manager</span> <span class="kn">import</span> <span class="n">get_incidents</span>  <span class="c1"># type: ignore</span>
                <span class="n">items</span> <span class="o">=</span> <span class="n">get_incidents</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;🧠 תקלות אחרונות:&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">items</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;(אין תקלות מתועדות)&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">((</span><span class="n">items</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span> <span class="k">if</span> <span class="n">items</span> <span class="k">else</span> <span class="p">[]),</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;incident&#39;</span><span class="p">)</span>
                <span class="n">ts</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ts&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">action</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;response_action&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> — </span><span class="si">{</span><span class="n">ts</span><span class="si">}</span><span class="s2"> — action: </span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># הרחבה: תחזיות פעילות (Observability v6)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">predictive_engine</span> <span class="kn">import</span> <span class="n">get_recent_predictions</span>  <span class="c1"># type: ignore</span>
                <span class="n">preds</span> <span class="o">=</span> <span class="n">get_recent_predictions</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">preds</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">🔮 תחזיות פעילות:&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">preds</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;(אין תחזיות פעילות)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">preds</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:],</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metric&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
                    <span class="n">when</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;predicted_cross_ts&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;predicted_cross_at&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2"> → </span><span class="si">{</span><span class="n">when</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה ב-/incidents: </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdvancedBotHandlers.predict_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.predict_command">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">predict_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;/predict – תחזית תקלות ל-3 שעות הקרובות עם חיווי מגמות.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># הרשאות: אדמינים בלבד</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_admin</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;❌ פקודה זמינה למנהלים בלבד&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">predictive_engine</span> <span class="kn">import</span> <span class="n">evaluate_predictions</span>  <span class="c1"># type: ignore</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;ℹ️ מנוע חיזוי אינו זמין בסביבה זו&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">horizon</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span>  <span class="c1"># 3h</span>
            <span class="n">trends</span> <span class="o">=</span> <span class="n">evaluate_predictions</span><span class="p">(</span><span class="n">horizon_seconds</span><span class="o">=</span><span class="n">horizon</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">trends</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;🔮 אין נתונים מספיקים לחיזוי כרגע&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">def</span> <span class="nf">_dir_emoji</span><span class="p">(</span><span class="n">slope</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">slope</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">:</span>
                        <span class="k">return</span> <span class="s2">&quot;🔴&quot;</span>  <span class="c1"># עליה</span>
                    <span class="k">if</span> <span class="n">slope</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">1e-6</span><span class="p">:</span>
                        <span class="k">return</span> <span class="s2">&quot;🟢&quot;</span>  <span class="c1"># ירידה</span>
                    <span class="k">return</span> <span class="s2">&quot;⚪&quot;</span>      <span class="c1"># יציב</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s2">&quot;⚪&quot;</span>
            <span class="n">lines</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;🔮 Predictive Health – 3h&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">trends</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">metric</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
                    <span class="n">slope</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="s1">&#39;slope_per_minute&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="ow">or</span> <span class="mf">0.0</span><span class="p">)</span>
                    <span class="n">current</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="s1">&#39;current_value&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="ow">or</span> <span class="mf">0.0</span><span class="p">)</span>
                    <span class="n">thr</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="s1">&#39;threshold&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="ow">or</span> <span class="mf">0.0</span><span class="p">)</span>
                    <span class="n">cross_ts</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="s1">&#39;predicted_cross_ts&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">emoji</span> <span class="o">=</span> <span class="n">_dir_emoji</span><span class="p">(</span><span class="n">slope</span><span class="p">)</span>
                    <span class="n">base</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">emoji</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">: curr=</span><span class="si">{</span><span class="n">current</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> thr=</span><span class="si">{</span><span class="n">thr</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> slope/min=</span><span class="si">{</span><span class="n">slope</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">if</span> <span class="n">cross_ts</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timezone</span>
                            <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">cross_ts</span><span class="p">),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
                            <span class="n">when</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M UTC&#39;</span><span class="p">)</span>
                            <span class="n">base</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; → חצייה צפויה ב-</span><span class="si">{</span><span class="n">when</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="n">base</span> <span class="o">+=</span> <span class="s2">&quot; → חצייה צפויה&quot;</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה ב-/predict: </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdvancedBotHandlers.accuracy_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.accuracy_command">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">accuracy_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;/accuracy — דיוק חיזוי נוכחי וסטטיסטיקת מניעה.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># הרשאות: אדמינים בלבד</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_admin</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;❌ פקודה זמינה למנהלים בלבד&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="c1"># שליפת דיוק חיזוי מ-gauge אם קיים</span>
            <span class="n">accuracy</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">prevented_total</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">metrics</span> <span class="kn">import</span> <span class="n">prediction_accuracy_percent</span><span class="p">,</span> <span class="n">prevented_incidents_total</span>  <span class="c1"># type: ignore</span>
                <span class="k">if</span> <span class="n">prediction_accuracy_percent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Gauges in prometheus_client expose _value.get()</span>
                    <span class="n">accuracy</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">prediction_accuracy_percent</span><span class="p">,</span> <span class="s2">&quot;_value&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;get&quot;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">)())</span>
                <span class="k">if</span> <span class="n">prevented_incidents_total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Sum across all labels if possible</span>
                    <span class="c1"># prometheus_client stores counters in _metrics dict keyed by label tuples</span>
                    <span class="n">metrics_map</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">prevented_incidents_total</span><span class="p">,</span> <span class="s2">&quot;_metrics&quot;</span><span class="p">,</span> <span class="p">{})</span> <span class="ow">or</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">_labels</span><span class="p">,</span> <span class="n">sample</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">metrics_map</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="p">[])():</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">prevented_total</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="s2">&quot;_value&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;get&quot;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="mi">0</span><span class="p">)())</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">continue</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="c1"># גיבוי: חישוב זריז מתוך predictive_engine (אם gauge לא קיים)</span>
            <span class="k">if</span> <span class="n">accuracy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span> <span class="nn">predictive_engine</span> <span class="kn">import</span> <span class="n">get_recent_predictions</span>  <span class="c1"># type: ignore</span>
                    <span class="n">preds</span> <span class="o">=</span> <span class="n">get_recent_predictions</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
                    <span class="n">accuracy</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="k">if</span> <span class="n">preds</span> <span class="k">else</span> <span class="mf">0.0</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">accuracy</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;📊 Prediction Accuracy: </span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;🛡️ Prevented Incidents (est.): </span><span class="si">{</span><span class="n">prevented_total</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה ב-/accuracy: </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdvancedBotHandlers.errors_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.errors_command">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">errors_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;/errors – 10 השגיאות האחרונות. מקור ראשי: Sentry; Fallback: זיכרון מקומי.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># הרשאות: אדמינים בלבד</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_admin</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;❌ פקודה זמינה למנהלים בלבד&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="n">lines</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">used_fallback</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># 1) Sentry-first (best-effort)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">integrations_sentry</span> <span class="k">as</span> <span class="nn">_sentry</span>  <span class="c1"># type: ignore</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">_sentry</span><span class="p">,</span> <span class="s2">&quot;is_configured&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">_sentry</span><span class="o">.</span><span class="n">is_configured</span><span class="p">():</span>
                    <span class="n">issues</span> <span class="o">=</span> <span class="k">await</span> <span class="n">_sentry</span><span class="o">.</span><span class="n">get_recent_issues</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">issues</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">issues</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                            <span class="n">sid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shortId&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">it</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>
                            <span class="n">title</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. [</span><span class="si">{</span><span class="n">sid</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># ignore and try fallback</span>
                <span class="k">pass</span>

            <span class="c1"># 2) Fallback – recent errors buffer from observability</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">lines</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span> <span class="nn">observability</span> <span class="kn">import</span> <span class="n">get_recent_errors</span>  <span class="c1"># type: ignore</span>
                    <span class="n">recent</span> <span class="o">=</span> <span class="n">get_recent_errors</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="n">recent</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">er</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">recent</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                            <span class="n">code</span> <span class="o">=</span> <span class="n">er</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error_code&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;-&quot;</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="n">er</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">er</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;event&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
                            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. [</span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">used_fallback</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">used_fallback</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">used_fallback</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">lines</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;(אין נתוני שגיאות זמינים בסביבה זו)&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;🧰 שגיאות אחרונות:&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">lines</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה ב-/errors: </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdvancedBotHandlers.triage_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.triage_command">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">triage_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;/triage &lt;request_id|query&gt; – דוח חקירה קצר + קישור ל-HTML&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># הרשאות: אדמינים בלבד</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_admin</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;❌ פקודה זמינה למנהלים בלבד&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="n">args</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[]</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">query</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;ℹ️ שימוש: /triage &lt;request_id או שאילתא&gt;&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="c1"># איסוף נתונים דרך שירות ה-investigation (Sentry-first, best-effort)</span>
            <span class="n">result</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">services</span> <span class="kn">import</span> <span class="n">investigation_service</span> <span class="k">as</span> <span class="n">inv</span>  <span class="c1"># type: ignore</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">inv</span><span class="o">.</span><span class="n">triage</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="s2">&quot;timeline&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;summary_text&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}</span>

            <span class="n">summary_lines</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;🔎 Triage&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Query: </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
            <span class="n">text_summary</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary_text&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">text_summary</span><span class="p">:</span>
                <span class="n">summary_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text_summary</span><span class="p">)</span>

            <span class="c1"># שיתוף דוח HTML מלא כ-share פנימי</span>
            <span class="n">share_url</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">integrations</span> <span class="kn">import</span> <span class="n">code_sharing</span>  <span class="c1"># type: ignore</span>
                <span class="n">html_doc</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary_html&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">share</span> <span class="o">=</span> <span class="k">await</span> <span class="n">code_sharing</span><span class="o">.</span><span class="n">share_code</span><span class="p">(</span>
                    <span class="s2">&quot;internal&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;triage-</span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">.html&quot;</span><span class="p">,</span> <span class="n">html_doc</span><span class="p">,</span> <span class="s2">&quot;html&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Triage report&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">share</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">share_url</span> <span class="o">=</span> <span class="n">share</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">share_url</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">share_url</span><span class="p">:</span>
                <span class="n">summary_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;דוח מלא: </span><span class="si">{</span><span class="n">share_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># קישורי Grafana (2 ראשונים)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">links</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;grafana_links&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[])</span>
                <span class="k">if</span> <span class="n">links</span><span class="p">:</span>
                    <span class="n">glines</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">l</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">](</span><span class="si">{</span><span class="n">l</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">links</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">summary_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Grafana: </span><span class="si">{</span><span class="n">glines</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">summary_lines</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה ב-/triage: </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdvancedBotHandlers.rate_limit_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.rate_limit_command">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">rate_limit_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;/rate_limit – מצב מגבלת GitHub עם התראה אם שימוש &gt;80%&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># הרשאות: אדמינים בלבד</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_admin</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;❌ פקודה זמינה למנהלים בלבד&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">aiohttp</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;GITHUB_TOKEN&quot;</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;ℹ️ אין GITHUB_TOKEN או aiohttp – מידע לא זמין&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
                <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;https://api.github.com/rate_limit&quot;</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;token </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;GITHUB_TOKEN&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">})</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="n">core</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resources&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;core&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">remaining</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;remaining&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;limit&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">used_pct</span> <span class="o">=</span> <span class="p">(</span><span class="mi">100</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">remaining</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span> <span class="k">if</span> <span class="n">limit</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">bar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_progress_bar</span><span class="p">(</span><span class="n">used_pct</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;📈 GitHub Rate Limit</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Remaining: </span><span class="si">{</span><span class="n">remaining</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">limit</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Usage: </span><span class="si">{</span><span class="n">bar</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="c1"># אזהרה גם כאשר הנתונים לא זמינים (limit==0), וגם מעל 80%</span>
            <span class="k">if</span> <span class="n">used_pct</span> <span class="o">&gt;=</span> <span class="mi">80</span> <span class="ow">or</span> <span class="n">limit</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">⚠️ מתקרבים למגבלה! שקול לצמצם קריאות או להפעיל backoff&quot;</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה ב-/rate_limit: </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdvancedBotHandlers.enable_backoff_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.enable_backoff_command">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">enable_backoff_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;/enable_backoff – הפעלת Backoff גלובלי (מנהלים בלבד)&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_admin</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;❌ פקודה זמינה למנהלים בלבד&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">ttl_min</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ttl_min</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">ttl_min</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="s2">&quot;manual&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">services</span> <span class="kn">import</span> <span class="n">github_backoff_state</span> <span class="k">as</span> <span class="n">_state</span>
                <span class="k">if</span> <span class="n">_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;ℹ️ Backoff לא זמין בסביבה זו&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="n">info</span> <span class="o">=</span> <span class="n">_state</span><span class="o">.</span><span class="n">enable</span><span class="p">(</span><span class="n">reason</span><span class="o">=</span><span class="n">reason</span><span class="p">,</span> <span class="n">ttl_minutes</span><span class="o">=</span><span class="n">ttl_min</span><span class="p">)</span>
                <span class="n">ttl_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;, יפוג בעוד </span><span class="si">{</span><span class="n">ttl_min</span><span class="si">}</span><span class="s2"> דק&#39;&quot;</span> <span class="k">if</span> <span class="n">ttl_min</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🟡 הופעל Backoff GitHub (סיבה: </span><span class="si">{</span><span class="n">info</span><span class="o">.</span><span class="n">reason</span><span class="si">}{</span><span class="n">ttl_text</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה בהפעלת Backoff: </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה ב-/enable_backoff: </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdvancedBotHandlers.disable_backoff_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.disable_backoff_command">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">disable_backoff_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;/disable_backoff – כיבוי Backoff גלובלי (מנהלים בלבד)&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_admin</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;❌ פקודה זמינה למנהלים בלבד&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">services</span> <span class="kn">import</span> <span class="n">github_backoff_state</span> <span class="k">as</span> <span class="n">_state</span>
                <span class="k">if</span> <span class="n">_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;ℹ️ Backoff לא זמין בסביבה זו&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="n">info</span> <span class="o">=</span> <span class="n">_state</span><span class="o">.</span><span class="n">disable</span><span class="p">(</span><span class="n">reason</span><span class="o">=</span><span class="s2">&quot;manual&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;🟢 Backoff כובה&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה בכיבוי Backoff: </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה ב-/disable_backoff: </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_progress_bar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">percentage</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">filled</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">percentage</span><span class="p">)))</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
            <span class="n">bar</span> <span class="o">=</span> <span class="s2">&quot;█&quot;</span> <span class="o">*</span> <span class="n">filled</span> <span class="o">+</span> <span class="s2">&quot;░&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="n">filled</span><span class="p">)</span>
            <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;🟢&quot;</span> <span class="k">if</span> <span class="n">percentage</span> <span class="o">&lt;</span> <span class="mi">60</span> <span class="k">else</span> <span class="s2">&quot;🟡&quot;</span> <span class="k">if</span> <span class="n">percentage</span> <span class="o">&lt;</span> <span class="mi">80</span> <span class="k">else</span> <span class="s2">&quot;🔴&quot;</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">color</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">bar</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">percentage</span><span class="si">}</span><span class="s2">%&quot;</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">percentage</span><span class="si">}</span><span class="s2">%&quot;</span>
    
<div class="viewcode-block" id="AdvancedBotHandlers.validate_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.validate_command">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">validate_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;בדיקת תחביר של קוד&quot;&quot;&quot;</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;✅ אנא ציין שם קובץ לבדיקה:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;דוגמה: `/validate script.py`&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">file_data</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_data</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;❌ קובץ `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">` לא נמצא.&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># בדיקת תחביר</span>
        <span class="kn">from</span> <span class="nn">code_processor</span> <span class="kn">import</span> <span class="n">CodeProcessor</span>
        <span class="n">validation</span> <span class="o">=</span> <span class="n">CodeProcessor</span><span class="p">()</span><span class="o">.</span><span class="n">validate_syntax</span><span class="p">(</span><span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">],</span> <span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;programming_language&#39;</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="n">validation</span><span class="p">[</span><span class="s1">&#39;is_valid&#39;</span><span class="p">]:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;✅ **תחביר תקין עבור:** `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">`</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;🎉 הקוד עובר את כל בדיקות התחביר!&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;❌ **שגיאות תחביר עבור:** `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">`</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            
            <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">validation</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]:</span>
                <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;🚨 **שגיאה בשורה </span><span class="si">{</span><span class="n">error</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:**</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">error</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        
        <span class="c1"># אזהרות</span>
        <span class="k">if</span> <span class="n">validation</span><span class="p">[</span><span class="s1">&#39;warnings&#39;</span><span class="p">]:</span>
            <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;⚠️ **אזהרות:**</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">warning</span> <span class="ow">in</span> <span class="n">validation</span><span class="p">[</span><span class="s1">&#39;warnings&#39;</span><span class="p">]:</span>
                <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;• שורה </span><span class="si">{</span><span class="n">warning</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">warning</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        
        <span class="c1"># הצעות</span>
        <span class="k">if</span> <span class="n">validation</span><span class="p">[</span><span class="s1">&#39;suggestions&#39;</span><span class="p">]:</span>
            <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">💡 **הצעות לשיפור:**</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">suggestion</span> <span class="ow">in</span> <span class="n">validation</span><span class="p">[</span><span class="s1">&#39;suggestions&#39;</span><span class="p">]:</span>
                <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;• </span><span class="si">{</span><span class="n">suggestion</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="AdvancedBotHandlers.share_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.share_command">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">share_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;שיתוף קטע(י) קוד ב-Gist/Pastebin/קישור פנימי. תומך בשם יחיד או שמות מרובים.&quot;&quot;&quot;</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;🌐 אנא ציין שם קובץ או כמה שמות, מופרדים ברווח:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;דוגמאות:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;• `/share script.py`</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;• `/share app.py utils.py README.md`&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># תמיכה בשמות מרובים + wildcards (כמו *.py)</span>
        <span class="n">requested_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span>
        <span class="c1"># ניקוי כפילויות, שימור סדר</span>
        <span class="n">seen</span><span class="p">:</span> <span class="nb">set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">file_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">requested_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">file_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># שליפת פרטי הקבצים (תומך ב-wildcards)</span>
        <span class="n">found_files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">missing</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># נקבל את רשימת הקבצים של המשתמש למסנן wildcards בזיכרון</span>
        <span class="n">all_files</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user_files</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        <span class="n">all_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">all_files</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">_expand_pattern</span><span class="p">(</span><span class="n">pattern</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
            <span class="c1"># תמיכה בסיסית ב-* בלבד (תחילת/סוף/אמצע)</span>
            <span class="k">if</span> <span class="s1">&#39;*&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pattern</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">pattern</span><span class="p">]</span>
            <span class="c1"># ממפה ל-regex פשוט</span>
            <span class="kn">import</span> <span class="nn">re</span> <span class="k">as</span> <span class="nn">_re</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="s1">&#39;^&#39;</span> <span class="o">+</span> <span class="n">_re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">*&#39;</span><span class="p">,</span> <span class="s1">&#39;.*&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;$&#39;</span>
            <span class="n">rx</span> <span class="o">=</span> <span class="n">_re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">all_names</span> <span class="k">if</span> <span class="n">rx</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>

        <span class="n">expanded_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">file_names</span><span class="p">:</span>
            <span class="n">expanded</span> <span class="o">=</span> <span class="n">_expand_pattern</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">expanded_names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">expanded</span><span class="p">)</span>

        <span class="c1"># ניפוי כפילויות ושמירת סדר</span>
        <span class="n">seen2</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">final_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">expanded_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen2</span><span class="p">:</span>
                <span class="n">seen2</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                <span class="n">final_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">final_names</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">found_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">found_files</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;❌ לא נמצאו קבצים לשיתוף.&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># קידוד מזהה הקשר לשיתוף מרובה קבצים</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">found_files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">single</span> <span class="o">=</span> <span class="n">found_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="n">single</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">]</span>
            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🐙 GitHub Gist&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;share_gist_</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📋 Pastebin&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;share_pastebin_</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">PUBLIC_BASE_URL</span><span class="p">:</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📱 קישור פנימי&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;share_internal_</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;❌ ביטול&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;cancel_share&quot;</span><span class="p">)</span>
                <span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;❌ ביטול&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;cancel_share&quot;</span><span class="p">)</span>
                <span class="p">])</span>
            <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;🌐 **שיתוף קובץ:** `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">`</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;🔤 שפה: </span><span class="si">{</span><span class="n">single</span><span class="p">[</span><span class="s1">&#39;programming_language&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;📏 גודל: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">single</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> תווים</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;בחר אופן שיתוף:&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># רישום מזהה ייחודי לרשימת הקבצים אצל המשתמש</span>
            <span class="n">share_id</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;multi_share&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;multi_share&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># נשמור מיפוי share_id -&gt; רשימת שמות קבצים</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;multi_share&#39;</span><span class="p">][</span><span class="n">share_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">found_files</span><span class="p">]</span>

            <span class="n">files_list_preview</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;• `</span><span class="si">{</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">` (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> תווים)&quot;</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">found_files</span><span class="p">[:</span><span class="mi">10</span><span class="p">]])</span>
            <span class="n">more</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">found_files</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">10</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">(ועוד </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">found_files</span><span class="p">)</span><span class="o">-</span><span class="mi">10</span><span class="si">}</span><span class="s2"> קבצים...)&quot;</span>

            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🐙 GitHub Gist (מרובה)&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;share_gist_multi:</span><span class="si">{</span><span class="n">share_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">PUBLIC_BASE_URL</span><span class="p">:</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📱 קישור פנימי (מרובה)&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;share_internal_multi:</span><span class="si">{</span><span class="n">share_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;❌ ביטול&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;cancel_share&quot;</span><span class="p">)</span>
                <span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;❌ ביטול&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;cancel_share&quot;</span><span class="p">)</span>
                <span class="p">])</span>
            <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>

            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;🌐 **שיתוף מספר קבצים (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">found_files</span><span class="p">)</span><span class="si">}</span><span class="s2">):**</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">files_list_preview</span><span class="si">}{</span><span class="n">more</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;בחר אופן שיתוף:&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="AdvancedBotHandlers.share_help_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.share_help_command">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">share_help_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;הסבר קצר על פקודת /share&quot;&quot;&quot;</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">PUBLIC_BASE_URL</span><span class="p">:</span>
            <span class="n">help_text</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;# 📤 פקודת /share – שיתוף קבצים בקלות</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;## מה זה עושה?</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;פקודת `/share` מאפשרת לך לשתף קבצים מהבוט באופן מהיר ונוח. הבוט יוצר עבורך קישורי שיתוף אוטומטיים לקבצים שאתה בוחר.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;## איך להשתמש?</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;### דוגמאות פשוטות:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- **קובץ יחיד:** `/share script.py`</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- **מספר קבצים:** `/share app.py utils.py README.md`</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- **עם כוכביות (wildcards):** `/share *.py` או `/share main.*`</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;### ⚠️ חשוב לזכור:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;שמות הקבצים הם **case sensitive** - כלומר, צריך להקפיד על אותיות קטנות וגדולות בדיוק כמו שהן מופיעות בשם הקובץ המקורי.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- **אם יש כמה קבצים עם אותו שם בבוט – ישותף האחרון שנשמר.**</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;## איזה סוגי קישורים אפשר לקבל?</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;### 🐙 GitHub Gist</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- **מתאים לכל סוג קובץ ומספר קבצים**</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- קישור יציב ואמין</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- כדי להשתמש יש להגדיר `GITHUB_TOKEN`</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;### 📋 Pastebin</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- **רק לקובץ יחיד (מרובה קבצים לא נתמך)**</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- מהיר ופשוט לשימוש</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- כדי להשתמש יש להגדיר `PASTEBIN_API_KEY`</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;### 📱 קישור פנימי</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- **זמין בסביבה זו**</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- קישור זמני (בתוקף כשבוע בערך)</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- עובד עם כל סוג וכמות קבצים</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">help_text</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;# 📤 פקודת /share – שיתוף קבצים בקלות</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;## מה זה עושה?</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;פקודת `/share` מאפשרת לך לשתף קבצים מהבוט באופן מהיר ונוח. הבוט יוצר עבורך קישורי שיתוף אוטומטיים לקבצים שאתה בוחר.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;## איך להשתמש?</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;### דוגמאות פשוטות:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- **קובץ יחיד:** `/share script.py`</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- **מספר קבצים:** `/share app.py utils.py README.md`</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- **עם כוכביות (wildcards):** `/share *.py` או `/share main.*`</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;### ⚠️ חשוב לזכור:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;שמות הקבצים הם **case sensitive** - כלומר, צריך להקפיד על אותיות קטנות וגדולות בדיוק כמו שהן מופיעות בשם הקובץ המקורי.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- **אם יש כמה קבצים עם אותו שם בבוט – ישותף האחרון שנשמר.**</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;## איזה סוגי קישורים אפשר לקבל?</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;### 🐙 GitHub Gist</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- **מתאים לכל סוג קובץ ומספר קבצים**</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- קישור יציב ואמין</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- כדי להשתמש יש להגדיר `GITHUB_TOKEN`</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;### 📋 Pastebin</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- **רק לקובץ יחיד (מרובה קבצים לא נתמך)**</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- מהיר ופשוט לשימוש</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- כדי להשתמש יש להגדיר `PASTEBIN_API_KEY`</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;(קישור פנימי אינו זמין בסביבה זו)</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">help_text</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="AdvancedBotHandlers.download_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.download_command">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">download_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;הורדת קובץ&quot;&quot;&quot;</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;📥 אנא ציין שם קובץ להורדה:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;דוגמה: `/download script.py`&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">file_data</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_data</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;❌ קובץ `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">` לא נמצא.&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># יצירת קובץ להורדה</span>
        <span class="n">file_content</span> <span class="o">=</span> <span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">file_obj</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">file_content</span><span class="p">)</span>
        <span class="n">file_obj</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">file_name</span>
        
        <span class="c1"># שליחת הקובץ</span>
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_document</span><span class="p">(</span>
            <span class="n">document</span><span class="o">=</span><span class="n">InputFile</span><span class="p">(</span><span class="n">file_obj</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">file_name</span><span class="p">),</span>
            <span class="n">caption</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;📥 **הורדת קובץ:** `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">`</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="sa">f</span><span class="s2">&quot;🔤 שפה: </span><span class="si">{</span><span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;programming_language&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="sa">f</span><span class="s2">&quot;📅 עודכן: </span><span class="si">{</span><span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;updated_at&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/%m/%Y %H:%M&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
        <span class="p">)</span></div>

    
<div class="viewcode-block" id="AdvancedBotHandlers.tags_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.tags_command">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">tags_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;הצגת כל התגיות של המשתמש&quot;&quot;&quot;</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        
        <span class="n">files</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user_files</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;🏷️ עדיין אין לך קבצים עם תגיות.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># איסוף כל התגיות</span>
        <span class="n">all_tags</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">file_data</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="k">if</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">all_tags</span><span class="p">:</span>
                    <span class="n">all_tags</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">all_tags</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">all_tags</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;🏷️ עדיין אין לך קבצים עם תגיות.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># מיון לפי תדירות</span>
        <span class="n">sorted_tags</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">all_tags</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="n">response</span> <span class="o">=</span> <span class="s2">&quot;🏷️ **התגיות שלך:**</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        
        <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">sorted_tags</span><span class="p">[:</span><span class="mi">20</span><span class="p">]:</span>  <span class="c1"># מקסימום 20 תגיות</span>
            <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;• `#</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">` (</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2"> קבצים)</span><span class="se">\n</span><span class="s2">&quot;</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_tags</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">📄 ועוד </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sorted_tags</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">20</span><span class="si">}</span><span class="s2"> תגיות...&quot;</span>
        
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="AdvancedBotHandlers.recent_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.recent_command">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">recent_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;הצגת הקבצים שעודכנו לאחרונה&quot;&quot;&quot;</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        
        <span class="c1"># כמה ימים אחורה לחפש</span>
        <span class="n">days_back</span> <span class="o">=</span> <span class="mi">7</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span> <span class="ow">and</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="n">days_back</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        
        <span class="c1"># חיפוש קבצים אחרונים</span>
        <span class="n">since_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">days_back</span><span class="p">)</span>
        
        <span class="n">files</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user_files</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
        <span class="n">recent_files</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> 
            <span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;updated_at&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">since_date</span>
        <span class="p">]</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">recent_files</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;📅 לא נמצאו קבצים שעודכנו ב-</span><span class="si">{</span><span class="n">days_back</span><span class="si">}</span><span class="s2"> הימים האחרונים.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">response</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;📅 &lt;b&gt;קבצים מ-</span><span class="si">{</span><span class="n">days_back</span><span class="si">}</span><span class="s2"> הימים האחרונים:&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        
        <span class="k">for</span> <span class="n">file_data</span> <span class="ow">in</span> <span class="n">recent_files</span><span class="p">[:</span><span class="mi">15</span><span class="p">]:</span>  <span class="c1"># מקסימום 15 קבצים</span>
            <span class="n">dt_now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="k">if</span> <span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;updated_at&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tzinfo</span> <span class="k">else</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="n">days_ago</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt_now</span> <span class="o">-</span> <span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;updated_at&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">days</span>
            <span class="n">time_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;היום&quot;</span> <span class="k">if</span> <span class="n">days_ago</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;לפני </span><span class="si">{</span><span class="n">days_ago</span><span class="si">}</span><span class="s2"> ימים&quot;</span>
            <span class="n">safe_name</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)))</span>
            <span class="n">safe_lang</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;programming_language&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)))</span>
            <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;📄 &lt;code&gt;</span><span class="si">{</span><span class="n">safe_name</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   🔤 </span><span class="si">{</span><span class="n">safe_lang</span><span class="si">}</span><span class="s2"> | 📅 </span><span class="si">{</span><span class="n">time_str</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">recent_files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;📄 ועוד </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">recent_files</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">15</span><span class="si">}</span><span class="s2"> קבצים...&quot;</span>
        
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdvancedBotHandlers.info_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.info_command">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">info_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;מידע מהיר על קובץ ללא פתיחה&quot;&quot;&quot;</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;ℹ️ אנא ציין שם קובץ:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;דוגמה: &lt;code&gt;/info script.py&lt;/code&gt;&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">file_data</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_data</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;❌ קובץ &lt;code&gt;</span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/code&gt; לא נמצא.&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">safe_name</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)))</span>
        <span class="n">safe_lang</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;programming_language&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)))</span>
        <span class="n">size_chars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">updated_at</span> <span class="o">=</span> <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;updated_at&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">updated_str</span> <span class="o">=</span> <span class="n">updated_at</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/%m/%Y %H:%M&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">updated_at</span> <span class="k">else</span> <span class="s1">&#39;-&#39;</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">updated_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">updated_at</span><span class="p">)</span> <span class="k">if</span> <span class="n">updated_at</span> <span class="k">else</span> <span class="s1">&#39;-&#39;</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">tags_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;#</span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">)</span> <span class="k">if</span> <span class="n">tags</span> <span class="k">else</span> <span class="s2">&quot;-&quot;</span>
        
        <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;ℹ️ &lt;b&gt;מידע על קובץ&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;📄 &lt;b&gt;שם:&lt;/b&gt; &lt;code&gt;</span><span class="si">{</span><span class="n">safe_name</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;🔤 &lt;b&gt;שפה:&lt;/b&gt; </span><span class="si">{</span><span class="n">safe_lang</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;📏 &lt;b&gt;גודל:&lt;/b&gt; </span><span class="si">{</span><span class="n">size_chars</span><span class="si">}</span><span class="s2"> תווים</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;📅 &lt;b&gt;עודכן:&lt;/b&gt; </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">updated_str</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;🏷️ &lt;b&gt;תגיות:&lt;/b&gt; </span><span class="si">{</span><span class="n">tags_str</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdvancedBotHandlers.search_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.search_command">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">search_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;חיפוש קטעי קוד לפי טקסט/שפה/תגיות — מימוש מינימלי ובטוח לסוגים&quot;&quot;&quot;</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="c1"># קלט בטוח — לא מניחים כלום על context.args</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;🔍 שימוש: /search &lt;query&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;דוגמאות:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;• /search python — סינון לפי שפה</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;• /search #utils — לפי תגית</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;• /search api — חיפוש חופשי בשם/בתוכן&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># פענוח מינימלי של פרמטרים ללא תלות במסד/שירותים</span>
        <span class="n">query_tokens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">languages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">token</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="k">elif</span> <span class="n">t</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;python&quot;</span><span class="p">,</span><span class="s2">&quot;javascript&quot;</span><span class="p">,</span><span class="s2">&quot;typescript&quot;</span><span class="p">,</span><span class="s2">&quot;java&quot;</span><span class="p">,</span><span class="s2">&quot;html&quot;</span><span class="p">,</span><span class="s2">&quot;css&quot;</span><span class="p">,</span><span class="s2">&quot;json&quot;</span><span class="p">,</span><span class="s2">&quot;yaml&quot;</span><span class="p">,</span><span class="s2">&quot;markdown&quot;</span><span class="p">,</span><span class="s2">&quot;bash&quot;</span><span class="p">,</span><span class="s2">&quot;text&quot;</span><span class="p">}:</span>
                <span class="n">languages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">query_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="c1"># תשובה מינימלית; ההיגיון המלא של חיפוש נמצא ב-main/handlers אחרים</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;🔍 חיפוש התחלתי (תצוגת הדגמה):</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">languages</span><span class="p">:</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;• שפות: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">languages</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tags</span><span class="p">:</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;• תגיות: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="o">+</span><span class="n">x</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">tags</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">query_tokens</span><span class="p">:</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;• טקסט: </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">query_tokens</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;🔍 חיפוש&quot;</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_is_admin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;בודק אם המשתמש הוא אדמין לפי ENV ADMIN_USER_IDS (או מודול permissions אם קיים).&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">_perm_is_admin</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">_perm_is_admin</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">user_id</span><span class="p">)))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;ADMIN_USER_IDS&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">raw</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()]</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ids</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="AdvancedBotHandlers.broadcast_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.broadcast_command">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">broadcast_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;שידור הודעה לכל המשתמשים עם הגבלת קצב, RetryAfter וסיכום תוצאות.&quot;&quot;&quot;</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_admin</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;❌ פקודה זמינה רק למנהלים&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># ההודעה לשידור</span>
        <span class="n">message_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">message_text</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;📢 שימוש: /broadcast &lt;message&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;שלח את ההודעה שתשודר לכל המשתמשים.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># שליפת נמענים מ-Mongo</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;db&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">db</span><span class="o">.</span><span class="n">db</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;users&#39;</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;❌ לא ניתן לטעון רשימת משתמשים מהמסד.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">coll</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">users</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="n">coll</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$exists&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span> <span class="s2">&quot;blocked&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$ne&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}},</span> <span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
            <span class="n">recipients</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">uid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">uid</span><span class="p">:</span>
                        <span class="n">recipients</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">continue</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;טעינת נמענים נכשלה: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;❌ שגיאה בטעינת רשימת נמענים&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">recipients</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;ℹ️ אין נמענים לשידור.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># תוכן בטוח ל-HTML</span>
        <span class="n">safe_text</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">message_text</span><span class="p">)</span>
        
        <span class="n">success_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">fail_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">removed_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">delay_seconds</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># ~10 הודעות בשנייה</span>

        <span class="k">for</span> <span class="n">rid</span> <span class="ow">in</span> <span class="n">recipients</span><span class="p">:</span>
            <span class="n">sent_ok</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">attempts</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">attempts</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">sent_ok</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">context</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">chat_id</span><span class="o">=</span><span class="n">rid</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">safe_text</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">)</span>
                    <span class="n">success_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">sent_ok</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">except</span> <span class="n">telegram</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">RetryAfter</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">attempts</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s1">&#39;retry_after&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
                    <span class="c1"># ננסה שוב בלולאה</span>
                <span class="k">except</span> <span class="n">telegram</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">Forbidden</span><span class="p">:</span>
                    <span class="n">fail_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">removed_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rid</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">except</span> <span class="n">telegram</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">BadRequest</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">fail_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="s1">&#39;chat not found&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;not found&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                        <span class="n">removed_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rid</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;שידור לנמען </span><span class="si">{</span><span class="n">rid</span><span class="si">}</span><span class="s2"> נכשל: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">fail_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">sent_ok</span> <span class="ow">and</span> <span class="n">attempts</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">fail_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay_seconds</span><span class="p">)</span>
        
        <span class="n">removed_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">removed_ids</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">coll</span><span class="o">.</span><span class="n">update_many</span><span class="p">({</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="p">:</span> <span class="n">removed_ids</span><span class="p">}},</span> <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;blocked&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}})</span>
                <span class="n">removed_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">removed_ids</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        
        <span class="n">summary</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;📢 סיכום שידור</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;👥 נמענים: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">recipients</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;✅ הצלחות: </span><span class="si">{</span><span class="n">success_count</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;❌ כשלים: </span><span class="si">{</span><span class="n">fail_count</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;🧹 סומנו כחסומים/לא זמינים: </span><span class="si">{</span><span class="n">removed_count</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="AdvancedBotHandlers.handle_callback_query">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.handle_callback_query">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">handle_callback_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;טיפול בלחיצות על כפתורים&quot;&quot;&quot;</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>
        
        <span class="n">data</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">user_obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s1">&#39;from_user&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s1">&#39;effective_user&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">user_obj</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;confirm_delete_&quot;</span><span class="p">):</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;confirm_delete_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">delete_file</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;✅ הקובץ `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">` נמחק בהצלחה!&quot;</span><span class="p">,</span>
                        <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ שגיאה במחיקת הקובץ.&quot;</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;cancel_delete&quot;</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ מחיקה בוטלה.&quot;</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;cancel_share&quot;</span><span class="p">:</span>
                <span class="c1"># ביטול תיבת השיתוף (יחיד/מרובה)</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ השיתוף בוטל.&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># ניקוי הקשר מרובה אם נשמר</span>
                    <span class="n">ms</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;multi_share&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ms</span><span class="p">:</span>
                        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;multi_share&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            
            <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;highlight_&quot;</span><span class="p">):</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;highlight_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_highlighted_code</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;share_gist_multi:&quot;</span><span class="p">):</span>
                <span class="n">share_id</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_share_to_gist_multi</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">share_id</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;share_gist_&quot;</span><span class="p">):</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;share_gist_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_share_to_gist</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;share_pastebin_&quot;</span><span class="p">):</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;share_pastebin_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_share_to_pastebin</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;share_internal_&quot;</span><span class="p">):</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;share_internal_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_share_internal</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>

            <span class="c1"># הסרנו noop/‏share_noop — אין צורך עוד</span>

            <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;share_internal_multi:&quot;</span><span class="p">):</span>
                <span class="n">share_id</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_share_internal_multi</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">share_id</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;download_&quot;</span><span class="p">):</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;download_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_file_download</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
            
            <span class="c1"># ועוד callback handlers...</span>

            <span class="c1"># --- Favorites callbacks ---</span>
            <span class="k">elif</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;favorites_list&quot;</span><span class="p">:</span>
                <span class="n">favs</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_favorites</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">favs</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;💭 אין לך מועדפים כרגע.&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">get_language_emoji</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;⭐ &lt;b&gt;המועדפים שלך&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">fav</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">favs</span><span class="p">[:</span><span class="mi">10</span><span class="p">],</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">fname</span> <span class="o">=</span> <span class="n">fav</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">lang</span> <span class="o">=</span> <span class="n">fav</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;programming_language&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">get_language_emoji</span><span class="p">(</span><span class="n">lang</span><span class="p">)</span><span class="si">}</span><span class="s2"> &lt;code&gt;</span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">favs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">➕ ועוד </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">favs</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">10</span><span class="si">}</span><span class="s2"> קבצים...&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;export_favorites&quot;</span><span class="p">:</span>
                <span class="n">favs</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_favorites</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
                <span class="n">export_data</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;exported_at&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                    <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
                    <span class="s2">&quot;total_favorites&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">favs</span><span class="p">),</span>
                    <span class="s2">&quot;favorites&quot;</span><span class="p">:</span> <span class="n">favs</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">raw</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">export_data</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">bio</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">raw</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
                <span class="n">bio</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;favorites.json&quot;</span>
                <span class="c1"># שליחה עם BytesIO כפרמטר ראשון כדי לאפשר לטסטים לחלץ את התוכן</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_document</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;favorites.json&quot;</span><span class="p">,</span> <span class="n">caption</span><span class="o">=</span><span class="s2">&quot;📥 ייצוא מועדפים (JSON)&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;✅ קובץ ייצוא נשלח&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;favorites_stats&quot;</span><span class="p">:</span>
                <span class="n">favs</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_favorites</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">favs</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;💭 אין סטטיסטיקות - אין מועדפים&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="n">langs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">all_tags</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">favs</span><span class="p">:</span>
                    <span class="n">lang</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;programming_language&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
                    <span class="n">langs</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span> <span class="o">=</span> <span class="n">langs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]):</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                                <span class="n">all_tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="n">popular_lang</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">langs</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="n">langs</span> <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;אין&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
                <span class="n">top_tags</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">all_tags</span><span class="p">)</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;📊 &lt;b&gt;סטטיסטיקות מועדפים&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;⭐ סך המועדפים: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">favs</span><span class="p">)</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;🔤 שפה פופולרית:</span><span class="se">\n</span><span class="s2">   </span><span class="si">{</span><span class="n">popular_lang</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">popular_lang</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">top_tags</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">🏷️ תגיות פופולריות:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;   #</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">top_tags</span><span class="p">])</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;fav_toggle_id:&quot;</span><span class="p">):</span>
                <span class="n">fid</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">doc</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_file_by_id</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">doc</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">doc</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;⚠️ הקובץ לא נמצא&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">)</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">toggle_favorite</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;⭐ נוסף למועדפים!&quot;</span> <span class="k">if</span> <span class="n">state</span> <span class="k">else</span> <span class="s2">&quot;💔 הוסר מהמועדפים&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="c1"># אם אנחנו במסך בקרה/פעולות, הצג הודעת סטטוס מעל הכפתורים ושמור את המקלדת</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># שלוף פרטים להצגה</span>
                    <span class="n">latest</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
                    <span class="n">lang</span> <span class="o">=</span> <span class="n">latest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;programming_language&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;text&#39;</span>
                    <span class="n">note</span> <span class="o">=</span> <span class="n">latest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;—&#39;</span>
                    <span class="n">notice</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;⭐️ הקוד נשמר במועדפים&quot;</span> <span class="k">if</span> <span class="n">state</span> <span class="k">else</span> <span class="s2">&quot;💔 הקוד הוסר מהמועדפים&quot;</span><span class="p">)</span>
                    <span class="kn">from</span> <span class="nn">html</span> <span class="kn">import</span> <span class="n">escape</span> <span class="k">as</span> <span class="n">_e</span>
                    <span class="n">new_text</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">notice</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;📄 קובץ: &lt;code&gt;</span><span class="si">{</span><span class="n">_e</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;🧠 שפה: </span><span class="si">{</span><span class="n">_e</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">lang</span><span class="p">))</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;📝 הערה: </span><span class="si">{</span><span class="n">_e</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">note</span><span class="p">))</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;🎮 בחר פעולה מתקדמת:&quot;</span>
                    <span class="p">)</span>
                    <span class="c1"># בנה מקלדת מעודכנת עם תווית כפתור מועדפים הנכונה</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">is_fav_now</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">is_favorite</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">fname</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">is_fav_now</span> <span class="o">=</span> <span class="n">state</span>
                    <span class="n">fav_label</span> <span class="o">=</span> <span class="s2">&quot;💔 הסר ממועדפים&quot;</span> <span class="k">if</span> <span class="n">is_fav_now</span> <span class="k">else</span> <span class="s2">&quot;⭐ הוסף למועדפים&quot;</span>
                    <span class="c1"># נעדיף שימוש ב-id אם זמין</span>
                    <span class="n">fav_cb</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;fav_toggle_id:</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">fid</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;fav_toggle_tok:</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="kn">from</span> <span class="nn">telegram</span> <span class="kn">import</span> <span class="n">InlineKeyboardButton</span> <span class="k">as</span> <span class="n">_IKB</span><span class="p">,</span> <span class="n">InlineKeyboardMarkup</span> <span class="k">as</span> <span class="n">_IKM</span>
                    <span class="n">updated_kb</span> <span class="o">=</span> <span class="n">_IKM</span><span class="p">([[</span> <span class="n">_IKB</span><span class="p">(</span><span class="n">fav_label</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="n">fav_cb</span><span class="p">)</span> <span class="p">]])</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">new_text</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">updated_kb</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;fav_toggle_tok:&quot;</span><span class="p">):</span>
                <span class="n">token</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fname</span> <span class="o">=</span> <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fav_tokens&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">fname</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">fname</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;⚠️ לא נמצא קובץ לפעולה&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">toggle_favorite</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;⭐ נוסף למועדפים!&quot;</span> <span class="k">if</span> <span class="n">state</span> <span class="k">else</span> <span class="s2">&quot;💔 הוסר מהמועדפים&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">latest</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
                    <span class="n">lang</span> <span class="o">=</span> <span class="n">latest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;programming_language&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;text&#39;</span>
                    <span class="n">note</span> <span class="o">=</span> <span class="n">latest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;—&#39;</span>
                    <span class="n">notice</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;⭐️ הקוד נשמר במועדפים&quot;</span> <span class="k">if</span> <span class="n">state</span> <span class="k">else</span> <span class="s2">&quot;💔 הקוד הוסר מהמועדפים&quot;</span><span class="p">)</span>
                    <span class="kn">from</span> <span class="nn">html</span> <span class="kn">import</span> <span class="n">escape</span> <span class="k">as</span> <span class="n">_e</span>
                    <span class="n">new_text</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">notice</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;📄 קובץ: &lt;code&gt;</span><span class="si">{</span><span class="n">_e</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;🧠 שפה: </span><span class="si">{</span><span class="n">_e</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">lang</span><span class="p">))</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;📝 הערה: </span><span class="si">{</span><span class="n">_e</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">note</span><span class="p">))</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;🎮 בחר פעולה מתקדמת:&quot;</span>
                    <span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">is_fav_now</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">is_favorite</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">fname</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">is_fav_now</span> <span class="o">=</span> <span class="n">state</span>
                    <span class="n">fav_label</span> <span class="o">=</span> <span class="s2">&quot;💔 הסר ממועדפים&quot;</span> <span class="k">if</span> <span class="n">is_fav_now</span> <span class="k">else</span> <span class="s2">&quot;⭐ הוסף למועדפים&quot;</span>
                    <span class="n">fav_cb</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;fav_toggle_tok:</span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="kn">from</span> <span class="nn">telegram</span> <span class="kn">import</span> <span class="n">InlineKeyboardButton</span> <span class="k">as</span> <span class="n">_IKB</span><span class="p">,</span> <span class="n">InlineKeyboardMarkup</span> <span class="k">as</span> <span class="n">_IKM</span>
                    <span class="n">updated_kb</span> <span class="o">=</span> <span class="n">_IKM</span><span class="p">([[</span> <span class="n">_IKB</span><span class="p">(</span><span class="n">fav_label</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="n">fav_cb</span><span class="p">)</span> <span class="p">]])</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">new_text</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">updated_kb</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;שגיאה ב-callback: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ אירעה שגיאה. נסה שוב.&quot;</span><span class="p">)</span></div>

    
    <span class="k">async</span> <span class="k">def</span> <span class="nf">_send_highlighted_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;שליחת קוד עם הדגשת תחביר&quot;&quot;&quot;</span>
        <span class="n">file_data</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_data</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ קובץ `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">` לא נמצא.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># יצירת קוד מודגש</span>
        <span class="n">highlighted</span> <span class="o">=</span> <span class="n">code_processor</span><span class="o">.</span><span class="n">highlight_code</span><span class="p">(</span>
            <span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">],</span> 
            <span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;programming_language&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        
        <span class="c1"># שליחה כקובץ HTML אם הקוד ארוך</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">:</span>
            <span class="n">html_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            &lt;!DOCTYPE html&gt;</span>
<span class="s2">            &lt;html&gt;</span>
<span class="s2">            &lt;head&gt;</span>
<span class="s2">                &lt;meta charset=&quot;utf-8&quot;&gt;</span>
<span class="s2">                &lt;title&gt;</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&lt;/title&gt;</span>
<span class="s2">                &lt;style&gt;body </span><span class="se">{{</span><span class="s2"> font-family: monospace; </span><span class="se">}}</span><span class="s2">&lt;/style&gt;</span>
<span class="s2">            &lt;/head&gt;</span>
<span class="s2">            &lt;body&gt;</span>
<span class="s2">                </span><span class="si">{</span><span class="n">highlighted</span><span class="si">}</span>
<span class="s2">            &lt;/body&gt;</span>
<span class="s2">            &lt;/html&gt;</span>
<span class="s2">            &quot;&quot;&quot;</span>
            
            <span class="n">html_file</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">html_content</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
            <span class="n">html_file</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">.html&quot;</span>
            
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_document</span><span class="p">(</span>
                <span class="n">document</span><span class="o">=</span><span class="n">InputFile</span><span class="p">(</span><span class="n">html_file</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">.html&quot;</span><span class="p">),</span>
                <span class="n">caption</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;🎨 קוד מודגש עבור `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">`&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># שליחה כהודעה</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;🎨 **קוד מודגש עבור:** `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">`</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;```</span><span class="si">{</span><span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;programming_language&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">```&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
            <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_send_long_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg_target</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">parse_mode</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">reply_markup</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">InlineKeyboardMarkup</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;שליחת טקסט ארוך במספר הודעות, מפוצל לפי אורך בטוח לטלגרם.</span>

<span class="sd">        מגבלת אורך הודעת טלגרם היא סביב 4096 תווים. נשתמש במרווח בטחון.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">MAX_LEN</span> <span class="o">=</span> <span class="mi">3500</span>
            <span class="n">remaining</span> <span class="o">=</span> <span class="n">text</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">remaining</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">MAX_LEN</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">msg_target</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">remaining</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">parse_mode</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="c1"># פיצול לפי שורות כדי לשמור על פירוק טבעי</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">(</span><span class="n">remaining</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">remaining</span> <span class="k">else</span> <span class="p">[])</span>
            <span class="n">buf</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">curr</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="c1"># +1 עבור ה&quot;\n&quot; שיתווסף בהמשך</span>
                <span class="n">line_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">buf</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">curr</span> <span class="o">+</span> <span class="n">line_len</span> <span class="o">&gt;</span> <span class="n">MAX_LEN</span><span class="p">:</span>
                    <span class="n">chunk</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
                    <span class="k">await</span> <span class="n">msg_target</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">parse_mode</span><span class="p">)</span>
                    <span class="n">buf</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="p">]</span>
                    <span class="n">curr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="n">curr</span> <span class="o">+=</span> <span class="n">line_len</span>
            <span class="k">if</span> <span class="n">buf</span><span class="p">:</span>
                <span class="n">chunk</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">msg_target</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">parse_mode</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># במקרה חריג, שלח את הכל בהודעה אחת (עלול לחרוג אם ארוך מדי)</span>
            <span class="k">await</span> <span class="n">msg_target</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">text</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">parse_mode</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span><span class="p">)</span>
    
    <span class="k">async</span> <span class="k">def</span> <span class="nf">_share_to_gist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;שיתוף ב-GitHub Gist&quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">GITHUB_TOKEN</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="s2">&quot;❌ שיתוף ב-Gist לא זמין - לא הוגדר טוקן GitHub.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">file_data</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_data</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ קובץ `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">` לא נמצא.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">integrations</span> <span class="kn">import</span> <span class="n">code_sharing</span>
            <span class="n">description</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;שיתוף אוטומטי דרך CodeBot — </span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">code_sharing</span><span class="o">.</span><span class="n">share_code</span><span class="p">(</span>
                <span class="n">service</span><span class="o">=</span><span class="s2">&quot;gist&quot;</span><span class="p">,</span>
                <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span>
                <span class="n">code</span><span class="o">=</span><span class="n">file_data</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">],</span>
                <span class="n">language</span><span class="o">=</span><span class="n">file_data</span><span class="p">[</span><span class="s2">&quot;programming_language&quot;</span><span class="p">],</span>
                <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
                <span class="n">public</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ יצירת Gist נכשלה. ודא שטוקן GitHub תקין והרשאות מתאימות.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;🐙 **שותף ב-GitHub Gist!**</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;📄 קובץ: `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">`</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;🔗 קישור: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
            <span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;שגיאה בשיתוף Gist: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ שגיאה בשיתוף. נסה שוב מאוחר יותר.&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_share_to_pastebin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;שיתוף ב-Pastebin&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">integrations</span> <span class="kn">import</span> <span class="n">code_sharing</span>
        <span class="n">file_data</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_data</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ קובץ `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">` לא נמצא.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">code_sharing</span><span class="o">.</span><span class="n">share_code</span><span class="p">(</span>
                <span class="n">service</span><span class="o">=</span><span class="s2">&quot;pastebin&quot;</span><span class="p">,</span>
                <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span>
                <span class="n">code</span><span class="o">=</span><span class="n">file_data</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">],</span>
                <span class="n">language</span><span class="o">=</span><span class="n">file_data</span><span class="p">[</span><span class="s2">&quot;programming_language&quot;</span><span class="p">],</span>
                <span class="n">private</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">expire</span><span class="o">=</span><span class="s2">&quot;1M&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ יצירת Pastebin נכשלה. בדוק מפתח API.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;📋 **שותף ב-Pastebin!**</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;📄 קובץ: `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">`</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;🔗 קישור: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;שגיאה בשיתוף Pastebin: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ שגיאה בשיתוף. נסה שוב מאוחר יותר.&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_share_internal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;יצירת קישור שיתוף פנימי&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">integrations</span> <span class="kn">import</span> <span class="n">code_sharing</span>
        <span class="n">file_data</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_data</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ קובץ `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">` לא נמצא.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">code_sharing</span><span class="o">.</span><span class="n">share_code</span><span class="p">(</span>
                <span class="n">service</span><span class="o">=</span><span class="s2">&quot;internal&quot;</span><span class="p">,</span>
                <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span>
                <span class="n">code</span><span class="o">=</span><span class="n">file_data</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">],</span>
                <span class="n">language</span><span class="o">=</span><span class="n">file_data</span><span class="p">[</span><span class="s2">&quot;programming_language&quot;</span><span class="p">],</span>
                <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;שיתוף פנימי של </span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ יצירת קישור פנימי נכשלה.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">PUBLIC_BASE_URL</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                    <span class="s2">&quot;ℹ️ קישור פנימי אינו זמין כרגע (לא הוגדר PUBLIC_BASE_URL).</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;באפשרותך להשתמש ב-Gist/Pastebin במקום.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="c1"># ניסוח תוקף קריא</span>
            <span class="n">expires_iso</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;expires_at&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">expiry_line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;⏳ תוקף: </span><span class="si">{</span><span class="n">expires_iso</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">expires_iso</span><span class="p">)</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">tzinfo</span><span class="p">)</span> <span class="k">if</span> <span class="n">dt</span><span class="o">.</span><span class="n">tzinfo</span> <span class="k">else</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                <span class="n">delta</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">-</span> <span class="n">now</span>
                <span class="n">total_seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">total_seconds</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">days</span> <span class="o">=</span> <span class="n">total_seconds</span> <span class="o">//</span> <span class="mi">86400</span>
                    <span class="n">hours</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_seconds</span> <span class="o">%</span> <span class="mi">86400</span><span class="p">)</span> <span class="o">//</span> <span class="mi">3600</span>
                    <span class="k">if</span> <span class="n">days</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">rel</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;בעוד ~</span><span class="si">{</span><span class="n">days</span><span class="si">}</span><span class="s2"> ימים&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot; ו-</span><span class="si">{</span><span class="n">hours</span><span class="si">}</span><span class="s2"> שעות&quot;</span> <span class="k">if</span> <span class="n">hours</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">hours</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">rel</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;בעוד ~</span><span class="si">{</span><span class="n">hours</span><span class="si">}</span><span class="s2"> שעות&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">minutes</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_seconds</span> <span class="o">%</span> <span class="mi">3600</span><span class="p">)</span> <span class="o">//</span> <span class="mi">60</span>
                        <span class="n">rel</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;בעוד ~</span><span class="si">{</span><span class="n">minutes</span><span class="si">}</span><span class="s2"> דקות&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rel</span> <span class="o">=</span> <span class="s2">&quot;פג&quot;</span>
                <span class="n">date_str</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/%m/%Y %H:%M&quot;</span><span class="p">)</span>
                <span class="n">expiry_line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;⏳ תוקף: </span><span class="si">{</span><span class="n">date_str</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">rel</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">safe_file</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
            <span class="n">safe_url</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">])</span>
            <span class="n">safe_expiry</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">expiry_line</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;📱 &lt;b&gt;נוצר קישור פנימי!&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;📄 קובץ: &lt;code&gt;</span><span class="si">{</span><span class="n">safe_file</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;🔗 קישור: &lt;a href=</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">safe_url</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&gt;</span><span class="si">{</span><span class="n">safe_url</span><span class="si">}</span><span class="s2">&lt;/a&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">safe_expiry</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;שגיאה ביצירת קישור פנימי: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ שגיאה בשיתוף. נסה שוב מאוחר יותר.&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_share_to_gist_multi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">share_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;שיתוף מספר קבצים לגיסט אחד&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">integrations</span> <span class="kn">import</span> <span class="n">gist_integration</span>
        <span class="n">files_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;multi_share&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">share_id</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">names</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ לא נמצאה רשימת קבצים עבור השיתוף.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">files_map</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">files_map</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ לא נמצאו קבצים פעילים לשיתוף.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">GITHUB_TOKEN</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ שיתוף ב-Gist לא זמין - אין GITHUB_TOKEN.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">description</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;שיתוף מרובה קבצים (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">files_map</span><span class="p">)</span><span class="si">}</span><span class="s2">) דרך </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">BOT_LABEL</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">gist_integration</span><span class="o">.</span><span class="n">create_gist_multi</span><span class="p">(</span><span class="n">files_map</span><span class="o">=</span><span class="n">files_map</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span> <span class="n">public</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ יצירת Gist מרובה קבצים נכשלה.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;🐙 **שותף ב-GitHub Gist (מרובה קבצים)!**</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;📄 קבצים: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">files_map</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;🔗 קישור: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;שגיאה בשיתוף גיסט מרובה: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ שגיאה בשיתוף. נסה שוב מאוחר יותר.&quot;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;multi_share&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">share_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_share_internal_multi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">share_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;יצירת קישור פנימי למספר קבצים — מאחד לקובץ טקסט אחד&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">integrations</span> <span class="kn">import</span> <span class="n">code_sharing</span>
        <span class="n">names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;multi_share&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">share_id</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">names</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ לא נמצאה רשימת קבצים עבור השיתוף.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># נאחד לקובץ טקסט אחד קצר עם מפרידים</span>
        <span class="n">bundle_parts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lang_hint</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">lang_hint</span> <span class="o">=</span> <span class="n">lang_hint</span> <span class="ow">or</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;programming_language&#39;</span><span class="p">]</span>
                <span class="n">bundle_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;// ==== </span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> ====</span><span class="se">\n</span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bundle_parts</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ לא נמצאו קבצים לשיתוף פנימי.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">combined_code</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bundle_parts</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">code_sharing</span><span class="o">.</span><span class="n">share_code</span><span class="p">(</span>
                <span class="n">service</span><span class="o">=</span><span class="s2">&quot;internal&quot;</span><span class="p">,</span>
                <span class="n">file_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;bundle-</span><span class="si">{</span><span class="n">share_id</span><span class="si">}</span><span class="s2">.txt&quot;</span><span class="p">,</span>
                <span class="n">code</span><span class="o">=</span><span class="n">combined_code</span><span class="p">,</span>
                <span class="n">language</span><span class="o">=</span><span class="n">lang_hint</span> <span class="ow">or</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;שיתוף פנימי מרובה קבצים (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ יצירת קישור פנימי נכשלה.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">PUBLIC_BASE_URL</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                    <span class="s2">&quot;ℹ️ קישור פנימי אינו זמין כרגע (לא הוגדר PUBLIC_BASE_URL).</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;באפשרותך להשתמש ב-Gist במרובה קבצים.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="c1"># ניסוח תוקף קריא</span>
            <span class="n">expires_iso</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;expires_at&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">expiry_line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;⏳ תוקף: </span><span class="si">{</span><span class="n">expires_iso</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">expires_iso</span><span class="p">)</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">tzinfo</span><span class="p">)</span> <span class="k">if</span> <span class="n">dt</span><span class="o">.</span><span class="n">tzinfo</span> <span class="k">else</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                <span class="n">delta</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">-</span> <span class="n">now</span>
                <span class="n">total_seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">total_seconds</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">days</span> <span class="o">=</span> <span class="n">total_seconds</span> <span class="o">//</span> <span class="mi">86400</span>
                    <span class="n">hours</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_seconds</span> <span class="o">%</span> <span class="mi">86400</span><span class="p">)</span> <span class="o">//</span> <span class="mi">3600</span>
                    <span class="k">if</span> <span class="n">days</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">rel</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;בעוד ~</span><span class="si">{</span><span class="n">days</span><span class="si">}</span><span class="s2"> ימים&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot; ו-</span><span class="si">{</span><span class="n">hours</span><span class="si">}</span><span class="s2"> שעות&quot;</span> <span class="k">if</span> <span class="n">hours</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">hours</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">rel</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;בעוד ~</span><span class="si">{</span><span class="n">hours</span><span class="si">}</span><span class="s2"> שעות&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">minutes</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_seconds</span> <span class="o">%</span> <span class="mi">3600</span><span class="p">)</span> <span class="o">//</span> <span class="mi">60</span>
                        <span class="n">rel</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;בעוד ~</span><span class="si">{</span><span class="n">minutes</span><span class="si">}</span><span class="s2"> דקות&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rel</span> <span class="o">=</span> <span class="s2">&quot;פג&quot;</span>
                <span class="n">date_str</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/%m/%Y %H:%M&quot;</span><span class="p">)</span>
                <span class="n">expiry_line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;⏳ תוקף: </span><span class="si">{</span><span class="n">date_str</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">rel</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">safe_url</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">])</span>
            <span class="n">safe_expiry</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">expiry_line</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;📱 &lt;b&gt;נוצר קישור פנימי (מרובה קבצים)!&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;📄 קבצים: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;🔗 קישור: &lt;a href=</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">safe_url</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&gt;</span><span class="si">{</span><span class="n">safe_url</span><span class="si">}</span><span class="s2">&lt;/a&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">safe_expiry</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;שגיאה בקישור פנימי מרובה: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ שגיאה בשיתוף. נסה שוב מאוחר יותר.&quot;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;multi_share&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">share_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_send_file_download</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">file_data</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_data</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ קובץ `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">` לא נמצא.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_document</span><span class="p">(</span><span class="n">document</span><span class="o">=</span><span class="n">InputFile</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)),</span> <span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span></div>


<span class="c1"># פקודות נוספות ייוצרו בהמשך...</span>


<div class="viewcode-block" id="check_db_connection">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.check_db_connection">[תיעוד]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">check_db_connection</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;בדיקת חיבור אמיתית ל-MongoDB באמצעות פקודת ping.</span>

<span class="sd">    לוגיקה:</span>
<span class="sd">    - טוען URI מה-ENV (MONGODB_URL/REPORTER_MONGODB_URL/REPORTER_MONGODB_URI)</span>
<span class="sd">    - מנסה תחילה Motor (אסינכרוני) עם await</span>
<span class="sd">    - נפילה ל-PyMongo (סינכרוני) אם Motor לא זמין</span>
<span class="sd">    - מחזיר True רק אם ping הצליח בפועל</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">mongodb_uri</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;REPORTER_MONGODB_URL&#39;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;REPORTER_MONGODB_URI&#39;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;MONGODB_URL&#39;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mongodb_uri</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;MongoDB URI missing (MONGODB_URL not configured)&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Motor (עדיף אסינכרוני)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">motor.motor_asyncio</span> <span class="k">as</span> <span class="nn">_motor</span>  <span class="c1"># type: ignore</span>
            <span class="n">client</span> <span class="o">=</span> <span class="n">_motor</span><span class="o">.</span><span class="n">AsyncIOMotorClient</span><span class="p">(</span><span class="n">mongodb_uri</span><span class="p">,</span> <span class="n">serverSelectionTimeoutMS</span><span class="o">=</span><span class="mi">3000</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">admin</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;ping&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">motor_err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Motor ping failed; falling back to PyMongo: </span><span class="si">{</span><span class="n">motor_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># PyMongo (סינכרוני)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">pymongo</span> <span class="kn">import</span> <span class="n">MongoClient</span>  <span class="c1"># type: ignore</span>
            <span class="n">client2</span> <span class="o">=</span> <span class="n">MongoClient</span><span class="p">(</span><span class="n">mongodb_uri</span><span class="p">,</span> <span class="n">serverSelectionTimeoutMS</span><span class="o">=</span><span class="mi">3000</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">client2</span><span class="o">.</span><span class="n">admin</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;ping&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">client2</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">pym_err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PyMongo ping failed: </span><span class="si">{</span><span class="n">pym_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error during DB check: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Development Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>