

<!DOCTYPE html>
<html class="writer-html5" lang="he" data-content_root="../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>bot_handlers &mdash; ×ª×™×¢×•×“ Code Keeper Bot 1.0.0</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=2d7a82d5" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=0062297a"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/translations.js?v=a336edf7"></script>
      <script type="module" src="https://cdn.jsdelivr.net/npm/mermaid@11.12.1/dist/mermaid.esm.min.mjs"></script>
      <script type="module" src="https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.2.0/dist/mermaid-layout-elk.esm.min.mjs"></script>
      <script type="module">import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.12.1/dist/mermaid.esm.min.mjs";import elkLayouts from "https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.2.0/dist/mermaid-layout-elk.esm.min.mjs";mermaid.registerLayoutLoaders(elkLayouts);mermaid.initialize({startOnLoad:false});</script>
      <script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>
      <script type="module">import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.12.1/dist/mermaid.esm.min.mjs";

const defaultStyle = document.createElement('style');
defaultStyle.textContent = `pre.mermaid {
    /* Same as .mermaid-container > pre */
    display: block;
    width: 100%;
}

pre.mermaid > svg {
    /* Same as .mermaid-container > pre > svg */
    height: 500px;
    width: 100%;
    max-width: 100% !important;
}
`;
document.head.appendChild(defaultStyle);

const fullscreenStyle = document.createElement('style');
fullscreenStyle.textContent = `.mermaid-container {
    display: flex;
    flex-direction: row;
    width: 100%;
}

.mermaid-container > pre {
    display: block;
    width: 100%;
}

.mermaid-container > pre > svg {
    height: 500px;
    width: 100%;
    max-width: 100% !important;
}

.mermaid-fullscreen-btn {
    width: 28px;
    height: 28px;
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(0, 0, 0, 0.3);
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    font-size: 14px;
    line-height: 1;
    padding: 0;
    color: #333;
}

.mermaid-fullscreen-btn:hover {
    opacity: 100% !important;
    background: rgba(255, 255, 255, 1);
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
    transform: scale(1.1);
}

.mermaid-fullscreen-btn.dark-theme {
    background: rgba(50, 50, 50, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: #e0e0e0;
}

.mermaid-fullscreen-btn.dark-theme:hover {
    background: rgba(60, 60, 60, 1);
    box-shadow: 0 3px 10px rgba(255, 255, 255, 0.2);
}

.mermaid-fullscreen-modal {
    display: none;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 95vw;
    height: 100vh;
    background: rgba(255, 255, 255, 0.98);
    z-index: 9999;
    padding: 20px;
    overflow: auto;
}

.mermaid-fullscreen-modal.dark-theme {
    background: rgba(0, 0, 0, 0.98);
}

.mermaid-fullscreen-modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
}

.mermaid-container-fullscreen {
    position: relative;
    width: 95vw;
    height: 90vh;
    max-width: 95vw;
    max-height: 90vh;
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    overflow: auto;
    display: flex;
    align-items: center;
    justify-content: center;
}

.mermaid-container-fullscreen.dark-theme {
    background: #1a1a1a;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
}

.mermaid-container-fullscreen pre.mermaid {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.mermaid-container-fullscreen .mermaid svg {
    height: 100% !important;
    width: 100% !important;
    cursor: grab;
}

.mermaid-fullscreen-close {
    position: fixed !important;
    top: 20px !important;
    right: 20px !important;
    width: 40px;
    height: 40px;
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(0, 0, 0, 0.2);
    border-radius: 50%;
    cursor: pointer;
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    transition: all 0.2s;
    font-size: 24px;
    line-height: 1;
    color: #333;
}

.mermaid-fullscreen-close:hover {
    background: white;
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
    transform: scale(1.1);
}

.mermaid-fullscreen-close.dark-theme {
    background: rgba(50, 50, 50, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: #e0e0e0;
}

.mermaid-fullscreen-close.dark-theme:hover {
    background: rgba(60, 60, 60, 1);
    box-shadow: 0 6px 16px rgba(255, 255, 255, 0.2);
}

.mermaid-fullscreen-modal .mermaid-fullscreen-btn {
    display: none !important;
}`;
document.head.appendChild(fullscreenStyle);

// Detect if page has dark background
const isDarkTheme = () => {
    const bgColor = window.getComputedStyle(document.body).backgroundColor;
    const match = bgColor.match(/rgb\((\d+),\s*(\d+),\s*(\d+)/);
    if (match) {
        const r = parseInt(match[1]);
        const g = parseInt(match[2]);
        const b = parseInt(match[3]);
        const brightness = (r * 299 + g * 587 + b * 114) / 1000;
        return brightness < 128;
    }
    return false;
};

const load = async () => {
    await mermaid.run();

    const all_mermaids = document.querySelectorAll(".mermaid");
    const mermaids_processed = document.querySelectorAll(".mermaid[data-processed='true']");

    if ("False" === "True") {
        const mermaids_to_add_zoom = -1 === -1 ? all_mermaids.length : -1;
        if(mermaids_to_add_zoom > 0) {
            var svgs = d3.selectAll("");
            if(all_mermaids.length !== mermaids_processed.length) {
                setTimeout(load, 200);
                return;
            } else if(svgs.size() !== mermaids_to_add_zoom) {
                setTimeout(load, 200);
                return;
            } else {
                svgs.each(function() {
                    var svg = d3.select(this);
                    svg.html("<g class='wrapper'>" + svg.html() + "</g>");
                    var inner = svg.select("g");
                    var zoom = d3.zoom().on("zoom", function(event) {
                        inner.attr("transform", event.transform);
                    });
                    svg.call(zoom);
                });
            }
        }
    } else if(all_mermaids.length !== mermaids_processed.length) {
        // Wait for mermaid to process all diagrams
        setTimeout(load, 200);
        return;
    }

    const darkTheme = isDarkTheme();

    // Stop here if not adding fullscreen capability
    if ("True" !== "True") return;

    const modal = document.createElement('div');
    modal.className = 'mermaid-fullscreen-modal' + (darkTheme ? ' dark-theme' : '');
    modal.setAttribute('role', 'dialog');
    modal.setAttribute('aria-modal', 'true');
    modal.setAttribute('aria-label', 'Fullscreen diagram viewer');
    modal.innerHTML = `
        <button class="mermaid-fullscreen-close${darkTheme ? ' dark-theme' : ''}" aria-label="Close fullscreen">âœ•</button>
        <div class="mermaid-container-fullscreen${darkTheme ? ' dark-theme' : ''}"></div>
    `;
    document.body.appendChild(modal);

    const modalContent = modal.querySelector('.mermaid-container-fullscreen');
    const closeBtn = modal.querySelector('.mermaid-fullscreen-close');

    let previousScrollOffset = [window.scrollX, window.scrollY];

    const closeModal = () => {
        modal.classList.remove('active');
        modalContent.innerHTML = '';
        document.body.style.overflow = ''
        window.scrollTo({left: previousScrollOffset[0], top: previousScrollOffset[1], behavior: 'instant'});
    };

    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('active')) {
            closeModal();
        }
    });

    const allButtons = [];

    document.querySelectorAll('.mermaid').forEach((mermaidDiv) => {
        if (mermaidDiv.parentNode.classList.contains('mermaid-container') ||
            mermaidDiv.closest('.mermaid-fullscreen-modal')) {
            return;
        }

        const container = document.createElement('div');
        container.className = 'mermaid-container';
        mermaidDiv.parentNode.insertBefore(container, mermaidDiv);
        container.appendChild(mermaidDiv);

        const fullscreenBtn = document.createElement('button');
        fullscreenBtn.className = 'mermaid-fullscreen-btn' + (darkTheme ? ' dark-theme' : '');
        fullscreenBtn.setAttribute('aria-label', 'View diagram in fullscreen');
        fullscreenBtn.textContent = 'â›¶';
        fullscreenBtn.style.opacity = '50%';

        // Calculate dynamic position based on diagram's margin and padding
        const diagramStyle = window.getComputedStyle(mermaidDiv);
        const marginTop = parseFloat(diagramStyle.marginTop) || 0;
        const marginRight = parseFloat(diagramStyle.marginRight) || 0;
        const paddingTop = parseFloat(diagramStyle.paddingTop) || 0;
        const paddingRight = parseFloat(diagramStyle.paddingRight) || 0;
        fullscreenBtn.style.top = `${marginTop + paddingTop + 4}px`;
        fullscreenBtn.style.right = `${marginRight + paddingRight + 4}px`;

        fullscreenBtn.addEventListener('click', () => {
            previousScrollOffset = [window.scroll, window.scrollY];
            const clone = mermaidDiv.cloneNode(true);
            modalContent.innerHTML = '';
            modalContent.appendChild(clone);

            const svg = clone.querySelector('svg');
            if (svg) {
                svg.removeAttribute('width');
                svg.removeAttribute('height');
                svg.style.width = '100%';
                svg.style.height = 'auto';
                svg.style.maxWidth = '100%';
                svg.style.sdisplay = 'block';

                if ("False" === "True") {
                    setTimeout(() => {
                        const g = svg.querySelector('g');
                        if (g) {
                            var svgD3 = d3.select(svg);
                            svgD3.html("<g class='wrapper'>" + svgD3.html() + "</g>");
                            var inner = svgD3.select("g");
                            var zoom = d3.zoom().on("zoom", function(event) {
                                inner.attr("transform", event.transform);
                            });
                            svgD3.call(zoom);
                        }
                    }, 100);
                }
            }

            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        });

        container.appendChild(fullscreenBtn);
        allButtons.push(fullscreenBtn);
    });

    // Update theme classes when theme changes
    const updateTheme = () => {
        const dark = isDarkTheme();
        allButtons.forEach(btn => {
            if (dark) {
                btn.classList.add('dark-theme');
            } else {
                btn.classList.remove('dark-theme');
            }
        });
        if (dark) {
            modal.classList.add('dark-theme');
            modalContent.classList.add('dark-theme');
            closeBtn.classList.add('dark-theme');
        } else {
            modal.classList.remove('dark-theme');
            modalContent.classList.remove('dark-theme');
            closeBtn.classList.remove('dark-theme');
        }
    };

    // Watch for theme changes
    const observer = new MutationObserver(updateTheme);
    observer.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ['class', 'style', 'data-theme']
    });
    observer.observe(document.body, {
        attributes: true,
        attributeFilter: ['class', 'style']
    });
};

window.addEventListener("load", load);
</script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="××™× ×“×§×¡" href="../genindex.html" />
    <link rel="search" title="×—×™×¤×•×©" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Code Keeper Bot
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">×œ××¤×ª×—×™× ×•×œ×¡×•×›× ×™ AI:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quickstart-ai.html">×”×ª×—×œ×” ××”×™×¨×” - ×¡×•×›× ×™ AI</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#id1">××˜×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#id2">××” ××¡×•×¨</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#id3">××” ××•×ª×¨ ×•××•××œ×¥</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#id4">×¤×•×¨××˜×™ ×¦×™×˜×•×˜ ×§×•×“</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#tmp">××—×™×§×” ×‘×˜×•×—×” (×¨×§ ×‘-/tmp)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#pr">×§×•××™×˜×™× ×•-PR</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#id5">×§×™×©×•×¨×™× ××”×™×¨×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#cheatsheet-github-cli-gh">Cheatsheet â€“ GitHub CLI (gh)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">×”×ª×—×œ×” ××”×™×¨×” - ××¤×ª×—×™×</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#id2">××˜×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#id3">×©×œ×‘ 1: ×”×ª×§× ×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#env">×©×œ×‘ 2: ×”×’×“×¨×ª .env</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#id4">×©×œ×‘ 3: ×”×¨×¦×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#id5">××” ×”×œ××”?</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart-contrib.html">Quickstart ×œ×ª×¨×•××”</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-contrib.html#id1">××˜×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-contrib.html#id2">×¦×¢×“×™ ×”×›× ×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-contrib.html#id3">×¡×‘×™×‘×ª ×¤×™×ª×•×—</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-contrib.html#id4">×”×¨×¦×ª ×˜×¡×˜×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-contrib.html#stubs">×¢×œ ×”â€‘Stubs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-contrib.html#id5">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ai-guidelines.html">×”× ×—×™×•×ª ××œ××•×ª ×œ×¡×•×›× ×™ AI</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../ai-guidelines.html#id1">××’×‘×œ×•×ª ×§×¨×™×˜×™×•×ª</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../ai-guidelines.html#id2">×”×¨×¦×ª ×¤×§×•×“×•×ª</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../ai-guidelines.html#id3">×›×œ×™ ×§×‘×¦×™× ×××•×©×¨×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ai-guidelines.html#id4">×¢×§×¨×•× ×•×ª ×¢×¨×™×›×ª ×§×•×“</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ai-guidelines.html#pull-requests">×§×•××™×˜×™× ×•-Pull Requests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ai-guidelines.html#id5">×¢×‘×•×“×” ×¢× ×˜×¡×˜×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ai-guidelines.html#id6">×§×™×©×•×¨×™× ××”×™×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../agents/rate-limiting.html">ğŸš¦ ××¢×¨×›×ª Rate Limiting ×œ×¡×•×›× ×™ AI ×•×œ×•×•×‘</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#shadow-mode">××¡×˜×¨×˜×’×™×” â€“ Shadow Mode ×ª×—×™×œ×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#id1">××©×ª× ×™ ×¡×‘×™×‘×” ×•×§×•× ×¤×™×’</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#id2">××™× ×˜×’×¨×¦×™×” â€“ ×‘×•×˜ ×˜×œ×’×¨×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#flask-webapp">××™× ×˜×’×¨×¦×™×” â€“ Flask/WebApp</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#id3">×”×—×¨×’×•×ª ×—×©×•×‘×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#prometheus">× ×™×˜×•×¨ ×•××“×“×™× (Prometheus)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#id4">××‘×˜×—×” ×•×”×’× ×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#pydantic-settings">×§×•× ×¤×™×’×•×¨×¦×™×” (Pydantic Settings)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#id5">×ª×§×œ×•×ª × ×¤×•×¦×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#id6">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../doc-authoring.html">Doc Authoring Guide (Sphinx/RTD)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../doc-authoring.html#id1">××˜×¨×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../doc-authoring.html#id2">××“×™× ×™×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../doc-authoring.html#id3">×˜×™×¤×™× ××”×™×¨×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../doc-authoring.html#id4">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../style-glossary.html">Style &amp; Naming Glossary</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../style-glossary.html#id1">××˜×¨×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../style-glossary.html#id2">××™×¤×•×™ ××•× ×—×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../style-glossary.html#id3">×›×œ×œ×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../style-glossary.html#id4">×¢×•×’× ×™ ×ª×™×¢×•×“</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../versioning-stable-anchors.html">Versioning &amp; Stable Anchors</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../versioning-stable-anchors.html#id1">××“×™× ×™×•×ª ×¢×•×’× ×™× ×™×¦×™×‘×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../versioning-stable-anchors.html#whats-new">Whatâ€™s New</a></li>
<li class="toctree-l2"><a class="reference internal" href="../versioning-stable-anchors.html#anchors">×“×•×’××ª Anchors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../versioning-stable-anchors.html#id2">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../whats-new.html">Whatâ€™s New</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../whats-new.html#id1">2025-11-11</a></li>
<li class="toctree-l2"><a class="reference internal" href="../whats-new.html#id2">2025-11-06</a></li>
<li class="toctree-l2"><a class="reference internal" href="../whats-new.html#id3">2025-11-05</a></li>
<li class="toctree-l2"><a class="reference internal" href="../whats-new.html#id4">2025-10-30</a></li>
<li class="toctree-l2"><a class="reference internal" href="../whats-new.html#id5">2025-10-29</a></li>
<li class="toctree-l2"><a class="reference internal" href="../whats-new.html#id6">2025-10-15</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../architecture.html">××¨×›×™×˜×§×˜×•×¨×”</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#id2">×¡×§×™×¨×” ×›×œ×œ×™×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#id3">×ª×¨×©×™× ×¨×›×™×‘×™× (×ª××¦×™×ª×™)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#id4">××‘× ×” ×ª×™×§×™×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#id5">×–×¨×™××•×ª ××¨×›×–×™×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#id6">×§×™×©×•×¨×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#http-aiohttp">×ª×©×ª×™×ª HTTP â€“ ×¡×©×Ÿ aiohttp ××©×•×ª×£</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#documenthandler">×”×¤×¨×“×ª ××—×¨×™×•×ª â€“ DocumentHandler</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">××“×¨×™×š ×ª×¨×•××”</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../contributing.html#id2">××˜×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributing.html#id3">×›×œ×œ×™× ×›×œ×œ×™×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributing.html#workflow">Workflow ×‘×¡×™×¡×™</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributing.html#pre-commit">Pre-commit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributing.html#conventional-commits">Conventional Commits</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributing.html#id4">×“×•×’×××•×ª ×©×™××•×©×™×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributing.html#id5">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../branch-protection-and-pr-rules.html">Branch Protection &amp; PR Rules</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../branch-protection-and-pr-rules.html#id1">××˜×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../branch-protection-and-pr-rules.html#id2">×›×œ×œ×™ ×¢× ×¤×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../branch-protection-and-pr-rules.html#pr">×—×•×§×™ PR</a></li>
<li class="toctree-l2"><a class="reference internal" href="../branch-protection-and-pr-rules.html#ci-required-checks">CI â€“ Required Checks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../branch-protection-and-pr-rules.html#id3">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">××“×¨×™×›×™× ×‘×¡×™×¡×™×™×:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">×”×ª×§× ×” ×•×”×’×“×¨×”</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#id2">×“×¨×™×©×•×ª ××¢×¨×›×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#id3">×”×ª×§× ×” ××”×™×¨×”</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#id4">1. ×©×›×¤×œ ××ª ×”×¨×™×¤×•×–×™×˜×•×¨×™</a></li>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#id5">2. ×”×ª×§×Ÿ ×ª×œ×•×™×•×ª</a></li>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#id6">3. ×”×’×“×¨ ××©×ª× ×™ ×¡×‘×™×‘×”</a></li>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#id7">4. ×”×¤×¢×œ ××ª ×”×‘×•×˜</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#docker">×”×ª×§× ×” ×¢× Docker</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#image">1. ×‘× ×” ××ª ×”-Image</a></li>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#docker-compose">2. ×”×¤×¢×œ ×¢× Docker Compose</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#mongodb">×”×’×“×¨×ª MongoDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#telegram-bot">×”×’×“×¨×ª Telegram Bot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#id8">×”×’×“×¨×•×ª ××ª×§×“××•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#id9">×‘×“×™×§×ª ×”×ª×§× ×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#id10">×¤×ª×¨×•×Ÿ ×‘×¢×™×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#id11">×ª××™×›×”</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../configuration.html">Rate Limiting</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#environment-variables">Environment variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#databases-and-cache-pooling-timeouts">Databases and Cache (Pooling/Timeouts)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#http-clients">HTTP Clients</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#http-async-async-http">×©×™××•×© ×‘â€‘http_async (Async HTTP)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#http-sync-sync-http">×©×™××•×© ×‘â€‘http_sync (Sync HTTP)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#flask">Flask</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#telegram-bot">Telegram Bot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#metrics">Metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#security">Security</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#id1">Databases and Cache (Pooling/Timeouts)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#id2">HTTP Clients</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#id3">×©×™××•×© ×‘-http_sync (Sync HTTP)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../configuration.html#config-via-pydantic-settings">Config via Pydantic Settings</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#id4">×”×™×¨×¨×›×™×™×ª ×˜×¢×™× ×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#id5">×•×œ×™×“×¦×™×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#env-example">.env.example</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#id6">×©×™××•×© ×œ×¡×•×›× ×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#id7">×¤×¨××˜×¨×™ ×§×•× ×¤×™×’×•×¨×¦×™×” ××¨×›×–×™×™× (×—×“×©×™×)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#id8">××™×—×•×“ ×ª×™×¢×•×“ ×§×•× ×¤×™×’×•×¨×¦×™×”</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../environment-variables.html">××©×ª× ×™ ×¡×‘×™×‘×” - ×¨×¤×¨× ×¡</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../environment-variables.html#id2">×˜×‘×œ×” ××¨×›×–×™×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../environment-variables.html#id3">×“×•×’×××•×ª ×§×•× ×¤×™×’×•×¨×¦×™×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../environment-variables.html#id4">×§×™×©×•×¨×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../environment-variables.html#scopes-github">×˜×‘×œ×ª Scopes ×œ×¤×™×¦â€™×¨×™× ×©×œ GitHub</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../performance-scaling.html">×‘×™×¦×•×¢×™× ×•×”×¨×—×‘×” (Performance &amp; Scaling)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../performance-scaling.html#pagination">×¢×™××•×“ (Pagination)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance-scaling.html#projection">Projection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance-scaling.html#id1">×“×’×©×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance-scaling.html#connection-pooling-timeouts">×›×•×•× ×•×Ÿ Connection Pooling ×•-Timeouts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance-scaling.html#id2">×œ×•×’×™ ××™×˜×™×•×ª (××”×™×¨ ×œ××™×ª×•×¨ ×¦×•×•××¨×™ ×‘×§×‘×•×§)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance-scaling.html#env">×‘×“×™×§×•×ª ××”×™×¨×•×ª ××—×¨×™ ×©×™× ×•×™ ENV</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance-scaling.html#id3">×”× ×—×™×•×ª ×œ×¤×™ ×¡×‘×™×‘×”</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../large-files-runbook.html">×˜×™×¤×•×œ ×‘×§×‘×¦×™× ×’×“×•×œ×™× (Large Files)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../large-files-runbook.html#id1">××’×‘×œ×•×ª ×•×¤×•×œ×‘×§×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../large-files-runbook.html#id2">×”× ×—×™×•×ª ×”×¤×¢×œ×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../large-files-runbook.html#id3">× ×™×˜×•×¨</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../api/main.html">main module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.get_admin_ids"><code class="docutils literal notranslate"><span class="pre">get_admin_ids()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.notify_admins"><code class="docutils literal notranslate"><span class="pre">notify_admins()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.recycle_backfill_command"><code class="docutils literal notranslate"><span class="pre">recycle_backfill_command()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.log_user_activity"><code class="docutils literal notranslate"><span class="pre">log_user_activity()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.get_lock_collection"><code class="docutils literal notranslate"><span class="pre">get_lock_collection()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.ensure_lock_indexes"><code class="docutils literal notranslate"><span class="pre">ensure_lock_indexes()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.cleanup_mongo_lock"><code class="docutils literal notranslate"><span class="pre">cleanup_mongo_lock()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.manage_mongo_lock"><code class="docutils literal notranslate"><span class="pre">manage_mongo_lock()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.HelpEntry"><code class="docutils literal notranslate"><span class="pre">HelpEntry</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.HelpEntry.commands"><code class="docutils literal notranslate"><span class="pre">HelpEntry.commands</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.HelpEntry.description"><code class="docutils literal notranslate"><span class="pre">HelpEntry.description</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.HelpEntry.suffix"><code class="docutils literal notranslate"><span class="pre">HelpEntry.suffix</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.HelpSection"><code class="docutils literal notranslate"><span class="pre">HelpSection</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.HelpSection.title"><code class="docutils literal notranslate"><span class="pre">HelpSection.title</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.HelpSection.entries"><code class="docutils literal notranslate"><span class="pre">HelpSection.entries</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.application"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.application</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.github_handler"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.github_handler</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.backup_handler"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.backup_handler</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.__init__"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.setup_handlers"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.setup_handlers()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.help_command"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.help_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.save_command"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.save_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.list_command"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.list_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.search_command"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.search_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.check_commands"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.check_commands()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.stats_command"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.stats_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.handle_document"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.handle_document()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.handle_text_message"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.handle_text_message()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.error_handler"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.error_handler()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.start"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.start()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.stop"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.stop()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.signal_handler"><code class="docutils literal notranslate"><span class="pre">signal_handler()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.setup_handlers"><code class="docutils literal notranslate"><span class="pre">setup_handlers()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.main"><code class="docutils literal notranslate"><span class="pre">main()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.setup_bot_data"><code class="docutils literal notranslate"><span class="pre">setup_bot_data()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/config.html">config module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/config.html#config.BotConfig"><code class="docutils literal notranslate"><span class="pre">BotConfig</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.BOT_TOKEN"><code class="docutils literal notranslate"><span class="pre">BotConfig.BOT_TOKEN</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MONGODB_URL"><code class="docutils literal notranslate"><span class="pre">BotConfig.MONGODB_URL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.DATABASE_NAME"><code class="docutils literal notranslate"><span class="pre">BotConfig.DATABASE_NAME</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MONGODB_MAX_POOL_SIZE"><code class="docutils literal notranslate"><span class="pre">BotConfig.MONGODB_MAX_POOL_SIZE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MONGODB_MIN_POOL_SIZE"><code class="docutils literal notranslate"><span class="pre">BotConfig.MONGODB_MIN_POOL_SIZE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MONGODB_MAX_IDLE_TIME_MS"><code class="docutils literal notranslate"><span class="pre">BotConfig.MONGODB_MAX_IDLE_TIME_MS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MONGODB_WAIT_QUEUE_TIMEOUT_MS"><code class="docutils literal notranslate"><span class="pre">BotConfig.MONGODB_WAIT_QUEUE_TIMEOUT_MS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MONGODB_SERVER_SELECTION_TIMEOUT_MS"><code class="docutils literal notranslate"><span class="pre">BotConfig.MONGODB_SERVER_SELECTION_TIMEOUT_MS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MONGODB_SOCKET_TIMEOUT_MS"><code class="docutils literal notranslate"><span class="pre">BotConfig.MONGODB_SOCKET_TIMEOUT_MS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MONGODB_CONNECT_TIMEOUT_MS"><code class="docutils literal notranslate"><span class="pre">BotConfig.MONGODB_CONNECT_TIMEOUT_MS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MONGODB_RETRY_WRITES"><code class="docutils literal notranslate"><span class="pre">BotConfig.MONGODB_RETRY_WRITES</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MONGODB_RETRY_READS"><code class="docutils literal notranslate"><span class="pre">BotConfig.MONGODB_RETRY_READS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MONGODB_APPNAME"><code class="docutils literal notranslate"><span class="pre">BotConfig.MONGODB_APPNAME</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MONGODB_COMPRESSORS"><code class="docutils literal notranslate"><span class="pre">BotConfig.MONGODB_COMPRESSORS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MONGODB_HEARTBEAT_FREQUENCY_MS"><code class="docutils literal notranslate"><span class="pre">BotConfig.MONGODB_HEARTBEAT_FREQUENCY_MS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.REDIS_URL"><code class="docutils literal notranslate"><span class="pre">BotConfig.REDIS_URL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.CACHE_ENABLED"><code class="docutils literal notranslate"><span class="pre">BotConfig.CACHE_ENABLED</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.REDIS_MAX_CONNECTIONS"><code class="docutils literal notranslate"><span class="pre">BotConfig.REDIS_MAX_CONNECTIONS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.REDIS_CONNECT_TIMEOUT"><code class="docutils literal notranslate"><span class="pre">BotConfig.REDIS_CONNECT_TIMEOUT</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.REDIS_SOCKET_TIMEOUT"><code class="docutils literal notranslate"><span class="pre">BotConfig.REDIS_SOCKET_TIMEOUT</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.AIOHTTP_POOL_LIMIT"><code class="docutils literal notranslate"><span class="pre">BotConfig.AIOHTTP_POOL_LIMIT</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.AIOHTTP_TIMEOUT_TOTAL"><code class="docutils literal notranslate"><span class="pre">BotConfig.AIOHTTP_TIMEOUT_TOTAL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.AIOHTTP_LIMIT_PER_HOST"><code class="docutils literal notranslate"><span class="pre">BotConfig.AIOHTTP_LIMIT_PER_HOST</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.REQUESTS_POOL_CONNECTIONS"><code class="docutils literal notranslate"><span class="pre">BotConfig.REQUESTS_POOL_CONNECTIONS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.REQUESTS_POOL_MAXSIZE"><code class="docutils literal notranslate"><span class="pre">BotConfig.REQUESTS_POOL_MAXSIZE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.REQUESTS_TIMEOUT"><code class="docutils literal notranslate"><span class="pre">BotConfig.REQUESTS_TIMEOUT</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.REQUESTS_RETRIES"><code class="docutils literal notranslate"><span class="pre">BotConfig.REQUESTS_RETRIES</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.REQUESTS_RETRY_BACKOFF"><code class="docutils literal notranslate"><span class="pre">BotConfig.REQUESTS_RETRY_BACKOFF</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.RATE_LIMIT_ENABLED"><code class="docutils literal notranslate"><span class="pre">BotConfig.RATE_LIMIT_ENABLED</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.RATE_LIMIT_SHADOW_MODE"><code class="docutils literal notranslate"><span class="pre">BotConfig.RATE_LIMIT_SHADOW_MODE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.RATE_LIMIT_STRATEGY"><code class="docutils literal notranslate"><span class="pre">BotConfig.RATE_LIMIT_STRATEGY</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.ADMIN_USER_IDS"><code class="docutils literal notranslate"><span class="pre">BotConfig.ADMIN_USER_IDS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.GITHUB_TOKEN"><code class="docutils literal notranslate"><span class="pre">BotConfig.GITHUB_TOKEN</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.PASTEBIN_API_KEY"><code class="docutils literal notranslate"><span class="pre">BotConfig.PASTEBIN_API_KEY</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MAX_CODE_SIZE"><code class="docutils literal notranslate"><span class="pre">BotConfig.MAX_CODE_SIZE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MAX_FILES_PER_USER"><code class="docutils literal notranslate"><span class="pre">BotConfig.MAX_FILES_PER_USER</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.SUPPORTED_LANGUAGES"><code class="docutils literal notranslate"><span class="pre">BotConfig.SUPPORTED_LANGUAGES</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.RECYCLE_TTL_DAYS"><code class="docutils literal notranslate"><span class="pre">BotConfig.RECYCLE_TTL_DAYS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.PUBLIC_BASE_URL"><code class="docutils literal notranslate"><span class="pre">BotConfig.PUBLIC_BASE_URL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.WEBAPP_URL"><code class="docutils literal notranslate"><span class="pre">BotConfig.WEBAPP_URL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MAINTENANCE_MODE"><code class="docutils literal notranslate"><span class="pre">BotConfig.MAINTENANCE_MODE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MAINTENANCE_MESSAGE"><code class="docutils literal notranslate"><span class="pre">BotConfig.MAINTENANCE_MESSAGE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MAINTENANCE_AUTO_WARMUP_SECS"><code class="docutils literal notranslate"><span class="pre">BotConfig.MAINTENANCE_AUTO_WARMUP_SECS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MAINTENANCE_WARMUP_GRACE_SECS"><code class="docutils literal notranslate"><span class="pre">BotConfig.MAINTENANCE_WARMUP_GRACE_SECS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.RATE_LIMIT_PER_MINUTE"><code class="docutils literal notranslate"><span class="pre">BotConfig.RATE_LIMIT_PER_MINUTE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.HIGHLIGHT_THEME"><code class="docutils literal notranslate"><span class="pre">BotConfig.HIGHLIGHT_THEME</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.GIT_CHECKPOINT_PREFIX"><code class="docutils literal notranslate"><span class="pre">BotConfig.GIT_CHECKPOINT_PREFIX</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.GOOGLE_CLIENT_ID"><code class="docutils literal notranslate"><span class="pre">BotConfig.GOOGLE_CLIENT_ID</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.GOOGLE_CLIENT_SECRET"><code class="docutils literal notranslate"><span class="pre">BotConfig.GOOGLE_CLIENT_SECRET</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.GOOGLE_OAUTH_SCOPES"><code class="docutils literal notranslate"><span class="pre">BotConfig.GOOGLE_OAUTH_SCOPES</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.GOOGLE_TOKEN_REFRESH_MARGIN_SECS"><code class="docutils literal notranslate"><span class="pre">BotConfig.GOOGLE_TOKEN_REFRESH_MARGIN_SECS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.DRIVE_MENU_V2"><code class="docutils literal notranslate"><span class="pre">BotConfig.DRIVE_MENU_V2</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.DOCUMENTATION_URL"><code class="docutils literal notranslate"><span class="pre">BotConfig.DOCUMENTATION_URL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.BOT_LABEL"><code class="docutils literal notranslate"><span class="pre">BotConfig.BOT_LABEL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.DRIVE_ADD_HASH"><code class="docutils literal notranslate"><span class="pre">BotConfig.DRIVE_ADD_HASH</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.NORMALIZE_CODE_ON_SAVE"><code class="docutils literal notranslate"><span class="pre">BotConfig.NORMALIZE_CODE_ON_SAVE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.FEATURE_MY_COLLECTIONS"><code class="docutils literal notranslate"><span class="pre">BotConfig.FEATURE_MY_COLLECTIONS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.COMMUNITY_LIBRARY_ENABLED"><code class="docutils literal notranslate"><span class="pre">BotConfig.COMMUNITY_LIBRARY_ENABLED</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.SEARCH_PAGE_SIZE"><code class="docutils literal notranslate"><span class="pre">BotConfig.SEARCH_PAGE_SIZE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.UI_PAGE_SIZE"><code class="docutils literal notranslate"><span class="pre">BotConfig.UI_PAGE_SIZE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.SENTRY_DSN"><code class="docutils literal notranslate"><span class="pre">BotConfig.SENTRY_DSN</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.SENTRY_TEST_BUTTON_ENABLED"><code class="docutils literal notranslate"><span class="pre">BotConfig.SENTRY_TEST_BUTTON_ENABLED</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.METRICS_DB_ENABLED"><code class="docutils literal notranslate"><span class="pre">BotConfig.METRICS_DB_ENABLED</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.METRICS_COLLECTION"><code class="docutils literal notranslate"><span class="pre">BotConfig.METRICS_COLLECTION</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.METRICS_BATCH_SIZE"><code class="docutils literal notranslate"><span class="pre">BotConfig.METRICS_BATCH_SIZE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.METRICS_FLUSH_INTERVAL_SEC"><code class="docutils literal notranslate"><span class="pre">BotConfig.METRICS_FLUSH_INTERVAL_SEC</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.model_config"><code class="docutils literal notranslate"><span class="pre">BotConfig.model_config</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.settings_customise_sources"><code class="docutils literal notranslate"><span class="pre">BotConfig.settings_customise_sources()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/config.html#config.load_config"><code class="docutils literal notranslate"><span class="pre">load_config()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/bot_handlers.html">bot_handlers module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.set_activity_reporter"><code class="docutils literal notranslate"><span class="pre">set_activity_reporter()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.__init__"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.setup_advanced_handlers"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.setup_advanced_handlers()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.show_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.show_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.favorite_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.favorite_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.favorites_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.favorites_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.edit_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.edit_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.delete_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.delete_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.versions_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.versions_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.analyze_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.analyze_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.status_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.status_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.sentry_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.sentry_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.uptime_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.uptime_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.observe_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.observe_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.alerts_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.alerts_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.incidents_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.incidents_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.predict_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.predict_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.silence_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.silence_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.unsilence_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.unsilence_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.silences_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.silences_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.accuracy_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.accuracy_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.errors_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.errors_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.triage_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.triage_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.system_info_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.system_info_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.metrics_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.metrics_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.rate_limit_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.rate_limit_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.enable_backoff_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.enable_backoff_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.disable_backoff_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.disable_backoff_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.validate_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.validate_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.share_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.share_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.share_help_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.share_help_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.help_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.help_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.download_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.download_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.tags_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.tags_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.recent_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.recent_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.info_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.info_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.search_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.search_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.broadcast_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.broadcast_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.dm_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.dm_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.handle_callback_query"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.handle_callback_query()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.lang_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.lang_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.lang_debug_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.lang_debug_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.image_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.image_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.preview_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.preview_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.image_all_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.image_all_command()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.check_db_connection"><code class="docutils literal notranslate"><span class="pre">check_db_connection()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/conversation_handlers.html">conversation_handlers module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.set_activity_reporter"><code class="docutils literal notranslate"><span class="pre">set_activity_reporter()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.start_command"><code class="docutils literal notranslate"><span class="pre">start_command()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_community_hub"><code class="docutils literal notranslate"><span class="pre">show_community_hub()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_catalog_menu"><code class="docutils literal notranslate"><span class="pre">community_catalog_menu()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippets_menu"><code class="docutils literal notranslate"><span class="pre">snippets_menu()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_hub_callback"><code class="docutils literal notranslate"><span class="pre">community_hub_callback()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.main_menu_callback"><code class="docutils literal notranslate"><span class="pre">main_menu_callback()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.submit_flows_cancel"><code class="docutils literal notranslate"><span class="pre">submit_flows_cancel()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_help_page"><code class="docutils literal notranslate"><span class="pre">show_help_page()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.setup_favorites_category_handlers"><code class="docutils literal notranslate"><span class="pre">setup_favorites_category_handlers()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.start_repo_zip_import"><code class="docutils literal notranslate"><span class="pre">start_repo_zip_import()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.start_zip_create_flow"><code class="docutils literal notranslate"><span class="pre">start_zip_create_flow()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_by_repo_menu"><code class="docutils literal notranslate"><span class="pre">show_by_repo_menu()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_by_repo_menu_callback"><code class="docutils literal notranslate"><span class="pre">show_by_repo_menu_callback()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_all_files"><code class="docutils literal notranslate"><span class="pre">show_all_files()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_large_files_direct"><code class="docutils literal notranslate"><span class="pre">show_large_files_direct()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_github_menu"><code class="docutils literal notranslate"><span class="pre">show_github_menu()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_all_files_callback"><code class="docutils literal notranslate"><span class="pre">show_all_files_callback()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_submit_start"><code class="docutils literal notranslate"><span class="pre">community_submit_start()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_collect_title"><code class="docutils literal notranslate"><span class="pre">community_collect_title()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_collect_description"><code class="docutils literal notranslate"><span class="pre">community_collect_description()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_collect_url"><code class="docutils literal notranslate"><span class="pre">community_collect_url()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_collect_logo"><code class="docutils literal notranslate"><span class="pre">community_collect_logo()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_inline_approve"><code class="docutils literal notranslate"><span class="pre">community_inline_approve()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_reject_start"><code class="docutils literal notranslate"><span class="pre">community_reject_start()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_collect_reject_reason"><code class="docutils literal notranslate"><span class="pre">community_collect_reject_reason()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_queue_command"><code class="docutils literal notranslate"><span class="pre">community_queue_command()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_approve_command"><code class="docutils literal notranslate"><span class="pre">community_approve_command()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_reject_command"><code class="docutils literal notranslate"><span class="pre">community_reject_command()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_submit_start"><code class="docutils literal notranslate"><span class="pre">snippet_submit_start()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_collect_title"><code class="docutils literal notranslate"><span class="pre">snippet_collect_title()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_collect_description"><code class="docutils literal notranslate"><span class="pre">snippet_collect_description()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_mode_regular_start"><code class="docutils literal notranslate"><span class="pre">snippet_mode_regular_start()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_mode_long_start"><code class="docutils literal notranslate"><span class="pre">snippet_mode_long_start()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_long_collect_receive"><code class="docutils literal notranslate"><span class="pre">snippet_long_collect_receive()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_long_collect_done"><code class="docutils literal notranslate"><span class="pre">snippet_long_collect_done()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_collect_code"><code class="docutils literal notranslate"><span class="pre">snippet_collect_code()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_collect_language"><code class="docutils literal notranslate"><span class="pre">snippet_collect_language()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_inline_approve"><code class="docutils literal notranslate"><span class="pre">snippet_inline_approve()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_reject_start"><code class="docutils literal notranslate"><span class="pre">snippet_reject_start()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_collect_reject_reason"><code class="docutils literal notranslate"><span class="pre">snippet_collect_reject_reason()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_queue_command"><code class="docutils literal notranslate"><span class="pre">snippet_queue_command()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_approve_command"><code class="docutils literal notranslate"><span class="pre">snippet_approve_command()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_reject_command"><code class="docutils literal notranslate"><span class="pre">snippet_reject_command()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_regular_files_callback"><code class="docutils literal notranslate"><span class="pre">show_regular_files_callback()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_favorites_callback"><code class="docutils literal notranslate"><span class="pre">show_favorites_callback()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_favorites_page_callback"><code class="docutils literal notranslate"><span class="pre">show_favorites_page_callback()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_regular_files_page_callback"><code class="docutils literal notranslate"><span class="pre">show_regular_files_page_callback()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_recycle_bin"><code class="docutils literal notranslate"><span class="pre">show_recycle_bin()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.recycle_restore"><code class="docutils literal notranslate"><span class="pre">recycle_restore()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.recycle_purge"><code class="docutils literal notranslate"><span class="pre">recycle_purge()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.share_single_by_id"><code class="docutils literal notranslate"><span class="pre">share_single_by_id()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_duplicate_callback"><code class="docutils literal notranslate"><span class="pre">handle_duplicate_callback()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_file_menu"><code class="docutils literal notranslate"><span class="pre">handle_file_menu()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_view_file"><code class="docutils literal notranslate"><span class="pre">handle_view_file()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_edit_code"><code class="docutils literal notranslate"><span class="pre">handle_edit_code()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.receive_new_code"><code class="docutils literal notranslate"><span class="pre">receive_new_code()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_edit_name"><code class="docutils literal notranslate"><span class="pre">handle_edit_name()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_edit_note"><code class="docutils literal notranslate"><span class="pre">handle_edit_note()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.receive_new_name"><code class="docutils literal notranslate"><span class="pre">receive_new_name()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_versions_history"><code class="docutils literal notranslate"><span class="pre">handle_versions_history()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_download_file"><code class="docutils literal notranslate"><span class="pre">handle_download_file()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_delete_confirmation"><code class="docutils literal notranslate"><span class="pre">handle_delete_confirmation()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_delete_file"><code class="docutils literal notranslate"><span class="pre">handle_delete_file()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_file_info"><code class="docutils literal notranslate"><span class="pre">handle_file_info()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_callback_query"><code class="docutils literal notranslate"><span class="pre">handle_callback_query()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.cancel"><code class="docutils literal notranslate"><span class="pre">cancel()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.get_save_conversation_handler"><code class="docutils literal notranslate"><span class="pre">get_save_conversation_handler()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_view_version"><code class="docutils literal notranslate"><span class="pre">handle_view_version()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_revert_version"><code class="docutils literal notranslate"><span class="pre">handle_revert_version()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_preview_button"><code class="docutils literal notranslate"><span class="pre">handle_preview_button()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_autocomplete_button"><code class="docutils literal notranslate"><span class="pre">handle_autocomplete_button()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_batch_button"><code class="docutils literal notranslate"><span class="pre">handle_batch_button()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_batch_menu"><code class="docutils literal notranslate"><span class="pre">show_batch_menu()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_batch_repos_menu"><code class="docutils literal notranslate"><span class="pre">show_batch_repos_menu()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_batch_files_menu"><code class="docutils literal notranslate"><span class="pre">show_batch_files_menu()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_batch_zips_menu"><code class="docutils literal notranslate"><span class="pre">show_batch_zips_menu()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_batch_actions_menu"><code class="docutils literal notranslate"><span class="pre">show_batch_actions_menu()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.execute_batch_on_current_selection"><code class="docutils literal notranslate"><span class="pre">execute_batch_on_current_selection()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/database.html">database package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/database.html#database.init_database"><code class="docutils literal notranslate"><span class="pre">init_database()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/database.html#submodules">Submodules</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/database.bookmark.html">database.bookmark module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/database.bookmarks_manager.html">database.bookmarks_manager module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/database.collections_manager.html">database.collections_manager module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/database.manager.html">database.manager module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/database.models.html">database.models module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/database.repository.html">database.repository module</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/services.html">services package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/services.html#submodules">Submodules</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/services.backoff_state.html">services.backoff_state module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/services.backup_service.html">services.backup_service module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/services.code_service.html">services.code_service module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/services.github_service.html">services.github_service module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/services.google_drive_service.html">services.google_drive_service module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/services.investigation_service.html">services.investigation_service module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/services.webserver.html">services.webserver module</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/handlers.html">handlers package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/handlers.html#subpackages">Subpackages</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.github.html">handlers.github package</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/handlers.html#submodules">Submodules</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.documents.html">handlers.documents module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.file_view.html">handlers.file_view module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.pagination.html">handlers.pagination module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.save_flow.html">handlers.save_flow module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.states.html">handlers.states module</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/utils.html">utils module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.CodeErrorLogger"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CodeErrorLogger.__init__"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CodeErrorLogger.log_code_processing_error"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger.log_code_processing_error()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CodeErrorLogger.log_code_activity"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger.log_code_activity()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CodeErrorLogger.log_validation_failure"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger.log_validation_failure()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CodeErrorLogger.log_sanitization_success"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger.log_sanitization_success()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.TimeUtils"><code class="docutils literal notranslate"><span class="pre">TimeUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TimeUtils.format_relative_time"><code class="docutils literal notranslate"><span class="pre">TimeUtils.format_relative_time()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TimeUtils.parse_date_string"><code class="docutils literal notranslate"><span class="pre">TimeUtils.parse_date_string()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TimeUtils.get_time_ranges"><code class="docutils literal notranslate"><span class="pre">TimeUtils.get_time_ranges()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.TextUtils"><code class="docutils literal notranslate"><span class="pre">TextUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils.truncate_text"><code class="docutils literal notranslate"><span class="pre">TextUtils.truncate_text()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils.escape_markdown"><code class="docutils literal notranslate"><span class="pre">TextUtils.escape_markdown()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils.clean_filename"><code class="docutils literal notranslate"><span class="pre">TextUtils.clean_filename()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils.extract_hashtags"><code class="docutils literal notranslate"><span class="pre">TextUtils.extract_hashtags()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils.highlight_text"><code class="docutils literal notranslate"><span class="pre">TextUtils.highlight_text()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils.format_file_size"><code class="docutils literal notranslate"><span class="pre">TextUtils.format_file_size()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils.pluralize_hebrew"><code class="docutils literal notranslate"><span class="pre">TextUtils.pluralize_hebrew()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.SecurityUtils"><code class="docutils literal notranslate"><span class="pre">SecurityUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.SecurityUtils.generate_secure_token"><code class="docutils literal notranslate"><span class="pre">SecurityUtils.generate_secure_token()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.SecurityUtils.hash_content"><code class="docutils literal notranslate"><span class="pre">SecurityUtils.hash_content()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.SecurityUtils.validate_user_input"><code class="docutils literal notranslate"><span class="pre">SecurityUtils.validate_user_input()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.SecurityUtils.sanitize_code"><code class="docutils literal notranslate"><span class="pre">SecurityUtils.sanitize_code()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils"><code class="docutils literal notranslate"><span class="pre">TelegramUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.send_typing_action"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.send_typing_action()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.send_document_action"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.send_document_action()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.safe_answer"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.safe_answer()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.get_user_mention"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.get_user_mention()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.split_long_message"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.split_long_message()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.safe_edit_message_text"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.safe_edit_message_text()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.safe_edit_message_reply_markup"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.safe_edit_message_reply_markup()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.extract_message_text_preserve_markdown"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.extract_message_text_preserve_markdown()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.CallbackQueryGuard"><code class="docutils literal notranslate"><span class="pre">CallbackQueryGuard</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CallbackQueryGuard.DEFAULT_WINDOW_SECONDS"><code class="docutils literal notranslate"><span class="pre">CallbackQueryGuard.DEFAULT_WINDOW_SECONDS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CallbackQueryGuard.should_block"><code class="docutils literal notranslate"><span class="pre">CallbackQueryGuard.should_block()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CallbackQueryGuard.should_block_async"><code class="docutils literal notranslate"><span class="pre">CallbackQueryGuard.should_block_async()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.AsyncUtils"><code class="docutils literal notranslate"><span class="pre">AsyncUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.AsyncUtils.run_with_timeout"><code class="docutils literal notranslate"><span class="pre">AsyncUtils.run_with_timeout()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.AsyncUtils.batch_process"><code class="docutils literal notranslate"><span class="pre">AsyncUtils.batch_process()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.PerformanceUtils"><code class="docutils literal notranslate"><span class="pre">PerformanceUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.PerformanceUtils.timing_decorator"><code class="docutils literal notranslate"><span class="pre">PerformanceUtils.timing_decorator()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.PerformanceUtils.measure_time"><code class="docutils literal notranslate"><span class="pre">PerformanceUtils.measure_time()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.ValidationUtils"><code class="docutils literal notranslate"><span class="pre">ValidationUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.ValidationUtils.is_valid_filename"><code class="docutils literal notranslate"><span class="pre">ValidationUtils.is_valid_filename()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.ValidationUtils.is_safe_code"><code class="docutils literal notranslate"><span class="pre">ValidationUtils.is_safe_code()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.FileUtils"><code class="docutils literal notranslate"><span class="pre">FileUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.FileUtils.download_file"><code class="docutils literal notranslate"><span class="pre">FileUtils.download_file()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.FileUtils.get_file_extension"><code class="docutils literal notranslate"><span class="pre">FileUtils.get_file_extension()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.FileUtils.get_mime_type"><code class="docutils literal notranslate"><span class="pre">FileUtils.get_mime_type()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.FileUtils.create_temp_file"><code class="docutils literal notranslate"><span class="pre">FileUtils.create_temp_file()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.ConfigUtils"><code class="docutils literal notranslate"><span class="pre">ConfigUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.ConfigUtils.load_json_config"><code class="docutils literal notranslate"><span class="pre">ConfigUtils.load_json_config()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.ConfigUtils.save_json_config"><code class="docutils literal notranslate"><span class="pre">ConfigUtils.save_json_config()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.CacheUtils"><code class="docutils literal notranslate"><span class="pre">CacheUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CacheUtils.set"><code class="docutils literal notranslate"><span class="pre">CacheUtils.set()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CacheUtils.get"><code class="docutils literal notranslate"><span class="pre">CacheUtils.get()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CacheUtils.delete"><code class="docutils literal notranslate"><span class="pre">CacheUtils.delete()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CacheUtils.clear"><code class="docutils literal notranslate"><span class="pre">CacheUtils.clear()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.get_memory_usage"><code class="docutils literal notranslate"><span class="pre">get_memory_usage()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.setup_logging"><code class="docutils literal notranslate"><span class="pre">setup_logging()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.generate_summary_stats"><code class="docutils literal notranslate"><span class="pre">generate_summary_stats()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.detect_language_from_filename"><code class="docutils literal notranslate"><span class="pre">detect_language_from_filename()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.get_language_emoji"><code class="docutils literal notranslate"><span class="pre">get_language_emoji()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.SensitiveDataFilter"><code class="docutils literal notranslate"><span class="pre">SensitiveDataFilter</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.SensitiveDataFilter.filter"><code class="docutils literal notranslate"><span class="pre">SensitiveDataFilter.filter()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.install_sensitive_filter"><code class="docutils literal notranslate"><span class="pre">install_sensitive_filter()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.normalize_code"><code class="docutils literal notranslate"><span class="pre">normalize_code()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/modules.html">workspace</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/activity_reporter.html">activity_reporter module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/activity_reporter.html#activity_reporter.get_mongo_client"><code class="docutils literal notranslate"><span class="pre">get_mongo_client()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/activity_reporter.html#activity_reporter.close_mongo_client"><code class="docutils literal notranslate"><span class="pre">close_mongo_client()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/activity_reporter.html#activity_reporter.SimpleActivityReporter"><code class="docutils literal notranslate"><span class="pre">SimpleActivityReporter</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/activity_reporter.html#activity_reporter.create_reporter"><code class="docutils literal notranslate"><span class="pre">create_reporter()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/alert_forwarder.html">alert_forwarder module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/alert_forwarder.html#alert_forwarder.forward_alerts"><code class="docutils literal notranslate"><span class="pre">forward_alerts()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/alert_manager.html">alert_manager module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/alert_manager.html#alert_manager.reset_state_for_tests"><code class="docutils literal notranslate"><span class="pre">reset_state_for_tests()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/alert_manager.html#alert_manager.note_request"><code class="docutils literal notranslate"><span class="pre">note_request()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/alert_manager.html#alert_manager.get_current_error_rate_percent"><code class="docutils literal notranslate"><span class="pre">get_current_error_rate_percent()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/alert_manager.html#alert_manager.get_current_avg_latency_seconds"><code class="docutils literal notranslate"><span class="pre">get_current_avg_latency_seconds()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/alert_manager.html#alert_manager.bump_threshold"><code class="docutils literal notranslate"><span class="pre">bump_threshold()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/alert_manager.html#alert_manager.get_thresholds_snapshot"><code class="docutils literal notranslate"><span class="pre">get_thresholds_snapshot()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/alert_manager.html#alert_manager.check_and_emit_alerts"><code class="docutils literal notranslate"><span class="pre">check_and_emit_alerts()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/alert_manager.html#alert_manager.forward_critical_alert"><code class="docutils literal notranslate"><span class="pre">forward_critical_alert()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/alert_manager.html#alert_manager.get_dispatch_log"><code class="docutils literal notranslate"><span class="pre">get_dispatch_log()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/autocomplete_manager.html">autocomplete_manager module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/autocomplete_manager.html#autocomplete_manager.AutocompleteManager"><code class="docutils literal notranslate"><span class="pre">AutocompleteManager</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/backup_menu_handler.html">backup_menu_handler module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/backup_menu_handler.html#backup_menu_handler.BackupMenuHandler"><code class="docutils literal notranslate"><span class="pre">BackupMenuHandler</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/batch_commands.html">batch_commands module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_commands.html#batch_commands.batch_analyze_command"><code class="docutils literal notranslate"><span class="pre">batch_analyze_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_commands.html#batch_commands.batch_validate_command"><code class="docutils literal notranslate"><span class="pre">batch_validate_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_commands.html#batch_commands.job_status_command"><code class="docutils literal notranslate"><span class="pre">job_status_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_commands.html#batch_commands.large_file_command"><code class="docutils literal notranslate"><span class="pre">large_file_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_commands.html#batch_commands.handle_batch_callbacks"><code class="docutils literal notranslate"><span class="pre">handle_batch_callbacks()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_commands.html#batch_commands.setup_batch_handlers"><code class="docutils literal notranslate"><span class="pre">setup_batch_handlers()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/batch_processor.html">batch_processor module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_processor.html#batch_processor.BatchJob"><code class="docutils literal notranslate"><span class="pre">BatchJob</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_processor.html#batch_processor.BatchProcessor"><code class="docutils literal notranslate"><span class="pre">BatchProcessor</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/bot_handlers.html">bot_handlers module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.set_activity_reporter"><code class="docutils literal notranslate"><span class="pre">set_activity_reporter()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.check_db_connection"><code class="docutils literal notranslate"><span class="pre">check_db_connection()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/bot_rate_limiter.html">bot_rate_limiter module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_rate_limiter.html#bot_rate_limiter.RateLimitExceeded"><code class="docutils literal notranslate"><span class="pre">RateLimitExceeded</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_rate_limiter.html#bot_rate_limiter.check_rate_limit"><code class="docutils literal notranslate"><span class="pre">check_rate_limit()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_rate_limiter.html#bot_rate_limiter.rate_limit"><code class="docutils literal notranslate"><span class="pre">rate_limit()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/cache_commands.html">cache_commands module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_commands.html#cache_commands.cache_stats_command"><code class="docutils literal notranslate"><span class="pre">cache_stats_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_commands.html#cache_commands.clear_cache_command"><code class="docutils literal notranslate"><span class="pre">clear_cache_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_commands.html#cache_commands.setup_cache_handlers"><code class="docutils literal notranslate"><span class="pre">setup_cache_handlers()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_commands.html#cache_commands.cache_warm_command"><code class="docutils literal notranslate"><span class="pre">cache_warm_command()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/cache_manager.html">cache_manager module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_manager.html#cache_manager.DynamicTTL"><code class="docutils literal notranslate"><span class="pre">DynamicTTL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_manager.html#cache_manager.ActivityBasedTTL"><code class="docutils literal notranslate"><span class="pre">ActivityBasedTTL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_manager.html#cache_manager.build_cache_key"><code class="docutils literal notranslate"><span class="pre">build_cache_key()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_manager.html#cache_manager.CacheManager"><code class="docutils literal notranslate"><span class="pre">CacheManager</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_manager.html#cache_manager.dynamic_cache"><code class="docutils literal notranslate"><span class="pre">dynamic_cache()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_manager.html#cache_manager.cached"><code class="docutils literal notranslate"><span class="pre">cached()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_manager.html#cache_manager.async_cached"><code class="docutils literal notranslate"><span class="pre">async_cached()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/chatops.html">chatops package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/chatops.html#submodules">Submodules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/code_preview.html">code_preview module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/code_preview.html#code_preview.CodePreviewManager"><code class="docutils literal notranslate"><span class="pre">CodePreviewManager</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/code_processor.html">code_processor module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/config.html">config module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig"><code class="docutils literal notranslate"><span class="pre">BotConfig</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.load_config"><code class="docutils literal notranslate"><span class="pre">load_config()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/conftest.html">conftest module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/conftest.html#conftest.pytest_addoption"><code class="docutils literal notranslate"><span class="pre">pytest_addoption()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conftest.html#conftest.pytest_configure"><code class="docutils literal notranslate"><span class="pre">pytest_configure()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conftest.html#conftest.pytest_collection_modifyitems"><code class="docutils literal notranslate"><span class="pre">pytest_collection_modifyitems()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conftest.html#conftest.pytest_runtest_makereport"><code class="docutils literal notranslate"><span class="pre">pytest_runtest_makereport()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conftest.html#conftest.pytest_sessionfinish"><code class="docutils literal notranslate"><span class="pre">pytest_sessionfinish()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html">conversation_handlers module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.set_activity_reporter"><code class="docutils literal notranslate"><span class="pre">set_activity_reporter()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.start_command"><code class="docutils literal notranslate"><span class="pre">start_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_community_hub"><code class="docutils literal notranslate"><span class="pre">show_community_hub()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_catalog_menu"><code class="docutils literal notranslate"><span class="pre">community_catalog_menu()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippets_menu"><code class="docutils literal notranslate"><span class="pre">snippets_menu()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_hub_callback"><code class="docutils literal notranslate"><span class="pre">community_hub_callback()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.main_menu_callback"><code class="docutils literal notranslate"><span class="pre">main_menu_callback()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.submit_flows_cancel"><code class="docutils literal notranslate"><span class="pre">submit_flows_cancel()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_help_page"><code class="docutils literal notranslate"><span class="pre">show_help_page()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.setup_favorites_category_handlers"><code class="docutils literal notranslate"><span class="pre">setup_favorites_category_handlers()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.start_repo_zip_import"><code class="docutils literal notranslate"><span class="pre">start_repo_zip_import()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.start_zip_create_flow"><code class="docutils literal notranslate"><span class="pre">start_zip_create_flow()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_by_repo_menu"><code class="docutils literal notranslate"><span class="pre">show_by_repo_menu()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_by_repo_menu_callback"><code class="docutils literal notranslate"><span class="pre">show_by_repo_menu_callback()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_all_files"><code class="docutils literal notranslate"><span class="pre">show_all_files()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_large_files_direct"><code class="docutils literal notranslate"><span class="pre">show_large_files_direct()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_github_menu"><code class="docutils literal notranslate"><span class="pre">show_github_menu()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_all_files_callback"><code class="docutils literal notranslate"><span class="pre">show_all_files_callback()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_submit_start"><code class="docutils literal notranslate"><span class="pre">community_submit_start()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_collect_title"><code class="docutils literal notranslate"><span class="pre">community_collect_title()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_collect_description"><code class="docutils literal notranslate"><span class="pre">community_collect_description()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_collect_url"><code class="docutils literal notranslate"><span class="pre">community_collect_url()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_collect_logo"><code class="docutils literal notranslate"><span class="pre">community_collect_logo()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_inline_approve"><code class="docutils literal notranslate"><span class="pre">community_inline_approve()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_reject_start"><code class="docutils literal notranslate"><span class="pre">community_reject_start()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_collect_reject_reason"><code class="docutils literal notranslate"><span class="pre">community_collect_reject_reason()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_queue_command"><code class="docutils literal notranslate"><span class="pre">community_queue_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_approve_command"><code class="docutils literal notranslate"><span class="pre">community_approve_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_reject_command"><code class="docutils literal notranslate"><span class="pre">community_reject_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_submit_start"><code class="docutils literal notranslate"><span class="pre">snippet_submit_start()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_collect_title"><code class="docutils literal notranslate"><span class="pre">snippet_collect_title()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_collect_description"><code class="docutils literal notranslate"><span class="pre">snippet_collect_description()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_mode_regular_start"><code class="docutils literal notranslate"><span class="pre">snippet_mode_regular_start()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_mode_long_start"><code class="docutils literal notranslate"><span class="pre">snippet_mode_long_start()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_long_collect_receive"><code class="docutils literal notranslate"><span class="pre">snippet_long_collect_receive()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_long_collect_done"><code class="docutils literal notranslate"><span class="pre">snippet_long_collect_done()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_collect_code"><code class="docutils literal notranslate"><span class="pre">snippet_collect_code()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_collect_language"><code class="docutils literal notranslate"><span class="pre">snippet_collect_language()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_inline_approve"><code class="docutils literal notranslate"><span class="pre">snippet_inline_approve()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_reject_start"><code class="docutils literal notranslate"><span class="pre">snippet_reject_start()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_collect_reject_reason"><code class="docutils literal notranslate"><span class="pre">snippet_collect_reject_reason()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_queue_command"><code class="docutils literal notranslate"><span class="pre">snippet_queue_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_approve_command"><code class="docutils literal notranslate"><span class="pre">snippet_approve_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_reject_command"><code class="docutils literal notranslate"><span class="pre">snippet_reject_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_regular_files_callback"><code class="docutils literal notranslate"><span class="pre">show_regular_files_callback()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_favorites_callback"><code class="docutils literal notranslate"><span class="pre">show_favorites_callback()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_favorites_page_callback"><code class="docutils literal notranslate"><span class="pre">show_favorites_page_callback()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_regular_files_page_callback"><code class="docutils literal notranslate"><span class="pre">show_regular_files_page_callback()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_recycle_bin"><code class="docutils literal notranslate"><span class="pre">show_recycle_bin()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.recycle_restore"><code class="docutils literal notranslate"><span class="pre">recycle_restore()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.recycle_purge"><code class="docutils literal notranslate"><span class="pre">recycle_purge()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.share_single_by_id"><code class="docutils literal notranslate"><span class="pre">share_single_by_id()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_duplicate_callback"><code class="docutils literal notranslate"><span class="pre">handle_duplicate_callback()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_file_menu"><code class="docutils literal notranslate"><span class="pre">handle_file_menu()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_view_file"><code class="docutils literal notranslate"><span class="pre">handle_view_file()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_edit_code"><code class="docutils literal notranslate"><span class="pre">handle_edit_code()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.receive_new_code"><code class="docutils literal notranslate"><span class="pre">receive_new_code()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_edit_name"><code class="docutils literal notranslate"><span class="pre">handle_edit_name()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_edit_note"><code class="docutils literal notranslate"><span class="pre">handle_edit_note()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.receive_new_name"><code class="docutils literal notranslate"><span class="pre">receive_new_name()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_versions_history"><code class="docutils literal notranslate"><span class="pre">handle_versions_history()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_download_file"><code class="docutils literal notranslate"><span class="pre">handle_download_file()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_delete_confirmation"><code class="docutils literal notranslate"><span class="pre">handle_delete_confirmation()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_delete_file"><code class="docutils literal notranslate"><span class="pre">handle_delete_file()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_file_info"><code class="docutils literal notranslate"><span class="pre">handle_file_info()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_callback_query"><code class="docutils literal notranslate"><span class="pre">handle_callback_query()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.cancel"><code class="docutils literal notranslate"><span class="pre">cancel()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.get_save_conversation_handler"><code class="docutils literal notranslate"><span class="pre">get_save_conversation_handler()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_view_version"><code class="docutils literal notranslate"><span class="pre">handle_view_version()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_revert_version"><code class="docutils literal notranslate"><span class="pre">handle_revert_version()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_preview_button"><code class="docutils literal notranslate"><span class="pre">handle_preview_button()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_autocomplete_button"><code class="docutils literal notranslate"><span class="pre">handle_autocomplete_button()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_batch_button"><code class="docutils literal notranslate"><span class="pre">handle_batch_button()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_batch_menu"><code class="docutils literal notranslate"><span class="pre">show_batch_menu()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_batch_repos_menu"><code class="docutils literal notranslate"><span class="pre">show_batch_repos_menu()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_batch_files_menu"><code class="docutils literal notranslate"><span class="pre">show_batch_files_menu()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_batch_zips_menu"><code class="docutils literal notranslate"><span class="pre">show_batch_zips_menu()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_batch_actions_menu"><code class="docutils literal notranslate"><span class="pre">show_batch_actions_menu()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.execute_batch_on_current_selection"><code class="docutils literal notranslate"><span class="pre">execute_batch_on_current_selection()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/database.html">database package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/database.html#database.init_database"><code class="docutils literal notranslate"><span class="pre">init_database()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/database.html#submodules">Submodules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/duplicate_detector.html">duplicate_detector module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/duplicate_detector.html#duplicate_detector.scan_duplicates"><code class="docutils literal notranslate"><span class="pre">scan_duplicates()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/file_manager.html">file_manager module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/file_manager.html#file_manager.BackupInfo"><code class="docutils literal notranslate"><span class="pre">BackupInfo</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/file_manager.html#file_manager.BackupManager"><code class="docutils literal notranslate"><span class="pre">BackupManager</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/fix_telegram_parse_error.html">fix_telegram_parse_error module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/fix_telegram_parse_error.html#fix_telegram_parse_error.clean_for_telegram"><code class="docutils literal notranslate"><span class="pre">clean_for_telegram()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/fix_telegram_parse_error.html#fix_telegram_parse_error.apply_fix"><code class="docutils literal notranslate"><span class="pre">apply_fix()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/fix_telegram_parse_error.html#fix_telegram_parse_error.wrap_edit_message_calls"><code class="docutils literal notranslate"><span class="pre">wrap_edit_message_calls()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/github_menu_handler.html">github_menu_handler module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/github_menu_handler.html#github_menu_handler.http_request"><code class="docutils literal notranslate"><span class="pre">http_request()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_menu_handler.html#github_menu_handler.safe_html_escape"><code class="docutils literal notranslate"><span class="pre">safe_html_escape()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_menu_handler.html#github_menu_handler.format_bytes"><code class="docutils literal notranslate"><span class="pre">format_bytes()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_menu_handler.html#github_menu_handler.GitHubMenuHandler"><code class="docutils literal notranslate"><span class="pre">GitHubMenuHandler</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/github_upload_fix.html">github_upload_fix module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/github_upload_fix.html#github_upload_fix.github_upload_new_file"><code class="docutils literal notranslate"><span class="pre">github_upload_new_file()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_upload_fix.html#github_upload_fix.handle_document_fixed"><code class="docutils literal notranslate"><span class="pre">handle_document_fixed()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_upload_fix.html#github_upload_fix.upload_to_github_fixed"><code class="docutils literal notranslate"><span class="pre">upload_to_github_fixed()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_upload_fix.html#github_upload_fix.setup_minimal_commands"><code class="docutils literal notranslate"><span class="pre">setup_minimal_commands()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_upload_fix.html#github_upload_fix.stats_command_secured"><code class="docutils literal notranslate"><span class="pre">stats_command_secured()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_upload_fix.html#github_upload_fix.check_commands"><code class="docutils literal notranslate"><span class="pre">check_commands()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/handlers.html">handlers package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.html#subpackages">Subpackages</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.html#submodules">Submodules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/http_async.html">http_async module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/http_async.html#http_async.CircuitOpenError"><code class="docutils literal notranslate"><span class="pre">CircuitOpenError</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/http_async.html#http_async.get_session"><code class="docutils literal notranslate"><span class="pre">get_session()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/http_async.html#http_async.request"><code class="docutils literal notranslate"><span class="pre">request()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/http_async.html#http_async.close_session"><code class="docutils literal notranslate"><span class="pre">close_session()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/http_sync.html">http_sync module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/http_sync.html#http_sync.CircuitOpenError"><code class="docutils literal notranslate"><span class="pre">CircuitOpenError</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/http_sync.html#http_sync.get_session"><code class="docutils literal notranslate"><span class="pre">get_session()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/http_sync.html#http_sync.request"><code class="docutils literal notranslate"><span class="pre">request()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/i18n.html">i18n package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/i18n.html#submodules">Submodules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/integrations.html">integrations module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/integrations_github_monitor.html">integrations_github_monitor module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/integrations_github_monitor.html#integrations_github_monitor.fetch_rate_limit"><code class="docutils literal notranslate"><span class="pre">fetch_rate_limit()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/integrations_github_monitor.html#integrations_github_monitor.summarize_rate_limit"><code class="docutils literal notranslate"><span class="pre">summarize_rate_limit()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/integrations_sentry.html">integrations_sentry module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/integrations_sentry.html#integrations_sentry.is_configured"><code class="docutils literal notranslate"><span class="pre">is_configured()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/integrations_sentry.html#integrations_sentry.get_recent_issues"><code class="docutils literal notranslate"><span class="pre">get_recent_issues()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/integrations_sentry.html#integrations_sentry.search_events"><code class="docutils literal notranslate"><span class="pre">search_events()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/integrations_sentry.html#integrations_sentry.get_issue_events"><code class="docutils literal notranslate"><span class="pre">get_issue_events()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/internal_alerts.html">internal_alerts module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/internal_alerts.html#internal_alerts.emit_internal_alert"><code class="docutils literal notranslate"><span class="pre">emit_internal_alert()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/internal_alerts.html#internal_alerts.get_recent_alerts"><code class="docutils literal notranslate"><span class="pre">get_recent_alerts()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/large_files_handler.html">large_files_handler module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/large_files_handler.html#large_files_handler.LargeFilesHandler"><code class="docutils literal notranslate"><span class="pre">LargeFilesHandler</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/lazy_loader.html">lazy_loader module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/lazy_loader.html#lazy_loader.FileChunk"><code class="docutils literal notranslate"><span class="pre">FileChunk</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/lazy_loader.html#lazy_loader.LazyLoader"><code class="docutils literal notranslate"><span class="pre">LazyLoader</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html">main module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.get_admin_ids"><code class="docutils literal notranslate"><span class="pre">get_admin_ids()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.notify_admins"><code class="docutils literal notranslate"><span class="pre">notify_admins()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.recycle_backfill_command"><code class="docutils literal notranslate"><span class="pre">recycle_backfill_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.log_user_activity"><code class="docutils literal notranslate"><span class="pre">log_user_activity()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.get_lock_collection"><code class="docutils literal notranslate"><span class="pre">get_lock_collection()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.ensure_lock_indexes"><code class="docutils literal notranslate"><span class="pre">ensure_lock_indexes()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.cleanup_mongo_lock"><code class="docutils literal notranslate"><span class="pre">cleanup_mongo_lock()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.manage_mongo_lock"><code class="docutils literal notranslate"><span class="pre">manage_mongo_lock()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.HelpEntry"><code class="docutils literal notranslate"><span class="pre">HelpEntry</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.HelpSection"><code class="docutils literal notranslate"><span class="pre">HelpSection</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.signal_handler"><code class="docutils literal notranslate"><span class="pre">signal_handler()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.setup_handlers"><code class="docutils literal notranslate"><span class="pre">setup_handlers()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.main"><code class="docutils literal notranslate"><span class="pre">main()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.setup_bot_data"><code class="docutils literal notranslate"><span class="pre">setup_bot_data()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/metrics.html">metrics module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.track_performance"><code class="docutils literal notranslate"><span class="pre">track_performance()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.metrics_endpoint_bytes"><code class="docutils literal notranslate"><span class="pre">metrics_endpoint_bytes()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.metrics_content_type"><code class="docutils literal notranslate"><span class="pre">metrics_content_type()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.note_active_user"><code class="docutils literal notranslate"><span class="pre">note_active_user()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.record_request_outcome"><code class="docutils literal notranslate"><span class="pre">record_request_outcome()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.record_http_request"><code class="docutils literal notranslate"><span class="pre">record_http_request()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.record_outbound_request_duration"><code class="docutils literal notranslate"><span class="pre">record_outbound_request_duration()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.increment_outbound_retry"><code class="docutils literal notranslate"><span class="pre">increment_outbound_retry()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.set_circuit_state"><code class="docutils literal notranslate"><span class="pre">set_circuit_state()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.set_circuit_success_rate"><code class="docutils literal notranslate"><span class="pre">set_circuit_success_rate()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.get_boot_monotonic"><code class="docutils literal notranslate"><span class="pre">get_boot_monotonic()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.mark_startup_complete"><code class="docutils literal notranslate"><span class="pre">mark_startup_complete()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.note_first_request_latency"><code class="docutils literal notranslate"><span class="pre">note_first_request_latency()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.get_process_uptime_seconds"><code class="docutils literal notranslate"><span class="pre">get_process_uptime_seconds()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.record_dependency_init"><code class="docutils literal notranslate"><span class="pre">record_dependency_init()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.record_db_operation"><code class="docutils literal notranslate"><span class="pre">record_db_operation()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.get_uptime_percentage"><code class="docutils literal notranslate"><span class="pre">get_uptime_percentage()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.set_adaptive_observability_gauges"><code class="docutils literal notranslate"><span class="pre">set_adaptive_observability_gauges()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.track_file_saved"><code class="docutils literal notranslate"><span class="pre">track_file_saved()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.track_search_performed"><code class="docutils literal notranslate"><span class="pre">track_search_performed()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.track_github_sync"><code class="docutils literal notranslate"><span class="pre">track_github_sync()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/monitoring.html">monitoring package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/monitoring.html#submodules">Submodules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/observability.html">observability module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/observability.html#observability.get_observability_context"><code class="docutils literal notranslate"><span class="pre">get_observability_context()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/observability.html#observability.get_request_id"><code class="docutils literal notranslate"><span class="pre">get_request_id()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/observability.html#observability.bind_command"><code class="docutils literal notranslate"><span class="pre">bind_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/observability.html#observability.bind_user_context"><code class="docutils literal notranslate"><span class="pre">bind_user_context()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/observability.html#observability.prepare_outgoing_headers"><code class="docutils literal notranslate"><span class="pre">prepare_outgoing_headers()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/observability.html#observability.classify_error"><code class="docutils literal notranslate"><span class="pre">classify_error()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/observability.html#observability.setup_structlog_logging"><code class="docutils literal notranslate"><span class="pre">setup_structlog_logging()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/observability.html#observability.generate_request_id"><code class="docutils literal notranslate"><span class="pre">generate_request_id()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/observability.html#observability.bind_request_id"><code class="docutils literal notranslate"><span class="pre">bind_request_id()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/observability.html#observability.emit_event"><code class="docutils literal notranslate"><span class="pre">emit_event()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/observability.html#observability.init_sentry"><code class="docutils literal notranslate"><span class="pre">init_sentry()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/observability.html#observability.get_recent_errors"><code class="docutils literal notranslate"><span class="pre">get_recent_errors()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/observability.html#observability.emit_anomaly"><code class="docutils literal notranslate"><span class="pre">emit_anomaly()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/observability_instrumentation.html">observability_instrumentation module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/observability_instrumentation.html#observability_instrumentation.traced"><code class="docutils literal notranslate"><span class="pre">traced()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/observability_instrumentation.html#observability_instrumentation.start_span"><code class="docutils literal notranslate"><span class="pre">start_span()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/observability_instrumentation.html#observability_instrumentation.set_current_span_attributes"><code class="docutils literal notranslate"><span class="pre">set_current_span_attributes()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/observability_otel.html">observability_otel module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/observability_otel.html#observability_otel.setup_telemetry"><code class="docutils literal notranslate"><span class="pre">setup_telemetry()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/predictive_engine.html">predictive_engine module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/predictive_engine.html#predictive_engine.Trend"><code class="docutils literal notranslate"><span class="pre">Trend</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/predictive_engine.html#predictive_engine.note_observation"><code class="docutils literal notranslate"><span class="pre">note_observation()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/predictive_engine.html#predictive_engine.evaluate_predictions"><code class="docutils literal notranslate"><span class="pre">evaluate_predictions()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/predictive_engine.html#predictive_engine.reset_state_for_tests"><code class="docutils literal notranslate"><span class="pre">reset_state_for_tests()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/predictive_engine.html#predictive_engine.maybe_recompute_and_preempt"><code class="docutils literal notranslate"><span class="pre">maybe_recompute_and_preempt()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/predictive_engine.html#predictive_engine.get_recent_predictions"><code class="docutils literal notranslate"><span class="pre">get_recent_predictions()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/predictive_engine.html#predictive_engine.get_trend_snapshot"><code class="docutils literal notranslate"><span class="pre">get_trend_snapshot()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/rate_limiter.html">rate_limiter module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/rate_limiter.html#rate_limiter.RateLimiter"><code class="docutils literal notranslate"><span class="pre">RateLimiter</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/refactor_handlers.html">refactor_handlers module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/refactor_handlers.html#refactor_handlers.set_activity_reporter"><code class="docutils literal notranslate"><span class="pre">set_activity_reporter()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/refactor_handlers.html#refactor_handlers.RefactorHandlers"><code class="docutils literal notranslate"><span class="pre">RefactorHandlers</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/refactor_handlers.html#refactor_handlers.setup_refactor_handlers"><code class="docutils literal notranslate"><span class="pre">setup_refactor_handlers()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/refactoring_engine.html">refactoring_engine module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/refactoring_engine.html#id1">××“×™× ×™×•×ª ×•×§×•× ×¤×™×’×•×¨×¦×™×”</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/refactoring_engine.html#safe-decomposition-models-py">××§×¨×” ××™×•×—×“: Safe Decomposition ×œâ€‘<code class="docutils literal notranslate"><span class="pre">models.py</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/remediation_manager.html">remediation_manager module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/remediation_manager.html#remediation_manager.handle_critical_incident"><code class="docutils literal notranslate"><span class="pre">handle_critical_incident()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/remediation_manager.html#remediation_manager.get_incidents"><code class="docutils literal notranslate"><span class="pre">get_incidents()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/reminders.html">reminders package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/reminders.html#submodules">Submodules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/repo_analyzer.html">repo_analyzer module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/repo_analyzer.html#repo_analyzer.RepoAnalyzer"><code class="docutils literal notranslate"><span class="pre">RepoAnalyzer</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/search_engine.html">search_engine module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/secret_manager.html">secret_manager module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/secret_manager.html#secret_manager.encrypt_secret"><code class="docutils literal notranslate"><span class="pre">encrypt_secret()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/secret_manager.html#secret_manager.decrypt_secret"><code class="docutils literal notranslate"><span class="pre">decrypt_secret()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/services.html">services package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/services.html#submodules">Submodules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/setup_bookmarks.html">setup_bookmarks module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/setup_bookmarks.html#setup_bookmarks.check_mongodb_connection"><code class="docutils literal notranslate"><span class="pre">check_mongodb_connection()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/setup_bookmarks.html#setup_bookmarks.setup_bookmarks_collection"><code class="docutils literal notranslate"><span class="pre">setup_bookmarks_collection()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/setup_bookmarks.html#setup_bookmarks.verify_installation"><code class="docutils literal notranslate"><span class="pre">verify_installation()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/setup_bookmarks.html#setup_bookmarks.main"><code class="docutils literal notranslate"><span class="pre">main()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/terminal_commands.html">terminal_commands module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/terminal_commands.html#terminal_commands.run_in_sandbox"><code class="docutils literal notranslate"><span class="pre">run_in_sandbox()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/terminal_commands.html#terminal_commands.terminal_enter"><code class="docutils literal notranslate"><span class="pre">terminal_enter()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/terminal_commands.html#terminal_commands.terminal_exit"><code class="docutils literal notranslate"><span class="pre">terminal_exit()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/terminal_commands.html#terminal_commands.terminal_run_command"><code class="docutils literal notranslate"><span class="pre">terminal_run_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/terminal_commands.html#terminal_commands.terminal_command"><code class="docutils literal notranslate"><span class="pre">terminal_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/terminal_commands.html#terminal_commands.setup_terminal_handlers"><code class="docutils literal notranslate"><span class="pre">setup_terminal_handlers()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/test_basic.html">test_basic module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/test_basic.html#test_basic.test_python_version"><code class="docutils literal notranslate"><span class="pre">test_python_version()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/test_basic.html#test_basic.test_import_main"><code class="docutils literal notranslate"><span class="pre">test_import_main()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/test_basic.html#test_basic.test_environment"><code class="docutils literal notranslate"><span class="pre">test_environment()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/test_basic.html#test_basic.test_basic_calculation"><code class="docutils literal notranslate"><span class="pre">test_basic_calculation()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/test_basic.html#test_basic.TestRequirements"><code class="docutils literal notranslate"><span class="pre">TestRequirements</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/test_bookmarks.html">test_bookmarks module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/test_bookmarks.html#test_bookmarks.TestFileBookmarkModel"><code class="docutils literal notranslate"><span class="pre">TestFileBookmarkModel</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/test_bookmarks.html#test_bookmarks.TestBookmarksManager"><code class="docutils literal notranslate"><span class="pre">TestBookmarksManager</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/test_bookmarks.html#test_bookmarks.TestSyncFunctionality"><code class="docutils literal notranslate"><span class="pre">TestSyncFunctionality</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/test_bookmarks.html#test_bookmarks.TestIntegration"><code class="docutils literal notranslate"><span class="pre">TestIntegration</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/test_bookmarks.html#test_bookmarks.run_tests"><code class="docutils literal notranslate"><span class="pre">run_tests()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/user_stats.html">user_stats module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/user_stats.html#user_stats.UserStats"><code class="docutils literal notranslate"><span class="pre">UserStats</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html">utils module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CodeErrorLogger"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TimeUtils"><code class="docutils literal notranslate"><span class="pre">TimeUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils"><code class="docutils literal notranslate"><span class="pre">TextUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.SecurityUtils"><code class="docutils literal notranslate"><span class="pre">SecurityUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils"><code class="docutils literal notranslate"><span class="pre">TelegramUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CallbackQueryGuard"><code class="docutils literal notranslate"><span class="pre">CallbackQueryGuard</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.AsyncUtils"><code class="docutils literal notranslate"><span class="pre">AsyncUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.PerformanceUtils"><code class="docutils literal notranslate"><span class="pre">PerformanceUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.ValidationUtils"><code class="docutils literal notranslate"><span class="pre">ValidationUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.FileUtils"><code class="docutils literal notranslate"><span class="pre">FileUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.ConfigUtils"><code class="docutils literal notranslate"><span class="pre">ConfigUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CacheUtils"><code class="docutils literal notranslate"><span class="pre">CacheUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.get_memory_usage"><code class="docutils literal notranslate"><span class="pre">get_memory_usage()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.setup_logging"><code class="docutils literal notranslate"><span class="pre">setup_logging()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.generate_summary_stats"><code class="docutils literal notranslate"><span class="pre">generate_summary_stats()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.detect_language_from_filename"><code class="docutils literal notranslate"><span class="pre">detect_language_from_filename()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.get_language_emoji"><code class="docutils literal notranslate"><span class="pre">get_language_emoji()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.SensitiveDataFilter"><code class="docutils literal notranslate"><span class="pre">SensitiveDataFilter</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.install_sensitive_filter"><code class="docutils literal notranslate"><span class="pre">install_sensitive_filter()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.normalize_code"><code class="docutils literal notranslate"><span class="pre">normalize_code()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/webapp.html">webapp package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/webapp.html#submodules">Submodules</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../modules/index.html">××•×“×•×œ×™× ×¨××©×™×™×</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#file-management">File Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#github-integration">GitHub Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#backup-system">Backup System</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#code-processing">Code Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#search-engine">Search Engine</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#repository-analysis">Repository Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#batch-processing">Batch Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#large-files-handling">Large Files Handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#cache-management">Cache Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#user-statistics">User Statistics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#activity-reporting">Activity Reporting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#utilities">Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#lazy-loading">Lazy Loading</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#integrations">Integrations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#terminal-commands">Terminal Commands</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#autocomplete-manager">Autocomplete Manager</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../handlers/index.html">Handlers</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#show-command">Show Command</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../handlers/show.html">Show Command</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../handlers/show.html#show">××¤×¨×˜ ×¤×§×•×“×ª <cite>/show</cite></a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/show.html#html">×“×•×’××ª ×ª×’×•×‘×ª HTML</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/show.html#id1">×”×¢×¨×•×ª ×™×™×©×•×</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/show.html#id2">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#drive-menu">Drive Menu</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../handlers/drive_menu.html">Drive Menu V2</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../handlers/drive_menu.html#id1">×¡×§×™×¨×”</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/drive_menu.html#id2">×“×’×œ ×¤×™×¦â€™×¨</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/drive_menu.html#id3">×–×¨×™××•×ª ×¢×™×§×¨×™×•×ª</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/drive_menu.html#device-flow">×”×ª×—×‘×¨×•×ª (Device Flow)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/drive_menu.html#id4">×˜×™×¤×•×œ ×©×’×™××•×ª</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/drive_menu.html#id5">× ×™×˜×•×¨</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/drive_menu.html#module-handlers.drive.menu">API (autodoc)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#file-view-handler">File View Handler</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../handlers/index.html#file-view-handler-module">File View Handler Module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#pagination-handler">Pagination Handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#save-flow-handler">Save Flow Handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#states-handler">States Handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#github-handlers">GitHub Handlers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#document-flow">Document Flow</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../handlers/document-flow.html">×–×¨×™××ª ×”×˜×™×¤×•×œ ×‘××¡××›×™× (Document Flow)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../handlers/document-flow.html#id1">××¤×” ×•×ª×¤×§×™×“×™×</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/document-flow.html#id2">×–×¨×™××ª ×˜×™×¤×•×œ ×‘×§×•×‘×¥</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/document-flow.html#upload-mode">××¦×‘×™ upload_mode</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/document-flow.html#id3">×ª×œ×•×™×•×ª ×•×”×–×¨×§×•×ª</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/document-flow.html#best-practices">Best Practices</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/document-flow.html#filesfacade-db">×©×›×‘×ª ××—×¡×•×Ÿ (FilesFacade ××•×œ DB ×”×™×©×Ÿ)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/document-flow.html#id4">×¨××• ×’×</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../services/index.html">Services</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../services/index.html#code-service">Code Service</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../services/index.html#code-service-module">Code Service Module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../services/index.html#github-service">GitHub Service</a></li>
<li class="toctree-l2"><a class="reference internal" href="../services/index.html#backup-service">Backup Service</a></li>
<li class="toctree-l2"><a class="reference internal" href="../services/index.html#google-drive-service">Google Drive Service</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../services/google_drive_service.html">Google Drive Service</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../services/google_drive_service.html#id1">×¡×§×™×¨×”</a></li>
<li class="toctree-l4"><a class="reference internal" href="../services/google_drive_service.html#oauth">×”×¢×¨×•×ª OAuth</a></li>
<li class="toctree-l4"><a class="reference internal" href="../services/google_drive_service.html#id2">××‘× ×™ ×§×‘×¦×™×</a></li>
<li class="toctree-l4"><a class="reference internal" href="../services/google_drive_service.html#api-autodoc">API (autodoc)</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../database/index.html">Database</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../database/index.html#database-manager">Database Manager</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/index.html#models">Models</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../database/index.html#codesnippet-model">CodeSnippet Model</a></li>
<li class="toctree-l3"><a class="reference internal" href="../database/index.html#databasemanager-class">DatabaseManager Class</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../database/index.html#database-operations">Database Operations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../database/index.html#save-operations">Save Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../database/index.html#search-operations">Search Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../database/index.html#delete-operations">Delete Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../database/index.html#statistics-operations">Statistics Operations</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../database/index.html#users">××™× ×“×§×¡×™× ×‘×§×•×œ×§×¦×™×™×ª users</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../database/indexing.html">MongoDB Indexing Cookbook</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#id1">×œ××”?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#id2">××™× ×“×§×¡×™× ××•××œ×¦×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#python-pymongo">××ª×›×•× ×™× (Python / PyMongo)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#explain-mongo-shell">×‘×“×™×§×•×ª explain (Mongo Shell)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#explain">××” ×œ×—×¤×© ×‘-explain?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#id3">×‘×“×™×§×ª ×§×™×•× ××™× ×“×§×¡×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#id4">×©×™×˜×•×ª ×¢×‘×•×“×” ××•××œ×¦×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#id5">×“×•×’×××•×ª × ×•×¡×¤×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#gotchas">Gotchas × ×¤×•×¦×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../database/cursor-pagination.html">Cursor-based Pagination (created_at / _id)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#id1">×œ××”?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#id2">×¢×§×¨×•× ×•×ª ××™×•×Ÿ ×™×¦×™×‘</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#python">×§×™×“×•×“/×¤×¢× ×•×— ×§×•×¨×¡×•×¨ (Python)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#id3">×ª×‘× ×™×ª ×©××™×œ×ª×” (×—×“×© â†’ ×™×©×Ÿ)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#pymongo">PyMongo â€“ ×“×•×’××” ××œ××”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#id4">×“×¤×“×•×£ ×œ××—×•×¨ (×™×©×Ÿ â†’ ×—×“×©)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#copypaste">×‘×“×™×§×•×ª ×™×“× ×™×•×ª (Copyâ€‘Paste)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#id5">×©×™×˜×•×ª ×¢×‘×•×“×” ××•××œ×¦×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#gotchas">Gotchas × ×¤×•×¦×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#id6">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../database-schema.html">Database Schema</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../database-schema.html#collections">Collections</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../database-schema.html#code-snippets"><code class="docutils literal notranslate"><span class="pre">code_snippets</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../database-schema.html#users"><code class="docutils literal notranslate"><span class="pre">users</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../database-schema.html#bookmarks"><code class="docutils literal notranslate"><span class="pre">bookmarks</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../database-schema.html#sessions-webapp"><code class="docutils literal notranslate"><span class="pre">sessions</span></code> (WebApp)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../database-schema.html#indexes">Indexes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database-schema.html#relationships">Relationships</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database-schema.html#id1">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../database/detailed-schema.html">××‘× ×” × ×ª×•× ×™× ××¤×•×¨×˜ (Detailed Database Schema)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../database/detailed-schema.html#id1">×¡×§×™×¨×” ×›×œ×œ×™×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/detailed-schema.html#code-snippets">××•×¡×£: code_snippets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/detailed-schema.html#large-files">××•×¡×£: large_files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/detailed-schema.html#users">××•×¡×£: users</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/detailed-schema.html#bookmarks">××•×¡×£: bookmarks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/detailed-schema.html#collections">××•×¡×£: collections</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/detailed-schema.html#backups">××•×¡×£: backups</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/detailed-schema.html#id2">×™×—×¡×™× ×‘×™×Ÿ ××•×¡×¤×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/detailed-schema.html#best-practices">Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/detailed-schema.html#id3">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">×¢×–×¨×” ×•×“×•×’×××•×ª:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../examples.html">×“×•×’×××•×ª ×©×™××•×©</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#id2">×©×™××•×© ×‘×¡×™×¡×™</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id3">×™×¦×™×¨×ª ××¤×œ×™×§×¦×™×™×ª ×‘×•×˜</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id4">×©××™×¨×ª ×§×•×“ ×—×“×©</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id5">×—×™×¤×•×© ×§×•×“</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#handlers">×©×™××•×© ×‘-Handlers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#command-handler">×™×¦×™×¨×ª Command Handler</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#conversation-handler">×™×¦×™×¨×ª Conversation Handler</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#services">×©×™××•×© ×‘-Services</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id6">×–×™×”×•×™ ×©×¤×ª ×ª×›× ×•×ª</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id7">× ×™×ª×•×— ×§×•×“</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#github">××™× ×˜×’×¨×¦×™×” ×¢× GitHub</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#gist">×”×¢×œ××ª ×§×•×“ ×œ-Gist</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#gists">×©×œ×™×¤×ª Gists ×©×œ ××©×ª××©</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#id8">×¢×‘×•×“×” ×¢× ××¡×“ ×”× ×ª×•× ×™×</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id9">×‘×™×¦×•×¢ ×©××™×œ×ª×•×ª ××•×¨×›×‘×•×ª</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id10">×¢×“×›×•×Ÿ ×§×‘×¦×™×</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id11">×¡×˜×˜×™×¡×˜×™×§×•×ª</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#id12">×˜×™×¤×•×œ ×‘×©×’×™××•×ª</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id13">×˜×™×¤×•×œ ×‘×©×’×™××•×ª ×‘×¡×™×¡×™</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#retry-logic">Retry Logic</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#id14">×‘×“×™×§×•×ª</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id15">×‘×“×™×§×ª ×™×—×™×“×”</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id16">×‘×“×™×§×ª ××™× ×˜×’×¨×¦×™×”</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#id17">×“×•×’×××•×ª ××ª×§×“××•×ª</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id18">×¢×™×‘×•×“ ×‘××¦×•×•×”</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id19">×§××©×™× ×’</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#api-curl">×©×™×ª×•×£ ×¦×™×‘×•×¨×™ ×“×¨×š ×”â€‘API (curl)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#markdown">×“×•×’××ª Markdown ××ª×§×“××ª ×œ×ª×¦×•×’×”</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../testing.html">Testing Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#quickstart">ğŸš€ Quickstart ×œ×˜×¡×˜×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#id1">×”× ×—×™×•×ª ×§×¨×™×˜×™×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#stubs">×˜×¢×™× ×ª Stubs ×œ×˜×œ×’×¨×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#tmp-path">×“×•×’××ª ×©×™××•×© ×‘â€‘tmp_path</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#id2">××—×™×§×” ×‘×˜×•×—×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#mocking-http-github-menu-handler">Mocking HTTP ×‘â€‘github_menu_handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#blueprint">×¨×™×©×•× Blueprint ×‘×¡×‘×™×‘×ª ×˜×¡×˜×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#pytest-cov">×›×™×¡×•×™ ×‘×“×™×§×•×ª (pytest-cov)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#ci">CI × ×ª××š</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#performance">×‘×“×™×§×•×ª ×‘×™×¦×•×¢×™× (Performance)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#id3">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../testing-rate-limit-examples.html">×“×•×’×××•×ª ×˜×¡×˜×™× â€“ Rate Limiting ×•××¡×™× ×›×¨×•× ×™×•×ª</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../testing-rate-limit-examples.html#rate-limiting-redis-mock">Rate Limiting (Redis Mock)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing-rate-limit-examples.html#id1">×˜×¡×˜×™× ××¡×™× ×›×¨×•× ×™×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../performance-tests.html">×‘×“×™×§×•×ª ×‘×™×¦×•×¢×™× (Performance Tests)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../performance-tests.html#id1">××˜×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance-tests.html#id2">×¡×™××•×Ÿ ×˜×¡×˜×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance-tests.html#id3">×”×¨×¦×” ××§×•××™×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance-tests.html#ci-github-actions">CI / GitHub Actions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance-tests.html#id4">×“×•×—×•×ª ×•×–×× ×™ ×¨×™×¦×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance-tests.html#id5">×˜×™×¤×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ci-cd.html">CI/CD Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../ci-cd.html#id1">×—×•×§×™× ×§×©×™×—×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ci-cd.html#id2">×¡×˜×˜×•×¡×™× × ×“×¨×©×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ci-cd.html#ci-overview">×¨×™×›×•×– CI (Overview)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ci-cd.html#id3">×‘×“×™×§×•×ª ××•××œ×¦×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ci-cd.html#id4">×‘× ×™×™×” ×©×œ ×”×ª×™×¢×•×“</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ci-cd.html#id5">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../conversation-handlers.html">Conversation Handlers &amp; States</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#id1">×¡×§×™×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#states">×¨×©×™××ª States (××‘×—×¨ ×‘×¤×•×¢×œ)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#save-flow">Save Flow (×ª×¨×©×™× ××¦×‘×™×)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#github-flow">GitHub Flow (×ª×¨×©×™× ××¦×‘×™×)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#bot">×¡×¤×¨×™×™×ª ×¡× ×™×¤×˜×™× â€“ ×–×¨×™××ª ×”×’×©×” (Bot)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#id2">×‘×™×˜×•×œ ×”×•×’×Ÿ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#id3">×”×ª×¨××•×ª ××“××™×Ÿ ×•×”×•×“×¢×ª ××©×ª××©</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#handler">×“×•×’××ª Handler ×ª××¦×™×ª×™×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#id4">×˜×‘×œ×ª ×–×¨×™××•×ª ××œ××”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#id5">×§×™×©×•×¨×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#id6">×“×•×’×××•×ª ×§×•×“ ×ª××¦×™×ª×™×•×ª (×××©×™×•×ª)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#save">Save â€“ ×©×œ×‘×™× ×¢×™×§×¨×™×™×</a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#github">GitHub â€“ ×ª×¤×¨×™×˜ ×•×©×™×—×ª ×”×¢×œ××”</a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#backup">Backup â€“ ×ª×¤×¨×™×˜</a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#drive">Drive â€“ ×ª×¤×¨×™×˜</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#id7">××•×§×©×™× × ×¤×•×¦×™× ×•×¤×ª×¨×•× ×•×ª</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#query-answer"><code class="docutils literal notranslate"><span class="pre">query.answer()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#message-is-not-modified">×¢×¨×™×›×ª ×”×•×“×¢×•×ª ×‘×‘×˜×—×” â€“ â€Message is not modifiedâ€œ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#filters">Filters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#persistent-data-context-user-data">Persistent data (<code class="docutils literal notranslate"><span class="pre">context.user_data</span></code>)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#id8">×“×•×’×××•×ª ×˜×¡×˜×™× ×§×¦×¨×•×ª</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#id9">Save â€“ ×”×ª×—×œ×” ×•×–×¨×™××” ×‘×¡×™×¡×™×ª</a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#github-upload-conv-handler">GitHub â€“ upload_conv_handler</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting.html">Troubleshooting Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#id1">×©×’×™××•×ª × ×¤×•×¦×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#importerror-telegram-conversationhandler-filters">ImportError ×‘×–××Ÿ ×˜×¡×˜×™× (telegram / ConversationHandler / filters)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#parse-mode">×©×’×™××•×ª parse_mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#asyncio-attached-to-a-different-loop-event-loop-is-closed">×©×’×™××•×ª asyncio: â€attached to a different loopâ€œ / â€Event loop is closedâ€œ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#id2">×“×™×‘×•×’ ××”×™×¨</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#mongodb">×‘×“×™×§×ª ×—×™×‘×•×¨ MongoDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#id3">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../development.html">Development Workflow</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../development.html#handler">×”×•×¡×¤×ª Handler ×—×“×©</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development.html#endpoint-webapp">×”×•×¡×¤×ª Endpoint ×œâ€‘WebApp</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development.html#schema">×¢×“×›×•×Ÿ Schema ×‘××¡×“ ×”× ×ª×•× ×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development.html#id1">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../development/pre-commit.html">Pre-commit Hooks</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../development/pre-commit.html#id1">××˜×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development/pre-commit.html#id2">×”×ª×§× ×” ×•×”×¨×¦×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development/pre-commit.html#hooks">Hooks ×¤×¢×™×œ×™× (×¢×™×§×¨×™×™×)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development/pre-commit.html#id3">×˜×™×¤×™× ×œ×¤×ª×¨×•×Ÿ ×‘×¢×™×•×ª</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../integrations.html">Integrations</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../integrations.html#github-api">GitHub API</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../integrations.html#gist">×™×¦×™×¨×ª Gist (×“×•×’××”)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../integrations.html#google-drive-oauth-flow">Google Drive (OAuth Flow)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integrations.html#telegram-webhooks-vs-polling">Telegram Webhooks vs Polling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integrations.html#id1">×§×™×©×•×¨×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integrations.html#github-scopes">GitHub â€“ Scopes × ×“×¨×©×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integrations.html#troubleshooting-github-rate-limits">Troubleshooting GitHub â€“ Rate limits</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integrations.html#github-cli-gh">GitHub CLI (gh) â€“ ×ª×§×¦×™×¨ ×§×¦×¨</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integrations.html#repository-providers">Repository Providers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integrations.html#best-practices-monorepos">Best Practices â€“ ×××’×¨×™× ×’×“×•×œ×™×/Monorepos</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../repository-integrations.html">Repository Integrations</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../repository-integrations.html#id1">×¡×§×™×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../repository-integrations.html#id2">××¦×‘ ×ª××™×›×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../repository-integrations.html#id3">×”×¢×¨×•×ª</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../security.html">Security Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../security.html#id1">×¡×•×“×•×ª ×•×¤×¨×˜×™×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security.html#id2">×”×¦×¤× ×ª ×˜×•×§× ×™× (×“×•×’××”)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security.html#csrf-webapp">CSRF ×‘â€‘WebApp</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security.html#rate-limiting">Rate Limiting (×“×•×’××”)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security.html#id3">×§×™×©×•×¨×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security.html#id4">××‘×˜×—×ª ×”×•×“×¢×•×ª ×‘×˜×œ×’×¨×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../monitoring.html">Smart Observability v7 â€“ Predictive Health &amp; Adaptive Feedback</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../monitoring.html#grafana-telegram-webhook">×—×™×‘×•×¨ Grafana â†’ Telegram (Webhook)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../monitoring.html#grafana-annotations">Grafana Annotations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../monitoring.html#adaptive-thresholds">Adaptive Thresholds (×¡×¤×™× ×“×™× ××™×™×)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../monitoring.html#predictive-health-v7">Predictive Health (v7)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../monitoring.html#safe-mode">SAFE_MODE ×•×“×™×œ×•×’ ×¢×œ ×¤×¢×•×œ×•×ª ×× ×¢</a></li>
<li class="toctree-l3"><a class="reference internal" href="../monitoring.html#chatops">ChatOps</a></li>
<li class="toctree-l3"><a class="reference internal" href="../monitoring.html#chatops-rate-limit">×”×¨×©××•×ª ChatOps ×•-Rate Limit</a></li>
<li class="toctree-l3"><a class="reference internal" href="../monitoring.html#grafana">Grafana â€“ ×™×™×‘×•× ×“×©×‘×•×¨×“ ×œ×“×•×’××”</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../monitoring.html#grafana-accuracy-prevention-panels">Grafana â€“ Accuracy &amp; Prevention Panels</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../monitoring.html#feedback-loop">×ª×¨×©×™× ×–×¨×™××ª Feedback Loop</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../monitoring.html#autoremediation-v5">Autoâ€‘Remediation (v5)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../monitoring.html#incident-memory">Incident Memory</a></li>
<li class="toctree-l3"><a class="reference internal" href="../monitoring.html#id1">Feedback Loop ×œ××™×¨×•×¢×™× ×—×•×–×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../monitoring.html#chatops-observe">ChatOps â€“ /observe</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../monitoring.html#id2">×”×¨×—×‘×•×ª ××¦×‘ ××¤×•×¨×˜</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../monitoring.html#endpoints">Endpoints</a></li>
<li class="toctree-l2"><a class="reference internal" href="../monitoring.html#id3">×§×™×©×•×¨×™× ×œ×ª×™×¢×•×“ ChatOps</a></li>
<li class="toctree-l2"><a class="reference internal" href="../monitoring.html#id4">×˜×™×¤×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../git-lfs.html">Git LFS Integration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../git-lfs.html#id1">××˜×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../git-lfs.html#lfs">××ª×™ ×œ×”×©×ª××© ×‘â€‘LFS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../git-lfs.html#id2">×”×ª×§× ×” ×‘×¡×™×¡×™×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../git-lfs.html#best-practices">Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../git-lfs.html#id3">××’×‘×œ×•×ª ×•×’×‘×•×œ×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../git-lfs.html#id4">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../user/bookmarks.html">×¡×™×× ×™×•×ª (Bookmarks)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../user/bookmarks.html#id1">××”×Ÿ ×¡×™×× ×™×•×ª?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/bookmarks.html#id2">××™×š ×œ×”×•×¡×™×£ ×¡×™×× ×™×™×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/bookmarks.html#id3">×¤×× ×œ ×”×¡×™×× ×™×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/bookmarks.html#anchor">Anchor ×™×¦×™×‘</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/bookmarks.html#id4">××’×‘×œ×•×ª, ××‘×˜×—×” ×•×¤×¨×˜×™×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/bookmarks.html#api">API ×§×¦×¨ (×œ××¤×ª×—×™×)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/bookmarks.html#id5">×”×¢×¨×•×ª ×©×™××•×©×™×•×ª</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../user/sticky_notes.html">×¤×ª×§×™× ×“×‘×™×§×™× (Sticky Notes)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../user/sticky_notes.html#id1">××”× ×¤×ª×§×™× ×“×‘×™×§×™×?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/sticky_notes.html#id2">××™×š ××•×¡×™×¤×™× ×•×× ×”×œ×™× ×¤×ª×§×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/sticky_notes.html#id3">×¢×™×’×•×Ÿ ×™×¦×™×‘ ×œ×¢×•××ª ××™×§×•× ×§×‘×•×¢</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/sticky_notes.html#id4">×©×™×œ×•×‘ ×¢× ×¡×™×× ×™×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/sticky_notes.html#id5">××’×‘×œ×•×ª, ×¤×¨×˜×™×•×ª ×•××‘×˜×—×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/sticky_notes.html#id6">×˜×™×¤×™× ×©×™××•×©×™×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/sticky_notes.html#api">API ×§×¦×¨ (×œ××¤×ª×—×™×)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/sticky_notes.html#reminders">×”×ª×¨××•×ª ×•×ª×–×›×•×¨×•×ª (Reminders)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../user/sticky_notes.html#id7">××™×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../user/sticky_notes.html#troubleshooting">Troubleshooting ×§×¦×¨</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../user/sticky_notes.html#id8">×‘×¢×™×•×ª × ×¤×•×¦×•×ª ×‘×ª×–×›×•×¨×•×ª</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../user/my_collections.html">×”××•×¡×¤×™× ×©×œ×™ (My Collections)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../user/my_collections.html#id1">××”× ××•×¡×¤×™×?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/my_collections.html#id2">×™×›×•×œ×•×ª ××¨×›×–×™×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/my_collections.html#id3">××™×š ××©×ª××©×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/my_collections.html#id4">×©×™×œ×•×‘ ×¢× ×¡×™×× ×™×•×ª ×•×¤×ª×§×™× ×“×‘×™×§×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/my_collections.html#id5">××’×‘×œ×•×ª ×•×¤×¨×˜×™×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/my_collections.html#api">API ×§×¦×¨ (×œ××¤×ª×—×™×)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/my_collections.html#id6">×˜×™×¤×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/my_collections.html#id7">××•×‘×™×™×œ/×˜××‘×œ×˜ â€“ ×’×¨×™×¨×” ×œ×¡×™×“×•×¨</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../user/share_code.html">×©×™×ª×•×£ ×§×•×“ (×—×©×•×‘)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#id2">××” ×–×” ×¢×•×©×”?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#id3">××™×¤×” ×”×›×¤×ª×•×¨ ××•×¤×™×¢?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#id4">××™×š ×–×” ×¢×•×‘×“ (×–×¨×™××”)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#env">×“×¨×™×©×•×ª ×¡×‘×™×‘×ª×™×•×ª (ENV)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#id5">××’×‘×œ×•×ª ×•×”×ª× ×”×’×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#id6">×”×•×“×¢×•×ª ×”×¦×œ×—×”/×©×’×™××”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#troubleshooting">Troubleshooting ×§×¦×¨</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#id7">×“×•×’×××•×ª (×˜×§×¡×˜×•××œ×™×•×ª)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../user/github_browse.html">×¢×™×•×Ÿ ×‘×§×•×“ GitHub (×›×•×œ×œ ×—×™×¤×•×© ×‘×©× ×§×•×‘×¥)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../user/github_browse.html#id1">×©×•×¨×ª ×›×œ×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/github_browse.html#id2">×ª×•×¦××•×ª ×—×™×¤×•×©</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/github_browse.html#id3">× ×™×•×•×˜ ×¨×™×¤×•</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../user/download_repo.html">×”×•×¨×“×ª ×¨×™×¤×•</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../user/download_repo.html#id2">××” ×‘×“×™×•×§ ××•×¨×™×“</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/download_repo.html#id3">××’×‘×œ×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/download_repo.html#id4">×”×•×“×¢×•×ª × ×¤×•×¦×•×ª</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../BOT_TEST_PLAN_CONTAINER.html">×ª×›× ×™×ª ×‘×“×™×§×•×ª ×œ×‘×•×˜ â€“ Composition Root (Container) ×œ×©×™×¨×•×ª Snippet</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../BOT_TEST_PLAN_CONTAINER.html#id1">××™×š ×œ×‘×“×•×§</a></li>
<li class="toctree-l2"><a class="reference internal" href="../BOT_TEST_PLAN_CONTAINER.html#copy-paste">×¡×˜ ×“×•×’×××•×ª ×œ×©××™×¨×” (Copy/Paste)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../BOT_TEST_PLAN_CONTAINER.html#id2">×‘×“×™×§×•×ª × ×•×¡×¤×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../BOT_TEST_PLAN_CONTAINER.html#id3">×ª×§×œ×•×ª ×©×›×“××™ ×œ×¢×§×•×‘ ××—×¨×™×”×Ÿ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../BOT_TEST_PLAN_CONTAINER.html#facade-container">×‘×“×™×§×•×ª ×–×¨×™××” ××•×¨×—×‘×•×ª (×œ××—×¨ ××¢×‘×¨ ×œ-Facade/Container)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../BOT_TEST_PLAN_CONTAINER.html#id4">1) ×©××™×¨×”/×ª×¦×•×’×”/×¢×¨×™×›×” (×§×‘×¦×™× ×¨×’×™×œ×™×)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../BOT_TEST_PLAN_CONTAINER.html#id5">2) ×§×‘×¦×™× ×’×“×•×œ×™×</a></li>
<li class="toctree-l3"><a class="reference internal" href="../BOT_TEST_PLAN_CONTAINER.html#id6">3) ××¡××›×™×/×”×¢×œ××•×ª</a></li>
<li class="toctree-l3"><a class="reference internal" href="../BOT_TEST_PLAN_CONTAINER.html#google-drive">4) Google Drive</a></li>
<li class="toctree-l3"><a class="reference internal" href="../BOT_TEST_PLAN_CONTAINER.html#chatops">5) ChatOps â€“ ×–×™×”×•×™ ×©×¤×” (×©×§×™×¤×•×ª ×•×“×™×‘×•×’)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../BOT_TEST_PLAN_CONTAINER.html#id7">6) ×¨×’×¨×¡×™×” ×›×œ×œ×™×ª</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">×–×¨×™××•×ª ×¢×‘×•×“×”:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../workflows/index.html">×–×¨×™××•×ª ×¢×‘×•×“×” (Workflows)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../workflows/index.html#id1">×¡×§×™×¨×” ×›×œ×œ×™×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../workflows/index.html#id2">×¨×©×™××ª ×–×¨×™××•×ª</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../workflows/save-flow.html">×–×¨×™××ª ×©××™×¨×ª ×§×•×“ (Save Flow)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../workflows/save-flow.html#id1">×¡×§×™×¨×” ×›×œ×œ×™×ª</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/save-flow.html#id2">××¦×‘×™ ×©××™×¨×”</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/save-flow.html#id3">×–×¨×™××ª ×¢×‘×•×“×” ×‘×¡×™×¡×™×ª</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/save-flow.html#long-collect">××¦×‘ ××™×¡×•×£ ××¨×•×š (LONG_COLLECT)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/save-flow.html#secrets-detection">×–×™×”×•×™ ×¡×•×“×•×ª (Secrets Detection)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/save-flow.html#id4">×˜×™×¤×•×œ ×‘×›×¤×™×œ×•×™×•×ª</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/save-flow.html#id5">× ×¨××•×œ ×§×•×“</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/save-flow.html#edge-cases">Edge Cases</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/save-flow.html#id6">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../workflows/search-flow.html">×–×¨×™××ª ×—×™×¤×•×© (Search Flow)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../workflows/search-flow.html#id1">×¡×§×™×¨×” ×›×œ×œ×™×ª</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/search-flow.html#id2">×¡×•×’×™ ×—×™×¤×•×©</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/search-flow.html#id3">×–×¨×™××ª ×¢×‘×•×“×”</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/search-flow.html#searchindex">××‘× ×” SearchIndex</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/search-flow.html#id4">×¤×™×œ×˜×¨×™×</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/search-flow.html#regex">×˜×™×¤×•×œ ×‘×©×’×™××•×ª Regex</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/search-flow.html#id5">××™×•×Ÿ ×ª×•×¦××•×ª</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/search-flow.html#relevance-score">×—×™×©×•×‘ Relevance Score</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/search-flow.html#edge-cases">Edge Cases</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/search-flow.html#id6">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../workflows/refactor-flow.html">×–×¨×™××ª ×¨×¤×§×˜×•×¨×™× ×’ (Refactor Flow)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#id1">×¡×§×™×¨×” ×›×œ×œ×™×ª</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#id2">×¡×•×’×™ ×¨×¤×§×˜×•×¨×™× ×’</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#id3">×–×¨×™××ª ×¢×‘×•×“×”</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#telegram">×©×™××•×© ×‘×‘×•×˜ (Telegram)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#codeanalyzer">CodeAnalyzer</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#id4">×™×¦×™×¨×ª ×”×¦×¢×ª ×¨×¤×§×˜×•×¨×™× ×’</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#id5">××™××•×ª ×œ×¤× ×™ ×•××—×¨×™</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#id6">×™×™×¦×•× ×œ×’×™×¡×˜ (××•×¤×¦×™×•× ×œ×™)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#id7">×©××™×¨×ª ×’×¨×¡×”</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#edge-cases">Edge Cases</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#cohesion-policy">××“×™× ×™×•×ª ×§×™×‘×•×¥ ×•×¤×™×¦×•×œ (Cohesion Policy)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#smart-clustering-cycle-guard">Smart Clustering ×•â€‘Cycle Guard</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#safe-decomposition-models-py">Safe Decomposition ×œâ€‘models.py</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#canonical">×©××•×ª ×§×‘×¦×™× ×“×•××™×™× ×™×™× (Canonical)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#layered">××¦×‘ ×©×›×‘×•×ª (Layered)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#id8">×¤×¨××˜×¨×™× × ×™×ª× ×™× ×œ×›×•×•× ×•×Ÿ</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#id9">××’×‘×œ×•×ª ×™×“×•×¢×•×ª</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#id10">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../workflows/backup-flow.html">×–×¨×™××ª ×’×™×‘×•×™ ×•×©×—×–×•×¨ (Backup Flow)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../workflows/backup-flow.html#id1">×¡×§×™×¨×” ×›×œ×œ×™×ª</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/backup-flow.html#id2">×¡×•×’×™ ×’×™×‘×•×™×™×</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/backup-flow.html#id3">×™×¦×™×¨×ª ×’×™×‘×•×™ ××œ×</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/backup-flow.html#id4">×©×—×–×•×¨ ××’×™×‘×•×™</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/backup-flow.html#google-drive">×’×™×‘×•×™ ×œ-Google Drive</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/backup-flow.html#id5">× ×™×”×•×œ ×’×™×‘×•×™×™×</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/backup-flow.html#zip">×™×™×‘×•× ZIP ×—×™×¦×•× ×™</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/backup-flow.html#edge-cases">Edge Cases</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/backup-flow.html#id6">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../workflows/index.html#id3">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">×× ×•×¢×™ ×”××¢×¨×›×ª:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../engines/overview.html">×× ×•×¢×™ ×”××¢×¨×›×ª (System Engines)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../engines/overview.html#id1">×¡×§×™×¨×” ×›×œ×œ×™×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../engines/overview.html#search-engine">×× ×•×¢ ×—×™×¤×•×© (Search Engine)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../engines/overview.html#refactoring-engine">×× ×•×¢ ×¨×¤×§×˜×•×¨×™× ×’ (Refactoring Engine)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../engines/overview.html#smart-clustering-cycle-guard">×™×›×•×œ×•×ª ××ª×§×“××•×ª (Smart Clustering, Cycle Guard)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../engines/overview.html#layered-mode">××¦×‘ ×©×›×‘×•×ª (Layered Mode)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../engines/overview.html#safe-decomposition-models-py-models">Safe Decomposition ×œâ€‘models.py (×¤×™×¦×•×œ ×‘×˜×•×— ×œ×—×‘×™×œ×ª models/)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../engines/overview.html#code-processor">××¢×‘×“ ×§×•×“ (Code Processor)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../engines/overview.html#code-analyzer">×× ×•×¢ × ×™×ª×•×— (Code Analyzer)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../engines/overview.html#backup-service">×× ×•×¢ ×’×™×‘×•×™×™× (Backup Service)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../engines/overview.html#integration-services">×× ×•×¢ ××™× ×˜×’×¨×¦×™×•×ª (Integration Services)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../engines/overview.html#observability">×× ×•×¢ Observability</a></li>
<li class="toctree-l2"><a class="reference internal" href="../engines/overview.html#id2">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Edge Cases ×•×˜×™×¤×•×œ ×‘×©×’×™××•×ª:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../edge-cases.html">Edge Cases ×•×˜×™×¤×•×œ ×‘×©×’×™××•×ª</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../edge-cases.html#id1">×¡×§×™×¨×” ×›×œ×œ×™×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../edge-cases.html#id2">×§×‘×¦×™× ×’×“×•×œ×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../edge-cases.html#id3">×§×™×“×•×“×™× ×œ× ×¡×˜× ×“×¨×˜×™×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../edge-cases.html#github-rate-limits">GitHub Rate Limits</a></li>
<li class="toctree-l2"><a class="reference internal" href="../edge-cases.html#mongodb-connection-errors">MongoDB Connection Errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../edge-cases.html#redis-unavailability">Redis Unavailability</a></li>
<li class="toctree-l2"><a class="reference internal" href="../edge-cases.html#parsing">×©×’×™××•×ª Parsing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../edge-cases.html#file-i-o">×©×’×™××•×ª File I/O</a></li>
<li class="toctree-l2"><a class="reference internal" href="../edge-cases.html#network">×©×’×™××•×ª Network</a></li>
<li class="toctree-l2"><a class="reference internal" href="../edge-cases.html#validation">×©×’×™××•×ª Validation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../edge-cases.html#concurrent-access">×©×’×™××•×ª Concurrent Access</a></li>
<li class="toctree-l2"><a class="reference internal" href="../edge-cases.html#best-practices">Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../edge-cases.html#id4">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">××™×›×•×ª ×•×§×•× ×‘× ×¦×™×•×ª:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quality/type-safety.html">ğŸ“ Type Hints â€“ Best Practices</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../quality/type-safety.html#id1">××¡×˜×¨×˜×’×™×”: ×”×§×©×—×” ×”×“×¨×’×ª×™×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quality/type-safety.html#id2">×¤×¨×•×˜×•×§×•×œ×™× ×•×¡×˜××‘×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quality/type-safety.html#id3">×“×•×’×××•×ª ××”×§×•×“</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quality/type-safety.html#mypy">×”×’×“×¨×•×ª MyPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quality/type-safety.html#id4">××¡×œ×•×œ ××™×’×¨×¦×™×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quality/type-safety.html#id5">×”× ×—×™×•×ª ×œ×¡×•×›× ×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quality/type-safety.html#id6">×“×•×’×××•×ª ×§×¦×¨×•×ª</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../quality/code-normalization.html">× ×¨××•×œ ×§×•×“ (Code Normalization)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../quality/code-normalization.html#id1">×œ××” ×‘×›×œ×œ ×× ×¨××œ×™×?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quality/code-normalization.html#id2">××ª×™ ×•××™×¤×” ×”×× ×’× ×•×Ÿ ×¨×¥?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quality/code-normalization.html#id3">××” ×‘×“×™×•×§ ×§×•×¨×” ×‘××”×œ×š ×”× ×¨××•×œ?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quality/code-normalization.html#api">××™×š ×œ×‘×—×•×¨ API?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quality/code-normalization.html#id4">×“×’×©×™× ×œ×¡×•×›× ×™× ×‘×¢×ª ×›×ª×™×‘×ª ×§×•×“</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quality/code-normalization.html#id5">×˜×¡×˜×™×, ×“×™×‘×•×’ ×•×©×—×–×•×¨ ×ª×§×œ×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quality/code-normalization.html#id6">×©××œ×•×ª × ×¤×•×¦×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quality/code-normalization.html#id7">××” ×œ×¢×©×•×ª ×›×©××•×¡×™×¤×™× ×–×¨×™××” ×—×“×©×”?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quality/code-normalization.html#id8">×§×™×©×•×¨×™× ×¨×œ×•×•× ×˜×™×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ARCHITECTURE_LAYER_RULES.html">×›×œ×œ×™ ×©×›×‘×•×ª â€“ CodeBot</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../ARCHITECTURE_LAYER_RULES.html#id1">×©×›×‘×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ARCHITECTURE_LAYER_RULES.html#composition-root">Composition Root</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ARCHITECTURE_LAYER_RULES.html#id2">×–×™×”×•×™ ×©×¤×” â€“ ××§×•×¨ ×××ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ARCHITECTURE_LAYER_RULES.html#id3">×‘×“×™×§×•×ª ××›×™×¤×”</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">WebApp:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../webapp/overview.html">×”××™× ×™ Web App (×¡×§×™×¨×”)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/overview.html#id1">××” × ×•×ª×Ÿ?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/overview.html#id2">×“×©×‘×•×¨×“ ×—×“×©</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../webapp/overview.html#id3">××™×™×§×•× ×™ ×©×¤×” ××—×™×“×™×</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../webapp/overview.html#id4">×˜×‘×œ×ª ××™×™×§×•× ×™× × ×¤×•×¦×™×</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/overview.html#ai">×”× ×—×™×•×ª ×œ×¡×•×›× ×™ AI</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/overview.html#id5">×›×ª×•×‘×ª ×•×”×¨×©××•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/overview.html#env">×”×’×“×¨×•×ª ENV</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/overview.html#id6">×§×™×©×•×¨×™× ×•×ª××•× ×•×ª ××¡×š</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/overview.html#id7">×¨××• ×’×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/overview.html#id8">×‘×× ×¨ ×”×›×¨×–×•×ª ×‘×¨××© ×”××¡×š</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../webapp/overview.html#id9">××™×š ××¤×¢×™×œ×™×?</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/overview.html#id10">×”×¢×¨×•×ª ×•×§×™×©×•×¨×™×</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/overview.html#id11">××” ×§×•×¨×” ×××—×•×¨×™ ×”×§×œ×¢×™×?</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/overview.html#id12">×›×™×‘×•×™ ×–×× ×™</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/overview.html#id13">×”××œ×¦×•×ª ×œ×ª×•×›×Ÿ</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../DEV_WEB_PUSH.html">Web Push â€“ Sticky Notes Reminders</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../DEV_WEB_PUSH.html#id1">×“×¨×™×©×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../DEV_WEB_PUSH.html#vapid">×”×’×“×¨×ª ××¤×ª×—×•×ª VAPID</a></li>
<li class="toctree-l2"><a class="reference internal" href="../DEV_WEB_PUSH.html#id2">×”×¤×¢×œ×”/×›×™×‘×•×™</a></li>
<li class="toctree-l2"><a class="reference internal" href="../DEV_WEB_PUSH.html#remote-worker">××¦×‘ Remote Worker (××•××œ×¥ ×œ×¤×¨×•×“×§×©×Ÿ)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../DEV_WEB_PUSH.html#sidecar-render">×—×œ×•×¤×”: Sidecar (×œ×œ× ×©×™×¨×•×ª Render × ×•×¡×£)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../DEV_WEB_PUSH.html#server">× ×§×•×“×•×ª ×§×¦×” (Server)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../DEV_WEB_PUSH.html#service-worker">Service Worker</a></li>
<li class="toctree-l2"><a class="reference internal" href="../DEV_WEB_PUSH.html#id3">×¦×“â€‘×œ×§×•×—</a></li>
<li class="toctree-l2"><a class="reference internal" href="../DEV_WEB_PUSH.html#id4">×©×œ×™×—×” ×‘×–××Ÿ ×××ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../DEV_WEB_PUSH.html#id5">×‘×“×™×§×•×ª</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/user-interfaces.html">×××©×§×™ ××©×ª××©×™× (Web)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/user-interfaces.html#id1">××” ×–×”?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/user-interfaces.html#id2">×”×™×›×Ÿ ×–×” × ××¦×?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/user-interfaces.html#id3">×–×¨×™××ª ×¢×‘×•×“×” ×“×¨×š ×”×‘×•×˜</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/user-interfaces.html#id4">×©×“×•×ª ×—×•×‘×” ×•×œ×•×’×™×§×ª ×•×œ×™×“×¦×™×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/user-interfaces.html#id5">×—×™×•×•×™ ××¦×‘ ×ª×”×œ×™×š</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/user-interfaces.html#id6">×××©×§ ××“××™×Ÿ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/user-interfaces.html#ai">×“×•×’×××•×ª ×©×™××•×© ×œ×¡×•×›× ×™ AI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/user-interfaces.html#id7">××‘×˜×—×” ×•×¤×¨×˜×™×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/user-interfaces.html#id8">×”×¢×¨×•×ª ×ª××™××•×ª</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/snippet-library.html">×¡×¤×¨×™×™×ª ×¡× ×™×¤×˜×™× (Web)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/snippet-library.html#id1">××” ×–×”?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/snippet-library.html#ui">×××¤×™×™× ×™ UI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/snippet-library.html#api-json">API â€“ JSON</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../webapp/snippet-library.html#openapi">OpenAPI (×ª×§×¦×™×¨)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/snippet-library.html#json-schema-response">JSON Schema (Response)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/snippet-library.html#id2">×›×œ×œ×™ ×“×¤×“×•×£/×¡×¤×™×¨×”</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/snippet-library.html#id3">×©×’×™××•×ª</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/snippet-library.html#curl">×“×•×’×××•×ª cURL</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/snippet-library.html#id4">×”×’×©×•×ª, ××™×©×•×¨ ×•× ×™×”×•×œ (××“××™×Ÿ)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/snippet-library.html#id5">×™×™×‘×•× ××¡××š (××“××™×Ÿ)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/snippet-library.html#id6">×”×’×©×” ×“×¨×š ×”×‘×•×˜</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/snippet-library.html#id7">UI ×‘×‘×•×˜ â€“ ×”×¡×¨×•×ª ×•×©×™×¤×•×¨×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/snippet-library.html#id8">×’×¨×¡×” ××©×•×“×¨×’×ª â€“ ××” ×—×“×©</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/snippet-library.html#ai">××“×¨×™×š ×§×¦×¨ ×œ×¡×•×›× ×™ AI</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/onboarding.html">ğŸ‰ Onboarding (Welcome Modal) â€“ WebApp</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/onboarding.html#id1">××˜×¨×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/onboarding.html#id2">×–×¨×™××ª ××©×ª××©</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/onboarding.html#anchors">×§×™×©×•×¨×™ ××“×¨×™×›×™× (Anchors)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/onboarding.html#best-practices">Best Practices â€“ ××™× ×“×™×§×¦×™×” ×œ××©×ª××©×™× ×—×“×©×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/onboarding.html#js-ajax">×“×•×’××ª JS â€“ ××•×“××œ ×¢× Ajax</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/onboarding.html#api">API ×§×©×•×¨</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/onboarding.html#id3">××“×™×”</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/caching.html">Caching &amp; HTTP Validators (ETag / Last-Modified / 304)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#id1">×œ××” ×–×” ×—×©×•×‘?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#id2">×¢×§×¨×•× ×•×ª ×‘×¡×™×¡</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#flask-werkzeug">××ª×›×•×Ÿ: Flask + werkzeug</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#copypaste">×‘×“×™×§×•×ª ×™×“× ×™×•×ª (Copyâ€‘Paste)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#checklist">Checklist ×œ××™××•×© × ×›×•×Ÿ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#gotchas">Gotchas × ×¤×•×¦×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#cache-control">×©×™×œ×•×‘ ×¢× Cache-Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#id3">×§×™×©×•×¨×™× × ×•×¡×¤×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/advanced-caching.html">××¢×¨×›×ª Caching ××ª×§×“××ª ×¢× TTL ×“×™× ××™</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/advanced-caching.html#id1">×¢×§×¨×•× ×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/advanced-caching.html#id2">×§×•×“ ×œ×“×•×’××”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/advanced-caching.html#id3">×“×’×©×™× ×ª×¤×¢×•×œ×™×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/advanced-caching.html#id4">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/static-checklist.html">Static Performance &amp; Security Checklist (gzip/br, Cache, SRI)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/static-checklist.html#id1">××˜×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/static-checklist.html#br-gzip">×“×—×™×¡×” (br/gzip)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/static-checklist.html#cache-control">×›×•×ª×¨×•×ª Cache-Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/static-checklist.html#subresource-integrity-sri">Subresource Integrity (SRI)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/static-checklist.html#copypaste">×‘×“×™×§×•×ª ×™×“× ×™×•×ª (Copyâ€‘Paste)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/static-checklist.html#best-practices">Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/static-checklist.html#gotchas">Gotchas</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/api-reference.html">WebApp API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/api-reference.html#endpoints">Endpoints</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/api-reference.html#authentication-flow">Authentication Flow</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/api-reference.html#response-schema-example">Response Schema Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/api-reference.html#errors">Errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/api-reference.html#post-api-shared-save">×©×’×™××•×ª × ×¤×•×¦×•×ª â€“ <code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/api/shared/save</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/api-reference.html#id1">×§×™×©×•×¨×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/api-reference.html#files">××¡× ×Ÿ ×•×©×“×•×ª ×§×œ×˜ ×œ-<code class="docutils literal notranslate"><span class="pre">/files</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../webapp/api-reference.html#id2">×˜×‘×œ×ª ×¤×¨××˜×¨×™×</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/api-reference.html#id3">×“×•×’×××•×ª ×‘×§×©×”</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/api-reference.html#id4">×“×•×’×××•×ª ×ª×’×•×‘×”</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/bulk-actions.html">Bulk actions (×‘×—×™×¨×” ××¨×•×‘×”)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/bulk-actions.html#id1">×¡×§×™×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/bulk-actions.html#endpoints">Endpoints</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../webapp/bulk-actions.html#post-api-files-bulk-favorite"><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/api/files/bulk-favorite</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/bulk-actions.html#post-api-files-bulk-unfavorite"><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/api/files/bulk-unfavorite</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/bulk-actions.html#post-api-files-bulk-tag"><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/api/files/bulk-tag</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/bulk-actions.html#post-api-files-create-zip"><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/api/files/create-zip</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/bulk-actions.html#post-api-files-bulk-delete-soft-delete"><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/api/files/bulk-delete</span></code> (Soft Delete)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/bulk-actions.html#post-api-files-create-share-link"><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/api/files/create-share-link</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/bulk-actions.html#id2">×©×’×™××•×ª × ×¤×•×¦×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/bulk-actions.html#id3">×”×¢×¨×•×ª ×œ××¤×ª×—×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/editor.html">âŒ¨ï¸ ×¢×•×¨×š ×§×•×“ (WebApp Editor)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/editor.html#codemirror-isloading">×˜×¢×™× ×ª CodeMirror ×•××¦×‘ isLoading</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/editor.html#api">×©××™×¨×ª ×”×¢×“×¤×•×ª ××©×ª××© â€“ ×©× ×™ × ×ª×™×‘×™ API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/editor.html#id1">×”××œ×¦×•×ª</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/markdown-folding.html">Markdown â€“ ××¦×‘ ××¦×•××¦× (×§×™×¤×•×œ ×›×•×ª×¨×•×ª ###) â€“ ××“××™×Ÿ ×‘×œ×‘×“</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/markdown-folding.html#id1">×××¤×™×™× ×™× ×¢×™×§×¨×™×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/markdown-folding.html#id2">×”×–×¨×§×ª ×“×’×œ ×”×¨×©××” ×œ×ª×‘× ×™×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/markdown-folding.html#id3">×¢×§×¨×•× ×•×ª ×”××™××•×© ×‘×¦×“ ×”×œ×§×•×—</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/markdown-folding.html#id4">×¦â€™×§â€‘×œ×™×¡×˜ ×œ×¤×™×¦â€™×¨×™× ××§×•××™×™× ×“×•××™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/smooth-scrolling.html">Smooth Scrolling (WebApp) â€” ××“×¨×™×š ×ª××¦×™×ª×™ ×œ×¡×•×›× ×™ AI</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/smooth-scrolling.html#id1">××” ×¤×¢×™×œ ×›×‘×¨</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/smooth-scrolling.html#api">API ×œ×©×™××•×© ×§×œ×™×™× ×˜</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/smooth-scrolling.html#id2">×©××™×¨×ª ×”×¢×“×¤×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/smooth-scrolling.html#id3">×××©×§ ×”×’×“×¨×•×ª ××•×‘× ×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/smooth-scrolling.html#ai">×”× ×—×™×•×ª ×œ×¡×•×›× ×™ AI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/smooth-scrolling.html#id4">×× ×“×¨×•××™×“ â€” ××” ×™×© ×•××” ×œ×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/smooth-scrolling.html#id5">× ×’×™×©×•×ª ×•×‘×™×¦×•×¢×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/smooth-scrolling.html#id6">×¤×ª×¨×•×Ÿ ×ª×§×œ×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/smooth-scrolling.html#roadmap">×ª×•×›× ×™×ª ×”××©×š (Roadmap ××§×•×¦×¨)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/smooth-scrolling.html#id7">×§×™×©×•×¨×™× ×¤× ×™××™×™×</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Observability</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../observability.html">××•×‘×–×¨×•×•×‘×™×œ×™×•×ª (Observability)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../observability.html#id1">××˜×¨×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability.html#id2">×§×”×œ×™ ×™×¢×“</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability.html#id3">×ª×¦×•×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability.html#backend-traces">×‘×—×™×¨×ª Backend ×œÖ¾Traces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability.html#otlp">×”×’×“×¨×ª OTLP ×œ×¡×‘×™×‘×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability.html#id4">×§×™×©×•×¨×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability.html#manual-instrumentation">××™× ×¡×˜×¨×•×× ×˜×¦×™×” ×™×“× ×™×ª (Manual Instrumentation)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability.html#jaeger">×“×•×§×¨ ×§×•××¤×•×– â€“ ×”×¤×¢×œ×” ××”×™×¨×” ×¢× Jaeger</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../observability.html#quick-start-jaeger">Quick start â€“ ××™××•×ª ×¡×¤×× ×™× ×‘Ö¾Jaeger</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../observability.html#traced">×›×™×¡×•×™ ×“×§×•×¨×˜×•×¨ &#64;traced</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability.html#staging">××™××•×ª ×‘-Staging</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../rate-limiting.html">Rate Limiting</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../rate-limiting.html#id1">××‘×•×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rate-limiting.html#shadow-mode">Shadow Mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rate-limiting.html#softwarning-80">Softâ€‘Warning (80%)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rate-limiting.html#admin-bypass">Admin Bypass</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rate-limiting.html#monitoring">Monitoring</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rate-limiting.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rate-limiting.html#id2">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../observability/guidelines.html">ğŸ“Š ×”× ×—×™×•×ª Observability ×•××™×¨×•×¢×™×</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../observability/guidelines.html#id1">×ª×‘× ×™×ª ××™×¨×•×¢/×œ×•×’ â€“ ×©×“×•×ª ×—×•×‘×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/guidelines.html#fail-open">×¢×§×¨×•×Ÿ Fail-Open</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/guidelines.html#id2">×”× ×—×™×•×ª ×˜×™×¤×•×œ ×‘×©×’×™××•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/guidelines.html#request-id">×§×•×¨×œ×¦×™×” ×¢× request_id</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/guidelines.html#id3">×¡×˜× ×“×¨×˜×™× × ×•×¡×¤×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../logging_schema.html">×¡×›××ª ×œ×•×’×™× ×•××™×¨×•×¢×™× (Observability)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../logging_schema.html#id1">×©×“×•×ª ×—×•×‘×” ×‘×›×œ ××™×¨×•×¢</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logging_schema.html#id2">×©×“×•×ª ××•××œ×¦×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logging_schema.html#id3">××™×¨×•×¢×™× ××¨×›×–×™×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logging_schema.html#sampling">×“×’×™××” (Sampling)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logging_schema.html#id4">×¤×¨×˜×™×•×ª</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../metrics.html">××“×“×™× (Metrics)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../metrics.html#id1">× ×§×•×“×ª ×§×¦×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metrics.html#id2">××˜×¨×™×§×•×ª ×§×™×™××•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metrics.html#codebot-handlers-commands-db">××“×“×™ CodeBot ×™×™×¢×•×“×™×™× (Handlers/Commands/DB)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metrics.html#opentelemetry">××˜×¨×™×§×•×ª OpenTelemetry (×× ×–××™× ×•×ª)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metrics.html#promql">×“×•×’×××•×ª PromQL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metrics.html#tracing-grafana">Tracing ×‘-Grafana</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metrics.html#slo-sli">SLO/SLI ×œ×“×•×’××”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metrics.html#prometheus-alerting-rules">×”×ª×¨××•×ª (Prometheus alerting rules)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../resilience.html">Resilience ×œ×©×™×¨×•×ª×™× ×—×™×¦×•× ×™×™×</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../resilience.html#id1">×œ××” ×©×›×‘×” ××¨×•×›×–×ª?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../resilience.html#id2">××™×š ×–×” ×¢×•×‘×“?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../resilience.html#env">×§×•× ×¤×™×’×•×¨×¦×™×” ×—×©×•×‘×” (ENV)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../resilience.html#id3">×˜×™×¤</a></li>
<li class="toctree-l2"><a class="reference internal" href="../resilience.html#id4">×©×™××•×© ×‘×§×•×“</a></li>
<li class="toctree-l2"><a class="reference internal" href="../resilience.html#id5">×¨××• ×’×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../alerts.html">×”×ª×¨××•×ª (Alerts)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../alerts.html#id1">×¡×§×™×¨×” ××”×™×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../alerts.html#id2">×—×•×§×™ ×‘×¨×™×¨×ª ×”××—×“×œ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../alerts.html#id3">×”×ª×××” ×œ×¦×¨×›×™× ×©×œ×š</a></li>
<li class="toctree-l2"><a class="reference internal" href="../alerts.html#alert-manager">×§×•× ×¤×™×’×•×¨×¦×™×™×ª <code class="docutils literal notranslate"><span class="pre">alert_manager</span></code> ×‘××¤×œ×™×§×¦×™×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../alerts.html#id4">×˜×¢×™× ×ª ×©×™× ×•×™×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../alerts.html#id5">×‘×“×™×§×ª ×”×–×¨×™××” ×‘×§×¦×” ×”×©× ×™</a></li>
<li class="toctree-l2"><a class="reference internal" href="../alerts.html#id6">×˜×™×¤×™× ××—×¨×•× ×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../alerts.html#id7">×¨××• ×’×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../alerts.html#id8">×”×ª×¨××•×ª ××¢×¨×›×ª â€“ ×“×™×¡×§ ×›××¢×˜ ××œ×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../observability/log_based_alerts.html">×”×ª×¨××•×ª ××‘×•×¡×¡×•×ª ×œ×•×’×™× (Logâ€‘based Alerts)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#id1">××” ×–×” ×•×œ××”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#id2">×”×¨×›×™×‘×™× ×‘×§×•×“</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#id3">×§×‘×¦×™ ×§×•× ×¤×™×’</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../observability/log_based_alerts.html#config-error-signatures-yml">×“×•×’××” ××™× ×™××œ×™×ª: <code class="docutils literal notranslate"><span class="pre">config/error_signatures.yml</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../observability/log_based_alerts.html#config-alerts-yml">×“×•×’××” ××™× ×™××œ×™×ª: <code class="docutils literal notranslate"><span class="pre">config/alerts.yml</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#option-b">Option B â€“ ×—×™×‘×•×¨ ×‘×ª×•×š ×”×§×•×“ (××•××©)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../observability/log_based_alerts.html#id4">××©×ª× ×™ ×¡×‘×™×‘×”</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#option-a-sidecar">Option A â€“ Sidecar ××–×¨× ×œ×•×’×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#id5">×¡×¤×™× ×•×§×™×‘×•×¥ â€“ ×‘×¨×™×¨×•×ª ××—×“×œ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#fingerprint">××¡×˜×¨×˜×’×™×™×ª fingerprint ×•×§× ×•× ×™×§×œ×™×–×¦×™×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#id6">×¦â€™×§×œ×™×¡×˜ ×œ××¤×ª×—×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#id7">×‘×“×™×§×” ××§×•××™×ª (×¡×™××•×œ×¦×™×”)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#ai">×”× ×—×™×•×ª ×œ×¡×•×›× ×™ AI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#id8">××‘×˜×—×” ×•×¤×¨×˜×™×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#rollout">Rollout ××•××œ×¥</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#id9">×¨××• ×’×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#id10">×§×™×©×•×¨×™× ×œ×§×•×“</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#id11">×˜×§×¡×•× ×•××™×™×ª ×©×’×™××•×ª ×•×—×ª×™××•×ª</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../observability/log_based_alerts.html#id12">×ª×¨×©×™× ×–×¨×™××” ××§×•×¦×¨</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#chatops">×ª×¦×•×’×” ×‘â€‘ChatOps</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../observability/log_based_alerts.html#placeholder">×¤×œ×˜ ×œ×“×•×’××” (Placeholder)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#classify-error">×§×¨×™××ª ×”××©×š â€“ <code class="docutils literal notranslate"><span class="pre">classify_error()</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../sentry.html">Sentry</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../sentry.html#id1">×”×¤×¢×œ×” (××©×ª× ×™ ×¡×‘×™×‘×”)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sentry.html#id2">×¢×§×¨×•× ×•×ª</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../runbooks/incident-checklist.html">Incident Checklist (Onâ€‘Call)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/incident-checklist.html#incident">×‘×¢×ª ×¤×ª×™×—×ª Incident</a></li>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/incident-checklist.html#id1">×¡×˜×˜×•×¡×™ ××¢×§×‘ ××—×™×“×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/incident-checklist.html#id2">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../runbooks/logging-levels.html">×©×™× ×•×™ ×¨××•×ª ×œ×•×’×™×</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/logging-levels.html#debug">××ª×™ ×œ×”×¢×œ×•×ª ×œ-DEBUG</a></li>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/logging-levels.html#id2">×˜×™×¤</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../runbooks/github_backup_restore.html">GitHub Backup &amp; Restore Runbook</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/github_backup_restore.html#id1">××˜×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/github_backup_restore.html#id2">×“×¨×™×©×•×ª ××§×“×™××•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/github_backup_restore.html#checkpoint-tag">×™×¦×™×¨×ª × ×§×•×“×ª ×’×™×‘×•×™ (Checkpoint Tag)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/github_backup_restore.html#zip">×™×¦×™×¨×ª ××¨×›×™×•×Ÿ ZIP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/github_backup_restore.html#id3">×©×—×–×•×¨ â€“ ×‘×“×™×§×” ××§×•××™×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/github_backup_restore.html#id4">×©×—×–×•×¨ ××œ× ×œ×¤×¨×•×“×§×©×Ÿ (×–×”×™×¨×•×ª!)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/github_backup_restore.html#id5">×©×—×–×•×¨ ×§×‘×¦×™×/×ª×™×§×™×•×ª × ×§×•×“×ª×™×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/github_backup_restore.html#id6">×˜×™×¤×™× ×•×‘×˜×™×—×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/github_backup_restore.html#id7">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../runbooks/slo.html">Runbooks â€“ SLO Incidents</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/slo.html#higherrorrate">HighErrorRate</a></li>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/slo.html#sloavailabilitybreach-99-9">SLOAvailabilityBreach (×–××™× ×•×ª &lt; 99.9%)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/slo.html#slolatencyp95breach-p95-0-5s">SLOLatencyP95Breach (P95 &gt; 0.5s)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/slo.html#id1">×“×©×‘×•×¨×“</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ChatOps</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../chatops/overview.html">ChatOps â€“ ×¡×§×™×¨×” ×›×œ×œ×™×ª</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../chatops/overview.html#id1">×¢×§×¨×•× ×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/overview.html#id2">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../chatops/commands.html">×¤×§×•×“×•×ª ChatOps</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#status">/status</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#errors">/errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#mappings">×¡×˜×˜×•×¡×™ ×ª×•×¦××•×ª (Mappings)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#triage">/triage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#predict">/predict</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#observe-v">/observe -v (××¤×•×¨×˜)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#observe-vv">/observe -vv (××¤×•×¨×˜ ×××•×“)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#rate-limit">/rate_limit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#lang">/lang</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#lang-debug">/lang_debug</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#dm">/dm</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../chatops/observe.html">ChatOps â€“ /observe: ×”×¨×—×‘×•×ª -v ×•- -vv</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../chatops/observe.html#id1">×ª×—×‘×™×¨ ×•×¤×¨××˜×¨×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/observe.html#id2">×“×•×’×××•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/observe.html#v">×¤×œ×˜ ×œ×“×•×’××” â€“ â€-v</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/observe.html#vv">×¤×œ×˜ ×œ×“×•×’××” â€“ â€-vv</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/observe.html#id3">×”×¢×¨×•×ª ×©×™××•×©</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/observe.html#id4">×§×™×©×•×¨×™× ×¨×œ×•×•× ×˜×™×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../chatops/playbooks.html">Playbooks â€“ ×ª×¨×—×™×©×™× × ×¤×•×¦×™×</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../chatops/playbooks.html#p95-latency">p95 Latency ×¢×œ×” ××¢×œ ×”×¡×£</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/playbooks.html#error-rate-1">Error Rate &gt; 1%</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/playbooks.html#memory-usage">Memory Usage ××˜×¤×¡</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/playbooks.html#id1">×©×™×¨×•×ª ×—×™×¦×•× ×™ ××™×˜×™</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/playbooks.html#repeated-incident-15">Repeated Incident ×ª×—×ª 15 ×“×§Â«</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../chatops/permissions.html">×”×¨×©××•×ª ×•-Rate Limit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chatops/troubleshooting.html">×¤×ª×¨×•×Ÿ ×ª×§×œ×•×ª (FAQ)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chatops/faq.html">×©××œ×•×ª × ×¤×•×¦×•×ª</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">×¡×•×›× ×™ AI:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../ai-agents/guide.html">ğŸ¤– ××“×¨×™×š ×œ×¡×•×›× ×™ AI</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../ai-agents/guide.html#id1">× ×§×•×“×ª ×¤×ª×™×—×” ××”×™×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ai-agents/guide.html#id2">××‘× ×” ×”×¤×¨×•×™×§×˜ (×‘×§×¦×¨×”)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ai-agents/guide.html#id3">×”×•×¡×¤×ª ×¤×™×¦â€™×¨×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ai-agents/guide.html#id4">×¡×§×¨×™×¤×˜×™× ×—×©×•×‘×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ai-agents/guide.html#id5">××¤×ª ×“×¨×›×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ai-agents/guide.html#github-issues-chatops">GitHub Issues ×•-ChatOps</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../agents/rate-limiting.html">ğŸš¦ ××¢×¨×›×ª Rate Limiting ×œ×¡×•×›× ×™ AI ×•×œ×•×•×‘</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#shadow-mode">××¡×˜×¨×˜×’×™×” â€“ Shadow Mode ×ª×—×™×œ×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#id1">××©×ª× ×™ ×¡×‘×™×‘×” ×•×§×•× ×¤×™×’</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#id2">××™× ×˜×’×¨×¦×™×” â€“ ×‘×•×˜ ×˜×œ×’×¨×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#flask-webapp">××™× ×˜×’×¨×¦×™×” â€“ Flask/WebApp</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#id3">×”×—×¨×’×•×ª ×—×©×•×‘×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#prometheus">× ×™×˜×•×¨ ×•××“×“×™× (Prometheus)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#id4">××‘×˜×—×” ×•×”×’× ×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#pydantic-settings">×§×•× ×¤×™×’×•×¨×¦×™×” (Pydantic Settings)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#id5">×ª×§×œ×•×ª × ×¤×•×¦×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#id6">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Observability â€“ Advanced</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../observability/events_catalog.html">×§×˜×œ×•×’ ××™×¨×•×¢×™× ×§× ×•× ×™×™×</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../observability/events_catalog.html#github">GitHub</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/events_catalog.html#db">DB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/events_catalog.html#web-share">Web/Share</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/events_catalog.html#alerts">Alerts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/events_catalog.html#repo-analyzer">Repo Analyzer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/events_catalog.html#business">Business</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../observability/error_codes.html">××™×œ×•×Ÿ ×§×•×“×™ ×©×’×™××” (Error Codes)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../observability/error_codes.html#id1">×“×•×’×××•×ª ××™×¤×•×™</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/error_codes.html#id2">×”× ×—×™×•×ª</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../observability/tracing_hotspots.html">Tracing ×××•×§×“ ×‘× ×§×•×“×•×ª ×—××•×ª</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../observability/tracing_hotspots.html#id1">×ª×¨×©×™××™ ×–×¨×™××”</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../observability/tracing_hotspots.html#bot-update">×–×¨×™××ª bot.update</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../observability/tracing_hotspots.html#spans-bot-update">×××¤×™×™× ×™× ××•××œ×¦×™× ×œâ€‘Spans (bot.update)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../observability/tracing_hotspots.html#web-request">×–×¨×™××ª web.request</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../observability/tracing_hotspots.html#spans-web-request">×××¤×™×™× ×™× ××•××œ×¦×™× ×œâ€‘Spans (web.request)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../observability/tracing_hotspots.html#id2">×˜×‘×œ×ª â€×”×™×›×Ÿ ×¢×•×˜×¤×™×â€œ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/tracing_hotspots.html#trace-viewer">×“×•×’××ª Trace Viewer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/tracing_hotspots.html#id3">×”×˜××¢×ª ×“×§×•×¨×˜×•×¨ ×•×©×™××•×© ×‘×¤×•× ×§×¦×™×•×ª ×¢×–×¨</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/tracing_hotspots.html#best-practices">Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/tracing_hotspots.html#id4">×¨××• ×’×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../observability/metrics_promql.html">×©××™×œ×ª×•×ª PromQL ×©×™××•×©×™×•×ª</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../observability/metrics_promql.html#latency">×–××Ÿ ×ª×’×•×‘×” (Latency)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/metrics_promql.html#id1">×©×™×¢×•×¨ ×©×’×™××•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/metrics_promql.html#id2">××™×¨×•×¢×™ ×‘×™×–× ×¡</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../observability/alerts_playbook.html">Playbook ×§×¦×¨ ×œ×”×ª×¨××•×ª</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../observability/alerts_playbook.html#id1">×–×¨×™××”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/alerts_playbook.html#id2">×§×™×©×•×¨×™× ×‘×§×•×“</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/alerts_playbook.html#id3">×“×’×©×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/alerts_playbook.html#id4">×›×™×•×•× ×•×Ÿ ×¨×¢×©</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/alerts_playbook.html#id5">×˜×™×¤×™× ××”×™×¨×™×</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Code Keeper Bot</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">bot_handlers</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>×”×¨××” ×§×•×“ ××§×•×¨ ×œ bot_handlers</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">×¤×§×•×“×•×ª ××ª×§×“××•×ª ×œ×‘×•×˜ ×©×•××¨ ×§×‘×¦×™ ×§×•×“</span>
<span class="sd">Advanced Bot Handlers for Code Keeper Bot</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">io</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">html</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">secrets</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">telegram.error</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">telegram</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">,</span> <span class="n">InlineKeyboardMarkup</span><span class="p">,</span> <span class="n">InputFile</span><span class="p">,</span>
                      <span class="n">Update</span><span class="p">,</span> <span class="n">ReplyKeyboardMarkup</span><span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">telegram.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">ParseMode</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">telegram.ext</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">CallbackQueryHandler</span><span class="p">,</span>
    <span class="n">CommandHandler</span><span class="p">,</span>
    <span class="n">ContextTypes</span><span class="p">,</span>
    <span class="n">MessageHandler</span><span class="p">,</span>
    <span class="n">filters</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">telegram.ext</span><span class="w"> </span><span class="kn">import</span> <span class="n">ApplicationHandlerStop</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">services</span><span class="w"> </span><span class="kn">import</span> <span class="n">code_service</span> <span class="k">as</span> <span class="n">code_processor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">TelegramUtils</span>  <span class="c1"># ×¢×¨×™×›×•×ª ×‘×˜×•×—×•×ª ×œ×”×•×“×¢×•×ª/××§×œ×“×•×ª</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">services.image_generator</span><span class="w"> </span><span class="kn">import</span> <span class="n">CodeImageGenerator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rate_limiter</span><span class="w"> </span><span class="kn">import</span> <span class="n">RateLimiter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">config</span><span class="w"> </span><span class="kn">import</span> <span class="n">config</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">database</span><span class="w"> </span><span class="kn">import</span> <span class="n">CodeSnippet</span><span class="p">,</span> <span class="n">db</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">conversation_handlers</span><span class="w"> </span><span class="kn">import</span> <span class="n">MAIN_KEYBOARD</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>  <span class="c1"># type: ignore</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
    <span class="n">yaml</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>
<span class="c1"># Reporter ××•×–×¨×§ ×‘×–××Ÿ ×¨×™×¦×” ×›×“×™ ×œ×× ×•×¢ ×™×¦×™×¨×” ×‘×–××Ÿ import</span>
<span class="k">class</span><span class="w"> </span><span class="nc">_NoopReporter</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">report_activity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>

<span class="n">reporter</span> <span class="o">=</span> <span class="n">_NoopReporter</span><span class="p">()</span>

<div class="viewcode-block" id="set_activity_reporter">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.set_activity_reporter">[×ª×™×¢×•×“]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">set_activity_reporter</span><span class="p">(</span><span class="n">new_reporter</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">reporter</span>
    <span class="n">reporter</span> <span class="o">=</span> <span class="n">new_reporter</span> <span class="ow">or</span> <span class="n">_NoopReporter</span><span class="p">()</span></div>

    
<span class="c1"># Rate limiter ×œ×¤×™×¦&#39;×¨ ×™×¦×™×¨×ª ×ª××•× ×•×ª (10 ×¤×¢×•×œ×•×ª ×‘×“×§×” ×œ××©×ª××©)</span>
<span class="n">image_rate_limiter</span> <span class="o">=</span> <span class="n">RateLimiter</span><span class="p">(</span><span class="n">max_per_minute</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># ×˜×¢×™× ×ª ×§×•× ×¤×™×’×•×¨×¦×™×™×ª ×ª××•× ×•×ª (××•×¤×¦×™×•× ×œ×™)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_load_image_config</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cfg_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s1">&#39;config&#39;</span> <span class="o">/</span> <span class="s1">&#39;image_settings.yaml&#39;</span>
        <span class="k">if</span> <span class="n">yaml</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">cfg_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">cfg_path</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;image_generation&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>

<span class="n">IMAGE_CONFIG</span> <span class="o">=</span> <span class="n">_load_image_config</span><span class="p">()</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">aiohttp</span>  <span class="c1"># for GitHub rate limit check</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
    <span class="n">aiohttp</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>

<span class="c1"># ChatOps helpers: sensitive command throttling and permissions integration</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">chatops.ratelimit</span><span class="w"> </span><span class="kn">import</span> <span class="n">limit_sensitive</span>  <span class="c1"># type: ignore</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">limit_sensitive</span><span class="p">(</span><span class="n">_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">_decorator</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">fn</span>
        <span class="k">return</span> <span class="n">_decorator</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">chatops.permissions</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
        <span class="n">admin_required</span><span class="p">,</span>
        <span class="n">chat_allowlist_required</span><span class="p">,</span>
        <span class="n">is_admin</span> <span class="k">as</span> <span class="n">_perm_is_admin</span><span class="p">,</span>
    <span class="p">)</span>  <span class="c1"># type: ignore</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
    <span class="n">_perm_is_admin</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">admin_required</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
        <span class="k">return</span> <span class="n">fn</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">chat_allowlist_required</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
        <span class="k">return</span> <span class="n">fn</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_os</span>

<div class="viewcode-block" id="AdvancedBotHandlers">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers">[×ª×™×¢×•×“]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AdvancedBotHandlers</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;×¤×§×•×“×•×ª ××ª×§×“××•×ª ×©×œ ×”×‘×•×˜&quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="AdvancedBotHandlers.__init__">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.__init__">[×ª×™×¢×•×“]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">application</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span> <span class="o">=</span> <span class="n">application</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_advanced_handlers</span><span class="p">()</span></div>

    
<div class="viewcode-block" id="AdvancedBotHandlers.setup_advanced_handlers">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.setup_advanced_handlers">[×ª×™×¢×•×“]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup_advanced_handlers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×”×’×“×¨×ª handlers ××ª×§×“××™×&quot;&quot;&quot;</span>
        
        <span class="c1"># ×¤×§×•×“×•×ª × ×™×”×•×œ ×§×‘×¦×™×</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;show&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_command</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;edit&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">edit_command</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;delete&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_command</span><span class="p">))</span>
        <span class="c1"># self.application.add_handler(CommandHandler(&quot;rename&quot;, self.rename_command))</span>
        <span class="c1"># self.application.add_handler(CommandHandler(&quot;copy&quot;, self.copy_command))</span>
        <span class="c1"># ××•×¢×“×¤×™×</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;favorite&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">favorite_command</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;fav&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">favorite_command</span><span class="p">))</span>  <span class="c1"># ×§×™×¦×•×¨ ×“×¨×š</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;favorites&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">favorites_command</span><span class="p">))</span>
        
        <span class="c1"># ×¤×§×•×“×•×ª ×’×¨×¡××•×ª</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;versions&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">versions_command</span><span class="p">))</span>
        <span class="c1"># self.application.add_handler(CommandHandler(&quot;restore&quot;, self.restore_command))</span>
        <span class="c1"># self.application.add_handler(CommandHandler(&quot;diff&quot;, self.diff_command))</span>
        
        <span class="c1"># ×¤×§×•×“×•×ª ×©×™×ª×•×£</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;share&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">share_command</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;share_help&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">share_help_command</span><span class="p">))</span>
        <span class="c1"># self.application.add_handler(CommandHandler(&quot;export&quot;, self.export_command))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;download&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_command</span><span class="p">))</span>
        <span class="c1"># ×™×¦×™×¨×ª ×ª××•× ×•×ª ××§×•×“ â€“ ×¨×™×©×•× ×¢××™×“: ×›×œ ×¤×§×•×“×” × ×¨×©××ª ×‘× ×¤×¨×“</span>
        <span class="k">for</span> <span class="n">_cmd</span><span class="p">,</span> <span class="n">_fn</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="p">(</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_command</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;preview&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">preview_command</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;image_all&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_all_command</span><span class="p">),</span>
        <span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="n">_cmd</span><span class="p">,</span> <span class="n">_fn</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># ××œ ×ª×¢×¦×•×¨ ×¨×™×©×•× ×¤×§×•×“×•×ª ××—×¨×•×ª; ×“×•×•×— ×•×”××©×š</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to register /</span><span class="si">{</span><span class="n">_cmd</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
        
        <span class="c1"># ×¤×§×•×“×•×ª × ×™×ª×•×—</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;analyze&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_command</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;validate&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_command</span><span class="p">))</span>
        <span class="c1"># self.application.add_handler(CommandHandler(&quot;minify&quot;, self.minify_command))</span>
        
        <span class="c1"># ×¤×§×•×“×•×ª ××¨×’×•×Ÿ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;tags&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags_command</span><span class="p">))</span>
        <span class="c1"># self.application.add_handler(CommandHandler(&quot;languages&quot;, self.languages_command))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;recent&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">recent_command</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">info_command</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;broadcast&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">broadcast_command</span><span class="p">))</span>
        <span class="c1"># ×¤×§×•×“×ª DM ×œ×× ×”×œ×™× â€“ ×©×œ×™×—×ª ×”×•×“×¢×” ×¤×¨×˜×™×ª ×¢× ×©×™××•×¨ ×¨×•×•×—×™× (HTML &lt;pre&gt;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;dm&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_command</span><span class="p">))</span>
        <span class="c1"># ×—×™×¤×•×©</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;search&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_command</span><span class="p">))</span>
        <span class="c1"># ChatOps MVP + Stage 2 commands</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span>
            <span class="s2">&quot;status&quot;</span><span class="p">,</span>
            <span class="n">chat_allowlist_required</span><span class="p">(</span><span class="n">admin_required</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status_command</span><span class="p">))</span>
        <span class="p">))</span>
        <span class="c1"># Alias for detailed health check via chat (same as /status for now)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span>
            <span class="s2">&quot;health&quot;</span><span class="p">,</span>
            <span class="n">chat_allowlist_required</span><span class="p">(</span><span class="n">admin_required</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status_command</span><span class="p">))</span>
        <span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span>
            <span class="s2">&quot;observe&quot;</span><span class="p">,</span>
            <span class="n">chat_allowlist_required</span><span class="p">(</span><span class="n">admin_required</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">observe_command</span><span class="p">))</span>
        <span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span>
            <span class="s2">&quot;triage&quot;</span><span class="p">,</span>
            <span class="n">chat_allowlist_required</span><span class="p">(</span><span class="n">admin_required</span><span class="p">(</span><span class="n">limit_sensitive</span><span class="p">(</span><span class="s2">&quot;triage&quot;</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">triage_command</span><span class="p">)))</span>
        <span class="p">))</span>
        <span class="c1"># ××¢×¨×›×ª: ××™×“×¢ ×•××“×“×™×</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span>
            <span class="s2">&quot;system_info&quot;</span><span class="p">,</span>
            <span class="n">chat_allowlist_required</span><span class="p">(</span><span class="n">admin_required</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system_info_command</span><span class="p">))</span>
        <span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span>
            <span class="s2">&quot;metrics&quot;</span><span class="p">,</span>
            <span class="n">chat_allowlist_required</span><span class="p">(</span><span class="n">admin_required</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics_command</span><span class="p">))</span>
        <span class="p">))</span>
        <span class="c1"># Observability v6 â€“ Predictive Health</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;predict&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_command</span><span class="p">))</span>
        <span class="c1"># Observability v7 â€“ Prediction accuracy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;accuracy&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">accuracy_command</span><span class="p">))</span>
        <span class="c1"># ×¤×§×•×“×ª ×× ×”×œ ×œ×”×¦×’×ª ×§×™×©×•×¨ ×œ-Sentry</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span>
            <span class="s2">&quot;sen&quot;</span><span class="p">,</span>
            <span class="n">chat_allowlist_required</span><span class="p">(</span><span class="n">admin_required</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sentry_command</span><span class="p">))</span>
        <span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span>
            <span class="s2">&quot;errors&quot;</span><span class="p">,</span>
            <span class="n">chat_allowlist_required</span><span class="p">(</span><span class="n">admin_required</span><span class="p">(</span><span class="n">limit_sensitive</span><span class="p">(</span><span class="s2">&quot;errors&quot;</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">errors_command</span><span class="p">)))</span>
        <span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span>
            <span class="s2">&quot;rate_limit&quot;</span><span class="p">,</span>
            <span class="n">chat_allowlist_required</span><span class="p">(</span><span class="n">admin_required</span><span class="p">(</span><span class="n">limit_sensitive</span><span class="p">(</span><span class="s2">&quot;rate_limit&quot;</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">rate_limit_command</span><span class="p">)))</span>
        <span class="p">))</span>
        <span class="c1"># GitHub Backoff controls (admins)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span>
            <span class="s2">&quot;enable_backoff&quot;</span><span class="p">,</span>
            <span class="n">chat_allowlist_required</span><span class="p">(</span><span class="n">admin_required</span><span class="p">(</span><span class="n">limit_sensitive</span><span class="p">(</span><span class="s2">&quot;enable_backoff&quot;</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">enable_backoff_command</span><span class="p">)))</span>
        <span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span>
            <span class="s2">&quot;disable_backoff&quot;</span><span class="p">,</span>
            <span class="n">chat_allowlist_required</span><span class="p">(</span><span class="n">admin_required</span><span class="p">(</span><span class="n">limit_sensitive</span><span class="p">(</span><span class="s2">&quot;disable_backoff&quot;</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">disable_backoff_command</span><span class="p">)))</span>
        <span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span>
            <span class="s2">&quot;uptime&quot;</span><span class="p">,</span>
            <span class="n">chat_allowlist_required</span><span class="p">(</span><span class="n">admin_required</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uptime_command</span><span class="p">))</span>
        <span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span>
            <span class="s2">&quot;alerts&quot;</span><span class="p">,</span>
            <span class="n">chat_allowlist_required</span><span class="p">(</span><span class="n">admin_required</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alerts_command</span><span class="p">))</span>
        <span class="p">))</span>
        <span class="c1"># Observability v5 â€“ incident memory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span>
            <span class="s2">&quot;incidents&quot;</span><span class="p">,</span>
            <span class="n">chat_allowlist_required</span><span class="p">(</span><span class="n">admin_required</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">incidents_command</span><span class="p">))</span>
        <span class="p">))</span>

        <span class="c1"># ChatOps â€“ Silences management</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span>
            <span class="s2">&quot;silence&quot;</span><span class="p">,</span>
            <span class="n">chat_allowlist_required</span><span class="p">(</span><span class="n">admin_required</span><span class="p">(</span><span class="n">limit_sensitive</span><span class="p">(</span><span class="s2">&quot;silence&quot;</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">silence_command</span><span class="p">)))</span>
        <span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span>
            <span class="s2">&quot;unsilence&quot;</span><span class="p">,</span>
            <span class="n">chat_allowlist_required</span><span class="p">(</span><span class="n">admin_required</span><span class="p">(</span><span class="n">limit_sensitive</span><span class="p">(</span><span class="s2">&quot;unsilence&quot;</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">unsilence_command</span><span class="p">)))</span>
        <span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span>
            <span class="s2">&quot;silences&quot;</span><span class="p">,</span>
            <span class="n">chat_allowlist_required</span><span class="p">(</span><span class="n">admin_required</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">silences_command</span><span class="p">))</span>
        <span class="p">))</span>

        <span class="c1"># ChatOps â€“ Language detection (×¤×ª×•×— ×œ×›×œ ×”××©×ª××©×™×)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;lang&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lang_command</span><span class="p">))</span>
        <span class="c1"># ××•×ª×¨ ×‘×˜×œ×’×¨×: ××•×ª×™×•×ª/×¡×¤×¨×•×ª/×§×• ×ª×—×ª×•×Ÿ ×‘×œ×‘×“</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">([</span><span class="s2">&quot;lang_debug&quot;</span><span class="p">,</span> <span class="s2">&quot;langdebug&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lang_debug_command</span><span class="p">))</span>

        <span class="c1"># Callback handlers ×œ×›×¤×ª×•×¨×™×</span>
        <span class="c1"># Guard ×”×’×œ×•×‘×œ×™ ×”×ª×©×ª×™×ª×™ ××ª×•×•×¡×£ ×‘-main.py; ×›××Ÿ × ×©××¨ ×¨×§ ×”-handler ×”×›×œ×œ×™</span>
        <span class="c1"># ×—×©×•×‘: ×”×•×¡×¤×” ×‘×§×‘×•×¦×” ×××•×—×¨×ª, ×›×“×™ ×œ×ª×ª ×¢×“×™×¤×•×ª ×œ-handlers ×¡×¤×¦×™×¤×™×™× (×œ××©×œ ××•×¢×“×¤×™×)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CallbackQueryHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_callback_query</span><span class="p">),</span> <span class="n">group</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="c1"># ×¡×‘×™×‘×ª ×‘×“×™×§×•×ª ×¢× add_handler ×œ×œ× ×¤×¨××˜×¨ group</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CallbackQueryHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_callback_query</span><span class="p">))</span>
        <span class="c1"># Handler ××•×§×“× ×•×××•×§×“ ×œ×˜×•×’×œ ××•×¢×“×¤×™× ×›×“×™ ×œ×”×‘×˜×™×— ×§×œ×™×˜×” ××™×™×“×™×ª</span>
        <span class="n">toggle_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;^(fav_toggle_id:|fav_toggle_tok:)&#39;</span>
        <span class="n">toggle_handler</span> <span class="o">=</span> <span class="n">CallbackQueryHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_callback_query</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="n">toggle_pattern</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">toggle_handler</span><span class="p">,</span> <span class="n">group</span><span class="o">=-</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">toggle_handler</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to register favorites toggle CallbackQueryHandler: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Handler ×××•×§×“ ×¢× ×§×“×™××•×ª ×’×‘×•×”×” ×œ×›×¤×ª×•×¨×™ /share</span>
        <span class="n">share_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;^(share_gist_|share_pastebin_|share_internal_|share_gist_multi:|share_internal_multi:|cancel_share)&#39;</span>
        <span class="n">share_handler</span> <span class="o">=</span> <span class="n">CallbackQueryHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_callback_query</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="n">share_pattern</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">share_handler</span><span class="p">,</span> <span class="n">group</span><span class="o">=-</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="c1"># ×¡×‘×™×‘×ª ×‘×“×™×§×•×ª/×¡×˜××‘ ×©×‘×” add_handler ×œ× ×ª×•××š ×‘×¤×¨××˜×¨ group</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">share_handler</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># ××œ ×ª×‘×œ×¢ ×—×¨×™×’×•×ª ×©×§×˜×•×ª â€“ ×“×•×•×— ×œ×œ×•×’ ×›×“×™ ×œ× ×œ×©×‘×•×¨ ××ª ×›×¤×ª×•×¨×™ ×”×©×™×ª×•×£</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to register share CallbackQueryHandler: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Handler ××•×§×“× ×œ×›×¤×ª×•×¨×™ /image (×¦×•×¨ ××—×“×©/×¢×¨×™×›×ª ×”×’×“×¨×•×ª/Drive/×¤×•× ×˜×™×/×©××™×¨×”)</span>
        <span class="n">image_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;^(regenerate_image_|edit_image_settings_|img_set_theme:|img_set_width:|img_set_font:|img_note_prompt:|img_note_clear:|img_settings_done:|save_to_drive_)&#39;</span>
        <span class="n">image_handler</span> <span class="o">=</span> <span class="n">CallbackQueryHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_callback_query</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="n">image_pattern</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">image_handler</span><span class="p">,</span> <span class="n">group</span><span class="o">=-</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">image_handler</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to register image CallbackQueryHandler: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># ×§×œ×˜ ×˜×§×¡×˜ ×œ×¤×ª×§×™×ª ×ª××•× ×” (×œ×¤× ×™ ××¡× × ×™× ×›×œ×œ×™×™×)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">note_handler</span> <span class="o">=</span> <span class="n">MessageHandler</span><span class="p">(</span>
                <span class="n">filters</span><span class="o">.</span><span class="n">TEXT</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">filters</span><span class="o">.</span><span class="n">COMMAND</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_handle_image_note_input</span><span class="p">,</span>
                <span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">note_handler</span><span class="p">,</span> <span class="n">group</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to register image note MessageHandler: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_image_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">settings_map</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;img_settings&#39;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">settings_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_set_image_setting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">settings_map</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;img_settings&#39;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">settings_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">entry</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">entry</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">if</span> <span class="n">entry</span><span class="p">:</span>
                <span class="n">settings_map</span><span class="p">[</span><span class="n">file_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">settings_map</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="c1"># --- Image callbacks tokenization helpers (to stay under Telegram&#39;s 64B limit) ---</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_or_create_image_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a short stable token for a file name, storing mapping in user_data.</span>
<span class="sd">        We avoid leaking long names into callback_data which has a 64 bytes limit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tokens</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;img_name_by_tok&#39;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">reverse</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;img_tok_by_name&#39;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">tok</span> <span class="o">=</span> <span class="n">reverse</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tok</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">tok</span>
            <span class="c1"># Generate 8-hex token; prefix with &#39;tok:&#39; when used in callback</span>
            <span class="n">tok</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_hex</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
            <span class="c1"># Ensure uniqueness</span>
            <span class="k">while</span> <span class="n">tok</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
                <span class="n">tok</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_hex</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">tokens</span><span class="p">[</span><span class="n">tok</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_name</span>
            <span class="n">reverse</span><span class="p">[</span><span class="n">file_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">tok</span>
            <span class="k">return</span> <span class="n">tok</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># Fallback â€“ if something goes wrong, return sanitized short name tail</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">file_name</span> <span class="ow">or</span> <span class="s1">&#39;file&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">40</span><span class="p">:]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_resolve_image_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">suffix</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resolve a callback suffix back to the original file name.</span>
<span class="sd">        Supports either a raw file name or a token prefixed with &#39;tok:&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">suffix</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;tok:&#39;</span><span class="p">):</span>
                <span class="n">token</span> <span class="o">=</span> <span class="n">suffix</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">token</span> <span class="o">=</span> <span class="n">suffix</span>
            <span class="c1"># Try token lookup first</span>
            <span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;img_name_by_tok&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="c1"># Not a known token â€“ assume it&#39;s a direct file name</span>
            <span class="k">return</span> <span class="n">suffix</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">suffix</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_make_safe_suffix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">action_prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a safe suffix for callback_data for given action.</span>
<span class="sd">        If the combined callback would exceed 64 bytes, return a &#39;tok:&lt;token&gt;&#39; suffix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cb</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">action_prefix</span><span class="si">}{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cb</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">64</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">file_name</span>
            <span class="n">tok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_or_create_image_token</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;tok:</span><span class="si">{</span><span class="n">tok</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">file_name</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_image_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;××¤×¦×œ ×¤×¨××˜×¨×™× ×©×œ /image ×œ×©× ×§×•×‘×¥ ×•××•×¤×¦×™×•× ×œ×™×ª ×”×¢×¨×” ×§×¦×¨×” (--note).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span>
        <span class="n">file_tokens</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">note_tokens</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">note_mode</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">note_explicit</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">clear_requested</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="s1">&#39;--note-clear&#39;</span><span class="p">:</span>
                <span class="n">note_tokens</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">note_mode</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">note_explicit</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">clear_requested</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">note_mode</span><span class="p">:</span>
                <span class="n">note_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="s1">&#39;--note&#39;</span><span class="p">:</span>
                <span class="n">note_mode</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">note_explicit</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;--note=&#39;</span><span class="p">):</span>
                <span class="n">note_mode</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">note_explicit</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">note_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">continue</span>
            <span class="n">file_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file_tokens</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">clear_requested</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">file_name</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="kc">True</span>
        <span class="n">note</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">note_tokens</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="n">note_tokens</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">note</span><span class="p">:</span>
            <span class="n">note</span> <span class="o">=</span> <span class="n">note</span><span class="p">[:</span><span class="mi">220</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">note</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">note_explicit</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_handle_image_note_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×§×•×œ×˜ ×˜×§×¡×˜ ×—×•×¤×©×™ ×œ××—×¨ ×©×œ×—×™×¦×” ×¢×œ &#39;×¤×ª×§×™×ª&#39; ×‘×™×§×©×” ×§×œ×˜.&quot;&quot;&quot;</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;waiting_for_image_note&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="c1"># ×”×•×¦× ××ª ×”×“×’×œ ×›×“×™ ×œ×× ×•×¢ ×˜×¨×™×’×¨×™× ×›×¤×•×œ×™×</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;waiting_for_image_note&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">message</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># ×”×—×–×¨ ×“×’×œ ×›×“×™ ×©×œ× ×œ××‘×“ ××ª ××¦×‘ ×”×¤×ª×§×™×ª, ×•×× ×¢ ×”××©×š ×¢×™×‘×•×“</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;waiting_for_image_note&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span>
            <span class="k">raise</span> <span class="n">ApplicationHandlerStop</span><span class="p">()</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_name</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âš ï¸ ×œ× ×”×¦×œ×—×ª×™ ×œ××ª×¨ ××ª ×”×§×•×‘×¥ ×œ×¢×“×›×•×Ÿ ×”×¤×ª×§×™×ª.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ApplicationHandlerStop</span><span class="p">()</span>
        <span class="n">text</span> <span class="o">=</span> <span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">text</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
            <span class="c1"># ×ª×—×–×™×¨ ××ª ×”×“×’×œ ×›×“×™ ×œ××¡×•×£ ×©×•×‘ ×ª×©×•×‘×”</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;waiting_for_image_note&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span>
            <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;â„¹ï¸ ×”×”×•×“×¢×” ×¨×™×§×”. ×©×œ×— ×˜×§×¡×˜ ×¢×“ 220 ×ª×•×•×™× ××• ×›×ª×•×‘ &#39;×‘×˜×œ&#39;.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ApplicationHandlerStop</span><span class="p">()</span>
        <span class="n">lowered</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">cancel_tokens</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;×‘×˜×œ&quot;</span><span class="p">,</span> <span class="s2">&quot;cancel&quot;</span><span class="p">,</span> <span class="s2">&quot;×‘×™×˜×•×œ&quot;</span><span class="p">,</span> <span class="s2">&quot;×“×œ×’&quot;</span><span class="p">,</span> <span class="s2">&quot;skip&quot;</span><span class="p">}</span>
        <span class="n">clear_tokens</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;××—×§&quot;</span><span class="p">,</span> <span class="s2">&quot;delete&quot;</span><span class="p">,</span> <span class="s2">&quot;clear&quot;</span><span class="p">,</span> <span class="s2">&quot;×œ×œ×&quot;</span><span class="p">,</span> <span class="s2">&quot;× ×§×”&quot;</span><span class="p">,</span> <span class="s2">&quot;remove&quot;</span><span class="p">,</span> <span class="s2">&quot;××—×™×§×”&quot;</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">lowered</span> <span class="ow">in</span> <span class="n">cancel_tokens</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;â ×‘×•×˜×œ â€“ ×”×¤×ª×§×™×ª ×œ× ×©×•× ×ª×”.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ApplicationHandlerStop</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">lowered</span> <span class="ow">in</span> <span class="n">clear_tokens</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_image_setting</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;note&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ğŸ§¹ ×”×¤×ª×§×™×ª ×”×•×¡×¨×” ×¢×‘×•×¨ </span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">trimmed</span> <span class="o">=</span> <span class="n">text</span><span class="p">[:</span><span class="mi">220</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">220</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âœ‚ï¸ ×”×¤×ª×§×™×ª ×§×•×¦×¨×” ×œ-220 ×ª×•×•×™× ×•× ×©××¨×”.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âœ… ×”×¤×ª×§×™×ª × ×©××¨×”.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_image_setting</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;note&#39;</span><span class="p">,</span> <span class="n">trimmed</span><span class="p">)</span>
        <span class="n">chat_id</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;chat_id&#39;</span><span class="p">)</span>
        <span class="n">message_id</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message_id&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">chat_id</span> <span class="ow">and</span> <span class="n">message_id</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">kb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_image_settings_keyboard</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">context</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">edit_message_reply_markup</span><span class="p">(</span>
                    <span class="n">chat_id</span><span class="o">=</span><span class="n">chat_id</span><span class="p">,</span>
                    <span class="n">message_id</span><span class="o">=</span><span class="n">message_id</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">raise</span> <span class="n">ApplicationHandlerStop</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_image_settings_keyboard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InlineKeyboardMarkup</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×‘× ×” ××§×œ×“×ª ×”×’×“×¨×•×ª ×ª××•× ×” (×ª××”/×¨×•×—×‘/×¤×•× ×˜) ×ª×•×š ×¡×™××•×Ÿ ×”×‘×—×™×¨×” ×”× ×•×›×—×™×ª.</span>

<span class="sd">        ×¢×“×›×•×Ÿ: ×›×•×œ×œ×ª ×ª××•×ª × ×•×¡×¤×•×ª (Gruvbox, One Dark, Dracula) ×•×©×•×¨×ª ×‘×—×™×¨×ª ×¤×•× ×˜.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># ×”×¢×“×¤×•×ª ××¤×§×˜×™×‘×™×•×ª: ×¤×¨-××©×ª××© (DB) ×¢× ×“×¨×™×¡×” ×¤×¨-×§×•×‘×¥ (context)</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_effective_image_settings</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        <span class="n">current_theme</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;theme&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">IMAGE_CONFIG</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;default_theme&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;dark&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">current_width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">IMAGE_CONFIG</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;default_width&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">1200</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">current_width</span> <span class="o">=</span> <span class="mi">1200</span>
        <span class="n">current_font</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;dejavu&#39;</span><span class="p">)</span>
        <span class="n">current_note</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;note&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="c1"># suffixes ×‘×˜×•×—×™× ×¢×‘×•×¨ callback_data ×§×¦×¨×™×</span>
        <span class="n">theme_suffix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_safe_suffix</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;img_set_theme:&quot;</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        <span class="n">width_suffix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_safe_suffix</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;img_set_width:&quot;</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        <span class="n">font_suffix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_safe_suffix</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;img_set_font:&quot;</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        <span class="n">note_suffix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_safe_suffix</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;img_note_prompt:&quot;</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        <span class="n">clear_suffix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_safe_suffix</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;img_note_clear:&quot;</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        <span class="n">done_suffix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_safe_suffix</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;img_settings_done:&quot;</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_mk_theme_cb</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;img_set_theme:</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">theme_suffix</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_mk_width_cb</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;img_set_width:</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">width_suffix</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_lbl</span><span class="p">(</span><span class="n">selected</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">selected_label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default_label</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âœ… </span><span class="si">{</span><span class="n">selected_label</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">selected</span> <span class="k">else</span> <span class="n">default_label</span><span class="p">)</span>

        <span class="n">rows</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                    <span class="n">_lbl</span><span class="p">(</span><span class="n">current_theme</span> <span class="o">==</span> <span class="s1">&#39;dark&#39;</span><span class="p">,</span> <span class="s1">&#39;Dark&#39;</span><span class="p">,</span> <span class="s1">&#39;ğŸ¨ Dark&#39;</span><span class="p">),</span>
                    <span class="n">callback_data</span><span class="o">=</span><span class="n">_mk_theme_cb</span><span class="p">(</span><span class="s1">&#39;dark&#39;</span><span class="p">)</span>
                <span class="p">),</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                    <span class="n">_lbl</span><span class="p">(</span><span class="n">current_theme</span> <span class="o">==</span> <span class="s1">&#39;light&#39;</span><span class="p">,</span> <span class="s1">&#39;Light&#39;</span><span class="p">,</span> <span class="s1">&#39;ğŸŒ¤ï¸ Light&#39;</span><span class="p">),</span>
                    <span class="n">callback_data</span><span class="o">=</span><span class="n">_mk_theme_cb</span><span class="p">(</span><span class="s1">&#39;light&#39;</span><span class="p">)</span>
                <span class="p">),</span>
            <span class="p">],</span>
            <span class="p">[</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                    <span class="n">_lbl</span><span class="p">(</span><span class="n">current_theme</span> <span class="o">==</span> <span class="s1">&#39;github&#39;</span><span class="p">,</span> <span class="s1">&#39;GitHub&#39;</span><span class="p">,</span> <span class="s1">&#39;ğŸ™ GitHub&#39;</span><span class="p">),</span>
                    <span class="n">callback_data</span><span class="o">=</span><span class="n">_mk_theme_cb</span><span class="p">(</span><span class="s1">&#39;github&#39;</span><span class="p">)</span>
                <span class="p">),</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                    <span class="n">_lbl</span><span class="p">(</span><span class="n">current_theme</span> <span class="o">==</span> <span class="s1">&#39;monokai&#39;</span><span class="p">,</span> <span class="s1">&#39;Monokai&#39;</span><span class="p">,</span> <span class="s1">&#39;ğŸ¯ Monokai&#39;</span><span class="p">),</span>
                    <span class="n">callback_data</span><span class="o">=</span><span class="n">_mk_theme_cb</span><span class="p">(</span><span class="s1">&#39;monokai&#39;</span><span class="p">)</span>
                <span class="p">),</span>
            <span class="p">],</span>
            <span class="p">[</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                    <span class="n">_lbl</span><span class="p">(</span><span class="n">current_theme</span> <span class="o">==</span> <span class="s1">&#39;gruvbox&#39;</span><span class="p">,</span> <span class="s1">&#39;Gruvbox&#39;</span><span class="p">,</span> <span class="s1">&#39;ğŸŸ¤ Gruvbox&#39;</span><span class="p">),</span>
                    <span class="n">callback_data</span><span class="o">=</span><span class="n">_mk_theme_cb</span><span class="p">(</span><span class="s1">&#39;gruvbox&#39;</span><span class="p">)</span>
                <span class="p">),</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                    <span class="n">_lbl</span><span class="p">(</span><span class="n">current_theme</span> <span class="o">==</span> <span class="s1">&#39;one_dark&#39;</span><span class="p">,</span> <span class="s1">&#39;One Dark&#39;</span><span class="p">,</span> <span class="s1">&#39;ğŸŒ‘ One Dark&#39;</span><span class="p">),</span>
                    <span class="n">callback_data</span><span class="o">=</span><span class="n">_mk_theme_cb</span><span class="p">(</span><span class="s1">&#39;one_dark&#39;</span><span class="p">)</span>
                <span class="p">),</span>
            <span class="p">],</span>
            <span class="p">[</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                    <span class="n">_lbl</span><span class="p">(</span><span class="n">current_theme</span> <span class="o">==</span> <span class="s1">&#39;dracula&#39;</span><span class="p">,</span> <span class="s1">&#39;Dracula&#39;</span><span class="p">,</span> <span class="s1">&#39;ğŸ§› Dracula&#39;</span><span class="p">),</span>
                    <span class="n">callback_data</span><span class="o">=</span><span class="n">_mk_theme_cb</span><span class="p">(</span><span class="s1">&#39;dracula&#39;</span><span class="p">)</span>
                <span class="p">),</span>
            <span class="p">],</span>
        <span class="p">]</span>

        <span class="n">width_buttons</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_configured_width_options</span><span class="p">():</span>
            <span class="n">width_buttons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                    <span class="n">_lbl</span><span class="p">(</span><span class="n">current_width</span> <span class="o">==</span> <span class="n">opt</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">opt</span><span class="si">}</span><span class="s2">px&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">opt</span><span class="si">}</span><span class="s2">px&quot;</span><span class="p">),</span>
                    <span class="n">callback_data</span><span class="o">=</span><span class="n">_mk_width_cb</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">width_buttons</span><span class="p">),</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">width_buttons</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])</span>

        <span class="n">note_label</span> <span class="o">=</span> <span class="s2">&quot;ğŸ—’ï¸ ×”×•×¡×£ ×¤×ª×§×™×ª&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">current_note</span> <span class="k">else</span> <span class="s2">&quot;ğŸ—’ï¸ ×¢×¨×•×š ×¤×ª×§×™×ª&quot;</span>
        <span class="n">note_row</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                <span class="n">note_label</span><span class="p">,</span>
                <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;img_note_prompt:</span><span class="si">{</span><span class="n">note_suffix</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">current_note</span><span class="p">:</span>
            <span class="n">note_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                    <span class="s2">&quot;ğŸ§¹ × ×§×”&quot;</span><span class="p">,</span>
                    <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;img_note_clear:</span><span class="si">{</span><span class="n">clear_suffix</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">note_row</span><span class="p">)</span>

        <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
            <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                <span class="n">_lbl</span><span class="p">(</span><span class="n">current_font</span> <span class="o">==</span> <span class="s1">&#39;dejavu&#39;</span><span class="p">,</span> <span class="s1">&#39;DejaVu&#39;</span><span class="p">,</span> <span class="s1">&#39;ğŸ“ DejaVu Sans Mono&#39;</span><span class="p">),</span>
                <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;img_set_font:dejavu:</span><span class="si">{</span><span class="n">font_suffix</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">),</span>
            <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                <span class="n">_lbl</span><span class="p">(</span><span class="n">current_font</span> <span class="o">==</span> <span class="s1">&#39;jetbrains&#39;</span><span class="p">,</span> <span class="s1">&#39;JetBrains&#39;</span><span class="p">,</span> <span class="s1">&#39;ğŸš€ JetBrains Mono&#39;</span><span class="p">),</span>
                <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;img_set_font:jetbrains:</span><span class="si">{</span><span class="n">font_suffix</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">),</span>
            <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                <span class="n">_lbl</span><span class="p">(</span><span class="n">current_font</span> <span class="o">==</span> <span class="s1">&#39;cascadia&#39;</span><span class="p">,</span> <span class="s1">&#39;Cascadia&#39;</span><span class="p">,</span> <span class="s1">&#39;ğŸ’» Cascadia Code&#39;</span><span class="p">),</span>
                <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;img_set_font:cascadia:</span><span class="si">{</span><span class="n">font_suffix</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">),</span>
        <span class="p">])</span>
        <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;×©××•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;img_settings_done:</span><span class="si">{</span><span class="n">done_suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
        <span class="k">return</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_configured_width_options</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×”×¤×§×ª ×¨×©×™××ª ×¨×•×—×‘×™× ×–××™× ×™× (××¡×•× × ×ª ×•×××•×™× ×ª).&quot;&quot;&quot;</span>
        <span class="n">fallback</span> <span class="o">=</span> <span class="p">[</span><span class="mi">800</span><span class="p">,</span> <span class="mi">1200</span><span class="p">,</span> <span class="mi">1400</span><span class="p">,</span> <span class="mi">1800</span><span class="p">,</span> <span class="mi">2000</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="n">IMAGE_CONFIG</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;width_options&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">raw</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">fallback</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">raw</span> <span class="o">=</span> <span class="p">[</span><span class="n">raw</span><span class="p">]</span>
            <span class="n">widths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">raw</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">w</span> <span class="o">&gt;=</span> <span class="mi">600</span> <span class="ow">and</span> <span class="n">w</span> <span class="o">&lt;=</span> <span class="mi">2600</span><span class="p">:</span>
                        <span class="n">widths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">widths</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">fallback</span>
            <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">widths</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fallback</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_effective_image_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×××—×“ ×”×¢×“×¤×•×ª ×¤×¨-××©×ª××© (DB) ×¢× ×”×¢×“×¤×•×ª ×¤×¨-×§×•×‘×¥ (context).&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># ×‘×¡×™×¡: ×”×¢×“×¤×•×ª ××©×ª××© ×’×œ×•×‘×œ×™×•×ª</span>
            <span class="n">base</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_image_prefs</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># ×“×¨×™×¡×” ×¤×¨-×§×•×‘×¥ ×‘×–×™×›×¨×•×Ÿ</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">overrides</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_image_settings</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">overrides</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
        <span class="n">merged</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">overrides</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">merged</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_build_image_error_hint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requested_width</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">code_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×˜×§×¡×˜ ×¢×–×¨×” ×¢×“×™×Ÿ ×œ×©×’×™××•×ª, ×¢× ×”×“×’×©×” ×¢×œ ×”×•×¨×“×ª ×¨×–×•×œ×•×¦×™×”/×§×™×¦×•×¨ ×§×•×‘×¥.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">suggestions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">requested_width</span> <span class="ow">and</span> <span class="n">requested_width</span> <span class="o">&gt;=</span> <span class="mi">1600</span><span class="p">:</span>
                <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;× ×¡×” ×œ×‘×—×•×¨ ×¨×•×—×‘ × ××•×š ×™×•×ª×¨ ×“×¨×š ×”×›×¤×ª×•×¨ </span><span class="se">\&quot;</span><span class="s2">ğŸ“ ×¢×¨×•×š ×”×’×“×¨×•×ª</span><span class="se">\&quot;</span><span class="s2"> (×œ××©×œ 1200px ××• 1400px).&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">code_length</span> <span class="o">&gt;</span> <span class="mi">12000</span><span class="p">:</span>
                <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;×œ×§×‘×¦×™× ××¨×•×›×™× ×‘××™×•×—×“ ×›×“××™ ×œ×™×¦×•×¨ ×ª××•× ×” ×¨×§ ×œ×—×œ×§ ××”×©×•×¨×•×ª ××• ×œ×§×¦×¨ ××¢×˜.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">suggestions</span><span class="p">:</span>
                <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;××¤×©×¨ ×œ× ×¡×•×ª ×©×•×‘ ××—×¨×™ ×”×§×˜× ×ª ×”×¨×•×—×‘ ××• ×§×™×¦×•×¨ ×”×§×•×‘×¥.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ğŸ’¡ &quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">suggestions</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ğŸ’¡ × ×¡×” ×©×•×‘ ××—×¨×™ ×”×§×˜× ×ª ×”×¨×•×—×‘ ××• ×§×™×¦×•×¨ ×”×§×•×‘×¥.&quot;</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_edit_message_with_media_fallback</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">query</span><span class="p">,</span>
        <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">parse_mode</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">reply_markup</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">InlineKeyboardMarkup</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Edit ×”×•×“×¢×”, ×¢× fallback ×œ×”×•×“×¢×•×ª ××“×™×” (caption) ××• reply ×—×“×© ×‘××™×“×ª ×”×¦×•×¨×š.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">parse_mode</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="k">except</span> <span class="n">telegram</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">BadRequest</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">desc</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="c1"># ×× ××™×Ÿ ×©×™× ×•×™ ×××©×™ â€“ ××™×Ÿ ×¦×•×¨×š ×œ×¤×¢×•×œ</span>
            <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">in</span> <span class="n">desc</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="c1"># ×ª××™×›×ª fallback ×’× ×‘×©×’×™××” ×”× ×¤×•×¦×”: &quot;There is no text in the message to edit&quot;</span>
            <span class="n">needs_fallback</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
                <span class="n">key</span> <span class="ow">in</span> <span class="n">desc</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span>
                    <span class="s2">&quot;message can&#39;t be edited&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;message to edit not found&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;message to edit has no text&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;there is no text in the message to edit&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;no text in the message to edit&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;can&#39;t edit message&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">needs_fallback</span><span class="p">:</span>
                <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># ×—×¨×™×’×•×ª ××—×¨×•×ª ×™×˜×•×¤×œ×• ×¢&quot;×™ fallback ××ª×—×ª</span>
            <span class="k">pass</span>

        <span class="c1"># × ×™×¡×™×•×Ÿ ×œ×¢×¨×•×š caption (×‘××™×•×—×“ ×¢×‘×•×¨ ×”×•×“×¢×•×ª ×ª××•× ×”)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_caption</span><span class="p">(</span>
                <span class="n">caption</span><span class="o">=</span><span class="n">text</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">parse_mode</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="k">except</span> <span class="n">telegram</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">BadRequest</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">desc</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">in</span> <span class="n">desc</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">needs_reply</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
                <span class="n">key</span> <span class="ow">in</span> <span class="n">desc</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span>
                    <span class="s2">&quot;message can&#39;t be edited&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;message to edit not found&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;can&#39;t edit message&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">needs_reply</span><span class="p">:</span>
                <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># ×©×œ×™×—×ª ×”×•×“×¢×” ×—×“×©×” ×›×”×•×“×¢×ª fallback ×¡×•×¤×™×ª</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="n">text</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">parse_mode</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># ×‘×©×œ×‘ ×–×” ××™×Ÿ ×¢×•×“ ××” ×œ×¢×©×•×ª â€“ × ×‘×œ×¢ ×—×¨×™×’×” ×›×“×™ ×œ× ×œ×©×‘×•×¨ ××ª ×”×–×¨×™××”</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Fallback reply_text ×›×©×œ ×¢×‘×•×¨ ×œ×—×¦×Ÿ ×ª××•× ×”&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="AdvancedBotHandlers.show_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.show_command">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">show_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×”×¦×’×ª ×§×˜×¢ ×§×•×“ ×¢× ×”×“×’×©×ª ×ª×—×‘×™×¨&quot;&quot;&quot;</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;ğŸ“„ ×× × ×¦×™×™×Ÿ ×©× ×§×•×‘×¥:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;×“×•×’××”: `/show script.py`&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">file_data</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_data</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;âŒ ×§×•×‘×¥ `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">` ×œ× × ××¦×.&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># ×§×‘×œ ××ª ×”×§×•×“ ×”××§×•×¨×™ ×‘×‘×˜×—×”; ×•×“× ×©×ª××™×“ ×™×© ××—×¨×•×–×ª ×§×•×“</span>
        <span class="n">code_raw</span> <span class="o">=</span> <span class="nb">str</span><span class="p">((</span><span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
        <span class="n">language</span> <span class="o">=</span> <span class="nb">str</span><span class="p">((</span><span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;programming_language&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># highlight_code ×¢×©×•×™ ×œ×”×—×–×™×¨ ××—×¨×•×–×ª ×¨×™×§×” ×‘××§×¨×™ ×§×¦×” â€” × ×™×¤×•×œ ×—×–×¨×” ×œ×§×•×“ ×”××§×•×¨×™</span>
            <span class="n">original_code</span> <span class="o">=</span> <span class="n">code_processor</span><span class="o">.</span><span class="n">highlight_code</span><span class="p">(</span><span class="n">code_raw</span><span class="p">,</span> <span class="n">language</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">original_code</span> <span class="o">=</span> <span class="n">code_raw</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">original_code</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="n">original_code</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">original_code</span> <span class="o">=</span> <span class="n">code_raw</span>
        
        <span class="c1"># ×‘×¦×¢ ×”×™××œ×˜×•×ª ×œ×ª×•×›×Ÿ ×”×§×•×“ ×›×“×™ ×œ×× ×•×¢ ×©×’×™××•×ª</span>
        <span class="n">escaped_code</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">original_code</span><span class="p">)</span>
        <span class="n">language_html</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">language</span><span class="p">)</span>

        <span class="c1"># ×¢×˜×•×£ ××ª ×”×§×•×“ ×”× ×§×™ ×‘×ª×’×™×•×ª &lt;pre&gt;&lt;code&gt; ×©×˜×œ×’×¨× ×ª×•××š ×‘×”×Ÿ</span>
        <span class="n">response_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;&lt;b&gt;File:&lt;/b&gt; &lt;code&gt;</span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">file_name</span><span class="p">)))</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span>
<span class="s2">&lt;b&gt;Language:&lt;/b&gt; </span><span class="si">{</span><span class="n">language_html</span><span class="si">}</span>

<span class="s2">&lt;pre&gt;&lt;code&gt;</span><span class="si">{</span><span class="n">escaped_code</span><span class="si">}</span><span class="s2">&lt;/code&gt;&lt;/pre&gt;</span>
<span class="s2">&quot;&quot;&quot;</span>
        
        <span class="c1"># --- ××‘× ×” ×”×›×¤×ª×•×¨×™× ×”×—×“×© ×•×”× ×§×™ ---</span>
        <span class="n">file_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">,</span> <span class="n">file_name</span><span class="p">))</span>
        <span class="c1"># ×›×¤×ª×•×¨ ××•×¢×“×¤×™× ×‘×”×ª×× ×œ××¦×‘ ×”× ×•×›×—×™</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">is_fav_now</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">is_favorite</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">is_fav_now</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">fav_text</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;ğŸ’” ×”×¡×¨ ×××•×¢×“×¤×™×&quot;</span> <span class="k">if</span> <span class="n">is_fav_now</span> <span class="k">else</span> <span class="s2">&quot;â­ ×”×•×¡×£ ×œ××•×¢×“×¤×™×&quot;</span><span class="p">)</span>
        <span class="c1"># ×”×§×¤×“×” ×¢×œ ××’×‘×œ×ª 64 ×‘×ª×™× ×‘-callback_data + ×”×™×× ×¢×•×ª ××ª×•×•×™× ×‘×¢×™×™×ª×™×™×</span>
        <span class="c1"># ×”×¢×“×¤×” ×œ-ID ×× ×§×™×™×; ××—×¨×ª ×˜×•×§×Ÿ ×§×¦×¨ ×¢× ××™×¤×•×™ ×‘-user_data</span>
        <span class="n">has_id</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_raw_id</span> <span class="o">=</span> <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">_raw_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">has_id</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">file_id_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">_raw_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">has_id</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">file_id_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">has_id</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="s2">&quot;fav_toggle_id:&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_id_str</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">60</span><span class="p">:</span>
            <span class="n">fav_cb</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;fav_toggle_id:</span><span class="si">{</span><span class="n">file_id_str</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">token</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">token</span> <span class="o">=</span> <span class="s2">&quot;t&quot;</span>  <span class="c1"># fallback ×§×¦×¨</span>
            <span class="c1"># ×§×™×¦×•×¨ ×˜×•×§×Ÿ ×œ×©×™××•×© ×‘-callback_data ×•×©××™×¨×ª ×”××™×¤×•×™ ×ª×—×ª ×”××¤×ª×— ×”××§×•×¦×¨</span>
            <span class="n">short_tok</span> <span class="o">=</span> <span class="p">(</span><span class="n">token</span><span class="p">[:</span><span class="mi">24</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;t&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tokens_map</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fav_tokens&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
                <span class="n">tokens_map</span><span class="p">[</span><span class="n">short_tok</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_name</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;fav_tokens&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tokens_map</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">fav_cb</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;fav_toggle_tok:</span><span class="si">{</span><span class="n">short_tok</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">buttons</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ—‘ï¸ ××—×™×§×”&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;delete_</span><span class="si">{</span><span class="n">file_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;âœï¸ ×¢×¨×™×›×”&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;edit_</span><span class="si">{</span><span class="n">file_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="p">[</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ“ ×¢×¨×•×š ×”×¢×¨×”&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;edit_note_</span><span class="si">{</span><span class="n">file_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ’¾ ×”×•×¨×“×”&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;download_</span><span class="si">{</span><span class="n">file_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="p">[</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸŒ ×©×™×ª×•×£&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;share_</span><span class="si">{</span><span class="n">file_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="p">[</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">fav_text</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="n">fav_cb</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">]</span>
        <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">buttons</span><span class="p">)</span>
        <span class="c1"># ---------------------------------</span>
        
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">response_text</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s1">&#39;HTML&#39;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdvancedBotHandlers.favorite_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.favorite_command">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">favorite_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×”×•×¡×¤×”/×”×¡×¨×” ×©×œ ×§×•×‘×¥ ××”××•×¢×“×¤×™×: /favorite &lt;file_name&gt;&quot;&quot;&quot;</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;ğŸ”– &lt;b&gt;×”×•×¡×¤×”/×”×¡×¨×” ×××•×¢×“×¤×™×&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;×©×™××•×©: &lt;code&gt;/favorite &amp;lt;file_name&amp;gt;&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;×“×•×’××”:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;&lt;code&gt;/favorite config.py&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;××• ×©×œ×— &lt;code&gt;/favorites&lt;/code&gt; ×œ×¦×¤×™×™×” ×‘×›×œ ×”××•×¢×“×¤×™×&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">snippet</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">snippet</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;âŒ ×”×§×•×‘×¥ &lt;code&gt;</span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/code&gt; ×œ× × ××¦×.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;×©×œ×— &lt;code&gt;/list&lt;/code&gt; ×œ×¨×©×™××ª ×”×§×‘×¦×™× ×©×œ×š.&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="n">new_state</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">toggle_favorite</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        <span class="c1"># ×× ×”××ª×•×“×” ××—×–×™×¨×” None, ×–×• ×©×’×™××”</span>
        <span class="k">if</span> <span class="n">new_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×¢×“×›×•×Ÿ ××•×¢×“×¤×™×. × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">language</span> <span class="o">=</span> <span class="n">snippet</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;programming_language&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
        <span class="n">emoji</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_language_emoji</span>
            <span class="n">emoji</span> <span class="o">=</span> <span class="n">get_language_emoji</span><span class="p">(</span><span class="n">language</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">emoji</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">new_state</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;â­ &lt;b&gt;× ×•×¡×£ ×œ××•×¢×“×¤×™×!&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ“ ×§×•×‘×¥: &lt;code&gt;</span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">emoji</span><span class="si">}</span><span class="s2"> ×©×¤×”: </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">language</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;×œ× ×™×“×•×¢&#39;</span><span class="p">)</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ’¡ ×’×© ×‘××”×™×¨×•×ª ×¢× &lt;code&gt;/favorites&lt;/code&gt;&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ’” &lt;b&gt;×”×•×¡×¨ ××”××•×¢×“×¤×™×&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ“ ×§×•×‘×¥: &lt;code&gt;</span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;× ×™×ª×Ÿ ×œ×”×•×¡×™×£ ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.&quot;</span>
            <span class="p">)</span>
        <span class="c1"># ×›×¤×ª×•×¨×™× ××”×™×¨×™×</span>
        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ“‹ ×”×¦×’ ×§×•×‘×¥&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;view_direct_</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;â­ ×›×œ ×”××•×¢×“×¤×™×&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;favorites_list&quot;</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">]</span>
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">))</span></div>


<div class="viewcode-block" id="AdvancedBotHandlers.favorites_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.favorites_command">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">favorites_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×¨×©×™××ª ×”××•×¢×“×¤×™× ×©×œ ×”××©×ª××©: /favorites&quot;&quot;&quot;</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">favorites</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_favorites</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">favorites</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;ğŸ’­ ××™×Ÿ ×œ×š ××•×¢×“×¤×™× ×›×¨×’×¢.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;âœ¨ ×”×•×¡×£ ××•×¢×“×£ ×¨××©×•×Ÿ ×¢× &lt;code&gt;/favorite &amp;lt;×©×&amp;gt;&lt;/code&gt;&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;â­ &lt;b&gt;×”××•×¢×“×¤×™× ×©×œ×š&lt;/b&gt;&quot;</span><span class="p">]</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">TimeUtils</span><span class="p">,</span> <span class="n">get_language_emoji</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">fav</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">favorites</span><span class="p">[:</span><span class="mi">10</span><span class="p">],</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">fav</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">lang</span> <span class="o">=</span> <span class="n">fav</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;programming_language&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">rel</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fa</span> <span class="o">=</span> <span class="n">fav</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;favorited_at&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">fav</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;updated_at&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">fav</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;created_at&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">fa</span><span class="p">:</span>
                    <span class="n">rel</span> <span class="o">=</span> <span class="n">TimeUtils</span><span class="o">.</span><span class="n">format_relative_time</span><span class="p">(</span><span class="n">fa</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">rel</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">emoji</span> <span class="o">=</span> <span class="n">get_language_emoji</span><span class="p">(</span><span class="n">lang</span><span class="p">)</span>
            <span class="n">line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">emoji</span><span class="si">}</span><span class="s2"> &lt;code&gt;</span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span>
            <span class="k">if</span> <span class="n">rel</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; â€¢ </span><span class="si">{</span><span class="n">rel</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">favorites</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">â• ×•×¢×•×“ </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">favorites</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">10</span><span class="si">}</span><span class="s2"> ×§×‘×¦×™×...&quot;</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="c1"># ×›×¤×ª×•×¨×™ ×§×™×¦×•×¨ ×œ×§×‘×¦×™× (×¢×“ 5 ×¨××©×•× ×™×)</span>
        <span class="n">buttons</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fav</span> <span class="ow">in</span> <span class="n">favorites</span><span class="p">[:</span><span class="mi">5</span><span class="p">]:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">fav</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">latest</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
                <span class="n">fid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">latest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">fid</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="n">fid</span><span class="p">:</span>
                <span class="n">cb</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;view_direct_id:</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">safe_name</span> <span class="o">=</span> <span class="p">(</span><span class="n">fname</span><span class="p">[:</span><span class="mi">45</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;...&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">48</span> <span class="k">else</span> <span class="n">fname</span>
                <span class="n">cb</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;view_direct_</span><span class="si">{</span><span class="n">safe_name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">buttons</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ğŸ“„ </span><span class="si">{</span><span class="n">fname</span><span class="p">[:</span><span class="mi">20</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="n">cb</span><span class="p">)])</span>
        <span class="c1"># ×¤×¢×•×œ×•×ª ×›×œ×œ×™×•×ª</span>
        <span class="n">actions_row</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ“¥ ×™×™×¦×•× JSON&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;export_favorites&quot;</span><span class="p">),</span>
            <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×”&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;favorites_stats&quot;</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">buttons</span><span class="p">:</span>
            <span class="n">buttons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">actions_row</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">buttons</span> <span class="o">=</span> <span class="p">[</span><span class="n">actions_row</span><span class="p">]</span>
        <span class="c1"># ×©×œ×™×—×ª ×”×•×“×¢×” ××¨×•×›×” ×‘×¦×•×¨×” ×‘×˜×•×—×” (×¤×™×¦×•×œ ×œ××¡×¤×¨ ×”×•×“×¢×•×ª ×× ×¦×¨×™×š)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_long_message</span><span class="p">(</span>
            <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
            <span class="n">message</span><span class="p">,</span>
            <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">,</span>
            <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">buttons</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># ×× ×™×© ×™×•×ª×¨ ×-10 ××•×¢×“×¤×™×, ×©×œ×— ××ª ×”×©××¨ ×›×”×•×“×¢×•×ª × ×•×¡×¤×•×ª â€” ××¤×•×¦×œ×•×ª ×‘×‘×˜×—×”</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">favorites</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">rest_lines</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_language_emoji</span> <span class="k">as</span> <span class="n">_gle</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">fav</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">favorites</span><span class="p">[</span><span class="mi">10</span><span class="p">:],</span> <span class="mi">11</span><span class="p">):</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="n">fav</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">lang</span> <span class="o">=</span> <span class="n">fav</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;programming_language&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">rest_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">_gle</span><span class="p">(</span><span class="n">lang</span><span class="p">)</span><span class="si">}</span><span class="s2"> &lt;code&gt;</span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span><span class="p">)</span>
            <span class="n">rest_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rest_lines</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rest_text</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_long_message</span><span class="p">(</span>
                    <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
                    <span class="n">rest_text</span><span class="p">,</span>
                    <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="p">)</span></div>

    
<div class="viewcode-block" id="AdvancedBotHandlers.edit_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.edit_command">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">edit_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×¢×¨×™×›×ª ×§×˜×¢ ×§×•×“ ×§×™×™×&quot;&quot;&quot;</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;âœï¸ ×× × ×¦×™×™×Ÿ ×©× ×§×•×‘×¥ ×œ×¢×¨×™×›×”:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;×“×•×’××”: `/edit script.py`&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">file_data</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_data</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;âŒ ×§×•×‘×¥ `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">` ×œ× × ××¦×.&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># ×©××™×¨×ª ××™×“×¢ ×œ×¢×¨×™×›×”</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;editing_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;file_name&#39;</span><span class="p">:</span> <span class="n">file_name</span><span class="p">,</span>
            <span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
            <span class="s1">&#39;original_data&#39;</span><span class="p">:</span> <span class="n">file_data</span>
        <span class="p">}</span>
        
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;âœï¸ **×¢×¨×™×›×ª ×§×•×‘×¥:** `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">`</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;**×§×•×“ × ×•×›×—×™:**</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;```</span><span class="si">{</span><span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;programming_language&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">```</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;ğŸ”„ ×× × ×©×œ×— ××ª ×”×§×•×“ ×”×—×“×©:&quot;</span><span class="p">,</span>
            <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
        <span class="p">)</span></div>

    
<div class="viewcode-block" id="AdvancedBotHandlers.delete_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.delete_command">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">delete_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;××—×™×§×ª ×§×˜×¢ ×§×•×“&quot;&quot;&quot;</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;ğŸ—‘ï¸ ×× × ×¦×™×™×Ÿ ×©× ×§×•×‘×¥ ×œ××—×™×§×”:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;×“×•×’××”: `/delete script.py`&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">file_data</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_data</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;âŒ ×§×•×‘×¥ `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">` ×œ× × ××¦×.&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># ×›×¤×ª×•×¨×™ ××™×©×•×¨</span>
        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;âœ… ×›×Ÿ, ××—×§&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;confirm_delete_</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;âŒ ×‘×™×˜×•×œ&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;cancel_delete&quot;</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">]</span>
        <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
        
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;ğŸ—‘ï¸ **××™×©×•×¨ ××—×™×§×”**</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">`?</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;×¤×¢×•×œ×” ×–×• ×ª××—×§ ××ª ×›×œ ×”×’×¨×¡××•×ª ×©×œ ×”×§×•×‘×¥ ×•×œ× × ×™×ª×Ÿ ×œ×‘×˜×œ ××•×ª×”!&quot;</span><span class="p">,</span>
            <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span><span class="p">,</span>
            <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span>
        <span class="p">)</span></div>

    
<div class="viewcode-block" id="AdvancedBotHandlers.versions_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.versions_command">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">versions_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×”×¦×’×ª ×›×œ ×’×¨×¡××•×ª ×”×§×•×‘×¥&quot;&quot;&quot;</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;ğŸ”¢ ×× × ×¦×™×™×Ÿ ×©× ×§×•×‘×¥:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;×“×•×’××”: `/versions script.py`&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">versions</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_all_versions</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">versions</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;âŒ ×§×•×‘×¥ `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">` ×œ× × ××¦×.&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">response</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ğŸ”¢ **×’×¨×¡××•×ª ×¢×‘×•×¨:** `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">`</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        
        <span class="k">for</span> <span class="n">version_data</span> <span class="ow">in</span> <span class="n">versions</span><span class="p">:</span>
            <span class="n">is_latest</span> <span class="o">=</span> <span class="n">version_data</span> <span class="o">==</span> <span class="n">versions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;ğŸŸ¢ × ×•×›×—×™×ª&quot;</span> <span class="k">if</span> <span class="n">is_latest</span> <span class="k">else</span> <span class="s2">&quot;ğŸ”µ ×™×©× ×”&quot;</span>
            
            <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;**×’×¨×¡×” </span><span class="si">{</span><span class="n">version_data</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">** </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;ğŸ“… </span><span class="si">{</span><span class="n">version_data</span><span class="p">[</span><span class="s1">&#39;updated_at&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/%m/%Y %H:%M&#39;</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;ğŸ“ </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">version_data</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> ×ª×•×•×™×</span><span class="se">\n</span><span class="s2">&quot;</span>
            
            <span class="k">if</span> <span class="n">version_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">):</span>
                <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;ğŸ“ </span><span class="si">{</span><span class="n">version_data</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            
            <span class="n">response</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        
        <span class="c1"># ×›×¤×ª×•×¨×™ ×¤×¢×•×œ×”</span>
        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">version_data</span> <span class="ow">in</span> <span class="n">versions</span><span class="p">[:</span><span class="mi">5</span><span class="p">]:</span>  <span class="c1"># ××§×¡×™××•× 5 ×’×¨×¡××•×ª ×‘×›×¤×ª×•×¨×™×</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;ğŸ“„ ×’×¨×¡×” </span><span class="si">{</span><span class="n">version_data</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;show_version_</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">version_data</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">),</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;ğŸ”„ ×©×—×–×¨&quot;</span><span class="p">,</span>
                    <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;restore_version_</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">version_data</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="p">])</span>
        
        <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
        
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
            <span class="n">response</span><span class="p">,</span>
            <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span><span class="p">,</span>
            <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span>
        <span class="p">)</span></div>

    
<div class="viewcode-block" id="AdvancedBotHandlers.analyze_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.analyze_command">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">analyze_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;× ×™×ª×•×— ××ª×§×“× ×©×œ ×§×˜×¢ ×§×•×“&quot;&quot;&quot;</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;ğŸ“Š ×× × ×¦×™×™×Ÿ ×©× ×§×•×‘×¥ ×œ× ×™×ª×•×—:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;×“×•×’××”: `/analyze script.py`&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">file_data</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_data</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;âŒ ×§×•×‘×¥ `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">` ×œ× × ××¦×.&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">code</span> <span class="o">=</span> <span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span>
        <span class="n">language</span> <span class="o">=</span> <span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;programming_language&#39;</span><span class="p">]</span>
        
        <span class="c1"># × ×™×ª×•×— ×”×§×•×“</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="n">code_processor</span><span class="o">.</span><span class="n">get_code_stats</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="n">functions</span> <span class="o">=</span> <span class="n">code_processor</span><span class="o">.</span><span class="n">extract_functions</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">language</span><span class="p">)</span>
        
        <span class="n">response</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">ğŸ“Š **× ×™×ª×•×— ×§×•×“ ×¢×‘×•×¨:** `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">`</span>

<span class="s2">ğŸ“ **××“×“×™ ×’×•×“×œ:**</span>
<span class="s2">â€¢ ×¡×”&quot;×› ×©×•×¨×•×ª: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;total_lines&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">â€¢ ×©×•×¨×•×ª ×§×•×“: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;code_lines&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">â€¢ ×©×•×¨×•×ª ×”×¢×¨×•×ª: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;comment_lines&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">â€¢ ×©×•×¨×•×ª ×¨×™×§×•×ª: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;blank_lines&#39;</span><span class="p">]</span><span class="si">}</span>

<span class="s2">ğŸ“ **××“×“×™ ×ª×•×›×Ÿ:**</span>
<span class="s2">â€¢ ×ª×•×•×™×: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;characters&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">â€¢ ××™×œ×™×: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;words&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">â€¢ ×ª×•×•×™× ×œ×œ× ×¨×•×•×—×™×: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;characters_no_spaces&#39;</span><span class="p">]</span><span class="si">}</span>

<span class="s2">ğŸ”§ **××‘× ×” ×§×•×“:**</span>
<span class="s2">â€¢ ×¤×•× ×§×¦×™×•×ª: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;functions&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">â€¢ ××—×œ×§×•×ª: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;classes&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">â€¢ × ×™×§×•×“ ××•×¨×›×‘×•×ª: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;complexity_score&#39;</span><span class="p">]</span><span class="si">}</span>

<span class="s2">ğŸ“– **×§×¨×™××•×ª:**</span>
<span class="s2">â€¢ × ×™×§×•×“ ×§×¨×™××•×ª: </span><span class="si">{</span><span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;readability_score&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;×œ× ×–××™×Ÿ&#39;</span><span class="p">)</span><span class="si">}</span>
<span class="s2">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="n">functions</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ğŸ”§ **×¤×•× ×§×¦×™×•×ª ×©× ××¦××•:**</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">functions</span><span class="p">[:</span><span class="mi">10</span><span class="p">]:</span>  <span class="c1"># ××§×¡×™××•× 10 ×¤×•× ×§×¦×™×•×ª</span>
                <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;â€¢ `</span><span class="si">{</span><span class="n">func</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">()` (×©×•×¨×” </span><span class="si">{</span><span class="n">func</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">functions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;â€¢ ×•×¢×•×“ </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">functions</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">10</span><span class="si">}</span><span class="s2"> ×¤×•× ×§×¦×™×•×ª...</span><span class="se">\n</span><span class="s2">&quot;</span>
        
        <span class="c1"># ×”×¦×¢×•×ª ×œ×©×™×¤×•×¨</span>
        <span class="n">suggestions</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">if</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;comment_lines&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;total_lines&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">:</span>
            <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;ğŸ’¡ ×”×•×¡×£ ×™×•×ª×¨ ×”×¢×¨×•×ª ×œ×§×•×“&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;functions&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;total_lines&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
            <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;ğŸ’¡ ×©×§×•×œ ×œ×—×œ×§ ××ª ×”×§×•×“ ×œ×¤×•× ×§×¦×™×•×ª&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;complexity_score&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;total_lines&#39;</span><span class="p">]:</span>
            <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;ğŸ’¡ ×”×§×•×“ ××•×¨×›×‘ - ×©×§×•×œ ×¤×™×©×•×˜&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">suggestions</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ğŸ’¡ **×”×¦×¢×•×ª ×œ×©×™×¤×•×¨:**</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">suggestion</span> <span class="ow">in</span> <span class="n">suggestions</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;â€¢ </span><span class="si">{</span><span class="n">suggestion</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdvancedBotHandlers.status_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.status_command">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">status_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;/status â€“ ×‘×“×™×§×•×ª ×‘×¨×™××•×ª ×‘×¡×™×¡×™×•×ª: DB, Redis, GitHub API&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># ×”×¨×©××•×ª: ××“××™× ×™× ×‘×œ×‘×“</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_admin</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×¤×§×•×“×” ×–××™× ×” ×œ×× ×”×œ×™× ×‘×œ×‘×“&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="c1"># DB status - ×‘×“×™×§×ª ×¤×™× ×’ ×××™×ª×™×ª ×œ-MongoDB</span>
            <span class="c1"># ×”×¢×¨×”: × ×™×’×© ×œ×¤×•× ×§×¦×™×” ×“×¨×š ×”××•×“×•×œ ×›×“×™ ×œ××¤×©×¨ monkeypatch ×™×¦×™×‘ ×‘×˜×¡×˜×™×</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">importlib</span>
                <span class="n">_bh</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
                <span class="n">_checker</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">_bh</span><span class="p">,</span> <span class="s1">&#39;check_db_connection&#39;</span><span class="p">,</span> <span class="n">check_db_connection</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">_checker</span> <span class="o">=</span> <span class="n">check_db_connection</span>
            <span class="n">db_ok</span> <span class="o">=</span> <span class="k">await</span> <span class="n">_checker</span><span class="p">()</span>

            <span class="c1"># Redis status</span>
            <span class="n">redis_ok</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">cache_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">cache</span> <span class="k">as</span> <span class="n">_cache</span>
                <span class="n">redis_ok</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">_cache</span><span class="p">,</span> <span class="s1">&#39;is_enabled&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">redis_ok</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># GitHub API rate limit (optional)</span>
            <span class="n">gh_status</span> <span class="o">=</span> <span class="s2">&quot;unknown&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;GITHUB_TOKEN&quot;</span><span class="p">):</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">http_async</span><span class="w"> </span><span class="kn">import</span> <span class="n">request</span> <span class="k">as</span> <span class="n">async_request</span>
                    <span class="k">async</span> <span class="k">with</span> <span class="n">async_request</span><span class="p">(</span>
                        <span class="s2">&quot;GET&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;https://api.github.com/rate_limit&quot;</span><span class="p">,</span>
                        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;token </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;GITHUB_TOKEN&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">},</span>
                        <span class="n">service</span><span class="o">=</span><span class="s2">&quot;github&quot;</span><span class="p">,</span>
                        <span class="n">endpoint</span><span class="o">=</span><span class="s2">&quot;rate_limit&quot;</span><span class="p">,</span>
                    <span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                        <span class="n">remaining</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resources&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;core&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;remaining&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                        <span class="n">limit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resources&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;core&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;limit&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                        <span class="n">used_pct</span> <span class="o">=</span> <span class="p">(</span><span class="mi">100</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">remaining</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span> <span class="k">if</span> <span class="n">limit</span> <span class="k">else</span> <span class="mi">0</span>
                        <span class="n">gh_status</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">remaining</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">limit</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">used_pct</span><span class="si">}</span><span class="s2">% used)&quot;</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">gh_status</span> <span class="o">=</span> <span class="s2">&quot;error&quot;</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">_emoji</span><span class="p">(</span><span class="n">ok</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;ğŸŸ¢&quot;</span> <span class="k">if</span> <span class="n">ok</span> <span class="k">else</span> <span class="s2">&quot;ğŸ”´&quot;</span>

            <span class="c1"># Sentry status (DSN/API) â€“ ×œ× ×—×•×©×¤×™× ×¡×•×“×•×ª</span>
            <span class="n">sentry_dsn_set</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SENTRY_DSN&quot;</span><span class="p">))</span>
            <span class="n">sentry_api_ready</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SENTRY_AUTH_TOKEN&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SENTRY_ORG&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SENTRY_ORG_SLUG&quot;</span><span class="p">)))</span>

            <span class="c1"># OTEL exporter â€“ best-effort: ×§×™×™× endpoint ×™×“×•×¢ ××• ××•×“×•×œ otel ×–××™×Ÿ ×‘×¡×‘×™×‘×”</span>
            <span class="n">otel_ready</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">otel_ready</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;OTEL_EXPORTER_OTLP_ENDPOINT&quot;</span><span class="p">)</span>
                    <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;OTEL_EXPORTER_OTLP_TRACES_ENDPOINT&quot;</span><span class="p">)</span>
                    <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;OTEL_EXPORTER_OTLP_METRICS_ENDPOINT&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">otel_ready</span><span class="p">:</span>
                    <span class="kn">import</span><span class="w"> </span><span class="nn">importlib</span>
                    <span class="n">_</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s2">&quot;opentelemetry&quot;</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
                    <span class="n">otel_ready</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">otel_ready</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ“‹ Status</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;DB: </span><span class="si">{</span><span class="n">_emoji</span><span class="p">(</span><span class="n">db_ok</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Redis: </span><span class="si">{</span><span class="n">_emoji</span><span class="p">(</span><span class="n">redis_ok</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;GitHub: </span><span class="si">{</span><span class="n">gh_status</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Sentry DSN: </span><span class="si">{</span><span class="n">_emoji</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">sentry_dsn_set</span><span class="p">))</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Sentry API: </span><span class="si">{</span><span class="n">_emoji</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">sentry_api_ready</span><span class="p">))</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;OTEL Exporter: </span><span class="si">{</span><span class="n">_emoji</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">otel_ready</span><span class="p">))</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘-/status: </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdvancedBotHandlers.sentry_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.sentry_command">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">sentry_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;/sen â€“ ××—×–×™×¨ ×§×™×©×•×¨ ×œ-Sentry (×× ×”×œ×™× ×‘×œ×‘×“)&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_admin</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×¤×§×•×“×” ×–××™× ×” ×œ×× ×”×œ×™× ×‘×œ×‘×“&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="c1"># ×¢×“×™×¤×•×ª ×œ-ENV ×™×©×™×¨ ×©×œ ×§×™×©×•×¨ ×“××©×‘×•×¨×“</span>
            <span class="n">dashboard</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SENTRY_DASHBOARD_URL&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SENTRY_PROJECT_URL&quot;</span><span class="p">)</span>
            <span class="n">dsn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SENTRY_DSN&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
            <span class="n">url</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">dashboard</span><span class="p">:</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">dashboard</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># × × ×¡×” ×œ×’×–×•×¨ ×“×•××™×™×Ÿ ××”-DSN (×œ×œ× ×–×œ×™×’×ª ×¡×•×“×•×ª)</span>
                <span class="n">host</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">urlparse</span>
                    <span class="n">parsed</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">dsn</span><span class="p">)</span>
                    <span class="n">raw_host</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">hostname</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
                    <span class="c1"># Sentry SaaS DSN hosts look like o123.ingest.sentry.io or ingest.sentry.io</span>
                    <span class="c1"># ×œ×œ×™× ×§ UI × ×¨×¦×” https://sentry.io/...</span>
                    <span class="k">if</span> <span class="n">raw_host</span> <span class="o">==</span> <span class="s1">&#39;sentry.io&#39;</span> <span class="ow">or</span> <span class="n">raw_host</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.sentry.io&#39;</span><span class="p">):</span>
                        <span class="n">host</span> <span class="o">=</span> <span class="s1">&#39;sentry.io&#39;</span>
                    <span class="k">elif</span> <span class="n">raw_host</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ingest.&#39;</span><span class="p">):</span>
                        <span class="n">host</span> <span class="o">=</span> <span class="n">raw_host</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s1">&#39;ingest.&#39;</span><span class="p">):]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">host</span> <span class="o">=</span> <span class="n">raw_host</span> <span class="ow">or</span> <span class="kc">None</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">host</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">org</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SENTRY_ORG&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SENTRY_ORG_SLUG&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">host</span> <span class="ow">and</span> <span class="n">org</span><span class="p">:</span>
                    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2">/organizations/</span><span class="si">{</span><span class="n">org</span><span class="si">}</span><span class="s2">/issues/&quot;</span>
                <span class="k">elif</span> <span class="n">host</span><span class="p">:</span>
                    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2">/&quot;</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;â„¹ï¸ Sentry ×œ× ××•×’×“×¨ ×‘×¡×‘×™×‘×” ×–×•.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">safe_url</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ğŸ”— Sentry: </span><span class="si">{</span><span class="n">safe_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘-/sen: </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdvancedBotHandlers.uptime_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.uptime_command">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">uptime_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;/uptime â€“ ××—×•×– ×–××™× ×•×ª ×›×•×œ×œ ×œ×¤×™ metrics&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># ×”×¨×©××•×ª: ××“××™× ×™× ×‘×œ×‘×“</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_admin</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×¤×§×•×“×” ×–××™× ×” ×œ×× ×”×œ×™× ×‘×œ×‘×“&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_uptime_percentage</span>  <span class="c1"># type: ignore</span>
                <span class="n">uptime</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">get_uptime_percentage</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">uptime</span> <span class="o">=</span> <span class="mf">100.0</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;â±ï¸ Uptime: </span><span class="si">{</span><span class="n">uptime</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘-/uptime: </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdvancedBotHandlers.observe_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.observe_command">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">observe_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;/observe â€“ ×¡×™×›×•× ×—×™; /observe -v/ -vv â€“ ×ª×¦×•×’×” ××¤×•×¨×˜×ª ×¢× ××§×•×¨×•×ª&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># ×”×¨×©××•×ª: ××“××™× ×™× ×‘×œ×‘×“</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_admin</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×¤×§×•×“×” ×–××™× ×” ×œ×× ×”×œ×™× ×‘×œ×‘×“&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s1">&#39;args&#39;</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>
            <span class="n">verbose_level</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;-vv&quot;</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">):</span>
                <span class="n">verbose_level</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;-v&quot;</span><span class="p">,</span> <span class="s2">&quot;--verbose&quot;</span><span class="p">}</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">):</span>
                <span class="n">verbose_level</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="c1"># ×¤×¨××˜×¨×™× ××•×¤×¦×™×•× ×œ×™×™×: source=db|memory|all, window=5m|1h|24h</span>
            <span class="n">source</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span>
            <span class="n">window</span> <span class="o">=</span> <span class="s2">&quot;24h&quot;</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;source=&quot;</span><span class="p">):</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;db&quot;</span><span class="p">,</span> <span class="s2">&quot;memory&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">}:</span>
                        <span class="n">source</span> <span class="o">=</span> <span class="n">v</span>
                <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;window=&quot;</span><span class="p">):</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;5m&quot;</span><span class="p">,</span> <span class="s2">&quot;1h&quot;</span><span class="p">,</span> <span class="s2">&quot;24h&quot;</span><span class="p">}:</span>
                        <span class="n">window</span> <span class="o">=</span> <span class="n">v</span>

            <span class="c1"># ×× ×œ× ××¦×‘ ××¤×•×¨×˜ â€“ ×”×©××¨ ×”×ª× ×”×’×•×ª ×§×™×™××ª ×œ×œ× ×©×™× ×•×™</span>
            <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;source=&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">t</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;window=&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">args</span><span class="p">):</span>
                <span class="c1"># Uptime</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_uptime_percentage</span>  <span class="c1"># type: ignore</span>
                    <span class="n">uptime</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">get_uptime_percentage</span><span class="p">())</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">uptime</span> <span class="o">=</span> <span class="mf">100.0</span>

                <span class="c1"># Error rate</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">alert_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_current_error_rate_percent</span>  <span class="c1"># type: ignore</span>
                    <span class="n">error_rate</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">get_current_error_rate_percent</span><span class="p">(</span><span class="n">window_sec</span><span class="o">=</span><span class="mi">5</span> <span class="o">*</span> <span class="mi">60</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">error_rate</span> <span class="o">=</span> <span class="mf">0.0</span>

                <span class="c1"># Active users â€“ ×›×¨×’×¢ placeholder</span>
                <span class="n">active_users</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">codebot_active_users_total</span>  <span class="c1"># type: ignore</span>
                    <span class="k">if</span> <span class="n">codebot_active_users_total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">active_users</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">active_users</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="c1"># Alerts count (24h) ×¢× fallback</span>
                <span class="n">alerts_24h</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">critical_24h</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">used_db</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">monitoring.alerts_storage</span><span class="w"> </span><span class="kn">import</span> <span class="n">count_alerts_last_hours</span>  <span class="c1"># type: ignore</span>
                    <span class="n">total_db</span><span class="p">,</span> <span class="n">critical_db</span> <span class="o">=</span> <span class="n">count_alerts_last_hours</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">total_db</span> <span class="ow">or</span> <span class="n">critical_db</span><span class="p">):</span>
                        <span class="n">alerts_24h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">total_db</span><span class="p">)</span>
                        <span class="n">critical_24h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">critical_db</span><span class="p">)</span>
                        <span class="n">used_db</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">used_db</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">used_db</span><span class="p">:</span>
                    <span class="n">internal_total</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">internal_critical</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="kn">from</span><span class="w"> </span><span class="nn">internal_alerts</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_recent_alerts</span>  <span class="c1"># type: ignore</span>
                        <span class="n">items</span> <span class="o">=</span> <span class="n">get_recent_alerts</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
                        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
                        <span class="n">day_ago</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span> <span class="o">-</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">3600</span>
                        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">ts</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ts&#39;</span><span class="p">)</span>
                                <span class="n">t</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ts</span><span class="p">))</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span> <span class="k">if</span> <span class="n">ts</span> <span class="k">else</span> <span class="mf">0.0</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="n">t</span> <span class="o">=</span> <span class="mf">0.0</span>
                            <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;=</span> <span class="n">day_ago</span><span class="p">:</span>
                                <span class="n">internal_total</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;severity&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;critical&#39;</span><span class="p">:</span>
                                    <span class="n">internal_critical</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">internal_total</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">internal_critical</span> <span class="o">=</span> <span class="mi">0</span>

                    <span class="n">dispatch_critical</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="kn">from</span><span class="w"> </span><span class="nn">alert_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_dispatch_log</span>  <span class="c1"># type: ignore</span>
                        <span class="n">ditems</span> <span class="o">=</span> <span class="n">get_dispatch_log</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
                        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
                        <span class="n">day_ago</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span> <span class="o">-</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">3600</span>
                        <span class="n">seen_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                        <span class="k">for</span> <span class="n">di</span> <span class="ow">in</span> <span class="n">ditems</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">ts</span> <span class="o">=</span> <span class="n">di</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ts&#39;</span><span class="p">)</span>
                                <span class="n">t</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ts</span><span class="p">))</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span> <span class="k">if</span> <span class="n">ts</span> <span class="k">else</span> <span class="mf">0.0</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="n">t</span> <span class="o">=</span> <span class="mf">0.0</span>
                            <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;=</span> <span class="n">day_ago</span><span class="p">:</span>
                                <span class="n">aid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">di</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alert_id&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                                <span class="k">if</span> <span class="n">aid</span><span class="p">:</span>
                                    <span class="n">seen_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
                        <span class="n">dispatch_critical</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">seen_ids</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">dispatch_critical</span> <span class="o">=</span> <span class="mi">0</span>

                    <span class="k">if</span> <span class="n">internal_total</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">alerts_24h</span> <span class="o">=</span> <span class="n">internal_total</span>
                        <span class="n">critical_24h</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">internal_critical</span><span class="p">,</span> <span class="n">dispatch_critical</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">alerts_24h</span> <span class="o">=</span> <span class="n">dispatch_critical</span>
                        <span class="n">critical_24h</span> <span class="o">=</span> <span class="n">dispatch_critical</span>

                <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;ğŸ” Observability Overview</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Uptime: </span><span class="si">{</span><span class="n">uptime</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Error Rate: </span><span class="si">{</span><span class="n">error_rate</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Active Users: </span><span class="si">{</span><span class="n">active_users</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Alerts (24h): </span><span class="si">{</span><span class="n">alerts_24h</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">critical_24h</span><span class="si">}</span><span class="s2"> critical)&quot;</span>
                <span class="p">)</span>
                <span class="c1"># ×—×©×•×‘: ×œ×‘×˜×œ HTML parsing ×›×“×™ ×œ×× ×•×¢ ×›×©×œ×™× ×¢×œ ×ª×•×•×™×/××–×”×™× ×œ×-××•×ª×¨×™×</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="c1"># ---- ××¦×‘ ××¤×•×¨×˜ (-v / -vv) ----</span>
            <span class="c1"># Uptime</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_uptime_percentage</span>  <span class="c1"># type: ignore</span>
                <span class="n">uptime</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">get_uptime_percentage</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">uptime</span> <span class="o">=</span> <span class="mf">100.0</span>

            <span class="c1"># Current metrics + thresholds (memory)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">alert_manager</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                    <span class="n">get_current_error_rate_percent</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
                    <span class="n">get_current_avg_latency_seconds</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
                    <span class="n">get_thresholds_snapshot</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
                <span class="p">)</span>
                <span class="n">cur_err</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">get_current_error_rate_percent</span><span class="p">(</span><span class="n">window_sec</span><span class="o">=</span><span class="mi">5</span> <span class="o">*</span> <span class="mi">60</span><span class="p">))</span>
                <span class="n">cur_lat</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">get_current_avg_latency_seconds</span><span class="p">(</span><span class="n">window_sec</span><span class="o">=</span><span class="mi">5</span> <span class="o">*</span> <span class="mi">60</span><span class="p">))</span>
                <span class="n">thr</span> <span class="o">=</span> <span class="n">get_thresholds_snapshot</span><span class="p">()</span> <span class="ow">or</span> <span class="p">{}</span>
                <span class="n">err_thr</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">thr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error_rate_percent&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;threshold&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="ow">or</span> <span class="mf">0.0</span><span class="p">)</span>
                <span class="n">lat_thr</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">thr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;latency_seconds&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;threshold&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="ow">or</span> <span class="mf">0.0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">cur_err</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">cur_lat</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">err_thr</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">lat_thr</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="c1"># ×—×œ×•×Ÿ ×–××Ÿ ×œ×¡×¤×™×¨×ª ×”×ª×¨××•×ª</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">timedelta</span>
            <span class="n">now_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">window</span> <span class="o">==</span> <span class="s2">&quot;5m&quot;</span><span class="p">:</span>
                <span class="n">window_seconds</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">60</span>
                <span class="n">since_dt</span> <span class="o">=</span> <span class="n">now_dt</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">window_seconds</span><span class="p">)</span>
                <span class="n">window_label</span> <span class="o">=</span> <span class="s2">&quot;5m&quot;</span>
            <span class="k">elif</span> <span class="n">window</span> <span class="o">==</span> <span class="s2">&quot;1h&quot;</span><span class="p">:</span>
                <span class="n">window_seconds</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span>
                <span class="n">since_dt</span> <span class="o">=</span> <span class="n">now_dt</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">window_seconds</span><span class="p">)</span>
                <span class="n">window_label</span> <span class="o">=</span> <span class="s2">&quot;1h&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">window_seconds</span> <span class="o">=</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">3600</span>
                <span class="n">since_dt</span> <span class="o">=</span> <span class="n">now_dt</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">window_seconds</span><span class="p">)</span>
                <span class="n">window_label</span> <span class="o">=</span> <span class="s2">&quot;24h&quot;</span>

            <span class="c1"># Alerts â€“ DB</span>
            <span class="n">db_total</span> <span class="o">=</span> <span class="n">db_critical</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">db_ok</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">source</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;db&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">}:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">monitoring.alerts_storage</span><span class="w"> </span><span class="kn">import</span> <span class="n">count_alerts_since</span>  <span class="c1"># type: ignore</span>
                    <span class="n">db_total</span><span class="p">,</span> <span class="n">db_critical</span> <span class="o">=</span> <span class="n">count_alerts_since</span><span class="p">(</span><span class="n">since_dt</span><span class="p">)</span>
                    <span class="n">db_ok</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">db_ok</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># Alerts â€“ Memory (internal buffer) and dispatch de-dup check</span>
            <span class="n">mem_total</span> <span class="o">=</span> <span class="n">mem_critical</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">disp_unique_critical</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">source</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;memory&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">}:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">internal_alerts</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_recent_alerts</span>  <span class="c1"># type: ignore</span>
                    <span class="n">items</span> <span class="o">=</span> <span class="n">get_recent_alerts</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># ×‘×—×¨ ×‘×¡×™×¡ ×–××Ÿ ×™×¦×™×‘: ××§×¡&#39; ×”-ts ××”×–×™×›×¨×•×Ÿ (×× ×§×™×™×), ××—×¨×ª now</span>
                    <span class="n">base_ts</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                            <span class="n">ts</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ts&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">ts</span><span class="p">:</span>
                                <span class="n">t</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ts</span><span class="p">))</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
                                <span class="n">base_ts</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">base_ts</span> <span class="ow">or</span> <span class="n">t</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">base_ts</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">base_ts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">base_ts</span> <span class="o">=</span> <span class="n">since_dt</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
                    <span class="n">min_ts</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">base_ts</span><span class="p">)</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">window_seconds</span><span class="p">)</span>
                    <span class="n">t_total</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">t_critical</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">ts</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ts&#39;</span><span class="p">)</span>
                            <span class="n">t</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ts</span><span class="p">))</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span> <span class="k">if</span> <span class="n">ts</span> <span class="k">else</span> <span class="mf">0.0</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="n">t</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;=</span> <span class="n">min_ts</span><span class="p">:</span>
                            <span class="n">t_total</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;severity&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;critical&#39;</span><span class="p">:</span>
                                <span class="n">t_critical</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">mem_total</span> <span class="o">=</span> <span class="n">t_total</span>
                    <span class="n">mem_critical</span> <span class="o">=</span> <span class="n">t_critical</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">mem_total</span> <span class="o">=</span> <span class="n">mem_critical</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="c1"># Unique critical IDs from dispatch log</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">alert_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_dispatch_log</span>  <span class="c1"># type: ignore</span>
                    <span class="n">ditems</span> <span class="o">=</span> <span class="n">get_dispatch_log</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
                    <span class="c1"># ×¡××•×š ×œ×‘×¡×™×¡ ×”×–××Ÿ ×©× ×§×‘×¢ ×œ×–×™×›×¨×•×Ÿ ×›×“×™ ×œ×©××¨ ×¢×§×‘×™×•×ª ×¢× ×—×œ×•×Ÿ ×”×–××Ÿ ×‘×¤×•×¢×œ</span>
                    <span class="k">if</span> <span class="s1">&#39;base_ts&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="ow">and</span> <span class="n">base_ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">min_ts</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">base_ts</span><span class="p">)</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">window_seconds</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">min_ts</span> <span class="o">=</span> <span class="n">since_dt</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
                    <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">di</span> <span class="ow">in</span> <span class="n">ditems</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">ts</span> <span class="o">=</span> <span class="n">di</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ts&#39;</span><span class="p">)</span>
                            <span class="n">t</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ts</span><span class="p">))</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span> <span class="k">if</span> <span class="n">ts</span> <span class="k">else</span> <span class="mf">0.0</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="n">t</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;=</span> <span class="n">min_ts</span><span class="p">:</span>
                            <span class="n">aid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">di</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alert_id&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">aid</span><span class="p">:</span>
                                <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
                    <span class="n">disp_unique_critical</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">seen</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">disp_unique_critical</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Cooling snapshot &amp; sinks health (best-effort)</span>
            <span class="n">cooldown_lines</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">alert_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_cooldown_snapshot</span>  <span class="c1"># type: ignore</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">get_cooldown_snapshot</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>
            <span class="k">if</span> <span class="n">get_cooldown_snapshot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># type: ignore[truthy-bool]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">snap</span> <span class="o">=</span> <span class="n">get_cooldown_snapshot</span><span class="p">()</span> <span class="ow">or</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;error_rate_percent&quot;</span><span class="p">,</span> <span class="s2">&quot;latency_seconds&quot;</span><span class="p">):</span>
                        <span class="n">info</span> <span class="o">=</span> <span class="n">snap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
                        <span class="n">active</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cooldown_active&quot;</span><span class="p">))</span>
                        <span class="n">left</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;seconds_left&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">active</span> <span class="ow">and</span> <span class="n">left</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">cooldown_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: active (~</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">left</span><span class="p">)</span><span class="si">}</span><span class="s2">s left)&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">cooldown_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: idle&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">cooldown_lines</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Sinks health from dispatch log</span>
            <span class="n">sinks_lines</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">alert_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_dispatch_log</span>  <span class="c1"># type: ignore</span>
                <span class="n">ditems</span> <span class="o">=</span> <span class="n">get_dispatch_log</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
                <span class="n">per_sink</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">di</span> <span class="ow">in</span> <span class="n">ditems</span><span class="p">:</span>
                    <span class="n">sink</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">di</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sink&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
                    <span class="n">ok</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">di</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ok&#39;</span><span class="p">))</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">per_sink</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">sink</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;fail&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
                    <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                        <span class="n">s</span><span class="p">[</span><span class="s2">&quot;ok&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">s</span><span class="p">[</span><span class="s2">&quot;fail&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">sink</span><span class="p">,</span> <span class="n">agg</span> <span class="ow">in</span> <span class="n">per_sink</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">total</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">agg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ok&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">agg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fail&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>
                    <span class="n">okc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">agg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ok&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                    <span class="n">sinks_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sink</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">okc</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s2"> ok&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">sinks_lines</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># ×‘× ×™×™×ª ×”×•×“×¢×”</span>
            <span class="n">lines</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;ğŸ” Observability â€“ verbose&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Uptime: </span><span class="si">{</span><span class="n">uptime</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">% (source: memory)&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Error Rate (5m): curr=</span><span class="si">{</span><span class="n">cur_err</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">% | thr=</span><span class="si">{</span><span class="n">err_thr</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">% (source: memory)&quot;</span>
            <span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Latency (5m): curr=</span><span class="si">{</span><span class="n">cur_lat</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">s | thr=</span><span class="si">{</span><span class="n">lat_thr</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">s (source: memory)&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Alerts sections</span>
            <span class="k">if</span> <span class="n">source</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;db&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">}:</span>
                <span class="k">if</span> <span class="n">db_ok</span> <span class="ow">and</span> <span class="n">db_total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">db_critical</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Alerts (DB, window=</span><span class="si">{</span><span class="n">window_label</span><span class="si">}</span><span class="s2">): total=</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">db_total</span><span class="p">)</span><span class="si">}</span><span class="s2"> | critical=</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">db_critical</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Alerts (DB, window=</span><span class="si">{</span><span class="n">window_label</span><span class="si">}</span><span class="s2">): unavailable (fallback to memory)&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">source</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;memory&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">}:</span>
                <span class="k">if</span> <span class="n">mem_total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mem_critical</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">extra</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;; unique_critical_ids=</span><span class="si">{</span><span class="n">disp_unique_critical</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">disp_unique_critical</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Alerts (Memory, window=</span><span class="si">{</span><span class="n">window_label</span><span class="si">}</span><span class="s2">): total=</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">mem_total</span><span class="p">)</span><span class="si">}</span><span class="s2"> | critical=</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">mem_critical</span><span class="p">)</span><span class="si">}{</span><span class="n">extra</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Alerts (Memory, window=</span><span class="si">{</span><span class="n">window_label</span><span class="si">}</span><span class="s2">): n/a&quot;</span><span class="p">)</span>

            <span class="c1"># Recent errors (limited)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">observability</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_recent_errors</span>  <span class="c1"># type: ignore</span>
                <span class="n">recent</span> <span class="o">=</span> <span class="n">get_recent_errors</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">recent</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">recent</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Recent Errors (memory, Nâ‰¤5):&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">recent</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">code</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error_code&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;code&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>
                        <span class="n">ev</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;event&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span>
                        <span class="n">ts</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ts&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- [</span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">ev</span><span class="si">}</span><span class="s2"> â€” </span><span class="si">{</span><span class="n">ts</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">continue</span>

            <span class="c1"># Cooling &amp; Health</span>
            <span class="k">if</span> <span class="n">cooldown_lines</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Cooling:&quot;</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;- &quot;</span> <span class="o">+</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cooldown_lines</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">sinks_lines</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Sinks:&quot;</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;- &quot;</span> <span class="o">+</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sinks_lines</span><span class="p">])</span>

            <span class="c1"># -vv: ×¨×©×™××ª ××–×”×™ ×”×ª×¨××•×ª ××—×¨×•× ×•×ª ××”-DB (N=10)</span>
            <span class="k">if</span> <span class="n">verbose_level</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">source</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;db&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">}:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">db_ok</span><span class="p">:</span>
                        <span class="kn">from</span><span class="w"> </span><span class="nn">monitoring.alerts_storage</span><span class="w"> </span><span class="kn">import</span> <span class="n">list_recent_alert_ids</span>  <span class="c1"># type: ignore</span>
                        <span class="n">ids</span> <span class="o">=</span> <span class="n">list_recent_alert_ids</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">ids</span><span class="p">:</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Recent Alert IDs (DB, Nâ‰¤10):&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ids</span><span class="p">[:</span><span class="mi">10</span><span class="p">]):</span>
                        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># ×’×‘×•×œ ××•×¨×š: ×—×ª×•×š ×× ××¨×•×š ××“×™</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3500</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">[:</span><span class="mi">3400</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">â€¦ (truncated)&quot;</span>
            <span class="c1"># ×—×©×•×‘: ×œ×‘×˜×œ HTML parsing ×›×“×™ ×œ×× ×•×¢ ×›×©×œ×™× ×¢×œ ×ª×•×•×™×/××–×”×™× ×œ×-××•×ª×¨×™× (×œ××©×œ IDs ×¢× &#39;&lt;&#39;)</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘-/observe: </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdvancedBotHandlers.alerts_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.alerts_command">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">alerts_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;/alerts â€“ ×”×¦×’ 5 ×”×”×ª×¨××•×ª ×”××—×¨×•× ×•×ª ××”××¢×¨×›×ª ×”×¤× ×™××™×ª&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># ×”×¨×©××•×ª: ××“××™× ×™× ×‘×œ×‘×“</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_admin</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×¤×§×•×“×” ×–××™× ×” ×œ×× ×”×œ×™× ×‘×œ×‘×“&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">internal_alerts</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_recent_alerts</span>  <span class="c1"># type: ignore</span>
                <span class="n">items</span> <span class="o">=</span> <span class="n">get_recent_alerts</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">items</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;â„¹ï¸ ××™×Ÿ ×”×ª×¨××•×ª ××—×¨×•× ×•×ª&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ğŸš¨ ×”×ª×¨××•×ª ××—×¨×•× ×•×ª:&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;alert&#39;</span><span class="p">)</span>
                <span class="n">sev</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;severity&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;info&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                <span class="n">summary</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;summary&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. [</span><span class="si">{</span><span class="n">sev</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> â€“ </span><span class="si">{</span><span class="n">summary</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘-/alerts: </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdvancedBotHandlers.incidents_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.incidents_command">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">incidents_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;/incidents â€“ 5 ×”×ª×§×œ×•×ª ×”××—×¨×•× ×•×ª (×©×, ×–××Ÿ, ×˜×™×¤×•×œ)&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_admin</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×¤×§×•×“×” ×–××™× ×” ×œ×× ×”×œ×™× ×‘×œ×‘×“&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">remediation_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_incidents</span>  <span class="c1"># type: ignore</span>
                <span class="n">items</span> <span class="o">=</span> <span class="n">get_incidents</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ğŸ§  ×ª×§×œ×•×ª ××—×¨×•× ×•×ª:&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">items</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;(××™×Ÿ ×ª×§×œ×•×ª ××ª×•×¢×“×•×ª)&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">((</span><span class="n">items</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span> <span class="k">if</span> <span class="n">items</span> <span class="k">else</span> <span class="p">[]),</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;incident&#39;</span><span class="p">)</span>
                <span class="n">ts</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ts&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">action</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;response_action&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> â€” </span><span class="si">{</span><span class="n">ts</span><span class="si">}</span><span class="s2"> â€” action: </span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># ×”×¨×—×‘×”: ×ª×—×–×™×•×ª ×¤×¢×™×œ×•×ª (Observability v6)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">predictive_engine</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_recent_predictions</span>  <span class="c1"># type: ignore</span>
                <span class="n">preds</span> <span class="o">=</span> <span class="n">get_recent_predictions</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">preds</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ğŸ”® ×ª×—×–×™×•×ª ×¤×¢×™×œ×•×ª:&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">preds</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;(××™×Ÿ ×ª×—×–×™×•×ª ×¤×¢×™×œ×•×ª)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">preds</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:],</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metric&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
                    <span class="n">when</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;predicted_cross_ts&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;predicted_cross_at&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2"> â†’ </span><span class="si">{</span><span class="n">when</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘-/incidents: </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdvancedBotHandlers.predict_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.predict_command">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">predict_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;/predict â€“ ×ª×—×–×™×ª ×ª×§×œ×•×ª ×œ-3 ×©×¢×•×ª ×”×§×¨×•×‘×•×ª ×¢× ×—×™×•×•×™ ××’××•×ª.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># ×”×¨×©××•×ª: ××“××™× ×™× ×‘×œ×‘×“</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_admin</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×¤×§×•×“×” ×–××™× ×” ×œ×× ×”×œ×™× ×‘×œ×‘×“&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">predictive_engine</span><span class="w"> </span><span class="kn">import</span> <span class="n">evaluate_predictions</span><span class="p">,</span> <span class="n">note_observation</span>  <span class="c1"># type: ignore</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;â„¹ï¸ ×× ×•×¢ ×—×™×–×•×™ ××™× ×• ×–××™×Ÿ ×‘×¡×‘×™×‘×” ×–×•&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">horizon</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span>  <span class="c1"># 3h</span>
            <span class="c1"># Ensure we have a fresh observation snapshot before evaluating</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">note_observation</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">trends</span> <span class="o">=</span> <span class="n">evaluate_predictions</span><span class="p">(</span><span class="n">horizon_seconds</span><span class="o">=</span><span class="n">horizon</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">trends</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;ğŸ”® ××™×Ÿ × ×ª×•× ×™× ××¡×¤×™×§×™× ×œ×—×™×–×•×™ ×›×¨×’×¢&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">_dir_emoji</span><span class="p">(</span><span class="n">slope</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">slope</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">:</span>
                        <span class="k">return</span> <span class="s2">&quot;ğŸ”´&quot;</span>  <span class="c1"># ×¢×œ×™×”</span>
                    <span class="k">if</span> <span class="n">slope</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">1e-6</span><span class="p">:</span>
                        <span class="k">return</span> <span class="s2">&quot;ğŸŸ¢&quot;</span>  <span class="c1"># ×™×¨×™×“×”</span>
                    <span class="k">return</span> <span class="s2">&quot;âšª&quot;</span>      <span class="c1"># ×™×¦×™×‘</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s2">&quot;âšª&quot;</span>
            <span class="n">lines</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ğŸ”® Predictive Health â€“ 3h&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">trends</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">metric</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
                    <span class="n">slope</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="s1">&#39;slope_per_minute&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="ow">or</span> <span class="mf">0.0</span><span class="p">)</span>
                    <span class="n">current</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="s1">&#39;current_value&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="ow">or</span> <span class="mf">0.0</span><span class="p">)</span>
                    <span class="n">thr</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="s1">&#39;threshold&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="ow">or</span> <span class="mf">0.0</span><span class="p">)</span>
                    <span class="n">cross_ts</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="s1">&#39;predicted_cross_ts&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">emoji</span> <span class="o">=</span> <span class="n">_dir_emoji</span><span class="p">(</span><span class="n">slope</span><span class="p">)</span>
                    <span class="n">base</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">emoji</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">: curr=</span><span class="si">{</span><span class="n">current</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> thr=</span><span class="si">{</span><span class="n">thr</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> slope/min=</span><span class="si">{</span><span class="n">slope</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">if</span> <span class="n">cross_ts</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timezone</span>
                            <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">cross_ts</span><span class="p">),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
                            <span class="n">when</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M UTC&#39;</span><span class="p">)</span>
                            <span class="n">base</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; â†’ ×—×¦×™×™×” ×¦×¤×•×™×” ×‘-</span><span class="si">{</span><span class="n">when</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="n">base</span> <span class="o">+=</span> <span class="s2">&quot; â†’ ×—×¦×™×™×” ×¦×¤×•×™×”&quot;</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘-/predict: </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdvancedBotHandlers.silence_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.silence_command">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">silence_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;/silence &lt;name|pattern&gt; &lt;duration&gt; [reason...] [severity=&lt;level&gt;] [--force]</span>

<span class="sd">        Examples:</span>
<span class="sd">        /silence &quot;High Latency&quot; 2h reason=maintenance</span>
<span class="sd">        /silence High.* 30m severity=critical</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Admins only handled by decorator; parse args</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;args&quot;</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>
            <span class="c1"># (no additional args parsing here)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;â„¹ï¸ ×©×™××•×©: /silence &lt;name|pattern&gt; &lt;duration&gt; [reason...] [severity=&lt;level&gt;] [--force]&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">duration_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">reason_tokens</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
            <span class="n">force</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;--force&quot;</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">reason_tokens</span><span class="p">)</span>
            <span class="n">reason_tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">reason_tokens</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;--force&quot;</span><span class="p">]</span>
            <span class="n">severity</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># extract severity=xxx token if present</span>
            <span class="n">new_tokens</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">reason_tokens</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;severity=&quot;</span><span class="p">):</span>
                    <span class="n">severity</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">reason_tokens</span> <span class="o">=</span> <span class="n">new_tokens</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reason_tokens</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="c1"># duration parse &amp; bounds</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">monitoring.silences</span><span class="w"> </span><span class="kn">import</span> <span class="n">parse_duration_to_seconds</span>  <span class="c1"># type: ignore</span>
                <span class="n">max_days_env</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SILENCE_MAX_DAYS&quot;</span><span class="p">,</span> <span class="s2">&quot;7&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">7</span><span class="p">)</span>
                <span class="n">dur_sec</span> <span class="o">=</span> <span class="n">parse_duration_to_seconds</span><span class="p">(</span><span class="n">duration_str</span><span class="p">,</span> <span class="n">max_days</span><span class="o">=</span><span class="n">max_days_env</span><span class="p">)</span>  <span class="c1"># type: ignore[arg-type]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># Fallback lightweight parser (supports Ns/Nm/Nh/Nd)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">import</span><span class="w"> </span><span class="nn">re</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_re</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">max_days_env</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SILENCE_MAX_DAYS&quot;</span><span class="p">,</span> <span class="s2">&quot;7&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">7</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">max_days_env</span> <span class="o">=</span> <span class="mi">7</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">_re</span><span class="o">.</span><span class="n">fullmatch</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s*(\d+)\s*([smhd])\s*&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">duration_str</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
                        <span class="n">dur_sec</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                        <span class="n">unit</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;s&quot;</span><span class="p">:</span>
                            <span class="n">seconds</span> <span class="o">=</span> <span class="n">n</span>
                        <span class="k">elif</span> <span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;m&quot;</span><span class="p">:</span>
                            <span class="n">seconds</span> <span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="mi">60</span>
                        <span class="k">elif</span> <span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;h&quot;</span><span class="p">:</span>
                            <span class="n">seconds</span> <span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="mi">3600</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">seconds</span> <span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="mi">86400</span>
                        <span class="n">max_seconds</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_days_env</span><span class="p">))</span> <span class="o">*</span> <span class="mi">86400</span>
                        <span class="k">if</span> <span class="n">seconds</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">dur_sec</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">dur_sec</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">seconds</span><span class="p">,</span> <span class="n">max_seconds</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">dur_sec</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dur_sec</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âŒ ××©×š ×–××Ÿ ×œ× ×ª×§×™×Ÿ. ×”×©×ª××© ×‘-5m/1h/2d ×•×›×“&#39;.&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Prevent dangerous patterns unless force</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
                <span class="n">dangerous</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;.*&quot;</span><span class="p">,</span> <span class="s2">&quot;^.*$&quot;</span><span class="p">,</span> <span class="s2">&quot;(?s).*&quot;</span><span class="p">,</span> <span class="s2">&quot;.+&quot;</span><span class="p">,</span> <span class="s2">&quot;^.+$&quot;</span><span class="p">}</span>
                <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">in</span> <span class="n">dangerous</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;â›” ×ª×‘× ×™×ª ××¡×•×›× ×ª. ×”×•×¡×£ --force ×× ××ª×” ×‘×˜×•×—.&quot;</span><span class="p">)</span>
                    <span class="k">return</span>

            <span class="c1"># Dynamically resolve monitoring.silences to respect test monkeypatching</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_sys</span><span class="o">,</span><span class="w"> </span><span class="nn">importlib</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_il</span>  <span class="c1"># type: ignore</span>
            <span class="n">sil</span> <span class="o">=</span> <span class="n">_sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;monitoring.silences&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_il</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s1">&#39;monitoring.silences&#39;</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="n">sil</span><span class="o">.</span><span class="n">create_silence</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="n">pattern</span><span class="p">,</span> <span class="n">duration_seconds</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">dur_sec</span><span class="p">),</span> <span class="n">created_by</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="n">reason</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="n">severity</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">force</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">doc</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×™×¦×™×¨×ª ×”×©×ª×§×” × ×›×©×œ×” (×‘×“×•×§ ××’×‘×œ×•×ª/×ª×‘× ×™×ª/DB)&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">sid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_id&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">until</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;until_ts&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âœ… ×”×•×©×ª×§: id=</span><span class="si">{</span><span class="n">sid</span><span class="si">}</span><span class="se">\n</span><span class="s2">×¤×’ ×‘- </span><span class="si">{</span><span class="n">until</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘-/silence: </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdvancedBotHandlers.unsilence_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.unsilence_command">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">unsilence_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;/unsilence &lt;id|pattern&gt; â€“ disable active silence(s).&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;args&quot;</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;â„¹ï¸ ×©×™××•×©: /unsilence &lt;id|pattern&gt;&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">target</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_sys</span><span class="o">,</span><span class="w"> </span><span class="nn">importlib</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_il</span>  <span class="c1"># type: ignore</span>
            <span class="n">sil</span> <span class="o">=</span> <span class="n">_sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;monitoring.silences&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_il</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s1">&#39;monitoring.silences&#39;</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
            <span class="c1"># Heuristic: id is 32-hex (uuid hex); else treat as pattern</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">re</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_re</span>
            <span class="k">if</span> <span class="n">_re</span><span class="o">.</span><span class="n">fullmatch</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[0-9a-fA-F]</span><span class="si">{32}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="n">sil</span><span class="o">.</span><span class="n">unsilence_by_id</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âœ… ×‘×•×˜×œ×” ×”×©×ª×§×”&quot;</span> <span class="k">if</span> <span class="n">ok</span> <span class="k">else</span> <span class="s2">&quot;â„¹ï¸ ×œ× × ××¦××”/×¢×•×“×›× ×” ×”×©×ª×§×”&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">sil</span><span class="o">.</span><span class="n">unsilence_by_pattern</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âœ… ×‘×•×˜×œ×• </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2"> ×”×©×ª×§×•×ª&quot;</span> <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;â„¹ï¸ ×œ× × ××¦××• ×”×©×ª×§×•×ª ×¤×¢×™×œ×•×ª ×œ×ª×‘× ×™×ª&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘-/unsilence: </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdvancedBotHandlers.silences_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.silences_command">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">silences_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;/silences â€“ list active silences.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_sys</span><span class="o">,</span><span class="w"> </span><span class="nn">importlib</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_il</span>  <span class="c1"># type: ignore</span>
            <span class="n">sil</span> <span class="o">=</span> <span class="n">_sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;monitoring.silences&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_il</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s1">&#39;monitoring.silences&#39;</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">sil</span><span class="o">.</span><span class="n">list_active_silences</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">items</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;â„¹ï¸ ××™×Ÿ ×”×©×ª×§×•×ª ×¤×¢×™×œ×•×ª&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ğŸ”• ×”×©×ª×§×•×ª ×¤×¢×™×œ×•×ª:&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                <span class="n">sid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_id&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">patt</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pattern&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">sev</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;severity&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;-&quot;</span>
                <span class="n">until</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;until_ts&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">reason</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reason&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;â€¢ </span><span class="si">{</span><span class="n">sid</span><span class="si">}</span><span class="s2"> | pattern=</span><span class="si">{</span><span class="n">patt</span><span class="si">}</span><span class="s2"> | severity=</span><span class="si">{</span><span class="n">sev</span><span class="si">}</span><span class="s2"> | until=</span><span class="si">{</span><span class="n">until</span><span class="si">}</span><span class="s2"> | reason=</span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘-/silences: </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdvancedBotHandlers.accuracy_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.accuracy_command">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">accuracy_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;/accuracy â€” ×“×™×•×§ ×—×™×–×•×™ × ×•×›×—×™ ×•×¡×˜×˜×™×¡×˜×™×§×ª ×× ×™×¢×”.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># ×”×¨×©××•×ª: ××“××™× ×™× ×‘×œ×‘×“</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_admin</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×¤×§×•×“×” ×–××™× ×” ×œ×× ×”×œ×™× ×‘×œ×‘×“&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="c1"># ×©×œ×™×¤×ª ×“×™×•×§ ×—×™×–×•×™ ×-gauge ×× ×§×™×™×</span>
            <span class="n">accuracy</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">prevented_total</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">prediction_accuracy_percent</span><span class="p">,</span> <span class="n">prevented_incidents_total</span>  <span class="c1"># type: ignore</span>
                <span class="k">if</span> <span class="n">prediction_accuracy_percent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Gauges in prometheus_client expose _value.get()</span>
                    <span class="n">accuracy</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">prediction_accuracy_percent</span><span class="p">,</span> <span class="s2">&quot;_value&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;get&quot;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">)())</span>
                <span class="k">if</span> <span class="n">prevented_incidents_total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Sum across all labels if possible</span>
                    <span class="c1"># prometheus_client stores counters in _metrics dict keyed by label tuples</span>
                    <span class="n">metrics_map</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">prevented_incidents_total</span><span class="p">,</span> <span class="s2">&quot;_metrics&quot;</span><span class="p">,</span> <span class="p">{})</span> <span class="ow">or</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">_labels</span><span class="p">,</span> <span class="n">sample</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">metrics_map</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="p">[])():</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">prevented_total</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="s2">&quot;_value&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;get&quot;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="mi">0</span><span class="p">)())</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">continue</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="c1"># ×’×™×‘×•×™: ×—×™×©×•×‘ ×–×¨×™×– ××ª×•×š predictive_engine (×× gauge ×œ× ×§×™×™×)</span>
            <span class="k">if</span> <span class="n">accuracy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">predictive_engine</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_recent_predictions</span>  <span class="c1"># type: ignore</span>
                    <span class="n">preds</span> <span class="o">=</span> <span class="n">get_recent_predictions</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
                    <span class="n">accuracy</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="k">if</span> <span class="n">preds</span> <span class="k">else</span> <span class="mf">0.0</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">accuracy</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ“Š Prediction Accuracy: </span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ›¡ï¸ Prevented Incidents (est.): </span><span class="si">{</span><span class="n">prevented_total</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘-/accuracy: </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdvancedBotHandlers.errors_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.errors_command">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">errors_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;/errors â€“ Top signatures (5/30/120m) + Sentry links; supports &#39;/errors examples &lt;signature&gt;&#39;&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># ×”×¨×©××•×ª: ××“××™× ×™× ×‘×œ×‘×“</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_admin</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×¤×§×•×“×” ×–××™× ×” ×œ×× ×”×œ×™× ×‘×œ×‘×“&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;args&quot;</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>
            <span class="c1"># Optional filters: service=..., endpoint=...</span>
            <span class="n">svc_filter</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">ep_filter</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tok</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="s2">&quot;=&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">k</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;service&quot;</span> <span class="ow">and</span> <span class="n">val</span><span class="p">:</span>
                        <span class="n">svc_filter</span> <span class="o">=</span> <span class="n">val</span>
                    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;endpoint&quot;</span> <span class="ow">and</span> <span class="n">val</span><span class="p">:</span>
                        <span class="n">ep_filter</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">svc_filter</span> <span class="o">=</span> <span class="n">svc_filter</span> <span class="ow">or</span> <span class="kc">None</span>
                <span class="n">ep_filter</span> <span class="o">=</span> <span class="n">ep_filter</span> <span class="ow">or</span> <span class="kc">None</span>

            <span class="c1"># Helper: build Sentry query link for a given error_signature</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">_sentry_query_link</span><span class="p">(</span><span class="n">signature</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Best-effort derive UI base from DSN</span>
                    <span class="n">dsn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SENTRY_DSN&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
                    <span class="n">host</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">dsn</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">urlparse</span>
                            <span class="n">parsed</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">dsn</span><span class="p">)</span>
                            <span class="n">raw_host</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">hostname</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="n">raw_host</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        <span class="k">if</span> <span class="n">raw_host</span> <span class="o">==</span> <span class="s1">&#39;sentry.io&#39;</span> <span class="ow">or</span> <span class="n">raw_host</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.sentry.io&#39;</span><span class="p">):</span>
                            <span class="n">host</span> <span class="o">=</span> <span class="s1">&#39;sentry.io&#39;</span>
                        <span class="k">elif</span> <span class="n">raw_host</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ingest.&#39;</span><span class="p">):</span>
                            <span class="n">host</span> <span class="o">=</span> <span class="n">raw_host</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s1">&#39;ingest.&#39;</span><span class="p">):]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">host</span> <span class="o">=</span> <span class="n">raw_host</span> <span class="ow">or</span> <span class="kc">None</span>
                    <span class="n">host</span> <span class="o">=</span> <span class="n">host</span> <span class="ow">or</span> <span class="s1">&#39;sentry.io&#39;</span>
                    <span class="n">org</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SENTRY_ORG&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SENTRY_ORG_SLUG&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">org</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">None</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">quote_plus</span>
                    <span class="n">q</span> <span class="o">=</span> <span class="n">quote_plus</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;error_signature:&quot;</span><span class="si">{</span><span class="n">signature</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;https://</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2">/organizations/</span><span class="si">{</span><span class="n">org</span><span class="si">}</span><span class="s2">/issues/?query=</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">&amp;statsPeriod=24h&quot;</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>

            <span class="c1"># Sub-command: examples for a given signature</span>
            <span class="k">if</span> <span class="n">args</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;example&quot;</span><span class="p">,</span> <span class="s2">&quot;examples&quot;</span><span class="p">}:</span>
                <span class="n">signature</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">signature</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;â„¹ï¸ ×©×™××•×©: /errors examples &lt;error_signature&gt;&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">observability</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_recent_errors</span>  <span class="c1"># type: ignore</span>
                    <span class="n">examples</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">er</span> <span class="ow">in</span> <span class="p">(</span><span class="n">get_recent_errors</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]):</span>
                        <span class="n">sig</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">er</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error_signature&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">er</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;event&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">sig</span> <span class="o">==</span> <span class="n">signature</span><span class="p">:</span>
                            <span class="n">ts</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">er</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ts&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">er</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">er</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">er</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;event&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                            <span class="n">examples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;â€¢ </span><span class="si">{</span><span class="n">ts</span><span class="si">}</span><span class="s2"> â€“ </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">examples</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
                                <span class="k">break</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">examples</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;(××™×Ÿ ×“×•×’×××•×ª ×–××™× ×•×ª ×œ×—×ª×™××” ×–×•)&quot;</span><span class="p">)</span>
                        <span class="k">return</span>
                    <span class="n">link</span> <span class="o">=</span> <span class="n">_sentry_query_link</span><span class="p">(</span><span class="n">signature</span><span class="p">)</span>
                    <span class="n">header</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ğŸ” ×“×•×’×××•×ª ×œ×©×’×™××•×ª ×¢×‘×•×¨ ×”×—×ª×™××”: </span><span class="si">{</span><span class="n">signature</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">if</span> <span class="n">link</span><span class="p">:</span>
                        <span class="n">header</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Sentry: </span><span class="si">{</span><span class="n">link</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">header</span><span class="p">]</span> <span class="o">+</span> <span class="n">examples</span><span class="p">))</span>
                    <span class="k">return</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;(×›×©×œ ×‘××™×¡×•×£ ×“×•×’×××•×ª)&quot;</span><span class="p">)</span>
                    <span class="k">return</span>

            <span class="n">lines</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">kb_rows</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># 1) Sentry-first (best-effort): recent unresolved issues</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">integrations_sentry</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_sentry</span>  <span class="c1"># type: ignore</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">_sentry</span><span class="p">,</span> <span class="s2">&quot;is_configured&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">_sentry</span><span class="o">.</span><span class="n">is_configured</span><span class="p">():</span>
                    <span class="n">issues</span> <span class="o">=</span> <span class="k">await</span> <span class="n">_sentry</span><span class="o">.</span><span class="n">get_recent_issues</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">issues</span><span class="p">:</span>
                        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Sentry â€“ issues ××—×¨×•× ×™×:&quot;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">issues</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                            <span class="n">sid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shortId&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">it</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>
                            <span class="n">title</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                            <span class="n">perma</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;permalink&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                            <span class="n">suffix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; â€“ </span><span class="si">{</span><span class="n">perma</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">perma</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. [</span><span class="si">{</span><span class="n">sid</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">title</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># ignore and continue</span>
                <span class="k">pass</span>

            <span class="c1"># 2) Local Top signatures from recent errors buffer, across windows</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">observability</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_recent_errors</span>  <span class="c1"># type: ignore</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timezone</span><span class="p">,</span> <span class="n">timedelta</span>

                <span class="k">def</span><span class="w"> </span><span class="nf">_parse_ts</span><span class="p">(</span><span class="n">ts</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span> <span class="s1">&#39;+00:00&#39;</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">None</span>

                <span class="c1"># Windows default or single-window from args like &#39;30m&#39; (search any token)</span>
                <span class="n">wins</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
                <span class="n">_win_tok</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                        <span class="n">tl</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">tl</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">tl</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                            <span class="n">_win_tok</span> <span class="o">=</span> <span class="n">tl</span>
                            <span class="k">break</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">_win_tok</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">_win_tok</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">mins</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">_win_tok</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="n">wins</span> <span class="o">=</span> <span class="p">[</span><span class="n">mins</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">wins</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">120</span><span class="p">]</span>

                <span class="n">recent</span> <span class="o">=</span> <span class="n">get_recent_errors</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

                <span class="c1"># × ×©××•×¨ ××•×¢××“×™× ×œ×›×¤×ª×•×¨×™× ××ª×•×š ×—×œ×•×Ÿ ×”×™×¢×“ (×‘×¨×™×¨×ª ××—×“×œ: 30m ××• ×”×—×œ×•×Ÿ ×”×™×—×™×“ ×©×‘×—×¨ ×”××©×ª××©)</span>
                <span class="n">target_window</span> <span class="o">=</span> <span class="n">wins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">wins</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">30</span>
                <span class="n">selected_sigs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">wins</span><span class="p">:</span>
                    <span class="n">start</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
                    <span class="n">grouped</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">er</span> <span class="ow">in</span> <span class="n">recent</span><span class="p">:</span>
                        <span class="c1"># Apply optional filters (substring match, case-insensitive)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">svc_filter</span><span class="p">:</span>
                                <span class="n">svc</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">er</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;service&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">svc_filter</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">svc</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                                    <span class="k">continue</span>
                            <span class="k">if</span> <span class="n">ep_filter</span><span class="p">:</span>
                                <span class="n">ep</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">er</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;endpoint&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">ep_filter</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ep</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                                    <span class="k">continue</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="c1"># On parsing errors, skip filtering for this record</span>
                            <span class="k">pass</span>
                        <span class="n">ts_raw</span> <span class="o">=</span> <span class="n">er</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ts&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">er</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
                        <span class="n">ts_parsed</span> <span class="o">=</span> <span class="n">_parse_ts</span><span class="p">(</span><span class="n">ts_raw</span><span class="p">)</span>
                        <span class="n">error_ts</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="n">ts_parsed</span> <span class="k">if</span> <span class="n">ts_parsed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">now</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">error_ts</span><span class="o">.</span><span class="n">tzinfo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">error_ts</span> <span class="o">=</span> <span class="n">error_ts</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">error_ts</span> <span class="o">=</span> <span class="n">error_ts</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="n">error_ts</span> <span class="o">=</span> <span class="n">now</span>
                        <span class="k">if</span> <span class="n">error_ts</span> <span class="o">&lt;</span> <span class="n">start</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">signature</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">er</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error_signature&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">er</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;event&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
                        <span class="n">bucket</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">signature</span><span class="p">,</span> <span class="p">{</span>
                            <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                            <span class="s2">&quot;sample&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">er</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error_category&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                            <span class="s2">&quot;policy&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">er</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error_policy&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                            <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">er</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error_code&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;-&quot;</span><span class="p">),</span>
                        <span class="p">})</span>
                        <span class="n">bucket</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">bucket</span><span class="p">[</span><span class="s2">&quot;sample&quot;</span><span class="p">]:</span>
                            <span class="n">bucket</span><span class="p">[</span><span class="s2">&quot;sample&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">er</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">er</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;event&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">bucket</span><span class="p">[</span><span class="s2">&quot;category&quot;</span><span class="p">]:</span>
                            <span class="n">bucket</span><span class="p">[</span><span class="s2">&quot;category&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">er</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error_category&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">bucket</span><span class="p">[</span><span class="s2">&quot;policy&quot;</span><span class="p">]:</span>
                            <span class="n">bucket</span><span class="p">[</span><span class="s2">&quot;policy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">er</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error_policy&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">bucket</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;code&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">}</span> <span class="ow">and</span> <span class="n">er</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error_code&quot;</span><span class="p">):</span>
                            <span class="n">bucket</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">er</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error_code&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>

                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;â±ï¸ Top </span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s2">m:&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">grouped</span><span class="p">:</span>
                        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;(××™×Ÿ × ×ª×•× ×™× ×‘×—×œ×•×Ÿ ×–×”)&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="n">sorted_groups</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">grouped</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;count&quot;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sorted_groups</span><span class="p">[:</span><span class="mi">10</span><span class="p">],</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="n">category</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;-&quot;</span>
                        <span class="n">label_parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">category</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">sig</span> <span class="ow">and</span> <span class="n">sig</span> <span class="o">!=</span> <span class="s2">&quot;unknown&quot;</span><span class="p">:</span>
                            <span class="n">label_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
                        <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">label_parts</span><span class="p">)</span>
                        <span class="n">count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="n">sample</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sample&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>
                        <span class="n">code</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;code&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. [</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2">Ã— </span><span class="si">{</span><span class="n">sample</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">policy</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;policy&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">policy</span> <span class="ow">and</span> <span class="n">policy</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;escalate&quot;</span><span class="p">,</span> <span class="s2">&quot;default&quot;</span><span class="p">}:</span>
                            <span class="n">line</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; â€” policy=</span><span class="si">{</span><span class="n">policy</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="k">if</span> <span class="n">code</span> <span class="ow">and</span> <span class="n">code</span> <span class="o">!=</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
                            <span class="n">line</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; (code=</span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s2">)&quot;</span>
                        <span class="n">link</span> <span class="o">=</span> <span class="n">_sentry_query_link</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span> <span class="k">if</span> <span class="n">sig</span> <span class="ow">and</span> <span class="n">sig</span> <span class="o">!=</span> <span class="s2">&quot;unknown&quot;</span> <span class="k">else</span> <span class="kc">None</span>
                        <span class="k">if</span> <span class="n">link</span><span class="p">:</span>
                            <span class="n">line</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; â€” Sentry: </span><span class="si">{</span><span class="n">link</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">line</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; â€” ×“×•×’×××•×ª: /errors examples </span><span class="si">{</span><span class="n">sig</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

                    <span class="c1"># ×‘×—×™×¨×ª ××•×¢××“×™× ×œ×›×¤×ª×•×¨×™×</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">w</span> <span class="o">==</span> <span class="n">target_window</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">selected_sigs</span> <span class="ow">and</span> <span class="n">w</span> <span class="o">==</span> <span class="n">wins</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="n">selected_sigs</span> <span class="o">=</span> <span class="p">[</span><span class="n">sig</span> <span class="k">for</span> <span class="n">sig</span><span class="p">,</span> <span class="n">_info</span> <span class="ow">in</span> <span class="n">sorted_groups</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span> <span class="k">if</span> <span class="n">sig</span> <span class="ow">and</span> <span class="n">sig</span> <span class="o">!=</span> <span class="s2">&quot;unknown&quot;</span><span class="p">]</span>

                <span class="c1"># ×‘× ×™×™×ª ××§×œ×“×ª ××™× ×œ×™×™×Ÿ: ×œ×›×œ ×—×ª×™××” ×›×¤×ª×•×¨ ×“×•×’×××•×ª + ×›×¤×ª×•×¨ Sentry (URL)</span>
                <span class="k">if</span> <span class="n">selected_sigs</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">tokens_map</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;errors_sig_tokens&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
                        <span class="k">for</span> <span class="n">sig</span> <span class="ow">in</span> <span class="n">selected_sigs</span><span class="p">:</span>
                            <span class="n">tok</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="n">sig</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">16</span><span class="p">]</span>
                            <span class="n">tokens_map</span><span class="p">[</span><span class="n">tok</span><span class="p">]</span> <span class="o">=</span> <span class="n">sig</span>
                            <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ğŸ“„ ×“×•×’×××•×ª â€“ </span><span class="si">{</span><span class="n">sig</span><span class="p">[:</span><span class="mi">18</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;err_ex:</span><span class="si">{</span><span class="n">tok</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)]</span>
                            <span class="n">link</span> <span class="o">=</span> <span class="n">_sentry_query_link</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">link</span><span class="p">:</span>
                                <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ” Sentry&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">link</span><span class="p">))</span>
                            <span class="n">kb_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;errors_sig_tokens&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tokens_map</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">kb_rows</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">lines</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;(××™×Ÿ × ×ª×•× ×™ ×©×’×™××•×ª ×–××™× ×™× ×‘×¡×‘×™×‘×” ×–×•)&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;ğŸ§° ×©×’×™××•×ª ××—×¨×•× ×•×ª:&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">lines</span><span class="p">),</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="p">(</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb_rows</span><span class="p">)</span> <span class="k">if</span> <span class="n">kb_rows</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘-/errors: </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdvancedBotHandlers.triage_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.triage_command">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">triage_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;/triage &lt;request_id|query&gt; â€“ ×“×•×— ×—×§×™×¨×” ×§×¦×¨ + ×§×™×©×•×¨ ×œ-HTML&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># ×”×¨×©××•×ª: ××“××™× ×™× ×‘×œ×‘×“</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_admin</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×¤×§×•×“×” ×–××™× ×” ×œ×× ×”×œ×™× ×‘×œ×‘×“&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="n">args</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[]</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">query</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;â„¹ï¸ ×©×™××•×©: /triage &lt;request_id ××• ×©××™×œ×ª×&gt;&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="c1"># ××™×¡×•×£ × ×ª×•× ×™× ×“×¨×š ×©×™×¨×•×ª ×”-investigation (Sentry-first, best-effort)</span>
            <span class="n">result</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">services</span><span class="w"> </span><span class="kn">import</span> <span class="n">investigation_service</span> <span class="k">as</span> <span class="n">inv</span>  <span class="c1"># type: ignore</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">inv</span><span class="o">.</span><span class="n">triage</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="s2">&quot;timeline&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;summary_text&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}</span>

            <span class="n">summary_lines</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ğŸ” Triage&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Query: </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
            <span class="n">text_summary</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary_text&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">text_summary</span><span class="p">:</span>
                <span class="n">summary_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text_summary</span><span class="p">)</span>

            <span class="c1"># ×©×™×ª×•×£ ×“×•×— HTML ××œ× ×›-share ×¤× ×™××™</span>
            <span class="n">share_url</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">integrations</span><span class="w"> </span><span class="kn">import</span> <span class="n">code_sharing</span>  <span class="c1"># type: ignore</span>
                <span class="n">html_doc</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary_html&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">share</span> <span class="o">=</span> <span class="k">await</span> <span class="n">code_sharing</span><span class="o">.</span><span class="n">share_code</span><span class="p">(</span>
                    <span class="s2">&quot;internal&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;triage-</span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">.html&quot;</span><span class="p">,</span> <span class="n">html_doc</span><span class="p">,</span> <span class="s2">&quot;html&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Triage report&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">share</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">share_url</span> <span class="o">=</span> <span class="n">share</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">share_url</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">share_url</span><span class="p">:</span>
                <span class="c1"># ×—×œ×§ ××œ×§×•×—×•×ª ××¨×—×¤×™× ×¢×œ &#39;_&#39; ×‘×”×•×“×¢×•×ª ×˜×§×¡×˜ ×¨×’×™×œ×•×ª. ×©×™××•×© ×‘â€‘Markdown ×¢× ×§×™×©×•×¨ ××¢×•×’×Ÿ ××•× ×¢ ×¢×™×•×•×ª ××–×”×” ×”×©×™×ª×•×£.</span>
                <span class="n">summary_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;×“×•×— ××œ×: [×œ×—×™×¦×” ×›××Ÿ](</span><span class="si">{</span><span class="n">share_url</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># ×’× ×‘×¡×‘×™×‘×ª ×˜×¡×˜×™× ×œ×œ× ××™× ×˜×’×¨×¦×™×™×ª ×©×™×ª×•×£ ×—×™×™×‘ ×œ×”×™×•×ª ××–×›×•×¨ ×‘×¨×•×¨ ×œ×“×•×— ×”××œ×.</span>
                <span class="n">summary_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;×“×•×— ××œ×: ×œ× × ×•×¦×¨ ×§×™×©×•×¨ ××•×˜×•××˜×™ (×¡×‘×™×‘×ª ×‘×“×™×§×•×ª)&quot;</span><span class="p">)</span>

            <span class="c1"># ×§×™×©×•×¨×™ Sentry (2 ×¨××©×•× ×™×) + Grafana (2 ×¨××©×•× ×™×)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">slinks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sentry_links&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[])</span>
                <span class="k">if</span> <span class="n">slinks</span><span class="p">:</span>
                    <span class="n">sl</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">l</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">](</span><span class="si">{</span><span class="n">l</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">slinks</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">summary_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sentry: </span><span class="si">{</span><span class="n">sl</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">glinks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;grafana_links&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[])</span>
                <span class="k">if</span> <span class="n">glinks</span><span class="p">:</span>
                    <span class="n">gl</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">l</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">](</span><span class="si">{</span><span class="n">l</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">glinks</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">summary_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Grafana: </span><span class="si">{</span><span class="n">gl</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">summary_lines</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘-/triage: </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdvancedBotHandlers.system_info_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.system_info_command">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">system_info_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;/system_info â€“ ×ª×§×¦×™×¨ ××¦×‘ ×”××¢×¨×›×ª (CPU/Mem/Uptime/Env) â€“ ××“××™× ×™× ×‘×œ×‘×“&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># ×”×¨×©××•×ª: ××“××™× ×™× ×‘×œ×‘×“</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_admin</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×¤×§×•×“×” ×–××™× ×” ×œ×× ×”×œ×™× ×‘×œ×‘×“&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span><span class="o">,</span><span class="w"> </span><span class="nn">platform</span>
            <span class="c1"># Uptime â€“ ×”×©×ª××© ×‘×¤×•× ×§×¦×™×” ×™×™×¢×•×“×™×ª ×-metrics</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_process_uptime_seconds</span>  <span class="c1"># type: ignore</span>
                <span class="n">uptime_sec</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">get_process_uptime_seconds</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">uptime_sec</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">_format_duration</span><span class="p">(</span><span class="n">seconds</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">seconds</span><span class="p">))</span>
                    <span class="n">d</span><span class="p">,</span> <span class="n">rem</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">86400</span><span class="p">)</span>
                    <span class="n">h</span><span class="p">,</span> <span class="n">rem</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">rem</span><span class="p">,</span> <span class="mi">3600</span><span class="p">)</span>
                    <span class="n">m</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">rem</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
                    <span class="n">parts</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="n">d</span><span class="p">:</span>
                        <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">d&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">h</span> <span class="ow">or</span> <span class="n">d</span><span class="p">:</span>
                        <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s2">h&quot;</span><span class="p">)</span>
                    <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2">m&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">seconds</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">s&quot;</span>

            <span class="c1"># CPU/load</span>
            <span class="n">cpu_count</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="ow">or</span> <span class="mi">1</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">la1</span><span class="p">,</span> <span class="n">la5</span><span class="p">,</span> <span class="n">la15</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getloadavg</span><span class="p">()</span>
                <span class="n">load_part</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;load </span><span class="si">{</span><span class="n">la1</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">la5</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">la15</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> (CPUs=</span><span class="si">{</span><span class="n">cpu_count</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">load_part</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;CPUs=</span><span class="si">{</span><span class="n">cpu_count</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="c1"># Memory RSS (best-effort)</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">_fmt_bytes</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">units</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;B&#39;</span><span class="p">,</span><span class="s1">&#39;KB&#39;</span><span class="p">,</span><span class="s1">&#39;MB&#39;</span><span class="p">,</span><span class="s1">&#39;GB&#39;</span><span class="p">,</span><span class="s1">&#39;TB&#39;</span><span class="p">]</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">while</span> <span class="n">val</span> <span class="o">&gt;=</span> <span class="mi">1024</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">units</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">val</span> <span class="o">/=</span> <span class="mf">1024.0</span>
                        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">val</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">units</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

            <span class="n">mem_part</span> <span class="o">=</span> <span class="s2">&quot;unknown&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">import</span><span class="w"> </span><span class="nn">psutil</span>  <span class="c1"># type: ignore</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">psutil</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>
                <span class="k">if</span> <span class="n">psutil</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
                    <span class="n">mem_part</span> <span class="o">=</span> <span class="n">_fmt_bytes</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">memory_info</span><span class="p">(),</span> <span class="s1">&#39;rss&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="kn">import</span><span class="w"> </span><span class="nn">resource</span>  <span class="c1"># type: ignore</span>
                    <span class="n">rss_kb</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">),</span> <span class="s1">&#39;ru_maxrss&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                    <span class="n">mem_part</span> <span class="o">=</span> <span class="n">_fmt_bytes</span><span class="p">(</span><span class="n">rss_kb</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">mem_part</span> <span class="o">=</span> <span class="s2">&quot;unknown&quot;</span>

            <span class="c1"># ×¡×˜×˜×•×¡ Sentry (×œ×œ× ×—×©×™×¤×ª ×¡×•×“×•×ª)</span>
            <span class="n">sentry_dsn_set</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SENTRY_DSN&quot;</span><span class="p">))</span>
            <span class="n">sentry_api_ready</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SENTRY_AUTH_TOKEN&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SENTRY_ORG&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SENTRY_ORG_SLUG&quot;</span><span class="p">)))</span>

            <span class="n">env_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;ENVIRONMENT&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;ENV&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;production&quot;</span>
            <span class="n">app_ver</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;APP_VERSION&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;APP_VERSION&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>

            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;ğŸ–¥ï¸ System Info&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;â€¢ Python: </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">())</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">platform</span><span class="o">.</span><span class="n">release</span><span class="p">())</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;â€¢ Uptime: </span><span class="si">{</span><span class="n">_format_duration</span><span class="p">(</span><span class="n">uptime_sec</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;â€¢ CPU: </span><span class="si">{</span><span class="n">load_part</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;â€¢ Memory RSS: </span><span class="si">{</span><span class="n">mem_part</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;â€¢ Env: </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">env_name</span><span class="p">)</span><span class="si">}</span><span class="s2"> | Version: </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">app_ver</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;â€¢ Sentry DSN: </span><span class="si">{</span><span class="s1">&#39;configured&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">sentry_dsn_set</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;not set&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;â€¢ Sentry API (token+org): </span><span class="si">{</span><span class="s1">&#39;configured&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">sentry_api_ready</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;not set&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘-/system_info: </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdvancedBotHandlers.metrics_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.metrics_command">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">metrics_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;/metrics â€“ ×¡×™×›×•× ×§×¦×¨ + ×§×•×‘×¥ metrics ××œ× (Prometheus) â€“ ××“××™× ×™× ×‘×œ×‘×“&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_admin</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×¤×§×•×“×” ×–××™× ×” ×œ×× ×”×œ×™× ×‘×œ×‘×“&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="kn">from</span><span class="w"> </span><span class="nn">metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">metrics_endpoint_bytes</span><span class="p">,</span> <span class="n">get_uptime_percentage</span>  <span class="c1"># type: ignore</span>
            <span class="n">payload</span><span class="p">:</span> <span class="nb">bytes</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">payload</span> <span class="o">=</span> <span class="n">metrics_endpoint_bytes</span><span class="p">()</span> <span class="ow">or</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">uptime_pct</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">get_uptime_percentage</span><span class="p">())</span>
                <span class="n">summary</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ğŸ“ˆ Metrics: uptimeâ‰ˆ</span><span class="si">{</span><span class="n">uptime_pct</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">summary</span> <span class="o">=</span> <span class="s2">&quot;ğŸ“ˆ Metrics: uptimeâ‰ˆN/A&quot;</span>
            <span class="k">if</span> <span class="n">payload</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;metrics_</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.txt&quot;</span>
                    <span class="n">bio</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
                    <span class="n">bio</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_document</span><span class="p">(</span><span class="n">InputFile</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">fname</span><span class="p">),</span> <span class="n">caption</span><span class="o">=</span><span class="n">summary</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">text_preview</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)[:</span><span class="mi">3500</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">text_preview</span> <span class="o">=</span> <span class="s2">&quot;(metrics unavailable)&quot;</span>
                    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">summary</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">text_preview</span><span class="p">)</span>
                    <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">summary</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">(metrics unavailable)&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘-/metrics: </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdvancedBotHandlers.rate_limit_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.rate_limit_command">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">rate_limit_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;/rate_limit â€“ ××¦×‘ ××’×‘×œ×ª GitHub ×¢× ×”×ª×¨××” ×× ×©×™××•×© &gt;80%&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># ×”×¨×©××•×ª: ××“××™× ×™× ×‘×œ×‘×“</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_admin</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×¤×§×•×“×” ×–××™× ×” ×œ×× ×”×œ×™× ×‘×œ×‘×“&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;GITHUB_TOKEN&quot;</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;â„¹ï¸ ××™×Ÿ GITHUB_TOKEN â€“ ××™×“×¢ ×œ× ×–××™×Ÿ&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">http_async</span><span class="w"> </span><span class="kn">import</span> <span class="n">request</span> <span class="k">as</span> <span class="n">async_request</span>
            <span class="k">async</span> <span class="k">with</span> <span class="n">async_request</span><span class="p">(</span>
                <span class="s2">&quot;GET&quot;</span><span class="p">,</span>
                <span class="s2">&quot;https://api.github.com/rate_limit&quot;</span><span class="p">,</span>
                <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;token </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;GITHUB_TOKEN&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">},</span>
                <span class="n">service</span><span class="o">=</span><span class="s2">&quot;github&quot;</span><span class="p">,</span>
                <span class="n">endpoint</span><span class="o">=</span><span class="s2">&quot;rate_limit&quot;</span><span class="p">,</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="n">core</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resources&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;core&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">remaining</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;remaining&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;limit&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">used_pct</span> <span class="o">=</span> <span class="p">(</span><span class="mi">100</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">remaining</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span> <span class="k">if</span> <span class="n">limit</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">bar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_progress_bar</span><span class="p">(</span><span class="n">used_pct</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ“ˆ GitHub Rate Limit</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Remaining: </span><span class="si">{</span><span class="n">remaining</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">limit</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Usage: </span><span class="si">{</span><span class="n">bar</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="c1"># ××–×”×¨×” ×’× ×›××©×¨ ×”× ×ª×•× ×™× ×œ× ×–××™× ×™× (limit==0), ×•×’× ××¢×œ 80%</span>
            <span class="k">if</span> <span class="n">used_pct</span> <span class="o">&gt;=</span> <span class="mi">80</span> <span class="ow">or</span> <span class="n">limit</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">âš ï¸ ××ª×§×¨×‘×™× ×œ××’×‘×œ×”! ×©×§×•×œ ×œ×¦××¦× ×§×¨×™××•×ª ××• ×œ×”×¤×¢×™×œ backoff&quot;</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘-/rate_limit: </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdvancedBotHandlers.enable_backoff_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.enable_backoff_command">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">enable_backoff_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;/enable_backoff â€“ ×”×¤×¢×œ×ª Backoff ×’×œ×•×‘×œ×™ (×× ×”×œ×™× ×‘×œ×‘×“)&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_admin</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×¤×§×•×“×” ×–××™× ×” ×œ×× ×”×œ×™× ×‘×œ×‘×“&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">ttl_min</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ttl_min</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">ttl_min</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="s2">&quot;manual&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">services</span><span class="w"> </span><span class="kn">import</span> <span class="n">github_backoff_state</span> <span class="k">as</span> <span class="n">_state</span>
                <span class="k">if</span> <span class="n">_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;â„¹ï¸ Backoff ×œ× ×–××™×Ÿ ×‘×¡×‘×™×‘×” ×–×•&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="n">info</span> <span class="o">=</span> <span class="n">_state</span><span class="o">.</span><span class="n">enable</span><span class="p">(</span><span class="n">reason</span><span class="o">=</span><span class="n">reason</span><span class="p">,</span> <span class="n">ttl_minutes</span><span class="o">=</span><span class="n">ttl_min</span><span class="p">)</span>
                <span class="n">ttl_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;, ×™×¤×•×’ ×‘×¢×•×“ </span><span class="si">{</span><span class="n">ttl_min</span><span class="si">}</span><span class="s2"> ×“×§&#39;&quot;</span> <span class="k">if</span> <span class="n">ttl_min</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ğŸŸ¡ ×”×•×¤×¢×œ Backoff GitHub (×¡×™×‘×”: </span><span class="si">{</span><span class="n">info</span><span class="o">.</span><span class="n">reason</span><span class="si">}{</span><span class="n">ttl_text</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×”×¤×¢×œ×ª Backoff: </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘-/enable_backoff: </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdvancedBotHandlers.disable_backoff_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.disable_backoff_command">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">disable_backoff_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;/disable_backoff â€“ ×›×™×‘×•×™ Backoff ×’×œ×•×‘×œ×™ (×× ×”×œ×™× ×‘×œ×‘×“)&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_admin</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×¤×§×•×“×” ×–××™× ×” ×œ×× ×”×œ×™× ×‘×œ×‘×“&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">services</span><span class="w"> </span><span class="kn">import</span> <span class="n">github_backoff_state</span> <span class="k">as</span> <span class="n">_state</span>
                <span class="k">if</span> <span class="n">_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;â„¹ï¸ Backoff ×œ× ×–××™×Ÿ ×‘×¡×‘×™×‘×” ×–×•&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="n">info</span> <span class="o">=</span> <span class="n">_state</span><span class="o">.</span><span class="n">disable</span><span class="p">(</span><span class="n">reason</span><span class="o">=</span><span class="s2">&quot;manual&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;ğŸŸ¢ Backoff ×›×•×‘×”&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×›×™×‘×•×™ Backoff: </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘-/disable_backoff: </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_progress_bar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">percentage</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">filled</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">percentage</span><span class="p">)))</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
            <span class="n">bar</span> <span class="o">=</span> <span class="s2">&quot;â–ˆ&quot;</span> <span class="o">*</span> <span class="n">filled</span> <span class="o">+</span> <span class="s2">&quot;â–‘&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="n">filled</span><span class="p">)</span>
            <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;ğŸŸ¢&quot;</span> <span class="k">if</span> <span class="n">percentage</span> <span class="o">&lt;</span> <span class="mi">60</span> <span class="k">else</span> <span class="s2">&quot;ğŸŸ¡&quot;</span> <span class="k">if</span> <span class="n">percentage</span> <span class="o">&lt;</span> <span class="mi">80</span> <span class="k">else</span> <span class="s2">&quot;ğŸ”´&quot;</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">color</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">bar</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">percentage</span><span class="si">}</span><span class="s2">%&quot;</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">percentage</span><span class="si">}</span><span class="s2">%&quot;</span>
    
<div class="viewcode-block" id="AdvancedBotHandlers.validate_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.validate_command">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">validate_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×‘×“×™×§×ª ×ª×—×‘×™×¨ ×©×œ ×§×•×“&quot;&quot;&quot;</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;âœ… ×× × ×¦×™×™×Ÿ ×©× ×§×•×‘×¥ ×œ×‘×“×™×§×”:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;×“×•×’××”: `/validate script.py`&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">file_data</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_data</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;âŒ ×§×•×‘×¥ `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">` ×œ× × ××¦×.&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># ×‘×“×™×§×ª ×ª×—×‘×™×¨</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">code_processor</span><span class="w"> </span><span class="kn">import</span> <span class="n">CodeProcessor</span>
        <span class="n">validation</span> <span class="o">=</span> <span class="n">CodeProcessor</span><span class="p">()</span><span class="o">.</span><span class="n">validate_syntax</span><span class="p">(</span><span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">],</span> <span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;programming_language&#39;</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="n">validation</span><span class="p">[</span><span class="s1">&#39;is_valid&#39;</span><span class="p">]:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;âœ… **×ª×—×‘×™×¨ ×ª×§×™×Ÿ ×¢×‘×•×¨:** `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">`</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;ğŸ‰ ×”×§×•×“ ×¢×•×‘×¨ ××ª ×›×œ ×‘×“×™×§×•×ª ×”×ª×—×‘×™×¨!&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;âŒ **×©×’×™××•×ª ×ª×—×‘×™×¨ ×¢×‘×•×¨:** `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">`</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            
            <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">validation</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]:</span>
                <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;ğŸš¨ **×©×’×™××” ×‘×©×•×¨×” </span><span class="si">{</span><span class="n">error</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:**</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">error</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        
        <span class="c1"># ××–×”×¨×•×ª</span>
        <span class="k">if</span> <span class="n">validation</span><span class="p">[</span><span class="s1">&#39;warnings&#39;</span><span class="p">]:</span>
            <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;âš ï¸ **××–×”×¨×•×ª:**</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">warning</span> <span class="ow">in</span> <span class="n">validation</span><span class="p">[</span><span class="s1">&#39;warnings&#39;</span><span class="p">]:</span>
                <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;â€¢ ×©×•×¨×” </span><span class="si">{</span><span class="n">warning</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">warning</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        
        <span class="c1"># ×”×¦×¢×•×ª</span>
        <span class="k">if</span> <span class="n">validation</span><span class="p">[</span><span class="s1">&#39;suggestions&#39;</span><span class="p">]:</span>
            <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ğŸ’¡ **×”×¦×¢×•×ª ×œ×©×™×¤×•×¨:**</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">suggestion</span> <span class="ow">in</span> <span class="n">validation</span><span class="p">[</span><span class="s1">&#39;suggestions&#39;</span><span class="p">]:</span>
                <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;â€¢ </span><span class="si">{</span><span class="n">suggestion</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="AdvancedBotHandlers.share_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.share_command">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">share_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×©×™×ª×•×£ ×§×˜×¢(×™) ×§×•×“ ×‘-Gist/Pastebin/×§×™×©×•×¨ ×¤× ×™××™. ×ª×•××š ×‘×©× ×™×—×™×“ ××• ×©××•×ª ××¨×•×‘×™×.&quot;&quot;&quot;</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;ğŸŒ ×× × ×¦×™×™×Ÿ ×©× ×§×•×‘×¥ ××• ×›××” ×©××•×ª, ××•×¤×¨×“×™× ×‘×¨×•×•×—:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;×“×•×’×××•×ª:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;â€¢ `/share script.py`</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;â€¢ `/share app.py utils.py README.md`&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># ×ª××™×›×” ×‘×©××•×ª ××¨×•×‘×™× + wildcards (×›××• *.py)</span>
        <span class="n">requested_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span>
        <span class="c1"># × ×™×§×•×™ ×›×¤×™×œ×•×™×•×ª, ×©×™××•×¨ ×¡×“×¨</span>
        <span class="n">seen</span><span class="p">:</span> <span class="nb">set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">file_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">requested_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">file_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># ×©×œ×™×¤×ª ×¤×¨×˜×™ ×”×§×‘×¦×™× (×ª×•××š ×‘-wildcards)</span>
        <span class="n">found_files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">missing</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># × ×§×‘×œ ××ª ×¨×©×™××ª ×”×§×‘×¦×™× ×©×œ ×”××©×ª××© ×œ××¡× ×Ÿ wildcards ×‘×–×™×›×¨×•×Ÿ</span>
        <span class="n">all_files</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user_files</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;file_name&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="n">all_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">all_files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">)]</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_expand_pattern</span><span class="p">(</span><span class="n">pattern</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
            <span class="c1"># ×ª××™×›×” ×‘×¡×™×¡×™×ª ×‘-* ×‘×œ×‘×“ (×ª×—×™×œ×ª/×¡×•×£/×××¦×¢)</span>
            <span class="k">if</span> <span class="s1">&#39;*&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pattern</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">pattern</span><span class="p">]</span>
            <span class="c1"># ×××¤×” ×œ-regex ×¤×©×•×˜</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">re</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_re</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="s1">&#39;^&#39;</span> <span class="o">+</span> <span class="n">_re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">*&#39;</span><span class="p">,</span> <span class="s1">&#39;.*&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;$&#39;</span>
            <span class="n">rx</span> <span class="o">=</span> <span class="n">_re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">all_names</span> <span class="k">if</span> <span class="n">rx</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>

        <span class="n">expanded_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">file_names</span><span class="p">:</span>
            <span class="n">expanded</span> <span class="o">=</span> <span class="n">_expand_pattern</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">expanded_names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">expanded</span><span class="p">)</span>

        <span class="c1"># × ×™×¤×•×™ ×›×¤×™×œ×•×™×•×ª ×•×©××™×¨×ª ×¡×“×¨</span>
        <span class="n">seen2</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">final_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">expanded_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen2</span><span class="p">:</span>
                <span class="n">seen2</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                <span class="n">final_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">final_names</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">found_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">found_files</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;âŒ ×œ× × ××¦××• ×§×‘×¦×™× ×œ×©×™×ª×•×£.&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># ×§×™×“×•×“ ××–×”×” ×”×§×©×¨ ×œ×©×™×ª×•×£ ××¨×•×‘×” ×§×‘×¦×™×</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">found_files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">single</span> <span class="o">=</span> <span class="n">found_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="n">single</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">]</span>
            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ™ GitHub Gist&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;share_gist_</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ“‹ Pastebin&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;share_pastebin_</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">PUBLIC_BASE_URL</span><span class="p">:</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ“± ×§×™×©×•×¨ ×¤× ×™××™&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;share_internal_</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;âŒ ×‘×™×˜×•×œ&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;cancel_share&quot;</span><span class="p">)</span>
                <span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;âŒ ×‘×™×˜×•×œ&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;cancel_share&quot;</span><span class="p">)</span>
                <span class="p">])</span>
            <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸŒ **×©×™×ª×•×£ ×§×•×‘×¥:** `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">`</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ”¤ ×©×¤×”: </span><span class="si">{</span><span class="n">single</span><span class="p">[</span><span class="s1">&#39;programming_language&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ“ ×’×•×“×œ: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">single</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> ×ª×•×•×™×</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;×‘×—×¨ ××•×¤×Ÿ ×©×™×ª×•×£:&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># ×¨×™×©×•× ××–×”×” ×™×™×—×•×“×™ ×œ×¨×©×™××ª ×”×§×‘×¦×™× ××¦×œ ×”××©×ª××©</span>
            <span class="n">share_id</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;multi_share&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;multi_share&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># × ×©××•×¨ ××™×¤×•×™ share_id -&gt; ×¨×©×™××ª ×©××•×ª ×§×‘×¦×™×</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;multi_share&#39;</span><span class="p">][</span><span class="n">share_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">found_files</span><span class="p">]</span>

            <span class="n">files_list_preview</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;â€¢ `</span><span class="si">{</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">` (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> ×ª×•×•×™×)&quot;</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">found_files</span><span class="p">[:</span><span class="mi">10</span><span class="p">]])</span>
            <span class="n">more</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">found_files</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">10</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">(×•×¢×•×“ </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">found_files</span><span class="p">)</span><span class="o">-</span><span class="mi">10</span><span class="si">}</span><span class="s2"> ×§×‘×¦×™×...)&quot;</span>

            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ™ GitHub Gist (××¨×•×‘×”)&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;share_gist_multi:</span><span class="si">{</span><span class="n">share_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">PUBLIC_BASE_URL</span><span class="p">:</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ“± ×§×™×©×•×¨ ×¤× ×™××™ (××¨×•×‘×”)&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;share_internal_multi:</span><span class="si">{</span><span class="n">share_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;âŒ ×‘×™×˜×•×œ&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;cancel_share&quot;</span><span class="p">)</span>
                <span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;âŒ ×‘×™×˜×•×œ&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;cancel_share&quot;</span><span class="p">)</span>
                <span class="p">])</span>
            <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>

            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸŒ **×©×™×ª×•×£ ××¡×¤×¨ ×§×‘×¦×™× (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">found_files</span><span class="p">)</span><span class="si">}</span><span class="s2">):**</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">files_list_preview</span><span class="si">}{</span><span class="n">more</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;×‘×—×¨ ××•×¤×Ÿ ×©×™×ª×•×£:&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="AdvancedBotHandlers.share_help_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.share_help_command">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">share_help_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×”×¡×‘×¨ ×§×¦×¨ ×¢×œ ×¤×§×•×“×ª /share&quot;&quot;&quot;</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">PUBLIC_BASE_URL</span><span class="p">:</span>
            <span class="n">help_text</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;# ğŸ“¤ ×¤×§×•×“×ª /share â€“ ×©×™×ª×•×£ ×§×‘×¦×™× ×‘×§×œ×•×ª</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;## ××” ×–×” ×¢×•×©×”?</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;×¤×§×•×“×ª `/share` ×××¤×©×¨×ª ×œ×š ×œ×©×ª×£ ×§×‘×¦×™× ××”×‘×•×˜ ×‘××•×¤×Ÿ ××”×™×¨ ×•× ×•×—. ×”×‘×•×˜ ×™×•×¦×¨ ×¢×‘×•×¨×š ×§×™×©×•×¨×™ ×©×™×ª×•×£ ××•×˜×•××˜×™×™× ×œ×§×‘×¦×™× ×©××ª×” ×‘×•×—×¨.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;## ××™×š ×œ×”×©×ª××©?</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;### ×“×•×’×××•×ª ×¤×©×•×˜×•×ª:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- **×§×•×‘×¥ ×™×—×™×“:** `/share script.py`</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- **××¡×¤×¨ ×§×‘×¦×™×:** `/share app.py utils.py README.md`</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- **×¢× ×›×•×›×‘×™×•×ª (wildcards):** `/share *.py` ××• `/share main.*`</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;### âš ï¸ ×—×©×•×‘ ×œ×–×›×•×¨:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;×©××•×ª ×”×§×‘×¦×™× ×”× **case sensitive** - ×›×œ×•××¨, ×¦×¨×™×š ×œ×”×§×¤×™×“ ×¢×œ ××•×ª×™×•×ª ×§×˜× ×•×ª ×•×’×“×•×œ×•×ª ×‘×“×™×•×§ ×›××• ×©×”×Ÿ ××•×¤×™×¢×•×ª ×‘×©× ×”×§×•×‘×¥ ×”××§×•×¨×™.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- **×× ×™×© ×›××” ×§×‘×¦×™× ×¢× ××•×ª×• ×©× ×‘×‘×•×˜ â€“ ×™×©×•×ª×£ ×”××—×¨×•×Ÿ ×©× ×©××¨.**</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;## ××™×–×” ×¡×•×’×™ ×§×™×©×•×¨×™× ××¤×©×¨ ×œ×§×‘×œ?</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;### ğŸ™ GitHub Gist</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- **××ª××™× ×œ×›×œ ×¡×•×’ ×§×•×‘×¥ ×•××¡×¤×¨ ×§×‘×¦×™×**</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- ×§×™×©×•×¨ ×™×¦×™×‘ ×•×××™×Ÿ</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- ×›×“×™ ×œ×”×©×ª××© ×™×© ×œ×”×’×“×™×¨ `GITHUB_TOKEN`</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;### ğŸ“‹ Pastebin</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- **×¨×§ ×œ×§×•×‘×¥ ×™×—×™×“ (××¨×•×‘×” ×§×‘×¦×™× ×œ× × ×ª××š)**</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- ××”×™×¨ ×•×¤×©×•×˜ ×œ×©×™××•×©</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- ×›×“×™ ×œ×”×©×ª××© ×™×© ×œ×”×’×“×™×¨ `PASTEBIN_API_KEY`</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;### ğŸ“± ×§×™×©×•×¨ ×¤× ×™××™</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- **×–××™×Ÿ ×‘×¡×‘×™×‘×” ×–×•**</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- ×§×™×©×•×¨ ×–×× ×™ (×‘×ª×•×§×£ ×›×©×‘×•×¢ ×‘×¢×¨×š)</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- ×¢×•×‘×“ ×¢× ×›×œ ×¡×•×’ ×•×›××•×ª ×§×‘×¦×™×</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">help_text</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;# ğŸ“¤ ×¤×§×•×“×ª /share â€“ ×©×™×ª×•×£ ×§×‘×¦×™× ×‘×§×œ×•×ª</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;## ××” ×–×” ×¢×•×©×”?</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;×¤×§×•×“×ª `/share` ×××¤×©×¨×ª ×œ×š ×œ×©×ª×£ ×§×‘×¦×™× ××”×‘×•×˜ ×‘××•×¤×Ÿ ××”×™×¨ ×•× ×•×—. ×”×‘×•×˜ ×™×•×¦×¨ ×¢×‘×•×¨×š ×§×™×©×•×¨×™ ×©×™×ª×•×£ ××•×˜×•××˜×™×™× ×œ×§×‘×¦×™× ×©××ª×” ×‘×•×—×¨.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;## ××™×š ×œ×”×©×ª××©?</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;### ×“×•×’×××•×ª ×¤×©×•×˜×•×ª:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- **×§×•×‘×¥ ×™×—×™×“:** `/share script.py`</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- **××¡×¤×¨ ×§×‘×¦×™×:** `/share app.py utils.py README.md`</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- **×¢× ×›×•×›×‘×™×•×ª (wildcards):** `/share *.py` ××• `/share main.*`</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;### âš ï¸ ×—×©×•×‘ ×œ×–×›×•×¨:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;×©××•×ª ×”×§×‘×¦×™× ×”× **case sensitive** - ×›×œ×•××¨, ×¦×¨×™×š ×œ×”×§×¤×™×“ ×¢×œ ××•×ª×™×•×ª ×§×˜× ×•×ª ×•×’×“×•×œ×•×ª ×‘×“×™×•×§ ×›××• ×©×”×Ÿ ××•×¤×™×¢×•×ª ×‘×©× ×”×§×•×‘×¥ ×”××§×•×¨×™.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- **×× ×™×© ×›××” ×§×‘×¦×™× ×¢× ××•×ª×• ×©× ×‘×‘×•×˜ â€“ ×™×©×•×ª×£ ×”××—×¨×•×Ÿ ×©× ×©××¨.**</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;## ××™×–×” ×¡×•×’×™ ×§×™×©×•×¨×™× ××¤×©×¨ ×œ×§×‘×œ?</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;### ğŸ™ GitHub Gist</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- **××ª××™× ×œ×›×œ ×¡×•×’ ×§×•×‘×¥ ×•××¡×¤×¨ ×§×‘×¦×™×**</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- ×§×™×©×•×¨ ×™×¦×™×‘ ×•×××™×Ÿ</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- ×›×“×™ ×œ×”×©×ª××© ×™×© ×œ×”×’×“×™×¨ `GITHUB_TOKEN`</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;### ğŸ“‹ Pastebin</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- **×¨×§ ×œ×§×•×‘×¥ ×™×—×™×“ (××¨×•×‘×” ×§×‘×¦×™× ×œ× × ×ª××š)**</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- ××”×™×¨ ×•×¤×©×•×˜ ×œ×©×™××•×©</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- ×›×“×™ ×œ×”×©×ª××© ×™×© ×œ×”×’×“×™×¨ `PASTEBIN_API_KEY`</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;(×§×™×©×•×¨ ×¤× ×™××™ ××™× ×• ×–××™×Ÿ ×‘×¡×‘×™×‘×” ×–×•)</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">help_text</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdvancedBotHandlers.help_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.help_command">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">help_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×”×¦×’×ª ×¢×–×¨×” ××¨×•×›×–×ª ×¢× ×”×¤×§×•×“×•×ª ×”×–××™× ×•×ª ×‘×‘×•×˜.&quot;&quot;&quot;</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="c1"># ×—×œ×•×§×” ×œ×¤×™ × ×•×©××™×; ×©××•×ª ×¤×§×•×“×•×ª ×ª×•×××™× ×œ×¨×™×©×•× ×‘×¤×•×¢×œ</span>
        <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;&lt;b&gt;ğŸ“š ×¢×–×¨×” â€“ ×¤×§×•×“×•×ª ×–××™× ×•×ª&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;&lt;b&gt;×§×‘×¦×™×&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;â€¢ /show &amp;lt;×©×Ö¾×§×•×‘×¥&amp;gt; â€“ ×”×¦×’ ×§×•×‘×¥ ××•×“×’×©</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;â€¢ /edit &amp;lt;×©×Ö¾×§×•×‘×¥&amp;gt; â€“ ×¢×¨×™×›×ª ×§×•×‘×¥</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;â€¢ /delete &amp;lt;×©×Ö¾×§×•×‘×¥&amp;gt; â€“ ××—×™×§×”</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;â€¢ /download &amp;lt;×©×Ö¾×§×•×‘×¥&amp;gt; â€“ ×”×•×¨×“×”</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;&lt;b&gt;××•×¢×“×¤×™× ×•×’×¨×¡××•×ª&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;â€¢ /fav &amp;lt;×©×Ö¾×§×•×‘×¥&amp;gt; â€“ ×”×•×¡×£/×”×¡×¨ ×××•×¢×“×¤×™×</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;â€¢ /favorites â€“ ×¨×©×™××ª ××•×¢×“×¤×™×</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;â€¢ /versions &amp;lt;×©×Ö¾×§×•×‘×¥&amp;gt; â€“ ×’×¨×¡××•×ª ×§×•×‘×¥</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;&lt;b&gt;×©×™×ª×•×£&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;â€¢ /share &amp;lt;×§×‘×¦×™×...&amp;gt; â€“ ××©×£ ×©×™×ª×•×£ (Gist/Pastebin/×¤× ×™××™)</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;â€¢ /share_help â€“ ×¢×–×¨×” ××¤×•×¨×˜×ª ×¢×œ ×©×™×ª×•×£</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;&lt;b&gt;×ª××•× ×•×ª ×§×•×“&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;â€¢ /image &amp;lt;×©×Ö¾×§×•×‘×¥&amp;gt; â€“ ×™×¦×™×¨×ª ×ª××•× ×”</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;â€¢ /preview &amp;lt;×©×Ö¾×§×•×‘×¥&amp;gt; â€“ ×ª×¦×•×’×” ××§×“×™××”</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;â€¢ /image_all â€“ ×™×¦×™×¨×ª ×ª××•× ×•×ª ×œ×§×‘×¦×™× ×”××—×¨×•× ×™× (××•×’×‘×œ)</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;&lt;b&gt;×—×™×¤×•×© ×•× ×™×ª×•×—&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;â€¢ /search &amp;lt;×˜×§×¡×˜&amp;gt; â€“ ×—×™×¤×•×© ×‘×§×•×“</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;â€¢ /analyze &amp;lt;×©×Ö¾×§×•×‘×¥&amp;gt; â€“ × ×™×ª×•×—</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;â€¢ /validate &amp;lt;×©×Ö¾×§×•×‘×¥&amp;gt; â€“ ×‘×“×™×§×ª ×ª×•×§×£/×‘×“×™×§×•×ª</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;&lt;b&gt;××¨×’×•×Ÿ ×•××™×“×¢&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;â€¢ /tags â€“ ×ª×’×™×•×ª</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;â€¢ /recent â€“ ××—×¨×•× ×™×</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;â€¢ /info â€“ ××™×“×¢ ×¢×œ ×”×—×©×‘×•×Ÿ/×§×‘×¦×™×</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;â€¢ /broadcast â€“ ×©×™×“×•×¨ (××•×’×‘×œ)</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;&lt;b&gt;ChatOps/×× ×”×œ (××•×’×‘×œ ×”×¨×©××•×ª)&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;â€¢ /status, /health, /observe, /triage</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;â€¢ /system_info, /metrics, /uptime, /alerts, /incidents</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;â€¢ /predict, /accuracy, /errors, /rate_limit</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;â€¢ /enable_backoff, /disable_backoff, /silence, /unsilence, /silences</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;×˜×™×¤: ×‘×¤×œ×•××• /image ××¤×©×¨ ×œ×‘×—×•×¨ ×ª××”/×¨×•×—×‘/×¤×•× ×˜ ×•×œ×©××•×¨ ×›×‘×¨×™×¨×ªâ€‘××—×“×œ.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;×”×¢×¨×”: ×”×•×¡×£ ×ª×•×•×™×ª ×§×¦×¨×” ×œ×ª××•× ×” ×¢× &lt;code&gt;--note&lt;/code&gt; (××• × ×§×” ×¢× &lt;code&gt;--note-clear&lt;/code&gt;).&quot;</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">,</span> <span class="n">disable_web_page_preview</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># Fallback ×œ×œ× HTML</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;b&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;/b&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&amp;lt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&amp;gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">),</span>
                <span class="n">disable_web_page_preview</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span></div>

    
<div class="viewcode-block" id="AdvancedBotHandlers.download_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.download_command">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">download_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×”×•×¨×“×ª ×§×•×‘×¥&quot;&quot;&quot;</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;ğŸ“¥ ×× × ×¦×™×™×Ÿ ×©× ×§×•×‘×¥ ×œ×”×•×¨×“×”:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;×“×•×’××”: `/download script.py`&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">file_data</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_data</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;âŒ ×§×•×‘×¥ `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">` ×œ× × ××¦×.&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># ×™×¦×™×¨×ª ×§×•×‘×¥ ×œ×”×•×¨×“×”</span>
        <span class="n">file_content</span> <span class="o">=</span> <span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">file_obj</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">file_content</span><span class="p">)</span>
        <span class="n">file_obj</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">file_name</span>
        
        <span class="c1"># ×©×œ×™×—×ª ×”×§×•×‘×¥</span>
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_document</span><span class="p">(</span>
            <span class="n">document</span><span class="o">=</span><span class="n">InputFile</span><span class="p">(</span><span class="n">file_obj</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">file_name</span><span class="p">),</span>
            <span class="n">caption</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;ğŸ“¥ **×”×•×¨×“×ª ×§×•×‘×¥:** `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">`</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="sa">f</span><span class="s2">&quot;ğŸ”¤ ×©×¤×”: </span><span class="si">{</span><span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;programming_language&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="sa">f</span><span class="s2">&quot;ğŸ“… ×¢×•×“×›×Ÿ: </span><span class="si">{</span><span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;updated_at&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/%m/%Y %H:%M&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
        <span class="p">)</span></div>

    
<div class="viewcode-block" id="AdvancedBotHandlers.tags_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.tags_command">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">tags_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×”×¦×’×ª ×›×œ ×”×ª×’×™×•×ª ×©×œ ×”××©×ª××©&quot;&quot;&quot;</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        
        <span class="n">files</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user_files</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;file_name&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;ğŸ·ï¸ ×¢×“×™×™×Ÿ ××™×Ÿ ×œ×š ×§×‘×¦×™× ×¢× ×ª×’×™×•×ª.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># ××™×¡×•×£ ×›×œ ×”×ª×’×™×•×ª</span>
        <span class="n">all_tags</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">file_data</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="k">if</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">all_tags</span><span class="p">:</span>
                    <span class="n">all_tags</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">all_tags</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">all_tags</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;ğŸ·ï¸ ×¢×“×™×™×Ÿ ××™×Ÿ ×œ×š ×§×‘×¦×™× ×¢× ×ª×’×™×•×ª.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># ××™×•×Ÿ ×œ×¤×™ ×ª×“×™×¨×•×ª</span>
        <span class="n">sorted_tags</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">all_tags</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="n">response</span> <span class="o">=</span> <span class="s2">&quot;ğŸ·ï¸ **×”×ª×’×™×•×ª ×©×œ×š:**</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        
        <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">sorted_tags</span><span class="p">[:</span><span class="mi">20</span><span class="p">]:</span>  <span class="c1"># ××§×¡×™××•× 20 ×ª×’×™×•×ª</span>
            <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;â€¢ `#</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">` (</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2"> ×§×‘×¦×™×)</span><span class="se">\n</span><span class="s2">&quot;</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_tags</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ğŸ“„ ×•×¢×•×“ </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sorted_tags</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">20</span><span class="si">}</span><span class="s2"> ×ª×’×™×•×ª...&quot;</span>
        
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="AdvancedBotHandlers.recent_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.recent_command">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">recent_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×”×¦×’×ª ×”×§×‘×¦×™× ×©×¢×•×“×›× ×• ×œ××—×¨×•× ×”&quot;&quot;&quot;</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        
        <span class="c1"># ×›××” ×™××™× ××—×•×¨×” ×œ×—×¤×©</span>
        <span class="n">days_back</span> <span class="o">=</span> <span class="mi">7</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span> <span class="ow">and</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="n">days_back</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        
        <span class="c1"># ×—×™×¤×•×© ×§×‘×¦×™× ××—×¨×•× ×™×</span>
        <span class="n">since_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">days_back</span><span class="p">)</span>
        
        <span class="n">files</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user_files</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
        <span class="n">recent_files</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> 
            <span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;updated_at&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">since_date</span>
        <span class="p">]</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">recent_files</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ“… ×œ× × ××¦××• ×§×‘×¦×™× ×©×¢×•×“×›× ×• ×‘-</span><span class="si">{</span><span class="n">days_back</span><span class="si">}</span><span class="s2"> ×”×™××™× ×”××—×¨×•× ×™×.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">response</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ğŸ“… &lt;b&gt;×§×‘×¦×™× ×-</span><span class="si">{</span><span class="n">days_back</span><span class="si">}</span><span class="s2"> ×”×™××™× ×”××—×¨×•× ×™×:&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        
        <span class="k">for</span> <span class="n">file_data</span> <span class="ow">in</span> <span class="n">recent_files</span><span class="p">[:</span><span class="mi">15</span><span class="p">]:</span>  <span class="c1"># ××§×¡×™××•× 15 ×§×‘×¦×™×</span>
            <span class="n">dt_now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="k">if</span> <span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;updated_at&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tzinfo</span> <span class="k">else</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="n">days_ago</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt_now</span> <span class="o">-</span> <span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;updated_at&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">days</span>
            <span class="n">time_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;×”×™×•×&quot;</span> <span class="k">if</span> <span class="n">days_ago</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;×œ×¤× ×™ </span><span class="si">{</span><span class="n">days_ago</span><span class="si">}</span><span class="s2"> ×™××™×&quot;</span>
            <span class="n">safe_name</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)))</span>
            <span class="n">safe_lang</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;programming_language&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)))</span>
            <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;ğŸ“„ &lt;code&gt;</span><span class="si">{</span><span class="n">safe_name</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   ğŸ”¤ </span><span class="si">{</span><span class="n">safe_lang</span><span class="si">}</span><span class="s2"> | ğŸ“… </span><span class="si">{</span><span class="n">time_str</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">recent_files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;ğŸ“„ ×•×¢×•×“ </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">recent_files</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">15</span><span class="si">}</span><span class="s2"> ×§×‘×¦×™×...&quot;</span>
        
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdvancedBotHandlers.info_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.info_command">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">info_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;××™×“×¢ ××”×™×¨ ×¢×œ ×§×•×‘×¥ ×œ×œ× ×¤×ª×™×—×”&quot;&quot;&quot;</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;â„¹ï¸ ×× × ×¦×™×™×Ÿ ×©× ×§×•×‘×¥:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;×“×•×’××”: &lt;code&gt;/info script.py&lt;/code&gt;&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">file_data</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_data</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;âŒ ×§×•×‘×¥ &lt;code&gt;</span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/code&gt; ×œ× × ××¦×.&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">safe_name</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)))</span>
        <span class="n">safe_lang</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;programming_language&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)))</span>
        <span class="n">size_chars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">updated_at</span> <span class="o">=</span> <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;updated_at&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">updated_str</span> <span class="o">=</span> <span class="n">updated_at</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/%m/%Y %H:%M&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">updated_at</span> <span class="k">else</span> <span class="s1">&#39;-&#39;</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">updated_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">updated_at</span><span class="p">)</span> <span class="k">if</span> <span class="n">updated_at</span> <span class="k">else</span> <span class="s1">&#39;-&#39;</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">tags_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;#</span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">)</span> <span class="k">if</span> <span class="n">tags</span> <span class="k">else</span> <span class="s2">&quot;-&quot;</span>
        
        <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;â„¹ï¸ &lt;b&gt;××™×“×¢ ×¢×œ ×§×•×‘×¥&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;ğŸ“„ &lt;b&gt;×©×:&lt;/b&gt; &lt;code&gt;</span><span class="si">{</span><span class="n">safe_name</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;ğŸ”¤ &lt;b&gt;×©×¤×”:&lt;/b&gt; </span><span class="si">{</span><span class="n">safe_lang</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;ğŸ“ &lt;b&gt;×’×•×“×œ:&lt;/b&gt; </span><span class="si">{</span><span class="n">size_chars</span><span class="si">}</span><span class="s2"> ×ª×•×•×™×</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;ğŸ“… &lt;b&gt;×¢×•×“×›×Ÿ:&lt;/b&gt; </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">updated_str</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;ğŸ·ï¸ &lt;b&gt;×ª×’×™×•×ª:&lt;/b&gt; </span><span class="si">{</span><span class="n">tags_str</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdvancedBotHandlers.search_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.search_command">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">search_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×—×™×¤×•×© ×§×˜×¢×™ ×§×•×“ ×œ×¤×™ ×˜×§×¡×˜/×©×¤×”/×ª×’×™×•×ª â€” ××™××•×© ××™× ×™××œ×™ ×•×‘×˜×•×— ×œ×¡×•×’×™×&quot;&quot;&quot;</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="c1"># ×§×œ×˜ ×‘×˜×•×— â€” ×œ× ×× ×™×—×™× ×›×œ×•× ×¢×œ context.args</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;ğŸ” ×©×™××•×©: /search &lt;query&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;×“×•×’×××•×ª:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;â€¢ /search python â€” ×¡×™× ×•×Ÿ ×œ×¤×™ ×©×¤×”</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;â€¢ /search #utils â€” ×œ×¤×™ ×ª×’×™×ª</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;â€¢ /search api â€” ×—×™×¤×•×© ×—×•×¤×©×™ ×‘×©×/×‘×ª×•×›×Ÿ&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># ×¤×¢× ×•×— ××™× ×™××œ×™ ×©×œ ×¤×¨××˜×¨×™× ×œ×œ× ×ª×œ×•×ª ×‘××¡×“/×©×™×¨×•×ª×™×</span>
        <span class="n">query_tokens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">languages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">token</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="k">elif</span> <span class="n">t</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;python&quot;</span><span class="p">,</span><span class="s2">&quot;javascript&quot;</span><span class="p">,</span><span class="s2">&quot;typescript&quot;</span><span class="p">,</span><span class="s2">&quot;java&quot;</span><span class="p">,</span><span class="s2">&quot;html&quot;</span><span class="p">,</span><span class="s2">&quot;css&quot;</span><span class="p">,</span><span class="s2">&quot;json&quot;</span><span class="p">,</span><span class="s2">&quot;yaml&quot;</span><span class="p">,</span><span class="s2">&quot;markdown&quot;</span><span class="p">,</span><span class="s2">&quot;bash&quot;</span><span class="p">,</span><span class="s2">&quot;text&quot;</span><span class="p">}:</span>
                <span class="n">languages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">query_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="c1"># ×ª×©×•×‘×” ××™× ×™××œ×™×ª; ×”×”×™×’×™×•×Ÿ ×”××œ× ×©×œ ×—×™×¤×•×© × ××¦× ×‘-main/handlers ××—×¨×™×</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ğŸ” ×—×™×¤×•×© ×”×ª×—×œ×ª×™ (×ª×¦×•×’×ª ×”×“×’××”):</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">languages</span><span class="p">:</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;â€¢ ×©×¤×•×ª: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">languages</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tags</span><span class="p">:</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;â€¢ ×ª×’×™×•×ª: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="o">+</span><span class="n">x</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">tags</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">query_tokens</span><span class="p">:</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;â€¢ ×˜×§×¡×˜: </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">query_tokens</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;ğŸ” ×—×™×¤×•×©&quot;</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_is_admin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×‘×•×“×§ ×× ×”××©×ª××© ×”×•× ××“××™×Ÿ ×œ×¤×™ allowlist ××¤×•×¨×©; × ×•×¤×œ ×—×–×¨×” ×œ××•×“×•×œ permissions ×œ×œ× ××¦×‘ allow-all.&quot;&quot;&quot;</span>
        <span class="c1"># ×©×œ×‘ ×¨××©×•×Ÿ: allowlist ××¤×•×¨×© ××”-ENV (×‘×¢×œ ×§×“×™××•×ª)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;ADMIN_USER_IDS&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">raw</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">ids</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ids</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># ×× ××™×Ÿ allowlist ××¤×•×¨×©, ××œ ×ª×¡××•×š ×¢×œ override ×’×•×¨×£ ×©×œ CHATOPS_ALLOW_ALL_IF_NO_ADMINS</span>
        <span class="n">allow_all_override</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;CHATOPS_ALLOW_ALL_IF_NO_ADMINS&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">allow_all_override</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="s2">&quot;on&quot;</span><span class="p">}:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1">#Fallback ×–×”×™×¨ ×œ××•×“×•×œ permissions ×× ×–××™×Ÿ (×œ××©×œ ×¢×‘×•×¨ ××§×•×¨×•×ª ××—×¨×™× ×©×œ ×”×¨×©××•×ª)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">_perm_is_admin</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">_perm_is_admin</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">user_id</span><span class="p">)))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="AdvancedBotHandlers.broadcast_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.broadcast_command">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">broadcast_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×©×™×“×•×¨ ×”×•×“×¢×” ×œ×›×œ ×”××©×ª××©×™× ×¢× ×”×’×‘×œ×ª ×§×¦×‘, RetryAfter ×•×¡×™×›×•× ×ª×•×¦××•×ª.&quot;&quot;&quot;</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_admin</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×¤×§×•×“×” ×–××™× ×” ×¨×§ ×œ×× ×”×œ×™×&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># ×”×”×•×“×¢×” ×œ×©×™×“×•×¨</span>
        <span class="n">message_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">message_text</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;ğŸ“¢ ×©×™××•×©: /broadcast &lt;message&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;×©×œ×— ××ª ×”×”×•×“×¢×” ×©×ª×©×•×“×¨ ×œ×›×œ ×”××©×ª××©×™×.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># ×©×œ×™×¤×ª × ××¢× ×™× ×-Mongo</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;db&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">db</span><span class="o">.</span><span class="n">db</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;users&#39;</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ ×¨×©×™××ª ××©×ª××©×™× ××”××¡×“.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">coll</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">users</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="n">coll</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$exists&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span> <span class="s2">&quot;blocked&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$ne&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}},</span> <span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
            <span class="n">recipients</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">uid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">uid</span><span class="p">:</span>
                        <span class="n">recipients</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">continue</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;×˜×¢×™× ×ª × ××¢× ×™× × ×›×©×œ×”: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×¨×©×™××ª × ××¢× ×™×&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">recipients</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;â„¹ï¸ ××™×Ÿ × ××¢× ×™× ×œ×©×™×“×•×¨.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># ×ª×•×›×Ÿ ×‘×˜×•×— ×œ-HTML</span>
        <span class="n">safe_text</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">message_text</span><span class="p">)</span>
        
        <span class="n">success_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">fail_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">removed_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">delay_seconds</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># ~10 ×”×•×“×¢×•×ª ×‘×©× ×™×™×”</span>

        <span class="k">for</span> <span class="n">rid</span> <span class="ow">in</span> <span class="n">recipients</span><span class="p">:</span>
            <span class="n">sent_ok</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">attempts</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">attempts</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">sent_ok</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">context</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">chat_id</span><span class="o">=</span><span class="n">rid</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">safe_text</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">)</span>
                    <span class="n">success_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">sent_ok</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">except</span> <span class="n">telegram</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">RetryAfter</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">attempts</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s1">&#39;retry_after&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
                    <span class="c1"># × × ×¡×” ×©×•×‘ ×‘×œ×•×œ××”</span>
                <span class="k">except</span> <span class="n">telegram</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">Forbidden</span><span class="p">:</span>
                    <span class="n">fail_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">removed_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rid</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">except</span> <span class="n">telegram</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">BadRequest</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">fail_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="s1">&#39;chat not found&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;not found&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                        <span class="n">removed_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rid</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;×©×™×“×•×¨ ×œ× ××¢×Ÿ </span><span class="si">{</span><span class="n">rid</span><span class="si">}</span><span class="s2"> × ×›×©×œ: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">fail_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">sent_ok</span> <span class="ow">and</span> <span class="n">attempts</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">fail_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay_seconds</span><span class="p">)</span>
        
        <span class="n">removed_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">removed_ids</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">coll</span><span class="o">.</span><span class="n">update_many</span><span class="p">({</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="p">:</span> <span class="n">removed_ids</span><span class="p">}},</span> <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;blocked&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}})</span>
                <span class="n">removed_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">removed_ids</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        
        <span class="n">summary</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;ğŸ“¢ ×¡×™×›×•× ×©×™×“×•×¨</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;ğŸ‘¥ × ××¢× ×™×: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">recipients</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;âœ… ×”×¦×œ×—×•×ª: </span><span class="si">{</span><span class="n">success_count</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;âŒ ×›×©×œ×™×: </span><span class="si">{</span><span class="n">fail_count</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;ğŸ§¹ ×¡×•×× ×• ×›×—×¡×•××™×/×œ× ×–××™× ×™×: </span><span class="si">{</span><span class="n">removed_count</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdvancedBotHandlers.dm_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.dm_command">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">dm_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×©×œ×™×—×ª ×”×•×“×¢×” ×¤×¨×˜×™×ª ×œ××©×ª××© ×™×—×™×“ (×œ×× ×”×œ×™× ×‘×œ×‘×“).</span>

<span class="sd">        ×©×™××•×©:</span>
<span class="sd">        /dm &lt;user_id|@username&gt; &lt;message...&gt;</span>

<span class="sd">        ×”×”×•×“×¢×” × ×©×œ×—×ª ×‘-HTML ×¢× ×¢×˜×™×¤×ª &lt;pre&gt; ×›×“×™ ×œ×©××¨ ×¨×•×•×—×™× ×•×©×•×¨×•×ª.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">caller_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_admin</span><span class="p">(</span><span class="n">caller_id</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×¤×§×•×“×” ×–××™× ×” ×¨×§ ×œ×× ×”×œ×™×&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">raw</span> <span class="o">=</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="c1"># ×ª××™×›×” ×‘-/dm@BotUserName</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^/dm(?:@\S+)?\s+(\S+)\s+([\s\S]+)$&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;ğŸ“¬ ×©×™××•×©: /dm &lt;user_id|@username&gt; &lt;message&gt;</span><span class="se">\n</span><span class="s2">×“×•×’××”: /dm 123456 ×”×™×™! ×§×™×‘×œ×ª ×¤×¨×™××™×•× ğŸ’&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="n">recipient_token</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">message_text</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Resolve recipient</span>
        <span class="n">target_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">recipient_token</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">target_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">recipient_token</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">target_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># username: strip leading @ and query DB</span>
            <span class="n">uname</span> <span class="o">=</span> <span class="n">recipient_token</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="n">recipient_token</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">recipient_token</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;db&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">db</span><span class="o">.</span><span class="n">db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;users&#39;</span><span class="p">):</span>
                    <span class="c1"># × ×¡×” ×”×ª×××” ××“×•×™×§×ª ×•××– lowercase</span>
                    <span class="n">doc</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">uname</span><span class="p">})</span> <span class="ow">or</span> <span class="n">db</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">uname</span><span class="o">.</span><span class="n">lower</span><span class="p">()})</span>
                    <span class="k">if</span> <span class="n">doc</span> <span class="ow">and</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">):</span>
                        <span class="n">target_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">target_id</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">target_id</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âŒ × ××¢× /×ª ×œ× × ××¦×/×”. ×¡×¤×§/×™ user_id ×ª×§×™×Ÿ ××• @username ×§×™×™×.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># HTML-safe with preserved whitespace/newlines</span>
        <span class="n">safe</span> <span class="o">=</span> <span class="s2">&quot;&lt;pre&gt;&quot;</span> <span class="o">+</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">message_text</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&lt;/pre&gt;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">context</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span>
                <span class="n">chat_id</span><span class="o">=</span><span class="n">target_id</span><span class="p">,</span>
                <span class="n">text</span><span class="o">=</span><span class="n">safe</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">,</span>
                <span class="n">disable_web_page_preview</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âœ… ×”×”×•×“×¢×” × ×©×œ×—×” ×œ-</span><span class="si">{</span><span class="n">target_id</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">message_text</span><span class="p">)</span><span class="si">}</span><span class="s2"> ×ª×•×•×™×)&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">telegram</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">RetryAfter</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># ×”××ª×Ÿ ×•× ×¡×” ×©×•×‘ ×¤×¢× ××—×ª</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s1">&#39;retry_after&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">context</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span>
                    <span class="n">chat_id</span><span class="o">=</span><span class="n">target_id</span><span class="p">,</span>
                    <span class="n">text</span><span class="o">=</span><span class="n">safe</span><span class="p">,</span>
                    <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">,</span>
                    <span class="n">disable_web_page_preview</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âœ… ×”×”×•×“×¢×” × ×©×œ×—×” ×œ-</span><span class="si">{</span><span class="n">target_id</span><span class="si">}</span><span class="s2"> ×œ××—×¨ ×”××ª× ×” (Rate Limit)&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e2</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×œ×™×—×” × ×›×©×œ×” ×œ××—×¨ ×”××ª× ×”: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">e2</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">telegram</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">Forbidden</span><span class="p">:</span>
            <span class="c1"># ×™×™×ª×›×Ÿ ×©×”××©×ª××© ×—×¡× ××ª ×”×‘×•×˜ â€“ × ×¡××Ÿ ×‘-DB</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;db&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">db</span><span class="o">.</span><span class="n">db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;users&#39;</span><span class="p">):</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">update_one</span><span class="p">({</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">target_id</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;blocked&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}})</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âš ï¸ ×œ× × ×™×ª×Ÿ ×œ×©×œ×•×— (×”××©×ª××© ×—×¡× ××ª ×”×‘×•×˜ ××• ×‘×•×˜×§). ×¡×•××Ÿ ×›-blocked.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×©×œ×™×—×”: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="AdvancedBotHandlers.handle_callback_query">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.handle_callback_query">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_callback_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×˜×™×¤×•×œ ×‘×œ×—×™×¦×•×ª ×¢×œ ×›×¤×ª×•×¨×™×&quot;&quot;&quot;</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>
        
        <span class="n">data</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">user_obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s1">&#39;from_user&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s1">&#39;effective_user&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">user_obj</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;confirm_delete_&quot;</span><span class="p">):</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;confirm_delete_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">delete_file</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;âœ… ×”×§×•×‘×¥ `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">` × ××—×§ ×‘×”×¦×œ×—×”!&quot;</span><span class="p">,</span>
                        <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘××—×™×§×ª ×”×§×•×‘×¥.&quot;</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;cancel_delete&quot;</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ××—×™×§×” ×‘×•×˜×œ×”.&quot;</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;cancel_share&quot;</span><span class="p">:</span>
                <span class="c1"># ×¡×’×™×¨×ª ×”-UI ×‘×‘×˜×™×—×•×ª: ×× ×™×© message â€“ ××—×™×§×”; ××—×¨×ª × × ×§×” ××§×œ×“×ª (Inline)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># ×‘×”×•×“×¢×•×ª inline ××™×Ÿ message â€“ × × ×§×” reply markup</span>
                        <span class="k">await</span> <span class="n">TelegramUtils</span><span class="o">.</span><span class="n">safe_edit_message_reply_markup</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="c1"># ×× ×œ× × ×™×ª×Ÿ ×œ××—×•×§/×œ× ×§×•×ª â€“ × ×©×ª××© ×‘-fallback ×œ×¢×¨×™×›×ª ×˜×§×¡×˜/×›×™×ª×•×‘</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_edit_message_with_media_fallback</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s2">&quot;âŒ × ×¡×’×¨&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="c1"># × ×™×§×•×™ ×”×§×©×¨ ××¨×•×‘×” ×× × ×©××¨</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">ms</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;multi_share&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ms</span><span class="p">:</span>
                            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;multi_share&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
            
            <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;highlight_&quot;</span><span class="p">):</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;highlight_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_highlighted_code</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;share_gist_multi:&quot;</span><span class="p">):</span>
                <span class="n">share_id</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_share_to_gist_multi</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">share_id</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;share_gist_&quot;</span><span class="p">):</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;share_gist_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_share_to_gist</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;share_pastebin_&quot;</span><span class="p">):</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;share_pastebin_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_share_to_pastebin</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;share_internal_&quot;</span><span class="p">):</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;share_internal_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_share_internal</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>

            <span class="c1"># ×”×¡×¨× ×• noop/â€share_noop â€” ××™×Ÿ ×¦×•×¨×š ×¢×•×“</span>

            <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;share_internal_multi:&quot;</span><span class="p">):</span>
                <span class="n">share_id</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_share_internal_multi</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">share_id</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;download_&quot;</span><span class="p">):</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;download_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_file_download</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
            
            <span class="c1"># --- Image generation callbacks ---</span>
            <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;regenerate_image_&quot;</span><span class="p">):</span>
                <span class="n">_suffix</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;regenerate_image_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_image_target</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">_suffix</span><span class="p">)</span>
                <span class="c1"># Rate limit for expensive regeneration</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">allowed</span> <span class="o">=</span> <span class="k">await</span> <span class="n">image_rate_limiter</span><span class="o">.</span><span class="n">check_rate_limit</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">allowed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;â±ï¸ ×™×•×ª×¨ ××“×™ ×‘×§×©×•×ª. ×× × × ×¡×” ×©×•×‘ ×‘×¢×•×“ ×“×§×”.&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="n">doc</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">doc</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">):</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_edit_message_with_media_fallback</span><span class="p">(</span>
                        <span class="n">query</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s2">&quot;âŒ ×§×•×‘×¥ `</span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span><span class="si">}</span><span class="s2">` ×œ× × ××¦× ××• ×¨×™×§.&quot;</span><span class="p">,</span>
                        <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">return</span>
                <span class="n">settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_effective_image_settings</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
                <span class="n">style</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;style&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">IMAGE_CONFIG</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;default_style&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;monokai&#39;</span><span class="p">)</span>
                <span class="n">theme</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;theme&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">IMAGE_CONFIG</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;default_theme&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;dark&#39;</span><span class="p">)</span>
                <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">IMAGE_CONFIG</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;default_width&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">1200</span><span class="p">)</span>
                <span class="n">font_family</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;dejavu&#39;</span><span class="p">)</span>
                <span class="n">note_text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;note&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="kc">None</span>
                <span class="n">gen</span> <span class="o">=</span> <span class="n">CodeImageGenerator</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">,</span> <span class="n">theme</span><span class="o">=</span><span class="n">theme</span><span class="p">,</span> <span class="n">font_family</span><span class="o">=</span><span class="n">font_family</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">img</span> <span class="o">=</span> <span class="n">gen</span><span class="o">.</span><span class="n">generate_image</span><span class="p">(</span>
                        <span class="n">code</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]),</span>
                        <span class="n">language</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;programming_language&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;text&#39;</span><span class="p">),</span>
                        <span class="n">filename</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span>
                        <span class="n">max_width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span>
                        <span class="n">note</span><span class="o">=</span><span class="n">note_text</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">gen</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>  <span class="c1"># type: ignore[attr-defined]</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="n">bio</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
                <span class="n">bio</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">.png&quot;</span>
                <span class="c1"># ×¦×¨×£ ××§×œ×“×ª ×¢×“×›× ×™×ª ×’× ×œ×”×•×“×¢×ª ×”-reply ×”×—×“×©×”</span>
                <span class="n">regen_suffix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_safe_suffix</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;regenerate_image_&quot;</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
                <span class="n">edit_suffix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_safe_suffix</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;edit_image_settings_&quot;</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
                <span class="n">save_suffix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_safe_suffix</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;save_to_drive_&quot;</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
                <span class="n">kb</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">([</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”„ ×™×¦×•×¨ ××—×“×©&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;regenerate_image_</span><span class="si">{</span><span class="n">regen_suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                     <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ“ ×¢×¨×•×š ×”×’×“×¨×•×ª&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;edit_image_settings_</span><span class="si">{</span><span class="n">edit_suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)],</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ’¾ ×©××•×¨ ×‘-Drive&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;save_to_drive_</span><span class="si">{</span><span class="n">save_suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)]</span>
                <span class="p">])</span>
                <span class="n">extra_caption</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">if</span> <span class="n">note_text</span><span class="p">:</span>
                    <span class="n">extra_caption</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ğŸ“Œ ×”×¢×¨×”: </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">note_text</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_photo</span><span class="p">(</span>
                    <span class="n">photo</span><span class="o">=</span><span class="n">InputFile</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">bio</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
                    <span class="n">caption</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;ğŸ”„ × ×•×¦×¨ ××—×“×©: &lt;code&gt;</span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="si">{</span><span class="n">extra_caption</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;edit_image_settings_&quot;</span><span class="p">):</span>
                <span class="n">_suffix</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;edit_image_settings_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_image_target</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">_suffix</span><span class="p">)</span>
                <span class="c1"># ××§×œ×“×ª ×¢× ×¡×™××•×Ÿ ×”×‘×—×™×¨×” ×”× ×•×›×—×™×ª</span>
                <span class="n">kb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_image_settings_keyboard</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_edit_message_with_media_fallback</span><span class="p">(</span>
                    <span class="n">query</span><span class="p">,</span>
                    <span class="s2">&quot;ğŸ› ï¸ ×¢×¨×™×›×ª ×”×’×“×¨×•×ª ×ª××•× ×” â€“ ×‘×—×¨ ×ª××”/×¨×•×—×‘/×¤×•× ×˜ ×•××– ×œ×—×¥ &#39;×¦×•×¨ ××—×“×©&#39;&quot;</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;img_set_theme:&quot;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">theme</span><span class="p">,</span> <span class="n">suffix</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;âš ï¸ × ×ª×•× ×™× ×©×’×•×™×™×&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_image_target</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">suffix</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_image_setting</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;theme&#39;</span><span class="p">,</span> <span class="n">theme</span><span class="p">)</span>
                <span class="c1"># ×¢×“×›×Ÿ ××ª ×”××§×œ×“×ª ×›×š ×©×”×ª××” ×”× ×‘×—×¨×ª ×ª×•×¦×’ ×›âœ…</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;ğŸ¨ ×¢×•×“×›×Ÿ!&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">kb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_image_settings_keyboard</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
                    <span class="k">await</span> <span class="n">TelegramUtils</span><span class="o">.</span><span class="n">safe_edit_message_reply_markup</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">kb</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="c1"># ××™×Ÿ ×¦×•×¨×š ×œ×”×›×©×™×œ ××ª ×”×–×¨×™××” ×× ×¢×¨×™×›×ª ×”××§×œ×“×ª × ×›×©×œ×”</span>
                    <span class="k">pass</span>

            <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;img_set_width:&quot;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">width_s</span><span class="p">,</span> <span class="n">suffix</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">width_s</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;âš ï¸ ×¨×•×—×‘ ×œ× ×ª×§×™×Ÿ&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_image_target</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">suffix</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_image_setting</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;width&#39;</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;ğŸ“ ×¢×•×“×›×Ÿ!&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">kb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_image_settings_keyboard</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
                    <span class="k">await</span> <span class="n">TelegramUtils</span><span class="o">.</span><span class="n">safe_edit_message_reply_markup</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">kb</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;img_set_font:&quot;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">font_key</span><span class="p">,</span> <span class="n">suffix</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;âš ï¸ × ×ª×•× ×™× ×©×’×•×™×™×&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="k">if</span> <span class="n">font_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;dejavu&quot;</span><span class="p">,</span> <span class="s2">&quot;jetbrains&quot;</span><span class="p">,</span> <span class="s2">&quot;cascadia&quot;</span><span class="p">}:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;âš ï¸ ×¤×•× ×˜ ×œ× × ×ª××š&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_image_target</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">suffix</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_image_setting</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="n">font_key</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;ğŸ”¤ ×¢×•×“×›×Ÿ!&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">kb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_image_settings_keyboard</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
                    <span class="k">await</span> <span class="n">TelegramUtils</span><span class="o">.</span><span class="n">safe_edit_message_reply_markup</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">kb</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;img_note_prompt:&quot;</span><span class="p">):</span>
                <span class="n">suffix</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;img_note_prompt:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_image_target</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">suffix</span><span class="p">)</span>
                <span class="n">state</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;file_name&#39;</span><span class="p">:</span> <span class="n">file_name</span><span class="p">,</span>
                    <span class="s1">&#39;chat_id&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;chat_id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="s1">&#39;message_id&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;message_id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="p">}</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;waiting_for_image_note&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;×©×œ×— ×”×•×“×¢×” ×¢× ×˜×§×¡×˜ ×”×¤×ª×§×™×ª (×¢×“ 220 ×ª×•×•×™×).&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">preview</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">current_note</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_effective_image_settings</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;note&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">current_note</span><span class="p">:</span>
                    <span class="n">safe_note</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">current_note</span><span class="p">[:</span><span class="mi">120</span><span class="p">])</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_note</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">120</span><span class="p">:</span>
                        <span class="n">safe_note</span> <span class="o">+=</span> <span class="s2">&quot;â€¦&quot;</span>
                    <span class="n">preview</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">× ×•×›×—×™: </span><span class="si">{</span><span class="n">safe_note</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">msg</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s2">&quot;reply_text&quot;</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">msg</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;ğŸ—’ï¸ ×©×œ×— ×¢×›×©×™×• ××ª ×˜×§×¡×˜ ×”×¤×ª×§×™×ª ×¢×‘×•×¨ &lt;code&gt;</span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/code&gt; (×¢×“ 220 ×ª×•×•×™×).</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="s2">&quot;×›×ª×•×‘ &#39;××—×§&#39; ×œ×”×¡×¨×” ××• &#39;×‘×˜×œ&#39; ×›×“×™ ×œ×‘×˜×œ.&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">preview</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;×©×œ×— ×”×•×“×¢×” ×—×“×©×” ×¢× ×”×˜×§×¡×˜ ×”××‘×•×§×©.&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>

            <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;img_note_clear:&quot;</span><span class="p">):</span>
                <span class="n">suffix</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;img_note_clear:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_image_target</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">suffix</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_image_setting</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;note&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;ğŸ§¹ ×”×¤×ª×§×™×ª × ×•×§×ª×”.&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">kb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_image_settings_keyboard</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
                    <span class="k">await</span> <span class="n">TelegramUtils</span><span class="o">.</span><span class="n">safe_edit_message_reply_markup</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">kb</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;img_settings_done:&quot;</span><span class="p">):</span>
                <span class="n">_suffix</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;img_settings_done:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_image_target</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">_suffix</span><span class="p">)</span>
                <span class="c1"># ×©×œ×‘ ×©××™×¨×”: ×¤×¨×¡×™×¡×˜× ×¡ ×©×œ ×”×¢×“×¤×•×ª ×’×œ×•×‘×œ×™×•×ª ×œ××©×ª××©</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">eff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_image_settings</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
                    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">eff</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;theme&quot;</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">,</span> <span class="s2">&quot;font&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">eff</span><span class="p">}</span>
                    <span class="k">if</span> <span class="n">payload</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">db</span><span class="o">.</span><span class="n">save_image_prefs</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>  <span class="c1"># type: ignore[attr-defined]</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="c1"># ×× ××™×Ÿ method ×–××™×Ÿ (×‘××¦×‘ ×œ×œ× DB), ×“×œ×’ ×‘×©×§×˜</span>
                            <span class="k">pass</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="c1"># ×”×—×–×¨×ª ×”××§×œ×“×ª ×œ×‘×¡×™×¡</span>
                <span class="n">regen_suffix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_safe_suffix</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;regenerate_image_&quot;</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
                <span class="n">edit_suffix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_safe_suffix</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;edit_image_settings_&quot;</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
                <span class="n">save_suffix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_safe_suffix</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;save_to_drive_&quot;</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
                <span class="n">kb</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">([</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”„ ×¦×•×¨ ××—×“×©&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;regenerate_image_</span><span class="si">{</span><span class="n">regen_suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                     <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ“ ×¢×¨×•×š ×”×’×“×¨×•×ª&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;edit_image_settings_</span><span class="si">{</span><span class="n">edit_suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)],</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ’¾ ×©××•×¨ ×‘-Drive&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;save_to_drive_</span><span class="si">{</span><span class="n">save_suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)]</span>
                <span class="p">])</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">TelegramUtils</span><span class="o">.</span><span class="n">safe_edit_message_reply_markup</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">kb</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="c1"># ×›× ×¨××” ××™×Ÿ ××¤×©×¨×•×ª ×œ×¢×¨×•×š ×¨×§ ××ª ×”××§×œ×“×ª â€“ × × ×¡×” fallback ×›×œ×œ×™</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_edit_message_with_media_fallback</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s2">&quot;âœ… × ×©××¨×• ×”×”×¢×“×¤×•×ª&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">kb</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;âœ… × ×©××¨&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;save_to_drive_&quot;</span><span class="p">):</span>
                <span class="n">_suffix</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;save_to_drive_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_image_target</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">_suffix</span><span class="p">)</span>
                <span class="c1"># Rate limit for potentially heavy generation+upload</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">allowed</span> <span class="o">=</span> <span class="k">await</span> <span class="n">image_rate_limiter</span><span class="o">.</span><span class="n">check_rate_limit</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">allowed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;â±ï¸ ×™×•×ª×¨ ××“×™ ×‘×§×©×•×ª. ×× × × ×¡×” ×©×•×‘ ×‘×¢×•×“ ×“×§×”.&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="n">doc</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">doc</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">):</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_edit_message_with_media_fallback</span><span class="p">(</span>
                        <span class="n">query</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s2">&quot;âŒ ×§×•×‘×¥ `</span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span><span class="si">}</span><span class="s2">` ×œ× × ××¦× ××• ×¨×™×§.&quot;</span><span class="p">,</span>
                        <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">return</span>
                <span class="n">settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_effective_image_settings</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
                <span class="n">style</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;style&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">IMAGE_CONFIG</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;default_style&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;monokai&#39;</span><span class="p">)</span>
                <span class="n">theme</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;theme&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">IMAGE_CONFIG</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;default_theme&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;dark&#39;</span><span class="p">)</span>
                <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">IMAGE_CONFIG</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;default_width&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">1200</span><span class="p">)</span>
                <span class="n">font_family</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;dejavu&#39;</span><span class="p">)</span>
                <span class="n">note_text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;note&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="kc">None</span>
                <span class="n">gen</span> <span class="o">=</span> <span class="n">CodeImageGenerator</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">,</span> <span class="n">theme</span><span class="o">=</span><span class="n">theme</span><span class="p">,</span> <span class="n">font_family</span><span class="o">=</span><span class="n">font_family</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">img</span> <span class="o">=</span> <span class="n">gen</span><span class="o">.</span><span class="n">generate_image</span><span class="p">(</span>
                        <span class="n">code</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]),</span>
                        <span class="n">language</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;programming_language&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;text&#39;</span><span class="p">),</span>
                        <span class="n">filename</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span>
                        <span class="n">max_width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span>
                        <span class="n">note</span><span class="o">=</span><span class="n">note_text</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">gen</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>  <span class="c1"># type: ignore[attr-defined]</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="c1"># ×”×¢×œ××” ×œ-Drive</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">services.google_drive_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">upload_bytes</span>  <span class="c1"># type: ignore</span>
                    <span class="n">fid</span> <span class="o">=</span> <span class="n">upload_bytes</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">img</span><span class="p">,</span> <span class="n">sub_path</span><span class="o">=</span><span class="s2">&quot;code_images&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">fid</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">fid</span><span class="p">:</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_edit_message_with_media_fallback</span><span class="p">(</span>
                        <span class="n">query</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s2">&quot;âœ… × ×©××¨ ×œ-Drive (id: &lt;code&gt;</span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fid</span><span class="p">))</span><span class="si">}</span><span class="s2">&lt;/code&gt;)&quot;</span><span class="p">,</span>
                        <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_edit_message_with_media_fallback</span><span class="p">(</span>
                        <span class="n">query</span><span class="p">,</span>
                        <span class="s2">&quot;âš ï¸ ×©××™×¨×” ×œ-Drive ×œ× ×”×¦×œ×™×—×” (×‘×“×•×§ ×”×¨×©××•×ª/×—×™×‘×•×¨)&quot;</span><span class="p">,</span>
                    <span class="p">)</span>

            <span class="c1"># ×•×¢×•×“ callback handlers...</span>

            <span class="c1"># --- ChatOps: /errors inline examples ---</span>
            <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;err_ex:&quot;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># ×”×¨×©××•×ª: ××“××™× ×™× ×‘×œ×‘×“</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_admin</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×¤×§×•×“×” ×–××™× ×” ×œ×× ×”×œ×™× ×‘×œ×‘×“&quot;</span><span class="p">)</span>
                        <span class="k">return</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="n">token</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">sig</span> <span class="o">=</span> <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;errors_sig_tokens&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">sig</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">sig</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;×›×¤×ª×•×¨ ×¤×’ ×ª×•×§×£&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="c1"># ××¡×•×£ ×¢×“ 5 ×“×•×’×××•×ª ××”×‘××¤×¨ ×”××§×•××™</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">observability</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_recent_errors</span>  <span class="c1"># type: ignore</span>
                    <span class="n">examples</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">er</span> <span class="ow">in</span> <span class="p">(</span><span class="n">get_recent_errors</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]):</span>
                        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">er</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error_signature&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">er</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;event&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">sig</span><span class="p">:</span>
                            <span class="n">ts</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">er</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ts&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">er</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">er</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">er</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;event&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                            <span class="n">examples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;â€¢ </span><span class="si">{</span><span class="n">ts</span><span class="si">}</span><span class="s2"> â€“ </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">examples</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
                                <span class="k">break</span>
                    <span class="n">header</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ğŸ” ×“×•×’×××•×ª ×œ×©×’×™××•×ª ×¢×‘×•×¨ ×”×—×ª×™××”: </span><span class="si">{</span><span class="n">sig</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="c1"># ×§×™×©×•×¨ Sentry (×× ×–××™×Ÿ)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">quote_plus</span>
                        <span class="n">dsn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SENTRY_DSN&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
                        <span class="n">host</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">if</span> <span class="n">dsn</span><span class="p">:</span>
                            <span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">urlparse</span>
                            <span class="n">parsed</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">dsn</span><span class="p">)</span>
                            <span class="n">raw_host</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">hostname</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
                            <span class="k">if</span> <span class="n">raw_host</span> <span class="o">==</span> <span class="s1">&#39;sentry.io&#39;</span> <span class="ow">or</span> <span class="n">raw_host</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.sentry.io&#39;</span><span class="p">):</span>
                                <span class="n">host</span> <span class="o">=</span> <span class="s1">&#39;sentry.io&#39;</span>
                            <span class="k">elif</span> <span class="n">raw_host</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ingest.&#39;</span><span class="p">):</span>
                                <span class="n">host</span> <span class="o">=</span> <span class="n">raw_host</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s1">&#39;ingest.&#39;</span><span class="p">):]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">host</span> <span class="o">=</span> <span class="n">raw_host</span> <span class="ow">or</span> <span class="kc">None</span>
                        <span class="n">host</span> <span class="o">=</span> <span class="n">host</span> <span class="ow">or</span> <span class="s1">&#39;sentry.io&#39;</span>
                        <span class="n">org</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SENTRY_ORG&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SENTRY_ORG_SLUG&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">org</span><span class="p">:</span>
                            <span class="n">q</span> <span class="o">=</span> <span class="n">quote_plus</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;error_signature:&quot;</span><span class="si">{</span><span class="n">sig</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
                            <span class="n">link</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2">/organizations/</span><span class="si">{</span><span class="n">org</span><span class="si">}</span><span class="s2">/issues/?query=</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">&amp;statsPeriod=24h&quot;</span>
                            <span class="n">header</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Sentry: </span><span class="si">{</span><span class="n">link</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">examples</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">header</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">(××™×Ÿ ×“×•×’×××•×ª ×–××™× ×•×ª ×œ×—×ª×™××” ×–×•)&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">header</span><span class="p">]</span> <span class="o">+</span> <span class="n">examples</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;(×›×©×œ ×‘××™×¡×•×£ ×“×•×’×××•×ª)&quot;</span><span class="p">)</span>
                    <span class="k">return</span>

            <span class="c1"># --- Favorites callbacks ---</span>
            <span class="k">elif</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;favorites_list&quot;</span><span class="p">:</span>
                <span class="n">favs</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_favorites</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">favs</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;ğŸ’­ ××™×Ÿ ×œ×š ××•×¢×“×¤×™× ×›×¨×’×¢.&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_language_emoji</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;â­ &lt;b&gt;×”××•×¢×“×¤×™× ×©×œ×š&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">fav</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">favs</span><span class="p">[:</span><span class="mi">10</span><span class="p">],</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">fname</span> <span class="o">=</span> <span class="n">fav</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">lang</span> <span class="o">=</span> <span class="n">fav</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;programming_language&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">get_language_emoji</span><span class="p">(</span><span class="n">lang</span><span class="p">)</span><span class="si">}</span><span class="s2"> &lt;code&gt;</span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">favs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">â• ×•×¢×•×“ </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">favs</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">10</span><span class="si">}</span><span class="s2"> ×§×‘×¦×™×...&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;export_favorites&quot;</span><span class="p">:</span>
                <span class="n">favs</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_favorites</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
                <span class="n">export_data</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;exported_at&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                    <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
                    <span class="s2">&quot;total_favorites&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">favs</span><span class="p">),</span>
                    <span class="s2">&quot;favorites&quot;</span><span class="p">:</span> <span class="n">favs</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">raw</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">export_data</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">bio</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">raw</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
                <span class="n">bio</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;favorites.json&quot;</span>
                <span class="c1"># ×©×œ×™×—×” ×¢× BytesIO ×›×¤×¨××˜×¨ ×¨××©×•×Ÿ ×›×“×™ ×œ××¤×©×¨ ×œ×˜×¡×˜×™× ×œ×—×œ×¥ ××ª ×”×ª×•×›×Ÿ</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_document</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;favorites.json&quot;</span><span class="p">,</span> <span class="n">caption</span><span class="o">=</span><span class="s2">&quot;ğŸ“¥ ×™×™×¦×•× ××•×¢×“×¤×™× (JSON)&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âœ… ×§×•×‘×¥ ×™×™×¦×•× × ×©×œ×—&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;favorites_stats&quot;</span><span class="p">:</span>
                <span class="n">favs</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_favorites</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">favs</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;ğŸ’­ ××™×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª - ××™×Ÿ ××•×¢×“×¤×™×&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="n">langs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">all_tags</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">favs</span><span class="p">:</span>
                    <span class="n">lang</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;programming_language&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
                    <span class="n">langs</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span> <span class="o">=</span> <span class="n">langs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]):</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                                <span class="n">all_tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="n">popular_lang</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">langs</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="n">langs</span> <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;××™×Ÿ&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">Counter</span>
                <span class="n">top_tags</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">all_tags</span><span class="p">)</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;ğŸ“Š &lt;b&gt;×¡×˜×˜×™×¡×˜×™×§×•×ª ××•×¢×“×¤×™×&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;â­ ×¡×š ×”××•×¢×“×¤×™×: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">favs</span><span class="p">)</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;ğŸ”¤ ×©×¤×” ×¤×•×¤×•×œ×¨×™×ª:</span><span class="se">\n</span><span class="s2">   </span><span class="si">{</span><span class="n">popular_lang</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">popular_lang</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">top_tags</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ğŸ·ï¸ ×ª×’×™×•×ª ×¤×•×¤×•×œ×¨×™×•×ª:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;   #</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">top_tags</span><span class="p">])</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;fav_toggle_id:&quot;</span><span class="p">):</span>
                <span class="n">fid</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">doc</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_file_by_id</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">doc</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">doc</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;âš ï¸ ×”×§×•×‘×¥ ×œ× × ××¦×&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">)</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">toggle_favorite</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;â­ × ×•×¡×£ ×œ××•×¢×“×¤×™×!&quot;</span> <span class="k">if</span> <span class="n">state</span> <span class="k">else</span> <span class="s2">&quot;ğŸ’” ×”×•×¡×¨ ××”××•×¢×“×¤×™×&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="c1"># ×× ×× ×—× ×• ×‘××¡×š ×‘×§×¨×”/×¤×¢×•×œ×•×ª, ×”×¦×’ ×”×•×“×¢×ª ×¡×˜×˜×•×¡ ××¢×œ ×”×›×¤×ª×•×¨×™× ×•×©××•×¨ ××ª ×”××§×œ×“×ª</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># ×©×œ×•×£ ×¤×¨×˜×™× ×œ×”×¦×’×”</span>
                    <span class="n">latest</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
                    <span class="n">lang</span> <span class="o">=</span> <span class="n">latest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;programming_language&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;text&#39;</span>
                    <span class="n">note</span> <span class="o">=</span> <span class="n">latest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;â€”&#39;</span>
                    <span class="n">notice</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;â­ï¸ ×”×§×•×“ × ×©××¨ ×‘××•×¢×“×¤×™×&quot;</span> <span class="k">if</span> <span class="n">state</span> <span class="k">else</span> <span class="s2">&quot;ğŸ’” ×”×§×•×“ ×”×•×¡×¨ ××”××•×¢×“×¤×™×&quot;</span><span class="p">)</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">html</span><span class="w"> </span><span class="kn">import</span> <span class="n">escape</span> <span class="k">as</span> <span class="n">_e</span>
                    <span class="n">new_text</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">notice</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;ğŸ“„ ×§×•×‘×¥: &lt;code&gt;</span><span class="si">{</span><span class="n">_e</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;ğŸ§  ×©×¤×”: </span><span class="si">{</span><span class="n">_e</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">lang</span><span class="p">))</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;ğŸ“ ×”×¢×¨×”: </span><span class="si">{</span><span class="n">_e</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">note</span><span class="p">))</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;ğŸ® ×‘×—×¨ ×¤×¢×•×œ×” ××ª×§×“××ª:&quot;</span>
                    <span class="p">)</span>
                    <span class="c1"># ×‘× ×” ××§×œ×“×ª ××¢×•×“×›× ×ª ×¢× ×ª×•×•×™×ª ×›×¤×ª×•×¨ ××•×¢×“×¤×™× ×”× ×›×•× ×”</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">is_fav_now</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">is_favorite</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">fname</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">is_fav_now</span> <span class="o">=</span> <span class="n">state</span>
                    <span class="n">fav_label</span> <span class="o">=</span> <span class="s2">&quot;ğŸ’” ×”×¡×¨ ×××•×¢×“×¤×™×&quot;</span> <span class="k">if</span> <span class="n">is_fav_now</span> <span class="k">else</span> <span class="s2">&quot;â­ ×”×•×¡×£ ×œ××•×¢×“×¤×™×&quot;</span>
                    <span class="c1"># × ×¢×“×™×£ ×©×™××•×© ×‘-id ×× ×–××™×Ÿ</span>
                    <span class="n">fav_cb</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;fav_toggle_id:</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">fid</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;fav_toggle_tok:</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">telegram</span><span class="w"> </span><span class="kn">import</span> <span class="n">InlineKeyboardButton</span> <span class="k">as</span> <span class="n">_IKB</span><span class="p">,</span> <span class="n">InlineKeyboardMarkup</span> <span class="k">as</span> <span class="n">_IKM</span>
                    <span class="n">updated_kb</span> <span class="o">=</span> <span class="n">_IKM</span><span class="p">([[</span> <span class="n">_IKB</span><span class="p">(</span><span class="n">fav_label</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="n">fav_cb</span><span class="p">)</span> <span class="p">]])</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">new_text</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">updated_kb</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;fav_toggle_tok:&quot;</span><span class="p">):</span>
                <span class="n">token</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fname</span> <span class="o">=</span> <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fav_tokens&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">fname</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">fname</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;âš ï¸ ×œ× × ××¦× ×§×•×‘×¥ ×œ×¤×¢×•×œ×”&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">toggle_favorite</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;â­ × ×•×¡×£ ×œ××•×¢×“×¤×™×!&quot;</span> <span class="k">if</span> <span class="n">state</span> <span class="k">else</span> <span class="s2">&quot;ğŸ’” ×”×•×¡×¨ ××”××•×¢×“×¤×™×&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">latest</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
                    <span class="n">lang</span> <span class="o">=</span> <span class="n">latest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;programming_language&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;text&#39;</span>
                    <span class="n">note</span> <span class="o">=</span> <span class="n">latest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;â€”&#39;</span>
                    <span class="n">notice</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;â­ï¸ ×”×§×•×“ × ×©××¨ ×‘××•×¢×“×¤×™×&quot;</span> <span class="k">if</span> <span class="n">state</span> <span class="k">else</span> <span class="s2">&quot;ğŸ’” ×”×§×•×“ ×”×•×¡×¨ ××”××•×¢×“×¤×™×&quot;</span><span class="p">)</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">html</span><span class="w"> </span><span class="kn">import</span> <span class="n">escape</span> <span class="k">as</span> <span class="n">_e</span>
                    <span class="n">new_text</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">notice</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;ğŸ“„ ×§×•×‘×¥: &lt;code&gt;</span><span class="si">{</span><span class="n">_e</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;ğŸ§  ×©×¤×”: </span><span class="si">{</span><span class="n">_e</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">lang</span><span class="p">))</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;ğŸ“ ×”×¢×¨×”: </span><span class="si">{</span><span class="n">_e</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">note</span><span class="p">))</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;ğŸ® ×‘×—×¨ ×¤×¢×•×œ×” ××ª×§×“××ª:&quot;</span>
                    <span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">is_fav_now</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">is_favorite</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">fname</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">is_fav_now</span> <span class="o">=</span> <span class="n">state</span>
                    <span class="n">fav_label</span> <span class="o">=</span> <span class="s2">&quot;ğŸ’” ×”×¡×¨ ×××•×¢×“×¤×™×&quot;</span> <span class="k">if</span> <span class="n">is_fav_now</span> <span class="k">else</span> <span class="s2">&quot;â­ ×”×•×¡×£ ×œ××•×¢×“×¤×™×&quot;</span>
                    <span class="n">fav_cb</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;fav_toggle_tok:</span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">telegram</span><span class="w"> </span><span class="kn">import</span> <span class="n">InlineKeyboardButton</span> <span class="k">as</span> <span class="n">_IKB</span><span class="p">,</span> <span class="n">InlineKeyboardMarkup</span> <span class="k">as</span> <span class="n">_IKM</span>
                    <span class="n">updated_kb</span> <span class="o">=</span> <span class="n">_IKM</span><span class="p">([[</span> <span class="n">_IKB</span><span class="p">(</span><span class="n">fav_label</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="n">fav_cb</span><span class="p">)</span> <span class="p">]])</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">new_text</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">updated_kb</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;×©×’×™××” ×‘-callback: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ××™×¨×¢×” ×©×’×™××”. × ×¡×” ×©×•×‘.&quot;</span><span class="p">)</span></div>

    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_send_highlighted_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×©×œ×™×—×ª ×§×•×“ ×¢× ×”×“×’×©×ª ×ª×—×‘×™×¨&quot;&quot;&quot;</span>
        <span class="n">file_data</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_data</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×§×•×‘×¥ `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">` ×œ× × ××¦×.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># ×™×¦×™×¨×ª ×§×•×“ ××•×“×’×©</span>
        <span class="n">highlighted</span> <span class="o">=</span> <span class="n">code_processor</span><span class="o">.</span><span class="n">highlight_code</span><span class="p">(</span>
            <span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">],</span> 
            <span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;programming_language&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        
        <span class="c1"># ×©×œ×™×—×” ×›×§×•×‘×¥ HTML ×× ×”×§×•×“ ××¨×•×š</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">:</span>
            <span class="n">html_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            &lt;!DOCTYPE html&gt;</span>
<span class="s2">            &lt;html&gt;</span>
<span class="s2">            &lt;head&gt;</span>
<span class="s2">                &lt;meta charset=&quot;utf-8&quot;&gt;</span>
<span class="s2">                &lt;title&gt;</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&lt;/title&gt;</span>
<span class="s2">                &lt;style&gt;body </span><span class="se">{{</span><span class="s2"> font-family: monospace; </span><span class="se">}}</span><span class="s2">&lt;/style&gt;</span>
<span class="s2">            &lt;/head&gt;</span>
<span class="s2">            &lt;body&gt;</span>
<span class="s2">                </span><span class="si">{</span><span class="n">highlighted</span><span class="si">}</span>
<span class="s2">            &lt;/body&gt;</span>
<span class="s2">            &lt;/html&gt;</span>
<span class="s2">            &quot;&quot;&quot;</span>
            
            <span class="n">html_file</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">html_content</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
            <span class="n">html_file</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">.html&quot;</span>
            
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_document</span><span class="p">(</span>
                <span class="n">document</span><span class="o">=</span><span class="n">InputFile</span><span class="p">(</span><span class="n">html_file</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">.html&quot;</span><span class="p">),</span>
                <span class="n">caption</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;ğŸ¨ ×§×•×“ ××•×“×’×© ×¢×‘×•×¨ `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">`&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># ×©×œ×™×—×” ×›×”×•×“×¢×”</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ¨ **×§×•×“ ××•×“×’×© ×¢×‘×•×¨:** `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">`</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;```</span><span class="si">{</span><span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;programming_language&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">```&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
            <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_send_long_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg_target</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">parse_mode</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">reply_markup</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">InlineKeyboardMarkup</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×©×œ×™×—×ª ×˜×§×¡×˜ ××¨×•×š ×‘××¡×¤×¨ ×”×•×“×¢×•×ª, ××¤×•×¦×œ ×œ×¤×™ ××•×¨×š ×‘×˜×•×— ×œ×˜×œ×’×¨×.</span>

<span class="sd">        ××’×‘×œ×ª ××•×¨×š ×”×•×“×¢×ª ×˜×œ×’×¨× ×”×™× ×¡×‘×™×‘ 4096 ×ª×•×•×™×. × ×©×ª××© ×‘××¨×•×•×— ×‘×˜×—×•×Ÿ.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">MAX_LEN</span> <span class="o">=</span> <span class="mi">3500</span>
            <span class="n">remaining</span> <span class="o">=</span> <span class="n">text</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">remaining</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">MAX_LEN</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">msg_target</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">remaining</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">parse_mode</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="c1"># ×¤×™×¦×•×œ ×œ×¤×™ ×©×•×¨×•×ª ×›×“×™ ×œ×©××•×¨ ×¢×œ ×¤×™×¨×•×§ ×˜×‘×¢×™</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">(</span><span class="n">remaining</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">remaining</span> <span class="k">else</span> <span class="p">[])</span>
            <span class="n">buf</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">curr</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="c1"># +1 ×¢×‘×•×¨ ×”&quot;\n&quot; ×©×™×ª×•×•×¡×£ ×‘×”××©×š</span>
                <span class="n">line_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">buf</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">curr</span> <span class="o">+</span> <span class="n">line_len</span> <span class="o">&gt;</span> <span class="n">MAX_LEN</span><span class="p">:</span>
                    <span class="n">chunk</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
                    <span class="k">await</span> <span class="n">msg_target</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">parse_mode</span><span class="p">)</span>
                    <span class="n">buf</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="p">]</span>
                    <span class="n">curr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="n">curr</span> <span class="o">+=</span> <span class="n">line_len</span>
            <span class="k">if</span> <span class="n">buf</span><span class="p">:</span>
                <span class="n">chunk</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">msg_target</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">parse_mode</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># ×‘××§×¨×” ×—×¨×™×’, ×©×œ×— ××ª ×”×›×œ ×‘×”×•×“×¢×” ××—×ª (×¢×œ×•×œ ×œ×—×¨×•×’ ×× ××¨×•×š ××“×™)</span>
            <span class="k">await</span> <span class="n">msg_target</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">text</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">parse_mode</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span><span class="p">)</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_share_to_gist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×©×™×ª×•×£ ×‘-GitHub Gist&quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">GITHUB_TOKEN</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="s2">&quot;âŒ ×©×™×ª×•×£ ×‘-Gist ×œ× ×–××™×Ÿ - ×œ× ×”×•×’×“×¨ ×˜×•×§×Ÿ GitHub.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">file_data</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_data</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×§×•×‘×¥ `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">` ×œ× × ××¦×.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">integrations</span><span class="w"> </span><span class="kn">import</span> <span class="n">code_sharing</span>
            <span class="n">description</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;×©×™×ª×•×£ ××•×˜×•××˜×™ ×“×¨×š CodeBot â€” </span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">code_sharing</span><span class="o">.</span><span class="n">share_code</span><span class="p">(</span>
                <span class="n">service</span><span class="o">=</span><span class="s2">&quot;gist&quot;</span><span class="p">,</span>
                <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span>
                <span class="n">code</span><span class="o">=</span><span class="n">file_data</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">],</span>
                <span class="n">language</span><span class="o">=</span><span class="n">file_data</span><span class="p">[</span><span class="s2">&quot;programming_language&quot;</span><span class="p">],</span>
                <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
                <span class="n">public</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×™×¦×™×¨×ª Gist × ×›×©×œ×”. ×•×“× ×©×˜×•×§×Ÿ GitHub ×ª×§×™×Ÿ ×•×”×¨×©××•×ª ××ª××™××•×ª.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ™ **×©×•×ª×£ ×‘-GitHub Gist!**</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ“„ ×§×•×‘×¥: `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">`</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ”— ×§×™×©×•×¨: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
            <span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;×©×’×™××” ×‘×©×™×ª×•×£ Gist: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×©×™×ª×•×£. × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_share_to_pastebin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×©×™×ª×•×£ ×‘-Pastebin&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">integrations</span><span class="w"> </span><span class="kn">import</span> <span class="n">code_sharing</span>
        <span class="n">file_data</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_data</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×§×•×‘×¥ `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">` ×œ× × ××¦×.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">code_sharing</span><span class="o">.</span><span class="n">share_code</span><span class="p">(</span>
                <span class="n">service</span><span class="o">=</span><span class="s2">&quot;pastebin&quot;</span><span class="p">,</span>
                <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span>
                <span class="n">code</span><span class="o">=</span><span class="n">file_data</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">],</span>
                <span class="n">language</span><span class="o">=</span><span class="n">file_data</span><span class="p">[</span><span class="s2">&quot;programming_language&quot;</span><span class="p">],</span>
                <span class="n">private</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">expire</span><span class="o">=</span><span class="s2">&quot;1M&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×™×¦×™×¨×ª Pastebin × ×›×©×œ×”. ×‘×“×•×§ ××¤×ª×— API.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ“‹ **×©×•×ª×£ ×‘-Pastebin!**</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ“„ ×§×•×‘×¥: `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">`</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ”— ×§×™×©×•×¨: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;×©×’×™××” ×‘×©×™×ª×•×£ Pastebin: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×©×™×ª×•×£. × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_share_internal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×™×¦×™×¨×ª ×§×™×©×•×¨ ×©×™×ª×•×£ ×¤× ×™××™&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">integrations</span><span class="w"> </span><span class="kn">import</span> <span class="n">code_sharing</span>
        <span class="n">file_data</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_data</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×§×•×‘×¥ `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">` ×œ× × ××¦×.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">code_sharing</span><span class="o">.</span><span class="n">share_code</span><span class="p">(</span>
                <span class="n">service</span><span class="o">=</span><span class="s2">&quot;internal&quot;</span><span class="p">,</span>
                <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span>
                <span class="n">code</span><span class="o">=</span><span class="n">file_data</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">],</span>
                <span class="n">language</span><span class="o">=</span><span class="n">file_data</span><span class="p">[</span><span class="s2">&quot;programming_language&quot;</span><span class="p">],</span>
                <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;×©×™×ª×•×£ ×¤× ×™××™ ×©×œ </span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×™×¦×™×¨×ª ×§×™×©×•×¨ ×¤× ×™××™ × ×›×©×œ×”.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">PUBLIC_BASE_URL</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                    <span class="s2">&quot;â„¹ï¸ ×§×™×©×•×¨ ×¤× ×™××™ ××™× ×• ×–××™×Ÿ ×›×¨×’×¢ (×œ× ×”×•×’×“×¨ PUBLIC_BASE_URL).</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;×‘××¤×©×¨×•×ª×š ×œ×”×©×ª××© ×‘-Gist/Pastebin ×‘××§×•×.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="c1"># × ×™×¡×•×— ×ª×•×§×£ ×§×¨×™×</span>
            <span class="n">expires_iso</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;expires_at&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">expiry_line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;â³ ×ª×•×§×£: </span><span class="si">{</span><span class="n">expires_iso</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">expires_iso</span><span class="p">)</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">tzinfo</span><span class="p">)</span> <span class="k">if</span> <span class="n">dt</span><span class="o">.</span><span class="n">tzinfo</span> <span class="k">else</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                <span class="n">delta</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">-</span> <span class="n">now</span>
                <span class="n">total_seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">total_seconds</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">days</span> <span class="o">=</span> <span class="n">total_seconds</span> <span class="o">//</span> <span class="mi">86400</span>
                    <span class="n">hours</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_seconds</span> <span class="o">%</span> <span class="mi">86400</span><span class="p">)</span> <span class="o">//</span> <span class="mi">3600</span>
                    <span class="k">if</span> <span class="n">days</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">rel</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;×‘×¢×•×“ ~</span><span class="si">{</span><span class="n">days</span><span class="si">}</span><span class="s2"> ×™××™×&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot; ×•-</span><span class="si">{</span><span class="n">hours</span><span class="si">}</span><span class="s2"> ×©×¢×•×ª&quot;</span> <span class="k">if</span> <span class="n">hours</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">hours</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">rel</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;×‘×¢×•×“ ~</span><span class="si">{</span><span class="n">hours</span><span class="si">}</span><span class="s2"> ×©×¢×•×ª&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">minutes</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_seconds</span> <span class="o">%</span> <span class="mi">3600</span><span class="p">)</span> <span class="o">//</span> <span class="mi">60</span>
                        <span class="n">rel</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;×‘×¢×•×“ ~</span><span class="si">{</span><span class="n">minutes</span><span class="si">}</span><span class="s2"> ×“×§×•×ª&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rel</span> <span class="o">=</span> <span class="s2">&quot;×¤×’&quot;</span>
                <span class="n">date_str</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/%m/%Y %H:%M&quot;</span><span class="p">)</span>
                <span class="n">expiry_line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;â³ ×ª×•×§×£: </span><span class="si">{</span><span class="n">date_str</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">rel</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">safe_file</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
            <span class="n">safe_url</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">])</span>
            <span class="n">safe_expiry</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">expiry_line</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ“± &lt;b&gt;× ×•×¦×¨ ×§×™×©×•×¨ ×¤× ×™××™!&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ“„ ×§×•×‘×¥: &lt;code&gt;</span><span class="si">{</span><span class="n">safe_file</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ”— ×§×™×©×•×¨: &lt;a href=</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">safe_url</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&gt;</span><span class="si">{</span><span class="n">safe_url</span><span class="si">}</span><span class="s2">&lt;/a&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">safe_expiry</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;×©×’×™××” ×‘×™×¦×™×¨×ª ×§×™×©×•×¨ ×¤× ×™××™: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×©×™×ª×•×£. × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_share_to_gist_multi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">share_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×©×™×ª×•×£ ××¡×¤×¨ ×§×‘×¦×™× ×œ×’×™×¡×˜ ××—×“&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">integrations</span><span class="w"> </span><span class="kn">import</span> <span class="n">gist_integration</span>
        <span class="n">files_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;multi_share&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">share_id</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">names</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×œ× × ××¦××” ×¨×©×™××ª ×§×‘×¦×™× ×¢×‘×•×¨ ×”×©×™×ª×•×£.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">files_map</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">files_map</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×œ× × ××¦××• ×§×‘×¦×™× ×¤×¢×™×œ×™× ×œ×©×™×ª×•×£.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">GITHUB_TOKEN</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×©×™×ª×•×£ ×‘-Gist ×œ× ×–××™×Ÿ - ××™×Ÿ GITHUB_TOKEN.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">description</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;×©×™×ª×•×£ ××¨×•×‘×” ×§×‘×¦×™× (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">files_map</span><span class="p">)</span><span class="si">}</span><span class="s2">) ×“×¨×š </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">BOT_LABEL</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">gist_integration</span><span class="o">.</span><span class="n">create_gist_multi</span><span class="p">(</span><span class="n">files_map</span><span class="o">=</span><span class="n">files_map</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span> <span class="n">public</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×™×¦×™×¨×ª Gist ××¨×•×‘×” ×§×‘×¦×™× × ×›×©×œ×”.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ™ **×©×•×ª×£ ×‘-GitHub Gist (××¨×•×‘×” ×§×‘×¦×™×)!**</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ“„ ×§×‘×¦×™×: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">files_map</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ”— ×§×™×©×•×¨: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;×©×’×™××” ×‘×©×™×ª×•×£ ×’×™×¡×˜ ××¨×•×‘×”: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×©×™×ª×•×£. × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.&quot;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;multi_share&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">share_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_share_internal_multi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">share_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×™×¦×™×¨×ª ×§×™×©×•×¨ ×¤× ×™××™ ×œ××¡×¤×¨ ×§×‘×¦×™× â€” ×××—×“ ×œ×§×•×‘×¥ ×˜×§×¡×˜ ××—×“&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">integrations</span><span class="w"> </span><span class="kn">import</span> <span class="n">code_sharing</span>
        <span class="n">names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;multi_share&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">share_id</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">names</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×œ× × ××¦××” ×¨×©×™××ª ×§×‘×¦×™× ×¢×‘×•×¨ ×”×©×™×ª×•×£.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># × ××—×“ ×œ×§×•×‘×¥ ×˜×§×¡×˜ ××—×“ ×§×¦×¨ ×¢× ××¤×¨×™×“×™×</span>
        <span class="n">bundle_parts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lang_hint</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">lang_hint</span> <span class="o">=</span> <span class="n">lang_hint</span> <span class="ow">or</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;programming_language&#39;</span><span class="p">]</span>
                <span class="n">bundle_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;// ==== </span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> ====</span><span class="se">\n</span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bundle_parts</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×œ× × ××¦××• ×§×‘×¦×™× ×œ×©×™×ª×•×£ ×¤× ×™××™.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">combined_code</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bundle_parts</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">code_sharing</span><span class="o">.</span><span class="n">share_code</span><span class="p">(</span>
                <span class="n">service</span><span class="o">=</span><span class="s2">&quot;internal&quot;</span><span class="p">,</span>
                <span class="n">file_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;bundle-</span><span class="si">{</span><span class="n">share_id</span><span class="si">}</span><span class="s2">.txt&quot;</span><span class="p">,</span>
                <span class="n">code</span><span class="o">=</span><span class="n">combined_code</span><span class="p">,</span>
                <span class="n">language</span><span class="o">=</span><span class="n">lang_hint</span> <span class="ow">or</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;×©×™×ª×•×£ ×¤× ×™××™ ××¨×•×‘×” ×§×‘×¦×™× (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×™×¦×™×¨×ª ×§×™×©×•×¨ ×¤× ×™××™ × ×›×©×œ×”.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">PUBLIC_BASE_URL</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                    <span class="s2">&quot;â„¹ï¸ ×§×™×©×•×¨ ×¤× ×™××™ ××™× ×• ×–××™×Ÿ ×›×¨×’×¢ (×œ× ×”×•×’×“×¨ PUBLIC_BASE_URL).</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;×‘××¤×©×¨×•×ª×š ×œ×”×©×ª××© ×‘-Gist ×‘××¨×•×‘×” ×§×‘×¦×™×.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="c1"># × ×™×¡×•×— ×ª×•×§×£ ×§×¨×™×</span>
            <span class="n">expires_iso</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;expires_at&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">expiry_line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;â³ ×ª×•×§×£: </span><span class="si">{</span><span class="n">expires_iso</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">expires_iso</span><span class="p">)</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">tzinfo</span><span class="p">)</span> <span class="k">if</span> <span class="n">dt</span><span class="o">.</span><span class="n">tzinfo</span> <span class="k">else</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                <span class="n">delta</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">-</span> <span class="n">now</span>
                <span class="n">total_seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">total_seconds</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">days</span> <span class="o">=</span> <span class="n">total_seconds</span> <span class="o">//</span> <span class="mi">86400</span>
                    <span class="n">hours</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_seconds</span> <span class="o">%</span> <span class="mi">86400</span><span class="p">)</span> <span class="o">//</span> <span class="mi">3600</span>
                    <span class="k">if</span> <span class="n">days</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">rel</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;×‘×¢×•×“ ~</span><span class="si">{</span><span class="n">days</span><span class="si">}</span><span class="s2"> ×™××™×&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot; ×•-</span><span class="si">{</span><span class="n">hours</span><span class="si">}</span><span class="s2"> ×©×¢×•×ª&quot;</span> <span class="k">if</span> <span class="n">hours</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">hours</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">rel</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;×‘×¢×•×“ ~</span><span class="si">{</span><span class="n">hours</span><span class="si">}</span><span class="s2"> ×©×¢×•×ª&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">minutes</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_seconds</span> <span class="o">%</span> <span class="mi">3600</span><span class="p">)</span> <span class="o">//</span> <span class="mi">60</span>
                        <span class="n">rel</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;×‘×¢×•×“ ~</span><span class="si">{</span><span class="n">minutes</span><span class="si">}</span><span class="s2"> ×“×§×•×ª&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rel</span> <span class="o">=</span> <span class="s2">&quot;×¤×’&quot;</span>
                <span class="n">date_str</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/%m/%Y %H:%M&quot;</span><span class="p">)</span>
                <span class="n">expiry_line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;â³ ×ª×•×§×£: </span><span class="si">{</span><span class="n">date_str</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">rel</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">safe_url</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">])</span>
            <span class="n">safe_expiry</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">expiry_line</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ“± &lt;b&gt;× ×•×¦×¨ ×§×™×©×•×¨ ×¤× ×™××™ (××¨×•×‘×” ×§×‘×¦×™×)!&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ“„ ×§×‘×¦×™×: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ”— ×§×™×©×•×¨: &lt;a href=</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">safe_url</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&gt;</span><span class="si">{</span><span class="n">safe_url</span><span class="si">}</span><span class="s2">&lt;/a&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">safe_expiry</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;×©×’×™××” ×‘×§×™×©×•×¨ ×¤× ×™××™ ××¨×•×‘×”: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×©×™×ª×•×£. × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.&quot;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;multi_share&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">share_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_send_file_download</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">file_data</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_data</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×§×•×‘×¥ `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">` ×œ× × ××¦×.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_document</span><span class="p">(</span><span class="n">document</span><span class="o">=</span><span class="n">InputFile</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)),</span> <span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>

    <span class="c1"># ===== ChatOps: Language detection =====</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_code_from_message_or_reply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;× ×™×¡×™×•×Ÿ ×œ××©×•×š ×§×•×“ ××”×•×“×¢×” × ×•×›×—×™×ª ××• ××”×•×“×¢×ª ×ª×’×•×‘×” (reply).&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># ×× ×™×© ×ª×’×•×‘×” â€“ ×”×¢×“×£ ××ª ×”×˜×§×¡×˜ ××”×”×•×“×¢×” ××œ×™×” ××’×™×‘×™×</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="s2">&quot;reply_to_message&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">rt</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_to_message</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">rt</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">rt</span><span class="o">.</span><span class="n">text</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">rt</span><span class="p">,</span> <span class="s2">&quot;caption&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">rt</span><span class="o">.</span><span class="n">caption</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="c1"># ×—×™×¤×•×© ×‘×œ×•×§ ``` ×‘×§×•×× ×“ ×”× ×•×›×—×™</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">txt</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">text</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="s2">&quot;```&quot;</span> <span class="ow">in</span> <span class="n">txt</span><span class="p">:</span>
                <span class="n">first</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;```&quot;</span><span class="p">)</span>
                <span class="n">last</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s2">&quot;```&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">last</span> <span class="o">&gt;</span> <span class="n">first</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">txt</span><span class="p">[</span><span class="n">first</span> <span class="o">+</span> <span class="mi">3</span><span class="p">:</span><span class="n">last</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_infer_reason</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">language</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×”×¡×‘×¨ ×§×¦×¨ ×¢×œ ××” ×”×›×¨×™×¢: shebang / ×©× ×§×•×‘×¥ / ×¡×™×•××ª / ×ª×•×›×Ÿ / fallback.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="p">(</span><span class="n">filename</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">fn</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span> <span class="k">as</span> <span class="n">_P</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="n">_P</span><span class="p">(</span><span class="n">base</span><span class="p">)</span><span class="o">.</span><span class="n">suffix</span>  <span class="c1"># &#39;&#39; ×× ××™×Ÿ ×¡×™×•××ª</span>
            <span class="n">first_line</span> <span class="o">=</span> <span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">code</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">first_line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;#!&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="s2">&quot;bash&quot;</span> <span class="ow">in</span> <span class="n">first_line</span> <span class="ow">or</span> <span class="n">first_line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;/sh&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot; env sh&quot;</span> <span class="ow">in</span> <span class="n">first_line</span> <span class="ow">or</span> <span class="s2">&quot; env bash&quot;</span> <span class="ow">in</span> <span class="n">first_line</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s2">&quot;shebang (bash/sh)&quot;</span>
                <span class="k">if</span> <span class="s2">&quot;python&quot;</span> <span class="ow">in</span> <span class="n">first_line</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s2">&quot;shebang (python)&quot;</span>
            <span class="k">if</span> <span class="n">base</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;dockerfile&quot;</span><span class="p">,</span> <span class="s2">&quot;makefile&quot;</span><span class="p">,</span> <span class="s2">&quot;taskfile&quot;</span><span class="p">,</span> <span class="s2">&quot;.gitignore&quot;</span><span class="p">,</span> <span class="s2">&quot;.dockerignore&quot;</span><span class="p">,</span> <span class="s2">&quot;.env&quot;</span><span class="p">}:</span>
                <span class="k">return</span> <span class="s2">&quot;×©× ×§×•×‘×¥ ××™×•×—×“&quot;</span>
            <span class="n">non_generic</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;.py&quot;</span><span class="p">,</span> <span class="s2">&quot;.pyw&quot;</span><span class="p">,</span> <span class="s2">&quot;.pyx&quot;</span><span class="p">,</span> <span class="s2">&quot;.pyi&quot;</span><span class="p">,</span> <span class="s2">&quot;.js&quot;</span><span class="p">,</span> <span class="s2">&quot;.jsx&quot;</span><span class="p">,</span> <span class="s2">&quot;.ts&quot;</span><span class="p">,</span> <span class="s2">&quot;.tsx&quot;</span><span class="p">,</span> <span class="s2">&quot;.mjs&quot;</span><span class="p">,</span> <span class="s2">&quot;.html&quot;</span><span class="p">,</span> <span class="s2">&quot;.htm&quot;</span><span class="p">,</span> <span class="s2">&quot;.css&quot;</span><span class="p">,</span> <span class="s2">&quot;.scss&quot;</span><span class="p">,</span> <span class="s2">&quot;.sass&quot;</span><span class="p">,</span> <span class="s2">&quot;.less&quot;</span><span class="p">,</span> <span class="s2">&quot;.java&quot;</span><span class="p">,</span> <span class="s2">&quot;.cpp&quot;</span><span class="p">,</span> <span class="s2">&quot;.cxx&quot;</span><span class="p">,</span> <span class="s2">&quot;.cc&quot;</span><span class="p">,</span> <span class="s2">&quot;.hpp&quot;</span><span class="p">,</span> <span class="s2">&quot;.hxx&quot;</span><span class="p">,</span> <span class="s2">&quot;.c&quot;</span><span class="p">,</span> <span class="s2">&quot;.cs&quot;</span><span class="p">,</span> <span class="s2">&quot;.go&quot;</span><span class="p">,</span> <span class="s2">&quot;.rs&quot;</span><span class="p">,</span> <span class="s2">&quot;.rb&quot;</span><span class="p">,</span> <span class="s2">&quot;.rake&quot;</span><span class="p">,</span> <span class="s2">&quot;.php&quot;</span><span class="p">,</span> <span class="s2">&quot;.phtml&quot;</span><span class="p">,</span> <span class="s2">&quot;.swift&quot;</span><span class="p">,</span> <span class="s2">&quot;.sh&quot;</span><span class="p">,</span> <span class="s2">&quot;.bash&quot;</span><span class="p">,</span> <span class="s2">&quot;.zsh&quot;</span><span class="p">,</span> <span class="s2">&quot;.fish&quot;</span><span class="p">,</span> <span class="s2">&quot;.sql&quot;</span><span class="p">,</span> <span class="s2">&quot;.json&quot;</span><span class="p">,</span> <span class="s2">&quot;.yaml&quot;</span><span class="p">,</span> <span class="s2">&quot;.yml&quot;</span><span class="p">,</span> <span class="s2">&quot;.xml&quot;</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">non_generic</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;×¡×™×•××ª ×œ×-×’× ×¨×™×ª&quot;</span>
            <span class="n">generic_md</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;.md&quot;</span><span class="p">,</span> <span class="s2">&quot;.markdown&quot;</span><span class="p">,</span> <span class="s2">&quot;.mdown&quot;</span><span class="p">,</span> <span class="s2">&quot;.mkd&quot;</span><span class="p">,</span> <span class="s2">&quot;.mkdn&quot;</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">generic_md</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;×ª×•×›×Ÿ (override ×œ-.md)&quot;</span> <span class="k">if</span> <span class="n">language</span> <span class="o">==</span> <span class="s2">&quot;python&quot;</span> <span class="k">else</span> <span class="s2">&quot;×¡×™×•××ª ×’× ×¨×™×ª (.md)&quot;</span>
            <span class="k">if</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;.txt&quot;</span><span class="p">}:</span>
                <span class="k">return</span> <span class="s2">&quot;×ª×•×›×Ÿ (override ×œ-.txt/×œ×œ× ×¡×™×•××ª)&quot;</span> <span class="k">if</span> <span class="n">language</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;python&quot;</span><span class="p">,</span> <span class="s2">&quot;yaml&quot;</span><span class="p">,</span> <span class="s2">&quot;bash&quot;</span><span class="p">}</span> <span class="k">else</span> <span class="s2">&quot;×‘×¨×™×¨×ª ××—×“×œ (.txt/×œ×œ×)&quot;</span>
            <span class="k">return</span> <span class="s2">&quot;fallback&quot;</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

<div class="viewcode-block" id="AdvancedBotHandlers.lang_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.lang_command">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">lang_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;/lang â€“ ×–×™×”×•×™ ×©×¤×” ×§×¦×¨: ××§×‘×œ ×©× ×§×•×‘×¥ ××•×¤×¦×™×•× ×œ×™ ×•/××• ×§×•×“ (reply/``` block).&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[]</span>
            <span class="n">arg_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_code_from_message_or_reply</span><span class="p">(</span><span class="n">update</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">arg_text</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;editing_file_name&quot;</span><span class="p">))</span>
                <span class="ow">or</span> <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;last_save_success&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file_name&quot;</span><span class="p">)</span>
                <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
            <span class="p">)</span>
            <span class="n">language</span> <span class="o">=</span> <span class="n">code_processor</span><span class="o">.</span><span class="n">detect_language</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infer_reason</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">language</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ğŸ§  ×©×¤×”: </span><span class="si">{</span><span class="n">language</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">filename</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ğŸ“„ ×§×•×‘×¥: `</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">`&quot;</span>
            <span class="k">if</span> <span class="n">reason</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">â„¹ï¸ ×¡×™×‘×”: </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘-/lang: </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdvancedBotHandlers.lang_debug_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.lang_debug_command">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">lang_debug_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;/lang_debug â€“ ×¤×™×¨×•×˜ ××œ×: ×©×/×¡×™×•××ª/shebang/××•×ª×•×ª ×ª×•×›×Ÿ ×•×”×›×¨×¢×”.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span> <span class="k">as</span> <span class="n">_P</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">re</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_re</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[]</span>
            <span class="n">arg_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_code_from_message_or_reply</span><span class="p">(</span><span class="n">update</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">arg_text</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;editing_file_name&quot;</span><span class="p">))</span>
                <span class="ow">or</span> <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;last_save_success&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file_name&quot;</span><span class="p">)</span>
                <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
            <span class="p">)</span>
            <span class="n">language</span> <span class="o">=</span> <span class="n">code_processor</span><span class="o">.</span><span class="n">detect_language</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="p">(</span><span class="n">filename</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">fn</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="n">_P</span><span class="p">(</span><span class="n">base</span><span class="p">)</span><span class="o">.</span><span class="n">suffix</span> <span class="ow">or</span> <span class="s2">&quot;(none)&quot;</span>
            <span class="n">first_line</span> <span class="o">=</span> <span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">code</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="c1"># ××•×ª×•×ª ×ª×•×›×Ÿ</span>
            <span class="n">py_signals</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">s_def</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">_re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^\s*def\s+\w+\s*\(&quot;</span><span class="p">,</span> <span class="n">code</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">_re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">))</span>
            <span class="n">s_class</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">_re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^\s*class\s+\w+\s*\(?&quot;</span><span class="p">,</span> <span class="n">code</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">_re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">))</span>
            <span class="n">s_import</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">_re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^\s*import\s+\w+&quot;</span><span class="p">,</span> <span class="n">code</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">_re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">))</span>
            <span class="n">s_main</span> <span class="o">=</span> <span class="s2">&quot;__name__&quot;</span> <span class="ow">in</span> <span class="p">(</span><span class="n">code</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;__main__&quot;</span> <span class="ow">in</span> <span class="p">(</span><span class="n">code</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">s_block</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">_re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;:\s*(#.*)?\n\s{4,}\S&quot;</span><span class="p">,</span> <span class="n">code</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">_re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="p">(</span><span class="n">s_def</span><span class="p">,</span> <span class="n">s_class</span><span class="p">,</span> <span class="n">s_import</span><span class="p">,</span> <span class="n">s_main</span><span class="p">,</span> <span class="n">s_block</span><span class="p">):</span>
                <span class="n">py_signals</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">b</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">md_heading</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">_re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(^|\n)\s{0,3}#[^#]&quot;</span><span class="p">,</span> <span class="n">code</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
            <span class="n">md_list</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">_re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(^|\n)\s{0,2}[-*+]\s+\S&quot;</span><span class="p">,</span> <span class="n">code</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
            <span class="n">md_link</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">_re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\[.+?\]\(.+?\)&quot;</span><span class="p">,</span> <span class="n">code</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
            <span class="n">md_fence</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;```&quot;</span> <span class="ow">in</span> <span class="p">(</span><span class="n">code</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infer_reason</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">language</span><span class="p">)</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;ğŸ§ª Language Debug&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ“„ file: `</span><span class="si">{</span><span class="n">filename</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;â€”&#39;</span><span class="si">}</span><span class="s2">`&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ”– base: </span><span class="si">{</span><span class="n">base</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;â€”&#39;</span><span class="si">}</span><span class="s2">  â€¢  ext: </span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;#! shebang: </span><span class="si">{</span><span class="n">first_line</span><span class="p">[:</span><span class="mi">120</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;â€¦&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">first_line</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">120</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;â€”&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ python_signals: def=</span><span class="si">{</span><span class="n">s_def</span><span class="si">}</span><span class="s2"> class=</span><span class="si">{</span><span class="n">s_class</span><span class="si">}</span><span class="s2"> import=</span><span class="si">{</span><span class="n">s_import</span><span class="si">}</span><span class="s2"> main=</span><span class="si">{</span><span class="n">s_main</span><span class="si">}</span><span class="s2"> block=</span><span class="si">{</span><span class="n">s_block</span><span class="si">}</span><span class="s2"> total=</span><span class="si">{</span><span class="n">py_signals</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ“ md_markers: heading=</span><span class="si">{</span><span class="n">md_heading</span><span class="si">}</span><span class="s2"> list=</span><span class="si">{</span><span class="n">md_list</span><span class="si">}</span><span class="s2"> link=</span><span class="si">{</span><span class="n">md_link</span><span class="si">}</span><span class="s2"> fence=</span><span class="si">{</span><span class="n">md_fence</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ§  language: </span><span class="si">{</span><span class="n">language</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;â„¹ï¸ reason: </span><span class="si">{</span><span class="n">reason</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;â€”&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘-/lang_debug: </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


    <span class="c1"># --- Image generation commands ---------------------------------------</span>
<div class="viewcode-block" id="AdvancedBotHandlers.image_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.image_command">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">image_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×™×¦×™×¨×ª ×ª××•× ×ª PNG ××”×§×•×“ ×¢×‘×•×¨ ×§×•×‘×¥ × ×ª×•×Ÿ.&quot;&quot;&quot;</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>

        <span class="c1"># ×©×™××•×© ×‘×¡×™×¡×™ ×•×”×¡×‘×¨ ×§×¦×¨</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;ğŸ–¼ï¸ &lt;b&gt;×™×¦×™×¨×ª ×ª××•× ×ª ×§×•×“&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;×©×™××•×©: &lt;code&gt;/image &amp;lt;file_name&amp;gt;&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;××¤×©×¨ ×œ×”×•×¡×™×£ ×”×¢×¨×” ×§×¦×¨×”: &lt;code&gt;/image file.py --note ×‘×“×™×§×”&lt;/code&gt;&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Rate limiting</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">allowed</span> <span class="o">=</span> <span class="k">await</span> <span class="n">image_rate_limiter</span><span class="o">.</span><span class="n">check_rate_limit</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">allowed</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># ××œ ×ª×©×‘×•×¨ ××ª ×”×–×¨×™××” ×‘××§×¨×” ×—×¨×™×’</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;â±ï¸ ×™×•×ª×¨ ××“×™ ×‘×§×©×•×ª. ×× × × ×¡×” ×©×•×‘ ×‘×¢×•×“ ×“×§×”.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">file_name</span><span class="p">,</span> <span class="n">inline_note</span><span class="p">,</span> <span class="n">note_explicit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_image_args</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_name</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;âŒ ×× × ×¦×™×™×Ÿ ×©× ×§×•×‘×¥.</span><span class="se">\n</span><span class="s2">×“×•×’××”: &lt;code&gt;/image script.py&lt;/code&gt;&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">note_explicit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_image_setting</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;note&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">inline_note</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">))</span>
        <span class="n">file_data</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_data</span><span class="p">:</span>
            <span class="n">safe</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×§×•×‘×¥ &lt;code&gt;</span><span class="si">{</span><span class="n">safe</span><span class="si">}</span><span class="s2">&lt;/code&gt; ×œ× × ××¦×.&quot;</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">code</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">language</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;programming_language&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;text&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">code</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×”×§×•×‘×¥ ×¨×™×§.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">code_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="n">requested_width</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># ×”×¢×“×¤×•×ª ××¤×§×˜×™×‘×™×•×ª: ×¤×¨-××©×ª××© (DB) ×¢× ×“×¨×™×¡×” ×¤×¨-×§×•×‘×¥ (context)</span>
            <span class="n">settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_effective_image_settings</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
            <span class="n">style</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;style&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">IMAGE_CONFIG</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;default_style&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;monokai&#39;</span><span class="p">)</span>
            <span class="n">theme</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;theme&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">IMAGE_CONFIG</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;default_theme&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;dark&#39;</span><span class="p">)</span>
            <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">IMAGE_CONFIG</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;default_width&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">1200</span><span class="p">)</span>
            <span class="n">requested_width</span> <span class="o">=</span> <span class="n">width</span>
            <span class="n">font_family</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;dejavu&#39;</span><span class="p">)</span>
            <span class="n">note_text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;note&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="kc">None</span>

            <span class="n">generator</span> <span class="o">=</span> <span class="n">CodeImageGenerator</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">,</span> <span class="n">theme</span><span class="o">=</span><span class="n">theme</span><span class="p">,</span> <span class="n">font_family</span><span class="o">=</span><span class="n">font_family</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">image_bytes</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">generate_image</span><span class="p">(</span>
                    <span class="n">code</span><span class="o">=</span><span class="n">code</span><span class="p">,</span>
                    <span class="n">language</span><span class="o">=</span><span class="n">language</span><span class="p">,</span>
                    <span class="n">filename</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span>
                    <span class="n">max_width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span>
                    <span class="n">note</span><span class="o">=</span><span class="n">note_text</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">generator</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>  <span class="c1"># type: ignore[attr-defined]</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="n">bio</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">image_bytes</span><span class="p">)</span>
            <span class="n">bio</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">.png&quot;</span>
            <span class="n">safe_name</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
            <span class="n">safe_lang</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">language</span><span class="p">)</span>
            <span class="n">note_caption</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">note_text</span><span class="p">:</span>
                <span class="n">note_caption</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ğŸ“Œ ×”×¢×¨×”: </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">note_text</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="c1"># ×›×¤×ª×•×¨×™× ××ª×§×“××™× â€“ ×•×“× ×¢××™×“×” ×‘××’×‘×œ×ª 64 ×‘×ª×™× ×©×œ ×˜×œ×’×¨×</span>
            <span class="n">regen_suffix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_safe_suffix</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;regenerate_image_&quot;</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
            <span class="n">edit_suffix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_safe_suffix</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;edit_image_settings_&quot;</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
            <span class="n">save_suffix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_safe_suffix</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;save_to_drive_&quot;</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
            <span class="n">kb</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">([</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”„ ×¦×•×¨ ××—×“×©&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;regenerate_image_</span><span class="si">{</span><span class="n">regen_suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                     <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ“ ×¢×¨×•×š ×”×’×“×¨×•×ª&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;edit_image_settings_</span><span class="si">{</span><span class="n">edit_suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)],</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ’¾ ×©××•×¨ ×‘-Drive&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;save_to_drive_</span><span class="si">{</span><span class="n">save_suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)]</span>
                <span class="p">])</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_photo</span><span class="p">(</span>
                <span class="n">photo</span><span class="o">=</span><span class="n">InputFile</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">),</span>
                <span class="n">caption</span><span class="o">=</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;ğŸ–¼ï¸ &lt;b&gt;×ª××•× ×ª ×§×•×“:&lt;/b&gt; &lt;code&gt;</span><span class="si">{</span><span class="n">safe_name</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;ğŸ”¤ ×©×¤×”: </span><span class="si">{</span><span class="n">safe_lang</span><span class="si">}</span><span class="s2"> | ğŸ¨ ×ª××”: </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">theme</span><span class="p">)</span><span class="si">}</span><span class="s2"> | ğŸ§© ×¡×’× ×•×Ÿ: </span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">style</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">note_caption</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">),</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××”: ×—×¡×¨×•×ª ×¡×¤×¨×™×•×ª × ×“×¨×©×•×ª.</span><span class="se">\n</span><span class="s2">&lt;code&gt;</span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error generating image: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª ×ª××•× ×”: &lt;code&gt;</span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_build_image_error_hint</span><span class="p">(</span><span class="n">requested_width</span><span class="p">,</span><span class="w"> </span><span class="n">code_length</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">,</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="AdvancedBotHandlers.preview_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.preview_command">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">preview_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×ª×¦×•×’×” ××§×“×™××” (×¢×“ 50 ×©×•×¨×•×ª, ×¨×•×—×‘ 800px).&quot;&quot;&quot;</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;ğŸ‘ï¸ &lt;b&gt;×ª×¦×•×’×” ××§×“×™××”&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;×©×™××•×©: &lt;code&gt;/preview &amp;lt;file_name&amp;gt;&lt;/code&gt;&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Rate limit ×¢×“×™×Ÿ ×’× ×›××Ÿ</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">allowed</span> <span class="o">=</span> <span class="k">await</span> <span class="n">image_rate_limiter</span><span class="o">.</span><span class="n">check_rate_limit</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">allowed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;â±ï¸ ×™×•×ª×¨ ××“×™ ×‘×§×©×•×ª. ×× × × ×¡×” ×©×•×‘ ×‘×¢×•×“ ×“×§×”.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">file_data</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_data</span><span class="p">:</span>
            <span class="n">safe</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×§×•×‘×¥ &lt;code&gt;</span><span class="si">{</span><span class="n">safe</span><span class="si">}</span><span class="s2">&lt;/code&gt; ×œ× × ××¦×.&quot;</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">code</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">language</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;programming_language&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;text&#39;</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="n">max_preview_lines</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(((</span><span class="n">IMAGE_CONFIG</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;preview&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_lines&#39;</span><span class="p">))</span> <span class="ow">or</span> <span class="mi">50</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_preview_lines</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">[:</span><span class="n">max_preview_lines</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">...&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># ×”×¢×“×¤×•×ª ××¤×§×˜×™×‘×™×•×ª: ×¤×¨-××©×ª××© (DB) + ×‘×¨×™×¨×ª ××—×“×œ ××§×•×‘×¥ ×§×•× ×¤×™×’</span>
            <span class="n">settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_effective_image_settings</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
            <span class="n">style</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;style&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">IMAGE_CONFIG</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;default_style&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;monokai&#39;</span><span class="p">)</span>
            <span class="n">theme</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;theme&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">IMAGE_CONFIG</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;default_theme&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;dark&#39;</span><span class="p">)</span>
            <span class="n">prev_w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">IMAGE_CONFIG</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;preview&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">800</span><span class="p">))</span>
            <span class="n">font_family</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;dejavu&#39;</span><span class="p">)</span>
            <span class="n">generator</span> <span class="o">=</span> <span class="n">CodeImageGenerator</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">,</span> <span class="n">theme</span><span class="o">=</span><span class="n">theme</span><span class="p">,</span> <span class="n">font_family</span><span class="o">=</span><span class="n">font_family</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">image_bytes</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">generate_image</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="n">code</span><span class="p">,</span> <span class="n">language</span><span class="o">=</span><span class="n">language</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span> <span class="n">max_width</span><span class="o">=</span><span class="n">prev_w</span><span class="p">,</span> <span class="n">max_height</span><span class="o">=</span><span class="mi">1500</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">generator</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>  <span class="c1"># type: ignore[attr-defined]</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="n">bio</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">image_bytes</span><span class="p">)</span>
            <span class="n">bio</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;preview_</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">.png&quot;</span>
            <span class="n">safe_name</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_photo</span><span class="p">(</span>
                <span class="n">photo</span><span class="o">=</span><span class="n">InputFile</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">bio</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
                <span class="n">caption</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;ğŸ‘ï¸ ×ª×¦×•×’×” ××§×“×™××”: &lt;code&gt;</span><span class="si">{</span><span class="n">safe_name</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Preview error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××”: &lt;code&gt;</span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdvancedBotHandlers.image_all_command">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.image_all_command">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">image_all_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×™×¦×™×¨×ª ×ª××•× ×•×ª ×œ×›×œ ×”×§×‘×¦×™× ×©×œ ×”××©×ª××© (×¢×“ 20).&quot;&quot;&quot;</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>

        <span class="c1"># ×‘×“×™×§×” ×¨×›×” ×©×œ Rate limit</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">allowed</span> <span class="o">=</span> <span class="k">await</span> <span class="n">image_rate_limiter</span><span class="o">.</span><span class="n">check_rate_limit</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">allowed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;â±ï¸ ×™×•×ª×¨ ××“×™ ×‘×§×©×•×ª. ×× × × ×¡×” ×©×•×‘ ×‘×¢×•×“ ×“×§×”.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># ×’×‘×•×œ×•×ª ×‘×˜×™×—×•×ª ××”×§×•× ×¤×™×’</span>
        <span class="n">_img_all_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="n">IMAGE_CONFIG</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;image_all&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="n">max_images</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">_img_all_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_images&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">20</span><span class="p">))</span>
        <span class="n">max_total_chars</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">_img_all_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_total_chars&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">300000</span><span class="p">))</span>
        <span class="n">max_lines_per_file</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">_img_all_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_lines&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">200</span><span class="p">))</span>

        <span class="n">files</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user_files</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">max_images</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×œ× × ××¦××• ×§×‘×¦×™×.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">status</span> <span class="o">=</span> <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ğŸ¨ ×™×•×¦×¨ </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span><span class="si">}</span><span class="s2"> ×ª××•× ×•×ª...</span><span class="se">\n</span><span class="s2">0/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span><span class="si">}</span><span class="s2"> ×”×•×©×œ××•&quot;</span><span class="p">)</span>

        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_try_edit_status</span><span class="p">(</span><span class="n">new_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">status</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="s2">&quot;edit_text&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">status</span><span class="o">.</span><span class="n">edit_text</span><span class="p">(</span><span class="n">new_text</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="n">done</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">remaining_char_budget</span> <span class="o">=</span> <span class="n">max_total_chars</span>
        <span class="n">generator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CodeImageGenerator</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fname</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="c1"># ×§×™×˜×•×¢ ×§×‘×¦×™× ××¨×•×›×™× ×œ×©××™×¨×” ×¢×œ ×–×™×›×¨×•×Ÿ</span>
                    <span class="n">code</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">code</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">lines</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_lines_per_file</span><span class="p">:</span>
                        <span class="n">code</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">[:</span><span class="n">max_lines_per_file</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">...&quot;</span>
                    <span class="n">remaining_char_budget</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">remaining_char_budget</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># ×—×¨×’× ×• ××ª×§×¦×™×‘ â€“ ×¢×¦×•×¨ ×‘×¨×›×•×ª</span>
                        <span class="k">break</span>
                    <span class="c1"># ×”×¢×“×¤×•×ª ×œ×›×œ ×§×•×‘×¥ ×œ×¤×™ ×”××©×ª××©</span>
                    <span class="n">settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_effective_image_settings</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
                    <span class="n">style</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;style&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">IMAGE_CONFIG</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;default_style&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;monokai&#39;</span><span class="p">)</span>
                    <span class="n">theme</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;theme&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">IMAGE_CONFIG</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;default_theme&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;dark&#39;</span><span class="p">)</span>
                    <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">IMAGE_CONFIG</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;default_width&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">1200</span><span class="p">)</span>
                    <span class="n">font_family</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;dejavu&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">generator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">generator</span> <span class="o">=</span> <span class="n">CodeImageGenerator</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">,</span> <span class="n">theme</span><span class="o">=</span><span class="n">theme</span><span class="p">,</span> <span class="n">font_family</span><span class="o">=</span><span class="n">font_family</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">configure</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">generator</span><span class="p">,</span> <span class="s2">&quot;configure&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">configure</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">configure</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">,</span> <span class="n">theme</span><span class="o">=</span><span class="n">theme</span><span class="p">,</span> <span class="n">font_family</span><span class="o">=</span><span class="n">font_family</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">cfg_err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to reconfigure CodeImageGenerator: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">cfg_err</span><span class="p">)</span>
                    <span class="n">img_bytes</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">generate_image</span><span class="p">(</span>
                        <span class="n">code</span><span class="o">=</span><span class="n">code</span><span class="p">,</span>
                        <span class="n">language</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;programming_language&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;text&#39;</span><span class="p">),</span>
                        <span class="n">filename</span><span class="o">=</span><span class="n">fname</span><span class="p">,</span>
                        <span class="n">max_width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">bio</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">img_bytes</span><span class="p">)</span>
                    <span class="n">bio</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">.png&quot;</span>
                    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_photo</span><span class="p">(</span><span class="n">photo</span><span class="o">=</span><span class="n">InputFile</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">bio</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">)</span>
                    <span class="n">done</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">done</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">_try_edit_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ğŸ¨ ×™×•×¦×¨ </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span><span class="si">}</span><span class="s2"> ×ª××•× ×•×ª...</span><span class="se">\n</span><span class="si">{</span><span class="n">done</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span><span class="si">}</span><span class="s2"> ×”×•×©×œ××•&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing </span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">generator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">generator</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>  <span class="c1"># type: ignore[attr-defined]</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;âœ… ×”×•×©×œ×! × ×•×¦×¨×• </span><span class="si">{</span><span class="n">done</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span><span class="si">}</span><span class="s2"> ×ª××•× ×•×ª.&quot;</span>
        <span class="k">if</span> <span class="n">remaining_char_budget</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">(×”×•×¤×¡×§ ××•×§×“× ×¢×§×‘ ×ª×•×›×Ÿ ××¨×•×š â€“ ×œ×©××™×¨×” ×¢×œ ×–×™×›×¨×•×Ÿ)&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="k">await</span> <span class="n">_try_edit_status</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span></div>
</div>


<span class="c1"># ×¤×§×•×“×•×ª × ×•×¡×¤×•×ª ×™×™×•×¦×¨×• ×‘×”××©×š...</span>


<div class="viewcode-block" id="check_db_connection">
<a class="viewcode-back" href="../api/bot_handlers.html#bot_handlers.check_db_connection">[×ª×™×¢×•×“]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">check_db_connection</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;×‘×“×™×§×ª ×—×™×‘×•×¨ ×××™×ª×™×ª ×œ-MongoDB ×‘×××¦×¢×•×ª ×¤×§×•×“×ª ping.</span>

<span class="sd">    ×œ×•×’×™×§×”:</span>
<span class="sd">    - ×˜×•×¢×Ÿ URI ××”-ENV (MONGODB_URL/REPORTER_MONGODB_URL/REPORTER_MONGODB_URI)</span>
<span class="sd">    - ×× ×¡×” ×ª×—×™×œ×” Motor (××¡×™× ×›×¨×•× ×™) ×¢× await</span>
<span class="sd">    - × ×¤×™×œ×” ×œ-PyMongo (×¡×™× ×›×¨×•× ×™) ×× Motor ×œ× ×–××™×Ÿ</span>
<span class="sd">    - ××—×–×™×¨ True ×¨×§ ×× ping ×”×¦×œ×™×— ×‘×¤×•×¢×œ</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">mongodb_uri</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;REPORTER_MONGODB_URL&#39;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;REPORTER_MONGODB_URI&#39;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;MONGODB_URL&#39;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mongodb_uri</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;MongoDB URI missing (MONGODB_URL not configured)&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Motor (×¢×“×™×£ ××¡×™× ×›×¨×•× ×™)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">motor.motor_asyncio</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_motor</span>  <span class="c1"># type: ignore</span>
            <span class="n">client</span> <span class="o">=</span> <span class="n">_motor</span><span class="o">.</span><span class="n">AsyncIOMotorClient</span><span class="p">(</span><span class="n">mongodb_uri</span><span class="p">,</span> <span class="n">serverSelectionTimeoutMS</span><span class="o">=</span><span class="mi">3000</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">admin</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;ping&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">motor_err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Motor ping failed; falling back to PyMongo: </span><span class="si">{</span><span class="n">motor_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># PyMongo (×¡×™× ×›×¨×•× ×™)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">pymongo</span><span class="w"> </span><span class="kn">import</span> <span class="n">MongoClient</span>  <span class="c1"># type: ignore</span>
            <span class="n">client2</span> <span class="o">=</span> <span class="n">MongoClient</span><span class="p">(</span><span class="n">mongodb_uri</span><span class="p">,</span> <span class="n">serverSelectionTimeoutMS</span><span class="o">=</span><span class="mi">3000</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">client2</span><span class="o">.</span><span class="n">admin</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;ping&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">client2</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">pym_err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PyMongo ping failed: </span><span class="si">{</span><span class="n">pym_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error during DB check: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Development Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>