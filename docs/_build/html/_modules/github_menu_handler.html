

<!DOCTYPE html>
<html class="writer-html5" lang="he" data-content_root="../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>github_menu_handler &mdash; ×ª×™×¢×•×“ Code Keeper Bot 1.0.0</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=97689da2" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=0062297a"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/vendor/turndown.umd.js?v=c7d37de5"></script>
      <script src="../_static/vendor/turndown-plugin-gfm.js?v=cc6884c9"></script>
      <script src="../_static/copy-page.js?v=8142343d"></script>
      <script src="../_static/translations.js?v=a336edf7"></script>
      <script type="module" src="https://cdn.jsdelivr.net/npm/mermaid@11.12.1/dist/mermaid.esm.min.mjs"></script>
      <script type="module" src="https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.2.0/dist/mermaid-layout-elk.esm.min.mjs"></script>
      <script type="module">import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.12.1/dist/mermaid.esm.min.mjs";import elkLayouts from "https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.2.0/dist/mermaid-layout-elk.esm.min.mjs";mermaid.registerLayoutLoaders(elkLayouts);mermaid.initialize({startOnLoad:false});</script>
      <script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>
      <script type="module">import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.12.1/dist/mermaid.esm.min.mjs";

const defaultStyle = document.createElement('style');
defaultStyle.textContent = `pre.mermaid {
    /* Same as .mermaid-container > pre */
    display: block;
    width: 100%;
}

pre.mermaid > svg {
    /* Same as .mermaid-container > pre > svg */
    height: 500px;
    width: 100%;
    max-width: 100% !important;
}
`;
document.head.appendChild(defaultStyle);

const fullscreenStyle = document.createElement('style');
fullscreenStyle.textContent = `.mermaid-container {
    display: flex;
    flex-direction: row;
    width: 100%;
}

.mermaid-container > pre {
    display: block;
    width: 100%;
}

.mermaid-container > pre > svg {
    height: 500px;
    width: 100%;
    max-width: 100% !important;
}

.mermaid-fullscreen-btn {
    width: 28px;
    height: 28px;
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(0, 0, 0, 0.3);
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    font-size: 14px;
    line-height: 1;
    padding: 0;
    color: #333;
}

.mermaid-fullscreen-btn:hover {
    opacity: 100% !important;
    background: rgba(255, 255, 255, 1);
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
    transform: scale(1.1);
}

.mermaid-fullscreen-btn.dark-theme {
    background: rgba(50, 50, 50, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: #e0e0e0;
}

.mermaid-fullscreen-btn.dark-theme:hover {
    background: rgba(60, 60, 60, 1);
    box-shadow: 0 3px 10px rgba(255, 255, 255, 0.2);
}

.mermaid-fullscreen-modal {
    display: none;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 95vw;
    height: 100vh;
    background: rgba(255, 255, 255, 0.98);
    z-index: 9999;
    padding: 20px;
    overflow: auto;
}

.mermaid-fullscreen-modal.dark-theme {
    background: rgba(0, 0, 0, 0.98);
}

.mermaid-fullscreen-modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
}

.mermaid-container-fullscreen {
    position: relative;
    width: 95vw;
    height: 90vh;
    max-width: 95vw;
    max-height: 90vh;
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    overflow: auto;
    display: flex;
    align-items: center;
    justify-content: center;
}

.mermaid-container-fullscreen.dark-theme {
    background: #1a1a1a;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
}

.mermaid-container-fullscreen pre.mermaid {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.mermaid-container-fullscreen .mermaid svg {
    height: 100% !important;
    width: 100% !important;
    cursor: grab;
}

.mermaid-fullscreen-close {
    position: fixed !important;
    top: 20px !important;
    right: 20px !important;
    width: 40px;
    height: 40px;
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(0, 0, 0, 0.2);
    border-radius: 50%;
    cursor: pointer;
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    transition: all 0.2s;
    font-size: 24px;
    line-height: 1;
    color: #333;
}

.mermaid-fullscreen-close:hover {
    background: white;
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
    transform: scale(1.1);
}

.mermaid-fullscreen-close.dark-theme {
    background: rgba(50, 50, 50, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: #e0e0e0;
}

.mermaid-fullscreen-close.dark-theme:hover {
    background: rgba(60, 60, 60, 1);
    box-shadow: 0 6px 16px rgba(255, 255, 255, 0.2);
}

.mermaid-fullscreen-modal .mermaid-fullscreen-btn {
    display: none !important;
}`;
document.head.appendChild(fullscreenStyle);

// Detect if page has dark background
const isDarkTheme = () => {
    const bgColor = window.getComputedStyle(document.body).backgroundColor;
    const match = bgColor.match(/rgb\((\d+),\s*(\d+),\s*(\d+)/);
    if (match) {
        const r = parseInt(match[1]);
        const g = parseInt(match[2]);
        const b = parseInt(match[3]);
        const brightness = (r * 299 + g * 587 + b * 114) / 1000;
        return brightness < 128;
    }
    return false;
};

const load = async () => {
    await mermaid.run();

    const all_mermaids = document.querySelectorAll(".mermaid");
    const mermaids_processed = document.querySelectorAll(".mermaid[data-processed='true']");

    if ("False" === "True") {
        const mermaids_to_add_zoom = -1 === -1 ? all_mermaids.length : -1;
        if(mermaids_to_add_zoom > 0) {
            var svgs = d3.selectAll("");
            if(all_mermaids.length !== mermaids_processed.length) {
                setTimeout(load, 200);
                return;
            } else if(svgs.size() !== mermaids_to_add_zoom) {
                setTimeout(load, 200);
                return;
            } else {
                svgs.each(function() {
                    var svg = d3.select(this);
                    svg.html("<g class='wrapper'>" + svg.html() + "</g>");
                    var inner = svg.select("g");
                    var zoom = d3.zoom().on("zoom", function(event) {
                        inner.attr("transform", event.transform);
                    });
                    svg.call(zoom);
                });
            }
        }
    } else if(all_mermaids.length !== mermaids_processed.length) {
        // Wait for mermaid to process all diagrams
        setTimeout(load, 200);
        return;
    }

    const darkTheme = isDarkTheme();

    // Stop here if not adding fullscreen capability
    if ("True" !== "True") return;

    const modal = document.createElement('div');
    modal.className = 'mermaid-fullscreen-modal' + (darkTheme ? ' dark-theme' : '');
    modal.setAttribute('role', 'dialog');
    modal.setAttribute('aria-modal', 'true');
    modal.setAttribute('aria-label', 'Fullscreen diagram viewer');
    modal.innerHTML = `
        <button class="mermaid-fullscreen-close${darkTheme ? ' dark-theme' : ''}" aria-label="Close fullscreen">âœ•</button>
        <div class="mermaid-container-fullscreen${darkTheme ? ' dark-theme' : ''}"></div>
    `;
    document.body.appendChild(modal);

    const modalContent = modal.querySelector('.mermaid-container-fullscreen');
    const closeBtn = modal.querySelector('.mermaid-fullscreen-close');

    let previousScrollOffset = [window.scrollX, window.scrollY];

    const closeModal = () => {
        modal.classList.remove('active');
        modalContent.innerHTML = '';
        document.body.style.overflow = ''
        window.scrollTo({left: previousScrollOffset[0], top: previousScrollOffset[1], behavior: 'instant'});
    };

    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('active')) {
            closeModal();
        }
    });

    const allButtons = [];

    document.querySelectorAll('.mermaid').forEach((mermaidDiv) => {
        if (mermaidDiv.parentNode.classList.contains('mermaid-container') ||
            mermaidDiv.closest('.mermaid-fullscreen-modal')) {
            return;
        }

        const container = document.createElement('div');
        container.className = 'mermaid-container';
        mermaidDiv.parentNode.insertBefore(container, mermaidDiv);
        container.appendChild(mermaidDiv);

        const fullscreenBtn = document.createElement('button');
        fullscreenBtn.className = 'mermaid-fullscreen-btn' + (darkTheme ? ' dark-theme' : '');
        fullscreenBtn.setAttribute('aria-label', 'View diagram in fullscreen');
        fullscreenBtn.textContent = 'â›¶';
        fullscreenBtn.style.opacity = '50%';

        // Calculate dynamic position based on diagram's margin and padding
        const diagramStyle = window.getComputedStyle(mermaidDiv);
        const marginTop = parseFloat(diagramStyle.marginTop) || 0;
        const marginRight = parseFloat(diagramStyle.marginRight) || 0;
        const paddingTop = parseFloat(diagramStyle.paddingTop) || 0;
        const paddingRight = parseFloat(diagramStyle.paddingRight) || 0;
        fullscreenBtn.style.top = `${marginTop + paddingTop + 4}px`;
        fullscreenBtn.style.right = `${marginRight + paddingRight + 4}px`;

        fullscreenBtn.addEventListener('click', () => {
            previousScrollOffset = [window.scroll, window.scrollY];
            const clone = mermaidDiv.cloneNode(true);
            modalContent.innerHTML = '';
            modalContent.appendChild(clone);

            const svg = clone.querySelector('svg');
            if (svg) {
                svg.removeAttribute('width');
                svg.removeAttribute('height');
                svg.style.width = '100%';
                svg.style.height = 'auto';
                svg.style.maxWidth = '100%';
                svg.style.sdisplay = 'block';

                if ("False" === "True") {
                    setTimeout(() => {
                        const g = svg.querySelector('g');
                        if (g) {
                            var svgD3 = d3.select(svg);
                            svgD3.html("<g class='wrapper'>" + svgD3.html() + "</g>");
                            var inner = svgD3.select("g");
                            var zoom = d3.zoom().on("zoom", function(event) {
                                inner.attr("transform", event.transform);
                            });
                            svgD3.call(zoom);
                        }
                    }, 100);
                }
            }

            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        });

        container.appendChild(fullscreenBtn);
        allButtons.push(fullscreenBtn);
    });

    // Update theme classes when theme changes
    const updateTheme = () => {
        const dark = isDarkTheme();
        allButtons.forEach(btn => {
            if (dark) {
                btn.classList.add('dark-theme');
            } else {
                btn.classList.remove('dark-theme');
            }
        });
        if (dark) {
            modal.classList.add('dark-theme');
            modalContent.classList.add('dark-theme');
            closeBtn.classList.add('dark-theme');
        } else {
            modal.classList.remove('dark-theme');
            modalContent.classList.remove('dark-theme');
            closeBtn.classList.remove('dark-theme');
        }
    };

    // Watch for theme changes
    const observer = new MutationObserver(updateTheme);
    observer.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ['class', 'style', 'data-theme']
    });
    observer.observe(document.body, {
        attributes: true,
        attributeFilter: ['class', 'style']
    });
};

window.addEventListener("load", load);
</script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="××™× ×“×§×¡" href="../genindex.html" />
    <link rel="search" title="×—×™×¤×•×©" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Code Keeper Bot
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">×œ××¤×ª×—×™× ×•×œ×¡×•×›× ×™ AI:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quickstart-ai.html">×”×ª×—×œ×” ××”×™×¨×” - ×¡×•×›× ×™ AI</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#id1">××˜×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#id2">××” ××¡×•×¨</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#id3">××” ××•×ª×¨ ×•××•××œ×¥</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#id4">×¤×•×¨××˜×™ ×¦×™×˜×•×˜ ×§×•×“</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#tmp">××—×™×§×” ×‘×˜×•×—×” (×¨×§ ×‘-/tmp)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#pr">×§×•××™×˜×™× ×•-PR</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#id5">×§×™×©×•×¨×™× ××”×™×¨×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#cheatsheet-github-cli-gh">Cheatsheet â€“ GitHub CLI (gh)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">×”×ª×—×œ×” ××”×™×¨×” - ××¤×ª×—×™×</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#id2">××˜×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#id3">×©×œ×‘ 1: ×”×ª×§× ×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#env">×©×œ×‘ 2: ×”×’×“×¨×ª .env</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#id4">×©×œ×‘ 3: ×”×¨×¦×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#id5">××” ×”×œ××”?</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart-contrib.html">Quickstart ×œ×ª×¨×•××”</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-contrib.html#id1">××˜×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-contrib.html#id2">×¦×¢×“×™ ×”×›× ×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-contrib.html#id3">×¡×‘×™×‘×ª ×¤×™×ª×•×—</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-contrib.html#id4">×”×¨×¦×ª ×˜×¡×˜×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-contrib.html#stubs">×¢×œ ×”â€‘Stubs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-contrib.html#id5">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ai-guidelines.html">×”× ×—×™×•×ª ××œ××•×ª ×œ×¡×•×›× ×™ AI</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../ai-guidelines.html#id1">××’×‘×œ×•×ª ×§×¨×™×˜×™×•×ª</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../ai-guidelines.html#id2">×”×¨×¦×ª ×¤×§×•×“×•×ª</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../ai-guidelines.html#id3">×›×œ×™ ×§×‘×¦×™× ×××•×©×¨×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ai-guidelines.html#id4">×¢×§×¨×•× ×•×ª ×¢×¨×™×›×ª ×§×•×“</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ai-guidelines.html#pull-requests">×§×•××™×˜×™× ×•-Pull Requests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ai-guidelines.html#id5">×¢×‘×•×“×” ×¢× ×˜×¡×˜×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ai-guidelines.html#id6">×§×™×©×•×¨×™× ××”×™×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../agents/rate-limiting.html">ğŸš¦ ××¢×¨×›×ª Rate Limiting ×œ×¡×•×›× ×™ AI ×•×œ×•×•×‘</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#shadow-mode">××¡×˜×¨×˜×’×™×” â€“ Shadow Mode ×ª×—×™×œ×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#id1">××©×ª× ×™ ×¡×‘×™×‘×” ×•×§×•× ×¤×™×’</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#id2">××™× ×˜×’×¨×¦×™×” â€“ ×‘×•×˜ ×˜×œ×’×¨×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#flask-webapp">××™× ×˜×’×¨×¦×™×” â€“ Flask/WebApp</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#id3">×”×—×¨×’×•×ª ×—×©×•×‘×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#prometheus">× ×™×˜×•×¨ ×•××“×“×™× (Prometheus)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#id4">××‘×˜×—×” ×•×”×’× ×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#pydantic-settings">×§×•× ×¤×™×’×•×¨×¦×™×” (Pydantic Settings)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#id5">×ª×§×œ×•×ª × ×¤×•×¦×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#id6">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../doc-authoring.html">Doc Authoring Guide (Sphinx/RTD)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../doc-authoring.html#id1">××˜×¨×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../doc-authoring.html#id2">××“×™× ×™×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../doc-authoring.html#id3">×˜×™×¤×™× ××”×™×¨×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../doc-authoring.html#id4">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../style-glossary.html">Style &amp; Naming Glossary</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../style-glossary.html#id1">××˜×¨×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../style-glossary.html#id2">××™×¤×•×™ ××•× ×—×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../style-glossary.html#id3">×›×œ×œ×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../style-glossary.html#id4">×¢×•×’× ×™ ×ª×™×¢×•×“</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../versioning-stable-anchors.html">Versioning &amp; Stable Anchors</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../versioning-stable-anchors.html#id1">××“×™× ×™×•×ª ×¢×•×’× ×™× ×™×¦×™×‘×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../versioning-stable-anchors.html#whats-new">Whatâ€™s New</a></li>
<li class="toctree-l2"><a class="reference internal" href="../versioning-stable-anchors.html#anchors">×“×•×’××ª Anchors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../versioning-stable-anchors.html#id2">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../whats-new.html">Whatâ€™s New</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../whats-new.html#id1">2025-12-11</a></li>
<li class="toctree-l2"><a class="reference internal" href="../whats-new.html#id2">2025-11-11</a></li>
<li class="toctree-l2"><a class="reference internal" href="../whats-new.html#id3">2025-11-06</a></li>
<li class="toctree-l2"><a class="reference internal" href="../whats-new.html#id4">2025-11-05</a></li>
<li class="toctree-l2"><a class="reference internal" href="../whats-new.html#id5">2025-10-30</a></li>
<li class="toctree-l2"><a class="reference internal" href="../whats-new.html#id6">2025-10-29</a></li>
<li class="toctree-l2"><a class="reference internal" href="../whats-new.html#id7">2025-10-15</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../architecture.html">××¨×›×™×˜×§×˜×•×¨×”</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#id2">×¡×§×™×¨×” ×›×œ×œ×™×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#id3">×ª×¨×©×™× ×¨×›×™×‘×™× (×ª××¦×™×ª×™)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#id4">××‘× ×” ×ª×™×§×™×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#id5">××§×•×¨×•×ª × ×•×¡×¤×™×</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../architecture/clean-architecture.html">Clean Architecture ×‘-src</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../architecture/clean-architecture.html#clean-architecture">×œ××” Clean Architecture</a></li>
<li class="toctree-l4"><a class="reference internal" href="../architecture/clean-architecture.html#id1">×ª×¨×©×™× ×©×›×‘×•×ª</a></li>
<li class="toctree-l4"><a class="reference internal" href="../architecture/clean-architecture.html#id2">××‘× ×” ×ª×™×§×™×•×ª</a></li>
<li class="toctree-l4"><a class="reference internal" href="../architecture/clean-architecture.html#domain">×©×›×‘×ª ×”×“×•××™×™×Ÿ (Domain)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../architecture/clean-architecture.html#application">×©×›×‘×ª ×”×™×™×©×•× (Application)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../architecture/clean-architecture.html#infrastructure">×©×›×‘×ª ×”×ª×©×ª×™×ª (Infrastructure)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../architecture/clean-architecture.html#id3">×“×•×’××ª ×–×¨×™××”: ×™×¦×™×¨×ª ×¡× ×™×¤×˜</a></li>
<li class="toctree-l4"><a class="reference internal" href="../architecture/clean-architecture.html#id4">×”× ×—×™×•×ª ×¢×‘×•×“×”</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#id6">×–×¨×™××•×ª ××¨×›×–×™×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#id7">×§×™×©×•×¨×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#http-aiohttp">×ª×©×ª×™×ª HTTP â€“ ×¡×©×Ÿ aiohttp ××©×•×ª×£</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#documenthandler">×”×¤×¨×“×ª ××—×¨×™×•×ª â€“ DocumentHandler</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">××“×¨×™×š ×ª×¨×•××”</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../contributing.html#id2">××˜×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributing.html#id3">×›×œ×œ×™× ×›×œ×œ×™×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributing.html#workflow">Workflow ×‘×¡×™×¡×™</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributing.html#pre-commit">Pre-commit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributing.html#conventional-commits">Conventional Commits</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributing.html#id4">×“×•×’×××•×ª ×©×™××•×©×™×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributing.html#id5">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../branch-protection-and-pr-rules.html">Branch Protection &amp; PR Rules</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../branch-protection-and-pr-rules.html#id1">××˜×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../branch-protection-and-pr-rules.html#id2">×›×œ×œ×™ ×¢× ×¤×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../branch-protection-and-pr-rules.html#pr">×—×•×§×™ PR</a></li>
<li class="toctree-l2"><a class="reference internal" href="../branch-protection-and-pr-rules.html#ci-required-checks">CI â€“ Required Checks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../branch-protection-and-pr-rules.html#id3">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">××“×¨×™×›×™× ×‘×¡×™×¡×™×™×:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">×”×ª×§× ×” ×•×”×’×“×¨×”</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#id2">×“×¨×™×©×•×ª ××¢×¨×›×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#id3">×”×ª×§× ×” ××”×™×¨×”</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#id4">1. ×©×›×¤×œ ××ª ×”×¨×™×¤×•×–×™×˜×•×¨×™</a></li>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#id5">2. ×”×ª×§×Ÿ ×ª×œ×•×™×•×ª</a></li>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#id6">3. ×”×’×“×¨ ××©×ª× ×™ ×¡×‘×™×‘×”</a></li>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#id7">4. ×”×¤×¢×œ ××ª ×”×‘×•×˜</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#docker">×”×ª×§× ×” ×¢× Docker</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#image">1. ×‘× ×” ××ª ×”-Image</a></li>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#docker-compose">2. ×”×¤×¢×œ ×¢× Docker Compose</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#mongodb">×”×’×“×¨×ª MongoDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#telegram-bot">×”×’×“×¨×ª Telegram Bot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#id8">×”×’×“×¨×•×ª ××ª×§×“××•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#id9">×‘×“×™×§×ª ×”×ª×§× ×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#id10">×¤×ª×¨×•×Ÿ ×‘×¢×™×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#id11">×ª××™×›×”</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../configuration.html">Rate Limiting</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#environment-variables">Environment variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#databases-and-cache-pooling-timeouts">Databases and Cache (Pooling/Timeouts)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#http-clients">HTTP Clients</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#http-async-async-http">×©×™××•×© ×‘â€‘http_async (Async HTTP)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#http-sync-sync-http">×©×™××•×© ×‘â€‘http_sync (Sync HTTP)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#flask">Flask</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#telegram-bot">Telegram Bot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#metrics">Metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#security">Security</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#id1">Databases and Cache (Pooling/Timeouts)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#id2">HTTP Clients</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#id3">×©×™××•×© ×‘-http_sync (Sync HTTP)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../configuration.html#config-via-pydantic-settings">Config via Pydantic Settings</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#id4">×”×™×¨×¨×›×™×™×ª ×˜×¢×™× ×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#id5">×•×œ×™×“×¦×™×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#env-example">.env.example</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#id6">×©×™××•×© ×œ×¡×•×›× ×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#id7">×¤×¨××˜×¨×™ ×§×•× ×¤×™×’×•×¨×¦×™×” ××¨×›×–×™×™× (×—×“×©×™×)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#id8">××™×—×•×“ ×ª×™×¢×•×“ ×§×•× ×¤×™×’×•×¨×¦×™×”</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../configuration.html#id9">×§×‘×¦×™ ×§×•× ×¤×™×’×•×¨×¦×™×” ×™×™×¢×•×“×™×™×</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#config-alert-graph-sources-json"><code class="docutils literal notranslate"><span class="pre">config/alert_graph_sources.json</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#config-observability-runbooks-yml"><code class="docutils literal notranslate"><span class="pre">config/observability_runbooks.yml</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#config-alert-quick-fixes-json"><code class="docutils literal notranslate"><span class="pre">config/alert_quick_fixes.json</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#config-alerts-yml"><code class="docutils literal notranslate"><span class="pre">config/alerts.yml</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#config-error-signatures-yml"><code class="docutils literal notranslate"><span class="pre">config/error_signatures.yml</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#config-image-settings-yaml"><code class="docutils literal notranslate"><span class="pre">config/image_settings.yaml</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../environment-variables.html">××©×ª× ×™ ×¡×‘×™×‘×” - ×¨×¤×¨× ×¡</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../environment-variables.html#id2">×˜×‘×œ×” ××¨×›×–×™×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../environment-variables.html#id3">×”×ª×¨××•×ª ×•× ×™×˜×•×¨ (×”×¨×—×‘×”)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../environment-variables.html#otel">××“×“×™×, OTEL ×•×—×™×–×•×™</a></li>
<li class="toctree-l2"><a class="reference internal" href="../environment-variables.html#id4">×ª×¤×¢×•×œ, ××™× ×˜×’×¨×¦×™×•×ª ×•×¤×™×¦â€™×¨×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../environment-variables.html#id5">×“×’×œ×™ ×‘×“×™×§×•×ª ×•×¤×™×ª×•×—</a></li>
<li class="toctree-l2"><a class="reference internal" href="../environment-variables.html#id6">×“×•×’×××•×ª ×§×•× ×¤×™×’×•×¨×¦×™×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../environment-variables.html#id7">×§×™×©×•×¨×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../environment-variables.html#scopes-github">×˜×‘×œ×ª Scopes ×œ×¤×™×¦â€™×¨×™× ×©×œ GitHub</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../performance-scaling.html">×‘×™×¦×•×¢×™× ×•×”×¨×—×‘×” (Performance &amp; Scaling)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../performance-scaling.html#pagination">×¢×™××•×“ (Pagination)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance-scaling.html#projection">Projection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance-scaling.html#id1">×“×’×©×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance-scaling.html#connection-pooling-timeouts">×›×•×•× ×•×Ÿ Connection Pooling ×•-Timeouts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance-scaling.html#id2">×œ×•×’×™ ××™×˜×™×•×ª (××”×™×¨ ×œ××™×ª×•×¨ ×¦×•×•××¨×™ ×‘×§×‘×•×§)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance-scaling.html#env">×‘×“×™×§×•×ª ××”×™×¨×•×ª ××—×¨×™ ×©×™× ×•×™ ENV</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance-scaling.html#id3">×”× ×—×™×•×ª ×œ×¤×™ ×¡×‘×™×‘×”</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../performance-sticky-notes.html">Sticky Notes Warmup â€“ ×¤×ª×¨×•×Ÿ ×‘×™×¦×•×¢×™× ××©×•×œ×‘</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../performance-sticky-notes.html#id1">×¨×§×¢ ×§×¦×¨</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance-sticky-notes.html#id2">×”×ª×¨×•×¤×” ×”××™×™×“×™×ª (××•×›×—×ª)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance-sticky-notes.html#warmup">Warmup ××‘× ×™ (×¢×“×™×™×Ÿ ×‘×ª×”×œ×™×š ××™××•×ª)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance-sticky-notes.html#id3">××™×¤×•×¡ ×”×“×’×œ ×‘×¢×ª ×©×™× ×•×™ ××™× ×“×§×¡×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance-sticky-notes.html#rollout">××” ×œ×××ª ×œ×¤× ×™ rollout ××œ×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance-sticky-notes.html#latency">××” ×œ×¢×©×•×ª ×× latency ×§×•×¤×¥ ×©×•×‘</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance-sticky-notes.html#id4">×”××œ×¦×” ×¨×©××™×ª</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../large-files-runbook.html">×˜×™×¤×•×œ ×‘×§×‘×¦×™× ×’×“×•×œ×™× (Large Files)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../large-files-runbook.html#id1">××’×‘×œ×•×ª ×•×¤×•×œ×‘×§×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../large-files-runbook.html#id2">×”× ×—×™×•×ª ×”×¤×¢×œ×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../large-files-runbook.html#id3">× ×™×˜×•×¨</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../api/main.html">main module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.get_drive_handler_from_application"><code class="docutils literal notranslate"><span class="pre">get_drive_handler_from_application()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.get_admin_ids"><code class="docutils literal notranslate"><span class="pre">get_admin_ids()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.notify_admins"><code class="docutils literal notranslate"><span class="pre">notify_admins()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.recycle_backfill_command"><code class="docutils literal notranslate"><span class="pre">recycle_backfill_command()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.log_user_activity"><code class="docutils literal notranslate"><span class="pre">log_user_activity()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.get_lock_collection"><code class="docutils literal notranslate"><span class="pre">get_lock_collection()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.ensure_lock_indexes"><code class="docutils literal notranslate"><span class="pre">ensure_lock_indexes()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.cleanup_mongo_lock"><code class="docutils literal notranslate"><span class="pre">cleanup_mongo_lock()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.manage_mongo_lock"><code class="docutils literal notranslate"><span class="pre">manage_mongo_lock()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.HelpEntry"><code class="docutils literal notranslate"><span class="pre">HelpEntry</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.HelpEntry.commands"><code class="docutils literal notranslate"><span class="pre">HelpEntry.commands</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.HelpEntry.description"><code class="docutils literal notranslate"><span class="pre">HelpEntry.description</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.HelpEntry.suffix"><code class="docutils literal notranslate"><span class="pre">HelpEntry.suffix</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.HelpSection"><code class="docutils literal notranslate"><span class="pre">HelpSection</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.HelpSection.title"><code class="docutils literal notranslate"><span class="pre">HelpSection.title</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.HelpSection.entries"><code class="docutils literal notranslate"><span class="pre">HelpSection.entries</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.application"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.application</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.github_handler"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.github_handler</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.backup_handler"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.backup_handler</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.__init__"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.setup_handlers"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.setup_handlers()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.help_command"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.help_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.save_command"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.save_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.list_command"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.list_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.search_command"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.search_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.check_commands"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.check_commands()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.stats_command"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.stats_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.handle_document"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.handle_document()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.handle_text_message"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.handle_text_message()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.error_handler"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.error_handler()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.start"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.start()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.stop"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.stop()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.signal_handler"><code class="docutils literal notranslate"><span class="pre">signal_handler()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.setup_handlers"><code class="docutils literal notranslate"><span class="pre">setup_handlers()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.main"><code class="docutils literal notranslate"><span class="pre">main()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.setup_bot_data"><code class="docutils literal notranslate"><span class="pre">setup_bot_data()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/config.html">config module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/config.html#config.BotConfig"><code class="docutils literal notranslate"><span class="pre">BotConfig</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.BOT_TOKEN"><code class="docutils literal notranslate"><span class="pre">BotConfig.BOT_TOKEN</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MONGODB_URL"><code class="docutils literal notranslate"><span class="pre">BotConfig.MONGODB_URL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.DATABASE_NAME"><code class="docutils literal notranslate"><span class="pre">BotConfig.DATABASE_NAME</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MONGODB_MAX_POOL_SIZE"><code class="docutils literal notranslate"><span class="pre">BotConfig.MONGODB_MAX_POOL_SIZE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MONGODB_MIN_POOL_SIZE"><code class="docutils literal notranslate"><span class="pre">BotConfig.MONGODB_MIN_POOL_SIZE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MONGODB_MAX_IDLE_TIME_MS"><code class="docutils literal notranslate"><span class="pre">BotConfig.MONGODB_MAX_IDLE_TIME_MS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MONGODB_WAIT_QUEUE_TIMEOUT_MS"><code class="docutils literal notranslate"><span class="pre">BotConfig.MONGODB_WAIT_QUEUE_TIMEOUT_MS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MONGODB_SERVER_SELECTION_TIMEOUT_MS"><code class="docutils literal notranslate"><span class="pre">BotConfig.MONGODB_SERVER_SELECTION_TIMEOUT_MS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MONGODB_SOCKET_TIMEOUT_MS"><code class="docutils literal notranslate"><span class="pre">BotConfig.MONGODB_SOCKET_TIMEOUT_MS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MONGODB_CONNECT_TIMEOUT_MS"><code class="docutils literal notranslate"><span class="pre">BotConfig.MONGODB_CONNECT_TIMEOUT_MS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MONGODB_RETRY_WRITES"><code class="docutils literal notranslate"><span class="pre">BotConfig.MONGODB_RETRY_WRITES</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MONGODB_RETRY_READS"><code class="docutils literal notranslate"><span class="pre">BotConfig.MONGODB_RETRY_READS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MONGODB_APPNAME"><code class="docutils literal notranslate"><span class="pre">BotConfig.MONGODB_APPNAME</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MONGODB_COMPRESSORS"><code class="docutils literal notranslate"><span class="pre">BotConfig.MONGODB_COMPRESSORS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MONGODB_HEARTBEAT_FREQUENCY_MS"><code class="docutils literal notranslate"><span class="pre">BotConfig.MONGODB_HEARTBEAT_FREQUENCY_MS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.REDIS_URL"><code class="docutils literal notranslate"><span class="pre">BotConfig.REDIS_URL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.CACHE_ENABLED"><code class="docutils literal notranslate"><span class="pre">BotConfig.CACHE_ENABLED</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.REDIS_MAX_CONNECTIONS"><code class="docutils literal notranslate"><span class="pre">BotConfig.REDIS_MAX_CONNECTIONS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.REDIS_CONNECT_TIMEOUT"><code class="docutils literal notranslate"><span class="pre">BotConfig.REDIS_CONNECT_TIMEOUT</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.REDIS_SOCKET_TIMEOUT"><code class="docutils literal notranslate"><span class="pre">BotConfig.REDIS_SOCKET_TIMEOUT</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.AIOHTTP_POOL_LIMIT"><code class="docutils literal notranslate"><span class="pre">BotConfig.AIOHTTP_POOL_LIMIT</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.AIOHTTP_TIMEOUT_TOTAL"><code class="docutils literal notranslate"><span class="pre">BotConfig.AIOHTTP_TIMEOUT_TOTAL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.AIOHTTP_LIMIT_PER_HOST"><code class="docutils literal notranslate"><span class="pre">BotConfig.AIOHTTP_LIMIT_PER_HOST</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.REQUESTS_POOL_CONNECTIONS"><code class="docutils literal notranslate"><span class="pre">BotConfig.REQUESTS_POOL_CONNECTIONS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.REQUESTS_POOL_MAXSIZE"><code class="docutils literal notranslate"><span class="pre">BotConfig.REQUESTS_POOL_MAXSIZE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.REQUESTS_TIMEOUT"><code class="docutils literal notranslate"><span class="pre">BotConfig.REQUESTS_TIMEOUT</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.REQUESTS_RETRIES"><code class="docutils literal notranslate"><span class="pre">BotConfig.REQUESTS_RETRIES</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.REQUESTS_RETRY_BACKOFF"><code class="docutils literal notranslate"><span class="pre">BotConfig.REQUESTS_RETRY_BACKOFF</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.RATE_LIMIT_ENABLED"><code class="docutils literal notranslate"><span class="pre">BotConfig.RATE_LIMIT_ENABLED</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.RATE_LIMIT_SHADOW_MODE"><code class="docutils literal notranslate"><span class="pre">BotConfig.RATE_LIMIT_SHADOW_MODE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.RATE_LIMIT_STRATEGY"><code class="docutils literal notranslate"><span class="pre">BotConfig.RATE_LIMIT_STRATEGY</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.ADMIN_USER_IDS"><code class="docutils literal notranslate"><span class="pre">BotConfig.ADMIN_USER_IDS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.GITHUB_TOKEN"><code class="docutils literal notranslate"><span class="pre">BotConfig.GITHUB_TOKEN</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.PASTEBIN_API_KEY"><code class="docutils literal notranslate"><span class="pre">BotConfig.PASTEBIN_API_KEY</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MAX_CODE_SIZE"><code class="docutils literal notranslate"><span class="pre">BotConfig.MAX_CODE_SIZE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MAX_FILES_PER_USER"><code class="docutils literal notranslate"><span class="pre">BotConfig.MAX_FILES_PER_USER</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.SUPPORTED_LANGUAGES"><code class="docutils literal notranslate"><span class="pre">BotConfig.SUPPORTED_LANGUAGES</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.RECYCLE_TTL_DAYS"><code class="docutils literal notranslate"><span class="pre">BotConfig.RECYCLE_TTL_DAYS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.PUBLIC_BASE_URL"><code class="docutils literal notranslate"><span class="pre">BotConfig.PUBLIC_BASE_URL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.WEBAPP_URL"><code class="docutils literal notranslate"><span class="pre">BotConfig.WEBAPP_URL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MAINTENANCE_MODE"><code class="docutils literal notranslate"><span class="pre">BotConfig.MAINTENANCE_MODE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MAINTENANCE_MESSAGE"><code class="docutils literal notranslate"><span class="pre">BotConfig.MAINTENANCE_MESSAGE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MAINTENANCE_AUTO_WARMUP_SECS"><code class="docutils literal notranslate"><span class="pre">BotConfig.MAINTENANCE_AUTO_WARMUP_SECS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MAINTENANCE_WARMUP_GRACE_SECS"><code class="docutils literal notranslate"><span class="pre">BotConfig.MAINTENANCE_WARMUP_GRACE_SECS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.RATE_LIMIT_PER_MINUTE"><code class="docutils literal notranslate"><span class="pre">BotConfig.RATE_LIMIT_PER_MINUTE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.HIGHLIGHT_THEME"><code class="docutils literal notranslate"><span class="pre">BotConfig.HIGHLIGHT_THEME</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.GIT_CHECKPOINT_PREFIX"><code class="docutils literal notranslate"><span class="pre">BotConfig.GIT_CHECKPOINT_PREFIX</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.GOOGLE_CLIENT_ID"><code class="docutils literal notranslate"><span class="pre">BotConfig.GOOGLE_CLIENT_ID</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.GOOGLE_CLIENT_SECRET"><code class="docutils literal notranslate"><span class="pre">BotConfig.GOOGLE_CLIENT_SECRET</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.GOOGLE_OAUTH_SCOPES"><code class="docutils literal notranslate"><span class="pre">BotConfig.GOOGLE_OAUTH_SCOPES</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.GOOGLE_TOKEN_REFRESH_MARGIN_SECS"><code class="docutils literal notranslate"><span class="pre">BotConfig.GOOGLE_TOKEN_REFRESH_MARGIN_SECS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.DRIVE_MENU_V2"><code class="docutils literal notranslate"><span class="pre">BotConfig.DRIVE_MENU_V2</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.DOCUMENTATION_URL"><code class="docutils literal notranslate"><span class="pre">BotConfig.DOCUMENTATION_URL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.BOT_LABEL"><code class="docutils literal notranslate"><span class="pre">BotConfig.BOT_LABEL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.DRIVE_ADD_HASH"><code class="docutils literal notranslate"><span class="pre">BotConfig.DRIVE_ADD_HASH</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.NORMALIZE_CODE_ON_SAVE"><code class="docutils literal notranslate"><span class="pre">BotConfig.NORMALIZE_CODE_ON_SAVE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.FEATURE_MY_COLLECTIONS"><code class="docutils literal notranslate"><span class="pre">BotConfig.FEATURE_MY_COLLECTIONS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.COMMUNITY_LIBRARY_ENABLED"><code class="docutils literal notranslate"><span class="pre">BotConfig.COMMUNITY_LIBRARY_ENABLED</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.SEARCH_PAGE_SIZE"><code class="docutils literal notranslate"><span class="pre">BotConfig.SEARCH_PAGE_SIZE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.UI_PAGE_SIZE"><code class="docutils literal notranslate"><span class="pre">BotConfig.UI_PAGE_SIZE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.SENTRY_DSN"><code class="docutils literal notranslate"><span class="pre">BotConfig.SENTRY_DSN</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.SENTRY_TEST_BUTTON_ENABLED"><code class="docutils literal notranslate"><span class="pre">BotConfig.SENTRY_TEST_BUTTON_ENABLED</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.ANOMALY_IGNORE_ENDPOINTS"><code class="docutils literal notranslate"><span class="pre">BotConfig.ANOMALY_IGNORE_ENDPOINTS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.METRICS_DB_ENABLED"><code class="docutils literal notranslate"><span class="pre">BotConfig.METRICS_DB_ENABLED</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.METRICS_COLLECTION"><code class="docutils literal notranslate"><span class="pre">BotConfig.METRICS_COLLECTION</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.METRICS_BATCH_SIZE"><code class="docutils literal notranslate"><span class="pre">BotConfig.METRICS_BATCH_SIZE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.METRICS_FLUSH_INTERVAL_SEC"><code class="docutils literal notranslate"><span class="pre">BotConfig.METRICS_FLUSH_INTERVAL_SEC</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.model_config"><code class="docutils literal notranslate"><span class="pre">BotConfig.model_config</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.settings_customise_sources"><code class="docutils literal notranslate"><span class="pre">BotConfig.settings_customise_sources()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/config.html#config.load_config"><code class="docutils literal notranslate"><span class="pre">load_config()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/bot_handlers.html">bot_handlers module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.set_activity_reporter"><code class="docutils literal notranslate"><span class="pre">set_activity_reporter()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.__init__"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.setup_advanced_handlers"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.setup_advanced_handlers()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.show_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.show_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.favorite_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.favorite_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.favorites_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.favorites_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.edit_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.edit_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.delete_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.delete_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.versions_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.versions_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.analyze_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.analyze_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.status_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.status_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.sentry_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.sentry_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.uptime_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.uptime_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.observe_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.observe_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.alerts_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.alerts_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.incidents_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.incidents_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.predict_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.predict_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.silence_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.silence_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.unsilence_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.unsilence_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.silences_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.silences_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.accuracy_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.accuracy_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.errors_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.errors_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.triage_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.triage_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.system_info_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.system_info_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.metrics_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.metrics_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.rate_limit_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.rate_limit_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.cache_clear_stale_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.cache_clear_stale_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.status_worker_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.status_worker_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.version_history_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.version_history_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.enable_backoff_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.enable_backoff_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.disable_backoff_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.disable_backoff_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.validate_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.validate_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.share_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.share_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.share_help_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.share_help_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.help_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.help_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.download_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.download_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.tags_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.tags_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.recent_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.recent_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.info_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.info_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.search_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.search_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.broadcast_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.broadcast_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.dm_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.dm_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.handle_callback_query"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.handle_callback_query()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.lang_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.lang_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.lang_debug_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.lang_debug_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.image_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.image_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.preview_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.preview_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.image_all_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.image_all_command()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.check_db_connection"><code class="docutils literal notranslate"><span class="pre">check_db_connection()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/conversation_handlers.html">conversation_handlers module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.DatabaseManager"><code class="docutils literal notranslate"><span class="pre">DatabaseManager</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.set_activity_reporter"><code class="docutils literal notranslate"><span class="pre">set_activity_reporter()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.start_command"><code class="docutils literal notranslate"><span class="pre">start_command()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_community_hub"><code class="docutils literal notranslate"><span class="pre">show_community_hub()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_catalog_menu"><code class="docutils literal notranslate"><span class="pre">community_catalog_menu()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippets_menu"><code class="docutils literal notranslate"><span class="pre">snippets_menu()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_hub_callback"><code class="docutils literal notranslate"><span class="pre">community_hub_callback()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.main_menu_callback"><code class="docutils literal notranslate"><span class="pre">main_menu_callback()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.submit_flows_cancel"><code class="docutils literal notranslate"><span class="pre">submit_flows_cancel()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_help_page"><code class="docutils literal notranslate"><span class="pre">show_help_page()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.setup_favorites_category_handlers"><code class="docutils literal notranslate"><span class="pre">setup_favorites_category_handlers()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.start_repo_zip_import"><code class="docutils literal notranslate"><span class="pre">start_repo_zip_import()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.start_zip_create_flow"><code class="docutils literal notranslate"><span class="pre">start_zip_create_flow()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_by_repo_menu"><code class="docutils literal notranslate"><span class="pre">show_by_repo_menu()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_by_repo_menu_callback"><code class="docutils literal notranslate"><span class="pre">show_by_repo_menu_callback()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_all_files"><code class="docutils literal notranslate"><span class="pre">show_all_files()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_large_files_direct"><code class="docutils literal notranslate"><span class="pre">show_large_files_direct()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_github_menu"><code class="docutils literal notranslate"><span class="pre">show_github_menu()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_all_files_callback"><code class="docutils literal notranslate"><span class="pre">show_all_files_callback()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_submit_start"><code class="docutils literal notranslate"><span class="pre">community_submit_start()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_collect_title"><code class="docutils literal notranslate"><span class="pre">community_collect_title()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_collect_description"><code class="docutils literal notranslate"><span class="pre">community_collect_description()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_collect_url"><code class="docutils literal notranslate"><span class="pre">community_collect_url()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_collect_logo"><code class="docutils literal notranslate"><span class="pre">community_collect_logo()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_inline_approve"><code class="docutils literal notranslate"><span class="pre">community_inline_approve()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_reject_start"><code class="docutils literal notranslate"><span class="pre">community_reject_start()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_collect_reject_reason"><code class="docutils literal notranslate"><span class="pre">community_collect_reject_reason()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_queue_command"><code class="docutils literal notranslate"><span class="pre">community_queue_command()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_approve_command"><code class="docutils literal notranslate"><span class="pre">community_approve_command()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_reject_command"><code class="docutils literal notranslate"><span class="pre">community_reject_command()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_submit_start"><code class="docutils literal notranslate"><span class="pre">snippet_submit_start()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_collect_title"><code class="docutils literal notranslate"><span class="pre">snippet_collect_title()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_collect_description"><code class="docutils literal notranslate"><span class="pre">snippet_collect_description()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_mode_regular_start"><code class="docutils literal notranslate"><span class="pre">snippet_mode_regular_start()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_mode_long_start"><code class="docutils literal notranslate"><span class="pre">snippet_mode_long_start()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_long_collect_receive"><code class="docutils literal notranslate"><span class="pre">snippet_long_collect_receive()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_long_collect_done"><code class="docutils literal notranslate"><span class="pre">snippet_long_collect_done()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_collect_code"><code class="docutils literal notranslate"><span class="pre">snippet_collect_code()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_collect_language"><code class="docutils literal notranslate"><span class="pre">snippet_collect_language()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_inline_approve"><code class="docutils literal notranslate"><span class="pre">snippet_inline_approve()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_reject_start"><code class="docutils literal notranslate"><span class="pre">snippet_reject_start()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_collect_reject_reason"><code class="docutils literal notranslate"><span class="pre">snippet_collect_reject_reason()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_queue_command"><code class="docutils literal notranslate"><span class="pre">snippet_queue_command()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_approve_command"><code class="docutils literal notranslate"><span class="pre">snippet_approve_command()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_reject_command"><code class="docutils literal notranslate"><span class="pre">snippet_reject_command()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_regular_files_callback"><code class="docutils literal notranslate"><span class="pre">show_regular_files_callback()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_favorites_callback"><code class="docutils literal notranslate"><span class="pre">show_favorites_callback()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_favorites_page_callback"><code class="docutils literal notranslate"><span class="pre">show_favorites_page_callback()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_regular_files_page_callback"><code class="docutils literal notranslate"><span class="pre">show_regular_files_page_callback()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_recycle_bin"><code class="docutils literal notranslate"><span class="pre">show_recycle_bin()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.recycle_restore"><code class="docutils literal notranslate"><span class="pre">recycle_restore()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.recycle_purge"><code class="docutils literal notranslate"><span class="pre">recycle_purge()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.share_single_by_id"><code class="docutils literal notranslate"><span class="pre">share_single_by_id()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_duplicate_callback"><code class="docutils literal notranslate"><span class="pre">handle_duplicate_callback()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_file_menu"><code class="docutils literal notranslate"><span class="pre">handle_file_menu()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_view_file"><code class="docutils literal notranslate"><span class="pre">handle_view_file()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_edit_code"><code class="docutils literal notranslate"><span class="pre">handle_edit_code()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.receive_new_code"><code class="docutils literal notranslate"><span class="pre">receive_new_code()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_edit_name"><code class="docutils literal notranslate"><span class="pre">handle_edit_name()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_edit_note"><code class="docutils literal notranslate"><span class="pre">handle_edit_note()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.receive_new_name"><code class="docutils literal notranslate"><span class="pre">receive_new_name()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_versions_history"><code class="docutils literal notranslate"><span class="pre">handle_versions_history()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_download_file"><code class="docutils literal notranslate"><span class="pre">handle_download_file()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_delete_confirmation"><code class="docutils literal notranslate"><span class="pre">handle_delete_confirmation()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_delete_file"><code class="docutils literal notranslate"><span class="pre">handle_delete_file()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_file_info"><code class="docutils literal notranslate"><span class="pre">handle_file_info()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_callback_query"><code class="docutils literal notranslate"><span class="pre">handle_callback_query()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.cancel"><code class="docutils literal notranslate"><span class="pre">cancel()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.get_save_conversation_handler"><code class="docutils literal notranslate"><span class="pre">get_save_conversation_handler()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_view_version"><code class="docutils literal notranslate"><span class="pre">handle_view_version()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_revert_version"><code class="docutils literal notranslate"><span class="pre">handle_revert_version()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_preview_button"><code class="docutils literal notranslate"><span class="pre">handle_preview_button()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_autocomplete_button"><code class="docutils literal notranslate"><span class="pre">handle_autocomplete_button()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_batch_button"><code class="docutils literal notranslate"><span class="pre">handle_batch_button()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_batch_menu"><code class="docutils literal notranslate"><span class="pre">show_batch_menu()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_batch_repos_menu"><code class="docutils literal notranslate"><span class="pre">show_batch_repos_menu()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_batch_files_menu"><code class="docutils literal notranslate"><span class="pre">show_batch_files_menu()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_batch_zips_menu"><code class="docutils literal notranslate"><span class="pre">show_batch_zips_menu()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_batch_actions_menu"><code class="docutils literal notranslate"><span class="pre">show_batch_actions_menu()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.execute_batch_on_current_selection"><code class="docutils literal notranslate"><span class="pre">execute_batch_on_current_selection()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/database.html">database package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/database.html#database.init_database"><code class="docutils literal notranslate"><span class="pre">init_database()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/database.html#submodules">Submodules</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/database.bookmark.html">database.bookmark module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/database.bookmarks_manager.html">database.bookmarks_manager module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/database.collections_manager.html">database.collections_manager module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/database.manager.html">database.manager module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/database.models.html">database.models module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/database.repository.html">database.repository module</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/services.html">services package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/services.html#submodules">Submodules</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/services.backoff_state.html">services.backoff_state module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/services.backup_service.html">services.backup_service module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/services.code_service.html">services.code_service module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/services.github_service.html">services.github_service module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/services.google_drive_service.html">services.google_drive_service module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/services.investigation_service.html">services.investigation_service module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/services.webserver.html">services.webserver module</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/handlers.html">handlers package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/handlers.html#subpackages">Subpackages</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.github.html">handlers.github package</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/handlers.html#submodules">Submodules</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.documents.html">handlers.documents module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.file_view.html">handlers.file_view module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.pagination.html">handlers.pagination module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.save_flow.html">handlers.save_flow module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.states.html">handlers.states module</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/utils.html">utils module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.CodeErrorLogger"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CodeErrorLogger.__init__"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CodeErrorLogger.log_code_processing_error"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger.log_code_processing_error()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CodeErrorLogger.log_code_activity"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger.log_code_activity()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CodeErrorLogger.log_validation_failure"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger.log_validation_failure()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CodeErrorLogger.log_sanitization_success"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger.log_sanitization_success()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.TimeUtils"><code class="docutils literal notranslate"><span class="pre">TimeUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TimeUtils.format_relative_time"><code class="docutils literal notranslate"><span class="pre">TimeUtils.format_relative_time()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TimeUtils.parse_date_string"><code class="docutils literal notranslate"><span class="pre">TimeUtils.parse_date_string()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TimeUtils.get_time_ranges"><code class="docutils literal notranslate"><span class="pre">TimeUtils.get_time_ranges()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.TextUtils"><code class="docutils literal notranslate"><span class="pre">TextUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils.truncate_text"><code class="docutils literal notranslate"><span class="pre">TextUtils.truncate_text()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils.escape_markdown"><code class="docutils literal notranslate"><span class="pre">TextUtils.escape_markdown()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils.clean_filename"><code class="docutils literal notranslate"><span class="pre">TextUtils.clean_filename()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils.extract_hashtags"><code class="docutils literal notranslate"><span class="pre">TextUtils.extract_hashtags()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils.highlight_text"><code class="docutils literal notranslate"><span class="pre">TextUtils.highlight_text()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils.format_file_size"><code class="docutils literal notranslate"><span class="pre">TextUtils.format_file_size()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils.pluralize_hebrew"><code class="docutils literal notranslate"><span class="pre">TextUtils.pluralize_hebrew()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.SecurityUtils"><code class="docutils literal notranslate"><span class="pre">SecurityUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.SecurityUtils.generate_secure_token"><code class="docutils literal notranslate"><span class="pre">SecurityUtils.generate_secure_token()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.SecurityUtils.hash_content"><code class="docutils literal notranslate"><span class="pre">SecurityUtils.hash_content()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.SecurityUtils.validate_user_input"><code class="docutils literal notranslate"><span class="pre">SecurityUtils.validate_user_input()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.SecurityUtils.sanitize_code"><code class="docutils literal notranslate"><span class="pre">SecurityUtils.sanitize_code()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils"><code class="docutils literal notranslate"><span class="pre">TelegramUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.send_typing_action"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.send_typing_action()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.send_document_action"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.send_document_action()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.safe_answer"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.safe_answer()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.get_user_mention"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.get_user_mention()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.split_long_message"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.split_long_message()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.safe_edit_message_text"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.safe_edit_message_text()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.safe_edit_message_reply_markup"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.safe_edit_message_reply_markup()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.extract_message_text_preserve_markdown"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.extract_message_text_preserve_markdown()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.CallbackQueryGuard"><code class="docutils literal notranslate"><span class="pre">CallbackQueryGuard</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CallbackQueryGuard.DEFAULT_WINDOW_SECONDS"><code class="docutils literal notranslate"><span class="pre">CallbackQueryGuard.DEFAULT_WINDOW_SECONDS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CallbackQueryGuard.should_block"><code class="docutils literal notranslate"><span class="pre">CallbackQueryGuard.should_block()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CallbackQueryGuard.should_block_async"><code class="docutils literal notranslate"><span class="pre">CallbackQueryGuard.should_block_async()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.AsyncUtils"><code class="docutils literal notranslate"><span class="pre">AsyncUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.AsyncUtils.run_with_timeout"><code class="docutils literal notranslate"><span class="pre">AsyncUtils.run_with_timeout()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.AsyncUtils.batch_process"><code class="docutils literal notranslate"><span class="pre">AsyncUtils.batch_process()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.PerformanceUtils"><code class="docutils literal notranslate"><span class="pre">PerformanceUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.PerformanceUtils.timing_decorator"><code class="docutils literal notranslate"><span class="pre">PerformanceUtils.timing_decorator()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.PerformanceUtils.measure_time"><code class="docutils literal notranslate"><span class="pre">PerformanceUtils.measure_time()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.ValidationUtils"><code class="docutils literal notranslate"><span class="pre">ValidationUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.ValidationUtils.is_valid_filename"><code class="docutils literal notranslate"><span class="pre">ValidationUtils.is_valid_filename()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.ValidationUtils.is_safe_code"><code class="docutils literal notranslate"><span class="pre">ValidationUtils.is_safe_code()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.FileUtils"><code class="docutils literal notranslate"><span class="pre">FileUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.FileUtils.download_file"><code class="docutils literal notranslate"><span class="pre">FileUtils.download_file()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.FileUtils.get_file_extension"><code class="docutils literal notranslate"><span class="pre">FileUtils.get_file_extension()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.FileUtils.get_mime_type"><code class="docutils literal notranslate"><span class="pre">FileUtils.get_mime_type()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.FileUtils.create_temp_file"><code class="docutils literal notranslate"><span class="pre">FileUtils.create_temp_file()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.ConfigUtils"><code class="docutils literal notranslate"><span class="pre">ConfigUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.ConfigUtils.load_json_config"><code class="docutils literal notranslate"><span class="pre">ConfigUtils.load_json_config()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.ConfigUtils.save_json_config"><code class="docutils literal notranslate"><span class="pre">ConfigUtils.save_json_config()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.CacheUtils"><code class="docutils literal notranslate"><span class="pre">CacheUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CacheUtils.set"><code class="docutils literal notranslate"><span class="pre">CacheUtils.set()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CacheUtils.get"><code class="docutils literal notranslate"><span class="pre">CacheUtils.get()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CacheUtils.delete"><code class="docutils literal notranslate"><span class="pre">CacheUtils.delete()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CacheUtils.clear"><code class="docutils literal notranslate"><span class="pre">CacheUtils.clear()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.get_memory_usage"><code class="docutils literal notranslate"><span class="pre">get_memory_usage()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.setup_logging"><code class="docutils literal notranslate"><span class="pre">setup_logging()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.generate_summary_stats"><code class="docutils literal notranslate"><span class="pre">generate_summary_stats()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.detect_language_from_filename"><code class="docutils literal notranslate"><span class="pre">detect_language_from_filename()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.get_language_emoji"><code class="docutils literal notranslate"><span class="pre">get_language_emoji()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.SensitiveDataFilter"><code class="docutils literal notranslate"><span class="pre">SensitiveDataFilter</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.SensitiveDataFilter.filter"><code class="docutils literal notranslate"><span class="pre">SensitiveDataFilter.filter()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.install_sensitive_filter"><code class="docutils literal notranslate"><span class="pre">install_sensitive_filter()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.normalize_code"><code class="docutils literal notranslate"><span class="pre">normalize_code()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/modules.html">workspace</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/activity_reporter.html">activity_reporter module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/activity_reporter.html#activity_reporter.get_mongo_client"><code class="docutils literal notranslate"><span class="pre">get_mongo_client()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/activity_reporter.html#activity_reporter.close_mongo_client"><code class="docutils literal notranslate"><span class="pre">close_mongo_client()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/activity_reporter.html#activity_reporter.SimpleActivityReporter"><code class="docutils literal notranslate"><span class="pre">SimpleActivityReporter</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/activity_reporter.html#activity_reporter.create_reporter"><code class="docutils literal notranslate"><span class="pre">create_reporter()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/alert_forwarder.html">alert_forwarder module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/alert_forwarder.html#alert_forwarder.forward_alerts"><code class="docutils literal notranslate"><span class="pre">forward_alerts()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/alert_manager.html">alert_manager module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/alert_manager.html#alert_manager.reset_state_for_tests"><code class="docutils literal notranslate"><span class="pre">reset_state_for_tests()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/alert_manager.html#alert_manager.note_request"><code class="docutils literal notranslate"><span class="pre">note_request()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/alert_manager.html#alert_manager.get_current_error_rate_percent"><code class="docutils literal notranslate"><span class="pre">get_current_error_rate_percent()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/alert_manager.html#alert_manager.get_current_avg_latency_seconds"><code class="docutils literal notranslate"><span class="pre">get_current_avg_latency_seconds()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/alert_manager.html#alert_manager.get_request_stats_between"><code class="docutils literal notranslate"><span class="pre">get_request_stats_between()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/alert_manager.html#alert_manager.bump_threshold"><code class="docutils literal notranslate"><span class="pre">bump_threshold()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/alert_manager.html#alert_manager.get_thresholds_snapshot"><code class="docutils literal notranslate"><span class="pre">get_thresholds_snapshot()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/alert_manager.html#alert_manager.check_and_emit_alerts"><code class="docutils literal notranslate"><span class="pre">check_and_emit_alerts()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/alert_manager.html#alert_manager.forward_critical_alert"><code class="docutils literal notranslate"><span class="pre">forward_critical_alert()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/alert_manager.html#alert_manager.get_dispatch_log"><code class="docutils literal notranslate"><span class="pre">get_dispatch_log()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/autocomplete_manager.html">autocomplete_manager module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/autocomplete_manager.html#autocomplete_manager.AutocompleteManager"><code class="docutils literal notranslate"><span class="pre">AutocompleteManager</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/backup_menu_handler.html">backup_menu_handler module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/backup_menu_handler.html#backup_menu_handler.BackupMenuHandler"><code class="docutils literal notranslate"><span class="pre">BackupMenuHandler</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/batch_commands.html">batch_commands module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_commands.html#batch_commands.batch_analyze_command"><code class="docutils literal notranslate"><span class="pre">batch_analyze_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_commands.html#batch_commands.batch_validate_command"><code class="docutils literal notranslate"><span class="pre">batch_validate_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_commands.html#batch_commands.job_status_command"><code class="docutils literal notranslate"><span class="pre">job_status_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_commands.html#batch_commands.large_file_command"><code class="docutils literal notranslate"><span class="pre">large_file_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_commands.html#batch_commands.handle_batch_callbacks"><code class="docutils literal notranslate"><span class="pre">handle_batch_callbacks()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_commands.html#batch_commands.setup_batch_handlers"><code class="docutils literal notranslate"><span class="pre">setup_batch_handlers()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/batch_processor.html">batch_processor module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_processor.html#batch_processor.BatchJob"><code class="docutils literal notranslate"><span class="pre">BatchJob</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_processor.html#batch_processor.BatchProcessor"><code class="docutils literal notranslate"><span class="pre">BatchProcessor</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/bot_handlers.html">bot_handlers module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.set_activity_reporter"><code class="docutils literal notranslate"><span class="pre">set_activity_reporter()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.check_db_connection"><code class="docutils literal notranslate"><span class="pre">check_db_connection()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/bot_rate_limiter.html">bot_rate_limiter module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_rate_limiter.html#bot_rate_limiter.RateLimitExceeded"><code class="docutils literal notranslate"><span class="pre">RateLimitExceeded</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_rate_limiter.html#bot_rate_limiter.check_rate_limit"><code class="docutils literal notranslate"><span class="pre">check_rate_limit()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_rate_limiter.html#bot_rate_limiter.rate_limit"><code class="docutils literal notranslate"><span class="pre">rate_limit()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/cache_commands.html">cache_commands module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_commands.html#cache_commands.cache_stats_command"><code class="docutils literal notranslate"><span class="pre">cache_stats_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_commands.html#cache_commands.clear_cache_command"><code class="docutils literal notranslate"><span class="pre">clear_cache_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_commands.html#cache_commands.setup_cache_handlers"><code class="docutils literal notranslate"><span class="pre">setup_cache_handlers()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_commands.html#cache_commands.cache_warm_command"><code class="docutils literal notranslate"><span class="pre">cache_warm_command()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/cache_manager.html">cache_manager module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_manager.html#cache_manager.DynamicTTL"><code class="docutils literal notranslate"><span class="pre">DynamicTTL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_manager.html#cache_manager.ActivityBasedTTL"><code class="docutils literal notranslate"><span class="pre">ActivityBasedTTL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_manager.html#cache_manager.build_cache_key"><code class="docutils literal notranslate"><span class="pre">build_cache_key()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_manager.html#cache_manager.CacheManager"><code class="docutils literal notranslate"><span class="pre">CacheManager</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_manager.html#cache_manager.dynamic_cache"><code class="docutils literal notranslate"><span class="pre">dynamic_cache()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_manager.html#cache_manager.cached"><code class="docutils literal notranslate"><span class="pre">cached()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_manager.html#cache_manager.async_cached"><code class="docutils literal notranslate"><span class="pre">async_cached()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/chatops.html">chatops package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/chatops.html#submodules">Submodules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/code_preview.html">code_preview module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/code_preview.html#code_preview.CodePreviewManager"><code class="docutils literal notranslate"><span class="pre">CodePreviewManager</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/code_processor.html">code_processor module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/config.html">config module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig"><code class="docutils literal notranslate"><span class="pre">BotConfig</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.load_config"><code class="docutils literal notranslate"><span class="pre">load_config()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/conftest.html">conftest module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/conftest.html#conftest.pytest_addoption"><code class="docutils literal notranslate"><span class="pre">pytest_addoption()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conftest.html#conftest.pytest_ignore_collect"><code class="docutils literal notranslate"><span class="pre">pytest_ignore_collect()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conftest.html#conftest.pytest_configure"><code class="docutils literal notranslate"><span class="pre">pytest_configure()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conftest.html#conftest.pytest_collection_modifyitems"><code class="docutils literal notranslate"><span class="pre">pytest_collection_modifyitems()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conftest.html#conftest.pytest_runtest_makereport"><code class="docutils literal notranslate"><span class="pre">pytest_runtest_makereport()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conftest.html#conftest.pytest_sessionfinish"><code class="docutils literal notranslate"><span class="pre">pytest_sessionfinish()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html">conversation_handlers module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.DatabaseManager"><code class="docutils literal notranslate"><span class="pre">DatabaseManager</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.set_activity_reporter"><code class="docutils literal notranslate"><span class="pre">set_activity_reporter()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.start_command"><code class="docutils literal notranslate"><span class="pre">start_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_community_hub"><code class="docutils literal notranslate"><span class="pre">show_community_hub()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_catalog_menu"><code class="docutils literal notranslate"><span class="pre">community_catalog_menu()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippets_menu"><code class="docutils literal notranslate"><span class="pre">snippets_menu()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_hub_callback"><code class="docutils literal notranslate"><span class="pre">community_hub_callback()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.main_menu_callback"><code class="docutils literal notranslate"><span class="pre">main_menu_callback()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.submit_flows_cancel"><code class="docutils literal notranslate"><span class="pre">submit_flows_cancel()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_help_page"><code class="docutils literal notranslate"><span class="pre">show_help_page()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.setup_favorites_category_handlers"><code class="docutils literal notranslate"><span class="pre">setup_favorites_category_handlers()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.start_repo_zip_import"><code class="docutils literal notranslate"><span class="pre">start_repo_zip_import()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.start_zip_create_flow"><code class="docutils literal notranslate"><span class="pre">start_zip_create_flow()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_by_repo_menu"><code class="docutils literal notranslate"><span class="pre">show_by_repo_menu()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_by_repo_menu_callback"><code class="docutils literal notranslate"><span class="pre">show_by_repo_menu_callback()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_all_files"><code class="docutils literal notranslate"><span class="pre">show_all_files()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_large_files_direct"><code class="docutils literal notranslate"><span class="pre">show_large_files_direct()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_github_menu"><code class="docutils literal notranslate"><span class="pre">show_github_menu()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_all_files_callback"><code class="docutils literal notranslate"><span class="pre">show_all_files_callback()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_submit_start"><code class="docutils literal notranslate"><span class="pre">community_submit_start()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_collect_title"><code class="docutils literal notranslate"><span class="pre">community_collect_title()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_collect_description"><code class="docutils literal notranslate"><span class="pre">community_collect_description()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_collect_url"><code class="docutils literal notranslate"><span class="pre">community_collect_url()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_collect_logo"><code class="docutils literal notranslate"><span class="pre">community_collect_logo()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_inline_approve"><code class="docutils literal notranslate"><span class="pre">community_inline_approve()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_reject_start"><code class="docutils literal notranslate"><span class="pre">community_reject_start()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_collect_reject_reason"><code class="docutils literal notranslate"><span class="pre">community_collect_reject_reason()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_queue_command"><code class="docutils literal notranslate"><span class="pre">community_queue_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_approve_command"><code class="docutils literal notranslate"><span class="pre">community_approve_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_reject_command"><code class="docutils literal notranslate"><span class="pre">community_reject_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_submit_start"><code class="docutils literal notranslate"><span class="pre">snippet_submit_start()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_collect_title"><code class="docutils literal notranslate"><span class="pre">snippet_collect_title()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_collect_description"><code class="docutils literal notranslate"><span class="pre">snippet_collect_description()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_mode_regular_start"><code class="docutils literal notranslate"><span class="pre">snippet_mode_regular_start()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_mode_long_start"><code class="docutils literal notranslate"><span class="pre">snippet_mode_long_start()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_long_collect_receive"><code class="docutils literal notranslate"><span class="pre">snippet_long_collect_receive()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_long_collect_done"><code class="docutils literal notranslate"><span class="pre">snippet_long_collect_done()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_collect_code"><code class="docutils literal notranslate"><span class="pre">snippet_collect_code()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_collect_language"><code class="docutils literal notranslate"><span class="pre">snippet_collect_language()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_inline_approve"><code class="docutils literal notranslate"><span class="pre">snippet_inline_approve()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_reject_start"><code class="docutils literal notranslate"><span class="pre">snippet_reject_start()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_collect_reject_reason"><code class="docutils literal notranslate"><span class="pre">snippet_collect_reject_reason()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_queue_command"><code class="docutils literal notranslate"><span class="pre">snippet_queue_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_approve_command"><code class="docutils literal notranslate"><span class="pre">snippet_approve_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_reject_command"><code class="docutils literal notranslate"><span class="pre">snippet_reject_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_regular_files_callback"><code class="docutils literal notranslate"><span class="pre">show_regular_files_callback()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_favorites_callback"><code class="docutils literal notranslate"><span class="pre">show_favorites_callback()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_favorites_page_callback"><code class="docutils literal notranslate"><span class="pre">show_favorites_page_callback()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_regular_files_page_callback"><code class="docutils literal notranslate"><span class="pre">show_regular_files_page_callback()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_recycle_bin"><code class="docutils literal notranslate"><span class="pre">show_recycle_bin()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.recycle_restore"><code class="docutils literal notranslate"><span class="pre">recycle_restore()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.recycle_purge"><code class="docutils literal notranslate"><span class="pre">recycle_purge()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.share_single_by_id"><code class="docutils literal notranslate"><span class="pre">share_single_by_id()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_duplicate_callback"><code class="docutils literal notranslate"><span class="pre">handle_duplicate_callback()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_file_menu"><code class="docutils literal notranslate"><span class="pre">handle_file_menu()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_view_file"><code class="docutils literal notranslate"><span class="pre">handle_view_file()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_edit_code"><code class="docutils literal notranslate"><span class="pre">handle_edit_code()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.receive_new_code"><code class="docutils literal notranslate"><span class="pre">receive_new_code()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_edit_name"><code class="docutils literal notranslate"><span class="pre">handle_edit_name()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_edit_note"><code class="docutils literal notranslate"><span class="pre">handle_edit_note()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.receive_new_name"><code class="docutils literal notranslate"><span class="pre">receive_new_name()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_versions_history"><code class="docutils literal notranslate"><span class="pre">handle_versions_history()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_download_file"><code class="docutils literal notranslate"><span class="pre">handle_download_file()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_delete_confirmation"><code class="docutils literal notranslate"><span class="pre">handle_delete_confirmation()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_delete_file"><code class="docutils literal notranslate"><span class="pre">handle_delete_file()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_file_info"><code class="docutils literal notranslate"><span class="pre">handle_file_info()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_callback_query"><code class="docutils literal notranslate"><span class="pre">handle_callback_query()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.cancel"><code class="docutils literal notranslate"><span class="pre">cancel()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.get_save_conversation_handler"><code class="docutils literal notranslate"><span class="pre">get_save_conversation_handler()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_view_version"><code class="docutils literal notranslate"><span class="pre">handle_view_version()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_revert_version"><code class="docutils literal notranslate"><span class="pre">handle_revert_version()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_preview_button"><code class="docutils literal notranslate"><span class="pre">handle_preview_button()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_autocomplete_button"><code class="docutils literal notranslate"><span class="pre">handle_autocomplete_button()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_batch_button"><code class="docutils literal notranslate"><span class="pre">handle_batch_button()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_batch_menu"><code class="docutils literal notranslate"><span class="pre">show_batch_menu()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_batch_repos_menu"><code class="docutils literal notranslate"><span class="pre">show_batch_repos_menu()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_batch_files_menu"><code class="docutils literal notranslate"><span class="pre">show_batch_files_menu()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_batch_zips_menu"><code class="docutils literal notranslate"><span class="pre">show_batch_zips_menu()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_batch_actions_menu"><code class="docutils literal notranslate"><span class="pre">show_batch_actions_menu()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.execute_batch_on_current_selection"><code class="docutils literal notranslate"><span class="pre">execute_batch_on_current_selection()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/database.html">database package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/database.html#database.init_database"><code class="docutils literal notranslate"><span class="pre">init_database()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/database.html#submodules">Submodules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/duplicate_detector.html">duplicate_detector module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/duplicate_detector.html#duplicate_detector.scan_duplicates"><code class="docutils literal notranslate"><span class="pre">scan_duplicates()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/file_manager.html">file_manager module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/file_manager.html#file_manager.BackupInfo"><code class="docutils literal notranslate"><span class="pre">BackupInfo</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/file_manager.html#file_manager.BackupManager"><code class="docutils literal notranslate"><span class="pre">BackupManager</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/fix_telegram_parse_error.html">fix_telegram_parse_error module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/fix_telegram_parse_error.html#fix_telegram_parse_error.clean_for_telegram"><code class="docutils literal notranslate"><span class="pre">clean_for_telegram()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/fix_telegram_parse_error.html#fix_telegram_parse_error.apply_fix"><code class="docutils literal notranslate"><span class="pre">apply_fix()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/fix_telegram_parse_error.html#fix_telegram_parse_error.wrap_edit_message_calls"><code class="docutils literal notranslate"><span class="pre">wrap_edit_message_calls()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/github_menu_handler.html">github_menu_handler module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/github_menu_handler.html#github_menu_handler.http_request"><code class="docutils literal notranslate"><span class="pre">http_request()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_menu_handler.html#github_menu_handler.safe_html_escape"><code class="docutils literal notranslate"><span class="pre">safe_html_escape()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_menu_handler.html#github_menu_handler.format_bytes"><code class="docutils literal notranslate"><span class="pre">format_bytes()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_menu_handler.html#github_menu_handler.GitHubMenuHandler"><code class="docutils literal notranslate"><span class="pre">GitHubMenuHandler</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/github_upload_fix.html">github_upload_fix module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/github_upload_fix.html#github_upload_fix.github_upload_new_file"><code class="docutils literal notranslate"><span class="pre">github_upload_new_file()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_upload_fix.html#github_upload_fix.handle_document_fixed"><code class="docutils literal notranslate"><span class="pre">handle_document_fixed()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_upload_fix.html#github_upload_fix.upload_to_github_fixed"><code class="docutils literal notranslate"><span class="pre">upload_to_github_fixed()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_upload_fix.html#github_upload_fix.setup_minimal_commands"><code class="docutils literal notranslate"><span class="pre">setup_minimal_commands()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_upload_fix.html#github_upload_fix.stats_command_secured"><code class="docutils literal notranslate"><span class="pre">stats_command_secured()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_upload_fix.html#github_upload_fix.check_commands"><code class="docutils literal notranslate"><span class="pre">check_commands()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/handlers.html">handlers package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.html#subpackages">Subpackages</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.html#submodules">Submodules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/http_async.html">http_async module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/http_async.html#http_async.CircuitOpenError"><code class="docutils literal notranslate"><span class="pre">CircuitOpenError</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/http_async.html#http_async.get_session"><code class="docutils literal notranslate"><span class="pre">get_session()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/http_async.html#http_async.request"><code class="docutils literal notranslate"><span class="pre">request()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/http_async.html#http_async.close_session"><code class="docutils literal notranslate"><span class="pre">close_session()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/http_sync.html">http_sync module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/http_sync.html#http_sync.CircuitOpenError"><code class="docutils literal notranslate"><span class="pre">CircuitOpenError</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/http_sync.html#http_sync.get_session"><code class="docutils literal notranslate"><span class="pre">get_session()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/http_sync.html#http_sync.request"><code class="docutils literal notranslate"><span class="pre">request()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/i18n.html">i18n package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/i18n.html#submodules">Submodules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/integrations.html">integrations module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/integrations_github_monitor.html">integrations_github_monitor module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/integrations_github_monitor.html#integrations_github_monitor.fetch_rate_limit"><code class="docutils literal notranslate"><span class="pre">fetch_rate_limit()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/integrations_github_monitor.html#integrations_github_monitor.summarize_rate_limit"><code class="docutils literal notranslate"><span class="pre">summarize_rate_limit()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/integrations_sentry.html">integrations_sentry module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/integrations_sentry.html#integrations_sentry.is_configured"><code class="docutils literal notranslate"><span class="pre">is_configured()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/integrations_sentry.html#integrations_sentry.get_recent_issues"><code class="docutils literal notranslate"><span class="pre">get_recent_issues()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/integrations_sentry.html#integrations_sentry.search_events"><code class="docutils literal notranslate"><span class="pre">search_events()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/integrations_sentry.html#integrations_sentry.get_issue_events"><code class="docutils literal notranslate"><span class="pre">get_issue_events()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/internal_alerts.html">internal_alerts module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/internal_alerts.html#internal_alerts.emit_internal_alert"><code class="docutils literal notranslate"><span class="pre">emit_internal_alert()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/internal_alerts.html#internal_alerts.get_recent_alerts"><code class="docutils literal notranslate"><span class="pre">get_recent_alerts()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/large_files_handler.html">large_files_handler module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/large_files_handler.html#large_files_handler.LargeFilesHandler"><code class="docutils literal notranslate"><span class="pre">LargeFilesHandler</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/lazy_loader.html">lazy_loader module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/lazy_loader.html#lazy_loader.FileChunk"><code class="docutils literal notranslate"><span class="pre">FileChunk</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/lazy_loader.html#lazy_loader.LazyLoader"><code class="docutils literal notranslate"><span class="pre">LazyLoader</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html">main module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.get_drive_handler_from_application"><code class="docutils literal notranslate"><span class="pre">get_drive_handler_from_application()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.get_admin_ids"><code class="docutils literal notranslate"><span class="pre">get_admin_ids()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.notify_admins"><code class="docutils literal notranslate"><span class="pre">notify_admins()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.recycle_backfill_command"><code class="docutils literal notranslate"><span class="pre">recycle_backfill_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.log_user_activity"><code class="docutils literal notranslate"><span class="pre">log_user_activity()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.get_lock_collection"><code class="docutils literal notranslate"><span class="pre">get_lock_collection()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.ensure_lock_indexes"><code class="docutils literal notranslate"><span class="pre">ensure_lock_indexes()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.cleanup_mongo_lock"><code class="docutils literal notranslate"><span class="pre">cleanup_mongo_lock()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.manage_mongo_lock"><code class="docutils literal notranslate"><span class="pre">manage_mongo_lock()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.HelpEntry"><code class="docutils literal notranslate"><span class="pre">HelpEntry</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.HelpSection"><code class="docutils literal notranslate"><span class="pre">HelpSection</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.signal_handler"><code class="docutils literal notranslate"><span class="pre">signal_handler()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.setup_handlers"><code class="docutils literal notranslate"><span class="pre">setup_handlers()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.main"><code class="docutils literal notranslate"><span class="pre">main()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.setup_bot_data"><code class="docutils literal notranslate"><span class="pre">setup_bot_data()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/metrics.html">metrics module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.track_performance"><code class="docutils literal notranslate"><span class="pre">track_performance()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.metrics_endpoint_bytes"><code class="docutils literal notranslate"><span class="pre">metrics_endpoint_bytes()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.metrics_content_type"><code class="docutils literal notranslate"><span class="pre">metrics_content_type()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.note_active_user"><code class="docutils literal notranslate"><span class="pre">note_active_user()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.note_request_started"><code class="docutils literal notranslate"><span class="pre">note_request_started()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.note_request_finished"><code class="docutils literal notranslate"><span class="pre">note_request_finished()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.get_active_requests_count"><code class="docutils literal notranslate"><span class="pre">get_active_requests_count()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.get_current_memory_usage"><code class="docutils literal notranslate"><span class="pre">get_current_memory_usage()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.get_recent_errors_count"><code class="docutils literal notranslate"><span class="pre">get_recent_errors_count()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.get_top_slow_endpoints"><code class="docutils literal notranslate"><span class="pre">get_top_slow_endpoints()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.get_slowest_endpoint"><code class="docutils literal notranslate"><span class="pre">get_slowest_endpoint()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.note_deployment_started"><code class="docutils literal notranslate"><span class="pre">note_deployment_started()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.note_deployment_shutdown"><code class="docutils literal notranslate"><span class="pre">note_deployment_shutdown()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.get_avg_response_time_seconds"><code class="docutils literal notranslate"><span class="pre">get_avg_response_time_seconds()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.record_request_outcome"><code class="docutils literal notranslate"><span class="pre">record_request_outcome()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.update_health_gauges"><code class="docutils literal notranslate"><span class="pre">update_health_gauges()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.record_startup_stage_metric"><code class="docutils literal notranslate"><span class="pre">record_startup_stage_metric()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.record_startup_total_metric"><code class="docutils literal notranslate"><span class="pre">record_startup_total_metric()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.record_http_request"><code class="docutils literal notranslate"><span class="pre">record_http_request()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.record_request_queue_delay"><code class="docutils literal notranslate"><span class="pre">record_request_queue_delay()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.record_outbound_request_duration"><code class="docutils literal notranslate"><span class="pre">record_outbound_request_duration()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.increment_outbound_retry"><code class="docutils literal notranslate"><span class="pre">increment_outbound_retry()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.set_circuit_state"><code class="docutils literal notranslate"><span class="pre">set_circuit_state()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.set_circuit_success_rate"><code class="docutils literal notranslate"><span class="pre">set_circuit_success_rate()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.get_boot_monotonic"><code class="docutils literal notranslate"><span class="pre">get_boot_monotonic()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.mark_startup_complete"><code class="docutils literal notranslate"><span class="pre">mark_startup_complete()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.note_first_request_latency"><code class="docutils literal notranslate"><span class="pre">note_first_request_latency()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.get_process_uptime_seconds"><code class="docutils literal notranslate"><span class="pre">get_process_uptime_seconds()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.record_dependency_init"><code class="docutils literal notranslate"><span class="pre">record_dependency_init()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.record_db_operation"><code class="docutils literal notranslate"><span class="pre">record_db_operation()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.get_uptime_percentage"><code class="docutils literal notranslate"><span class="pre">get_uptime_percentage()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.set_adaptive_observability_gauges"><code class="docutils literal notranslate"><span class="pre">set_adaptive_observability_gauges()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.set_external_error_rate_percent"><code class="docutils literal notranslate"><span class="pre">set_external_error_rate_percent()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.track_file_saved"><code class="docutils literal notranslate"><span class="pre">track_file_saved()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.track_search_performed"><code class="docutils literal notranslate"><span class="pre">track_search_performed()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.track_github_sync"><code class="docutils literal notranslate"><span class="pre">track_github_sync()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/monitoring.html">monitoring package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/monitoring.html#submodules">Submodules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/observability.html">observability module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/observability.html#observability.get_observability_context"><code class="docutils literal notranslate"><span class="pre">get_observability_context()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/observability.html#observability.get_request_id"><code class="docutils literal notranslate"><span class="pre">get_request_id()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/observability.html#observability.bind_command"><code class="docutils literal notranslate"><span class="pre">bind_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/observability.html#observability.bind_user_context"><code class="docutils literal notranslate"><span class="pre">bind_user_context()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/observability.html#observability.prepare_outgoing_headers"><code class="docutils literal notranslate"><span class="pre">prepare_outgoing_headers()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/observability.html#observability.classify_error"><code class="docutils literal notranslate"><span class="pre">classify_error()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/observability.html#observability.setup_structlog_logging"><code class="docutils literal notranslate"><span class="pre">setup_structlog_logging()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/observability.html#observability.generate_request_id"><code class="docutils literal notranslate"><span class="pre">generate_request_id()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/observability.html#observability.bind_request_id"><code class="docutils literal notranslate"><span class="pre">bind_request_id()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/observability.html#observability.emit_event"><code class="docutils literal notranslate"><span class="pre">emit_event()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/observability.html#observability.init_sentry"><code class="docutils literal notranslate"><span class="pre">init_sentry()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/observability.html#observability.get_recent_errors"><code class="docutils literal notranslate"><span class="pre">get_recent_errors()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/observability.html#observability.emit_anomaly"><code class="docutils literal notranslate"><span class="pre">emit_anomaly()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/observability_instrumentation.html">observability_instrumentation module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/observability_instrumentation.html#observability_instrumentation.traced"><code class="docutils literal notranslate"><span class="pre">traced()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/observability_instrumentation.html#observability_instrumentation.start_span"><code class="docutils literal notranslate"><span class="pre">start_span()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/observability_instrumentation.html#observability_instrumentation.set_current_span_attributes"><code class="docutils literal notranslate"><span class="pre">set_current_span_attributes()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/observability_otel.html">observability_otel module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/observability_otel.html#observability_otel.setup_telemetry"><code class="docutils literal notranslate"><span class="pre">setup_telemetry()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/predictive_engine.html">predictive_engine module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/predictive_engine.html#predictive_engine.Trend"><code class="docutils literal notranslate"><span class="pre">Trend</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/predictive_engine.html#predictive_engine.note_observation"><code class="docutils literal notranslate"><span class="pre">note_observation()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/predictive_engine.html#predictive_engine.evaluate_predictions"><code class="docutils literal notranslate"><span class="pre">evaluate_predictions()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/predictive_engine.html#predictive_engine.reset_state_for_tests"><code class="docutils literal notranslate"><span class="pre">reset_state_for_tests()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/predictive_engine.html#predictive_engine.maybe_recompute_and_preempt"><code class="docutils literal notranslate"><span class="pre">maybe_recompute_and_preempt()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/predictive_engine.html#predictive_engine.get_recent_predictions"><code class="docutils literal notranslate"><span class="pre">get_recent_predictions()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/predictive_engine.html#predictive_engine.get_trend_snapshot"><code class="docutils literal notranslate"><span class="pre">get_trend_snapshot()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/rate_limiter.html">rate_limiter module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/rate_limiter.html#rate_limiter.RateLimiter"><code class="docutils literal notranslate"><span class="pre">RateLimiter</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/refactor_handlers.html">refactor_handlers module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/refactor_handlers.html#refactor_handlers.set_activity_reporter"><code class="docutils literal notranslate"><span class="pre">set_activity_reporter()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/refactor_handlers.html#refactor_handlers.RefactorHandlers"><code class="docutils literal notranslate"><span class="pre">RefactorHandlers</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/refactor_handlers.html#refactor_handlers.setup_refactor_handlers"><code class="docutils literal notranslate"><span class="pre">setup_refactor_handlers()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/refactoring_engine.html">refactoring_engine module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/refactoring_engine.html#id1">××“×™× ×™×•×ª ×•×§×•× ×¤×™×’×•×¨×¦×™×”</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/refactoring_engine.html#safe-decomposition-models-py">××§×¨×” ××™×•×—×“: Safe Decomposition ×œâ€‘<code class="docutils literal notranslate"><span class="pre">models.py</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/remediation_manager.html">remediation_manager module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/remediation_manager.html#remediation_manager.handle_critical_incident"><code class="docutils literal notranslate"><span class="pre">handle_critical_incident()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/remediation_manager.html#remediation_manager.get_incidents"><code class="docutils literal notranslate"><span class="pre">get_incidents()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/reminders.html">reminders package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/reminders.html#submodules">Submodules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/repo_analyzer.html">repo_analyzer module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/repo_analyzer.html#repo_analyzer.RepoAnalyzer"><code class="docutils literal notranslate"><span class="pre">RepoAnalyzer</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/search_engine.html">search_engine module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/secret_manager.html">secret_manager module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/secret_manager.html#secret_manager.encrypt_secret"><code class="docutils literal notranslate"><span class="pre">encrypt_secret()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/secret_manager.html#secret_manager.decrypt_secret"><code class="docutils literal notranslate"><span class="pre">decrypt_secret()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/services.html">services package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/services.html#submodules">Submodules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/setup_bookmarks.html">setup_bookmarks module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/setup_bookmarks.html#setup_bookmarks.check_mongodb_connection"><code class="docutils literal notranslate"><span class="pre">check_mongodb_connection()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/setup_bookmarks.html#setup_bookmarks.setup_bookmarks_collection"><code class="docutils literal notranslate"><span class="pre">setup_bookmarks_collection()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/setup_bookmarks.html#setup_bookmarks.verify_installation"><code class="docutils literal notranslate"><span class="pre">verify_installation()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/setup_bookmarks.html#setup_bookmarks.main"><code class="docutils literal notranslate"><span class="pre">main()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/terminal_commands.html">terminal_commands module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/terminal_commands.html#terminal_commands.run_in_sandbox"><code class="docutils literal notranslate"><span class="pre">run_in_sandbox()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/terminal_commands.html#terminal_commands.terminal_enter"><code class="docutils literal notranslate"><span class="pre">terminal_enter()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/terminal_commands.html#terminal_commands.terminal_exit"><code class="docutils literal notranslate"><span class="pre">terminal_exit()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/terminal_commands.html#terminal_commands.terminal_run_command"><code class="docutils literal notranslate"><span class="pre">terminal_run_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/terminal_commands.html#terminal_commands.terminal_command"><code class="docutils literal notranslate"><span class="pre">terminal_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/terminal_commands.html#terminal_commands.setup_terminal_handlers"><code class="docutils literal notranslate"><span class="pre">setup_terminal_handlers()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/test_basic.html">test_basic module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/test_basic.html#test_basic.test_python_version"><code class="docutils literal notranslate"><span class="pre">test_python_version()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/test_basic.html#test_basic.test_import_main"><code class="docutils literal notranslate"><span class="pre">test_import_main()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/test_basic.html#test_basic.test_environment"><code class="docutils literal notranslate"><span class="pre">test_environment()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/test_basic.html#test_basic.test_basic_calculation"><code class="docutils literal notranslate"><span class="pre">test_basic_calculation()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/test_basic.html#test_basic.TestRequirements"><code class="docutils literal notranslate"><span class="pre">TestRequirements</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/test_bookmarks.html">test_bookmarks module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/test_bookmarks.html#test_bookmarks.TestFileBookmarkModel"><code class="docutils literal notranslate"><span class="pre">TestFileBookmarkModel</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/test_bookmarks.html#test_bookmarks.TestBookmarksManager"><code class="docutils literal notranslate"><span class="pre">TestBookmarksManager</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/test_bookmarks.html#test_bookmarks.TestSyncFunctionality"><code class="docutils literal notranslate"><span class="pre">TestSyncFunctionality</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/test_bookmarks.html#test_bookmarks.TestIntegration"><code class="docutils literal notranslate"><span class="pre">TestIntegration</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/test_bookmarks.html#test_bookmarks.run_tests"><code class="docutils literal notranslate"><span class="pre">run_tests()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/user_stats.html">user_stats module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/user_stats.html#user_stats.UserStats"><code class="docutils literal notranslate"><span class="pre">UserStats</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html">utils module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CodeErrorLogger"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TimeUtils"><code class="docutils literal notranslate"><span class="pre">TimeUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils"><code class="docutils literal notranslate"><span class="pre">TextUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.SecurityUtils"><code class="docutils literal notranslate"><span class="pre">SecurityUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils"><code class="docutils literal notranslate"><span class="pre">TelegramUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CallbackQueryGuard"><code class="docutils literal notranslate"><span class="pre">CallbackQueryGuard</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.AsyncUtils"><code class="docutils literal notranslate"><span class="pre">AsyncUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.PerformanceUtils"><code class="docutils literal notranslate"><span class="pre">PerformanceUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.ValidationUtils"><code class="docutils literal notranslate"><span class="pre">ValidationUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.FileUtils"><code class="docutils literal notranslate"><span class="pre">FileUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.ConfigUtils"><code class="docutils literal notranslate"><span class="pre">ConfigUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CacheUtils"><code class="docutils literal notranslate"><span class="pre">CacheUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.get_memory_usage"><code class="docutils literal notranslate"><span class="pre">get_memory_usage()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.setup_logging"><code class="docutils literal notranslate"><span class="pre">setup_logging()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.generate_summary_stats"><code class="docutils literal notranslate"><span class="pre">generate_summary_stats()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.detect_language_from_filename"><code class="docutils literal notranslate"><span class="pre">detect_language_from_filename()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.get_language_emoji"><code class="docutils literal notranslate"><span class="pre">get_language_emoji()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.SensitiveDataFilter"><code class="docutils literal notranslate"><span class="pre">SensitiveDataFilter</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.install_sensitive_filter"><code class="docutils literal notranslate"><span class="pre">install_sensitive_filter()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.normalize_code"><code class="docutils literal notranslate"><span class="pre">normalize_code()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/webapp.html">webapp package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/webapp.html#submodules">Submodules</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../modules/index.html">××•×“×•×œ×™× ×¨××©×™×™×</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#file-management">File Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#github-integration">GitHub Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#backup-system">Backup System</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#code-processing">Code Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#search-engine">Search Engine</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#repository-analysis">Repository Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#batch-processing">Batch Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#large-files-handling">Large Files Handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#cache-management">Cache Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#user-statistics">User Statistics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#activity-reporting">Activity Reporting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#utilities">Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#lazy-loading">Lazy Loading</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#integrations">Integrations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#terminal-commands">Terminal Commands</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#autocomplete-manager">Autocomplete Manager</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../handlers/index.html">Handlers</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#show-command">Show Command</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../handlers/show.html">Show Command</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../handlers/show.html#show">××¤×¨×˜ ×¤×§×•×“×ª <cite>/show</cite></a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/show.html#html">×“×•×’××ª ×ª×’×•×‘×ª HTML</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/show.html#id1">×”×¢×¨×•×ª ×™×™×©×•×</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/show.html#id2">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#drive-menu">Drive Menu</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../handlers/drive_menu.html">Drive Menu V2</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../handlers/drive_menu.html#id1">×¡×§×™×¨×”</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/drive_menu.html#id2">×“×’×œ ×¤×™×¦â€™×¨</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/drive_menu.html#id3">×–×¨×™××•×ª ×¢×™×§×¨×™×•×ª</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/drive_menu.html#device-flow">×”×ª×—×‘×¨×•×ª (Device Flow)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/drive_menu.html#id4">×˜×™×¤×•×œ ×©×’×™××•×ª</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/drive_menu.html#id5">× ×™×˜×•×¨</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/drive_menu.html#module-handlers.drive.menu">API (autodoc)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#file-view-handler">File View Handler</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../handlers/index.html#file-view-handler-module">File View Handler Module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#pagination-handler">Pagination Handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#save-flow-handler">Save Flow Handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#states-handler">States Handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#github-handlers">GitHub Handlers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#github-menu-bridge">GitHub Menu Bridge</a></li>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#document-flow">Document Flow</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../handlers/document-flow.html">×–×¨×™××ª ×”×˜×™×¤×•×œ ×‘××¡××›×™× (Document Flow)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../handlers/document-flow.html#id1">××¤×” ×•×ª×¤×§×™×“×™×</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/document-flow.html#id2">×–×¨×™××ª ×˜×™×¤×•×œ ×‘×§×•×‘×¥</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/document-flow.html#upload-mode">××¦×‘×™ upload_mode</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/document-flow.html#id3">×ª×œ×•×™×•×ª ×•×”×–×¨×§×•×ª</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/document-flow.html#best-practices">Best Practices</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/document-flow.html#filesfacade-db">×©×›×‘×ª ××—×¡×•×Ÿ (FilesFacade ××•×œ DB ×”×™×©×Ÿ)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/document-flow.html#id4">×¨××• ×’×</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#drive-utilities">Drive Utilities</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../services/index.html">Services</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../services/index.html#code-service">Code Service</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../services/index.html#code-service-module">Code Service Module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../services/index.html#github-service">GitHub Service</a></li>
<li class="toctree-l2"><a class="reference internal" href="../services/index.html#backup-service">Backup Service</a></li>
<li class="toctree-l2"><a class="reference internal" href="../services/index.html#ai-explain-service">AI Explain Service</a></li>
<li class="toctree-l2"><a class="reference internal" href="../services/index.html#community-library-service">Community Library Service</a></li>
<li class="toctree-l2"><a class="reference internal" href="../services/index.html#image-generator-service">Image Generator Service</a></li>
<li class="toctree-l2"><a class="reference internal" href="../services/index.html#snippet-library-service">Snippet Library Service</a></li>
<li class="toctree-l2"><a class="reference internal" href="../services/index.html#observability-http-service">Observability HTTP Service</a></li>
<li class="toctree-l2"><a class="reference internal" href="../services/index.html#google-drive-service">Google Drive Service</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../services/google_drive_service.html">Google Drive Service</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../services/google_drive_service.html#id1">×¡×§×™×¨×”</a></li>
<li class="toctree-l4"><a class="reference internal" href="../services/google_drive_service.html#oauth">×”×¢×¨×•×ª OAuth</a></li>
<li class="toctree-l4"><a class="reference internal" href="../services/google_drive_service.html#id2">××‘× ×™ ×§×‘×¦×™×</a></li>
<li class="toctree-l4"><a class="reference internal" href="../services/google_drive_service.html#api-autodoc">API (autodoc)</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../database/index.html">Database</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../database/index.html#database-manager">Database Manager</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/index.html#models">Models</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../database/index.html#codesnippet-model">CodeSnippet Model</a></li>
<li class="toctree-l3"><a class="reference internal" href="../database/index.html#databasemanager-class">DatabaseManager Class</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../database/index.html#database-operations">Database Operations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../database/index.html#save-operations">Save Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../database/index.html#search-operations">Search Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../database/index.html#delete-operations">Delete Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../database/index.html#statistics-operations">Statistics Operations</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../database/index.html#users">××™× ×“×§×¡×™× ×‘×§×•×œ×§×¦×™×™×ª users</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/index.html#id1">××“×¨×™×›×™ ××•×“×•×œ×™× ×™×™×¢×•×“×™×™×</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../database/bookmarks-manager.html">×× ×”×œ ×¡×™×× ×™×•×ª â€“ BookmarksManager</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../database/bookmarks-manager.html#id1">××ª×™ ××©×ª××©×™× ×‘×•?</a></li>
<li class="toctree-l4"><a class="reference internal" href="../database/bookmarks-manager.html#id2">××‘× ×” ×•××™× ×“×§×¡×™×</a></li>
<li class="toctree-l4"><a class="reference internal" href="../database/bookmarks-manager.html#id3">××’×‘×œ×•×ª ×©×™××•×©</a></li>
<li class="toctree-l4"><a class="reference internal" href="../database/bookmarks-manager.html#toggle">×ª×”×œ×™×š Toggle</a></li>
<li class="toctree-l4"><a class="reference internal" href="../database/bookmarks-manager.html#id4">×¡× ×›×¨×•×Ÿ ×¢× ×©×™× ×•×™×™× ×‘×§×•×‘×¥</a></li>
<li class="toctree-l4"><a class="reference internal" href="../database/bookmarks-manager.html#analytics">××™×¨×•×¢×™× (Analytics)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../database/bookmarks-manager.html#module-database.bookmarks_manager">Autodoc</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../database/collections-manager.html">×× ×”×œ ××•×¡×¤×™× â€“ CollectionsManager</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../database/collections-manager.html#id1">×¨×›×™×‘×™ ×‘×¡×™×¡</a></li>
<li class="toctree-l4"><a class="reference internal" href="../database/collections-manager.html#id2">××™× ×“×§×¡×™×</a></li>
<li class="toctree-l4"><a class="reference internal" href="../database/collections-manager.html#id3">×¡×•×’×™ ××•×¡×¤×™×</a></li>
<li class="toctree-l4"><a class="reference internal" href="../database/collections-manager.html#id4">×ª×¨×—×™×©×™ ×©×™××•×© × ×¤×•×¦×™×</a></li>
<li class="toctree-l4"><a class="reference internal" href="../database/collections-manager.html#id5">×—×•×§×™× ×•×©××™×¨×” ×¢×œ ××™×›×•×ª</a></li>
<li class="toctree-l4"><a class="reference internal" href="../database/collections-manager.html#id6">×©×™×ª×•×£ ×¦×™×‘×•×¨×™</a></li>
<li class="toctree-l4"><a class="reference internal" href="../database/collections-manager.html#module-database.collections_manager">Autodoc</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../database/indexing.html">MongoDB Indexing Cookbook</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#id1">×œ××”?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#id2">××™× ×“×§×¡×™× ××•××œ×¦×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#python-pymongo">××ª×›×•× ×™× (Python / PyMongo)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#explain-mongo-shell">×‘×“×™×§×•×ª explain (Mongo Shell)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#explain">××” ×œ×—×¤×© ×‘-explain?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#id3">×‘×“×™×§×ª ×§×™×•× ××™× ×“×§×¡×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#id4">×©×™×˜×•×ª ×¢×‘×•×“×” ××•××œ×¦×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#id5">×“×•×’×××•×ª × ×•×¡×¤×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#gotchas">Gotchas × ×¤×•×¦×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../database/cursor-pagination.html">Cursor-based Pagination (created_at / _id)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#id1">×œ××”?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#id2">×¢×§×¨×•× ×•×ª ××™×•×Ÿ ×™×¦×™×‘</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#python">×§×™×“×•×“/×¤×¢× ×•×— ×§×•×¨×¡×•×¨ (Python)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#id3">×ª×‘× ×™×ª ×©××™×œ×ª×” (×—×“×© â†’ ×™×©×Ÿ)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#pymongo">PyMongo â€“ ×“×•×’××” ××œ××”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#id4">×“×¤×“×•×£ ×œ××—×•×¨ (×™×©×Ÿ â†’ ×—×“×©)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#copypaste">×‘×“×™×§×•×ª ×™×“× ×™×•×ª (Copyâ€‘Paste)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#id5">×©×™×˜×•×ª ×¢×‘×•×“×” ××•××œ×¦×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#gotchas">Gotchas × ×¤×•×¦×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#id6">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../database-schema.html">Database Schema</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../database-schema.html#collections">Collections</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../database-schema.html#code-snippets"><code class="docutils literal notranslate"><span class="pre">code_snippets</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../database-schema.html#users"><code class="docutils literal notranslate"><span class="pre">users</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../database-schema.html#bookmarks"><code class="docutils literal notranslate"><span class="pre">bookmarks</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../database-schema.html#sessions-webapp"><code class="docutils literal notranslate"><span class="pre">sessions</span></code> (WebApp)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../database-schema.html#indexes">Indexes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database-schema.html#relationships">Relationships</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database-schema.html#id1">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../database/detailed-schema.html">××‘× ×” × ×ª×•× ×™× ××¤×•×¨×˜ (Detailed Database Schema)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../database/detailed-schema.html#id1">×¡×§×™×¨×” ×›×œ×œ×™×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/detailed-schema.html#code-snippets">××•×¡×£: code_snippets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/detailed-schema.html#large-files">××•×¡×£: large_files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/detailed-schema.html#users">××•×¡×£: users</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/detailed-schema.html#bookmarks">××•×¡×£: bookmarks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/detailed-schema.html#collections">××•×¡×£: collections</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/detailed-schema.html#backups">××•×¡×£: backups</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/detailed-schema.html#id2">×™×—×¡×™× ×‘×™×Ÿ ××•×¡×¤×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/detailed-schema.html#best-practices">Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/detailed-schema.html#id3">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">×¢×–×¨×” ×•×“×•×’×××•×ª:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../examples.html">×“×•×’×××•×ª ×©×™××•×©</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#id2">×©×™××•×© ×‘×¡×™×¡×™</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id3">×™×¦×™×¨×ª ××¤×œ×™×§×¦×™×™×ª ×‘×•×˜</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id4">×©××™×¨×ª ×§×•×“ ×—×“×©</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id5">×—×™×¤×•×© ×§×•×“</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#handlers">×©×™××•×© ×‘-Handlers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#command-handler">×™×¦×™×¨×ª Command Handler</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#conversation-handler">×™×¦×™×¨×ª Conversation Handler</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#services">×©×™××•×© ×‘-Services</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id6">×–×™×”×•×™ ×©×¤×ª ×ª×›× ×•×ª</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id7">× ×™×ª×•×— ×§×•×“</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#github">××™× ×˜×’×¨×¦×™×” ×¢× GitHub</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#gist">×”×¢×œ××ª ×§×•×“ ×œ-Gist</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#gists">×©×œ×™×¤×ª Gists ×©×œ ××©×ª××©</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#id8">×¢×‘×•×“×” ×¢× ××¡×“ ×”× ×ª×•× ×™×</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id9">×‘×™×¦×•×¢ ×©××™×œ×ª×•×ª ××•×¨×›×‘×•×ª</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id10">×¢×“×›×•×Ÿ ×§×‘×¦×™×</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id11">×¡×˜×˜×™×¡×˜×™×§×•×ª</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#id12">×˜×™×¤×•×œ ×‘×©×’×™××•×ª</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id13">×˜×™×¤×•×œ ×‘×©×’×™××•×ª ×‘×¡×™×¡×™</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#retry-logic">Retry Logic</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#id14">×‘×“×™×§×•×ª</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id15">×‘×“×™×§×ª ×™×—×™×“×”</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id16">×‘×“×™×§×ª ××™× ×˜×’×¨×¦×™×”</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#id17">×“×•×’×××•×ª ××ª×§×“××•×ª</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id18">×¢×™×‘×•×“ ×‘××¦×•×•×”</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id19">×§××©×™× ×’</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#api-curl">×©×™×ª×•×£ ×¦×™×‘×•×¨×™ ×“×¨×š ×”â€‘API (curl)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#markdown">×“×•×’××ª Markdown ××ª×§×“××ª ×œ×ª×¦×•×’×”</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../testing.html">Testing Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#quickstart">ğŸš€ Quickstart ×œ×˜×¡×˜×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#id1">×”× ×—×™×•×ª ×§×¨×™×˜×™×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#stubs">×˜×¢×™× ×ª Stubs ×œ×˜×œ×’×¨×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#tmp-path">×“×•×’××ª ×©×™××•×© ×‘â€‘tmp_path</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#id2">××—×™×§×” ×‘×˜×•×—×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#mocking-http-github-menu-handler">Mocking HTTP ×‘â€‘github_menu_handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#blueprint">×¨×™×©×•× Blueprint ×‘×¡×‘×™×‘×ª ×˜×¡×˜×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#pytest-cov">×›×™×¡×•×™ ×‘×“×™×§×•×ª (pytest-cov)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#ci">CI × ×ª××š</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#performance">×‘×“×™×§×•×ª ×‘×™×¦×•×¢×™× (Performance)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#id3">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../testing-rate-limit-examples.html">×“×•×’×××•×ª ×˜×¡×˜×™× â€“ Rate Limiting ×•××¡×™× ×›×¨×•× ×™×•×ª</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../testing-rate-limit-examples.html#rate-limiting-redis-mock">Rate Limiting (Redis Mock)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing-rate-limit-examples.html#id1">×˜×¡×˜×™× ××¡×™× ×›×¨×•× ×™×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../performance-tests.html">×‘×“×™×§×•×ª ×‘×™×¦×•×¢×™× (Performance Tests)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../performance-tests.html#id1">××˜×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance-tests.html#id2">×¡×™××•×Ÿ ×˜×¡×˜×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance-tests.html#id3">×”×¨×¦×” ××§×•××™×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance-tests.html#ci-github-actions">CI / GitHub Actions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance-tests.html#id4">×“×•×—×•×ª ×•×–×× ×™ ×¨×™×¦×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance-tests.html#id5">×˜×™×¤×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ci-cd.html">CI/CD Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../ci-cd.html#id1">×—×•×§×™× ×§×©×™×—×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ci-cd.html#id2">×¡×˜×˜×•×¡×™× × ×“×¨×©×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ci-cd.html#ci-overview">×¨×™×›×•×– CI (Overview)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ci-cd.html#id3">×‘×“×™×§×•×ª ××•××œ×¦×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ci-cd.html#id4">×‘× ×™×™×” ×©×œ ×”×ª×™×¢×•×“</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ci-cd.html#id5">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../conversation-handlers.html">Conversation Handlers &amp; States</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#id1">×¡×§×™×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#states">×¨×©×™××ª States (××‘×—×¨ ×‘×¤×•×¢×œ)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#save-flow">Save Flow (×ª×¨×©×™× ××¦×‘×™×)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#github-flow">GitHub Flow (×ª×¨×©×™× ××¦×‘×™×)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#bot">×¡×¤×¨×™×™×ª ×¡× ×™×¤×˜×™× â€“ ×–×¨×™××ª ×”×’×©×” (Bot)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#id2">×‘×™×˜×•×œ ×”×•×’×Ÿ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#id3">×”×ª×¨××•×ª ××“××™×Ÿ ×•×”×•×“×¢×ª ××©×ª××©</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#handler">×“×•×’××ª Handler ×ª××¦×™×ª×™×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#id4">×˜×‘×œ×ª ×–×¨×™××•×ª ××œ××”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#id5">×§×™×©×•×¨×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#id6">×“×•×’×××•×ª ×§×•×“ ×ª××¦×™×ª×™×•×ª (×××©×™×•×ª)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#save">Save â€“ ×©×œ×‘×™× ×¢×™×§×¨×™×™×</a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#github">GitHub â€“ ×ª×¤×¨×™×˜ ×•×©×™×—×ª ×”×¢×œ××”</a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#backup">Backup â€“ ×ª×¤×¨×™×˜</a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#drive">Drive â€“ ×ª×¤×¨×™×˜</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#id7">××•×§×©×™× × ×¤×•×¦×™× ×•×¤×ª×¨×•× ×•×ª</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#query-answer"><code class="docutils literal notranslate"><span class="pre">query.answer()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#message-is-not-modified">×¢×¨×™×›×ª ×”×•×“×¢×•×ª ×‘×‘×˜×—×” â€“ â€Message is not modifiedâ€œ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#filters">Filters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#persistent-data-context-user-data">Persistent data (<code class="docutils literal notranslate"><span class="pre">context.user_data</span></code>)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#id8">×“×•×’×××•×ª ×˜×¡×˜×™× ×§×¦×¨×•×ª</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#id9">Save â€“ ×”×ª×—×œ×” ×•×–×¨×™××” ×‘×¡×™×¡×™×ª</a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#github-upload-conv-handler">GitHub â€“ upload_conv_handler</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting.html">Troubleshooting Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#id1">×©×’×™××•×ª × ×¤×•×¦×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#importerror-telegram-conversationhandler-filters">ImportError ×‘×–××Ÿ ×˜×¡×˜×™× (telegram / ConversationHandler / filters)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#parse-mode">×©×’×™××•×ª parse_mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#asyncio-attached-to-a-different-loop-event-loop-is-closed">×©×’×™××•×ª asyncio: â€attached to a different loopâ€œ / â€Event loop is closedâ€œ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#id2">×“×™×‘×•×’ ××”×™×¨</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#mongodb">×‘×“×™×§×ª ×—×™×‘×•×¨ MongoDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#id3">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../development.html">Development Workflow</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../development.html#handler">×”×•×¡×¤×ª Handler ×—×“×©</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development.html#endpoint-webapp">×”×•×¡×¤×ª Endpoint ×œâ€‘WebApp</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development.html#schema">×¢×“×›×•×Ÿ Schema ×‘××¡×“ ×”× ×ª×•× ×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development.html#id1">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../development/pre-commit.html">Pre-commit Hooks</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../development/pre-commit.html#id1">××˜×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development/pre-commit.html#id2">×”×ª×§× ×” ×•×”×¨×¦×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development/pre-commit.html#hooks">Hooks ×¤×¢×™×œ×™× (×¢×™×§×¨×™×™×)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development/pre-commit.html#id3">×˜×™×¤×™× ×œ×¤×ª×¨×•×Ÿ ×‘×¢×™×•×ª</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../development/tools.html">×›×œ×™ ×¢×–×¨ ×œ××¤×ª×—×™×</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../development/tools.html#tools-analyze-queries-py"><code class="docutils literal notranslate"><span class="pre">tools/analyze_queries.py</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../development/tools.html#id3">××˜×¨×”</a></li>
<li class="toctree-l3"><a class="reference internal" href="../development/tools.html#id4">×“×¨×™×©×•×ª</a></li>
<li class="toctree-l3"><a class="reference internal" href="../development/tools.html#id5">×“×•×’××ª ×”×¨×¦×”</a></li>
<li class="toctree-l3"><a class="reference internal" href="../development/tools.html#id6">×¤×œ×˜ ××•×¤×™×™× ×™</a></li>
<li class="toctree-l3"><a class="reference internal" href="../development/tools.html#id7">×˜×™×¤×™×</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../development/tools.html#tools-dup-scan-py"><code class="docutils literal notranslate"><span class="pre">tools/dup_scan.py</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../development/tools.html#id8">××˜×¨×”</a></li>
<li class="toctree-l3"><a class="reference internal" href="../development/tools.html#id9">×“×•×’××ª ×”×¨×¦×”</a></li>
<li class="toctree-l3"><a class="reference internal" href="../development/tools.html#id10">×¤×¨××˜×¨×™× ×—×©×•×‘×™×</a></li>
<li class="toctree-l3"><a class="reference internal" href="../development/tools.html#best-practices">Best Practices</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../development/scripts.html">×¡×§×¨×™×¤×˜×™× ×©×™××•×©×™×™×</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../development/scripts.html#scripts-cleanup-repo-tags-py"><code class="docutils literal notranslate"><span class="pre">scripts/cleanup_repo_tags.py</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../development/scripts.html#scripts-dev-seed-py"><code class="docutils literal notranslate"><span class="pre">scripts/dev_seed.py</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../development/scripts.html#scripts-import-snippets-from-markdown-py">scripts/import_snippets_from_markdown.py</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development/scripts.html#scripts-migrate-workspace-collections-py">scripts/migrate_workspace_collections.py</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development/scripts.html#scripts-run-log-aggregator-py"><code class="docutils literal notranslate"><span class="pre">scripts/run_log_aggregator.py</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../development/scripts.html#scripts-start-webapp-sh"><code class="docutils literal notranslate"><span class="pre">scripts/start_webapp.sh</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../development/scripts.html#scripts-start-with-worker-sh"><code class="docutils literal notranslate"><span class="pre">scripts/start_with_worker.sh</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../development/i18n.html">×‘×™× ××•× ×•×ª××™×›×” ×‘×©×¤×•×ª</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../development/i18n.html#id3">××‘× ×” ×”×§×‘×¦×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development/i18n.html#id4">×‘×—×™×¨×ª ×©×¤×” ×‘×–××Ÿ ×¨×™×¦×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development/i18n.html#id5">×”×•×¡×¤×ª ×©×¤×” ×—×“×©×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development/i18n.html#id6">×¢×§×¨×•× ×•×ª ×›×ª×™×‘×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development/i18n.html#id7">×‘×“×™×§×•×ª ××”×™×¨×•×ª</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../integrations.html">Integrations</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../integrations.html#github-api">GitHub API</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../integrations.html#gist">×™×¦×™×¨×ª Gist (×“×•×’××”)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../integrations.html#google-drive-oauth-flow">Google Drive (OAuth Flow)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integrations.html#telegram-webhooks-vs-polling">Telegram Webhooks vs Polling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integrations.html#id1">×§×™×©×•×¨×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integrations.html#github-scopes">GitHub â€“ Scopes × ×“×¨×©×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integrations.html#troubleshooting-github-rate-limits">Troubleshooting GitHub â€“ Rate limits</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integrations.html#github-cli-gh">GitHub CLI (gh) â€“ ×ª×§×¦×™×¨ ×§×¦×¨</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integrations.html#repository-providers">Repository Providers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integrations.html#best-practices-monorepos">Best Practices â€“ ×××’×¨×™× ×’×“×•×œ×™×/Monorepos</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../repository-integrations.html">Repository Integrations</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../repository-integrations.html#id1">×¡×§×™×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../repository-integrations.html#id2">××¦×‘ ×ª××™×›×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../repository-integrations.html#id3">×”×¢×¨×•×ª</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../security.html">Security Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../security.html#id1">×¡×•×“×•×ª ×•×¤×¨×˜×™×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security.html#id2">×”×¦×¤× ×ª ×˜×•×§× ×™× (×“×•×’××”)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security.html#csrf-webapp">CSRF ×‘â€‘WebApp</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security.html#rate-limiting">Rate Limiting (×“×•×’××”)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security.html#id3">×§×™×©×•×¨×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security.html#id4">××‘×˜×—×ª ×”×•×“×¢×•×ª ×‘×˜×œ×’×¨×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../monitoring.html">Smart Observability v7 â€“ Predictive Health &amp; Adaptive Feedback</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../monitoring.html#grafana-telegram-webhook">×—×™×‘×•×¨ Grafana â†’ Telegram (Webhook)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../monitoring.html#grafana-annotations">Grafana Annotations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../monitoring.html#adaptive-thresholds">Adaptive Thresholds (×¡×¤×™× ×“×™× ××™×™×)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../monitoring.html#id1">×”×¤×¨×“×” ×‘×™×Ÿ ×©×’×™××•×ª ×¤× ×™××™×•×ª ×œ×—×™×¦×•× ×™×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../monitoring.html#predictive-health-v7">Predictive Health (v7)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../monitoring.html#safe-mode">SAFE_MODE ×•×“×™×œ×•×’ ×¢×œ ×¤×¢×•×œ×•×ª ×× ×¢</a></li>
<li class="toctree-l3"><a class="reference internal" href="../monitoring.html#chatops">ChatOps</a></li>
<li class="toctree-l3"><a class="reference internal" href="../monitoring.html#chatops-rate-limit">×”×¨×©××•×ª ChatOps ×•-Rate Limit</a></li>
<li class="toctree-l3"><a class="reference internal" href="../monitoring.html#grafana">Grafana â€“ ×™×™×‘×•× ×“×©×‘×•×¨×“ ×œ×“×•×’××”</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../monitoring.html#grafana-accuracy-prevention-panels">Grafana â€“ Accuracy &amp; Prevention Panels</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../monitoring.html#feedback-loop">×ª×¨×©×™× ×–×¨×™××ª Feedback Loop</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../monitoring.html#autoremediation-v5">Autoâ€‘Remediation (v5)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../monitoring.html#incident-memory">Incident Memory</a></li>
<li class="toctree-l3"><a class="reference internal" href="../monitoring.html#id2">Feedback Loop ×œ××™×¨×•×¢×™× ×—×•×–×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../monitoring.html#chatops-observe">ChatOps â€“ /observe</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../monitoring.html#id3">×”×¨×—×‘×•×ª ××¦×‘ ××¤×•×¨×˜</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../monitoring.html#endpoints">Endpoints</a></li>
<li class="toctree-l2"><a class="reference internal" href="../monitoring.html#id4">×§×™×©×•×¨×™× ×œ×ª×™×¢×•×“ ChatOps</a></li>
<li class="toctree-l2"><a class="reference internal" href="../monitoring.html#id5">×˜×™×¤×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../git-lfs.html">Git LFS Integration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../git-lfs.html#id1">××˜×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../git-lfs.html#lfs">××ª×™ ×œ×”×©×ª××© ×‘â€‘LFS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../git-lfs.html#id2">×”×ª×§× ×” ×‘×¡×™×¡×™×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../git-lfs.html#best-practices">Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../git-lfs.html#id3">××’×‘×œ×•×ª ×•×’×‘×•×œ×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../git-lfs.html#id4">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../user/bookmarks.html">×¡×™×× ×™×•×ª (Bookmarks)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../user/bookmarks.html#id1">××”×Ÿ ×¡×™×× ×™×•×ª?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/bookmarks.html#id2">××™×š ×œ×”×•×¡×™×£ ×¡×™×× ×™×™×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/bookmarks.html#id3">×¤×× ×œ ×”×¡×™×× ×™×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/bookmarks.html#anchor">Anchor ×™×¦×™×‘</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/bookmarks.html#id4">××’×‘×œ×•×ª, ××‘×˜×—×” ×•×¤×¨×˜×™×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/bookmarks.html#api">API ×§×¦×¨ (×œ××¤×ª×—×™×)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/bookmarks.html#id5">×”×¢×¨×•×ª ×©×™××•×©×™×•×ª</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../user/sticky_notes.html">×¤×ª×§×™× ×“×‘×™×§×™× (Sticky Notes)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../user/sticky_notes.html#id1">××”× ×¤×ª×§×™× ×“×‘×™×§×™×?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/sticky_notes.html#id2">××™×š ××•×¡×™×¤×™× ×•×× ×”×œ×™× ×¤×ª×§×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/sticky_notes.html#id3">×¢×™×’×•×Ÿ ×™×¦×™×‘ ×œ×¢×•××ª ××™×§×•× ×§×‘×•×¢</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/sticky_notes.html#id4">×©×™×œ×•×‘ ×¢× ×¡×™×× ×™×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/sticky_notes.html#id5">××’×‘×œ×•×ª, ×¤×¨×˜×™×•×ª ×•××‘×˜×—×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/sticky_notes.html#id6">×˜×™×¤×™× ×©×™××•×©×™×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/sticky_notes.html#api">API ×§×¦×¨ (×œ××¤×ª×—×™×)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/sticky_notes.html#reminders">×”×ª×¨××•×ª ×•×ª×–×›×•×¨×•×ª (Reminders)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../user/sticky_notes.html#id7">××™×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../user/sticky_notes.html#troubleshooting">Troubleshooting ×§×¦×¨</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../user/sticky_notes.html#id8">×‘×¢×™×•×ª × ×¤×•×¦×•×ª ×‘×ª×–×›×•×¨×•×ª</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../user/reminders.html">×ª×–×›×•×¨×•×ª ×‘×‘×•×˜</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../user/reminders.html#id2">×¡×§×™×¨×” ×§×¦×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/reminders.html#id3">×¤×§×•×“×•×ª ×¢×™×§×¨×™×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/reminders.html#id4">××™×š ×”×•×•×™×–×¨×“ ×¢×•×‘×“</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/reminders.html#id5">×˜×™×¤×™× ×œ×©×™××•×© ×‘×¤×§×•×“×” ××”×™×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/reminders.html#id6">× ×™×”×•×œ ×”×ª×–×›×•×¨×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/reminders.html#id7">××’×‘×œ×•×ª ×•××“×™× ×™×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/reminders.html#id8">××ª×–××Ÿ ×•×”×ª××•×©×©×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/reminders.html#id9">×—×™×‘×•×¨ ×œ×§×•×“</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/reminders.html#id10">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../user/my_collections.html">×”××•×¡×¤×™× ×©×œ×™ (My Collections)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../user/my_collections.html#id1">××”× ××•×¡×¤×™×?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/my_collections.html#id2">×™×›×•×œ×•×ª ××¨×›×–×™×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/my_collections.html#id3">××™×š ××©×ª××©×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/my_collections.html#id4">×©×™×œ×•×‘ ×¢× ×¡×™×× ×™×•×ª ×•×¤×ª×§×™× ×“×‘×™×§×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/my_collections.html#id5">××’×‘×œ×•×ª ×•×¤×¨×˜×™×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/my_collections.html#api">API ×§×¦×¨ (×œ××¤×ª×—×™×)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/my_collections.html#id6">×˜×™×¤×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/my_collections.html#id7">××•×‘×™×™×œ/×˜××‘×œ×˜ â€“ ×’×¨×™×¨×” ×œ×¡×™×“×•×¨</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/my_collections.html#kanban">×œ×•×— Kanban ×¢×‘×•×¨ <em>×©×•×œ×—×Ÿ ×”×¢×‘×•×“×”</em></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../user/share_code.html">×©×™×ª×•×£ ×§×•×“ (×—×©×•×‘)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#id2">××” ×–×” ×¢×•×©×”?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#id3">××™×¤×” ×”×›×¤×ª×•×¨ ××•×¤×™×¢?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#id4">××™×š ×–×” ×¢×•×‘×“ (×–×¨×™××”)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#env">×“×¨×™×©×•×ª ×¡×‘×™×‘×ª×™×•×ª (ENV)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#id5">××’×‘×œ×•×ª ×•×”×ª× ×”×’×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#id6">×”×•×“×¢×•×ª ×”×¦×œ×—×”/×©×’×™××”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#troubleshooting">Troubleshooting ×§×¦×¨</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#id7">×“×•×’×××•×ª (×˜×§×¡×˜×•××œ×™×•×ª)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../user/github_browse.html">×¢×™×•×Ÿ ×‘×§×•×“ GitHub (×›×•×œ×œ ×—×™×¤×•×© ×‘×©× ×§×•×‘×¥)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../user/github_browse.html#id1">×©×•×¨×ª ×›×œ×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/github_browse.html#id2">×ª×•×¦××•×ª ×—×™×¤×•×©</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/github_browse.html#id3">× ×™×•×•×˜ ×¨×™×¤×•</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../user/download_repo.html">×”×•×¨×“×ª ×¨×™×¤×•</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../user/download_repo.html#id2">××” ×‘×“×™×•×§ ××•×¨×™×“</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/download_repo.html#id3">××’×‘×œ×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/download_repo.html#id4">×”×•×“×¢×•×ª × ×¤×•×¦×•×ª</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../BOT_TEST_PLAN_CONTAINER.html">×ª×›× ×™×ª ×‘×“×™×§×•×ª ×œ×‘×•×˜ â€“ Composition Root (Container) ×œ×©×™×¨×•×ª Snippet</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../BOT_TEST_PLAN_CONTAINER.html#id1">××™×š ×œ×‘×“×•×§</a></li>
<li class="toctree-l2"><a class="reference internal" href="../BOT_TEST_PLAN_CONTAINER.html#copy-paste">×¡×˜ ×“×•×’×××•×ª ×œ×©××™×¨×” (Copy/Paste)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../BOT_TEST_PLAN_CONTAINER.html#id2">×‘×“×™×§×•×ª × ×•×¡×¤×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../BOT_TEST_PLAN_CONTAINER.html#id3">×ª×§×œ×•×ª ×©×›×“××™ ×œ×¢×§×•×‘ ××—×¨×™×”×Ÿ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../BOT_TEST_PLAN_CONTAINER.html#facade-container">×‘×“×™×§×•×ª ×–×¨×™××” ××•×¨×—×‘×•×ª (×œ××—×¨ ××¢×‘×¨ ×œ-Facade/Container)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../BOT_TEST_PLAN_CONTAINER.html#id4">1) ×©××™×¨×”/×ª×¦×•×’×”/×¢×¨×™×›×” (×§×‘×¦×™× ×¨×’×™×œ×™×)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../BOT_TEST_PLAN_CONTAINER.html#id5">2) ×§×‘×¦×™× ×’×“×•×œ×™×</a></li>
<li class="toctree-l3"><a class="reference internal" href="../BOT_TEST_PLAN_CONTAINER.html#id6">3) ××¡××›×™×/×”×¢×œ××•×ª</a></li>
<li class="toctree-l3"><a class="reference internal" href="../BOT_TEST_PLAN_CONTAINER.html#google-drive">4) Google Drive</a></li>
<li class="toctree-l3"><a class="reference internal" href="../BOT_TEST_PLAN_CONTAINER.html#chatops">5) ChatOps â€“ ×–×™×”×•×™ ×©×¤×” (×©×§×™×¤×•×ª ×•×“×™×‘×•×’)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../BOT_TEST_PLAN_CONTAINER.html#id7">6) ×¨×’×¨×¡×™×” ×›×œ×œ×™×ª</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">×–×¨×™××•×ª ×¢×‘×•×“×”:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../workflows/index.html">×–×¨×™××•×ª ×¢×‘×•×“×” (Workflows)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../workflows/index.html#id1">×¡×§×™×¨×” ×›×œ×œ×™×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../workflows/index.html#id2">×¨×©×™××ª ×–×¨×™××•×ª</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../workflows/save-flow.html">×–×¨×™××ª ×©××™×¨×ª ×§×•×“ (Save Flow)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../workflows/save-flow.html#id1">×¡×§×™×¨×” ×›×œ×œ×™×ª</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/save-flow.html#id2">××¦×‘×™ ×©××™×¨×”</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/save-flow.html#id3">×–×¨×™××ª ×¢×‘×•×“×” ×‘×¡×™×¡×™×ª</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/save-flow.html#long-collect">××¦×‘ ××™×¡×•×£ ××¨×•×š (LONG_COLLECT)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/save-flow.html#secrets-detection">×–×™×”×•×™ ×¡×•×“×•×ª (Secrets Detection)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/save-flow.html#id4">×˜×™×¤×•×œ ×‘×›×¤×™×œ×•×™×•×ª</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/save-flow.html#id5">× ×¨××•×œ ×§×•×“</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/save-flow.html#edge-cases">Edge Cases</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/save-flow.html#id6">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../workflows/search-flow.html">×–×¨×™××ª ×—×™×¤×•×© (Search Flow)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../workflows/search-flow.html#id1">×¡×§×™×¨×” ×›×œ×œ×™×ª</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/search-flow.html#id2">×¡×•×’×™ ×—×™×¤×•×©</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/search-flow.html#id3">×–×¨×™××ª ×¢×‘×•×“×”</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/search-flow.html#searchindex">××‘× ×” SearchIndex</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/search-flow.html#id4">×¤×™×œ×˜×¨×™×</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/search-flow.html#regex">×˜×™×¤×•×œ ×‘×©×’×™××•×ª Regex</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/search-flow.html#id5">××™×•×Ÿ ×ª×•×¦××•×ª</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/search-flow.html#relevance-score">×—×™×©×•×‘ Relevance Score</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/search-flow.html#edge-cases">Edge Cases</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/search-flow.html#id6">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../workflows/refactor-flow.html">×–×¨×™××ª ×¨×¤×§×˜×•×¨×™× ×’ (Refactor Flow)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#id1">×¡×§×™×¨×” ×›×œ×œ×™×ª</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#id2">×¡×•×’×™ ×¨×¤×§×˜×•×¨×™× ×’</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#id3">×–×¨×™××ª ×¢×‘×•×“×”</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#telegram">×©×™××•×© ×‘×‘×•×˜ (Telegram)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#codeanalyzer">CodeAnalyzer</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#id4">×™×¦×™×¨×ª ×”×¦×¢×ª ×¨×¤×§×˜×•×¨×™× ×’</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#id5">××™××•×ª ×œ×¤× ×™ ×•××—×¨×™</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#id6">×™×™×¦×•× ×œ×’×™×¡×˜ (××•×¤×¦×™×•× ×œ×™)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#id7">×©××™×¨×ª ×’×¨×¡×”</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#edge-cases">Edge Cases</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#cohesion-policy">××“×™× ×™×•×ª ×§×™×‘×•×¥ ×•×¤×™×¦×•×œ (Cohesion Policy)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#smart-clustering-cycle-guard">Smart Clustering ×•â€‘Cycle Guard</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#safe-decomposition-models-py">Safe Decomposition ×œâ€‘models.py</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#canonical">×©××•×ª ×§×‘×¦×™× ×“×•××™×™× ×™×™× (Canonical)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#layered">××¦×‘ ×©×›×‘×•×ª (Layered)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#id8">×¤×¨××˜×¨×™× × ×™×ª× ×™× ×œ×›×•×•× ×•×Ÿ</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#id9">××’×‘×œ×•×ª ×™×“×•×¢×•×ª</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#id10">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../workflows/backup-flow.html">×–×¨×™××ª ×’×™×‘×•×™ ×•×©×—×–×•×¨ (Backup Flow)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../workflows/backup-flow.html#id1">×¡×§×™×¨×” ×›×œ×œ×™×ª</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/backup-flow.html#id2">×¡×•×’×™ ×’×™×‘×•×™×™×</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/backup-flow.html#id3">×™×¦×™×¨×ª ×’×™×‘×•×™ ××œ×</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/backup-flow.html#id4">×©×—×–×•×¨ ××’×™×‘×•×™</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/backup-flow.html#google-drive">×’×™×‘×•×™ ×œ-Google Drive</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/backup-flow.html#id5">× ×™×”×•×œ ×’×™×‘×•×™×™×</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/backup-flow.html#zip">×™×™×‘×•× ZIP ×—×™×¦×•× ×™</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/backup-flow.html#edge-cases">Edge Cases</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/backup-flow.html#id6">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../workflows/index.html#id3">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">×× ×•×¢×™ ×”××¢×¨×›×ª:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../engines/overview.html">×× ×•×¢×™ ×”××¢×¨×›×ª (System Engines)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../engines/overview.html#id1">×¡×§×™×¨×” ×›×œ×œ×™×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../engines/overview.html#search-engine">×× ×•×¢ ×—×™×¤×•×© (Search Engine)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../engines/overview.html#refactoring-engine">×× ×•×¢ ×¨×¤×§×˜×•×¨×™× ×’ (Refactoring Engine)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../engines/overview.html#smart-clustering-cycle-guard">×™×›×•×œ×•×ª ××ª×§×“××•×ª (Smart Clustering, Cycle Guard)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../engines/overview.html#layered-mode">××¦×‘ ×©×›×‘×•×ª (Layered Mode)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../engines/overview.html#safe-decomposition-models-py-models">Safe Decomposition ×œâ€‘models.py (×¤×™×¦×•×œ ×‘×˜×•×— ×œ×—×‘×™×œ×ª models/)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../engines/overview.html#code-processor">××¢×‘×“ ×§×•×“ (Code Processor)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../engines/overview.html#code-analyzer">×× ×•×¢ × ×™×ª×•×— (Code Analyzer)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../engines/overview.html#backup-service">×× ×•×¢ ×’×™×‘×•×™×™× (Backup Service)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../engines/overview.html#integration-services">×× ×•×¢ ××™× ×˜×’×¨×¦×™×•×ª (Integration Services)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../engines/overview.html#observability">×× ×•×¢ Observability</a></li>
<li class="toctree-l2"><a class="reference internal" href="../engines/overview.html#id2">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Edge Cases ×•×˜×™×¤×•×œ ×‘×©×’×™××•×ª:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../edge-cases.html">Edge Cases ×•×˜×™×¤×•×œ ×‘×©×’×™××•×ª</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../edge-cases.html#id1">×¡×§×™×¨×” ×›×œ×œ×™×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../edge-cases.html#id2">×§×‘×¦×™× ×’×“×•×œ×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../edge-cases.html#id3">×§×™×“×•×“×™× ×œ× ×¡×˜× ×“×¨×˜×™×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../edge-cases.html#github-rate-limits">GitHub Rate Limits</a></li>
<li class="toctree-l2"><a class="reference internal" href="../edge-cases.html#mongodb-connection-errors">MongoDB Connection Errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../edge-cases.html#redis-unavailability">Redis Unavailability</a></li>
<li class="toctree-l2"><a class="reference internal" href="../edge-cases.html#parsing">×©×’×™××•×ª Parsing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../edge-cases.html#file-i-o">×©×’×™××•×ª File I/O</a></li>
<li class="toctree-l2"><a class="reference internal" href="../edge-cases.html#network">×©×’×™××•×ª Network</a></li>
<li class="toctree-l2"><a class="reference internal" href="../edge-cases.html#validation">×©×’×™××•×ª Validation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../edge-cases.html#concurrent-access">×©×’×™××•×ª Concurrent Access</a></li>
<li class="toctree-l2"><a class="reference internal" href="../edge-cases.html#best-practices">Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../edge-cases.html#id4">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">××™×›×•×ª ×•×§×•× ×‘× ×¦×™×•×ª:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quality/type-safety.html">ğŸ“ Type Hints â€“ Best Practices</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../quality/type-safety.html#id1">××¡×˜×¨×˜×’×™×”: ×”×§×©×—×” ×”×“×¨×’×ª×™×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quality/type-safety.html#id2">×¤×¨×•×˜×•×§×•×œ×™× ×•×¡×˜××‘×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quality/type-safety.html#id3">×“×•×’×××•×ª ××”×§×•×“</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quality/type-safety.html#mypy">×”×’×“×¨×•×ª MyPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quality/type-safety.html#id4">××¡×œ×•×œ ××™×’×¨×¦×™×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quality/type-safety.html#id5">×”× ×—×™×•×ª ×œ×¡×•×›× ×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quality/type-safety.html#id6">×“×•×’×××•×ª ×§×¦×¨×•×ª</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../quality/code-normalization.html">× ×¨××•×œ ×§×•×“ (Code Normalization)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../quality/code-normalization.html#id1">×œ××” ×‘×›×œ×œ ×× ×¨××œ×™×?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quality/code-normalization.html#id2">××ª×™ ×•××™×¤×” ×”×× ×’× ×•×Ÿ ×¨×¥?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quality/code-normalization.html#id3">××” ×‘×“×™×•×§ ×§×•×¨×” ×‘××”×œ×š ×”× ×¨××•×œ?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quality/code-normalization.html#api">××™×š ×œ×‘×—×•×¨ API?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quality/code-normalization.html#id4">×“×’×©×™× ×œ×¡×•×›× ×™× ×‘×¢×ª ×›×ª×™×‘×ª ×§×•×“</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quality/code-normalization.html#id5">×˜×¡×˜×™×, ×“×™×‘×•×’ ×•×©×—×–×•×¨ ×ª×§×œ×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quality/code-normalization.html#id6">×©××œ×•×ª × ×¤×•×¦×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quality/code-normalization.html#id7">××” ×œ×¢×©×•×ª ×›×©××•×¡×™×¤×™× ×–×¨×™××” ×—×“×©×”?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quality/code-normalization.html#id8">×§×™×©×•×¨×™× ×¨×œ×•×•× ×˜×™×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ARCHITECTURE_LAYER_RULES.html">×›×œ×œ×™ ×©×›×‘×•×ª â€“ CodeBot</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../ARCHITECTURE_LAYER_RULES.html#id1">×©×›×‘×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ARCHITECTURE_LAYER_RULES.html#composition-root">Composition Root</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ARCHITECTURE_LAYER_RULES.html#id2">×–×™×”×•×™ ×©×¤×” â€“ ××§×•×¨ ×××ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ARCHITECTURE_LAYER_RULES.html#id3">×‘×“×™×§×•×ª ××›×™×¤×”</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">WebApp:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../webapp/overview.html">×”××™× ×™ Web App (×¡×§×™×¨×”)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/overview.html#id1">××” × ×•×ª×Ÿ?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/overview.html#id2">×“×©×‘×•×¨×“ ×—×“×©</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../webapp/overview.html#id3">××™×™×§×•× ×™ ×©×¤×” ××—×™×“×™×</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../webapp/overview.html#id4">×˜×‘×œ×ª ××™×™×§×•× ×™× × ×¤×•×¦×™×</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/overview.html#ai">×”× ×—×™×•×ª ×œ×¡×•×›× ×™ AI</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/overview.html#id5">×›×ª×•×‘×ª ×•×”×¨×©××•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/overview.html#env">×”×’×“×¨×•×ª ENV</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/overview.html#id6">×§×™×©×•×¨×™× ×•×ª××•× ×•×ª ××¡×š</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/overview.html#id7">×¨××• ×’×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/overview.html#id8">×‘×× ×¨ ×”×›×¨×–×•×ª ×‘×¨××© ×”××¡×š</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../webapp/overview.html#id9">××™×š ××¤×¢×™×œ×™×?</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/overview.html#id10">×”×¢×¨×•×ª ×•×§×™×©×•×¨×™×</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/overview.html#id11">××” ×§×•×¨×” ×××—×•×¨×™ ×”×§×œ×¢×™×?</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/overview.html#id12">×›×™×‘×•×™ ×–×× ×™</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/overview.html#id13">×”××œ×¦×•×ª ×œ×ª×•×›×Ÿ</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../DEV_WEB_PUSH.html">Web Push â€“ Sticky Notes Reminders</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../DEV_WEB_PUSH.html#id1">×“×¨×™×©×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../DEV_WEB_PUSH.html#vapid">×”×’×“×¨×ª ××¤×ª×—×•×ª VAPID</a></li>
<li class="toctree-l2"><a class="reference internal" href="../DEV_WEB_PUSH.html#id2">×”×¤×¢×œ×”/×›×™×‘×•×™</a></li>
<li class="toctree-l2"><a class="reference internal" href="../DEV_WEB_PUSH.html#remote-worker">××¦×‘ Remote Worker (××•××œ×¥ ×œ×¤×¨×•×“×§×©×Ÿ)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../DEV_WEB_PUSH.html#sidecar-render">×—×œ×•×¤×”: Sidecar (×œ×œ× ×©×™×¨×•×ª Render × ×•×¡×£)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../DEV_WEB_PUSH.html#server">× ×§×•×“×•×ª ×§×¦×” (Server)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../DEV_WEB_PUSH.html#service-worker">Service Worker</a></li>
<li class="toctree-l2"><a class="reference internal" href="../DEV_WEB_PUSH.html#id3">×¦×“â€‘×œ×§×•×—</a></li>
<li class="toctree-l2"><a class="reference internal" href="../DEV_WEB_PUSH.html#id4">×©×œ×™×—×” ×‘×–××Ÿ ×××ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../DEV_WEB_PUSH.html#id5">×‘×“×™×§×•×ª</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/user-interfaces.html">×××©×§×™ ××©×ª××©×™× (Web)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/user-interfaces.html#id1">××” ×–×”?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/user-interfaces.html#id2">×”×™×›×Ÿ ×–×” × ××¦×?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/user-interfaces.html#id3">×–×¨×™××ª ×¢×‘×•×“×” ×“×¨×š ×”×‘×•×˜</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/user-interfaces.html#id4">×©×“×•×ª ×—×•×‘×” ×•×œ×•×’×™×§×ª ×•×œ×™×“×¦×™×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/user-interfaces.html#id5">×—×™×•×•×™ ××¦×‘ ×ª×”×œ×™×š</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/user-interfaces.html#id6">×××©×§ ××“××™×Ÿ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/user-interfaces.html#ai">×“×•×’×××•×ª ×©×™××•×© ×œ×¡×•×›× ×™ AI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/user-interfaces.html#id7">××‘×˜×—×” ×•×¤×¨×˜×™×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/user-interfaces.html#id8">×”×¢×¨×•×ª ×ª××™××•×ª</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/snippet-library.html">×¡×¤×¨×™×™×ª ×¡× ×™×¤×˜×™× (Web)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/snippet-library.html#id1">××” ×–×”?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/snippet-library.html#ui">×××¤×™×™× ×™ UI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/snippet-library.html#api-json">API â€“ JSON</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../webapp/snippet-library.html#openapi">OpenAPI (×ª×§×¦×™×¨)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/snippet-library.html#json-schema-response">JSON Schema (Response)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/snippet-library.html#id2">×›×œ×œ×™ ×“×¤×“×•×£/×¡×¤×™×¨×”</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/snippet-library.html#id3">×©×’×™××•×ª</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/snippet-library.html#curl">×“×•×’×××•×ª cURL</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/snippet-library.html#id4">×”×’×©×•×ª, ××™×©×•×¨ ×•× ×™×”×•×œ (××“××™×Ÿ)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/snippet-library.html#id5">×™×™×‘×•× ××¡××š (××“××™×Ÿ)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/snippet-library.html#id6">×”×’×©×” ×“×¨×š ×”×‘×•×˜</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/snippet-library.html#id7">UI ×‘×‘×•×˜ â€“ ×”×¡×¨×•×ª ×•×©×™×¤×•×¨×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/snippet-library.html#id8">×’×¨×¡×” ××©×•×“×¨×’×ª â€“ ××” ×—×“×©</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/snippet-library.html#ai">××“×¨×™×š ×§×¦×¨ ×œ×¡×•×›× ×™ AI</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/onboarding.html">ğŸ§­ WebApp Onboarding â€“ Welcome Modal, Interactive Tour &amp; Theme Wizard</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/onboarding.html#id1">×¨×›×™×‘×™× ×•××” ×”× ×¢×•×©×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/onboarding.html#id2">×ª×¨×©×™× ××™× ×˜×¨××§×¦×™×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/onboarding.html#welcome-modal">Welcome Modal â€“ ×¨×¢× ×•×Ÿ ×§×¦×¨</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../webapp/onboarding.html#id3">××˜×¨×•×ª</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/onboarding.html#id4">×–×¨×™××ª ××©×ª××©</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/onboarding.html#id5">×¡× ×›×¨×•×Ÿ ×œ××“×¨×™×š ×”×¢×“×›× ×™</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../webapp/onboarding.html#id6">××™×š ×œ×¢×“×›×Ÿ</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/onboarding.html#anchors">×§×™×©×•×¨×™ ××“×¨×™×›×™× (Anchors)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/onboarding.html#best-practices">Best Practices â€“ ×¡×™××•×Ÿ ××©×ª××©×™× ×—×“×©×™×</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/onboarding.html#js-ajax">×“×•×’××ª JS â€“ ××•×“××œ ×¢× Ajax</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/onboarding.html#api">API ×§×©×•×¨</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/onboarding.html#interactive-tour-driver-js">Interactive Tour (Driver.js)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../webapp/onboarding.html#id7">××ª×™ ×”×¡×™×•×¨ × ×¤×ª×—?</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/onboarding.html#id8">×©×œ×‘×™ ×”×¡×™×•×¨</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/onboarding.html#id9">×”×¤×¢×œ×” ×™×“× ×™×ª ×•××™×¤×•×¡</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/onboarding.html#id10">×ª×—×–×•×§×” ×œ××¤×ª×—×™×</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/onboarding.html#troubleshooting">Troubleshooting â€“ â€×œ××” ×”×¡×™×•×¨ ×œ× ××•×¤×™×¢?â€œ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/onboarding.html#gif">×¦×™×œ×•××™ ××¡×š / GIF</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/onboarding.html#theme-picker-wizard-personalization">Theme Picker Wizard (Personalization)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../webapp/onboarding.html#id11">×¡×§×™×¨×” ×›×œ×œ×™×ª</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/onboarding.html#id12">×˜×¨×™×’×¨×™× ×•×”×’× ×•×ª</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/onboarding.html#id13">×××©×§ ×•×—×•×•×™×™×ª ××©×ª××©</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/onboarding.html#id14">×”×ª××“×” ×•×¡× ×›×¨×•×Ÿ ×©×¨×ª</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/onboarding.html#debugging-reset">ğŸ› ï¸ Debugging &amp; Reset</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/onboarding.html#qa">××“×¨×™×š ×‘×“×™×§×•×ª (QA)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/onboarding.html#id15">×¦×™×œ×•××™ ××¡×š</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/onboarding.html#id16">×§×™×©×•×¨×™× ×¨×œ×•×•× ×˜×™×™×</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/onboarding.html#id17">Troubleshooting ××¨×•×›×– â€“ â€×œ××” ×©×•× ×“×‘×¨ ×œ× ×§×•×¤×¥ ×œ×™?â€œ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/onboarding.html#id18">××“×™×” ×•×”×¨×—×‘×•×ª</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/caching.html">Caching &amp; HTTP Validators (ETag / Last-Modified / 304)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#id1">×œ××” ×–×” ×—×©×•×‘?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#id2">×¢×§×¨×•× ×•×ª ×‘×¡×™×¡</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#flask-werkzeug">××ª×›×•×Ÿ: Flask + werkzeug</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#copypaste">×‘×“×™×§×•×ª ×™×“× ×™×•×ª (Copyâ€‘Paste)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#checklist">Checklist ×œ××™××•×© × ×›×•×Ÿ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#gotchas">Gotchas × ×¤×•×¦×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#cache-control">×©×™×œ×•×‘ ×¢× Cache-Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#id3">×§×™×©×•×¨×™× × ×•×¡×¤×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/advanced-caching.html">××¢×¨×›×ª Caching ××ª×§×“××ª ×¢× TTL ×“×™× ××™</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/advanced-caching.html#id1">×¢×§×¨×•× ×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/advanced-caching.html#id2">×§×•×“ ×œ×“×•×’××”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/advanced-caching.html#id3">×“×’×©×™× ×ª×¤×¢×•×œ×™×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/advanced-caching.html#warmup-frontend">Warmup ×œ× ×›×¡×™ Frontend</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/advanced-caching.html#id4">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/static-checklist.html">Static Performance &amp; Security Checklist (gzip/br, Cache, SRI)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/static-checklist.html#id1">××˜×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/static-checklist.html#br-gzip">×“×—×™×¡×” (br/gzip)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/static-checklist.html#cache-control">×›×•×ª×¨×•×ª Cache-Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/static-checklist.html#subresource-integrity-sri">Subresource Integrity (SRI)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/static-checklist.html#copypaste">×‘×“×™×§×•×ª ×™×“× ×™×•×ª (Copyâ€‘Paste)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/static-checklist.html#best-practices">Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/static-checklist.html#gotchas">Gotchas</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/commands-catalog.html">×ª×—×–×•×§×ª ×§×˜×œ×•×’ ×”×¤×§×•×“×•×ª (<code class="docutils literal notranslate"><span class="pre">commands.json</span></code>)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/commands-catalog.html#id1">××‘×•×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/commands-catalog.html#schema">××‘× ×” ×”× ×ª×•× ×™× (Schema)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/commands-catalog.html#json">×“×•×’××ª JSON</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/commands-catalog.html#taxonomy">×”× ×—×™×•×ª ×¡×™×•×•×’ (Taxonomy)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../webapp/commands-catalog.html#id2">×˜×™×¤×™× ×œ×–×™×”×•×™ ××•×˜×•××˜×™</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/commands-catalog.html#id3">×¦â€™×§-×œ×™×¡×˜ ×œ×”×•×¡×¤×ª ×¤×§×•×“×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/commands-catalog.html#id4">×‘×“×™×§×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/commands-catalog.html#id5">×›×¨×˜×™×¡×™×•×ª ×—×“×©×•×ª (×“×¦×Â« 2025)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/api-reference.html">WebApp API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/api-reference.html#endpoints">Endpoints</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/api-reference.html#authentication-flow">Authentication Flow</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/api-reference.html#response-schema-example">Response Schema Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/api-reference.html#errors">Errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/api-reference.html#post-api-shared-save">×©×’×™××•×ª × ×¤×•×¦×•×ª â€“ <code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/api/shared/save</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/api-reference.html#id1">×§×™×©×•×¨×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/api-reference.html#files">××¡× ×Ÿ ×•×©×“×•×ª ×§×œ×˜ ×œ-<code class="docutils literal notranslate"><span class="pre">/files</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../webapp/api-reference.html#id2">×˜×‘×œ×ª ×¤×¨××˜×¨×™×</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/api-reference.html#id3">×“×•×’×××•×ª ×‘×§×©×”</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/api-reference.html#id4">×“×•×’×××•×ª ×ª×’×•×‘×”</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/bulk-actions.html">Bulk actions (×‘×—×™×¨×” ××¨×•×‘×”)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/bulk-actions.html#id1">×¡×§×™×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/bulk-actions.html#endpoints">Endpoints</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../webapp/bulk-actions.html#post-api-files-bulk-favorite"><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/api/files/bulk-favorite</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/bulk-actions.html#post-api-files-bulk-unfavorite"><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/api/files/bulk-unfavorite</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/bulk-actions.html#post-api-files-bulk-tag"><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/api/files/bulk-tag</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/bulk-actions.html#post-api-files-create-zip"><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/api/files/create-zip</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/bulk-actions.html#post-api-files-bulk-delete-soft-delete"><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/api/files/bulk-delete</span></code> (Soft Delete)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/bulk-actions.html#post-api-files-create-share-link"><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/api/files/create-share-link</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/bulk-actions.html#id2">×©×’×™××•×ª × ×¤×•×¦×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/bulk-actions.html#id3">×”×¢×¨×•×ª ×œ××¤×ª×—×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/editor.html">âŒ¨ï¸ ×¢×•×¨×š ×§×•×“ (WebApp Editor)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/editor.html#codemirror-isloading">×˜×¢×™× ×ª CodeMirror ×•××¦×‘ isLoading</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/editor.html#api">×©××™×¨×ª ×”×¢×“×¤×•×ª ××©×ª××© â€“ ×©× ×™ × ×ª×™×‘×™ API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/editor.html#id1">×”××œ×¦×•×ª</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/markdown-folding.html">Markdown â€“ ××¦×‘ ××¦×•××¦× (×§×™×¤×•×œ ×›×•×ª×¨×•×ª ###) â€“ ××“××™×Ÿ ×‘×œ×‘×“</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/markdown-folding.html#id1">×××¤×™×™× ×™× ×¢×™×§×¨×™×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/markdown-folding.html#id2">×”×–×¨×§×ª ×“×’×œ ×”×¨×©××” ×œ×ª×‘× ×™×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/markdown-folding.html#id3">×¢×§×¨×•× ×•×ª ×”××™××•×© ×‘×¦×“ ×”×œ×§×•×—</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/markdown-folding.html#id4">×¦â€™×§â€‘×œ×™×¡×˜ ×œ×¤×™×¦â€™×¨×™× ××§×•××™×™× ×“×•××™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/smooth-scrolling.html">Smooth Scrolling (WebApp) â€” ××“×¨×™×š ×ª××¦×™×ª×™ ×œ×¡×•×›× ×™ AI</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/smooth-scrolling.html#id1">××” ×¤×¢×™×œ ×›×‘×¨</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/smooth-scrolling.html#api">API ×œ×©×™××•×© ×§×œ×™×™× ×˜</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/smooth-scrolling.html#id2">×©××™×¨×ª ×”×¢×“×¤×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/smooth-scrolling.html#id3">×××©×§ ×”×’×“×¨×•×ª ××•×‘× ×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/smooth-scrolling.html#ai">×”× ×—×™×•×ª ×œ×¡×•×›× ×™ AI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/smooth-scrolling.html#id4">×× ×“×¨×•××™×“ â€” ××” ×™×© ×•××” ×œ×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/smooth-scrolling.html#id5">× ×’×™×©×•×ª ×•×‘×™×¦×•×¢×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/smooth-scrolling.html#id6">×¤×ª×¨×•×Ÿ ×ª×§×œ×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/smooth-scrolling.html#roadmap">×ª×•×›× ×™×ª ×”××©×š (Roadmap ××§×•×¦×¨)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/smooth-scrolling.html#id7">×§×™×©×•×¨×™× ×¤× ×™××™×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/system-modules.html">××•×“×•×œ×™× ×¤× ×™××™×™× ×‘-WebApp</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/system-modules.html#activity-tracker-py"><code class="docutils literal notranslate"><span class="pre">activity_tracker.py</span></code> â€“ ×“×’×™××ª ×¤×¢×™×œ×•×ª ××©×ª××©×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/system-modules.html#community-library-api-py-rest"><code class="docutils literal notranslate"><span class="pre">community_library_api.py</span></code> â€“ REST ×¢×‘×•×¨ ××•×¡×£ ×”×§×”×™×œ×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/system-modules.html#community-library-ui-py-web"><code class="docutils literal notranslate"><span class="pre">community_library_ui.py</span></code> â€“ ×ª×¦×•×’×ª Web</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/system-modules.html#snippet-library-api-py-snippet-library-ui-py"><code class="docutils literal notranslate"><span class="pre">snippet_library_api.py</span></code> ×•-<code class="docutils literal notranslate"><span class="pre">snippet_library_ui.py</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/system-modules.html#push-api-py-web-push-subscriptions"><code class="docutils literal notranslate"><span class="pre">push_api.py</span></code> â€“ Web Push Subscriptions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/system-modules.html#workspace-api-py-kanban-workspaces"><code class="docutils literal notranslate"><span class="pre">workspace_api.py</span></code> â€“ × ×™×”×•×œ Kanban (Workspaces)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/system-modules.html#config-radar-py"><code class="docutils literal notranslate"><span class="pre">config_radar.py</span></code> â€“ ×¨× ×˜×’×Ÿ ×§×•× ×¤×™×’×•×¨×¦×™×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/system-modules.html#id2">××™×š ×œ×”×©×ª××© ×‘×¢××•×“ ×–×”</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Frontend &gt; Theming</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../webapp/theming_and_css.html">××¢×¨×›×ª ×¢×¨×›×•×ª ×”× ×•×©× ×•×”×˜×•×§× ×™× ×”×—×“×©×”</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/theming_and_css.html#id3">×¨×§×¢ ×•××•×˜×™×‘×¦×™×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/theming_and_css.html#data-theme">×©×›×‘×•×ª ××©×ª× ×™× ×•×˜×¢×™× ×ª <code class="docutils literal notranslate"><span class="pre">data-theme</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../webapp/theming_and_css.html#id4">×ª×¨×©×™× ×–×¨×™××ª ×”×™×¨×¨×›×™×™×ª ×˜×•×§× ×™×</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/theming_and_css.html#id5">×˜×‘×œ×ª ×˜×•×§× ×™× ×¢×™×§×¨×™×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/theming_and_css.html#theme-reference">××¤×ª ×¢×¨×›×•×ª ×”× ×•×©× (Theme Reference)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/theming_and_css.html#markdown-viewer-split-view">Markdown Viewer ×•â€‘Split View</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/theming_and_css.html#best-practices">×”× ×—×™×•×ª ×œ××¤×ª×—×™× (Best Practices)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../webapp/theming_and_css.html#id6">×“×•×’××ª ×§×•×“ â€“ ×œ× ×ª×§×™×Ÿ ×œ×¢×•××ª ×ª×§×™×Ÿ</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/theming_and_css.html#component-tokens-theme-builder">Component Tokens ×•â€‘Theme Builder</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/theming_and_css.html#merge">×‘×“×™×§×•×ª ×—×•×‘×” ×œ×¤× ×™ Merge</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/theming_and_css.html#id7">×©×™××•×©×™× × ×•×¡×¤×™× ×•×—×¨×™×’×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/theming_and_css.html#id8">×§×™×©×•×¨×™× ×•× ×¡×¤×—×™×</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Observability</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../observability.html">××•×‘×–×¨×•×•×‘×™×œ×™×•×ª (Observability)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../observability.html#id1">××˜×¨×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability.html#id2">×§×”×œ×™ ×™×¢×“</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability.html#id3">×ª×¦×•×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability.html#backend-traces">×‘×—×™×¨×ª Backend ×œÖ¾Traces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability.html#otlp">×”×’×“×¨×ª OTLP ×œ×¡×‘×™×‘×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability.html#id4">×§×™×©×•×¨×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability.html#manual-instrumentation">××™× ×¡×˜×¨×•×× ×˜×¦×™×” ×™×“× ×™×ª (Manual Instrumentation)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability.html#jaeger">×“×•×§×¨ ×§×•××¤×•×– â€“ ×”×¤×¢×œ×” ××”×™×¨×” ×¢× Jaeger</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../observability.html#quick-start-jaeger">Quick start â€“ ××™××•×ª ×¡×¤×× ×™× ×‘Ö¾Jaeger</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../observability.html#traced">×›×™×¡×•×™ ×“×§×•×¨×˜×•×¨ &#64;traced</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability.html#staging">××™××•×ª ×‘-Staging</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../observability/observability_dashboard.html">ğŸ“¡ Observability Dashboard &amp; API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../observability/observability_dashboard.html#admin-observability">ğŸ–¥ï¸ ×¡×§×™×¨×ª ×”×××©×§ <code class="docutils literal notranslate"><span class="pre">/admin/observability</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../observability/observability_dashboard.html#id1">×—×œ×•×§×ª ×”×“×£</a></li>
<li class="toctree-l3"><a class="reference internal" href="../observability/observability_dashboard.html#id2">×™×›×•×œ×•×ª ×¡×™× ×•×Ÿ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../observability/observability_dashboard.html#ui">××§×¨× ×•Ö¾UI</a></li>
<li class="toctree-l3"><a class="reference internal" href="../observability/observability_dashboard.html#ai">ğŸ¤– ×”×¡×‘×¨ AI ×œ×”×ª×¨××•×ª</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../observability/observability_dashboard.html#api-reference">ğŸ“š API Reference</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../observability/observability_dashboard.html#id3">×¤×¨××˜×¨×™ ×–××Ÿ ××©×•×ª×¤×™×</a></li>
<li class="toctree-l3"><a class="reference internal" href="../observability/observability_dashboard.html#get-api-observability-alerts"><code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/api/observability/alerts</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../observability/observability_dashboard.html#meta-high-error-rate">Meta ××•×¢×©×¨ ×œ×”×ª×¨××•×ª High Error Rate</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../observability/observability_dashboard.html#get-api-observability-aggregations"><code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/api/observability/aggregations</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../observability/observability_dashboard.html#get-api-observability-timeseries"><code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/api/observability/timeseries</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../observability/observability_dashboard.html#get-api-observability-replay"><code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/api/observability/replay</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../observability/observability_dashboard.html#runbooks-quick-fix">Runbooks ×“×™× ××™×™× + Quick Fix</a></li>
<li class="toctree-l3"><a class="reference internal" href="../observability/observability_dashboard.html#get-api-observability-export"><code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/api/observability/export</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../observability/observability_dashboard.html#post-api-observability-quickfix-track"><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/api/observability/quickfix/track</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../observability/observability_dashboard.html#post-api-observability-alerts-ai-explain"><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/api/observability/alerts/ai_explain</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../observability/observability_dashboard.html#rate-limiting">ğŸ” ××‘×˜×—×”, Rate Limiting ×•×§××©</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/observability_dashboard.html#id4">ğŸ”Œ ××™× ×˜×’×¨×¦×™×•×ª ×•×“×•×’×××•×ª ×©×™××•×©</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../observability/observability_dashboard.html#grafana-bi">Grafana / BI</a></li>
<li class="toctree-l3"><a class="reference internal" href="../observability/observability_dashboard.html#slack-on-call-bot">Slack / On-call Bot</a></li>
<li class="toctree-l3"><a class="reference internal" href="../observability/observability_dashboard.html#config-radar">×©×™×œ×•×‘ ×¢× Config Radar</a></li>
<li class="toctree-l3"><a class="reference internal" href="../observability/observability_dashboard.html#readme">×¨×¤×¨× ×¡ ×œÖ¾README</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../observability/observability_dashboard.html#id5">âœ”ï¸ ××” ×”×œ××”?</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../observability/quick_fix_rules.html">ğŸ§  Quick Fix ×—×›× (Queue Delay + ×¢×•××¡/DB) â€“ ×”× ×—×™×•×ª ×œ××¤×ª×—×™× ×•×œ×¡×•×›× ×™ AI</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../observability/quick_fix_rules.html#id1">××™×¤×” ×–×” ××•×¤×™×¢</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/quick_fix_rules.html#id2">××§×•×¨ ×××ª: ××™×¤×” ×”×—×•×§×™× ×—×™×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/quick_fix_rules.html#latency-slow-response">×˜×‘×œ×ª ×”×—×œ×˜×” (Latency / Slow Response)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/quick_fix_rules.html#id3">××™×œ×• ×©×“×•×ª ×× ×—× ×• ××©×ª××©×™× ×‘×”× (×¡×›××ª × ×ª×•× ×™×)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../observability/quick_fix_rules.html#id4">××•×ª×•×ª ×¢×™×§×¨×™×™×</a></li>
<li class="toctree-l3"><a class="reference internal" href="../observability/quick_fix_rules.html#id5">×¢×•××¡ ×•××©××‘×™×</a></li>
<li class="toctree-l3"><a class="reference internal" href="../observability/quick_fix_rules.html#db-pool-utilization">â€œDB Pool utilizationâ€</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../observability/quick_fix_rules.html#safety">×¢×§×¨×•× ×•×ª Safety (×—×©×•×‘)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/quick_fix_rules.html#ai">××™×š ×œ×”×•×¡×™×£/×œ×©× ×•×ª ×—×•×§ (×¦â€™×§×œ×™×¡×˜ ×œ××¤×ª×—×™× ×•×œâ€‘AI)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/quick_fix_rules.html#id6">×”×¢×¨×•×ª ×œ×¡×•×›× ×™ AI (××™×š ×œ×¢×‘×•×“ × ×›×•×Ÿ)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../observability/coverage_report.html">Coverage Report (Runbooks / Quick Fixes)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../observability/coverage_report.html#id1">××˜×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/coverage_report.html#catalog-registry">××§×•×¨ ×”×××ª (Catalog / Registry)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/coverage_report.html#matching">×”×’×“×¨×•×ª ×›×™×¡×•×™ (Matching)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../observability/coverage_report.html#runbooks">Runbooks</a></li>
<li class="toctree-l3"><a class="reference internal" href="../observability/coverage_report.html#quick-fixes">Quick Fixes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../observability/coverage_report.html#id2">××” ××•×¦×’ ×‘×“×•×—</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/coverage_report.html#api">API</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../api/ai_explain.html">ğŸ§  Observability AI Explain API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../api/ai_explain.html#id1">ğŸ” ××™××•×ª ×•×‘×§×¨×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/ai_explain.html#post-api-ai-explain">ğŸ“¥ ×‘×§×©×” (<code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/api/ai/explain</span></code>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/ai_explain.html#ok">ğŸ“¤ ×ª×’×•×‘×” ××•×¦×œ×—×ª (<code class="docutils literal notranslate"><span class="pre">200</span> <span class="pre">OK</span></code>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/ai_explain.html#id2">â— ×§×•×“×™ ×©×’×™××”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/ai_explain.html#id3">âš™ï¸ ×§×•× ×¤×™×’×•×¨×¦×™×” × ×“×¨×©×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/ai_explain.html#id4">ğŸ§ª ×‘×“×™×§×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/ai_explain.html#id5">ğŸ“ ×˜×™×¤×™× ×œ×¤×¨×™×¡×”</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../rate-limiting.html">Rate Limiting</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../rate-limiting.html#id1">××‘×•×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rate-limiting.html#shadow-mode">Shadow Mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rate-limiting.html#softwarning-80">Softâ€‘Warning (80%)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rate-limiting.html#admin-bypass">Admin Bypass</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rate-limiting.html#monitoring">Monitoring</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rate-limiting.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rate-limiting.html#id2">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../observability/guidelines.html">ğŸ“Š ×”× ×—×™×•×ª Observability ×•××™×¨×•×¢×™×</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../observability/guidelines.html#id1">×ª×‘× ×™×ª ××™×¨×•×¢/×œ×•×’ â€“ ×©×“×•×ª ×—×•×‘×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/guidelines.html#fail-open">×¢×§×¨×•×Ÿ Fail-Open</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/guidelines.html#id2">×”× ×—×™×•×ª ×˜×™×¤×•×œ ×‘×©×’×™××•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/guidelines.html#request-id">×§×•×¨×œ×¦×™×” ×¢× request_id</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/guidelines.html#id3">×¡×˜× ×“×¨×˜×™× × ×•×¡×¤×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../logging_schema.html">×¡×›××ª ×œ×•×’×™× ×•××™×¨×•×¢×™× (Observability)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../logging_schema.html#id1">×©×“×•×ª ×—×•×‘×” ×‘×›×œ ××™×¨×•×¢</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logging_schema.html#id2">×©×“×•×ª ××•××œ×¦×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logging_schema.html#id3">××™×¨×•×¢×™× ××¨×›×–×™×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logging_schema.html#sampling">×“×’×™××” (Sampling)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logging_schema.html#id4">×¤×¨×˜×™×•×ª</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../metrics.html">××“×“×™× (Metrics)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../metrics.html#id1">× ×§×•×“×ª ×§×¦×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metrics.html#id2">××˜×¨×™×§×•×ª ×§×™×™××•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metrics.html#codebot-handlers-commands-db">××“×“×™ CodeBot ×™×™×¢×•×“×™×™× (Handlers/Commands/DB)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metrics.html#opentelemetry">××˜×¨×™×§×•×ª OpenTelemetry (×× ×–××™× ×•×ª)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metrics.html#promql">×“×•×’×××•×ª PromQL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metrics.html#tracing-grafana">Tracing ×‘-Grafana</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metrics.html#slo-sli">SLO/SLI ×œ×“×•×’××”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metrics.html#prometheus-alerting-rules">×”×ª×¨××•×ª (Prometheus alerting rules)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../resilience.html">Resilience ×œ×©×™×¨×•×ª×™× ×—×™×¦×•× ×™×™×</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../resilience.html#id1">×œ××” ×©×›×‘×” ××¨×•×›×–×ª?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../resilience.html#id2">××™×š ×–×” ×¢×•×‘×“?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../resilience.html#env">×§×•× ×¤×™×’×•×¨×¦×™×” ×—×©×•×‘×” (ENV)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../resilience.html#id3">×˜×™×¤</a></li>
<li class="toctree-l2"><a class="reference internal" href="../resilience.html#id4">×©×™××•×© ×‘×§×•×“</a></li>
<li class="toctree-l2"><a class="reference internal" href="../resilience.html#id5">×¨××• ×’×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../alerts.html">×”×ª×¨××•×ª (Alerts)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../alerts.html#id1">×¡×§×™×¨×” ××”×™×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../alerts.html#id2">×—×•×§×™ ×‘×¨×™×¨×ª ×”××—×“×œ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../alerts.html#id3">×”×ª×××” ×œ×¦×¨×›×™× ×©×œ×š</a></li>
<li class="toctree-l2"><a class="reference internal" href="../alerts.html#health-startup-prometheus">××“×“×™ Health ×•-Startup ×œ-Prometheus</a></li>
<li class="toctree-l2"><a class="reference internal" href="../alerts.html#alert-manager">×§×•× ×¤×™×’×•×¨×¦×™×™×ª <code class="docutils literal notranslate"><span class="pre">alert_manager</span></code> ×‘××¤×œ×™×§×¦×™×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../alerts.html#id4">×˜×¢×™× ×ª ×©×™× ×•×™×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../alerts.html#id5">×‘×“×™×§×ª ×”×–×¨×™××” ×‘×§×¦×” ×”×©× ×™</a></li>
<li class="toctree-l2"><a class="reference internal" href="../alerts.html#id6">×˜×™×¤×™× ××—×¨×•× ×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../alerts.html#id7">×¨××• ×’×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../alerts.html#id8">×”×ª×¨××•×ª ××¢×¨×›×ª â€“ ×“×™×¡×§ ×›××¢×˜ ××œ×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../observability/log_based_alerts.html">×”×ª×¨××•×ª ××‘×•×¡×¡×•×ª ×œ×•×’×™× (Logâ€‘based Alerts)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#id1">××” ×–×” ×•×œ××”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#id2">×”×¨×›×™×‘×™× ×‘×§×•×“</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#id3">×§×‘×¦×™ ×§×•× ×¤×™×’</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../observability/log_based_alerts.html#config-error-signatures-yml">×“×•×’××” ××™× ×™××œ×™×ª: <code class="docutils literal notranslate"><span class="pre">config/error_signatures.yml</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../observability/log_based_alerts.html#config-alerts-yml">×“×•×’××” ××™× ×™××œ×™×ª: <code class="docutils literal notranslate"><span class="pre">config/alerts.yml</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#option-b">Option B â€“ ×—×™×‘×•×¨ ×‘×ª×•×š ×”×§×•×“ (××•××©)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../observability/log_based_alerts.html#id4">××©×ª× ×™ ×¡×‘×™×‘×”</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#option-a-sidecar">Option A â€“ Sidecar ××–×¨× ×œ×•×’×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#id5">×¡×¤×™× ×•×§×™×‘×•×¥ â€“ ×‘×¨×™×¨×•×ª ××—×“×œ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#fingerprint">××¡×˜×¨×˜×’×™×™×ª fingerprint ×•×§× ×•× ×™×§×œ×™×–×¦×™×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#id6">×¦â€™×§×œ×™×¡×˜ ×œ××¤×ª×—×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#id7">×‘×“×™×§×” ××§×•××™×ª (×¡×™××•×œ×¦×™×”)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#ai">×”× ×—×™×•×ª ×œ×¡×•×›× ×™ AI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#id8">××‘×˜×—×” ×•×¤×¨×˜×™×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#rollout">Rollout ××•××œ×¥</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#id9">×¨××• ×’×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#id10">×§×™×©×•×¨×™× ×œ×§×•×“</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#id11">×˜×§×¡×•× ×•××™×™×ª ×©×’×™××•×ª ×•×—×ª×™××•×ª</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../observability/log_based_alerts.html#id12">×ª×¨×©×™× ×–×¨×™××” ××§×•×¦×¨</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#chatops">×ª×¦×•×’×” ×‘â€‘ChatOps</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../observability/log_based_alerts.html#placeholder">×¤×œ×˜ ×œ×“×•×’××” (Placeholder)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#classify-error">×§×¨×™××ª ×”××©×š â€“ <code class="docutils literal notranslate"><span class="pre">classify_error()</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../observability/log-aggregator.html">×× ×•×¢ × ×™×ª×•×— ×œ×•×’×™× (Log Event Aggregator)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../observability/log-aggregator.html#id2">××¨×›×™×˜×§×˜×•×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log-aggregator.html#id3">×§×•× ×¤×™×’×•×¨×¦×™×” ×•×§×‘×¦×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log-aggregator.html#cli">×”×¨×¦×ª CLI ××§×•××™×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log-aggregator.html#id4">×©×™×œ×•×‘ ×‘××¢×¨×›×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log-aggregator.html#id5">×¢×‘×•×“×” ×‘×˜×•×—×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log-aggregator.html#id6">× ×™×¤×•×™ ×ª×§×œ×•×ª × ×¤×•×¥</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../sentry.html">Sentry</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../sentry.html#id1">×”×¤×¢×œ×” (××©×ª× ×™ ×¡×‘×™×‘×”)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sentry.html#telegram-observability">×”×ª×¨××•×ª ×œÖ¾Telegram ×•×œ×œ×•×— Observability</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../sentry.html#id2">××™×¤×” ×œ×”×’×“×™×¨ ××©×ª× ×™×</a></li>
<li class="toctree-l3"><a class="reference internal" href="../sentry.html#observability">××” ×¦×¨×™×š ×›×“×™ ×©×–×” ×™×•×¤×™×¢ ×‘×œ×•×— Observability</a></li>
<li class="toctree-l3"><a class="reference internal" href="../sentry.html#id3">××” ×¦×¨×™×š ×›×“×™ ×©×–×” ×™×™×©×œ×— ×œ×˜×œ×’×¨×</a></li>
<li class="toctree-l3"><a class="reference internal" href="../sentry.html#polling">Polling â€“ ××©×ª× ×™× ×¨×œ×•×•× ×˜×™×™×</a></li>
<li class="toctree-l3"><a class="reference internal" href="../sentry.html#webhook">Webhook â€“ ××‘×˜×—×” ×•×“×”-×“×•×¤×œ×™×§×¦×™×”</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../sentry.html#id4">×¢×§×¨×•× ×•×ª</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../runbooks/incident-checklist.html">Incident Checklist (Onâ€‘Call)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/incident-checklist.html#incident">×‘×¢×ª ×¤×ª×™×—×ª Incident</a></li>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/incident-checklist.html#id1">×¡×˜×˜×•×¡×™ ××¢×§×‘ ××—×™×“×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/incident-checklist.html#id2">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../runbooks/logging-levels.html">×©×™× ×•×™ ×¨××•×ª ×œ×•×’×™×</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/logging-levels.html#debug">××ª×™ ×œ×”×¢×œ×•×ª ×œ-DEBUG</a></li>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/logging-levels.html#id2">×˜×™×¤</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../runbooks/github_backup_restore.html">GitHub Backup &amp; Restore Runbook</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/github_backup_restore.html#id1">××˜×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/github_backup_restore.html#id2">×“×¨×™×©×•×ª ××§×“×™××•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/github_backup_restore.html#checkpoint-tag">×™×¦×™×¨×ª × ×§×•×“×ª ×’×™×‘×•×™ (Checkpoint Tag)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/github_backup_restore.html#zip">×™×¦×™×¨×ª ××¨×›×™×•×Ÿ ZIP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/github_backup_restore.html#id3">×©×—×–×•×¨ â€“ ×‘×“×™×§×” ××§×•××™×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/github_backup_restore.html#id4">×©×—×–×•×¨ ××œ× ×œ×¤×¨×•×“×§×©×Ÿ (×–×”×™×¨×•×ª!)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/github_backup_restore.html#id5">×©×—×–×•×¨ ×§×‘×¦×™×/×ª×™×§×™×•×ª × ×§×•×“×ª×™×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/github_backup_restore.html#id6">×˜×™×¤×™× ×•×‘×˜×™×—×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/github_backup_restore.html#id7">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../runbooks/slo.html">Runbooks â€“ SLO Incidents</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/slo.html#higherrorrate">HighErrorRate</a></li>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/slo.html#sloavailabilitybreach-99-9">SLOAvailabilityBreach (×–××™× ×•×ª &lt; 99.9%)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/slo.html#slolatencyp95breach-p95-0-5s">SLOLatencyP95Breach (P95 &gt; 0.5s)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/slo.html#db-mongodb">×ª×§×œ×ª ×”×ª×—×‘×¨×•×ª ×œâ€‘DB (MongoDB) â€“ ×§×¨×™×˜×™</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../runbooks/slo.html#id1">×¡×™××¤×˜×•××™×</a></li>
<li class="toctree-l3"><a class="reference internal" href="../runbooks/slo.html#id2">×¡×“×¨ ×¤×¢×•×œ×•×ª (×‘×§×¦×¨×”)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/slo.html#id3">××™×˜×™×•×ª/× ×¤×™×œ×” ×©×œ ×©×™×¨×•×ª ×—×™×¦×•× ×™ â€“ ×‘×™× ×•× ×™</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../runbooks/slo.html#id4">×¡×™××¤×˜×•××™×</a></li>
<li class="toctree-l3"><a class="reference internal" href="../runbooks/slo.html#id5">×¡×“×¨ ×¤×¢×•×œ×•×ª</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/slo.html#deploy-release">×‘××’ ××—×¨×™ Deploy / Release â€“ ××©×ª× ×”</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../runbooks/slo.html#id6">×¡×“×¨ ×¤×¢×•×œ×•×ª</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/slo.html#id7">×“×©×‘×•×¨×“</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">×¤×¨×™×¡×” ×•-Workers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../deployment/workers.html">×¢×•×‘×“×™ Push ×•-Edge</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../deployment/workers.html#cloudflare-worker-worker">Cloudflare Worker (<cite>/worker</cite>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../deployment/workers.html#node-push-worker-push-worker">Node Push Worker (<cite>/push_worker</cite>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../deployment/workers.html#webapp-webapp-push-api-py">×—×™×‘×•×¨ ×œ-WebApp (<cite>webapp/push_api.py</cite>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../deployment/workers.html#id2">×‘×“×™×§×•×ª ×•×¢×¦×•×ª</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ChatOps</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../chatops/overview.html">ChatOps â€“ ×¡×§×™×¨×” ×›×œ×œ×™×ª</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../chatops/overview.html#id1">×¢×§×¨×•× ×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/overview.html#id2">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../chatops/commands.html">×¤×§×•×“×•×ª ChatOps</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#ctrl-cmd-k">×›×¨×˜×™×¡×™×•×ª ×—×™×¤×•×© (Ctrl/Cmd+K)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#status">/status</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#health">/health</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#uptime">/uptime</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#system-info">/system_info</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#metrics">/metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#observe">/observe</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#observe-v">/observe -v (××¤×•×¨×˜)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#observe-vv">/observe -vv (××¤×•×¨×˜ ×××•×“)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#errors">/errors</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../chatops/commands.html#mappings">×¡×˜×˜×•×¡×™ ×ª×•×¦××•×ª (Mappings)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#alerts">/alerts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#incidents">/incidents</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#triage">/triage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#predict">/predict</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#accuracy">/accuracy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#rate-limit">/rate_limit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#enable-backoff">/enable_backoff</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#disable-backoff">/disable_backoff</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#sen">/sen</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#lang">/lang</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#lang-debug">/lang_debug</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#dm">/dm</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#silence">/silence</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#unsilence">/unsilence</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#silences">/silences</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#cache-stats">/cache_stats</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#clear-cache">/clear_cache</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#cache-warm">/cache_warm</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#cache-clear-stale">/cache_clear_stale</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#status-worker">/status_worker</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#version-history">/version_history</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../chatops/observe.html">ChatOps â€“ /observe: ×”×¨×—×‘×•×ª -v ×•- -vv</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../chatops/observe.html#id1">×ª×—×‘×™×¨ ×•×¤×¨××˜×¨×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/observe.html#id2">×“×•×’×××•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/observe.html#v">×¤×œ×˜ ×œ×“×•×’××” â€“ â€-v</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/observe.html#vv">×¤×œ×˜ ×œ×“×•×’××” â€“ â€-vv</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/observe.html#id3">×”×¢×¨×•×ª ×©×™××•×©</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/observe.html#id4">×§×™×©×•×¨×™× ×¨×œ×•×•× ×˜×™×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../chatops/ratelimit.html">×”×’×‘×œ×ª ×§×¦×‘ ×œ×¤×§×•×“×•×ª ×¨×’×™×©×•×ª</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../chatops/ratelimit.html#id2">×¢×§×¨×•× ×•×ª ××¨×›×–×™×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/ratelimit.html#id3">×©×™××•×© ×‘×“×§×•×¨×˜×•×¨</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/ratelimit.html#id4">×§×•× ×¤×™×’×•×¨×¦×™×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/ratelimit.html#id5">×©×™×œ×•×‘ ×‘×‘×•×˜</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/ratelimit.html#autodoc">Autodoc</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../chatops/playbooks.html">Playbooks â€“ ×ª×¨×—×™×©×™× × ×¤×•×¦×™×</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../chatops/playbooks.html#p95-latency">p95 Latency ×¢×œ×” ××¢×œ ×”×¡×£</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/playbooks.html#error-rate-1">Error Rate &gt; 1%</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/playbooks.html#memory-usage">Memory Usage ××˜×¤×¡</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/playbooks.html#id1">×©×™×¨×•×ª ×—×™×¦×•× ×™ ××™×˜×™</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/playbooks.html#repeated-incident-15">Repeated Incident ×ª×—×ª 15 ×“×§Â«</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../chatops/permissions.html">×”×¨×©××•×ª ×•-Rate Limit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chatops/troubleshooting.html">×¤×ª×¨×•×Ÿ ×ª×§×œ×•×ª (FAQ)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chatops/faq.html">×©××œ×•×ª × ×¤×•×¦×•×ª</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">×¡×•×›× ×™ AI:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../ai-agents/guide.html">ğŸ¤– ××“×¨×™×š ×œ×¡×•×›× ×™ AI</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../ai-agents/guide.html#id1">× ×§×•×“×ª ×¤×ª×™×—×” ××”×™×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ai-agents/guide.html#id2">××‘× ×” ×”×¤×¨×•×™×§×˜ (×‘×§×¦×¨×”)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ai-agents/guide.html#id3">×”×•×¡×¤×ª ×¤×™×¦â€™×¨×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ai-agents/guide.html#id4">×¡×§×¨×™×¤×˜×™× ×—×©×•×‘×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ai-agents/guide.html#id5">××¤×ª ×“×¨×›×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ai-agents/guide.html#github-issues-chatops">GitHub Issues ×•-ChatOps</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../agents/rate-limiting.html">ğŸš¦ ××¢×¨×›×ª Rate Limiting ×œ×¡×•×›× ×™ AI ×•×œ×•×•×‘</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#shadow-mode">××¡×˜×¨×˜×’×™×” â€“ Shadow Mode ×ª×—×™×œ×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#id1">××©×ª× ×™ ×¡×‘×™×‘×” ×•×§×•× ×¤×™×’</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#id2">××™× ×˜×’×¨×¦×™×” â€“ ×‘×•×˜ ×˜×œ×’×¨×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#flask-webapp">××™× ×˜×’×¨×¦×™×” â€“ Flask/WebApp</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#id3">×”×—×¨×’×•×ª ×—×©×•×‘×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#prometheus">× ×™×˜×•×¨ ×•××“×“×™× (Prometheus)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#id4">××‘×˜×—×” ×•×”×’× ×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#pydantic-settings">×§×•× ×¤×™×’×•×¨×¦×™×” (Pydantic Settings)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#id5">×ª×§×œ×•×ª × ×¤×•×¦×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#id6">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Observability â€“ Advanced</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../observability/events_catalog.html">×§×˜×œ×•×’ ××™×¨×•×¢×™× ×§× ×•× ×™×™×</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../observability/events_catalog.html#github">GitHub</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/events_catalog.html#db">DB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/events_catalog.html#web-share">Web/Share</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/events_catalog.html#alerts">Alerts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/events_catalog.html#repo-analyzer">Repo Analyzer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/events_catalog.html#business">Business</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../observability/error_codes.html">××™×œ×•×Ÿ ×§×•×“×™ ×©×’×™××” (Error Codes)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../observability/error_codes.html#id1">×“×•×’×××•×ª ××™×¤×•×™</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/error_codes.html#id2">×”× ×—×™×•×ª</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../observability/tracing_hotspots.html">Tracing ×××•×§×“ ×‘× ×§×•×“×•×ª ×—××•×ª</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../observability/tracing_hotspots.html#id1">×ª×¨×©×™××™ ×–×¨×™××”</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../observability/tracing_hotspots.html#bot-update">×–×¨×™××ª bot.update</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../observability/tracing_hotspots.html#spans-bot-update">×××¤×™×™× ×™× ××•××œ×¦×™× ×œâ€‘Spans (bot.update)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../observability/tracing_hotspots.html#web-request">×–×¨×™××ª web.request</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../observability/tracing_hotspots.html#spans-web-request">×××¤×™×™× ×™× ××•××œ×¦×™× ×œâ€‘Spans (web.request)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../observability/tracing_hotspots.html#id2">×˜×‘×œ×ª â€×”×™×›×Ÿ ×¢×•×˜×¤×™×â€œ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/tracing_hotspots.html#trace-viewer">×“×•×’××ª Trace Viewer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/tracing_hotspots.html#id3">×”×˜××¢×ª ×“×§×•×¨×˜×•×¨ ×•×©×™××•×© ×‘×¤×•× ×§×¦×™×•×ª ×¢×–×¨</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/tracing_hotspots.html#best-practices">Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/tracing_hotspots.html#id4">×¨××• ×’×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../observability/metrics_promql.html">×©××™×œ×ª×•×ª PromQL ×©×™××•×©×™×•×ª</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../observability/metrics_promql.html#latency">×–××Ÿ ×ª×’×•×‘×” (Latency)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/metrics_promql.html#id1">×©×™×¢×•×¨ ×©×’×™××•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/metrics_promql.html#id2">××™×¨×•×¢×™ ×‘×™×–× ×¡</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../observability/alerts_playbook.html">Playbook ×§×¦×¨ ×œ×”×ª×¨××•×ª</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../observability/alerts_playbook.html#id1">×–×¨×™××”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/alerts_playbook.html#id2">×§×™×©×•×¨×™× ×‘×§×•×“</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/alerts_playbook.html#id3">×“×’×©×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/alerts_playbook.html#id4">×›×™×•×•× ×•×Ÿ ×¨×¢×©</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/alerts_playbook.html#id5">×˜×™×¤×™× ××”×™×¨×™×</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Code Keeper Bot</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">github_menu_handler</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>×”×¨××” ×§×•×“ ××§×•×¨ ×œ github_menu_handler</h1><div class="highlight"><pre>
<span></span><span class="c1"># FIXED: Changed from Markdown to HTML parsing (2025-01-10)</span>
<span class="c1"># This fixes Telegram parsing errors with special characters in suggestions</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">zipfile</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_stdlib_zipfile</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timezone</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">islice</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">html</span><span class="w"> </span><span class="kn">import</span> <span class="n">escape</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">io</span><span class="w"> </span><span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">http_sync</span><span class="w"> </span><span class="kn">import</span> <span class="n">request</span> <span class="k">as</span> <span class="n">_http_sync_request</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">errno</span>

<span class="c1"># Shim: expose a &#39;requests&#39; object for tests and route GETs through it.</span>
<span class="c1"># This allows monkeypatching gh.requests.get in tests while still using</span>
<span class="c1"># our pooled http client under the hood.</span>
<span class="k">class</span><span class="w"> </span><span class="nc">_RequestsShim</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_http_sync_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="c1"># Expose for tests: monkeypatch sets gh.requests.get</span>
<span class="n">requests</span> <span class="o">=</span> <span class="n">_RequestsShim</span><span class="p">()</span>


<div class="viewcode-block" id="http_request">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.http_request">[×ª×™×¢×•×“]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">http_request</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">method</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_http_sync_request</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">github</span><span class="w"> </span><span class="kn">import</span> <span class="n">Github</span><span class="p">,</span> <span class="n">GithubException</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">github.InputGitTreeElement</span><span class="w"> </span><span class="kn">import</span> <span class="n">InputGitTreeElement</span>
<span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>  <span class="c1"># pragma: no cover - optional dependency in minimal/test envs</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">GithubException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Placeholder raised when PyGithub is missing.&quot;&quot;&quot;</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Github</span><span class="p">:</span>  <span class="c1"># type: ignore</span>
        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;PyGithub is required for GitHub integrations. &quot;</span>
                <span class="s2">&quot;Install via &#39;pip install PyGithub&#39; or monkeypatch github_menu_handler.Github in tests.&quot;</span>
            <span class="p">)</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">InputGitTreeElement</span><span class="p">:</span>  <span class="c1"># type: ignore</span>
        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;PyGithub InputGitTreeElement unavailable. Install PyGithub to enable tree operations.&quot;</span>
            <span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">telegram</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">InlineKeyboardButton</span><span class="p">,</span>
    <span class="n">InlineKeyboardMarkup</span><span class="p">,</span>
    <span class="n">InlineQueryResultArticle</span><span class="p">,</span>
    <span class="n">InputFile</span><span class="p">,</span>
    <span class="n">InputTextMessageContent</span><span class="p">,</span>
    <span class="n">Update</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">telegram.error</span><span class="w"> </span><span class="kn">import</span> <span class="n">BadRequest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">secrets</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">telegram.ext</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">ContextTypes</span><span class="p">,</span>
    <span class="n">ConversationHandler</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">repo_analyzer</span><span class="w"> </span><span class="kn">import</span> <span class="n">RepoAnalyzer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">config</span><span class="w"> </span><span class="kn">import</span> <span class="n">config</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">file_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">backup_manager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">TelegramUtils</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># Optional backoff state</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">services</span><span class="w"> </span><span class="kn">import</span> <span class="n">github_backoff_state</span>  <span class="c1"># type: ignore</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
    <span class="n">github_backoff_state</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">observability</span><span class="w"> </span><span class="kn">import</span> <span class="n">emit_event</span>  <span class="c1"># type: ignore</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">emit_event</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">severity</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">fields</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
        <span class="k">return</span> <span class="kc">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">track_performance</span><span class="p">,</span> <span class="n">errors_total</span>  <span class="c1"># type: ignore</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">contextmanager</span>
    <span class="n">errors_total</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>
    <span class="nd">@contextmanager</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">track_performance</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
        <span class="k">yield</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">track_github_sync</span>  <span class="c1"># type: ignore</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">track_github_sync</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
        <span class="k">return</span> <span class="kc">None</span>

<span class="c1"># ×™×¦×™×¨×ª Proxy ×œ-zipfile ×›×“×™ ×œ××¤×©×¨ monkeypatch ×‘×˜×•×— ×©××™× ×• ×™×•×¦×¨ ×¨×§×•×¨×¡×™×”</span>
<span class="k">class</span><span class="w"> </span><span class="nc">_ZipfileProxy</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">real_module</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_real</span> <span class="o">=</span> <span class="n">real_module</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="c1"># ×”×¢×‘×¨×ª ×ª×›×•× ×•×ª ×‘×¨×™×¨×ª ××—×“×œ ×œ××•×“×•×œ ×”×××™×ª×™</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_real</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

<span class="c1"># ×©×™× ×œ×‘: ×‘×ª×•×š ××•×“×•×œ ×–×”, ×”×©× &#39;zipfile&#39; ××¤× ×” ×œ×¤×¨×•×§×¡×™, ×›×š ×©-monkeypatch ×¢×œ</span>
<span class="c1"># zipfile.ZipFile ×™×©×¤×™×¢ ×¨×§ ×›××Ÿ, ×‘×¢×•×“ ×§×¨×™××•×ª ××—×–×™×¨×•×ª ×œ-zipfile ×”××§×•×¨×™ ×‘×ª×•×š ×”-WRAPPER</span>
<span class="n">zipfile</span> <span class="o">=</span> <span class="n">_ZipfileProxy</span><span class="p">(</span><span class="n">_stdlib_zipfile</span><span class="p">)</span>

<span class="c1"># ×”×’×“×¨×ª ×œ×•×’×¨</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># ××¦×‘×™ ×©×™×—×”</span>
<span class="n">REPO_SELECT</span><span class="p">,</span> <span class="n">FILE_UPLOAD</span><span class="p">,</span> <span class="n">FOLDER_SELECT</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="c1"># ××’×‘×œ×•×ª ×§×‘×¦×™× ×’×“×•×œ×™×</span>
<span class="n">MAX_INLINE_FILE_BYTES</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>  <span class="c1"># 5MB ×œ×©×œ×™×—×” ×™×©×™×¨×” ×‘×‘×•×˜</span>
<span class="n">MAX_ZIP_TOTAL_BYTES</span> <span class="o">=</span> <span class="mi">50</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>  <span class="c1"># 50MB ×œ×§×•×‘×¥ ZIP ××—×“</span>
<span class="n">MAX_ZIP_FILES</span> <span class="o">=</span> <span class="mi">500</span>  <span class="c1"># ××§×¡×™××•× ×§×‘×¦×™× ×‘-ZIP ××—×“</span>
<span class="n">TELEGRAM_SAFE_TEXT_LIMIT</span> <span class="o">=</span> <span class="mi">4000</span>
<span class="n">TELEGRAM_TRUNCATION_NOTICE</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">(âœ‚ï¸ ×—×œ×§ ××”×˜×§×¡×˜ ×§×•×¦×¨ ×›×“×™ ×œ×¢××•×“ ×‘××’×‘×œ×ª ×˜×œ×’×¨×)&quot;</span>

<span class="c1"># ×—×œ×•×Ÿ ×§×™×¨×•×¨ ××™× ×™××œ×™ ×œ×”×ª×¨××•×ª PR &quot;×¢×•×“×›×Ÿ&quot; (× ×™×ª×Ÿ ×œ×›×™×•×œ ×“×¨×š ENV)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">_PR_UPDATE_MIN_COOLDOWN_SECONDS</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
        <span class="mi">0</span><span class="p">,</span>
        <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;GITHUB_NOTIFICATIONS_PR_MIN_COOLDOWN&quot;</span><span class="p">,</span> <span class="s2">&quot;30&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;30&quot;</span><span class="p">),</span>
    <span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="n">_PR_UPDATE_MIN_COOLDOWN_SECONDS</span> <span class="o">=</span> <span class="mi">30</span>

<span class="c1"># ××’×‘×œ×•×ª ×™×™×‘×•× ×¨×™×¤×• (×™×™×‘×•× ×ª×•×›×Ÿ, ×œ× ×’×™×‘×•×™)</span>
<span class="n">IMPORT_MAX_FILE_BYTES</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>  <span class="c1"># 1MB ×œ×§×•×‘×¥ ×™×—×™×“</span>
<span class="n">IMPORT_MAX_TOTAL_BYTES</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>  <span class="c1"># 20MB ×œ×›×œ ×”×™×™×‘×•×</span>
<span class="n">IMPORT_MAX_FILES</span> <span class="o">=</span> <span class="mi">2000</span>  <span class="c1"># ×”×’×‘×œ×” ×¡×‘×™×¨×” ×œ××¡×¤×¨ ×§×‘×¦×™×</span>
<span class="c1"># ×”×¨×—×‘×ª ×¨×©×™××ª ×ª×™×§×™×•×ª ×›×‘×“×•×ª ×œ×“×™×œ×•×’ ×‘×›×œ ×¢×•××§ ×¢×¥ â€“ ××©×¤×¨ ×¡×¨×™×§×”/×§×¨×™××” ×œ××—×¨ ×—×œ×™×¦×”</span>
<span class="n">IMPORT_SKIP_DIRS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;.git&quot;</span><span class="p">,</span> <span class="s2">&quot;.github&quot;</span><span class="p">,</span> <span class="s2">&quot;__pycache__&quot;</span><span class="p">,</span> <span class="s2">&quot;node_modules&quot;</span><span class="p">,</span> <span class="s2">&quot;dist&quot;</span><span class="p">,</span> <span class="s2">&quot;build&quot;</span><span class="p">,</span>
    <span class="s2">&quot;_build&quot;</span><span class="p">,</span> <span class="s2">&quot;_static&quot;</span><span class="p">,</span> <span class="s2">&quot;_images&quot;</span><span class="p">,</span>  <span class="c1"># ×ª×‘× ×™×•×ª ×©× ×¤×•×¦×•×ª ×ª×—×ª docs/</span>
    <span class="s2">&quot;.venv&quot;</span><span class="p">,</span> <span class="s2">&quot;venv&quot;</span><span class="p">,</span> <span class="s2">&quot;.tox&quot;</span>
<span class="p">}</span>

<span class="c1"># ××’×‘×œ×•×ª ×¢×–×¨ ×œ×©×œ×™×¤×ª ×ª××¨×™×›×™ ×¢× ×¤×™× ×œ××™×•×Ÿ</span>
<span class="n">MAX_BRANCH_DATE_FETCH</span> <span class="o">=</span> <span class="mi">120</span>  <span class="c1"># ×× ×™×© ×™×•×ª×¨ ××–×” â€” × ×•×•×ª×¨ ×¢×œ ××™×•×Ÿ ×œ×¤×™ ×ª××¨×™×š (×œ××¢×˜ ×‘×¨×™×¨×ª ×”××—×“×œ)</span>

<span class="c1"># ×ª×¦×•×’×ª ×§×•×‘×¥ ×—×œ×§×™×ª</span>
<span class="n">VIEW_LINES_PER_PAGE</span> <span class="o">=</span> <span class="mi">80</span>

<span class="c1"># ×§×™×“×•××•×ª ×§×¦×¨×•×ª ×œ-callback×™× ×›×“×™ ×œ×”×™×©××¨ ××ª×—×ª ×œ-64 ×ª×•×•×™× (××’×‘×œ×ª ×˜×œ×’×¨×)</span>
<span class="n">CALLBACK_BRANCH_FROM_COMMIT</span> <span class="o">=</span> <span class="s2">&quot;rcb&quot;</span>
<span class="n">CALLBACK_REVERT_PR_FROM_COMMIT</span> <span class="o">=</span> <span class="s2">&quot;rcpr&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_safe_rmtree_tmp</span><span class="p">(</span><span class="n">target_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;××—×™×§×” ×‘×˜×•×—×” ×©×œ ×ª×™×§×™×™×” ×ª×—×ª /tmp ×‘×œ×‘×“, ×¢× ×¡×•×¨×’×™ ×‘×˜×™×—×•×ª.</span>

<span class="sd">    ×™×–×¨×•×§ ×—×¨×™×’×” ×× ×”× ×ª×™×‘ ××™× ×• ×ª×—×ª /tmp ××• ×©×’×•×™.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">target_path</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">rp_target</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">target_path</span><span class="p">)</span>
        <span class="n">rp_base</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="s2">&quot;/tmp&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rp_target</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">rp_base</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Refusing to delete non-tmp path: </span><span class="si">{</span><span class="n">rp_target</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rp_target</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()}:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Refusing to delete unsafe path: </span><span class="si">{</span><span class="n">rp_target</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">rp_target</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="c1"># ×œ× ××¤×¡×™×§ ××ª ×”×–×¨×™××” ×‘××§×¨×” ×©×œ ×©×’×™××” ×‘× ×™×§×•×™</span>
        <span class="k">pass</span>


<div class="viewcode-block" id="safe_html_escape">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.safe_html_escape">[×ª×™×¢×•×“]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">safe_html_escape</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Escape text for Telegram HTML; preserves \n/\r/\t and keeps existing HTML entities.</span>

<span class="sd">    ××¨×—×™×‘ × ×™×§×•×™ ×ª×•×•×™× ×‘×œ×ª×™ × ×¨××™×: ZWSP/ZWNJ/ZWJ, BOM/ZWNBSP, ×•×ª×•×•×™ ×›×™×•×•× ×™×•×ª LRM/RLM/LRE/RLE/PDF/LRO/RLO/LRI/RLI/FSI/PDI.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">text</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
    <span class="c1"># × ×§×” ×ª×•×•×™× ×‘×œ×ª×™ × ×¨××™× (Zero-width) + BOM</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[\u200b\u200c\u200d\u2060\ufeff]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
    <span class="c1"># × ×§×” ×¡×™××•× ×™ ×›×™×•×•× ×™×•×ª (Cf) × ×¤×•×¦×™× ×©×’×•×¨××™× ×œ×‘×œ×‘×•×œ ×‘×”×¦×’×”</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[\u200e\u200f\u202a\u202b\u202c\u202d\u202e\u2066\u2067\u2068\u2069]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
    <span class="c1"># × ×§×” ×ª×•×•×™ ×‘×§×¨×” ××š ×”×©××¨ \n, \r, \t</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[\x00-\x08\x0b\x0c\x0e-\x1f\x7f-\x9f]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_trim_html_preserving_entities</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;××§×¦×¨ ×˜×§×¡×˜ HTML ××‘×œ×™ ×œ×”×©××™×¨ ×™×©×•×™×•×ª ×©×‘×•×¨×•×ª ×‘×¡×•×£ ×”××—×¨×•×–×ª.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">limit</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">limit</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">text</span>
    <span class="n">trimmed</span> <span class="o">=</span> <span class="n">text</span><span class="p">[:</span><span class="n">limit</span><span class="p">]</span>
    <span class="n">partial</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&amp;[A-Za-z0-9#]{0,32}$&quot;</span><span class="p">,</span> <span class="n">trimmed</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">partial</span> <span class="ow">and</span> <span class="s2">&quot;;&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">partial</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">trimmed</span> <span class="o">=</span> <span class="n">trimmed</span><span class="p">[:</span> <span class="n">partial</span><span class="o">.</span><span class="n">start</span><span class="p">()]</span>
    <span class="k">return</span> <span class="n">trimmed</span>


<div class="viewcode-block" id="format_bytes">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.format_bytes">[×ª×™×¢×•×“]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">format_bytes</span><span class="p">(</span><span class="n">num</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;×¤×•×¨××˜ × ×—××“ ×œ×’×•×“×œ ×§×•×‘×¥&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;KB&quot;</span><span class="p">,</span> <span class="s2">&quot;MB&quot;</span><span class="p">,</span> <span class="s2">&quot;GB&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">num</span> <span class="o">&lt;</span> <span class="mf">1024.0</span> <span class="ow">or</span> <span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;GB&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">num</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">unit</span> <span class="o">!=</span> <span class="s2">&quot;B&quot;</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">num</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">num</span> <span class="o">/=</span> <span class="mf">1024.0</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)</span></div>



<div class="viewcode-block" id="GitHubMenuHandler">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler">[×ª×™×¢×•×“]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">GitHubMenuHandler</span><span class="p">:</span>
<div class="viewcode-block" id="GitHubMenuHandler.__init__">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.__init__">[×ª×™×¢×•×“]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_sessions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_api_call</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.get_user_session">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.get_user_session">[×ª×™×¢×•×“]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_user_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;××—×–×™×¨ ××• ×™×•×¦×¨ ×¡×©×Ÿ ××©×ª××© ×‘×–×™×›×¨×•×Ÿ&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_sessions</span><span class="p">:</span>
            <span class="c1"># × ×¡×” ×œ×˜×¢×•×Ÿ ×¨×™×¤×• ××•×¢×“×£ ××”××¡×“, ×¢× × ×¤×™×œ×” ×‘×˜×•×—×” ×‘×¡×‘×™×‘×ª ×‘×“×™×§×•×ª/CI</span>
            <span class="n">selected_repo</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">database</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span>  <span class="c1"># type: ignore</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">selected_repo</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_selected_repo</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">selected_repo</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">selected_repo</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_sessions</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;selected_repo&quot;</span><span class="p">:</span> <span class="n">selected_repo</span><span class="p">,</span>  <span class="c1"># ×˜×¢×Ÿ ××”××¡×“ × ×ª×•× ×™×</span>
                <span class="s2">&quot;selected_folder&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># None = root ×©×œ ×”×¨×™×¤×•</span>
                <span class="s2">&quot;github_token&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_sessions</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span></div>


    <span class="c1"># --- Date/time helpers ---</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_to_utc_aware</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Normalize datetime to timezone-aware UTC to avoid comparison errors.</span>

<span class="sd">        PyGithub often returns naive UTC datetimes. We must not compare</span>
<span class="sd">        naive and aware datetimes, so we coerce to aware UTC.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dt</span><span class="o">.</span><span class="n">tzinfo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">dt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dt</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># Fallback: return as-is if unexpected type</span>
            <span class="k">return</span> <span class="n">dt</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_serialize_seen_pr_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Serialize datetime for notifications deduplication storage.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">aware</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_utc_aware</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">aware</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">aware</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dt</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_seen_pr_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse stored notifications timestamp back into aware datetime.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_utc_aware</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">value_str</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">value_str</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">parsed</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">value_str</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">parsed</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">value_str</span><span class="p">),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_utc_aware</span><span class="p">(</span><span class="n">parsed</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_combine_with_telegram_limit</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">header</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">body</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">notice</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×××—×“ ×˜×§×¡×˜×™× ×•×©×•××¨ ×¢×œ ××’×‘×œ×ª ×˜×œ×’×¨× ×ª×•×š ×”×•×¡×¤×ª ×”×•×“×¢×ª ×§×™×¦×•×¨ ×‘××™×“×ª ×”×¦×•×¨×š.&quot;&quot;&quot;</span>
        <span class="n">max_length</span> <span class="o">=</span> <span class="n">TELEGRAM_SAFE_TEXT_LIMIT</span> <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">limit</span>
        <span class="n">notice_text</span> <span class="o">=</span> <span class="n">TELEGRAM_TRUNCATION_NOTICE</span> <span class="k">if</span> <span class="n">notice</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">notice</span>
        <span class="k">if</span> <span class="n">max_length</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">max_length</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">header</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">body</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">part</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span> <span class="k">if</span> <span class="n">part</span><span class="p">]</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">combined</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">combined</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">max_length</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">combined</span>
        <span class="n">notice_text</span> <span class="o">=</span> <span class="n">notice_text</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">notice_text</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">notice_text</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">max_length</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_trim_html_preserving_entities</span><span class="p">(</span><span class="n">notice_text</span><span class="p">,</span> <span class="n">max_length</span><span class="p">)</span>
        <span class="n">available</span> <span class="o">=</span> <span class="n">max_length</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">notice_text</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">available</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">notice_text</span>
        <span class="n">trimmed</span> <span class="o">=</span> <span class="n">_trim_html_preserving_entities</span><span class="p">(</span><span class="n">combined</span><span class="p">,</span> <span class="n">available</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">trimmed</span><span class="si">}{</span><span class="n">notice_text</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_cache_recent_backup</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">backup_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">repo_full_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">file_count</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">total_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">created_at</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">backup_id</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cache</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;_recent_backups&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;file_path&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">backup_manager</span><span class="o">.</span><span class="n">backup_dir</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">backup_id</span><span class="si">}</span><span class="s2">.zip&quot;</span><span class="p">),</span>
                <span class="s2">&quot;repo&quot;</span><span class="p">:</span> <span class="n">repo_full_name</span><span class="p">,</span>
                <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">path</span><span class="p">,</span>
                <span class="s2">&quot;file_count&quot;</span><span class="p">:</span> <span class="n">file_count</span><span class="p">,</span>
                <span class="s2">&quot;total_size&quot;</span><span class="p">:</span> <span class="n">total_size</span><span class="p">,</span>
                <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="n">created_at</span><span class="p">,</span>
                <span class="s2">&quot;backup_id&quot;</span><span class="p">:</span> <span class="n">backup_id</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">cache</span><span class="p">[</span><span class="n">backup_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">cache</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">cache</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">cache</span><span class="p">)))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_resolve_backup_version</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span>
        <span class="n">repo_full_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">infos</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
        <span class="n">backup_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">repo_backups</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">infos</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s2">&quot;repo&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="n">repo_full_name</span><span class="p">]</span>
        <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">repo_backups</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">backup_id</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">repo_backups</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s2">&quot;backup_id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="n">backup_id</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cache</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_recent_backups&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">entry</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">backup_id</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">entry</span> <span class="ow">and</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;repo&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">repo_full_name</span><span class="p">:</span>
                        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

<div class="viewcode-block" id="GitHubMenuHandler.show_browse_ref_menu">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_browse_ref_menu">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">show_browse_ref_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×ª×¤×¨×™×˜ ×‘×—×™×¨×ª ref (×¢× ×£/×ª×’) ×¢× ×¢×™××•×“ ×•×˜××‘×™×.&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_full</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_full</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×—×¡×¨ ×˜×•×§×Ÿ ××• ×¨×™×¤×• × ×‘×—×¨&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_full</span><span class="p">)</span>
        <span class="n">current_ref</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;browse_ref&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="s2">&quot;default_branch&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;main&quot;</span><span class="p">)</span>
        <span class="n">tab</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;browse_ref_tab&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;branches&quot;</span>
        <span class="n">kb</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># ×˜××‘×™×</span>
        <span class="n">tabs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸŒ¿ ×¢× ×¤×™×&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;browse_refs_branches_page_0&quot;</span><span class="p">),</span>
            <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ· ×ª×’×™×•×ª&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;browse_refs_tags_page_0&quot;</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tabs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tab</span> <span class="o">==</span> <span class="s2">&quot;branches&quot;</span><span class="p">:</span>
            <span class="n">page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;browse_refs_branches_page&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">repo</span><span class="o">.</span><span class="n">get_branches</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">config</span><span class="w"> </span><span class="kn">import</span> <span class="n">config</span> <span class="k">as</span> <span class="n">_cfg</span>  <span class="c1"># type: ignore</span>
                <span class="n">page_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">_cfg</span><span class="p">,</span> <span class="s1">&#39;UI_PAGE_SIZE&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">page_size</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">page</span> <span class="o">*</span> <span class="n">page_size</span>
            <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">page_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">br</span> <span class="ow">in</span> <span class="n">items</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;âœ… &quot;</span> <span class="o">+</span> <span class="n">br</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">br</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">current_ref</span> <span class="k">else</span> <span class="n">br</span><span class="o">.</span><span class="n">name</span>
                <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;browse_select_ref:</span><span class="si">{</span><span class="n">br</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
            <span class="c1"># ×¢×™××•×“</span>
            <span class="n">nav</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">page</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;â¬…ï¸ ×”×§×•×“×&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;browse_refs_branches_page_</span><span class="si">{</span><span class="n">page</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">end</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
                <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;×”×‘× â¡ï¸&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;browse_refs_branches_page_</span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">nav</span><span class="p">:</span>
                <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nav</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;browse_refs_tags_page&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">repo</span><span class="o">.</span><span class="n">get_tags</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">config</span><span class="w"> </span><span class="kn">import</span> <span class="n">config</span> <span class="k">as</span> <span class="n">_cfg</span>  <span class="c1"># type: ignore</span>
                <span class="n">page_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">_cfg</span><span class="p">,</span> <span class="s1">&#39;UI_PAGE_SIZE&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">page_size</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">page</span> <span class="o">*</span> <span class="n">page_size</span>
            <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">page_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">tg</span> <span class="ow">in</span> <span class="n">items</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tg</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;âœ… &quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="n">current_ref</span> <span class="k">else</span> <span class="n">name</span>
                <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;browse_select_ref:</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
            <span class="n">nav</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">page</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;â¬…ï¸ ×”×§×•×“×&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;browse_refs_tags_page_</span><span class="si">{</span><span class="n">page</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">end</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
                <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;×”×‘× â¡ï¸&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;browse_refs_tags_page_</span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">nav</span><span class="p">:</span>
                <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nav</span><span class="p">)</span>
        <span class="c1"># ×ª×—×ª×™×ª</span>
        <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×¨×”&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)])</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;×‘×—×¨/×™ ref ×œ×“×¤×“×•×£ (× ×•×›×—×™: &lt;code&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">current_ref</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/code&gt;)&quot;</span><span class="p">,</span>
            <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span>
            <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.show_browse_search_results">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_browse_search_results">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">show_browse_search_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×—×™×¤×•×© ×œ×¤×™ ×©× ×§×•×‘×¥ (prefix/contains) ×¢× ×¢×™××•×“ ×•×ª×•×¦××•×ª ×œ×¤×ª×™×—×”.&quot;&quot;&quot;</span>
        <span class="c1"># ×©×™××•×© ×‘-Contents API: ××™×Ÿ ×—×™×¤×•×© ×©××•×ª ×™×©×™×¨; × ×©×ª××© ×‘-Search API code:in:path/name</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s2">&quot;callback_query&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span> <span class="k">if</span> <span class="n">query</span> <span class="k">else</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_full</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;browse_search_query&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;browse_search_page&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_full</span> <span class="ow">and</span> <span class="n">q</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×—×¡×¨×™× × ×ª×•× ×™× ×œ×—×™×¤×•×©&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×—×¡×¨×™× × ×ª×•× ×™× ×œ×—×™×¤×•×©&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="c1"># ×”×¤×•×¨××˜: repo:owner/name in:path &lt;query&gt;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">owner</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">repo_full</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">owner</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">repo_full</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
        <span class="c1"># ×‘× ×™×™×ª ×©××™×œ×ª×”: × ×—×¤×© ×‘××—×¨×•×–×ª ×”× ×ª×™×‘ ×‘×œ×‘×“ (in:name ×œ× × ×ª××š ×‘-code search)</span>
        <span class="n">q_safe</span> <span class="o">=</span> <span class="p">(</span><span class="n">q</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">term</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">q_safe</span><span class="si">}</span><span class="s1">&quot;&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="ow">in</span> <span class="n">q_safe</span><span class="p">)</span> <span class="k">else</span> <span class="n">q_safe</span>
        <span class="n">gh_query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;repo:</span><span class="si">{</span><span class="n">owner</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> in:path </span><span class="si">{</span><span class="n">term</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># PyGithub ××—×–×™×¨ PaginatedList; × ×”×¤×•×š ×œ×¨×©×™××” ×‘×˜×•×—×” ×¢× ×”×’×‘×œ×” ×›×“×™ ×œ×× ×•×¢ 403/timeout</span>
            <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">search_code</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">gh_query</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s2">&quot;desc&quot;</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br</span><span class="p">:</span>
            <span class="c1"># × × ×”×œ ××ª ×˜×œ×’×¨× &quot;message is not modified&quot; ×‘×¢×“×™× ×•×ª</span>
            <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;××™×Ÿ ×©×™× ×•×™ ×‘×ª×•×¦××”&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">return</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s2">&quot;callback_query&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;×©×’×™××” ×‘×—×™×¤×•×©: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×—×™×¤×•×©: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">return</span>
        <span class="c1"># ×¢×™××•×“ ×™×“× ×™</span>
        <span class="n">per_page</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">items</span> <span class="o">=</span> <span class="n">results</span>  <span class="c1"># ×›×‘×¨ ×¨×©×™××”</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">items</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ğŸ” ××™×Ÿ ×ª×•×¦××•×ª ×¢×‘×•×¨ &lt;code&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/code&gt; ×‘-&lt;code&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">repo_full</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span>
            <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">([[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×¨×”&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)]]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">per_page</span>
        <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">per_page</span><span class="p">,</span> <span class="n">total</span><span class="p">)</span>
        <span class="n">shown</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
        <span class="c1"># ××¤×¡ ××™×¤×•×™ ××™× ×“×§×¡×™× ×œ××¡×š ×–×” (×œ-callback ×§×¦×¨×™×)</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_idx_map&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># ×¡×™××•×Ÿ ××¦×‘: ×ª×¦×•×’×ª ×ª×•×¦××•×ª ×—×™×¤×•×© ×¤×¢×™×œ×” (×œ×¦×•×¨×š ×—×–×¨×” ××—×•×¨×” ××ª×¦×•×’×ª ×§×•×‘×¥)</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;last_results_were_search&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">kb</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">shown</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">view_cb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mk_cb</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;browse_select_view&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
                <span class="c1"># ×›×¤×ª×•×¨ ×™×—×™×“: &quot;path ğŸ‘ï¸&quot; ×œ×¦×¤×™×™×” ×‘×§×•×‘×¥</span>
                <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> ğŸ‘ï¸&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="n">view_cb</span><span class="p">)</span>
                <span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="n">nav</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">total_pages</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">total</span> <span class="o">+</span> <span class="n">per_page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">per_page</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">page</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;â¬…ï¸ ×”×§×•×“×&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;browse_search_page:</span><span class="si">{</span><span class="n">page</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">page</span> <span class="o">&lt;</span> <span class="n">total_pages</span><span class="p">:</span>
            <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;×”×‘× â¡ï¸&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;browse_search_page:</span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">nav</span><span class="p">:</span>
            <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nav</span><span class="p">)</span>
        <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×¨×”&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)])</span>
        <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ğŸ” ×ª×•×¦××•×ª ×—×™×¤×•×© ×¢×‘×•×¨ &lt;code&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/code&gt; â€” ××¦×™×’ </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">shown</span><span class="p">)</span><span class="si">}</span><span class="s2"> ××ª×•×š </span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.check_rate_limit">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.check_rate_limit">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">check_rate_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">github_client</span><span class="p">:</span> <span class="n">Github</span><span class="p">,</span> <span class="n">update_or_query</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×‘×•×“×§ ××ª ××’×‘×œ×ª ×”-API ×©×œ GitHub&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rate_limit</span> <span class="o">=</span> <span class="n">github_client</span><span class="o">.</span><span class="n">get_rate_limit</span><span class="p">()</span>
            <span class="c1"># ×ª××™××•×ª ×§×“×™××” ×•××—×•×¨×”: PyGithub ×™×©×Ÿ (rate.core) ××•×œ ×—×“×© (rate.resources[&quot;core&quot;]).</span>
            <span class="n">core_limit</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">rate_limit</span><span class="p">,</span> <span class="s2">&quot;core&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">core_limit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">resources</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">rate_limit</span><span class="p">,</span> <span class="s2">&quot;resources&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">resources</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">core_limit</span> <span class="o">=</span> <span class="n">resources</span><span class="p">[</span><span class="s2">&quot;core&quot;</span><span class="p">]</span>  <span class="c1"># type: ignore[index]</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">core_limit</span> <span class="o">=</span> <span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;core&quot;</span><span class="p">)</span>  <span class="c1"># type: ignore[attr-defined]</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="n">core_limit</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># ×× ×œ× ×”×¦×œ×—× ×• ×œ×§×‘×œ × ×ª×•× ×™ core â€“ × ××©×™×š ×‘×œ×™ ×œ×—×¡×•× ××ª ×”×–×¨×™××”</span>
            <span class="k">if</span> <span class="n">core_limit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">core_limit</span><span class="p">,</span> <span class="s2">&quot;remaining&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">core_limit</span><span class="o">.</span><span class="n">remaining</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">reset_time</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">core_limit</span><span class="p">,</span> <span class="s2">&quot;reset&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="c1"># ×ª××™×›×” ×’× ×‘-timestamp ×•×’× ×‘-datetime</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reset_time</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
                        <span class="n">seconds_left</span> <span class="o">=</span> <span class="n">reset_time</span> <span class="o">-</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">reset_time</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">):</span>
                        <span class="n">seconds_left</span> <span class="o">=</span> <span class="n">reset_time</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span> <span class="o">-</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>  <span class="c1"># type: ignore[call-arg]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">seconds_left</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">seconds_left</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">minutes_until_reset</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">seconds_left</span> <span class="o">/</span> <span class="mi">60</span><span class="p">))</span>

                <span class="n">error_message</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;â³ ×—×¨×™×’×” ×××’×‘×œ×ª GitHub API</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;× ×•×ª×¨×• ×¨×§ </span><span class="si">{</span><span class="n">core_limit</span><span class="o">.</span><span class="n">remaining</span><span class="si">}</span><span class="s2"> ×‘×§×©×•×ª</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;×”××’×‘×œ×” ×ª×ª××¤×¡ ×‘×¢×•×“ </span><span class="si">{</span><span class="n">minutes_until_reset</span><span class="si">}</span><span class="s2"> ×“×§×•×ª</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;ğŸ’¡ × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨&quot;</span>
                <span class="p">)</span>

                <span class="c1"># ×‘×“×•×§ ×× ×–×” callback query ××• update ×¨×’×™×œ</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">update_or_query</span><span class="p">,</span> <span class="s2">&quot;answer&quot;</span><span class="p">):</span>
                    <span class="c1"># ×–×” callback query</span>
                    <span class="k">await</span> <span class="n">update_or_query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="n">error_message</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># ×–×” update ×¨×’×™×œ</span>
                    <span class="k">await</span> <span class="n">update_or_query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>

                <span class="k">return</span> <span class="kc">False</span>

            <span class="c1"># Respect global backoff switch: if active, warn once and proceed (gate elsewhere)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">github_backoff_state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">github_backoff_state</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">is_active</span><span class="p">():</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;âš ï¸ Backoff ×¤×¢×™×œ â€“ ×™×™×ª×›× ×• ×”×©×”×™×•×ª ×‘×™×Ÿ ×§×¨×™××•×ª API&quot;</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">update_or_query</span><span class="p">,</span> <span class="s2">&quot;answer&quot;</span><span class="p">):</span>
                        <span class="k">await</span> <span class="n">update_or_query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">update_or_query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error checking rate limit: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">emit_event</span><span class="p">(</span><span class="s2">&quot;github_rate_limit_check_error&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">errors_total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">errors_total</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="s2">&quot;github_rate_limit_check_error&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># ×‘××§×¨×” ×©×œ ×©×’×™××”, × ××©×™×š ×‘×›×œ ×–××ª</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.apply_rate_limit_delay">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.apply_rate_limit_delay">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">apply_rate_limit_delay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;××•×¡×™×£ ×”×©×”×™×™×” ×‘×™×Ÿ ×‘×§×©×•×ª API; ××›×‘×“ ××¦×‘ Backoff ×’×œ×•×‘×œ×™.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">base_delay</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;GITHUB_API_BASE_DELAY&quot;</span><span class="p">,</span> <span class="s2">&quot;2.0&quot;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">base_delay</span> <span class="o">=</span> <span class="mf">2.0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">github_backoff_state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">github_backoff_state</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">is_active</span><span class="p">():</span>
                <span class="c1"># Increase delay under backoff to reduce pressure</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">backoff_delay</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;GITHUB_BACKOFF_DELAY&quot;</span><span class="p">,</span> <span class="s2">&quot;5.0&quot;</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">backoff_delay</span> <span class="o">=</span> <span class="mf">5.0</span>
                <span class="n">base_delay</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">base_delay</span><span class="p">,</span> <span class="n">backoff_delay</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">last_call</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_api_call</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">time_since_last</span> <span class="o">=</span> <span class="n">current_time</span> <span class="o">-</span> <span class="n">last_call</span>
        <span class="k">if</span> <span class="n">time_since_last</span> <span class="o">&lt;</span> <span class="n">base_delay</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">base_delay</span> <span class="o">-</span> <span class="n">time_since_last</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_api_call</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.get_user_token">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.get_user_token">[×ª×™×¢×•×“]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_user_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;××§×‘×œ ×˜×•×§×Ÿ ×©×œ ××©×ª××© - ××”×¡×©×Ÿ ××• ××”××¡×“ × ×ª×•× ×™×&quot;&quot;&quot;</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

        <span class="c1"># × ×¡×” ××”×¡×©×Ÿ</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;github_token&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">token</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">token</span>

        <span class="c1"># × ×¡×” ××”××¡×“ × ×ª×•× ×™×</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">database</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span>

        <span class="n">token</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_github_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">token</span><span class="p">:</span>
            <span class="c1"># ×©××•×¨ ×‘×¡×©×Ÿ ×œ×©×™××•×© ××”×™×¨</span>
            <span class="n">session</span><span class="p">[</span><span class="s2">&quot;github_token&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">token</span>

        <span class="k">return</span> <span class="n">token</span></div>


    <span class="c1"># --- Helpers to keep Telegram callback_data &lt;= 64 bytes ---</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_mk_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×™×•×¦×¨ callback_data ×‘×˜×•×—. ×× ××¨×•×š ××“×™, ××©×ª××© ×‘××™× ×“×§×¡ ×–×× ×™ ×‘××¤×” ×‘-context.user_data.&quot;&quot;&quot;</span>
        <span class="n">safe_path</span> <span class="o">=</span> <span class="n">path</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">safe_path</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">64</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">data</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">64</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">data</span>
        <span class="n">idx_map</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;browse_idx_map&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">idx_map</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">idx_map</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_idx_map&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx_map</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idx_map</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">idx_map</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">safe_path</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_i:</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_path_from_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×©×—×–×•×¨ × ×ª×™×‘ ××ª×•×š callback_data ×¨×’×™×œ ××• ×××•×¤×” (_i:).&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;_i:&quot;</span><span class="p">):</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;browse_idx_map&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
                <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_render_file_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;××¦×™×’ ×“×£ ×ª×¦×•×’×” ×—×œ×§×™×ª ×©×œ ×§×•×‘×¥ ×¢× ×›×¤×ª×•×¨×™ &#39;×”×¦×’ ×¢×•×“&#39;, &#39;×”×•×¨×“&#39;, &#39;×—×–×¨×”&#39;.&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;repo&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;view_file_path&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;view_file_text&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="n">page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;view_page_index&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="c1"># ×—×™×©×•×‘ ×—×œ×•×§×” ×œ×©×•×¨×•×ª</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="n">total_lines</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">page</span> <span class="o">*</span> <span class="n">VIEW_LINES_PER_PAGE</span>
        <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">VIEW_LINES_PER_PAGE</span><span class="p">,</span> <span class="n">total_lines</span><span class="p">)</span>
        <span class="n">chunk</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">])</span>
        <span class="c1"># ×˜×§×¡×˜ ×œ×ª×¦×•×’×” + ×’×•×“×œ ×•×©×¤×” ××–×•×”×”</span>
        <span class="n">size_bytes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;view_file_size&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">lang</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;view_detected_language&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;text&quot;</span>
        <span class="n">header</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;ğŸ“„ ×ª×¦×•×’×ª ×§×•×‘×¥</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;ğŸ“ &lt;code&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;ğŸ“„ &lt;code&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;ğŸ”¤ ×©×¤×”: &lt;code&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">lang</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/code&gt; | ğŸ’¾ ×’×•×“×œ: &lt;code&gt;</span><span class="si">{</span><span class="n">format_bytes</span><span class="p">(</span><span class="n">size_bytes</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;×©×•×¨×•×ª </span><span class="si">{</span><span class="n">start</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">end</span><span class="si">}</span><span class="s2"> ××ª×•×š </span><span class="si">{</span><span class="n">total_lines</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="c1"># ×‘× ×™×™×ª ××§×œ×“×ª</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×¨×”&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;view_back&quot;</span><span class="p">)],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;â¬‡ï¸ ×”×•×¨×“&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mk_cb</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;browse_select_download&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">))]]</span>
        <span class="c1"># ×›×¤×ª×•×¨ ×©×™×ª×•×£ ×§×™×©×•×¨ ×œ×§×•×‘×¥ â€“ ×¨×§ ×‘××¡×š ×”×ª×¦×•×’×” (×œ× ×‘×¨×©×™××”)</span>
        <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”— ×©×ª×£ ×§×™×©×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mk_cb</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;share_selected_links_single&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">))])</span>
        <span class="k">if</span> <span class="n">end</span> <span class="o">&lt;</span> <span class="n">total_lines</span><span class="p">:</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;×”×¦×’ ×¢×•×“ â¤µï¸&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;view_more&quot;</span><span class="p">)])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># ×”×“×’×©×ª ×ª×—×‘×™×¨ ×§×™×™××ª ×‘××•×“×•×œ code_processor.highlight_code; × ×©×ª××© ×‘×” ×•××– × × ×§×” ×œ-Telegram</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">services</span><span class="w"> </span><span class="kn">import</span> <span class="n">code_service</span> <span class="k">as</span> <span class="n">code_processor</span>
                <span class="c1"># ×¤×•×¨××˜ ×©××™×¨×ª ×©×•×¨×•×ª ×›×‘×¨×™×¨×ª ××—×“×œ</span>
                <span class="n">lower_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">path</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="c1"># ×× YAML â€“ × ×¡×” ×¦×‘×™×¢×” ×™×©×™×¨×”, ××—×¨×ª ×›×œ×œ×™</span>
                <span class="k">if</span> <span class="n">lower_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.yml&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">lower_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.yaml&#39;</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">highlighted_html</span> <span class="o">=</span> <span class="n">code_processor</span><span class="o">.</span><span class="n">highlight_code</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="s1">&#39;yaml&#39;</span><span class="p">)</span>
                        <span class="n">body</span> <span class="o">=</span> <span class="n">highlighted_html</span> <span class="ow">or</span> <span class="sa">f</span><span class="s2">&quot;&lt;pre&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/pre&gt;&quot;</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;pre&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/pre&gt;&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># ×©××™×¨×ª ×©×•×¨×•×ª ×‘×›×•×— ×¢×‘×•×¨ ×¡×•×’×™ ×§×‘×¦×™× ×¨×’×™×©×™× ×œ×¢×™×¦×•×‘</span>
                    <span class="n">force_pre_exts</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;.md&#39;</span><span class="p">,</span> <span class="s1">&#39;.markdown&#39;</span><span class="p">,</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">lower_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">force_pre_exts</span><span class="p">):</span>
                        <span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;pre&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/pre&gt;&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># × ×¡×” ×”×™×™×œ×™×™×˜; ×× ×™×•×¦×¨×ª ×‘×œ×’×Ÿ, fallback ×œ-pre</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">highlighted_html</span> <span class="o">=</span> <span class="n">code_processor</span><span class="o">.</span><span class="n">highlight_code</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">lang</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">highlighted_html</span> <span class="ow">or</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">chunk</span><span class="p">:</span>
                                <span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;pre&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/pre&gt;&quot;</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">body</span> <span class="o">=</span> <span class="n">highlighted_html</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;pre&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/pre&gt;&quot;</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;pre&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/pre&gt;&quot;</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">header</span> <span class="o">+</span> <span class="n">body</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">rows</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">raise</span>

<div class="viewcode-block" id="GitHubMenuHandler.show_import_branch_menu">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_import_branch_menu">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">show_import_branch_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;××¦×™×’ ×‘×—×™×¨×ª ×¢× ×£ ×œ×™×™×‘×•× ×¨×™×¤×• (×¢×™××•×“).&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_full</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_full</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×—×¡×¨ ×˜×•×§×Ÿ ××• ×¨×™×¤×• × ×‘×—×¨&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># ×”×•×“×¢×ª ×˜×¢×™× ×” ×‘×–××Ÿ ×©×œ×™×¤×ª ×”×¢× ×¤×™×</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">TelegramUtils</span><span class="o">.</span><span class="n">safe_edit_message_text</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s2">&quot;â³ ×˜×•×¢×Ÿ ×¨×©×™××ª ×¢× ×¤×™×â€¦&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_full</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># ××™×Ÿ ×¢× ×£ ×‘×©×œ×‘ ×–×”; ×“×•×•×— ×¨×§ ×¢×œ ×”×¨×™×¤×•</span>
                <span class="n">emit_event</span><span class="p">(</span><span class="s2">&quot;github_import_repo_error&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">repo</span><span class="o">=</span><span class="n">repo_full</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×¨×™×¤×•: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">branches</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">repo</span><span class="o">.</span><span class="n">get_branches</span><span class="p">())</span>
            <span class="c1"># ××™×™×Ÿ: main ×¨××©×•×Ÿ; ××—×¨×™×• ×œ×¤×™ ×¢×“×›×•×Ÿ commit ××—×¨×•×Ÿ (×—×“×©â†’×™×©×Ÿ)</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">_branch_sort_key</span><span class="p">(</span><span class="n">br</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># commit.last_modified ×œ× ×§×™×™× ×ª××™×“; × ×™×§×— commit.commit.author.date</span>
                    <span class="k">return</span> <span class="n">br</span><span class="o">.</span><span class="n">commit</span><span class="o">.</span><span class="n">commit</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">date</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">min</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
            <span class="c1"># ×¨×©×™××ª ×¢× ×¤×™× ××œ××”</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">branches</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">MAX_BRANCH_DATE_FETCH</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">branches_sorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">branches</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">_branch_sort_key</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">branches_sorted</span> <span class="o">=</span> <span class="n">branches</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">branches_sorted</span> <span class="o">=</span> <span class="n">branches</span>
            <span class="c1"># ×”×•×¦× main ×œ×¨××© (×× ×§×™×™×)</span>
            <span class="n">main_idx</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">branches_sorted</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;main&#39;</span> <span class="ow">or</span> <span class="n">b</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;master&#39;</span><span class="p">)),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">main_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">main_br</span> <span class="o">=</span> <span class="n">branches_sorted</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">main_idx</span><span class="p">)</span>
                <span class="n">branches_sorted</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">main_br</span><span class="p">)</span>
            <span class="n">branches</span> <span class="o">=</span> <span class="n">branches_sorted</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×©×œ×™×¤×ª ×¢× ×¤×™×: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;import_branches_page&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">page_size</span> <span class="o">=</span> <span class="mi">8</span>
        <span class="n">total_pages</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">branches</span><span class="p">)</span> <span class="o">+</span> <span class="n">page_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">page_size</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">page</span> <span class="o">*</span> <span class="n">page_size</span>
        <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">page_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">branches</span><span class="p">))</span>
        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># ××™×¤×•×™ ××¡×™××•× ×™× ×§×¦×¨×™× ×œ×©××•×ª ×¢× ×¤×™× ×›×“×™ ×œ×¢××•×“ ×‘××’×‘×œ×ª 64 ×‘×ª×™× ×©×œ Telegram</span>
        <span class="n">token_map</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;import_branch_token_map&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="c1"># ×ª×¦×•×’×” ××—×™×“×”: main ×¨××©×•×Ÿ (×›×‘×¨ ××•×§×¤×¥ ×œ××¢×œ×” ×‘××™×•×Ÿ) ×•××– ×›×œ ×”×¢× ×¤×™× â€“ ×××•×™× ×™× ××”×—×“×© ×œ×™×©×Ÿ</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">br</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">branches</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]):</span>
            <span class="n">token</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;i</span><span class="si">{</span><span class="n">start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">token_map</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="o">=</span> <span class="n">br</span><span class="o">.</span><span class="n">name</span>
            <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ğŸŒ¿ </span><span class="si">{</span><span class="n">br</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;import_repo_select_branch:</span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
        <span class="n">nav</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">page</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;â¬…ï¸ ×”×§×•×“×&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;import_repo_branches_page_</span><span class="si">{</span><span class="n">page</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ğŸ“„ </span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total_pages</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;noop&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">page</span> <span class="o">&lt;</span> <span class="n">total_pages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;×”×‘× â¡ï¸&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;import_repo_branches_page_</span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">nav</span><span class="p">:</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nav</span><span class="p">)</span>
        <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)])</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
            <span class="s2">&quot;â¬‡ï¸ ×‘×—×¨/×™ ×¢× ×£ ×œ×™×™×‘×•× ×§×‘×¦×™× ××”×¨×™×¤×•:&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
        <span class="p">)</span></div>


    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_confirm_import_repo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;××¡×š ××™×©×•×¨ ×œ×™×™×‘×•× ×¢× ×”×¡×‘×¨ ×§×¦×¨ ×›×“×™ ×œ×× ×•×¢ ×‘×œ×‘×•×œ ×¢× ×’×™×‘×•×™×™×.&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_full</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;â¬‡ï¸ ×™×™×‘×•× ×¨×™×¤×• ×-GitHub</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;×–×”×• &lt;b&gt;×™×™×‘×•× ×§×‘×¦×™×&lt;/b&gt; ×•×œ× ×™×¦×™×¨×ª ×’×™×‘×•×™ ZIP.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;× ×•×¨×™×“ ZIP ×¨×©××™, × ×—×œ×¥ ×œ-/tmp, × ×§×œ×˜ ×œ×§×‘×¦×™× ×‘××¡×“ ×¢× ×ª×’×™×•×ª:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;&lt;code&gt;repo:</span><span class="si">{</span><span class="n">repo_full</span><span class="si">}</span><span class="s2">&lt;/code&gt;, &lt;code&gt;source:github&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;× ×›×‘×“ ××’×‘×œ×•×ª ×’×•×“×œ/×›××•×ª, × ×“×œ×’ ×¢×œ ×‘×™× ××¨×™×™× ×•-&lt;code&gt;.git&lt;/code&gt; ×•×ª×™×§×™×•×ª ××™×•×ª×¨×•×ª.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;×¢× ×£: &lt;code&gt;</span><span class="si">{</span><span class="n">branch</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;×œ×”××©×™×š?&quot;</span>
        <span class="p">)</span>
        <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;âœ… ×›×Ÿ, ×™×™×‘×&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;import_repo_start&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;âŒ ×‘×™×˜×•×œ&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;import_repo_cancel&quot;</span><span class="p">)],</span>
        <span class="p">]</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="GitHubMenuHandler.import_repo_from_zip">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.import_repo_from_zip">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">import_repo_from_zip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">repo_full</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;××•×¨×™×“ ZIP ×¨×©××™ ×©×œ GitHub (zipball) ×œ×¢× ×£, ××—×œ×¥ ×œ-tmp, ×•××§×œ×™×˜ ×§×‘×¦×™× ×œ-DB ×¢× ×ª×’×™×•×ª repo/source.</span>

<span class="sd">        ×©××™×¨×”: CodeSnippet ×œ×§×‘×¦×™× ×˜×§×¡×˜×•××œ×™×™× ×§×˜× ×™× (×¢×“ IMPORT_MAX_FILE_BYTES) ×¢×“ ×¡×š IMPORT_MAX_TOTAL_BYTES ×•××§×¡&#39; IMPORT_MAX_FILES.</span>
<span class="sd">        ××“×œ×’ ×¢×œ ×‘×™× ××¨×™×™×, ×§×‘×¦×™ ×¢× ×§, ×•×ª×™×§×™×•×ª ××™×•×ª×¨×•×ª. ×× ×§×” tmp ×‘×¡×•×£.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">emit_event</span><span class="p">(</span><span class="s2">&quot;github_import_repo_error&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="s2">&quot;missing_token&quot;</span><span class="p">,</span> <span class="n">repo</span><span class="o">=</span><span class="n">repo_full</span><span class="p">,</span> <span class="n">branch</span><span class="o">=</span><span class="n">branch</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×—×¡×¨ ×˜×•×§×Ÿ GitHub&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># ×™×¦×™×¨×ª ×œ×§×•×— GitHub</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">emit_event</span><span class="p">(</span><span class="s2">&quot;github_import_repo_error&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">repo</span><span class="o">=</span><span class="n">repo_full</span><span class="p">,</span> <span class="n">branch</span><span class="o">=</span><span class="n">branch</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×”×›× ×ª ×—×™×‘×•×¨ ×œâ€‘GitHub: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_full</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×¨×™×¤×•: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;â³ ××•×¨×™×“ ZIP ×¨×©××™ ×•××™×™×‘× ×§×‘×¦×™×â€¦ ×–×” ×¢×©×•×™ ×œ×§×—×ª 1â€“8 ×“×§×•×ª&quot;</span><span class="p">)</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">zipfile</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_zip</span>
        <span class="n">tmp_dir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">zip_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">extracted_dir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">saved</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">updated</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_bytes</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">skipped</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># ×§×‘×œ×ª ×§×™×©×•×¨ zipball ×¢×‘×•×¨ branch</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_archive_link</span><span class="p">(</span><span class="s2">&quot;zipball&quot;</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">branch</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="c1"># ×’×¨×¡××•×ª PyGithub ×™×©× ×•×ª ×œ× ××§×‘×œ×•×ª ref; × × ×¡×” ×œ×œ× ref</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_archive_link</span><span class="p">(</span><span class="s2">&quot;zipball&quot;</span><span class="p">)</span>
            <span class="c1"># ×”×•×¨×“×” ×‘××¦×‘ ×–×¨×™××” + ×× ×™×¢×ª ×“×—×™×¡×” ××™×•×ª×¨×ª</span>
            <span class="n">_headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Accept-Encoding&quot;</span><span class="p">:</span> <span class="s2">&quot;identity&quot;</span><span class="p">}</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">http_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">_headers</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="c1"># ×¢×‘×•×“×” ×‘-/tmp ×‘×œ×‘×“</span>
            <span class="n">tmp_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;codebot-gh-import-&quot;</span><span class="p">)</span>
            <span class="n">zip_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="s2">&quot;repo.zip&quot;</span><span class="p">)</span>
            <span class="c1"># ×‘×“×™×§×ª Content-Length ××•×œ ×ª×§×¨×ª IMPORT_MAX_TOTAL_BYTES (safety)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_cl</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Content-Length&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">_cl</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">_cl</span> <span class="ow">and</span> <span class="n">_cl</span> <span class="o">&gt;</span> <span class="n">IMPORT_MAX_TOTAL_BYTES</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×”â€‘ZIP ×’×“×•×œ ××“×™ ×œ×™×™×‘×•× ×™×©×™×¨ ×‘×¨××ª ×”×ª×•×›×Ÿ (××¢×œ 20MB). × ×¡×” ×™×™×‘×•× ×¡×œ×§×˜×™×‘×™ ××• ZIP ×—×œ×§×™.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="c1"># ×›×ª×™×‘×” ×‘×–×¨× ×œ×“×™×¡×§ ×ª×•×š ×©××™×¨×” ×¢×œ ×ª×§×¨×”</span>
            <span class="n">written</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">zip_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">resp</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">128</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">chunk</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                    <span class="n">written</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">written</span> <span class="o">&gt;</span> <span class="n">IMPORT_MAX_TOTAL_BYTES</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×”â€‘ZIP ×—×•×¨×’ ×××’×‘×œ×ª ×™×™×‘×•× ×”×ª×•×›×Ÿ (20MB). × ×¡×” ×™×™×‘×•× ×¡×œ×§×˜×™×‘×™.&quot;</span><span class="p">)</span>
                        <span class="k">return</span>
            <span class="c1"># ×—×œ×™×¦×” ×œ×ª×ª-×ª×™×§×™×™×” ×™×™×¢×•×“×™×ª</span>
            <span class="n">extracted_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="s2">&quot;repo&quot;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">extracted_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># ××“×•×“ ×–××Ÿ ×—×œ×™×¦×”</span>
            <span class="k">with</span> <span class="n">track_performance</span><span class="p">(</span><span class="s2">&quot;github_zip_extract&quot;</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">_zip</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">zip_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zf</span><span class="p">:</span>
                    <span class="n">zf</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">extracted_dir</span><span class="p">)</span>
            <span class="c1"># ××¦× ×©×•×¨×© (github zip ××•×¡×™×£ ×ª×™×§×™×™×ª prefix)</span>
            <span class="c1"># × ×‘×—×¨ ×ª×™×§×™×™×” ×”×¨××©×•× ×” ××ª×—×ª extracted_dir</span>
            <span class="n">roots</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">extracted_dir</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">extracted_dir</span><span class="p">)]</span>
            <span class="n">root</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">roots</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
                    <span class="n">root</span> <span class="o">=</span> <span class="n">p</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">root</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×œ× × ××¦××• ×§×‘×¦×™× ×œ××—×¨ ×—×œ×™×¦×”&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">database</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">detect_language_from_filename</span>
            <span class="n">repo_tag</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;repo:</span><span class="si">{</span><span class="n">repo_full</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">source_tag</span> <span class="o">=</span> <span class="s2">&quot;source:github&quot;</span>
            <span class="c1"># ××¢×‘×¨ ×¢×œ ×§×‘×¦×™×</span>
            <span class="k">for</span> <span class="n">cur_dir</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>
                <span class="c1"># ×¡×™× ×•×Ÿ ×ª×™×§×™×•×ª ××™×•×ª×¨×•×ª</span>
                <span class="n">dirnames</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dirnames</span> <span class="k">if</span> <span class="n">d</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">IMPORT_SKIP_DIRS</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
                    <span class="c1"># ×“×œ×’ ×¢×œ ×§×‘×¦×™ ZIP ×¢×¦×× ××• ×§×‘×¦×™× ××•×¡×ª×¨×™× ×¢× ×§×™×™×</span>
                    <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.zip&#39;</span><span class="p">):</span>
                        <span class="n">skipped</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">continue</span>
                    <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cur_dir</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                    <span class="n">rel_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span>
                    <span class="c1"># ×“×œ×’ ×¢×œ × ×ª×™×‘×™× ×—×©×•×“×™×</span>
                    <span class="k">if</span> <span class="n">rel_path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
                        <span class="n">skipped</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">continue</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># ×§×¨× ×›-bytes ×•×‘×“×•×§ ×‘×™× ××¨×™/×’×•×“×œ</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                            <span class="n">raw</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">IMPORT_MAX_FILE_BYTES</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">IMPORT_MAX_FILE_BYTES</span><span class="p">:</span>
                            <span class="n">skipped</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">continue</span>
                        <span class="c1"># heuristic: ×× ×™×© ××¤×¡-×‘×™×™×˜×™× ×¨×‘×™× â†’ ×›× ×¨××” ×‘×™× ××¨×™</span>
                        <span class="k">if</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">raw</span><span class="p">:</span>
                            <span class="n">skipped</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">continue</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">text</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">text</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;latin-1&#39;</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="n">skipped</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">total_bytes</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">IMPORT_MAX_TOTAL_BYTES</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">saved</span> <span class="o">&gt;=</span> <span class="n">IMPORT_MAX_FILES</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">lang</span> <span class="o">=</span> <span class="n">detect_language_from_filename</span><span class="p">(</span><span class="n">rel_path</span><span class="p">)</span>
                        <span class="c1"># ×‘×“×•×§ ×× ×§×™×™× ×›×‘×¨ ×¢×‘×•×¨ ××•×ª×• ×¨×™×¤×• (×œ×¤×™ ×ª×’×™×ª repo:)</span>
                        <span class="n">prev_doc</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">rel_path</span><span class="p">)</span>
                        <span class="n">prev_tags</span> <span class="o">=</span> <span class="p">(</span><span class="n">prev_doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[])</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prev_doc</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span>
                        <span class="n">existed_for_repo</span> <span class="o">=</span> <span class="nb">any</span><span class="p">((</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">t</span> <span class="o">==</span> <span class="n">repo_tag</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">prev_tags</span><span class="p">)</span>
                        <span class="c1"># ××“×™×“×ª ×‘×™×¦×•×¢ ×¢×‘×•×¨ ×©××™×¨×” ×‘×•×“×“×ª</span>
                        <span class="k">with</span> <span class="n">track_performance</span><span class="p">(</span><span class="s2">&quot;github_import_save_file&quot;</span><span class="p">):</span>
                            <span class="n">ok</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">save_file</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="n">rel_path</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="n">text</span><span class="p">,</span> <span class="n">programming_language</span><span class="o">=</span><span class="n">lang</span><span class="p">,</span> <span class="n">extra_tags</span><span class="o">=</span><span class="p">[</span><span class="n">repo_tag</span><span class="p">,</span> <span class="n">source_tag</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">existed_for_repo</span><span class="p">:</span>
                                <span class="n">updated</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">saved</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="n">total_bytes</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">skipped</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">skipped</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">track_github_sync</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">files_count</span><span class="o">=</span><span class="n">saved</span> <span class="o">+</span> <span class="n">updated</span><span class="p">,</span> <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">emit_event</span><span class="p">(</span><span class="s2">&quot;github_sync&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">user_id</span><span class="p">),</span> <span class="n">files_count</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">saved</span> <span class="o">+</span> <span class="n">updated</span><span class="p">),</span> <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;âœ… ×™×™×‘×•× ×”×•×©×œ×: </span><span class="si">{</span><span class="n">saved</span><span class="si">}</span><span class="s2"> ×—×“×©×™×, </span><span class="si">{</span><span class="n">updated</span><span class="si">}</span><span class="s2"> ×¢×•×“×›× ×•, </span><span class="si">{</span><span class="n">skipped</span><span class="si">}</span><span class="s2"> ×“×™×œ×•×’×™×.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ”– ×ª×™×•×’: &lt;code&gt;</span><span class="si">{</span><span class="n">repo_tag</span><span class="si">}</span><span class="s2">&lt;/code&gt; (×•-&lt;code&gt;</span><span class="si">{</span><span class="n">source_tag</span><span class="si">}</span><span class="s2">&lt;/code&gt;)</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;â„¹ï¸ ×–×”×• ×™×™×‘×•× ×ª×•×›×Ÿ â€” ×œ× × ×•×¦×¨ ×’×™×‘×•×™ ZIP.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;×ª×•×›×œ ×œ××¦×•× ××ª ×”×§×‘×¦×™× ×‘×³ğŸ—‚ ×œ×¤×™ ×¨×™×¤×•×³.&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">emit_event</span><span class="p">(</span><span class="s2">&quot;github_import_repo_error&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">repo</span><span class="o">=</span><span class="n">repo_full</span><span class="p">,</span> <span class="n">branch</span><span class="o">=</span><span class="n">branch</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×™×™×‘×•×: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># × ×™×§×•×™ ×‘×˜×•×— ×©×œ tmp ×•×©×œ ×§×•×‘×¥ ×”-ZIP</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">zip_path</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">zip_path</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">zip_path</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">_safe_rmtree_tmp</span><span class="p">(</span><span class="n">extracted_dir</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">_safe_rmtree_tmp</span><span class="p">(</span><span class="n">tmp_dir</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.github_menu_command">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.github_menu_command">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">github_menu_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;××¦×™×’ ×ª×¤×¨×™×˜ GitHub&quot;&quot;&quot;</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>

        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

        <span class="c1"># × ×§×” ×“×’×œ×™ ×–×¨×™××ª &quot;×”×“×‘×§ ×§×•×“&quot; ×× ×”×™×• ×¤×¢×™×œ×™×, ×›×“×™ ×œ×× ×•×¢ ×ª×§×™×¢×” ×‘×–×¨×™××”</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;waiting_for_paste_content&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;waiting_for_paste_filename&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;paste_content&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># ×‘× ×” ×”×•×“×¢×ª ×¡×˜×˜×•×¡</span>
        <span class="n">status_msg</span> <span class="o">=</span> <span class="s2">&quot;&lt;b&gt;ğŸ”§ ×ª×¤×¨×™×˜ GitHub&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">token</span><span class="p">:</span>
            <span class="n">status_msg</span> <span class="o">+=</span> <span class="s2">&quot;ğŸ”‘ &lt;b&gt;××—×•×‘×¨ ×œ-GitHub&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">status_msg</span> <span class="o">+=</span> <span class="s2">&quot;ğŸ”’ &lt;b&gt;×œ× ××—×•×‘×¨&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">):</span>
            <span class="n">status_msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;ğŸ“ ×¨×™×¤×• × ×‘×—×¨: &lt;code&gt;</span><span class="si">{</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;selected_repo&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_folder&quot;</span><span class="p">):</span>
            <span class="n">status_msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;ğŸ“‚ ×ª×™×§×™×™×ª ×™×¢×“: &lt;code&gt;</span><span class="si">{</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;selected_folder&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># ×›×¤×ª×•×¨ ×”×’×“×¨×ª ×˜×•×§×Ÿ</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”‘ ×”×’×“×¨ ×˜×•×§×Ÿ GitHub&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;set_token&quot;</span><span class="p">)]</span>
            <span class="p">)</span>

        <span class="c1"># ×›×¤×ª×•×¨ ×‘×—×™×¨×ª ×¨×™×¤×• - ×–××™×Ÿ ×¨×§ ×¢× ×˜×•×§×Ÿ</span>
        <span class="k">if</span> <span class="n">token</span><span class="p">:</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ“ ×‘×—×¨ ×¨×™×¤×•&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;select_repo&quot;</span><span class="p">)])</span>
            <span class="c1"># ×™×¦×™×¨×ª ×¨×™×¤×• ×—×“×© ×-ZIP ×’× ×œ×œ× ×¨×™×¤×• × ×‘×—×¨</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ†• ×¦×•×¨ ×¨×™×¤×• ×—×“×© ×Ö¼ZIP&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_create_repo_from_zip&quot;</span><span class="p">)])</span>

        <span class="c1"># ×›×¤×ª×•×¨×™ ×”×¢×œ××” - ××•×¦×’×™× ×¨×§ ×× ×™×© ×¨×™×¤×• × ×‘×—×¨</span>
        <span class="k">if</span> <span class="n">token</span> <span class="ow">and</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">):</span>
            <span class="c1"># ×”×¢×‘×¨ ××ª &quot;×‘×—×¨ ×ª×™×§×™×™×ª ×™×¢×“&quot; ×œ××¢×œ×”, ×™×©×™×¨×•×ª ××—×¨×™ &quot;×‘×—×¨ ×¨×™×¤×•&quot;</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ“‚ ×‘×—×¨ ×ª×™×§×™×™×ª ×™×¢×“&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;set_folder&quot;</span><span class="p">)])</span>
            <span class="c1"># × ×™×•×•×˜ ×‘×¨×™×¤×•</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ—ƒï¸ ×¢×™×™×Ÿ ×‘×¨×™×¤×•&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;browse_repo&quot;</span><span class="p">)])</span>
            <span class="c1"># ×›×¤×ª×•×¨ ×”×¢×œ××”</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ“¤ ×”×¢×œ×” ×§×•×‘×¥ ×—×“×©&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;upload_file&quot;</span><span class="p">)])</span>
            <span class="c1"># ×¤×¢×•×œ×•×ª × ×•×¡×¤×•×ª ×‘×˜×•×—×•×ª</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ“¥ ×”×•×¨×“ ×§×•×‘×¥ ××”×¨×™×¤×•&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;download_file_menu&quot;</span><span class="p">)]</span>
            <span class="p">)</span>
            <span class="c1"># ×›×¤×ª×•×¨ ×™×™×‘×•× ×¨×™×¤×• (ZIP ×¨×©××™ â†’ ×™×™×‘×•× ×§×‘×¦×™× ×œ-DB)</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;â¬‡ï¸ ×”×•×¨×“ ×¨×™×¤×•&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_import_repo&quot;</span><span class="p">)]</span>
            <span class="p">)</span>
            <span class="c1"># ×¨×™×›×•×– ×¤×¢×•×œ×•×ª ××—×™×§×” ×‘×ª×¤×¨×™×˜ ××©× ×”</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ§¨ ××—×§ ×§×•×‘×¥/×¨×™×¤×• ×©×œ×&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;danger_delete_menu&quot;</span><span class="p">)]</span>
            <span class="p">)</span>
            <span class="c1"># ×”×ª×¨××•×ª ×—×›××•×ª</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”” ×”×ª×¨××•×ª ×—×›××•×ª&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;notifications_menu&quot;</span><span class="p">)]</span>
            <span class="p">)</span>
            <span class="c1"># ×ª×¤×¨×™×˜ ×’×™×‘×•×™/×©×—×–×•×¨ ××¨×•×›×–</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ§° ×’×™×‘×•×™ ×•×©×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_backup_menu&quot;</span><span class="p">)]</span>
            <span class="p">)</span>
        <span class="c1"># ×›×¤×ª×•×¨ × ×™×ª×•×— ×¨×™×¤×• - ×ª××™×“ ××•×¦×’ ×× ×™×© ×˜×•×§×Ÿ</span>
        <span class="k">if</span> <span class="n">token</span><span class="p">:</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ” × ×ª×— ×¨×™×¤×•&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;analyze_repo&quot;</span><span class="p">)])</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;âœ… ×‘×“×•×§ ×ª×§×™× ×•×ª ×¨×™×¤×•&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;validate_repo&quot;</span><span class="p">)])</span>
            <span class="c1"># ×›×¤×ª×•×¨ ×™×¦×™××” (××—×™×§×ª ×˜×•×§×Ÿ) ×›××©×¨ ×™×© ×˜×•×§×Ÿ</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸšª ×”×ª× ×ª×§ ××’×™×˜×”××‘&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;logout_github&quot;</span><span class="p">)]</span>
            <span class="p">)</span>

        <span class="c1"># ×›×¤×ª×•×¨ ×”×¦×’×ª ×”×’×“×¨×•×ª</span>
        <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ“‹ ×”×¦×’ ×”×’×“×¨×•×ª × ×•×›×—×™×•×ª&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;show_current&quot;</span><span class="p">)]</span>
        <span class="p">)</span>

        <span class="c1"># ×›×¤×ª×•×¨ ×¡×’×™×¨×”</span>
        <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;âŒ ×¡×’×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;close_menu&quot;</span><span class="p">)])</span>

        <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="n">status_msg</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="n">status_msg</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="GitHubMenuHandler.handle_menu_callback">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.handle_menu_callback">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_menu_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle menu button clicks&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;ğŸ“± GitHub handler received callback: </span><span class="si">{</span><span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="si">}</span><span class="s2"> from user </span><span class="si">{</span><span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">emit_event</span><span class="p">(</span>
                <span class="s2">&quot;github_callback_received&quot;</span><span class="p">,</span>
                <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)),</span>
                <span class="n">user_id</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s2">&quot;from_user&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>

        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;select_repo&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_repo_selection</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;browse_repo&quot;</span><span class="p">:</span>
            <span class="c1"># ××¦×‘ ×¢×™×•×Ÿ ×‘×¨×™×¤×• ×¢× ×ª×¦×•×’×ª ×§×‘×¦×™×</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;view&quot;</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;multi_mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;multi_selection&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_repo_browser</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;upload_file&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×§×•×“× ×‘×—×¨ ×¨×™×¤×•!</span><span class="se">\n</span><span class="s2">×©×œ×— /github ×•×‘×—×¨ &#39;×‘×—×¨ ×¨×™×¤×•&#39;&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">folder_display</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_folder&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;root&quot;</span>
                <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;âœï¸ ×”×“×‘×§ ×§×•×“&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;upload_paste_code&quot;</span><span class="p">)],</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ—‚ ×œ×¤×™ ×¨×™×¤×•&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;gh_upload_cat:repos&quot;</span><span class="p">)],</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ“¦ ×§×‘×¦×™ ZIP&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;gh_upload_cat:zips&quot;</span><span class="p">)],</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ“‚ ×§×‘×¦×™× ×’×“×•×œ×™×&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;gh_upload_cat:large&quot;</span><span class="p">)],</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ“ ×©××¨ ×”×§×‘×¦×™×&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;gh_upload_cat:other&quot;</span><span class="p">)],</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)],</span>
                <span class="p">]</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;ğŸ“¤ &lt;b&gt;×”×¢×œ××ª ×§×•×‘×¥ ×œ×¨×™×¤×•&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;×¨×™×¤×•: &lt;code&gt;</span><span class="si">{</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;selected_repo&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;ğŸ“‚ ×ª×™×§×™×™×”: &lt;code&gt;</span><span class="si">{</span><span class="n">folder_display</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;×‘×—×¨ ××§×•×¨ ×œ×”×¢×œ××”:&quot;</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span>
                    <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">return</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;cancel_paste_flow&quot;</span><span class="p">:</span>
            <span class="c1"># ×‘×™×˜×•×œ ××¤×•×¨×© ×©×œ ×–×¨×™××ª &quot;×”×“×‘×§ ×§×•×“&quot;: × ×§×” ×“×’×œ×™× ×•×—×–×•×¨ ×œ×ª×¤×¨×™×˜ ×”×¢×œ××”</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;waiting_for_paste_content&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;waiting_for_paste_filename&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;paste_content&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="c1"># × ×•×•×˜ ×—×–×¨×” ×œ××¡×š &quot;×”×¢×œ×” ×§×•×‘×¥ ×—×“×©&quot;</span>
            <span class="c1"># ×¢×œ ×™×“×™ ×§×¨×™××” ×¢×¦××™×ª ×œ×¡×¢×™×£ upload_file</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×§×•×“× ×‘×—×¨ ×¨×™×¤×•!</span><span class="se">\n</span><span class="s2">×©×œ×— /github ×•×‘×—×¨ &#39;×‘×—×¨ ×¨×™×¤×•&#39;&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">folder_display</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_folder&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;root&quot;</span>
                <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;âœï¸ ×”×“×‘×§ ×§×•×“&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;upload_paste_code&quot;</span><span class="p">)],</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ—‚ ×œ×¤×™ ×¨×™×¤×•&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;gh_upload_cat:repos&quot;</span><span class="p">)],</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ“¦ ×§×‘×¦×™ ZIP&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;gh_upload_cat:zips&quot;</span><span class="p">)],</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ“‚ ×§×‘×¦×™× ×’×“×•×œ×™×&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;gh_upload_cat:large&quot;</span><span class="p">)],</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ“ ×©××¨ ×”×§×‘×¦×™×&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;gh_upload_cat:other&quot;</span><span class="p">)],</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)],</span>
                <span class="p">]</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;ğŸ“¤ &lt;b&gt;×”×¢×œ××ª ×§×•×‘×¥ ×œ×¨×™×¤×•&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;×¨×™×¤×•: &lt;code&gt;</span><span class="si">{</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;selected_repo&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;ğŸ“‚ ×ª×™×§×™×™×”: &lt;code&gt;</span><span class="si">{</span><span class="n">folder_display</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;×‘×—×¨ ××§×•×¨ ×œ×”×¢×œ××”:&quot;</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span>
                    <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;upload_paste_code&quot;</span><span class="p">:</span>
            <span class="c1"># ×”×ª×—×œ×ª ×–×¨×™××ª &quot;×”×“×‘×§ ×§×•×“&quot;</span>
            <span class="c1"># × ×§×” ×“×’×œ×™× ×™×©× ×™×</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;waiting_for_paste_content&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;waiting_for_paste_filename&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;paste_content&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_paste_content&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="s2">&quot;âœï¸ ×©×œ×—/×™ ×›××Ÿ ××ª ×”×§×•×“ ×œ×”×¢×œ××” ×›×˜×§×¡×˜.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;×œ××—×¨ ××›×Ÿ ××‘×§×© ××ª ×©× ×”×§×•×‘×¥ (×›×•×œ×œ ×¡×™×•××ª).&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">([</span>
                    <span class="p">[</span>
                        <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;upload_file&quot;</span><span class="p">),</span>
                        <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;âŒ ×‘×™×˜×•×œ&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;cancel_paste_flow&quot;</span><span class="p">),</span>
                    <span class="p">]</span>
                <span class="p">]),</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;gh_upload_cat:repos&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_upload_repos</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;gh_upload_cat:zips&quot;</span><span class="p">:</span>
            <span class="c1"># ×”×¦×’ ××ª ×›×œ ×§×‘×¦×™ ×”â€‘ZIP ×©×©××•×¨×™× ×‘×‘×•×˜, ×œ×œ× ×¡×™× ×•×Ÿ ×œ×¤×™ ×¨×™×¤×•</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;zip_back_to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;github_upload&#39;</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;github_backup_context_repo&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">backup_handler</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">bot_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;backup_handler&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">backup_handler</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">backup_menu_handler</span><span class="w"> </span><span class="kn">import</span> <span class="n">BackupMenuHandler</span>  <span class="c1"># ×˜×¢×™× ×” ×¢×¦×œ×” ×œ×× ×™×¢×ª ×ª×œ×•×ª ××¢×’×œ×™×ª</span>
                    <span class="n">backup_handler</span> <span class="o">=</span> <span class="n">BackupMenuHandler</span><span class="p">()</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">bot_data</span><span class="p">[</span><span class="s1">&#39;backup_handler&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">backup_handler</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×¨×›×™×‘ ×’×™×‘×•×™ ×œ× ×–××™×Ÿ: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">backup_handler</span><span class="o">.</span><span class="n">_show_backups_list</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×§×‘×¦×™ ZIP: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;gh_upload_zip_browse:&quot;</span><span class="p">):</span>
            <span class="c1"># ×¢×™×•×Ÿ ×‘×§×•×‘×¥ ZIP ×©××•×¨ ×•×‘×—×™×¨×ª ×§×•×‘×¥ ××ª×•×›×• ×œ×”×¢×œ××” ×œ×¨×™×¤×•</span>
            <span class="n">backup_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
            <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_name</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×—×¡×¨×™× × ×ª×•× ×™× (×‘×—×¨ ×¨×™×¤×• ×¢× /github)&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">infos</span> <span class="o">=</span> <span class="n">backup_manager</span><span class="o">.</span><span class="n">list_backups</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                <span class="n">match</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">infos</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s1">&#39;backup_id&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">backup_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">match</span><span class="o">.</span><span class="n">file_path</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">file_path</span><span class="p">):</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×”×’×™×‘×•×™ ×œ× × ××¦× ×‘×“×™×¡×§&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="c1"># ×§×¨× ×©××•×ª ×§×‘×¦×™× ××ª×•×š ×”â€‘ZIP (×œ×œ× ×ª×™×§×™×•×ª ×•-metadata.json)</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">zipfile</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_zip</span>
                <span class="n">names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">with</span> <span class="n">_zip</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zf</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">zf</span><span class="o">.</span><span class="n">namelist</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="s1">&#39;metadata.json&#39;</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">names</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;â„¹ï¸ ××™×Ÿ ×§×‘×¦×™× ×‘â€‘ZIP&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="c1"># ×¢×™××•×“ ×‘×¡×™×¡×™</span>
                <span class="n">page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gh_zip_browse_page&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">PAGE</span> <span class="o">=</span> <span class="mi">10</span>
                <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
                <span class="n">total_pages</span> <span class="o">=</span> <span class="p">(</span><span class="n">total</span> <span class="o">+</span> <span class="n">PAGE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">PAGE</span>
                <span class="k">if</span> <span class="n">page</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">page</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">page</span> <span class="o">&gt;</span> <span class="n">total_pages</span><span class="p">:</span>
                    <span class="n">page</span> <span class="o">=</span> <span class="n">total_pages</span>
                <span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">PAGE</span>
                <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">PAGE</span><span class="p">,</span> <span class="n">total</span><span class="p">)</span>
                <span class="n">slice_names</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
                <span class="c1"># ×©××™×¨×ª ××™×¤×•×™ ×©××•×ª ×‘×§××© ×”×¡×©×Ÿ ×›×“×™ ×œ×”×™×× ×¢ ×-callback ××¨×•×š ××“×™</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">cache</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;gh_zip_cache&#39;</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="n">cache</span><span class="p">[</span><span class="n">backup_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;names&#39;</span><span class="p">:</span> <span class="n">names</span><span class="p">}</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="c1"># ×‘× ×” ×›×¤×ª×•×¨×™× ×œ×‘×—×™×¨×ª ×§×•×‘×¥ ×œ×”×¢×œ××” + ×¢×™××•×“ + ×—×–×¨×” (×œ×¤×™ ××™× ×“×§×¡)</span>
                <span class="n">kb</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">slice_names</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">):</span>
                    <span class="n">safe_label</span> <span class="o">=</span> <span class="n">n</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">64</span> <span class="k">else</span> <span class="p">(</span><span class="n">n</span><span class="p">[:</span><span class="mi">30</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;â€¦&#39;</span> <span class="o">+</span> <span class="n">n</span><span class="p">[</span><span class="o">-</span><span class="mi">30</span><span class="p">:])</span>
                    <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">safe_label</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;gh_upload_zip_select_idx:</span><span class="si">{</span><span class="n">backup_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
                <span class="c1"># ×¢×™××•×“</span>
                <span class="n">nav</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">page</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;â¬…ï¸ ×”×§×•×“×&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;gh_upload_zip_page:</span><span class="si">{</span><span class="n">backup_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">page</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">page</span> <span class="o">&lt;</span> <span class="n">total_pages</span><span class="p">:</span>
                    <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;×”×‘× â¡ï¸&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;gh_upload_zip_page:</span><span class="si">{</span><span class="n">backup_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">nav</span><span class="p">:</span>
                    <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nav</span><span class="p">)</span>
                <span class="c1"># ×—×–×•×¨ ×œ×¨×©×™××ª ×”â€‘ZIP×™× ×©×œ ×”×¢×œ××”</span>
                <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;gh_upload_cat:zips&quot;</span><span class="p">)])</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;×‘×—×¨ ×§×•×‘×¥ ××ª×•×š ZIP ×œ×”×¢×œ××” ×œ×¨×™×¤×•:</span><span class="se">\n</span><span class="s2">&lt;code&gt;</span><span class="si">{</span><span class="n">backup_id</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">×¢××•×“ </span><span class="si">{</span><span class="n">page</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total_pages</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span>
                    <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×§×¨×™××ª ZIP: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;gh_upload_zip_page:&quot;</span><span class="p">):</span>
            <span class="c1"># × ×™×•×•×˜ ×¢××•×“×™× ×‘×¢×™×•×Ÿ ×”â€‘ZIP</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">backup_id</span><span class="p">,</span> <span class="n">page_str</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;gh_zip_browse_page&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">page_str</span><span class="p">))</span>
                <span class="c1"># ×”×‘×™× ××—×“×© ××ª ××•×ª×• ××¡×š</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_menu_callback</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
                <span class="c1"># ×”×—×œ×£ ××ª ×”-callback ×œ-browse ×›×“×™ ×œ×”×¤×¢×™×œ ××ª ×”×¢×“×›×•×Ÿ</span>
                <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;gh_upload_zip_browse:</span><span class="si">{</span><span class="n">backup_id</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_menu_callback</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;×©×’×™××ª ×¢×™××•×“&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;gh_upload_zip_select_idx:&quot;</span><span class="p">):</span>
            <span class="c1"># ×‘×—×™×¨×ª ×§×•×‘×¥ ××ª×•×š ZIP ×œ×¤×™ ××™× ×“×§×¡ ×›×“×™ ×œ×¢××•×“ ×‘××’×‘×œ×ª 64 ×‘×ª×™× ×©×œ callback_data</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">backup_id</span><span class="p">,</span> <span class="n">idx_str</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">idx_str</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;×‘×§×©×” ×œ× ×ª×§×¤×”&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
            <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_name</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×—×¡×¨×™× × ×ª×•× ×™× (×‘×—×¨ ×¨×™×¤×• ×¢× /github)&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="c1"># ××¦× ××ª ×”× ×ª×™×‘ ×”×¤× ×™××™ ×œ×¤×™ ×”×§××©; ×× ×œ× ×§×™×™× â€” ×˜×¢×Ÿ ××—×“×© ××”â€‘ZIP</span>
            <span class="n">inner_path</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cache</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gh_zip_cache&#39;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">names</span> <span class="o">=</span> <span class="p">(</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">backup_id</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;names&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">):</span>
                    <span class="n">inner_path</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">inner_path</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">inner_path</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">infos</span> <span class="o">=</span> <span class="n">backup_manager</span><span class="o">.</span><span class="n">list_backups</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">infos</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s1">&#39;backup_id&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">backup_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">match</span><span class="o">.</span><span class="n">file_path</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">file_path</span><span class="p">):</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×”×’×™×‘×•×™ ×œ× × ××¦× ×‘×“×™×¡×§&quot;</span><span class="p">)</span>
                        <span class="k">return</span>
                    <span class="kn">import</span><span class="w"> </span><span class="nn">zipfile</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_zip</span>
                    <span class="k">with</span> <span class="n">_zip</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zf</span><span class="p">:</span>
                        <span class="n">all_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">zf</span><span class="o">.</span><span class="n">namelist</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">n</span> <span class="o">!=</span> <span class="s1">&#39;metadata.json&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_names</span><span class="p">):</span>
                        <span class="n">inner_path</span> <span class="o">=</span> <span class="n">all_names</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×¤×¨×™×˜ ×œ× ×§×™×™× ×‘â€‘ZIP&quot;</span><span class="p">)</span>
                        <span class="k">return</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×§×¨×™××ª ZIP: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
            <span class="c1"># ×”××©×š ×–×¨×™××ª ×”×¢×œ××” ×–×”×” ×œ×‘×—×™×¨×” ×œ×¤×™ ××—×¨×•×–×ª</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">infos</span> <span class="o">=</span> <span class="n">backup_manager</span><span class="o">.</span><span class="n">list_backups</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                <span class="n">match</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">infos</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s1">&#39;backup_id&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">backup_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">match</span><span class="o">.</span><span class="n">file_path</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">file_path</span><span class="p">):</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×”×’×™×‘×•×™ ×œ× × ××¦× ×‘×“×™×¡×§&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">zipfile</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_zip</span>
                <span class="k">with</span> <span class="n">_zip</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zf</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">raw</span> <span class="o">=</span> <span class="n">zf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">inner_path</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×§×•×‘×¥ ×œ× × ××¦× ×‘×ª×•×š ×”â€‘ZIP&quot;</span><span class="p">)</span>
                        <span class="k">return</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">content_text</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">content_text</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;latin-1&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×œ× × ×™×ª×Ÿ ×œ×¤×¢× ×— ××ª ×”×§×•×‘×¥: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">return</span>
                <span class="n">target_folder</span> <span class="o">=</span> <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;upload_target_folder&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_folder&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
                <span class="n">target_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target_folder</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">inner_path</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">target_folder</span> <span class="k">else</span> <span class="n">inner_path</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">re</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_re</span>
                <span class="n">target_path</span> <span class="o">=</span> <span class="n">_re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;/+&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">target_path</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">))</span>
                <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span>
                <span class="n">branch</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;upload_target_branch&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">repo</span><span class="o">.</span><span class="n">default_branch</span> <span class="ow">or</span> <span class="s2">&quot;main&quot;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">existing</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="n">target_path</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">branch</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">update_file</span><span class="p">(</span>
                        <span class="n">path</span><span class="o">=</span><span class="n">target_path</span><span class="p">,</span>
                        <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Update </span><span class="si">{</span><span class="n">inner_path</span><span class="si">}</span><span class="s2"> via Telegram bot&quot;</span><span class="p">,</span>
                        <span class="n">content</span><span class="o">=</span><span class="n">content_text</span><span class="p">,</span>
                        <span class="n">sha</span><span class="o">=</span><span class="n">existing</span><span class="o">.</span><span class="n">sha</span><span class="p">,</span>
                        <span class="n">branch</span><span class="o">=</span><span class="n">branch</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âœ… ×”×§×•×‘×¥ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×” ×œ-&lt;code&gt;</span><span class="si">{</span><span class="n">target_path</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">create_file</span><span class="p">(</span>
                        <span class="n">path</span><span class="o">=</span><span class="n">target_path</span><span class="p">,</span>
                        <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Upload </span><span class="si">{</span><span class="n">inner_path</span><span class="si">}</span><span class="s2"> via Telegram bot&quot;</span><span class="p">,</span>
                        <span class="n">content</span><span class="o">=</span><span class="n">content_text</span><span class="p">,</span>
                        <span class="n">branch</span><span class="o">=</span><span class="n">branch</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âœ… ×”×§×•×‘×¥ ×”×•×¢×œ×” ×‘×”×¦×œ×—×” ×œ-&lt;code&gt;</span><span class="si">{</span><span class="n">target_path</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span>
                <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;â• ×”×¢×œ×” ×§×•×‘×¥ × ×•×¡×£ ××”â€‘ZIP&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;gh_upload_zip_browse:</span><span class="si">{</span><span class="n">backup_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)],</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;gh_upload_cat:zips&quot;</span><span class="p">)],</span>
                <span class="p">]</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;ğŸ¯ ×‘×—×¨ ×¤×¢×•×œ×”:&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×”×¢×œ××”: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;gh_upload_zip_select:&quot;</span><span class="p">):</span>
            <span class="c1"># ×‘×—×™×¨×ª ×§×•×‘×¥ ×¡×¤×¦×™×¤×™ ××ª×•×š ZIP ×œ×”×¢×œ××” ×œ×¨×™×¤×•</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">backup_id</span><span class="p">,</span> <span class="n">inner_path</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;×‘×§×©×” ×œ× ×ª×§×¤×”&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
            <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_name</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×—×¡×¨×™× × ×ª×•× ×™× (×‘×—×¨ ×¨×™×¤×• ×¢× /github)&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="c1"># ×‘×“×•×§ ××ª ×”â€‘ZIP ×•×”×•×¦× ××ª ×”×ª×•×›×Ÿ ×©×œ ×”×§×•×‘×¥</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">infos</span> <span class="o">=</span> <span class="n">backup_manager</span><span class="o">.</span><span class="n">list_backups</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                <span class="n">match</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">infos</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s1">&#39;backup_id&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">backup_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">match</span><span class="o">.</span><span class="n">file_path</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">file_path</span><span class="p">):</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×”×’×™×‘×•×™ ×œ× × ××¦× ×‘×“×™×¡×§&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">zipfile</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_zip</span>
                <span class="k">with</span> <span class="n">_zip</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zf</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">raw</span> <span class="o">=</span> <span class="n">zf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">inner_path</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×§×•×‘×¥ ×œ× × ××¦× ×‘×ª×•×š ×”â€‘ZIP&quot;</span><span class="p">)</span>
                        <span class="k">return</span>
                <span class="c1"># ×”××¨×ª ×ª×•×›×Ÿ ×œ×˜×§×¡×˜ (utf-8 ××• latin-1)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">content_text</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">content_text</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;latin-1&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×œ× × ×™×ª×Ÿ ×œ×¤×¢× ×— ××ª ×”×§×•×‘×¥: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">return</span>
                <span class="c1"># ×™×¢×“: × ×ª×™×‘ ×”×ª×™×§×™×™×” ×©× ×‘×—×¨×” + ×©× ×”×§×•×‘×¥ ×”××§×•×¨×™ ××”â€‘ZIP</span>
                <span class="n">target_folder</span> <span class="o">=</span> <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;upload_target_folder&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_folder&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
                <span class="n">target_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target_folder</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">inner_path</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">target_folder</span> <span class="k">else</span> <span class="n">inner_path</span>
                <span class="c1"># ×•×“× ×©×™××•×© ×‘× ×ª×™×‘ × ×§×™ ×œ×œ× ×›×¤×™×œ×•×™×•×ª &#39;/&#39;</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">re</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_re</span>
                <span class="n">target_path</span> <span class="o">=</span> <span class="n">_re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;/+&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">target_path</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">))</span>
                <span class="c1"># ×‘×¦×¢ ×™×¦×™×¨×”/×¢×“×›×•×Ÿ</span>
                <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span>
                <span class="n">branch</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;upload_target_branch&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">repo</span><span class="o">.</span><span class="n">default_branch</span> <span class="ow">or</span> <span class="s2">&quot;main&quot;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">existing</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="n">target_path</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">branch</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">update_file</span><span class="p">(</span>
                        <span class="n">path</span><span class="o">=</span><span class="n">target_path</span><span class="p">,</span>
                        <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Update </span><span class="si">{</span><span class="n">inner_path</span><span class="si">}</span><span class="s2"> via Telegram bot&quot;</span><span class="p">,</span>
                        <span class="n">content</span><span class="o">=</span><span class="n">content_text</span><span class="p">,</span>
                        <span class="n">sha</span><span class="o">=</span><span class="n">existing</span><span class="o">.</span><span class="n">sha</span><span class="p">,</span>
                        <span class="n">branch</span><span class="o">=</span><span class="n">branch</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âœ… ×”×§×•×‘×¥ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×” ×œ-&lt;code&gt;</span><span class="si">{</span><span class="n">target_path</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">create_file</span><span class="p">(</span>
                        <span class="n">path</span><span class="o">=</span><span class="n">target_path</span><span class="p">,</span>
                        <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Upload </span><span class="si">{</span><span class="n">inner_path</span><span class="si">}</span><span class="s2"> via Telegram bot&quot;</span><span class="p">,</span>
                        <span class="n">content</span><span class="o">=</span><span class="n">content_text</span><span class="p">,</span>
                        <span class="n">branch</span><span class="o">=</span><span class="n">branch</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âœ… ×”×§×•×‘×¥ ×”×•×¢×œ×” ×‘×”×¦×œ×—×” ×œ-&lt;code&gt;</span><span class="si">{</span><span class="n">target_path</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span>
                <span class="c1"># ×”×¦×¢ ×¤×¢×•×œ×•×ª ×”××©×š: ×‘×—×¨ ×§×•×‘×¥ × ×•×¡×£ ××”â€‘ZIP ××• ×—×–×•×¨</span>
                <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;â• ×”×¢×œ×” ×§×•×‘×¥ × ×•×¡×£ ××”â€‘ZIP&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;gh_upload_zip_browse:</span><span class="si">{</span><span class="n">backup_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)],</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;gh_upload_cat:zips&quot;</span><span class="p">)],</span>
                <span class="p">]</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;ğŸ¯ ×‘×—×¨ ×¤×¢×•×œ×”:&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×”×¢×œ××”: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;gh_upload_cat:large&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">upload_large_files_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;gh_upload_cat:other&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_upload_other_files</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="c1"># --- Create new repository from ZIP ---</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;github_create_repo_from_zip&quot;</span><span class="p">:</span>
            <span class="c1"># ×”×›× ×” ×œ×–×¨×™××ª ×™×¦×™×¨×ª ×¨×™×¤×• ×—×“×© ××ª×•×š ZIP</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
            <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ××™×Ÿ ×—×™×‘×•×¨ ×œ-GitHub. ×©×œ×— /github ×›×“×™ ×œ×”×’×“×™×¨ ×˜×•×§×Ÿ&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="c1"># × ×§×” ×“×’×œ×™× ×™×©× ×™× ×›×“×™ ×œ×× ×•×¢ ×‘×œ×‘×•×œ ×‘×§×œ×™×˜×ª ×”××¡××›×™×</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_github_upload&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;upload_mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;github_create_repo_from_zip&quot;</span>
            <span class="c1"># ×‘×¨×™×¨×ª ××—×“×œ: ×¨×™×¤×• ×¤×¨×˜×™</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;new_repo_private&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">vis_text</span> <span class="o">=</span> <span class="s2">&quot;×¤×¨×˜×™&quot;</span> <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;new_repo_private&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;×¦×™×‘×•×¨×™&quot;</span>
            <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;âœï¸ ×”×§×œ×“ ×©× ×¨×™×¤×•&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_new_repo_name&quot;</span><span class="p">)],</span>
                <span class="p">[</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                        <span class="s2">&quot;ğŸ”’ ×¤×¨×˜×™ âœ…&quot;</span> <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;new_repo_private&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;ğŸ”’ ×¤×¨×˜×™&quot;</span><span class="p">,</span>
                        <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_set_new_repo_visibility:1&quot;</span>
                    <span class="p">),</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                        <span class="s2">&quot;ğŸŒ ×¦×™×‘×•×¨×™ âœ…&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;new_repo_private&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;ğŸŒ ×¦×™×‘×•×¨×™&quot;</span><span class="p">,</span>
                        <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_set_new_repo_visibility:0&quot;</span>
                    <span class="p">),</span>
                <span class="p">],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)],</span>
            <span class="p">]</span>
            <span class="n">help_txt</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;ğŸ†• &lt;b&gt;×™×¦×™×¨×ª ×¨×™×¤×• ×—×“×© ×Ö¼ZIP&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;1) × ×™×ª×Ÿ ×œ×”×§×œ×™×“ ×©× ×œ×¨×™×¤×• (×œ×œ× ×¨×•×•×—×™×)</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;2) ×‘×—×¨ ×× ×”×¨×™×¤×• ×™×”×™×” &lt;b&gt;×¤×¨×˜×™&lt;/b&gt; ××• &lt;b&gt;×¦×™×‘×•×¨×™&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;3) ×©×œ×— ×¢×›×©×™×• ×§×•×‘×¥ ZIP ×¢× ×›×œ ×”×§×‘×¦×™×</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;×× ×œ× ×ª×•×§×œ×“ ×©×, × × ×¡×” ×œ×—×œ×¥ ×©× ××ª×™×§×™×™×ª-×”×‘×¡×™×¡ ×‘Ö¼ZIP ××• ××©× ×”×§×•×‘×¥.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;×‘×¨×™×¨×ª ××—×“×œ: &lt;code&gt;repo-&amp;lt;timestamp&amp;gt;&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;× ×¨××•×ª × ×•×›×—×™×ª: &lt;b&gt;</span><span class="si">{</span><span class="n">vis_text</span><span class="si">}</span><span class="s2">&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;×œ××—×¨ ×”×©×œ×™×—×”, × ×™×¦×•×¨ ×¨×™×¤×• ×œ×¤×™ ×‘×—×™×¨×ª×š ×•× ×¤×¨×•×¡ ××ª ×”×ª×•×›×Ÿ ×‘-commit ××—×“.&quot;</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">help_txt</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;github_new_repo_name&quot;</span><span class="p">:</span>
            <span class="c1"># ×‘×§×©×ª ×©× ×œ×¨×™×¤×• ×”×—×“×©</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_new_repo_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="s2">&quot;âœï¸ ×”×§×œ×“ ×©× ×œ×¨×™×¤×• ×”×—×“×© (××•×ª×¨ ××•×ª×™×•×ª, ××¡×¤×¨×™×, × ×§×•×“×•×ª, ××§×¤×™× ×•×§×• ×ª×—×ª×•×Ÿ).</span><span class="se">\n</span><span class="s2">×©×œ×— ×˜×§×¡×˜ ×¢×›×©×™×•.&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">([[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_create_repo_from_zip&quot;</span><span class="p">)]])</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;github_set_new_repo_visibility:&quot;</span><span class="p">):</span>
            <span class="c1"># ×‘×—×™×¨×ª × ×¨××•×ª (×¤×¨×˜×™/×¦×™×‘×•×¨×™) ×œ×¨×™×¤×• ×”×—×“×©</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">is_private</span> <span class="o">=</span> <span class="n">flag</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;new_repo_private&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_private</span>
            <span class="n">vis_text</span> <span class="o">=</span> <span class="s2">&quot;×¤×¨×˜×™&quot;</span> <span class="k">if</span> <span class="n">is_private</span> <span class="k">else</span> <span class="s2">&quot;×¦×™×‘×•×¨×™&quot;</span>
            <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;âœï¸ ×”×§×œ×“ ×©× ×¨×™×¤×•&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_new_repo_name&quot;</span><span class="p">)],</span>
                <span class="p">[</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                        <span class="s2">&quot;ğŸ”’ ×¤×¨×˜×™ âœ…&quot;</span> <span class="k">if</span> <span class="n">is_private</span> <span class="k">else</span> <span class="s2">&quot;ğŸ”’ ×¤×¨×˜×™&quot;</span><span class="p">,</span>
                        <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_set_new_repo_visibility:1&quot;</span>
                    <span class="p">),</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                        <span class="s2">&quot;ğŸŒ ×¦×™×‘×•×¨×™ âœ…&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">is_private</span> <span class="k">else</span> <span class="s2">&quot;ğŸŒ ×¦×™×‘×•×¨×™&quot;</span><span class="p">,</span>
                        <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_set_new_repo_visibility:0&quot;</span>
                    <span class="p">),</span>
                <span class="p">],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)],</span>
            <span class="p">]</span>
            <span class="n">help_txt</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;ğŸ†• &lt;b&gt;×™×¦×™×¨×ª ×¨×™×¤×• ×—×“×© ×Ö¼ZIP&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;1) × ×™×ª×Ÿ ×œ×”×§×œ×™×“ ×©× ×œ×¨×™×¤×• (×œ×œ× ×¨×•×•×—×™×)</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;2) ×‘×—×¨ ×× ×”×¨×™×¤×• ×™×”×™×” &lt;b&gt;×¤×¨×˜×™&lt;/b&gt; ××• &lt;b&gt;×¦×™×‘×•×¨×™&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;3) ×©×œ×— ×¢×›×©×™×• ×§×•×‘×¥ ZIP ×¢× ×›×œ ×”×§×‘×¦×™×</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;×× ×œ× ×ª×•×§×œ×“ ×©×, × × ×¡×” ×œ×—×œ×¥ ×©× ××ª×™×§×™×™×ª-×”×‘×¡×™×¡ ×‘Ö¼ZIP ××• ××©× ×”×§×•×‘×¥.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;×‘×¨×™×¨×ª ××—×“×œ: &lt;code&gt;repo-&amp;lt;timestamp&amp;gt;&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;× ×¨××•×ª × ×•×›×—×™×ª: &lt;b&gt;</span><span class="si">{</span><span class="n">vis_text</span><span class="si">}</span><span class="s2">&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;×œ××—×¨ ×”×©×œ×™×—×”, × ×™×¦×•×¨ ×¨×™×¤×• ×œ×¤×™ ×‘×—×™×¨×ª×š ×•× ×¤×¨×•×¡ ××ª ×”×ª×•×›×Ÿ ×‘-commit ××—×“.&quot;</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">help_txt</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="k">raise</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;×¢×•×“×›× ×” ×”× ×¨××•×ª&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;gh_upload_repo:&quot;</span><span class="p">):</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_upload_repo_files</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;other_files_page_&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="c1"># ×©××™×¨×ª ×¢××•×“, ×›×“×™ ×©×œ× × ×§×¤×•×¥ ×œ×¢××•×“ ×”×¨××©×•×Ÿ ××—×¨×™ ×¤×¢×•×œ×”</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;other_files_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_upload_other_files</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;repo_files_page:&quot;</span><span class="p">):</span>
            <span class="c1"># ×¤×•×¨××˜: repo_files_page:&lt;repo_tag&gt;:&lt;page&gt;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">repo_tag</span><span class="p">,</span> <span class="n">page_s</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">page_s</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">repo_tag</span><span class="p">,</span> <span class="n">page</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">repo_tag</span><span class="p">:</span>
                <span class="c1"># ×©××•×¨ ×¢××•×“ × ×•×›×—×™ ×œ×›×œ ×ª×’×™×ª</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;repo_files_page&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
                <span class="n">d</span><span class="p">[</span><span class="n">repo_tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;repo_files_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_upload_repo_files</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">repo_tag</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;gh_upload_large:&quot;</span><span class="p">):</span>
            <span class="n">file_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_large_file_upload</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">file_id</span><span class="p">)</span>

        <span class="c1"># ×”×•×¡×¨: &quot;upload_saved&quot; â€” ×”×–×¨×™××” ×›×œ×•×œ×” ×‘&quot;×”×¢×œ×” ×§×•×‘×¥ ×—×“×©&quot;</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;repos_page_&quot;</span><span class="p">):</span>
            <span class="n">page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_repos</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;upload_saved_&quot;</span><span class="p">):</span>
            <span class="n">file_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
            <span class="c1"># Show pre-upload check screen before actual upload</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;pending_saved_file_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_id</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_pre_upload_check</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;choose_upload_branch&quot;</span><span class="p">:</span>
            <span class="c1"># ××¢× ×” ××™×™×“×™ ×›×“×™ ×œ×©×—×¨×¨ ××ª ×”-UI ×œ×¤× ×™ ×˜×¢×™× ×ª ×¨×©×™××ª ×¢× ×¤×™×</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;×˜×•×¢×Ÿ ×¢× ×¤×™×â€¦&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_upload_branch_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;upload_branches_page_&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;upload_branches_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_upload_branch_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;upload_select_branch_tok:&quot;</span><span class="p">):</span>
            <span class="n">tok</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">br</span> <span class="o">=</span> <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;upload_branch_tokens&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tok</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">br</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;âš ï¸ ×œ× × ××¦× ×¢× ×£ ×œ×‘×—×™×¨×”&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;upload_target_branch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">br</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_pre_upload_check</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;choose_upload_folder&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;×˜×•×¢×Ÿ ×ª×™×§×™×•×ªâ€¦&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_upload_folder_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;upload_select_folder:&quot;</span><span class="p">):</span>
            <span class="c1"># ×‘×—×™×¨×ª ×ª×™×§×™×™×” ××ª×•×š ×“×¤×“×¤×Ÿ ×”×¨×™×¤×•</span>
            <span class="n">folder_path</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># normalize to no leading/trailing slashes</span>
            <span class="n">folder_norm</span> <span class="o">=</span> <span class="p">(</span><span class="n">folder_path</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;upload_target_folder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">folder_norm</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_pre_upload_check</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;upload_folder_root&quot;</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;upload_target_folder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_pre_upload_check</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;upload_folder_current&quot;</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;upload_target_folder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_folder&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_pre_upload_check</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;upload_folder_custom&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;×”×§×œ×“/×™ × ×ª×™×‘ ×™×¢×“â€¦&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">ask_upload_folder</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;upload_folder_create&quot;</span><span class="p">:</span>
            <span class="c1"># ×¤×ª×— ×–×¨×™××ª ×™×¦×™×¨×ª ×ª×™×§×™×™×” (×ª×•×× ×œ××¡×œ×•×œ ×‘×”××©×š ×¢×‘×•×¨ create_folder)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_new_folder_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># ×—×–×¨×” ×œ××¡×š ×”×‘×“×™×§×•×ª ×œ××—×¨ ×”×™×¦×™×¨×”</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;return_to_pre_upload&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[[</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;create_folder_back&quot;</span><span class="p">),</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;âŒ ×‘×™×˜×•×œ&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;create_folder_cancel&quot;</span><span class="p">)</span>
            <span class="p">]]</span>
            <span class="c1"># ×©×—×¨×¨ ××ª ×”â€‘UI ××™×“ ×›×“×™ ×œ×× ×•×¢ ×ª×—×•×©×ª ×ª×§×™×¢×”</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;×”×§×œ×“/×™ × ×ª×™×‘ ×ª×™×§×™×™×”â€¦&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="c1"># × ×¡×” ×œ×¢×¨×•×š ××ª ×”×”×•×“×¢×”, ×•×‘××§×¨×” ×©×œ &quot;message is not modified&quot; ×¢×“×›×Ÿ ×¨×§ ××ª ×”××§×œ×“×ª, ××• ×©×œ×— ×”×•×“×¢×” ×—×“×©×”</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                    <span class="s2">&quot;â• ×™×¦×™×¨×ª ×ª×™×§×™×™×” ×—×“×©×”</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;âœï¸ ×›×ª×•×‘ × ×ª×™×‘ ×ª×™×§×™×™×” ×—×“×©×” (×œ×“×•×’××”: src/new/section).</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;× ×™×¦×•×¨ ×§×•×‘×¥ â€.gitkeepâ€ ×‘×ª×•×š ×”×ª×™×§×™×™×” ×›×“×™ ×©â€‘Git ×™×©××•×¨ ××•×ª×”.&quot;</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="kn">from</span><span class="w"> </span><span class="nn">utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">TelegramUtils</span> <span class="k">as</span> <span class="n">_TU</span>
                        <span class="k">await</span> <span class="n">_TU</span><span class="o">.</span><span class="n">safe_edit_message_reply_markup</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="c1"># ×›×’×™×‘×•×™, ×©×œ×— ×”×•×“×¢×” ×—×“×©×”</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                                <span class="s2">&quot;â• ×™×¦×™×¨×ª ×ª×™×§×™×™×” ×—×“×©×”</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                                <span class="s2">&quot;âœï¸ ×›×ª×•×‘ × ×ª×™×‘ ×ª×™×§×™×™×” ×—×“×©×” (×œ×“×•×’××”: src/new/section).</span><span class="se">\n</span><span class="s2">&quot;</span>
                                <span class="s2">&quot;× ×™×¦×•×¨ ×§×•×‘×¥ â€.gitkeepâ€ ×‘×ª×•×š ×”×ª×™×§×™×™×” ×›×“×™ ×©â€‘Git ×™×©××•×¨ ××•×ª×”.&quot;</span><span class="p">,</span>
                                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
                            <span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span>
            <span class="k">return</span> <span class="n">REPO_SELECT</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;confirm_saved_upload&quot;</span><span class="p">:</span>
            <span class="n">file_id</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pending_saved_file_id&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">file_id</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×œ× × ××¦× ×§×•×‘×¥ ×××ª×™×Ÿ ×œ×”×¢×œ××”&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_saved_file_upload</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">file_id</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;refresh_saved_checks&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_pre_upload_check</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;back_to_menu&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">github_menu_command</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;folder_select_done&quot;</span><span class="p">:</span>
            <span class="c1"># ×¡×™×•× ×‘×—×™×¨×ª ×ª×™×§×™×™×” ×“×¨×š ×”×“×¤×“×¤×Ÿ ×•×”×¦×’×ª ××¦×‘</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;folder_select_mode&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">github_menu_command</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;folder_set_session:&quot;</span><span class="p">):</span>
            <span class="n">folder_path</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">session</span><span class="p">[</span><span class="s2">&quot;selected_folder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">folder_path</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âœ… ×ª×™×§×™×™×ª ×™×¢×“ ×¢×•×“×›× ×” ×œ-</span><span class="si">{</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;selected_folder&#39;</span><span class="p">]</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># ×™×¦×™××” ×××¡×š ×‘×—×™×¨×ª ×ª×™×§×™×™×” ×•×—×–×¨×” ×œ×ª×¤×¨×™×˜ ×”×¨××©×™ ×›×“×™ ×œ×× ×•×¢ ×©×’×™××ª &quot;Message is not modified&quot;</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;folder_select_mode&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">github_menu_command</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;noop&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="n">cache_time</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># ×œ× ×¢×•×©×” ×›×œ×•×, ×¨×§ ×œ×›×¤×ª×•×¨ ×”×ª×¦×•×’×”</span>

        <span class="c1"># --- New: logout GitHub token from menu ---</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;logout_github&quot;</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">database</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span>

            <span class="n">removed</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">delete_github_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">session</span><span class="p">[</span><span class="s2">&quot;github_token&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="c1"># × ×§×” ×’× ×‘×—×™×¨×•×ª ×§×•×“××•×ª ×›××©×¨ ××ª× ×ª×§×™×</span>
                <span class="n">session</span><span class="p">[</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">session</span><span class="p">[</span><span class="s2">&quot;selected_folder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="c1"># × ×§×” ×§××© ×¨×™×¤×•×–×™×˜×•×¨×™×–</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;repos&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;repos_cache_time&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">removed</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;ğŸ” ×”×ª× ×ª×§×ª ×-GitHub ×•×”×˜×•×§×Ÿ × ××—×§.â³ ××¨×¢× ×Ÿ ×ª×¤×¨×™×˜...&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;â„¹ï¸ ×œ× × ××¦× ×˜×•×§×Ÿ ××• ×©××™×¨×¢×” ×©×’×™××”.â³ ××¨×¢× ×Ÿ ×ª×¤×¨×™×˜...&quot;</span><span class="p">)</span>
            <span class="c1"># refresh the menu after logout</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">github_menu_command</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;github_import_repo&quot;</span><span class="p">:</span>
            <span class="c1"># ×¤×ª×™×—×ª ×–×¨×™××ª ×™×™×‘×•× ×¨×™×¤×• (×‘×—×™×¨×ª ×¢× ×£ â†’ ×™×™×‘×•×)</span>
            <span class="n">repo_full</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">repo_full</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×§×•×“× ×‘×—×¨ ×¨×™×¤×•!</span><span class="se">\n</span><span class="s2">×©×œ×— /github ×•×‘×—×¨ &#39;×‘×—×¨ ×¨×™×¤×•&#39;&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_import_branch_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;import_repo_branches_page_&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;import_branches_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_import_branch_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;import_repo_select_branch:&quot;</span><span class="p">):</span>
            <span class="n">token</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">token_map</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;import_branch_token_map&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">branch</span> <span class="o">=</span> <span class="n">token_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;import_repo_branch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">branch</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_confirm_import_repo</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">branch</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;import_repo_start&quot;</span><span class="p">:</span>
            <span class="c1"># ×”×ª×—×œ×ª ×™×™×‘×•× ×‘×¤×•×¢×œ</span>
            <span class="n">repo_full</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
            <span class="n">branch</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;import_repo_branch&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">repo_full</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">branch</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×—×¡×¨×™× × ×ª×•× ×™× ×œ×™×‘×•×. ×‘×—×¨ ×¨×™×¤×• ×•×¢× ×£ ××—×“×©.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">import_repo_from_zip</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">repo_full</span><span class="p">,</span> <span class="n">branch</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;import_repo_cancel&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">github_menu_command</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;analyze_repo&quot;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ğŸ” User </span><span class="si">{</span><span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> clicked &#39;analyze_repo&#39; button&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_analyze_repo_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;analyze_current_repo&quot;</span><span class="p">:</span>
            <span class="c1"># × ×ª×— ××ª ×”×¨×™×¤×• ×”× ×‘×—×¨</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ğŸ“Š User </span><span class="si">{</span><span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> analyzing current repo&quot;</span><span class="p">)</span>
            <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="n">repo_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://github.com/</span><span class="si">{</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;selected_repo&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_repository</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">repo_url</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;back_to_github_menu&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">github_menu_command</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;analyze_other_repo&quot;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ğŸ”„ User </span><span class="si">{</span><span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> wants to analyze another repo&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_another_repo</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;show_suggestions&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_improvement_suggestions</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;show_full_analysis&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_full_analysis</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;download_analysis_json&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_analysis_json</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;github_backup_menu&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_github_backup_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;github_backup_db_list&quot;</span><span class="p">:</span>
            <span class="c1"># ××¢×‘×¨ ×œ×¨×©×™××ª &quot;×’×™×‘×•×™×™ DB ××—×¨×•× ×™×&quot; ××ª×•×š ×ª×¤×¨×™×˜ GitHub, ×¢× ×—×–×¨×” ×œ-GitHub</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">backup_handler</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">bot_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;backup_handler&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">backup_handler</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">backup_menu_handler</span><span class="w"> </span><span class="kn">import</span> <span class="n">BackupMenuHandler</span>
                    <span class="n">backup_handler</span> <span class="o">=</span> <span class="n">BackupMenuHandler</span><span class="p">()</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">bot_data</span><span class="p">[</span><span class="s1">&#39;backup_handler&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">backup_handler</span>
                <span class="c1"># ×§×‘×¢ ×”×§×©×¨ ×—×–×¨×” ×œ-GitHub ×•×”×¡×¨ ×¡×™× ×•×Ÿ ×œ×¤×™ ×¨×™×¤×• ×œ×¨×©×™××” ×–×•</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;zip_back_to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;github&#39;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;github_backup_context_repo&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">await</span> <span class="n">backup_handler</span><span class="o">.</span><span class="n">_show_backups_list</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×’×™×‘×•×™×™×: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;github_restore_zip_to_repo&quot;</span><span class="p">:</span>
            <span class="c1"># ×”×ª×—×œ×ª ×©×—×–×•×¨ ZIP ×™×“× ×™ ×œ×¨×™×¤×•: ×”×’×“×¨ ××¦×‘ ×”×¢×œ××” ×•×‘×§×© ×‘×—×™×¨×ª purge</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
            <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">repo_full</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_full</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×—×¡×¨ ×˜×•×§×Ÿ ××• ×¨×™×¤×• × ×‘×—×¨&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                        <span class="k">raise</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;âŒ ×—×¡×¨ ×˜×•×§×Ÿ ××• ×¨×™×¤×• × ×‘×—×¨&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">return</span>
            <span class="c1"># ×•×“× ×©× ×™×§×™× ×• ×“×’×œ×™× ×™×©× ×™× ×©×œ ×”×¢×œ××” ×¨×’×™×œ×” ×›×“×™ ×œ×× ×•×¢ ×‘×œ×‘×•×œ</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_github_upload&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;upload_mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;github_restore_zip_to_repo&quot;</span>
            <span class="c1"># × ×¢×œ ××ª ×™×¢×“ ×”×¨×™×¤×• ×”×¦×¤×•×™ ×œ×©×—×–×•×¨ (×—×’×•×¨×ª ×‘×˜×™×—×•×ª × ×’×“ ×¨×™×¤×• ××—×¨)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;zip_restore_expected_repo_full&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">repo_full</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># ×œ× ×§×¨×™×˜×™ ×× × ×›×©×œ×ª ×©××™×¨×ª ×¡×˜×™×™×˜ - × ××ª×¨ ×‘×”××©×š</span>
                <span class="k">pass</span>
            <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ§¹ ××—×™×§×” ××œ××” ×œ×¤× ×™ ×”×¢×œ××”&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_restore_zip_setpurge:1&quot;</span><span class="p">)],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸš« ××œ ×ª××—×§, ×¨×§ ×¢×“×›×Ÿ&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_restore_zip_setpurge:0&quot;</span><span class="p">)],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;âŒ ×‘×™×˜×•×œ&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_backup_menu&quot;</span><span class="p">)],</span>
            <span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                    <span class="s2">&quot;×‘×—×¨ ××¦×‘ ×©×—×–×•×¨ ZIP ×œ×¨×™×¤×•, ×•××– ×©×œ×— ×§×•×‘×¥ ZIP ×¢×›×©×™×•:&quot;</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                        <span class="s2">&quot;×‘×—×¨ ××¦×‘ ×©×—×–×•×¨ ZIP ×œ×¨×™×¤×•, ×•××– ×©×œ×— ×§×•×‘×¥ ZIP ×¢×›×©×™×•:&quot;</span><span class="p">,</span>
                        <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;××™×Ÿ ×©×™× ×•×™ ×‘×ª×¦×•×’×”&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;github_restore_zip_setpurge:&quot;</span><span class="p">):</span>
            <span class="c1"># ×˜×™×¤×•×œ ×‘×‘×—×™×¨×ª ××¦×‘ ××—×™×§×”/×¢×“×›×•×Ÿ ×œ×¤× ×™ ×”×¢×œ××”</span>
            <span class="n">purge_flag</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span>
            <span class="c1"># ×•×“× ×©× ×™×§×™× ×• ×“×’×œ×™× ×™×©× ×™× ×©×œ ×”×¢×œ××” ×¨×’×™×œ×” ×›×“×™ ×œ×× ×•×¢ ×‘×œ×‘×•×œ</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_github_upload&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;upload_mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;github_restore_zip_to_repo&quot;</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;github_restore_zip_purge&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">purge_flag</span>
            <span class="c1"># ×”×©××¨ ××ª ×”×™×¢×“ ×”×¦×¤×•×™ ×× ×›×‘×¨ × ×§×‘×¢ ×§×•×“×</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;zip_restore_expected_repo_full&quot;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;zip_restore_expected_repo_full&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="p">(</span><span class="s2">&quot;ğŸ§¹ ×™×‘×•×¦×¢ × ×™×§×•×™ ×œ×¤× ×™ ×”×¢×œ××”. &quot;</span> <span class="k">if</span> <span class="n">purge_flag</span> <span class="k">else</span> <span class="s2">&quot;ğŸ” ×œ×œ× ××—×™×§×”. &quot;</span><span class="p">)</span> <span class="o">+</span>
                <span class="s2">&quot;×©×œ×— ×¢×›×©×™×• ×§×•×‘×¥ ZIP ×œ×©×—×–×•×¨ ×œ×¨×™×¤×•.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;github_restore_zip_list&quot;</span><span class="p">:</span>
            <span class="c1"># ×”×¦×’ ×¨×©×™××ª ×’×™×‘×•×™×™× (ZIP) ×©×œ ×”×¨×™×¤×• ×”× ×•×›×—×™ ×œ×¦×•×¨×š ×©×—×–×•×¨ ×œ×¨×™×¤×•</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
            <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">repo_full</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">repo_full</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×§×•×“× ×‘×—×¨ ×¨×™×¤×•!&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">backups</span> <span class="o">=</span> <span class="n">backup_manager</span><span class="o">.</span><span class="n">list_backups</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="c1"># ×¡× ×Ÿ ×¨×§ ×’×™×‘×•×™×™× ×¢× metadata ×©×œ ××•×ª×• ×¨×™×¤×•</span>
            <span class="n">backups</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">backups</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s1">&#39;repo&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="n">repo_full</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">backups</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;â„¹ï¸ ××™×Ÿ ×’×™×‘×•×™×™ ZIP ×©××•×¨×™× ×¢×‘×•×¨ ×”×¨×™×¤×•:</span><span class="se">\n</span><span class="s2">&lt;code&gt;</span><span class="si">{</span><span class="n">repo_full</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span><span class="p">,</span>
                    <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">([[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_backup_menu&quot;</span><span class="p">)]])</span>
                <span class="p">)</span>
                <span class="k">return</span>
            <span class="c1"># ×”×¦×’ ×¢×“ 10 ××—×¨×•× ×™×</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">backups</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;×‘×—×¨ ×’×™×‘×•×™ ×œ×©×—×–×•×¨ ×œ×¨×™×¤×•:</span><span class="se">\n</span><span class="s2">&lt;code&gt;</span><span class="si">{</span><span class="n">repo_full</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">]</span>
            <span class="n">kb</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;â€¢ </span><span class="si">{</span><span class="n">b</span><span class="o">.</span><span class="n">backup_id</span><span class="si">}</span><span class="s2"> â€” </span><span class="si">{</span><span class="n">b</span><span class="o">.</span><span class="n">created_at</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/%m/%Y %H:%M&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> â€” </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">total_size</span><span class="o">/</span><span class="mi">1024</span><span class="p">)</span><span class="si">}</span><span class="s2">KB&quot;</span><span class="p">)</span>
                <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;â™»ï¸ ×©×—×–×¨ ×’×™×‘×•×™ ×–×” ×œ×¨×™×¤×•&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;github_restore_zip_from_backup:</span><span class="si">{</span><span class="n">b</span><span class="o">.</span><span class="n">backup_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
            <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_backup_menu&quot;</span><span class="p">)])</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;github_restore_zip_from_backup:&quot;</span><span class="p">):</span>
            <span class="c1"># ×§×‘×œ backup_id ×•××– ×¤×ª×— ××ª ×ª×”×œ×™×š ×”×©×—×–×•×¨-×œ×¨×™×¤×• ×¢× ×§×•×‘×¥ ×”-ZIP ×”×–×”</span>
            <span class="n">backup_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
            <span class="n">info_list</span> <span class="o">=</span> <span class="n">backup_manager</span><span class="o">.</span><span class="n">list_backups</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">match</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">info_list</span> <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">backup_id</span> <span class="o">==</span> <span class="n">backup_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">match</span><span class="o">.</span><span class="n">file_path</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">file_path</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×”×’×™×‘×•×™ ×œ× × ××¦× ×‘×“×™×¡×§&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="c1"># ×”×’×“×¨ purge? ×‘×§×© ×‘×—×™×¨×”</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;pending_repo_restore_zip_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">file_path</span>
            <span class="c1"># × ×¢×œ ××ª ×™×¢×“ ×”×¨×™×¤×• ×”×¦×¤×•×™ ×¢×‘×•×¨ ×”×©×—×–×•×¨ ××ª×•×š ×’×™×‘×•×™</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;zip_restore_expected_repo_full&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="s2">&quot;×”×× ×œ××—×•×§ ×§×•×“× ××ª ×”×ª×•×›×Ÿ ×‘×¨×™×¤×• ×œ×¤× ×™ ×”×¢×œ××”?&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">([</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ§¹ ××—×™×§×” ××œ××” ×œ×¤× ×™ ×”×¢×œ××”&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_repo_restore_backup_setpurge:1&quot;</span><span class="p">)],</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸš« ××œ ×ª××—×§, ×¨×§ ×¢×“×›×Ÿ&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_repo_restore_backup_setpurge:0&quot;</span><span class="p">)],</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;âŒ ×‘×™×˜×•×œ&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_backup_menu&quot;</span><span class="p">)],</span>
                <span class="p">])</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;github_backup_help&quot;</span><span class="p">:</span>
            <span class="n">help_text</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;&lt;b&gt;×”×¡×‘×¨ ×¢×œ ×”×›×¤×ª×•×¨×™×:&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;ğŸ“¦ &lt;b&gt;×”×•×¨×“ ×’×™×‘×•×™ ZIP ×©×œ ×”×¨×™×¤×•&lt;/b&gt;: ×™×•×¦×¨ ×•××•×¨×™×“ ZIP ×©×œ ×›×œ ×”×ª×•×›×Ÿ (××• ×ª×™×§×™×™×” × ×•×›×—×™×ª), ×•×’× ×©×•××¨ ×›×’×™×‘×•×™ ×œ×©×™××•×© ×¢×ª×™×“×™.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;â™»ï¸ &lt;b&gt;×©×—×–×¨ ZIP ×œ×¨×™×¤×• (×¤×¨×™×¡×” ×•×”×—×œ×¤×”)&lt;/b&gt;: ×©×œ×— ZIP ××”××—×©×‘, ×•×”×‘×•×˜ ×™×¤×¨×•×¡ ××•×ª×• ×œ×¨×™×¤×• ×‘×§×•××™×˜ ××—×“. × ×™×ª×Ÿ ×œ×‘×—×•×¨ ××—×™×§×” ××œ××” ×œ×¤× ×™ ××• ×¢×“×›×•×Ÿ ×‘×œ×‘×“.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;ğŸ“‚ &lt;b&gt;×©×—×–×¨ ××’×™×‘×•×™ ×©××•×¨ ×œ×¨×™×¤×•&lt;/b&gt;: ×‘×—×¨ ZIP ×©×©××•×¨ ×‘×‘×•×˜ ×¢×‘×•×¨ ×”×¨×™×¤×• ×”×–×”, ×•×”×‘×•×˜ ×™×¤×¨×•×¡ ××•×ª×• ×œ×¨×™×¤×• (××—×™×§×”/×¢×“×›×•×Ÿ ×œ×¤×™ ×‘×—×™×¨×”).</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;ğŸ· &lt;b&gt;× ×§×•×“×ª ×©××™×¨×” ×‘×’×™×˜&lt;/b&gt;: ×™×•×¦×¨ ×ª×’×™×ª/×¢× ×£ × ×§×•×“×ª ×©××™×¨×” ×©×œ ×”×¨×™×¤×• ×”× ×•×›×—×™ ×›×“×™ ×©×ª×•×›×œ ×œ×—×–×•×¨ ××œ×™×”.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;â†©ï¸ &lt;b&gt;×—×–×¨×” ×œ× ×§×•×“×ª ×©××™×¨×”&lt;/b&gt;: ×¤×¢×•×œ×•×ª ×œ×©×—×–×•×¨ ××¦×‘ ××”×¨×¤×¨× ×¡ ×©×œ × ×§×•×“×ª ×©××™×¨×” (×ª×’×™×ª/×¢× ×£) â€” ×›×•×œ×œ ×™×¦×™×¨×ª ×¢× ×£/PR ×œ×©×—×–×•×¨.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;ğŸ—‚ &lt;b&gt;×’×™×‘×•×™×™ DB ××—×¨×•× ×™×&lt;/b&gt;: ××¦×™×’ ×’×™×‘×•×™×™× ×©×œ ×§×‘×¦×™× ×‘×‘×•×˜ ×¢×¦××• (×œ× ×§×©×•×¨ ×œâ€‘GitHub).</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;â™»ï¸ &lt;b&gt;×©×—×–×•×¨ ××’×™×‘×•×™ (ZIP)&lt;/b&gt;: ×©×—×–×•×¨ ××œ× ×œ×§×‘×¦×™× ×‘×‘×•×˜ ×¢×¦××• ××§×•×‘×¥ ZIP. ××•×—×§ ××ª ×›×œ ×”×§×‘×¦×™× ×‘×‘×•×˜ ×•××– ××©×—×–×¨.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;ğŸ”™ &lt;b&gt;×—×–×•×¨&lt;/b&gt;: ×—×–×¨×” ×œ×ª×¤×¨×™×˜ ×”×¨××©×™ ×©×œ GitHub.&quot;</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">help_text</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">([[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_backup_menu&quot;</span><span class="p">)]]))</span>
            <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="k">raise</span>
            <span class="k">return</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;backup_menu&quot;</span><span class="p">:</span>
            <span class="c1"># ×”××¦×œ×ª ×ª×¦×•×’×ª ×ª×¤×¨×™×˜ ×”×’×™×‘×•×™/×©×—×–×•×¨ ×©×œ DB ×œ-BackupMenuHandler</span>
            <span class="n">backup_handler</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">bot_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;backup_handler&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">backup_handler</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">backup_handler</span><span class="o">.</span><span class="n">show_backup_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×¨×›×™×‘ ×’×™×‘×•×™ ×œ× ×–××™×Ÿ&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;back_to_analysis&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_full_analysis</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;back_to_analysis_menu&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_analyze_results_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;back_to_summary&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_analyze_results_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;choose_my_repo&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_repos</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;enter_repo_url&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_repo_url</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;suggestion_&quot;</span><span class="p">):</span>
            <span class="n">suggestion_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_suggestion_details</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">suggestion_index</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;show_current&quot;</span><span class="p">:</span>
            <span class="n">current_repo</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">,</span> <span class="s2">&quot;×œ× × ×‘×—×¨&quot;</span><span class="p">)</span>
            <span class="n">current_folder</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_folder&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;root&quot;</span>
            <span class="n">has_token</span> <span class="o">=</span> <span class="s2">&quot;âœ…&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;âŒ&quot;</span>

            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×¨×” ×œ×ª×¤×¨×™×˜&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)]]</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ“Š &lt;b&gt;×”×’×“×¨×•×ª × ×•×›×—×™×•×ª:&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ“ ×¨×™×¤×•: &lt;code&gt;</span><span class="si">{</span><span class="n">current_repo</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ“‚ ×ª×™×§×™×™×”: &lt;code&gt;</span><span class="si">{</span><span class="n">current_folder</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ”‘ ×˜×•×§×Ÿ ××•×’×“×¨: </span><span class="si">{</span><span class="n">has_token</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ’¡ ×˜×™×¤: ×”×©×ª××© ×‘-&#39;×‘×—×¨ ×ª×™×§×™×™×ª ×™×¢×“&#39; ×›×“×™ ×œ×©× ×•×ª ××ª ××™×§×•× ×”×”×¢×œ××”&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;set_token&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="s2">&quot;ğŸ”‘ ×©×œ×— ×œ×™ ××ª ×”×˜×•×§×Ÿ ×©×œ GitHub:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;×”×˜×•×§×Ÿ ×™×™×©××¨ ×‘×¦×•×¨×” ×××•×‘×˜×—×ª ×œ×—×©×‘×•×Ÿ ×©×œ×š ×œ×¦×•×¨×š ×©×™××•×© ×¢×ª×™×“×™.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;×ª×•×›×œ ×œ×”×¡×™×¨ ××•×ª×• ×‘×›×œ ×¢×ª ×¢× ×”×¤×§×•×“×” /github_logout.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;ğŸ’¡ ×˜×™×¤: ×¦×•×¨ ×˜×•×§×Ÿ ×‘:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;https://github.com/settings/tokens&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">REPO_SELECT</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;set_folder&quot;</span><span class="p">:</span>
            <span class="c1"># ×¤×ª×— ×“×¤×“×¤×Ÿ ×¨×™×¤×• ×œ×‘×—×™×¨×ª ×ª×™×§×™×” ×××™×ª×™×ª ××ª×•×š ×”×¨×™×¤×•</span>
            <span class="c1"># ×¡×™××•×Ÿ ××¦×‘ ×‘×—×™×¨×ª ×ª×™×§×™×” ×¢×‘×•×¨ session</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;folder_select_mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;session&quot;</span>
            <span class="c1"># ××ª×—×œ ××¦×‘ ×“×¤×“×•×£</span>
            <span class="n">current</span> <span class="o">=</span> <span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_folder&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;download&quot;</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;multi_mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;multi_selection&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># ××¢× ×” ××™×™×“×™ ×›×“×™ ×œ×× ×•×¢ ×ª×—×•×©×ª ×ª×§×™×¢×”</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;×˜×•×¢×Ÿ ×“×¤×“×¤×Ÿ ×ª×™×§×™×•×ªâ€¦&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_repo_browser</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;folder_&quot;</span><span class="p">):</span>
            <span class="n">folder</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;folder_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">folder</span> <span class="o">==</span> <span class="s2">&quot;custom&quot;</span><span class="p">:</span>
                <span class="c1"># ×‘×§×© ×§×œ×˜ ×œ×ª×™×§×™×™×” ××•×ª×××ª ××™×©×™×ª</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_selected_folder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                    <span class="s2">&quot;âœï¸ ×”×§×œ×“ ×©× ×ª×™×§×™×™×” (×œ×“×•×’××”: src/images)</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;×”×©××¨ ×¨×™×§ ××• ×”×§×œ×“ / ×›×“×™ ×œ×‘×—×•×¨ root&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">FOLDER_SELECT</span>
            <span class="k">elif</span> <span class="n">folder</span> <span class="o">==</span> <span class="s2">&quot;root&quot;</span><span class="p">:</span>
                <span class="n">session</span><span class="p">[</span><span class="s2">&quot;selected_folder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;âœ… ×ª×™×§×™×™×” ×¢×•×“×›× ×” ×œ-root&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">github_menu_command</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">session</span><span class="p">[</span><span class="s2">&quot;selected_folder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">folder</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âœ… ×ª×™×§×™×™×” ×¢×•×“×›× ×” ×œ-</span><span class="si">{</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;selected_folder&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">github_menu_command</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;create_folder&quot;</span><span class="p">,</span> <span class="s2">&quot;upload_folder_create&quot;</span><span class="p">):</span>
            <span class="c1"># ×‘×§×© ××”××©×ª××© × ×ª×™×‘ ×ª×™×§×™×™×” ×—×“×©×” ×œ×™×¦×™×¨×” (× ×™×¦×•×¨ .gitkeep ×‘×ª×•×š ×”×ª×™×§×™×™×”)</span>
            <span class="n">return_to_pre</span> <span class="o">=</span> <span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;upload_folder_create&quot;</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_new_folder_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;return_to_pre_upload&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">return_to_pre</span>
            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;create_folder_back&quot;</span><span class="p">),</span> <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;âŒ ×‘×™×˜×•×œ&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;create_folder_cancel&quot;</span><span class="p">)]]</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="s2">&quot;â• ×™×¦×™×¨×ª ×ª×™×§×™×™×” ×—×“×©×”</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;âœï¸ ×›×ª×•×‘ × ×ª×™×‘ ×ª×™×§×™×™×” ×—×“×©×” (×œ×“×•×’××”: src/new/section).</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;× ×™×¦×•×¨ ×§×•×‘×¥ â€.gitkeepâ€ ×‘×ª×•×š ×”×ª×™×§×™×™×” ×›×“×™ ×©â€‘Git ×™×©××•×¨ ××•×ª×”.&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">REPO_SELECT</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;create_folder_back&quot;</span><span class="p">:</span>
            <span class="c1"># ×—×–×¨×” ×œ××¡×š &quot;×ª×™×§×™×™×ª ×™×¢×“&quot;</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_new_folder_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_upload_folder_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">REPO_SELECT</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;create_folder_cancel&quot;</span><span class="p">:</span>
            <span class="c1"># ×‘×™×˜×•×œ ×™×¦×™×¨×ª ×ª×™×§×™×™×” ×•×—×–×¨×” ×œ×ª×¤×¨×™×˜ GitHub</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_new_folder_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;return_to_pre_upload&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">github_menu_command</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">REPO_SELECT</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;github_menu&quot;</span><span class="p">:</span>
            <span class="c1"># ×—×–×¨×” ×œ×ª×¤×¨×™×˜ ×”×¨××©×™ ×©×œ GitHub</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_github_upload&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;in_github_menu&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;folder_select_mode&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="c1"># × ×§×” ×“×’×œ ×¡×™× ×•×Ÿ ×’×™×‘×•×™×™× ×œ×¤×™ ×¨×™×¤×•, ×× ×§×™×™×</span>
            <span class="c1"># × ×§×” ×“×’×œ×™× ×–×× ×™×™× ×©×œ ×™×¦×™×¨×ª ×¨×™×¤×• ×—×“×©</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;waiting_for_new_repo_name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;new_repo_name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;upload_mode&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;github_create_repo_from_zip&quot;</span><span class="p">:</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;upload_mode&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;new_repo_private&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;github_backup_context_repo&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">github_menu_command</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
        
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;git_checkpoint&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">git_checkpoint</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;git_checkpoint_doc:&quot;</span><span class="p">):</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">kind</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_checkpoint_doc</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;git_checkpoint_doc_skip&quot;</span><span class="p">:</span>
            <span class="n">kb</span> <span class="o">=</span> <span class="p">[[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;back_to_menu&quot;</span><span class="p">)]]</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="s2">&quot;âœ… × ×§×•×“×ª ×©××™×¨×” × ×•×¦×¨×”. × ×™×ª×Ÿ ×œ×—×–×•×¨ ×œ×ª×¤×¨×™×˜ ××• ×œ×”×¢×œ×•×ª ×§×‘×¦×™× ×©××•×¨×™×.&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span>
            <span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;restore_checkpoint_menu&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_restore_checkpoint_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;restore_commit_menu&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_commit_restore_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;restore_tags_page_&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;restore_tags_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_restore_checkpoint_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;restore_commits_page_&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;restore_commits_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_commit_restore_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;restore_select_tag:&quot;</span><span class="p">):</span>
            <span class="n">tag_name</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_restore_tag_actions</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">tag_name</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;restore_select_commit:&quot;</span><span class="p">):</span>
            <span class="n">commit_sha</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_commit_restore_actions</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">commit_sha</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;restore_branch_from_tag:&quot;</span><span class="p">):</span>
            <span class="n">tag_name</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_branch_from_tag</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">tag_name</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;restore_branch_from_commit:&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">CALLBACK_BRANCH_FROM_COMMIT</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">):</span>
            <span class="n">commit_sha</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_branch_from_commit</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">commit_sha</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;open_pr_from_branch:&quot;</span><span class="p">):</span>
            <span class="n">branch_name</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_pr_from_branch</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">branch_name</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;restore_revert_pr_from_tag:&quot;</span><span class="p">):</span>
            <span class="n">tag_name</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_revert_pr_from_tag</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">tag_name</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;restore_revert_pr_from_commit:&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">CALLBACK_REVERT_PR_FROM_COMMIT</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">):</span>
            <span class="n">commit_sha</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_revert_pr_from_commit</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">commit_sha</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;close_menu&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;ğŸ‘‹ ×”×ª×¤×¨×™×˜ × ×¡×’×¨&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;repo_&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;repo_manual&quot;</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                    <span class="s2">&quot;âœï¸ ×”×§×œ×“ ×©× ×¨×™×¤×• ×‘×¤×•×¨××˜:</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;&lt;code&gt;owner/repository&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;×œ×“×•×’××”: &lt;code&gt;amirbiron/CodeBot&lt;/code&gt;&quot;</span><span class="p">,</span>
                    <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">REPO_SELECT</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">repo_name</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;repo_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">session</span><span class="p">[</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">repo_name</span>
                <span class="c1"># ××™×¤×•×¡ ×ª×™×§×™×•×ª ×™×¢×“ ×™×©× ×•×ª ×‘×¢×ª ×‘×—×™×¨×ª ×¨×™×¤×• ×—×“×©</span>
                <span class="n">session</span><span class="p">[</span><span class="s2">&quot;selected_folder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;upload_target_folder&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;upload_target_branch&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

                <span class="c1"># × ×§×” ×¡×˜×™×™×˜×™× ×–×× ×™×™× ×©×œ ×–×¨× ×©×—×–×•×¨/×’×™×‘×•×™ ×›×“×™ ×œ×× ×•×¢ × ×¢×™×œ×” ×œ×¨×™×¤×• ×§×•×“×</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;zip_restore_expected_repo_full&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;github_restore_zip_purge&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;pending_repo_restore_zip_path&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;upload_mode&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>

                <span class="c1"># ×©××•×¨ ×‘××¡×“ × ×ª×•× ×™×</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">database</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span>

                <span class="n">db</span><span class="o">.</span><span class="n">save_selected_repo</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">repo_name</span><span class="p">)</span>

                <span class="c1"># ×”×¦×’ ××ª ×”×ª×¤×¨×™×˜ ×”××œ× ××—×¨×™ ×‘×—×™×¨×ª ×”×¨×™×¤×•</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">github_menu_command</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;danger_delete_menu&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_danger_delete_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;delete_file_menu&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_delete_file_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;delete_repo_menu&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_delete_repo_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;confirm_delete_file&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">confirm_delete_file</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;confirm_delete_repo_step1&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">confirm_delete_repo_step1</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;confirm_delete_repo&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">confirm_delete_repo</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;download_file_menu&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_download_file_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;browse_open:&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;browse_open_i:&quot;</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_path_from_cb</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;browse_open&quot;</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># ××¦×‘ ××¨×•×‘×” ×•××—×™×§×” ×‘×˜×•×—×” ×œ××™×¤×•×¡</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;multi_selection&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_repo_browser</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;browse_ref_menu&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_browse_ref_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;browse_refs_branches_page_&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_refs_branches_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_ref_tab&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;branches&quot;</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_browse_ref_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;browse_refs_tags_page_&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_refs_tags_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_ref_tab&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;tags&quot;</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_browse_ref_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;browse_select_ref:&quot;</span><span class="p">):</span>
            <span class="c1"># ×¢×“×›×•×Ÿ ref × ×•×›×—×™ ×•×”×—×–×¨×” ×œ×“×¤×“×¤×Ÿ</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_ref&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_repo_browser</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;browse_search&quot;</span><span class="p">:</span>
            <span class="c1"># ×‘×§×© ××”××©×ª××© ×œ×”×–×™×Ÿ ××—×¨×•×–×ª ×—×™×¤×•×© ×œ×©××•×ª ×§×‘×¦×™×</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_search_mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;×”×§×œ×“ ×¢×›×©×™×• ××ª ×”×©× ×œ×—×™×¤×•×© (×œ××©×œ: README)&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                    <span class="s2">&quot;ğŸ” ×”×–×Ÿ/×™ ××—×¨×•×–×ª ×œ×—×™×¤×•×© ×‘×©× ×§×•×‘×¥ (×œ×“×•×’××”: README ××• app.py)&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="k">raise</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;browse_search_page:&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">page</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_search_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_browse_search_results</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;browse_select_download:&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;browse_select_download_i:&quot;</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_path_from_cb</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;browse_select_download&quot;</span><span class="p">)</span>
            <span class="c1"># ×©××•×¨ ×¢×œ browse_action=download ×›×“×™ ×©×œ× ×™×™×—×©×¤×• ×›×¤×ª×•×¨×™ ××—×™×§×” ×œ××—×¨ ×”×”×•×¨×“×”</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;waiting_for_download_file_path&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="c1"># ××œ ×ª××¤×¡ ××ª browse_action; × ×©××•×¨ ××•×ª×• ×›-download</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;browse_action&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;download&quot;</span><span class="p">:</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;download&quot;</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;download&quot;</span>
            <span class="c1"># ×©××•×¨ ××ª ×”× ×ª×™×‘ ×”××—×¨×•×Ÿ ×›×“×™ ×©×”×“×¤×“×¤×Ÿ ×™×™×©××¨ ×‘××•×ª×• ××™×§×•×</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;browse_path&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">path</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="c1"># ×”×•×¨×“×” ××™×™×“×™×ª</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">repo_name</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×—×¡×¨ ×˜×•×§×Ÿ ××• ×¨×™×¤×• × ×‘×—×¨&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="c1"># ×× ×”×§×•×‘×¥ ×’×“×•×œ ××“×™, ×©×œ×— ×§×™×©×•×¨ ×œ×”×•×¨×“×” ×‘××§×•× ×ª×•×›×Ÿ ××œ×</span>
            <span class="n">size</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">contents</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">size</span> <span class="ow">and</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">MAX_INLINE_FILE_BYTES</span><span class="p">:</span>
                <span class="n">download_url</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">contents</span><span class="p">,</span> <span class="s2">&quot;download_url&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">download_url</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;âš ï¸ ×”×§×•×‘×¥ ×’×“×•×œ (</span><span class="si">{</span><span class="n">format_bytes</span><span class="p">(</span><span class="n">size</span><span class="p">)</span><span class="si">}</span><span class="s1">). ×œ×”×•×¨×“×”: &lt;a href=&quot;</span><span class="si">{</span><span class="n">download_url</span><span class="si">}</span><span class="s1">&quot;&gt;×§×™×©×•×¨ ×™×©×™×¨&lt;/a&gt;&#39;</span><span class="p">,</span>
                        <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;âš ï¸ ×”×§×•×‘×¥ ×’×“×•×œ (</span><span class="si">{</span><span class="n">format_bytes</span><span class="p">(</span><span class="n">size</span><span class="p">)</span><span class="si">}</span><span class="s2">) ×•×œ× × ×™×ª×Ÿ ×œ×”×•×¨×™×“×• ×™×©×™×¨×•×ª ×›×¨×’×¢.&quot;</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">contents</span><span class="o">.</span><span class="n">decoded_content</span>
                <span class="n">base</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="s1">&#39;os&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">path</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">contents</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;downloaded_file&quot;</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_document</span><span class="p">(</span><span class="n">document</span><span class="o">=</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
            <span class="c1"># ×”×™×©××¨ ×‘×“×¤×“×¤×Ÿ ×‘××¦×‘ ×”×•×¨×“×” ×‘×œ×‘×“, ×¢×“×›×Ÿ ××§×œ×“×ª ×‘×œ×™ ×œ×”×—×œ×™×£ ×˜×§×¡×˜</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_repo_browser</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">only_keyboard</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;browse_select_view:&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;browse_select_view_i:&quot;</span><span class="p">):</span>
            <span class="c1"># ××¦×‘ ×ª×¦×•×’×ª ×§×•×‘×¥ ×—×œ×§×™×ª ×¢× &quot;×”×¦×’ ×¢×•×“&quot;</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_path_from_cb</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;browse_select_view&quot;</span><span class="p">)</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
            <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_name</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×—×¡×¨×™× × ×ª×•× ×™× (×‘×—×¨ ×¨×™×¤×• ×¢× /github)&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span>
            <span class="c1"># ×›×‘×“×•×§ ref × ×•×›×—×™</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">current_ref</span> <span class="o">=</span> <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;browse_ref&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="s2">&quot;default_branch&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;main&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">current_ref</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="s2">&quot;default_branch&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;main&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">contents</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">current_ref</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">contents</span><span class="o">.</span><span class="n">decoded_content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">)</span>
                <span class="c1"># ×©××™×¨×ª × ×ª×•× ×™ ×¢×–×¨: ×’×•×“×œ ×•×©×¤×” ××–×•×”×”</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">detect_language_from_filename</span>
                    <span class="n">detected_lang</span> <span class="o">=</span> <span class="n">detect_language_from_filename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">detected_lang</span> <span class="o">=</span> <span class="s2">&quot;text&quot;</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;view_file_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">contents</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;view_detected_language&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">detected_lang</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×§×•×‘×¥: </span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="c1"># ×©×™××•×¨ ×˜×§×¡×˜ ×‘×–×™×›×¨×•×Ÿ ×§×¦×¨ (user_data) + ××™× ×“×§×¡ ×¢××•×“</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;view_file_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;view_file_text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;view_page_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_render_file_view</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;view_more&quot;</span><span class="p">:</span>
            <span class="c1"># ×”×¦×’ ×¢×•×“ ×¢××•×“; × ×’×Ÿ ××¤× ×™ None/××—×¨×•×–×ª</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">current_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;view_page_index&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">current_index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;view_page_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_index</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_render_file_view</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;view_back&quot;</span><span class="p">:</span>
            <span class="c1"># ×× ×”×’×¢× ×• ××ª×•×¦××•×ª ×—×™×¤×•×© â€“ ×—×–×¨×” ×œ×¢××•×“ ×”×—×™×¤×•×© ×”××—×¨×•×Ÿ</span>
            <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;last_results_were_search&quot;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_browse_search_results</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="c1"># × × ×§×” ××ª ×”×“×’×œ ×¨×§ ××—×¨×™ ×©×—×–×¨× ×• ×œ××¡×š ×”×—×™×¤×•×©</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;last_results_were_search&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># ×—×–×¨×” ×œ×¢×¥ ×”×¨×™×¤×• (×©×•××¨ path)</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;view&quot;</span>
                <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;browse_page&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_repo_browser</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;browse_select_delete:&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;browse_select_delete_i:&quot;</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_path_from_cb</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;browse_select_delete&quot;</span><span class="p">)</span>
            <span class="c1"># ×“×¨×•×© ××™×©×•×¨ ×œ×¤× ×™ ××—×™×§×”</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;pending_delete_file_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;âœ… ××™×©×•×¨ ××—×™×§×”&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;confirm_delete_file&quot;</span><span class="p">)],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)],</span>
            <span class="p">]</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="s2">&quot;×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×§×•×‘×¥ ×”×‘×?</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="sa">f</span><span class="s2">&quot;&lt;code&gt;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;download_zip:&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;download_zip_i:&quot;</span><span class="p">):</span>
            <span class="c1"># ×”×•×¨×“×ª ×”×ª×™×§×™×™×” ×”× ×•×›×—×™×ª ×›×§×•×‘×¥ ZIP</span>
            <span class="n">current_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_path_from_cb</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;download_zip&quot;</span><span class="p">)</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
            <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_name</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×—×¡×¨×™× × ×ª×•× ×™×&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span>
                    <span class="s2">&quot;××•×¨×™×“ ×ª×™×§×™×™×” ×›Ö¾ZIP, ×”×ª×”×œ×™×š ×¢×©×•×™ ×œ×”×™××©×š 1â€“2 ×“×§×•×ª.&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span>
                <span class="c1"># Fast path: ×”×•×¨×“×ª ZIP ××œ× ×©×œ ×”×¨×™×¤×• ×“×¨×š zipball</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">current_path</span><span class="p">:</span>
                    <span class="c1"># × ×‘× ×” ZIP ××œ× ××”×¨×™×¤×• (zipball) ×‘×¡×¤×•×œ ×œ×“×™×¡×§, × ×•×¡×™×£ metadata.json ×•×  Persist ×“×¨×š ×× ×”×œ ×”×’×™×‘×•×™×™×</span>
                    <span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">zip_path</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="kn">import</span><span class="w"> </span><span class="nn">zipfile</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_zip</span>
                        <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span> <span class="k">as</span> <span class="n">_dt</span><span class="p">,</span> <span class="n">timezone</span> <span class="k">as</span> <span class="n">_tz</span>
                        <span class="n">url</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_archive_link</span><span class="p">(</span><span class="s2">&quot;zipball&quot;</span><span class="p">)</span>
                        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Accept-Encoding&quot;</span><span class="p">:</span> <span class="s2">&quot;identity&quot;</span><span class="p">}</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="n">http_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">180</span><span class="p">)</span>
                        <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
                        <span class="c1"># ×‘×“×™×§×ª ×’×•×“×œ ××¨××© (×× ×™×“×•×¢)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">cl_header</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Content-Length&quot;</span><span class="p">)</span>
                            <span class="n">content_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cl_header</span><span class="p">)</span> <span class="k">if</span> <span class="n">cl_header</span> <span class="k">else</span> <span class="mi">0</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="n">content_length</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">too_big_for_telegram</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">content_length</span> <span class="ow">and</span> <span class="n">content_length</span> <span class="o">&gt;</span> <span class="n">MAX_ZIP_TOTAL_BYTES</span><span class="p">)</span>

                        <span class="c1"># ×”×•×¨×“×” ×œ×§×•×‘×¥ ×–×× ×™ ×‘×“×™×¡×§</span>
                        <span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_tmp</span>
                        <span class="k">with</span> <span class="n">_tmp</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.zip&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tmp_file</span><span class="p">:</span>
                            <span class="n">zip_path</span> <span class="o">=</span> <span class="n">tmp_file</span><span class="o">.</span><span class="n">name</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">128</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">):</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">chunk</span><span class="p">:</span>
                                        <span class="k">continue</span>
                                    <span class="n">tmp_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">tmp_file</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">MAX_ZIP_TOTAL_BYTES</span><span class="p">:</span>
                                        <span class="n">too_big_for_telegram</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e_os</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">e_os</span><span class="p">,</span> <span class="s1">&#39;errno&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOSPC</span><span class="p">:</span>
                                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âŒ ××™×Ÿ ××§×•× ×¤× ×•×™ ×‘×“×™×¡×§ ×©×œ ×”×©×¨×ª. × × ×œ×¤× ×•×ª ××§×•× ×•×œ× ×¡×•×ª ×©×•×‘.&quot;</span><span class="p">)</span>
                                        <span class="n">emit_event</span><span class="p">(</span><span class="s2">&quot;github_zip_persist_error&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="n">repo</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">repo</span><span class="o">.</span><span class="n">full_name</span><span class="p">),</span> <span class="n">error</span><span class="o">=</span><span class="s2">&quot;ENOSPC&quot;</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                    <span class="k">pass</span>
                                <span class="k">raise</span>

                        <span class="c1"># ×¡×¤×¨ ×§×‘×¦×™× ×§×™×™××™× (×œ×œ× metadata) ×•×”×•×¡×£ metadata.json ×‘××¦×‘ append</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">with</span> <span class="n">_zip</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">zip_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zin</span><span class="p">:</span>
                                <span class="n">file_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">zin</span><span class="o">.</span><span class="n">namelist</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)]</span>
                                <span class="n">file_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_names</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="n">file_count</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s2">&quot;backup_id&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;backup_</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">_dt</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">_tz</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
                            <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="n">_dt</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">_tz</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                            <span class="s2">&quot;backup_type&quot;</span><span class="p">:</span> <span class="s2">&quot;github_repo_zip&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;include_versions&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="s2">&quot;file_count&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">file_count</span><span class="p">),</span>
                            <span class="s2">&quot;created_by&quot;</span><span class="p">:</span> <span class="s2">&quot;Code Keeper Bot&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;repo&quot;</span><span class="p">:</span> <span class="n">repo</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span>
                            <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">current_path</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                        <span class="p">}</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">with</span> <span class="n">_zip</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">zip_path</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="n">_zip</span><span class="o">.</span><span class="n">ZIP_DEFLATED</span><span class="p">)</span> <span class="k">as</span> <span class="n">zout</span><span class="p">:</span>
                                <span class="n">zout</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="s2">&quot;metadata.json&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e_append</span><span class="p">:</span>
                            <span class="c1"># ××™×¨×•×¢ ×™×¦×™×¨×”</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">code</span> <span class="o">=</span> <span class="s2">&quot;ENOSPC&quot;</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e_append</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">e_append</span><span class="p">,</span> <span class="s1">&#39;errno&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOSPC</span> <span class="k">else</span> <span class="s2">&quot;zip_append_error&quot;</span>
                                <span class="n">emit_event</span><span class="p">(</span><span class="s2">&quot;github_zip_create_error&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="n">repo</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">repo</span><span class="o">.</span><span class="n">full_name</span><span class="p">),</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e_append</span><span class="p">),</span> <span class="n">code</span><span class="o">=</span><span class="n">code</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="k">pass</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e_append</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">e_append</span><span class="p">,</span> <span class="s1">&#39;errno&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOSPC</span><span class="p">:</span>
                                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âŒ ××™×Ÿ ××§×•× ×¤× ×•×™ ×‘×“×™×¡×§ ×©×œ ×”×©×¨×ª ×‘×¢×ª ×›×ª×™×‘×ª ×”××˜×-×“××˜×”.&quot;</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="k">pass</span>
                            <span class="k">raise</span>

                        <span class="n">total_bytes</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">total_bytes</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">zip_path</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="n">total_bytes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">content_length</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>

                        <span class="c1"># Persist ×“×¨×š ×× ×”×œ ×”×’×™×‘×•×™×™× â€“ ×œ×œ× ×§×¨×™××ª ×”×–×™×¤ ×œ×–×™×›×¨×•×Ÿ</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">backup_manager</span><span class="o">.</span><span class="n">save_backup_file</span><span class="p">(</span><span class="n">zip_path</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e_persist</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">code</span> <span class="o">=</span> <span class="s2">&quot;ENOSPC&quot;</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e_persist</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">e_persist</span><span class="p">,</span> <span class="s1">&#39;errno&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOSPC</span> <span class="k">else</span> <span class="s2">&quot;persist_error&quot;</span>
                                <span class="n">emit_event</span><span class="p">(</span><span class="s2">&quot;github_zip_persist_error&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="n">repo</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">repo</span><span class="o">.</span><span class="n">full_name</span><span class="p">),</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e_persist</span><span class="p">),</span> <span class="n">code</span><span class="o">=</span><span class="n">code</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">errors_total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">errors_total</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="s2">&quot;github_zip_persist_error&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="k">pass</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e_persist</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">e_persist</span><span class="p">,</span> <span class="s1">&#39;errno&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOSPC</span><span class="p">:</span>
                                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âŒ ××™×Ÿ ××§×•× ×¤× ×•×™ ×‘×“×™×¡×§ ×©×œ ×”×©×¨×ª ×œ×©××™×¨×ª ×”×’×™×‘×•×™.&quot;</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="k">pass</span>
                            <span class="k">raise</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">_cache_recent_backup</span><span class="p">(</span>
                            <span class="n">context</span><span class="p">,</span>
                            <span class="n">backup_id</span><span class="o">=</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;backup_id&quot;</span><span class="p">),</span>
                            <span class="n">repo_full_name</span><span class="o">=</span><span class="n">repo</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span>
                            <span class="n">path</span><span class="o">=</span><span class="n">current_path</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                            <span class="n">file_count</span><span class="o">=</span><span class="n">file_count</span><span class="p">,</span>
                            <span class="n">total_size</span><span class="o">=</span><span class="n">total_bytes</span><span class="p">,</span>
                            <span class="n">created_at</span><span class="o">=</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;created_at&quot;</span><span class="p">),</span>
                        <span class="p">)</span>

                        <span class="c1"># ×©× ×™×“×™×“×•×ª×™ ×•×©×œ×™×—×”/×§×™×©×•×¨</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">infos</span> <span class="o">=</span> <span class="n">backup_manager</span><span class="o">.</span><span class="n">list_backups</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="n">infos</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">version_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_backup_version</span><span class="p">(</span>
                            <span class="n">context</span><span class="p">,</span>
                            <span class="n">repo</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span>
                            <span class="n">infos</span><span class="p">,</span>
                            <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;backup_id&quot;</span><span class="p">),</span>
                        <span class="p">)</span>
                        <span class="n">date_str</span> <span class="o">=</span> <span class="n">_dt</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">_tz</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%m-%y %H.%M&#39;</span><span class="p">)</span>
                        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;BKP zip </span><span class="si">{</span><span class="n">repo</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> v</span><span class="si">{</span><span class="n">version_number</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">date_str</span><span class="si">}</span><span class="s2">.zip&quot;</span>
                        <span class="n">caption</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ğŸ“¦ ×¨×™×¤×• ××œ× â€” </span><span class="si">{</span><span class="n">format_bytes</span><span class="p">(</span><span class="n">total_bytes</span><span class="p">)</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">ğŸ’¾ × ×©××¨ ×‘×¨×©×™××ª ×”×’×™×‘×•×™×™×.&quot;</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">too_big_for_telegram</span> <span class="ow">and</span> <span class="n">total_bytes</span> <span class="o">&lt;=</span> <span class="n">MAX_ZIP_TOTAL_BYTES</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">zip_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fsend</span><span class="p">:</span>
                                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_document</span><span class="p">(</span><span class="n">document</span><span class="o">=</span><span class="n">InputFile</span><span class="p">(</span><span class="n">fsend</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">),</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">caption</span><span class="o">=</span><span class="n">caption</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;âš ï¸ ×©×œ×™×—×ª ×”×§×•×‘×¥ × ×›×©×œ×”. ×œ×”×•×¨×“×” ×™×©×™×¨×” ×â€‘GitHub: </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;âœ… ×”×’×™×‘×•×™ × ×©××¨ (</span><span class="si">{</span><span class="n">format_bytes</span><span class="p">(</span><span class="n">total_bytes</span><span class="p">)</span><span class="si">}</span><span class="s2">). ×œ×”×•×¨×“×” ×™×©×™×¨×” ×â€‘GitHub: &lt;a href=</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&gt;×§×™×©×•×¨&lt;/a&gt;&quot;</span><span class="p">,</span>
                                <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                            <span class="p">)</span>

                        <span class="c1"># Summary + ×“×™×¨×•×’</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">backup_id</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;backup_id&quot;</span><span class="p">)</span>
                            <span class="n">date_str2</span> <span class="o">=</span> <span class="n">_dt</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">_tz</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/%m/%y %H:%M&#39;</span><span class="p">)</span>
                            <span class="n">v_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;(v</span><span class="si">{</span><span class="n">version_number</span><span class="si">}</span><span class="s2">) &quot;</span> <span class="k">if</span> <span class="n">version_number</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                            <span class="n">summary_line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;â¬‡ï¸ backup zip </span><span class="si">{</span><span class="n">repo</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> â€“ </span><span class="si">{</span><span class="n">date_str2</span><span class="si">}</span><span class="s2"> â€“ </span><span class="si">{</span><span class="n">v_text</span><span class="si">}{</span><span class="n">format_bytes</span><span class="p">(</span><span class="n">total_bytes</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="kn">from</span><span class="w"> </span><span class="nn">database</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span> <span class="k">as</span> <span class="n">_db</span>
                                <span class="n">existing_note</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">get_backup_note</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">backup_id</span><span class="p">))</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="n">existing_note</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                            <span class="n">note_btn_text</span> <span class="o">=</span> <span class="s2">&quot;ğŸ“ ×¢×¨×•×š ×”×¢×¨×”&quot;</span> <span class="k">if</span> <span class="n">existing_note</span> <span class="k">else</span> <span class="s2">&quot;ğŸ“ ×”×•×¡×£ ×”×¢×¨×”&quot;</span>
                            <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ† ××¦×•×™×Ÿ&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;backup_rate:</span><span class="si">{</span><span class="n">backup_id</span><span class="si">}</span><span class="s2">:excellent&quot;</span><span class="p">)],</span>
                                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ‘ ×˜×•×‘&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;backup_rate:</span><span class="si">{</span><span class="n">backup_id</span><span class="si">}</span><span class="s2">:good&quot;</span><span class="p">)],</span>
                                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ¤· ×¡×‘×™×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;backup_rate:</span><span class="si">{</span><span class="n">backup_id</span><span class="si">}</span><span class="s2">:ok&quot;</span><span class="p">)],</span>
                                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">note_btn_text</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;backup_add_note:</span><span class="si">{</span><span class="n">backup_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)],</span>
                            <span class="p">]</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">summary_line</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">s</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;backup_summaries&quot;</span><span class="p">,</span> <span class="p">{})</span>
                                <span class="n">s</span><span class="p">[</span><span class="n">backup_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;chat_id&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&quot;message_id&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="o">.</span><span class="n">message_id</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">summary_line</span><span class="p">}</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="k">pass</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error fetching/persisting repo zipball: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">emit_event</span><span class="p">(</span>
                                <span class="s2">&quot;github_zipball_fetch_error&quot;</span><span class="p">,</span>
                                <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span>
                                <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                                <span class="n">repo</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="s2">&quot;full_name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)),</span>
                            <span class="p">)</span>
                            <span class="k">if</span> <span class="n">errors_total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">errors_total</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="s2">&quot;github_zipball_fetch_error&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×”×•×¨×“×ª ZIP ×©×œ ×”×¨×™×¤×•: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br</span><span class="p">:</span>
                            <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                                <span class="k">raise</span>
                    <span class="k">finally</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">zip_path</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">zip_path</span><span class="p">):</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">zip_path</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                    <span class="c1"># ×œ××—×¨ ×™×¦×™×¨×ª ×•×”×•×¨×“×ª ×”â€‘ZIP, ×”×¦×’ ××ª ×¨×©×™××ª ×”×’×™×‘×•×™×™× ×¨×§ ×× × ×•×¦×¨ metadata (×›×œ×•××¨ ×”×”×•×¨×“×” ×”×¦×œ×™×—×”)</span>
                    <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">backup_handler</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">bot_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;backup_handler&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">backup_handler</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="kn">from</span><span class="w"> </span><span class="nn">backup_menu_handler</span><span class="w"> </span><span class="kn">import</span> <span class="n">BackupMenuHandler</span>
                                <span class="n">backup_handler</span> <span class="o">=</span> <span class="n">BackupMenuHandler</span><span class="p">()</span>
                                <span class="n">context</span><span class="o">.</span><span class="n">bot_data</span><span class="p">[</span><span class="s1">&#39;backup_handler&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">backup_handler</span>
                            <span class="c1"># ×”×’×“×¨ ×”×§×©×¨ ×—×–×¨×” ×œ×¡××‘Ö¾×ª×¤×¨×™×˜ GitHub ×•×’×‘×™×œ×ª ×”×¨×©×™××” ×œ×¨×™×¤×• ×”× ×•×›×—×™</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;zip_back_to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;github&#39;</span>
                                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;github_backup_context_repo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">full_name</span>
                                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;backup_highlight_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;backup_id&#39;</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="k">pass</span>
                            <span class="k">await</span> <span class="n">backup_handler</span><span class="o">.</span><span class="n">_show_backups_list</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_github_backup_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
                            <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br2</span><span class="p">:</span>
                                <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br2</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                                    <span class="k">raise</span>
                    <span class="k">return</span>

                <span class="n">zip_buffer</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
                <span class="n">total_bytes</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">total_files</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">skipped_large</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">zip_buffer</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="n">zipfile</span><span class="o">.</span><span class="n">ZIP_DEFLATED</span><span class="p">,</span> <span class="n">compresslevel</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span> <span class="k">as</span> <span class="n">zipf</span><span class="p">:</span>
                    <span class="c1"># ×§×‘×¢ ×©× ×ª×™×§×™×™×ª ×”×©×•×¨×© ×‘×ª×•×š ×”-ZIP</span>
                    <span class="n">zip_root</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">current_path</span> <span class="k">else</span> <span class="n">current_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="c1"># ×”×’× ×” ××¤× ×™ ×¨×§×•×¨×¡×™×•×ª/×œ×•×œ××•×ª ×‘× ×ª×™×‘×™× (×œ××©×œ ×§×™×©×•×¨×™×/×ª×•×›×Ÿ ×‘×¢×™×™×ª×™)</span>
                    <span class="n">visited_paths</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

                    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">walk_and_zip</span><span class="p">(</span><span class="n">start_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">base_prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># Seed root to avoid cycles that point back to the start</span>
                        <span class="k">if</span> <span class="n">start_path</span><span class="p">:</span>
                            <span class="n">visited_paths</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">start_path</span><span class="p">)</span>
                        <span class="n">stack</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[(</span><span class="n">start_path</span><span class="p">,</span> <span class="n">base_prefix</span><span class="p">)]</span>
                        <span class="k">while</span> <span class="n">stack</span><span class="p">:</span>
                            <span class="n">path</span><span class="p">,</span> <span class="n">rel_prefix</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                            <span class="c1"># ×”×’× ×” ××¤× ×™ ××—×–×•×¨×™ ×ª×™×§×™×•×ª ××• API ×‘×¢×™×™×ª×™ ×©××•×‘×™×œ ×œ×¨×§×•×¨×¡×™×”</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">contents</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="n">path</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">RecursionError</span><span class="p">:</span>
                                <span class="c1"># ×“×œ×’ ×¢×œ ×”× ×ª×™×‘ ×”×‘×¢×™×™×ª×™ ×•×”××©×š ×œ×‘××™×</span>
                                <span class="k">continue</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="c1"># ×‘××§×¨×” ×©×œ ×©×’×™××” ××—×¨×ª â€“ ×“×œ×’ ×¢×œ ×”× ×ª×™×‘ ×”×–×” ×‘×œ×‘×“</span>
                                <span class="k">continue</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">contents</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                                <span class="n">contents</span> <span class="o">=</span> <span class="p">[</span><span class="n">contents</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">contents</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;dir&quot;</span><span class="p">:</span>
                                    <span class="n">next_path</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">path</span>
                                    <span class="k">if</span> <span class="n">next_path</span> <span class="ow">in</span> <span class="n">visited_paths</span><span class="p">:</span>
                                        <span class="k">continue</span>
                                    <span class="n">visited_paths</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">next_path</span><span class="p">)</span>
                                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_rate_limit_delay</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                                    <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">next_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rel_prefix</span><span class="si">}{</span><span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/&quot;</span><span class="p">))</span>
                                <span class="k">elif</span> <span class="n">item</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;file&quot;</span><span class="p">:</span>
                                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_rate_limit_delay</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                                    <span class="c1"># ×©×œ×•×£ ××•×‘×™×™×§×˜ ×§×•×‘×¥ ××œ× ××”-API (×¢× ×ª×•×›×Ÿ), ×•× ×¤×™×œ×” × ×¢×™××” ×œ× ×ª×•× ×™× ×©×›×‘×¨ ×§×™×™××™× ×‘-item</span>
                                    <span class="n">file_obj</span> <span class="o">=</span> <span class="kc">None</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">fetched</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
                                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fetched</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                                            <span class="n">fetched</span> <span class="o">=</span> <span class="n">fetched</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">fetched</span> <span class="k">else</span> <span class="kc">None</span>
                                        <span class="n">file_obj</span> <span class="o">=</span> <span class="n">fetched</span>
                                    <span class="k">except</span> <span class="ne">RecursionError</span><span class="p">:</span>
                                        <span class="n">file_obj</span> <span class="o">=</span> <span class="kc">None</span>
                                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                        <span class="n">file_obj</span> <span class="o">=</span> <span class="kc">None</span>

                                    <span class="c1"># ×§×‘×¢ ×’×•×“×œ ×•×ª×•×›×Ÿ ×¢× × ×¤×™×œ×•×ª ×‘×˜×•×—×•×ª</span>
                                    <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
                                    <span class="n">file_size</span> <span class="o">=</span> <span class="mi">0</span>
                                    <span class="k">if</span> <span class="n">file_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                        <span class="n">file_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">file_obj</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
                                        <span class="n">data</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">file_obj</span><span class="p">,</span> <span class="s2">&quot;decoded_content&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s2">&quot;decoded_content&quot;</span><span class="p">):</span>
                                        <span class="n">data</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s2">&quot;decoded_content&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">file_size</span><span class="p">:</span>
                                        <span class="n">file_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">file_size</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">)):</span>
                                        <span class="n">file_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                                    <span class="k">nonlocal</span> <span class="n">total_bytes</span><span class="p">,</span> <span class="n">total_files</span><span class="p">,</span> <span class="n">skipped_large</span>
                                    <span class="k">if</span> <span class="n">file_size</span> <span class="o">&gt;</span> <span class="n">MAX_INLINE_FILE_BYTES</span><span class="p">:</span>
                                        <span class="n">skipped_large</span> <span class="o">+=</span> <span class="mi">1</span>
                                        <span class="k">continue</span>
                                    <span class="k">if</span> <span class="n">total_files</span> <span class="o">&gt;=</span> <span class="n">MAX_ZIP_FILES</span><span class="p">:</span>
                                        <span class="k">continue</span>
                                    <span class="k">if</span> <span class="n">total_bytes</span> <span class="o">+</span> <span class="n">file_size</span> <span class="o">&gt;</span> <span class="n">MAX_ZIP_TOTAL_BYTES</span><span class="p">:</span>
                                        <span class="k">continue</span>
                                    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                        <span class="c1"># ×œ× ×”×¦×œ×—× ×• ×œ×”×©×™×’ ×ª×•×›×Ÿ â€“ ×“×œ×’ ×¢×œ ×”×§×•×‘×¥ ×‘×‘×˜×—×”</span>
                                        <span class="k">continue</span>
                                    <span class="n">arcname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">zip_root</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">rel_prefix</span><span class="si">}{</span><span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                                    <span class="n">zipf</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="n">arcname</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                                    <span class="n">total_bytes</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                                    <span class="n">total_files</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="k">await</span> <span class="n">walk_and_zip</span><span class="p">(</span><span class="n">current_path</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="c1"># ×”×•×¡×£ metadata.json</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;backup_id&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;backup_</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
                    <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                    <span class="s2">&quot;backup_type&quot;</span><span class="p">:</span> <span class="s2">&quot;github_repo_zip&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;include_versions&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;file_count&quot;</span><span class="p">:</span> <span class="n">total_files</span><span class="p">,</span>
                    <span class="s2">&quot;created_by&quot;</span><span class="p">:</span> <span class="s2">&quot;Code Keeper Bot&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;repo&quot;</span><span class="p">:</span> <span class="n">repo</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span>
                    <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">current_path</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
                <span class="p">}</span>
                <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">zip_buffer</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="n">zipfile</span><span class="o">.</span><span class="n">ZIP_DEFLATED</span><span class="p">,</span> <span class="n">compresslevel</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span> <span class="k">as</span> <span class="n">zipf</span><span class="p">:</span>
                    <span class="n">zipf</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="s2">&quot;metadata.json&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

                <span class="n">zip_buffer</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="c1"># ×©× ×™×“×™×“×•×ª×™ ×œ-folder/repo</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">infos</span> <span class="o">=</span> <span class="n">backup_manager</span><span class="o">.</span><span class="n">list_backups</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">infos</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">version_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_backup_version</span><span class="p">(</span>
                    <span class="n">context</span><span class="p">,</span>
                    <span class="n">repo</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span>
                    <span class="n">infos</span><span class="p">,</span>
                    <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;backup_id&quot;</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="n">date_str</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%m-%y %H.%M&#39;</span><span class="p">)</span>
                <span class="n">name_part</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">current_path</span> <span class="k">else</span> <span class="n">current_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;BKP zip </span><span class="si">{</span><span class="n">name_part</span><span class="si">}</span><span class="s2"> v</span><span class="si">{</span><span class="n">version_number</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">date_str</span><span class="si">}</span><span class="s2">.zip&quot;</span>
                <span class="n">zip_buffer</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">filename</span>
                <span class="n">caption</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;ğŸ“¦ ×§×•×‘×¥ ZIP ×œ×ª×™×§×™×™×”: /</span><span class="si">{</span><span class="n">current_path</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;××›×™×œ </span><span class="si">{</span><span class="n">total_files</span><span class="si">}</span><span class="s2"> ×§×‘×¦×™×, </span><span class="si">{</span><span class="n">format_bytes</span><span class="p">(</span><span class="n">total_bytes</span><span class="p">)</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;ğŸ’¾ × ×©××¨ ×‘×¨×©×™××ª ×”×’×™×‘×•×™×™×.&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">skipped_large</span><span class="p">:</span>
                    <span class="n">caption</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">âš ï¸ ×“×™×œ×’ ×¢×œ </span><span class="si">{</span><span class="n">skipped_large</span><span class="si">}</span><span class="s2"> ×§×‘×¦×™× ×’×“×•×œ×™× (&gt; </span><span class="si">{</span><span class="n">format_bytes</span><span class="p">(</span><span class="n">MAX_INLINE_FILE_BYTES</span><span class="p">)</span><span class="si">}</span><span class="s2">).&quot;</span>
                <span class="c1"># ×©××•×¨ ×’×™×‘×•×™ (Mongo/FS ×‘×”×ª×× ×œ×§×•× ×¤×™×’)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">backup_manager</span><span class="o">.</span><span class="n">save_backup_bytes</span><span class="p">(</span><span class="n">zip_buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),</span> <span class="n">metadata</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_cache_recent_backup</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">backup_id</span><span class="o">=</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;backup_id&quot;</span><span class="p">),</span> <span class="n">repo_full_name</span><span class="o">=</span><span class="n">repo</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">current_path</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">file_count</span><span class="o">=</span><span class="n">total_files</span><span class="p">,</span> <span class="n">total_size</span><span class="o">=</span><span class="n">total_bytes</span><span class="p">,</span> <span class="n">created_at</span><span class="o">=</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;created_at&quot;</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to persist GitHub ZIP: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">emit_event</span><span class="p">(</span>
                            <span class="s2">&quot;github_zip_persist_error&quot;</span><span class="p">,</span>
                            <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;warn&quot;</span><span class="p">,</span>
                            <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                            <span class="n">repo</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="s2">&quot;full_name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)),</span>
                        <span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_document</span><span class="p">(</span>
                    <span class="n">document</span><span class="o">=</span><span class="n">zip_buffer</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">caption</span><span class="o">=</span><span class="n">caption</span>
                <span class="p">)</span>
                <span class="c1"># ×”×¦×’ ×©×•×¨×ª ×¡×™×›×•× ×‘×¡×’× ×•×Ÿ ×”××‘×•×§×© ×•××– ×‘×§×© ×ª×™×•×’</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">backup_id</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;backup_id&quot;</span><span class="p">)</span>
                    <span class="n">date_str</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/%m/%y %H:%M&#39;</span><span class="p">)</span>
                    <span class="n">v_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;(v</span><span class="si">{</span><span class="n">version_number</span><span class="si">}</span><span class="s2">) &quot;</span> <span class="k">if</span> <span class="n">version_number</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                    <span class="n">summary_line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;â¬‡ï¸ backup zip </span><span class="si">{</span><span class="n">repo</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> â€“ </span><span class="si">{</span><span class="n">date_str</span><span class="si">}</span><span class="s2"> â€“ </span><span class="si">{</span><span class="n">v_text</span><span class="si">}{</span><span class="n">format_bytes</span><span class="p">(</span><span class="n">total_bytes</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="kn">from</span><span class="w"> </span><span class="nn">database</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span> <span class="k">as</span> <span class="n">_db</span>
                        <span class="n">existing_note</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">get_backup_note</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">backup_id</span><span class="p">))</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">existing_note</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="n">note_btn_text</span> <span class="o">=</span> <span class="s2">&quot;ğŸ“ ×¢×¨×•×š ×”×¢×¨×”&quot;</span> <span class="k">if</span> <span class="n">existing_note</span> <span class="k">else</span> <span class="s2">&quot;ğŸ“ ×”×•×¡×£ ×”×¢×¨×”&quot;</span>
                    <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ† ××¦×•×™×Ÿ&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;backup_rate:</span><span class="si">{</span><span class="n">backup_id</span><span class="si">}</span><span class="s2">:excellent&quot;</span><span class="p">)],</span>
                        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ‘ ×˜×•×‘&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;backup_rate:</span><span class="si">{</span><span class="n">backup_id</span><span class="si">}</span><span class="s2">:good&quot;</span><span class="p">)],</span>
                        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ¤· ×¡×‘×™×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;backup_rate:</span><span class="si">{</span><span class="n">backup_id</span><span class="si">}</span><span class="s2">:ok&quot;</span><span class="p">)],</span>
                        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">note_btn_text</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;backup_add_note:</span><span class="si">{</span><span class="n">backup_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)],</span>
                    <span class="p">]</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">summary_line</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;backup_summaries&quot;</span><span class="p">,</span> <span class="p">{})</span>
                        <span class="n">s</span><span class="p">[</span><span class="n">backup_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;chat_id&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&quot;message_id&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="o">.</span><span class="n">message_id</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">summary_line</span><span class="p">}</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="c1"># Rating buttons already attached above; no need to call external handler</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># ×œ×•×’ ×›×•×œ×œ traceback ×›×“×™ ×œ××‘×—×Ÿ ×›×©×œ×™× × ×“×™×¨×™× (×œ××©×œ ×¨×§×•×¨×¡×™×”)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating ZIP: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">emit_event</span><span class="p">(</span>
                        <span class="s2">&quot;github_zip_create_error&quot;</span><span class="p">,</span>
                        <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span>
                        <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                        <span class="n">repo</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="s2">&quot;full_name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)),</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">errors_total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">errors_total</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="s2">&quot;github_zip_create_error&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×”×›× ×ª ZIP: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                        <span class="k">raise</span>
                <span class="k">return</span>
            <span class="c1"># ×”×—×–×¨ ×œ×“×¤×“×¤×Ÿ ×‘××•×ª×• ××§×•×</span>
            <span class="c1"># ×œ××—×¨ ×™×¦×™×¨×ª ×•×”×•×¨×“×ª ×”â€‘ZIP, ×”×¦×’ ××ª ×¨×©×™××ª ×”×’×™×‘×•×™×™× ×¢×‘×•×¨ ×”×¨×™×¤×• ×”× ×•×›×—×™</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">backup_handler</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">bot_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;backup_handler&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">backup_handler</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">backup_menu_handler</span><span class="w"> </span><span class="kn">import</span> <span class="n">BackupMenuHandler</span>
                    <span class="n">backup_handler</span> <span class="o">=</span> <span class="n">BackupMenuHandler</span><span class="p">()</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">bot_data</span><span class="p">[</span><span class="s1">&#39;backup_handler&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">backup_handler</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;zip_back_to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;github&#39;</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;github_backup_context_repo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">full_name</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;backup_highlight_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;backup_id&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">await</span> <span class="n">backup_handler</span><span class="o">.</span><span class="n">_show_backups_list</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">br</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_repo_browser</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br2</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br2</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                        <span class="k">raise</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;inline_download_file:&quot;</span><span class="p">):</span>
            <span class="c1"># ×”×•×¨×“×ª ×§×•×‘×¥ ×©× ×‘×—×¨ ×“×¨×š ××™× ×œ×™×™×Ÿ</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
            <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_name</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×—×¡×¨×™× × ×ª×•× ×™× (×‘×—×¨ ×¨×™×¤×• ×¢× /github)&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="c1"># ×‘××¦×‘ Inline ××™×Ÿ query.message ×•×œ×›×Ÿ reply_* ×™×§×¨×•×¡. × ×¢×¨×•×š ××ª ×”×”×•×“×¢×” ×”××§×•×¨×™×ª</span>
            <span class="c1"># ×œ×”×•×“×¢×ª &quot;+ ××ª×—×™×œ ×‘×”×•×¨×“×”&quot; ×•× ×©×œ×— ××ª ×”×§×•×‘×¥ ×‘×¤×¨×˜×™ ×œ××©×ª××©.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">TelegramUtils</span><span class="o">.</span><span class="n">safe_edit_message_text</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s2">&quot;â¬‡ï¸ ××ª×—×™×œ ×‘×”×•×¨×“×”â€¦&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>

                <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span>
                <span class="n">contents</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="n">size</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">contents</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span>

                <span class="c1"># ×¤×•× ×§×¦×™×•×ª ×©×œ×™×—×” ×‘×”×ª×× ×œ×¡×•×’ ×”×”×•×“×¢×”</span>
                <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_send_text</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">parse_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">parse_mode</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">context</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">chat_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">parse_mode</span><span class="p">)</span>

                <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_send_document</span><span class="p">(</span><span class="n">buf</span><span class="p">:</span> <span class="n">BytesIO</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">caption</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_document</span><span class="p">(</span><span class="n">document</span><span class="o">=</span><span class="n">buf</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">caption</span><span class="o">=</span><span class="n">caption</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">context</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">send_document</span><span class="p">(</span><span class="n">chat_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">document</span><span class="o">=</span><span class="n">buf</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">caption</span><span class="o">=</span><span class="n">caption</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">size</span> <span class="ow">and</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">MAX_INLINE_FILE_BYTES</span><span class="p">:</span>
                    <span class="n">download_url</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">contents</span><span class="p">,</span> <span class="s2">&quot;download_url&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">download_url</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">_send_text</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s1">&#39;âš ï¸ ×”×§×•×‘×¥ ×’×“×•×œ (</span><span class="si">{</span><span class="n">format_bytes</span><span class="p">(</span><span class="n">size</span><span class="p">)</span><span class="si">}</span><span class="s1">). ×œ×”×•×¨×“×”: &lt;a href=&quot;</span><span class="si">{</span><span class="n">download_url</span><span class="si">}</span><span class="s1">&quot;&gt;×§×™×©×•×¨ ×™×©×™×¨&lt;/a&gt;&#39;</span><span class="p">,</span>
                            <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">_send_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âš ï¸ ×”×§×•×‘×¥ ×’×“×•×œ (</span><span class="si">{</span><span class="n">format_bytes</span><span class="p">(</span><span class="n">size</span><span class="p">)</span><span class="si">}</span><span class="s2">) ×•×œ× × ×™×ª×Ÿ ×œ×”×•×¨×™×“×• ×™×©×™×¨×•×ª ×›×¨×’×¢.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">contents</span><span class="o">.</span><span class="n">decoded_content</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">contents</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;downloaded_file&quot;</span>
                    <span class="k">await</span> <span class="n">_send_document</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">filename</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inline download error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">emit_event</span><span class="p">(</span>
                        <span class="s2">&quot;github_inline_download_error&quot;</span><span class="p">,</span>
                        <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span>
                        <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                        <span class="n">repo</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="s2">&quot;full_name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)),</span>
                        <span class="n">path</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">errors_total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">errors_total</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="s2">&quot;github_inline_download_error&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×”×•×¨×“×”: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">context</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">chat_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×”×•×¨×“×”: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">return</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;browse_page:&quot;</span><span class="p">):</span>
            <span class="c1"># ××¢×‘×¨ ×¢××•×“×™× ×‘×“×¤×“×¤×Ÿ ×”×¨×™×¤×•</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">page_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">page_index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">page_index</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_repo_browser</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">only_keyboard</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;multi_toggle&quot;</span><span class="p">:</span>
            <span class="c1"># ×”×¤×¢×œ/×‘×˜×œ ××¦×‘ ×‘×—×™×¨×” ××¨×•×‘×”</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;multi_mode&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;multi_mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">current</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;multi_mode&quot;</span><span class="p">]:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;multi_selection&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;××¦×‘ ×‘×—×™×¨×” ××¨×•×‘×” ×‘×•×˜×œ&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;××¦×‘ ×‘×—×™×¨×” ××¨×•×‘×” ×”×•×¤×¢×œ â€” ×¡××Ÿ ×§×‘×¦×™× ××”×¨×©×™××”&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_repo_browser</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">only_keyboard</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;browse_toggle_select:&quot;</span><span class="p">):</span>
            <span class="c1"># ×”×•×¡×£/×”×¡×¨ ×‘×—×™×¨×” ×©×œ ×§×•×‘×¥</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">selection</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;multi_selection&quot;</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="k">if</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">:</span>
                <span class="n">selection</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">selection</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;multi_selection&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_repo_browser</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">only_keyboard</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;multi_clear&quot;</span><span class="p">:</span>
            <span class="c1"># × ×§×” ×‘×—×™×¨×•×ª</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;multi_selection&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_repo_browser</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">only_keyboard</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;safe_toggle&quot;</span><span class="p">:</span>
            <span class="c1"># ×”×—×œ×£ ××¦×‘ ××—×™×§×” ×‘×˜×•×—×”</span>
            <span class="n">new_state</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;safe_delete&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;safe_delete&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_state</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;××—×™×§×” ×‘×˜×•×—×” &quot;</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;×¤×¢×™×œ×” (PR)&quot;</span> <span class="k">if</span> <span class="n">new_state</span> <span class="k">else</span> <span class="s2">&quot;×›×‘×•×™×” â€” ××•×—×§ ×™×©×™×¨×•×ª&quot;</span><span class="p">),</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_repo_browser</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">only_keyboard</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;multi_execute&quot;</span><span class="p">:</span>
            <span class="c1"># ×‘×¦×¢ ×¤×¢×•×œ×” ×¢×œ ×”×‘×—×™×¨×” (ZIP ×‘×”×•×¨×“×” | ××—×™×§×” ×‘××¦×‘ ××—×™×§×”)</span>
            <span class="n">selection</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;multi_selection&quot;</span><span class="p">,</span> <span class="p">[])))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">selection</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;×œ× × ×‘×—×¨×• ×§×‘×¦×™×&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
            <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_name</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×—×¡×¨×™× × ×ª×•× ×™×&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;browse_action&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;download&quot;</span><span class="p">:</span>
                <span class="c1"># ××¨×•×– ××ª ×”×‘×—×™×¨×” ×œ-ZIP</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">zip_buffer</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
                    <span class="n">total_bytes</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">total_files</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">skipped_large</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">zip_buffer</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="n">zipfile</span><span class="o">.</span><span class="n">ZIP_DEFLATED</span><span class="p">)</span> <span class="k">as</span> <span class="n">zipf</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">:</span>
                            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_rate_limit_delay</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">file_obj</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">file_obj</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;file&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;file&quot;</span><span class="p">:</span>
                                    <span class="k">continue</span>
                                <span class="n">file_size</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">file_obj</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span>
                                <span class="k">if</span> <span class="n">file_size</span> <span class="o">&gt;</span> <span class="n">MAX_INLINE_FILE_BYTES</span><span class="p">:</span>
                                    <span class="n">skipped_large</span> <span class="o">+=</span> <span class="mi">1</span>
                                    <span class="k">continue</span>
                                <span class="k">if</span> <span class="n">total_files</span> <span class="o">&gt;=</span> <span class="n">MAX_ZIP_FILES</span><span class="p">:</span>
                                    <span class="k">continue</span>
                                <span class="k">if</span> <span class="n">total_bytes</span> <span class="o">+</span> <span class="n">file_size</span> <span class="o">&gt;</span> <span class="n">MAX_ZIP_TOTAL_BYTES</span><span class="p">:</span>
                                    <span class="k">continue</span>
                                <span class="n">data</span> <span class="o">=</span> <span class="n">file_obj</span><span class="o">.</span><span class="n">decoded_content</span>
                                <span class="n">arcname</span> <span class="o">=</span> <span class="n">file_obj</span><span class="o">.</span><span class="n">path</span>  <span class="c1"># ×©××•×¨ ××‘× ×” × ×ª×™×‘</span>
                                <span class="n">zipf</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="n">arcname</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                                <span class="n">total_bytes</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                                <span class="n">total_files</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">total_files</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;××™×Ÿ ×§×‘×¦×™× ××ª××™××™× ×œ××¨×™×–×”&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">zip_buffer</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">repo</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">-selected.zip&quot;</span>
                        <span class="n">caption</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ğŸ“¦ ZIP ×œ×§×‘×¦×™× × ×‘×—×¨×™× â€” </span><span class="si">{</span><span class="n">total_files</span><span class="si">}</span><span class="s2"> ×§×‘×¦×™×, </span><span class="si">{</span><span class="n">format_bytes</span><span class="p">(</span><span class="n">total_bytes</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
                        <span class="k">if</span> <span class="n">skipped_large</span><span class="p">:</span>
                            <span class="n">caption</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">âš ï¸ ×“×™×œ×’ ×¢×œ </span><span class="si">{</span><span class="n">skipped_large</span><span class="si">}</span><span class="s2"> ×§×‘×¦×™× ×’×“×•×œ×™× (&gt; </span><span class="si">{</span><span class="n">format_bytes</span><span class="p">(</span><span class="n">MAX_INLINE_FILE_BYTES</span><span class="p">)</span><span class="si">}</span><span class="s2">).&quot;</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_document</span><span class="p">(</span>
                            <span class="n">document</span><span class="o">=</span><span class="n">zip_buffer</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">caption</span><span class="o">=</span><span class="n">caption</span>
                        <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Multi ZIP error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">emit_event</span><span class="p">(</span>
                            <span class="s2">&quot;github_multi_zip_error&quot;</span><span class="p">,</span>
                            <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span>
                            <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                            <span class="n">repo</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="s2">&quot;full_name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)),</span>
                            <span class="n">selected_count</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">set</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="k">else</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">errors_total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">errors_total</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="s2">&quot;github_multi_zip_error&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘××¨×™×–×ª ZIP: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="c1"># ×œ××—×¨ ×¤×¢×•×œ×”, ×©××•×¨ ×‘×“×¤×“×¤×Ÿ</span>
                    <span class="k">pass</span>
                <span class="c1"># ×”×©××¨ ×‘×“×¤×“×¤×Ÿ</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_repo_browser</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># ××—×™×§×” ×©×œ × ×‘×—×¨×™×</span>
                <span class="n">safe_delete</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;safe_delete&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="n">default_branch</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">default_branch</span> <span class="ow">or</span> <span class="s2">&quot;main&quot;</span>
                <span class="n">successes</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">failures</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">pr_url</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">safe_delete</span><span class="p">:</span>
                    <span class="c1"># ×¦×•×¨ ×¡× ×™×£ ×—×“×© ×•××—×•×§ ×‘×•, ×•××– ×¤×ª×— PR</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">base_ref</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_git_ref</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;heads/</span><span class="si">{</span><span class="n">default_branch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">new_branch</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;delete-bot-</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">repo</span><span class="o">.</span><span class="n">create_git_ref</span><span class="p">(</span><span class="n">ref</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;refs/heads/</span><span class="si">{</span><span class="n">new_branch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sha</span><span class="o">=</span><span class="n">base_ref</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">sha</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">:</span>
                            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_rate_limit_delay</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">contents</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">new_branch</span><span class="p">)</span>
                                <span class="n">repo</span><span class="o">.</span><span class="n">delete_file</span><span class="p">(</span>
                                    <span class="n">contents</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                                    <span class="sa">f</span><span class="s2">&quot;Delete via bot: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                    <span class="n">contents</span><span class="o">.</span><span class="n">sha</span><span class="p">,</span>
                                    <span class="n">branch</span><span class="o">=</span><span class="n">new_branch</span><span class="p">,</span>
                                <span class="p">)</span>
                                <span class="n">successes</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">pr</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">create_pull</span><span class="p">(</span>
                            <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Delete </span><span class="si">{</span><span class="n">successes</span><span class="si">}</span><span class="s2"> files via bot&quot;</span><span class="p">,</span>
                            <span class="n">body</span><span class="o">=</span><span class="s2">&quot;Automated deletion&quot;</span><span class="p">,</span>
                            <span class="n">base</span><span class="o">=</span><span class="n">default_branch</span><span class="p">,</span>
                            <span class="n">head</span><span class="o">=</span><span class="n">new_branch</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">pr_url</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">html_url</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Safe delete failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">emit_event</span><span class="p">(</span>
                                <span class="s2">&quot;github_safe_delete_error&quot;</span><span class="p">,</span>
                                <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span>
                                <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                                <span class="n">repo</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="s2">&quot;full_name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)),</span>
                                <span class="n">branch</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">default_branch</span><span class="p">),</span>
                            <span class="p">)</span>
                            <span class="k">if</span> <span class="n">errors_total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">errors_total</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="s2">&quot;github_safe_delete_error&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘××—×™×§×” ×‘×˜×•×—×”: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">return</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># ××—×™×§×” ×™×©×™×¨×” ×‘×‘×¨×× ×¥&#39; ×‘×¨×™×¨×ª ×”××—×“×œ</span>
                    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">:</span>
                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_rate_limit_delay</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">contents</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                            <span class="n">repo</span><span class="o">.</span><span class="n">delete_file</span><span class="p">(</span>
                                <span class="n">contents</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                                <span class="sa">f</span><span class="s2">&quot;Delete via bot: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                <span class="n">contents</span><span class="o">.</span><span class="n">sha</span><span class="p">,</span>
                                <span class="n">branch</span><span class="o">=</span><span class="n">default_branch</span><span class="p">,</span>
                            <span class="p">)</span>
                            <span class="n">successes</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Delete file failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">emit_event</span><span class="p">(</span>
                                    <span class="s2">&quot;github_delete_file_error&quot;</span><span class="p">,</span>
                                    <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span>
                                    <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                                    <span class="n">repo</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="s2">&quot;full_name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)),</span>
                                    <span class="n">path</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">),</span>
                                <span class="p">)</span>
                                <span class="k">if</span> <span class="n">errors_total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">errors_total</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="s2">&quot;github_delete_file_error&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="k">pass</span>
                            <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c1"># ×¡×›× ×•×”×¦×’</span>
                <span class="n">summary</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;âœ… × ××—×§×• </span><span class="si">{</span><span class="n">successes</span><span class="si">}</span><span class="s2"> | âŒ × ×›×©×œ×• </span><span class="si">{</span><span class="n">failures</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">pr_url</span><span class="p">:</span>
                    <span class="n">summary</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">ğŸ”— × ×¤×ª×— PR: &lt;a href=&quot;</span><span class="si">{</span><span class="n">pr_url</span><span class="si">}</span><span class="s1">&quot;&gt;×§×™×©×•×¨&lt;/a&gt;&#39;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="c1"># ××¤×¡ ××¦×‘ ××¨×•×‘×” ×•×—×–×•×¨ ×œ×ª×¤×¨×™×˜ ×”×“×¤×“×¤×Ÿ</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;multi_mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;multi_selection&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_repo_browser</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;share_folder_link:&quot;</span><span class="p">):</span>
            <span class="c1"># ×©×™×ª×•×£ ×§×™×©×•×¨ ×œ×ª×™×§×™×™×”</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
            <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_name</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;âŒ ×—×¡×¨×™× × ×ª×•× ×™×&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span>
            <span class="n">branch</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">default_branch</span> <span class="ow">or</span> <span class="s2">&quot;main&quot;</span>
            <span class="n">clean_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">path</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">url</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;https://github.com/</span><span class="si">{</span><span class="n">repo</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">/tree/</span><span class="si">{</span><span class="n">branch</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">clean_path</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">clean_path</span>
                <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;https://github.com/</span><span class="si">{</span><span class="n">repo</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">/tree/</span><span class="si">{</span><span class="n">branch</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ğŸ”— ×§×™×©×•×¨ ×œ×ª×™×§×™×™×”:</span><span class="se">\n</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;×”×§×™×©×•×¨ × ×©×œ×— ×‘×”×•×“×¢×” ×—×“×©×”&quot;</span><span class="p">)</span>
            <span class="c1"># ×”×™×©××¨ ×‘×“×¤×“×¤×Ÿ</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_repo_browser</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;share_selected_links&quot;</span><span class="p">:</span>
            <span class="c1"># ×©×™×ª×•×£ ×§×™×©×•×¨×™× ×œ×§×‘×¦×™× × ×‘×—×¨×™×</span>
            <span class="n">selection</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;multi_selection&quot;</span><span class="p">,</span> <span class="p">[])))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">selection</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;×œ× × ×‘×—×¨×• ×§×‘×¦×™×&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
            <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_name</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;âŒ ×—×¡×¨×™× × ×ª×•× ×™×&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span>
            <span class="n">branch</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">default_branch</span> <span class="ow">or</span> <span class="s2">&quot;main&quot;</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">[:</span><span class="mi">50</span><span class="p">]:</span>
                <span class="c1"># guard: ensure string before strip</span>
                <span class="n">clean</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
                <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://github.com/</span><span class="si">{</span><span class="n">repo</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">/blob/</span><span class="si">{</span><span class="n">branch</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">clean</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;â€¢ </span><span class="si">{</span><span class="n">clean</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;ğŸ”— ×§×™×©×•×¨×™× ×œ×§×‘×¦×™× × ×‘×—×¨×™×:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;share_selected_links error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">emit_event</span><span class="p">(</span>
                        <span class="s2">&quot;github_share_selected_links_error&quot;</span><span class="p">,</span>
                        <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span>
                        <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                        <span class="n">repo</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="s2">&quot;full_name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)),</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">errors_total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">errors_total</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="s2">&quot;github_share_selected_links_error&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;×©×’×™××” ×‘×©×™×ª×•×£ ×§×™×©×•×¨×™×&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># ×”×©××¨ ×‘×“×¤×“×¤×Ÿ</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_repo_browser</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;share_selected_links_single:&quot;</span><span class="p">):</span>
            <span class="c1"># ×©×™×ª×•×£ ×§×™×©×•×¨ ×œ×§×•×‘×¥ ×™×—×™×“ ××ª×¦×•×’×” ×¨×’×™×œ×”</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
            <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_name</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;âŒ ×—×¡×¨×™× × ×ª×•× ×™×&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span>
            <span class="n">branch</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">default_branch</span> <span class="ow">or</span> <span class="s2">&quot;main&quot;</span>
            <span class="n">clean</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://github.com/</span><span class="si">{</span><span class="n">repo</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">/blob/</span><span class="si">{</span><span class="n">branch</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">clean</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ğŸ”— ×§×™×©×•×¨ ×œ×§×•×‘×¥:</span><span class="se">\n</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;share_single_link error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">emit_event</span><span class="p">(</span>
                        <span class="s2">&quot;github_share_single_link_error&quot;</span><span class="p">,</span>
                        <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span>
                        <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                        <span class="n">repo</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="s2">&quot;full_name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)),</span>
                        <span class="n">path</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">errors_total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">errors_total</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="s2">&quot;github_share_single_link_error&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;×©×’×™××” ×‘×©×™×ª×•×£ ×§×™×©×•×¨&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_repo_browser</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">only_keyboard</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;notifications_menu&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_notifications_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;notifications_toggle&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">toggle_notifications</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;notifications_toggle_pr&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">toggle_notifications_pr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;notifications_toggle_issues&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">toggle_notifications_issues</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;notifications_interval_&quot;</span><span class="p">):</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_notifications_interval</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;notifications_check_now&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">notifications_check_now</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;notifications_sentry_test&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">notifications_sentry_test</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;pr_menu&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_pr_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;create_pr_menu&quot;</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;pr_branches_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_create_pr_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;branches_page_&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;pr_branches_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_create_pr_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;pr_select_head:&quot;</span><span class="p">):</span>
            <span class="n">head</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;pr_head&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">head</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_confirm_create_pr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;confirm_create_pr&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">confirm_create_pr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;merge_pr_menu&quot;</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;pr_list_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_merge_pr_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;prs_page_&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;pr_list_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_merge_pr_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;merge_pr:&quot;</span><span class="p">):</span>
            <span class="n">pr_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;pr_to_merge&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pr_number</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_confirm_merge_pr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;refresh_merge_pr&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_confirm_merge_pr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;confirm_merge_pr&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">confirm_merge_pr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;validate_repo&quot;</span><span class="p">:</span>
            <span class="n">status_message</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">done_event</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
            <span class="n">progress_task</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">status_message</span> <span class="o">=</span> <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;â³ ×‘×•×“×§ ×ª×§×™× ×•×ª ×”×¨×™×¤×•... 0%&quot;</span><span class="p">)</span>

                <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_progress_updater</span><span class="p">():</span>
                    <span class="n">percent</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">while</span> <span class="ow">not</span> <span class="n">done_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                            <span class="n">percent</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">percent</span> <span class="o">+</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">90</span><span class="p">)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">await</span> <span class="n">status_message</span><span class="o">.</span><span class="n">edit_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;â³ ×‘×•×“×§ ×ª×§×™× ×•×ª ×”×¨×™×¤×•... </span><span class="si">{</span><span class="n">percent</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="k">pass</span>
                            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>

                <span class="n">progress_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">_progress_updater</span><span class="p">())</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
                <span class="n">token_opt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">login_or_token</span><span class="o">=</span><span class="p">(</span><span class="n">token_opt</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
                <span class="n">repo_full</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">repo_full</span><span class="p">:</span>
                    <span class="n">done_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">progress_task</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">await</span> <span class="n">progress_task</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                    <span class="k">await</span> <span class="p">(</span><span class="n">status_message</span><span class="o">.</span><span class="n">edit_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×§×•×“× ×‘×—×¨ ×¨×™×¤×•!&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">status_message</span> <span class="k">else</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×§×•×“× ×‘×—×¨ ×¨×™×¤×•!&quot;</span><span class="p">))</span>
                    <span class="k">return</span>

                <span class="k">def</span><span class="w"> </span><span class="nf">do_validate</span><span class="p">():</span>
                    <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_full</span><span class="p">)</span>
                    <span class="n">url</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_archive_link</span><span class="p">(</span><span class="s2">&quot;zipball&quot;</span><span class="p">)</span>
                    <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;repo_val_&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tmp</span><span class="p">:</span>
                        <span class="n">zip_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="s2">&quot;repo.zip&quot;</span><span class="p">)</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="n">http_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
                        <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">zip_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
                        <span class="n">extract_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="s2">&quot;repo&quot;</span><span class="p">)</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">extract_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">zip_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zf</span><span class="p">:</span>
                            <span class="n">zf</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">extract_dir</span><span class="p">)</span>
                        <span class="c1"># GitHub zip ×™×•×¦×¨ ×ª×™×§×™×™×ª-×©×•×¨×© ×™×—×™×“×”</span>
                        <span class="n">entries</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">extract_dir</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">extract_dir</span><span class="p">)]</span>
                        <span class="n">root</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">entries</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">p</span><span class="p">)),</span> <span class="n">extract_dir</span><span class="p">)</span>
                        <span class="c1"># ×”×¢×ª×§ ×§×‘×¦×™ ×§×•× ×¤×™×’ ×× ×™×©</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;.flake8&quot;</span><span class="p">,</span> <span class="s2">&quot;pyproject.toml&quot;</span><span class="p">,</span> <span class="s2">&quot;mypy.ini&quot;</span><span class="p">,</span> <span class="s2">&quot;bandit.yaml&quot;</span><span class="p">):</span>
                                <span class="n">src</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">name</span><span class="p">)</span>
                                <span class="n">dst</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span>
                                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">d</span><span class="p">:</span>
                                        <span class="n">d</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="c1"># ×”×¨×¦×ª ×›×œ×™× ×¢×œ ×›×œ ×”×¨×™×¤×•</span>
                        <span class="k">def</span><span class="w"> </span><span class="nf">_run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">):</span>
                            <span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">cp</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">root</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
                                <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">stdout</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">stderr</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                                <span class="k">return</span> <span class="n">cp</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">out</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">TimeoutExpired</span><span class="p">:</span>
                                <span class="k">return</span> <span class="mi">124</span><span class="p">,</span> <span class="s2">&quot;Timeout&quot;</span>
                            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                                <span class="k">return</span> <span class="mi">127</span><span class="p">,</span> <span class="s2">&quot;Tool not installed&quot;</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="k">return</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                        
                        <span class="c1"># ×”×¢×“×¤×ª ×›×œ×™× ××”-venv ×”××§×•××™ ×× ×§×™×™×</span>
                        <span class="n">venv_bin</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s2">&quot;.venv&quot;</span><span class="p">,</span> <span class="s2">&quot;bin&quot;</span><span class="p">)</span>
                        <span class="n">venv_python</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">venv_bin</span><span class="p">,</span> <span class="s2">&quot;python&quot;</span><span class="p">)</span>
                        
                        <span class="k">def</span><span class="w"> </span><span class="nf">_resolve_tool_candidates</span><span class="p">(</span><span class="n">tool_name</span><span class="p">):</span>
                            <span class="n">candidates</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">venv_bin</span><span class="p">):</span>
                                <span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">venv_bin</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">venv_python</span><span class="p">):</span>
                                <span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">venv_python</span><span class="p">,</span> <span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">])</span>
                            <span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tool_name</span><span class="p">)</span>
                            <span class="k">return</span> <span class="n">candidates</span>

                        <span class="k">def</span><span class="w"> </span><span class="nf">_run_any</span><span class="p">(</span><span class="n">tool_name</span><span class="p">,</span> <span class="n">base_args</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">):</span>
                            <span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">_resolve_tool_candidates</span><span class="p">(</span><span class="n">tool_name</span><span class="p">):</span>
                                <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="n">candidate</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">candidate</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">candidate</span><span class="p">])</span> <span class="o">+</span> <span class="n">base_args</span>
                                <span class="n">rc</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">_run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
                                <span class="c1"># ×× ×”×›×œ×™ ×œ× × ××¦×, × ×¡×” ××•×¢××“ ×”×‘×</span>
                                <span class="k">if</span> <span class="n">rc</span> <span class="o">==</span> <span class="mi">127</span><span class="p">:</span>
                                    <span class="k">continue</span>
                                <span class="k">return</span> <span class="n">rc</span><span class="p">,</span> <span class="n">out</span>
                            <span class="k">return</span> <span class="mi">127</span><span class="p">,</span> <span class="s2">&quot;Tool not installed&quot;</span>
                        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;flake8&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_run_any</span><span class="p">(</span><span class="s2">&quot;flake8&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;.&quot;</span><span class="p">])</span>
                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;mypy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_run_any</span><span class="p">(</span><span class="s2">&quot;mypy&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;.&quot;</span><span class="p">])</span>
                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;bandit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_run_any</span><span class="p">(</span><span class="s2">&quot;bandit&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="s2">&quot;-r&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">])</span> 
                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;black&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_run_any</span><span class="p">(</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;--check&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">])</span> 
                        <span class="k">return</span> <span class="n">results</span><span class="p">,</span> <span class="n">repo_full</span>

                <span class="c1"># ×”×¨×™×¥ ×‘×¨×§×¢ ×›×“×™ ×œ× ×œ×—×¡×•× ××ª ×œ×•×œ××ª ×”××™×¨×•×¢×™×</span>
                <span class="n">results</span><span class="p">,</span> <span class="n">repo_name_for_msg</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">to_thread</span><span class="p">(</span><span class="n">do_validate</span><span class="p">)</span>
                <span class="n">done_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">progress_task</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">progress_task</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>

                <span class="c1"># ×¤×•×¨××˜ ×ª×•×¦××•×ª ××¢×•×¦×‘</span>
                <span class="k">def</span><span class="w"> </span><span class="nf">status_label</span><span class="p">(</span><span class="n">rc</span><span class="p">):</span>
                    <span class="k">return</span> <span class="s2">&quot;OK&quot;</span> <span class="k">if</span> <span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;MISSING&quot;</span> <span class="k">if</span> <span class="n">rc</span> <span class="o">==</span> <span class="mi">127</span> <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;TIMEOUT&quot;</span> <span class="k">if</span> <span class="n">rc</span> <span class="o">==</span> <span class="mi">124</span> <span class="k">else</span> <span class="s2">&quot;FAIL&quot;</span><span class="p">))</span>

                <span class="k">def</span><span class="w"> </span><span class="nf">status_emoji</span><span class="p">(</span><span class="n">rc</span><span class="p">):</span>
                    <span class="k">return</span> <span class="s2">&quot;âœ…&quot;</span> <span class="k">if</span> <span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;â›”&quot;</span> <span class="k">if</span> <span class="n">rc</span> <span class="o">==</span> <span class="mi">127</span> <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;â±ï¸&quot;</span> <span class="k">if</span> <span class="n">rc</span> <span class="o">==</span> <span class="mi">124</span> <span class="k">else</span> <span class="s2">&quot;âŒ&quot;</span><span class="p">))</span>

                <span class="c1"># ×ª×¨×’×•× ×¡×˜×˜×•×¡×™× ×œ×¢×‘×¨×™×ª ×œ×”×¦×’×”</span>
                <span class="n">he_label</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;OK&quot;</span><span class="p">:</span> <span class="s2">&quot;×ª×§×™×Ÿ&quot;</span><span class="p">,</span> <span class="s2">&quot;FAIL&quot;</span><span class="p">:</span> <span class="s2">&quot;× ×›×©×œ&quot;</span><span class="p">,</span> <span class="s2">&quot;TIMEOUT&quot;</span><span class="p">:</span> <span class="s2">&quot;×¤×’ ×–××Ÿ&quot;</span><span class="p">,</span> <span class="s2">&quot;MISSING&quot;</span><span class="p">:</span> <span class="s2">&quot;×œ× ××•×ª×§×Ÿ&quot;</span><span class="p">}</span>

                <span class="n">counts</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;OK&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;FAIL&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;TIMEOUT&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;MISSING&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
                <span class="n">max_tool_len</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">tool</span><span class="p">,</span> <span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="n">status_label</span><span class="p">(</span><span class="n">rc</span><span class="p">)</span>
                    <span class="n">counts</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">first_line</span> <span class="o">=</span> <span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="ow">or</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">][:</span><span class="mi">120</span><span class="p">]</span>
                    <span class="n">suffix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; â€” </span><span class="si">{</span><span class="n">escape</span><span class="p">(</span><span class="n">first_line</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">label</span> <span class="o">!=</span> <span class="s2">&quot;OK&quot;</span> <span class="ow">and</span> <span class="n">first_line</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                    <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tool</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">max_tool_len</span><span class="p">)</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">status_emoji</span><span class="p">(</span><span class="n">rc</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">he_label</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span><span class="w"> </span><span class="n">label</span><span class="p">)</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="n">header</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ğŸ§ª ×‘×“×™×§×•×ª ××ª×§×“××•×ª ×œ×¨×™×¤×• &lt;code&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">repo_name_for_msg</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">summary</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;×¡×™×›×•×: âœ… </span><span class="si">{</span><span class="n">counts</span><span class="p">[</span><span class="s1">&#39;OK&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">  âŒ </span><span class="si">{</span><span class="n">counts</span><span class="p">[</span><span class="s1">&#39;FAIL&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">  â±ï¸ </span><span class="si">{</span><span class="n">counts</span><span class="p">[</span><span class="s1">&#39;TIMEOUT&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">  â›” </span><span class="si">{</span><span class="n">counts</span><span class="p">[</span><span class="s1">&#39;MISSING&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">body</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>

                <span class="c1"># ×™×¦×™×¨×ª ×”×¦×¢×•×ª ×××•×§×“×•×ª</span>
                <span class="n">suggestions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="c1"># flake8 â€“ ×”×¦×¢×” ×œ×”×¡×¨×ª ×™×™×‘×•× ×©×œ× ×‘×©×™××•×©</span>
                <span class="n">rc_flake8</span><span class="p">,</span> <span class="n">out_flake8</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;flake8&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">rc_flake8</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">out_flake8</span><span class="p">:</span>
                    <span class="kn">import</span><span class="w"> </span><span class="nn">re</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_re</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">_re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(?P&lt;file&gt;[^:\n]+):(?P&lt;line&gt;\d+):\d+:\s*F401\s+&#39;([^&#39;]+)&#39;\s+imported but unused&quot;</span><span class="p">,</span> <span class="n">out_flake8</span><span class="p">,</span> <span class="n">_re</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                        <span class="n">file_p</span> <span class="o">=</span> <span class="n">safe_html_escape</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;file&quot;</span><span class="p">))</span>
                        <span class="n">line_p</span> <span class="o">=</span> <span class="n">safe_html_escape</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;line&quot;</span><span class="p">))</span>
                        <span class="c1"># ×œ× ×ª××™×“ ××¤×©×¨ ×œ×©×œ×•×£ ××ª ×”×©× ×‘×‘×˜×—×” ×‘×˜×œ×’×¨× â€“ ××©××™×¨×™× ×›×œ×œ×™</span>
                        <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;b&gt;flake8&lt;/b&gt;: ×”×¡×¨ ×™×™×‘×•× ×©×œ× ×‘×©×™××•×© ×‘×©×•×¨×” </span><span class="si">{</span><span class="n">line_p</span><span class="si">}</span><span class="s2"> ×‘×§×•×‘×¥ &lt;code&gt;</span><span class="si">{</span><span class="n">file_p</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span><span class="p">)</span>

                <span class="c1"># mypy â€“ ×”×¦×¢×” ×œ-Optional ×›××©×¨ ×‘×¨×™×¨×ª ××—×“×œ None ×œ×¡×•×’ ×œ×-Optional</span>
                <span class="n">rc_mypy</span><span class="p">,</span> <span class="n">out_mypy</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mypy&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">rc_mypy</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">out_mypy</span><span class="p">:</span>
                    <span class="kn">import</span><span class="w"> </span><span class="nn">re</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_re</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">_re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Incompatible default for argument </span><span class="se">\&quot;</span><span class="s2">(?P&lt;arg&gt;[^</span><span class="se">\&quot;</span><span class="s2">]+)</span><span class="se">\&quot;</span><span class="s2"> \(default has type </span><span class="se">\&quot;</span><span class="s2">None</span><span class="se">\&quot;</span><span class="s2">, argument has type </span><span class="se">\&quot;</span><span class="s2">(?P&lt;typ&gt;[^</span><span class="se">\&quot;</span><span class="s2">]+)</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">out_mypy</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                        <span class="n">arg_p</span> <span class="o">=</span> <span class="n">safe_html_escape</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;arg&quot;</span><span class="p">))</span>
                        <span class="n">typ_p</span> <span class="o">=</span> <span class="n">safe_html_escape</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;typ&quot;</span><span class="p">))</span>
                        <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;b&gt;mypy&lt;/b&gt;: ×”×’×“×¨ Optional[</span><span class="si">{</span><span class="n">typ_p</span><span class="si">}</span><span class="s2">] ×œ×¤×¨××˜×¨ &lt;code&gt;</span><span class="si">{</span><span class="n">arg_p</span><span class="si">}</span><span class="s2">&lt;/code&gt; ××• ×©× ×” ××ª ×‘×¨×™×¨×ª ×”××—×“×œ ×-None&quot;</span><span class="p">)</span>

                <span class="c1"># black â€“ ×”×¦×¢×” ×œ×”×¨×™×¥ black ×¢×œ ×§×‘×¦×™× ×¡×¤×¦×™×¤×™×™×</span>
                <span class="n">rc_black</span><span class="p">,</span> <span class="n">out_black</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">rc_black</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">out_black</span><span class="p">:</span>
                    <span class="kn">import</span><span class="w"> </span><span class="nn">re</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_re</span>
                    <span class="n">files</span> <span class="o">=</span> <span class="n">_re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;would reformat\s+(.+)&quot;</span><span class="p">,</span> <span class="n">out_black</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">files</span><span class="p">:</span>
                        <span class="n">raw_path</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="c1"># × ×¡×” ×œ×§×¦×¨ ××¡×œ×•×œ ×–×× ×™ ×©×œ zip ×œ× ×ª×™×‘ ×™×—×¡×™ ×‘×ª×•×š ×”×¨×™×¤×•</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">_m</span> <span class="o">=</span> <span class="n">_re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;.*/repo/[^/]+/(.+)$&quot;</span><span class="p">,</span> <span class="n">raw_path</span><span class="p">)</span>
                            <span class="n">short_path</span> <span class="o">=</span> <span class="n">_m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">_m</span> <span class="k">else</span> <span class="n">raw_path</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="n">short_path</span> <span class="o">=</span> <span class="n">raw_path</span>
                        <span class="n">file1</span> <span class="o">=</span> <span class="n">safe_html_escape</span><span class="p">(</span><span class="n">short_path</span><span class="p">)</span>
                        <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;b&gt;black&lt;/b&gt;: ×”×¨×¥ black ×¢×œ &lt;code&gt;</span><span class="si">{</span><span class="n">file1</span><span class="si">}</span><span class="s2">&lt;/code&gt; ××• ×¢×œ ×”×¤×¨×•×™×§×˜ ×›×•×œ×• ×œ×™×™×©×•×¨ ×¤×•×¨××˜&quot;</span><span class="p">)</span>

                <span class="c1"># bandit â€“ ×”×¦×¢×•×ª ×›×œ×œ×™×•×ª ×‘×”×ª×× ×œ×“×¤×•×¡×™× × ×¤×•×¦×™×</span>
                <span class="n">rc_bandit</span><span class="p">,</span> <span class="n">out_bandit</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bandit&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">rc_bandit</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">out_bandit</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;eval(&quot;</span> <span class="ow">in</span> <span class="n">out_bandit</span> <span class="ow">or</span> <span class="s2">&quot;B307&quot;</span> <span class="ow">in</span> <span class="n">out_bandit</span><span class="p">:</span>
                        <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&lt;b&gt;bandit&lt;/b&gt;: ×”×—×œ×£ ×©×™××•×© ×‘-eval ×‘×¤×ª×¨×•×Ÿ ×‘×˜×•×— ×™×•×ª×¨ (×œ××©×œ ast.literal_eval)&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="s2">&quot;exec(&quot;</span> <span class="ow">in</span> <span class="n">out_bandit</span> <span class="ow">or</span> <span class="s2">&quot;B102&quot;</span> <span class="ow">in</span> <span class="n">out_bandit</span><span class="p">:</span>
                        <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&lt;b&gt;bandit&lt;/b&gt;: ×”×™×× ×¢ ×-exec ×•×”×©×ª××© ×‘××œ×˜×¨× ×˜×™×‘×•×ª ×‘×˜×•×—×•×ª&quot;</span><span class="p">)</span>

                <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">header</span><span class="si">}{</span><span class="n">summary</span><span class="si">}</span><span class="se">\n</span><span class="s2">&lt;pre&gt;</span><span class="si">{</span><span class="n">body</span><span class="si">}</span><span class="s2">&lt;/pre&gt;&quot;</span>
                <span class="k">if</span> <span class="n">suggestions</span><span class="p">:</span>
                    <span class="c1"># ×©×™××•×¨ ×ª×’×™×•×ª HTML ×‘×ª×•×š ×”×”×¦×¢×•×ª ×ª×•×š ×‘×¨×™×—×” ×©×œ ×ª×•×›×Ÿ ×“×™× ××™ × ×¢×©×” ×›×‘×¨ ×‘×©×œ×‘ ×‘× ×™×™×ª ×”×”×¦×¢×•×ª</span>
                    <span class="n">sug_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;â€¢ </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">suggestions</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
                    <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">ğŸ’¡ ×”×¦×¢×•×ª ×××•×§×“×•×ª:</span><span class="se">\n</span><span class="si">{</span><span class="n">sug_text</span><span class="si">}</span><span class="s2">&quot;</span>

                <span class="c1"># ×”×•×¡×£ ×›×¤×ª×•×¨ ×—×–×¨×” ×œ×ª×¤×¨×™×˜ GitHub</span>
                <span class="n">kb</span> <span class="o">=</span> <span class="p">[[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×¨×” ×œ×ª×¤×¨×™×˜ GitHub&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)]]</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># ×•×“× ×¡×’×™×¨×ª ×¢×“×›×•×Ÿ ×”×ª×§×“××•×ª ×’× ×‘×©×’×™××”</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">done_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">progress_task</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">await</span> <span class="n">progress_task</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Repo validation failed&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×‘×“×™×§×ª ×”×¨×™×¤×•: </span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.show_repo_selection">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_repo_selection">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">show_repo_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Show repository selection menu&quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_repos</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.show_repos">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_repos">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">show_repos</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">page</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;××¦×™×’ ×¨×©×™××ª ×¨×™×¤×•×–×™×˜×•×¨×™×– ×¢× pagination&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>

        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_sessions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="p">{})</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;âŒ × × ×œ×”×’×“×™×¨ ×˜×•×§×Ÿ ×§×•×“×&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âŒ × × ×œ×”×’×“×™×¨ ×˜×•×§×Ÿ ×§×•×“×&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># ×cknowledge ××”×™×¨ ×œ-Callback ×›×“×™ ×œ×× ×•×¢ &quot;×ª×§×™×¢×”&quot; ×©×œ ×”×›×¤×ª×•×¨ ×‘×˜×œ×’×¨×</span>
            <span class="n">acked</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>
                    <span class="n">acked</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="c1"># ×× ×›×‘×¨ × ×¢× ×” ×§×•×“×, × ××©×™×š ×‘×œ×™ ×œ×–×¨×•×§</span>
                    <span class="n">acked</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># ×‘×“×•×§ ×× ×™×© repos ×‘-context.user_data ×•×× ×”× ×¢×“×™×™×Ÿ ×ª×§×¤×™×</span>
            <span class="n">cache_time</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;repos_cache_time&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">cache_age</span> <span class="o">=</span> <span class="n">current_time</span> <span class="o">-</span> <span class="n">cache_time</span>
            <span class="n">cache_max_age</span> <span class="o">=</span> <span class="mi">3600</span>  <span class="c1"># ×©×¢×” ××—×ª</span>

            <span class="n">needs_refresh</span> <span class="o">=</span> <span class="s2">&quot;repos&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span> <span class="ow">or</span> <span class="n">cache_age</span> <span class="o">&gt;</span> <span class="n">cache_max_age</span>

            <span class="k">if</span> <span class="n">needs_refresh</span><span class="p">:</span>
                <span class="c1"># ×”×¦×’ ×”×•×“×¢×ª ×˜×¢×™× ×” ××™×™×“×™×ª ×œ×¤× ×™ ×§×¨×™××” ××™×˜×™×ª ×œâ€‘GitHub</span>
                <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;â³ ×˜×•×¢×Ÿ ×¨×©×™××ª ×¨×™×¤×•×–×™×˜×•×¨×™×–â€¦&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[GitHub API] Fetching repos for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> (cache age: </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">cache_age</span><span class="p">)</span><span class="si">}</span><span class="s2">s)&quot;</span>
                <span class="p">)</span>

                <span class="c1"># ×× ××™×Ÿ cache ××• ×©×”×•× ×™×©×Ÿ, ×‘×¦×¢ ×‘×§×©×” ×œ-API</span>

                <span class="n">_tok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">login_or_token</span><span class="o">=</span><span class="p">(</span><span class="n">_tok</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>

                <span class="c1"># ×‘×“×•×§ rate limit ×œ×¤× ×™ ×”×‘×§×©×”</span>
                <span class="n">rate</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_rate_limit</span><span class="p">()</span>
                <span class="c1"># ×ª××™×›×” ×‘××‘× ×™ RateLimit ×©×•× ×™× (×™×©×Ÿ/×—×“×©)</span>
                <span class="n">core_limit</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="s2">&quot;core&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">core_limit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">resources</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="s2">&quot;resources&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">resources</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">core_limit</span> <span class="o">=</span> <span class="n">resources</span><span class="p">[</span><span class="s2">&quot;core&quot;</span><span class="p">]</span>  <span class="c1"># type: ignore[index]</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">core_limit</span> <span class="o">=</span> <span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;core&quot;</span><span class="p">)</span>  <span class="c1"># type: ignore[attr-defined]</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="n">core_limit</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">if</span> <span class="n">core_limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">core_limit</span><span class="p">,</span> <span class="s2">&quot;remaining&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;[GitHub API] Rate limit - Remaining: </span><span class="si">{</span><span class="n">core_limit</span><span class="o">.</span><span class="n">remaining</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="n">core_limit</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;limit&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[GitHub API] Rate limit - Remaining: unknown&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">core_limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">core_limit</span><span class="p">,</span> <span class="s2">&quot;remaining&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">core_limit</span><span class="o">.</span><span class="n">remaining</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;[GitHub API] Low on API calls! Only </span><span class="si">{</span><span class="n">core_limit</span><span class="o">.</span><span class="n">remaining</span><span class="si">}</span><span class="s2"> remaining&quot;</span>
                    <span class="p">)</span>

                <span class="k">if</span> <span class="n">core_limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">core_limit</span><span class="p">,</span> <span class="s2">&quot;remaining&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">core_limit</span><span class="o">.</span><span class="n">remaining</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="c1"># ×× ×™×© cache ×™×©×Ÿ, ×”×©×ª××© ×‘×• ×‘××§×•× ×œ×—×¡×•×</span>
                    <span class="k">if</span> <span class="s2">&quot;repos&quot;</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[GitHub API] Using stale cache due to rate limit&quot;</span><span class="p">)</span>
                        <span class="n">all_repos</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;repos&quot;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;â³ ××’×‘×œ×ª API × ××•×›×”! × ×•×ª×¨×• ×¨×§ </span><span class="si">{</span><span class="n">core_limit</span><span class="o">.</span><span class="n">remaining</span><span class="si">}</span><span class="s2"> ×‘×§×©×•×ª&quot;</span>
                            <span class="p">)</span>
                            <span class="c1"># ×œ××—×¨ ack ××¡×•×¨ ×œ×§×¨×•× ×©×•×‘ ×œ-answer; × ×¢×¨×•×š ××ª ×”×”×•×“×¢×” ×‘××§×•×</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">acked</span><span class="p">:</span>
                                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="k">pass</span>
                            <span class="k">return</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># ×”×•×¡×£ delay ×‘×™×Ÿ ×‘×§×©×•×ª</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_rate_limit_delay</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

                    <span class="n">user</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_user</span><span class="p">()</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[GitHub API] Getting repos for user: </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">login</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="c1"># ×§×‘×œ ××ª ×›×œ ×”×¨×™×¤×•×–×™×˜×•×¨×™×– - ×˜×¢×Ÿ ×¨×§ ×¤×¢× ××—×ª!</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;repos&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">get_repos</span><span class="p">())</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;repos_cache_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_time</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;[GitHub API] Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;repos&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> repos into cache&quot;</span>
                    <span class="p">)</span>
                    <span class="n">all_repos</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;repos&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[Cache] Using cached repos for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;repos&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[]))</span><span class="si">}</span><span class="s2"> repos (age: </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">cache_age</span><span class="p">)</span><span class="si">}</span><span class="s2">s)&quot;</span>
                <span class="p">)</span>
                <span class="n">all_repos</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;repos&quot;</span><span class="p">]</span>

            <span class="c1"># ×”×’×“×¨×•×ª pagination</span>
            <span class="n">repos_per_page</span> <span class="o">=</span> <span class="mi">8</span>
            <span class="n">total_repos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_repos</span><span class="p">)</span>
            <span class="n">total_pages</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_repos</span> <span class="o">+</span> <span class="n">repos_per_page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">repos_per_page</span>

            <span class="c1"># ×—×©×‘ ××™× ×“×§×¡×™×</span>
            <span class="n">start_idx</span> <span class="o">=</span> <span class="n">page</span> <span class="o">*</span> <span class="n">repos_per_page</span>
            <span class="n">end_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start_idx</span> <span class="o">+</span> <span class="n">repos_per_page</span><span class="p">,</span> <span class="n">total_repos</span><span class="p">)</span>

            <span class="c1"># ×¨×™×¤×•×–×™×˜×•×¨×™×– ×œ×¢××•×“ ×”× ×•×›×—×™</span>
            <span class="n">page_repos</span> <span class="o">=</span> <span class="n">all_repos</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span>

            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># ×”×•×¡×£ ×¨×™×¤×•×–×™×˜×•×¨×™×–</span>
            <span class="k">for</span> <span class="n">repo</span> <span class="ow">in</span> <span class="n">page_repos</span><span class="p">:</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;ğŸ“ </span><span class="si">{</span><span class="n">repo</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;repo_</span><span class="si">{</span><span class="n">repo</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                    <span class="p">]</span>
                <span class="p">)</span>

            <span class="c1"># ×›×¤×ª×•×¨×™ × ×™×•×•×˜</span>
            <span class="n">nav_buttons</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">page</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">nav_buttons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;â¬…ï¸ ×”×§×•×“×&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;repos_page_</span><span class="si">{</span><span class="n">page</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="n">nav_buttons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ğŸ“„ </span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total_pages</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;noop&quot;</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">page</span> <span class="o">&lt;</span> <span class="n">total_pages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">nav_buttons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;â¡ï¸ ×”×‘×&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;repos_page_</span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">nav_buttons</span><span class="p">:</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nav_buttons</span><span class="p">)</span>

            <span class="c1"># ×›×¤×ª×•×¨×™× × ×•×¡×¤×™×</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;âœï¸ ×”×§×œ×“ ×©× ×¨×™×¤×• ×™×“× ×™×ª&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;repo_manual&quot;</span><span class="p">)]</span>
            <span class="p">)</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;back_to_menu&quot;</span><span class="p">)])</span>

            <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;×‘×—×¨ ×¨×™×¤×•×–×™×˜×•×¨×™ (×¢××•×“ </span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> ××ª×•×š </span><span class="si">{</span><span class="n">total_pages</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;×‘×—×¨ ×¨×™×¤×•×–×™×˜×•×¨×™ (×¢××•×“ </span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> ××ª×•×š </span><span class="si">{</span><span class="n">total_pages</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;×‘×—×¨ ×¨×™×¤×•×–×™×˜×•×¨×™ (×¢××•×“ </span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> ××ª×•×š </span><span class="si">{</span><span class="n">total_pages</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">,</span>
                        <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span><span class="p">,</span>
                    <span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

            <span class="c1"># ×‘×“×•×§ ×× ×–×• ×©×’×™××ª rate limit</span>
            <span class="k">if</span> <span class="s2">&quot;rate limit&quot;</span> <span class="ow">in</span> <span class="n">error_msg</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;403&quot;</span> <span class="ow">in</span> <span class="n">error_msg</span><span class="p">:</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;â³ ×—×¨×™×’×” ×××’×‘×œ×ª GitHub API</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="s2">&quot;× ×¡×” ×©×•×‘ ×‘×¢×•×“ ×›××” ×“×§×•×ª&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××”: </span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;acked&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="ow">and</span> <span class="n">acked</span><span class="p">:</span>
                        <span class="c1"># ×œ××—×¨ ack â€“ ××™×Ÿ answer × ×•×¡×£; × ×¢×¨×•×š ×˜×§×¡×˜ ×‘××§×•×</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span></div>

 

<div class="viewcode-block" id="GitHubMenuHandler.show_upload_other_files">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_upload_other_files">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">show_upload_other_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;××¦×™×’ ×¨×§ ×§×‘×¦×™× ×©××™× × ××ª×•×™×’×™× repo: ×•××™× × ×§×‘×¦×™× ×’×“×•×œ×™×, ×¢× ×¢×™××•×“ ×•××™××•×’&#39;×™ ×œ×¤×™ ×©×¤×”.&quot;&quot;&quot;</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">database</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># ×§×¨×™××ª × ×ª×•× ×™×</span>
            <span class="n">all_files</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user_files</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;file_name&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
            <span class="n">large_files</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user_large_files</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">per_page</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
            <span class="n">large_names</span> <span class="o">=</span> <span class="p">{</span><span class="n">lf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">lf</span> <span class="ow">in</span> <span class="n">large_files</span> <span class="k">if</span> <span class="n">lf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">)}</span>

            <span class="n">other_files</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">all_files</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">)</span>
                <span class="n">tags</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">large_names</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">t</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;repo:&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">):</span>
                    <span class="n">other_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">other_files</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;â„¹ï¸ ××™×Ÿ &#39;×©××¨ ×§×‘×¦×™×&#39; ×œ×”×¦×’×” (×œ× ××ª×•×™×’×™× ×›×¨×™×¤×• ×•××™× × ×’×“×•×œ×™×)&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="c1"># ××¦×‘ ×¢××•×“ ×•×‘×—×™×¨×”</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;other_files_page&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">page</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">per_page</span> <span class="o">=</span> <span class="mi">20</span>
            <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">other_files</span><span class="p">)</span>
            <span class="n">pages</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">total</span> <span class="o">+</span> <span class="n">per_page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">per_page</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">page</span> <span class="o">&gt;</span> <span class="n">pages</span><span class="p">:</span>
                <span class="n">page</span> <span class="o">=</span> <span class="n">pages</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;other_files_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span>
            <span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">per_page</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">per_page</span>
            <span class="n">page_items</span> <span class="o">=</span> <span class="n">other_files</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>

            <span class="c1"># ×‘× ×™×™×ª ××§×œ×“×ª ×œ×‘×—×™×¨×ª ×§×•×‘×¥ ×™×—×™×“ ×œ×”×¢×œ××”</span>
            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_language_emoji</span><span class="p">,</span> <span class="n">detect_language_from_filename</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">page_items</span><span class="p">:</span>
                <span class="n">fid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">))</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span> <span class="s1">&#39;×œ×œ× ×©×&#39;</span><span class="p">)</span>
                <span class="n">lang</span> <span class="o">=</span> <span class="n">detect_language_from_filename</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">emoji</span> <span class="o">=</span> <span class="n">get_language_emoji</span><span class="p">(</span><span class="n">lang</span><span class="p">)</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">emoji</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;upload_saved_</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>

            <span class="c1"># × ×™×•×•×˜ ×¢××•×“×™×</span>
            <span class="n">nav</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">page</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;â¬…ï¸ ×”×§×•×“×&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;other_files_page_</span><span class="si">{</span><span class="n">page</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">page</span> <span class="o">&lt;</span> <span class="n">pages</span><span class="p">:</span>
                <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;â¡ï¸ ×”×‘×&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;other_files_page_</span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">nav</span><span class="p">:</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nav</span><span class="p">)</span>

            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;upload_file&quot;</span><span class="p">)])</span>

            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;×‘×—×¨/×™ ×§×•×‘×¥ ×œ×”×¢×œ××” (×©××¨ ×”×§×‘×¦×™×) â€” ×¢××•×“ </span><span class="si">{</span><span class="n">page</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">pages</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª &#39;×©××¨ ×”×§×‘×¦×™×&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.show_upload_repos">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_upload_repos">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">show_upload_repos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;××¦×™×’ ×ª×¤×¨×™×˜ ×¨×™×¤×•××™× ×œ×‘×—×™×¨×ª ×§×‘×¦×™× ×©××•×¨×™× ×¢× ×ª×’×™×ª repo: ×œ×”×¢×œ××”&quot;&quot;&quot;</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">database</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># ×¦×¨×™×š ×’× tags ×›×“×™ ×œ×¡×¤×•×¨ ×œ×¤×™ repo:</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user_files</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;file_name&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
            <span class="n">repo_to_count</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">t</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;repo:&#39;</span><span class="p">):</span>
                        <span class="n">repo_to_count</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">repo_to_count</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">repo_to_count</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;â„¹ï¸ ××™×Ÿ ×§×‘×¦×™× ×¢× ×ª×’×™×ª ×¨×™×¤×• (repo:owner/name)&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">cnt</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">repo_to_count</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])[:</span><span class="mi">50</span><span class="p">]:</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">cnt</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;gh_upload_repo:</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;upload_file&quot;</span><span class="p">)])</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;×‘×—×¨/×™ ×¨×™×¤×• (××ª×•×š ×ª×’×™×•×ª ×”×§×‘×¦×™× ×”×©××•×¨×™×):&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×¨×©×™××ª ×¨×™×¤×•××™×: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="GitHubMenuHandler.show_upload_repo_files">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_upload_repo_files">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">show_upload_repo_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span><span class="n">_repo_tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;××¦×™×’ ×§×‘×¦×™× ×©××•×¨×™× ×ª×—×ª ×ª×’×™×ª ×¨×™×¤×• ×©× ×‘×—×¨×” ×•×××¤×©×¨ ×œ×”×¢×œ×•×ª× ×¢× ×¢×™××•×“&quot;&quot;&quot;</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">database</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">repo_tag</span> <span class="o">=</span> <span class="n">_repo_tag</span>
            <span class="c1"># ×¢×™××•×“: ×§×¨× ××”-context ××• ×”×ª×—×œ ×‘×¢××•×“ 1</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;repo_files_page&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">repo_tag</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">page</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">per_page</span> <span class="o">=</span> <span class="mi">50</span>
            <span class="n">files</span><span class="p">,</span> <span class="n">total</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user_files_by_repo</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">repo_tag</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="n">page</span><span class="p">,</span> <span class="n">per_page</span><span class="o">=</span><span class="n">per_page</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;â„¹ï¸ ××™×Ÿ ×§×‘×¦×™× ×ª×—×ª ×”×ª×’×™×ª ×”×–×•&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">pages</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">total</span> <span class="o">+</span> <span class="n">per_page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">per_page</span><span class="p">)</span>
            <span class="c1"># ×‘× ×™×™×ª ×›×¤×ª×•×¨×™×</span>
            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="n">fid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">))</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span> <span class="s1">&#39;×œ×œ× ×©×&#39;</span><span class="p">)</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ğŸ“„ </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;upload_saved_</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
            <span class="n">nav</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">page</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;â¬…ï¸ ×”×§×•×“×&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;repo_files_page:</span><span class="si">{</span><span class="n">repo_tag</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">page</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">page</span> <span class="o">&lt;</span> <span class="n">pages</span><span class="p">:</span>
                <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;â¡ï¸ ×”×‘×&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;repo_files_page:</span><span class="si">{</span><span class="n">repo_tag</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">nav</span><span class="p">:</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nav</span><span class="p">)</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;gh_upload_cat:repos&quot;</span><span class="p">)])</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;×‘×—×¨/×™ ×§×•×‘×¥ ×œ×”×¢×œ××” ××”×ª×’×™×ª </span><span class="si">{</span><span class="n">repo_tag</span><span class="si">}</span><span class="s2"> (×¢××•×“ </span><span class="si">{</span><span class="n">page</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">pages</span><span class="si">}</span><span class="s2">, ×¡×š ×”×›×œ </span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×§×‘×¦×™×: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.upload_large_files_menu">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.upload_large_files_menu">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">upload_large_files_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;××¦×™×’ ×¨×©×™××ª ×§×‘×¦×™× ×’×“×•×œ×™× ×œ×”×¢×œ××” ×œ×¨×™×¤×• ×”× ×‘×—×¨&quot;&quot;&quot;</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">database</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">large_files</span><span class="p">,</span> <span class="n">total</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user_large_files</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">per_page</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">large_files</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;â„¹ï¸ ××™×Ÿ ×§×‘×¦×™× ×’×“×•×œ×™× ×©××•×¨×™×&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">lf</span> <span class="ow">in</span> <span class="n">large_files</span><span class="p">:</span>
                <span class="n">fid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">lf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">))</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">lf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span> <span class="s1">&#39;×œ×œ× ×©×&#39;</span><span class="p">)</span>
                <span class="n">size_kb</span> <span class="o">=</span> <span class="p">(</span><span class="n">lf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_size&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1024</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ğŸ“„ </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">size_kb</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">KB)&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;gh_upload_large:</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;upload_file&quot;</span><span class="p">)])</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;×‘×—×¨/×™ ×§×•×‘×¥ ×’×“×•×œ ×œ×”×¢×œ××”:&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×§×‘×¦×™× ×’×“×•×œ×™×: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.handle_large_file_upload">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.handle_large_file_upload">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_large_file_upload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">file_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;××¢×œ×” ×§×•×‘×¥ ×’×“×•×œ ×©× ×‘×—×¨ ×œ×’×™×˜×”××‘ (×¢× ××•×ª×Ÿ ×‘×“×™×§×•×ª ×›××• ×§×•×‘×¥ ×©××•×¨ ×¨×’×™×œ)&quot;&quot;&quot;</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">token</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×§×•×“× ×‘×—×¨ ×¨×™×¤×•/×˜×•×§×Ÿ ×‘×’×™×˜×”××‘&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># ×©×œ×•×£ ××ª ×ª×•×›×Ÿ ×”×§×•×‘×¥ ×”×’×“×•×œ</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">database</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">bson</span><span class="w"> </span><span class="kn">import</span> <span class="n">ObjectId</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">large_files_collection</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="n">file_id</span><span class="p">),</span> <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">doc</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×§×•×‘×¥ ×’×“×•×œ ×œ× × ××¦×&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># ×××—×“×™× ×¢× ×–×¨×™××ª show_pre_upload_check: × ×©×ª××© ×‘-pending_saved_file_id ××—×¨×™ ×™×¦×™×¨×ª ××¡××š ×–×× ×™</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># ×¦×•×¨ ××¡××š ×–×× ×™ ×‘×§×•×œ×§×©×Ÿ ×”×¨×’×™×œ ×›×“×™ ×œ××—×–×¨ ××ª ××¡×š ×”×‘×“×™×§×•×ª</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
                <span class="s2">&quot;file_name&quot;</span><span class="p">:</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file_name&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;large_file.txt&quot;</span><span class="p">,</span>
                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">insert_one</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;pending_saved_file_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">inserted_id</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_pre_upload_check</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×”×›× ×ª ×§×•×‘×¥ ×’×“×•×œ ×œ×”×¢×œ××”: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.handle_saved_file_upload">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.handle_saved_file_upload">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_saved_file_upload</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">file_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;××˜×¤×œ ×‘×”×¢×œ××ª ×§×•×‘×¥ ×©××•×¨ ×œ-GitHub&quot;&quot;&quot;</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;âŒ × × ×œ×‘×—×•×¨ ×¨×™×¤×• ×§×•×“×&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">bson</span><span class="w"> </span><span class="kn">import</span> <span class="n">ObjectId</span>

            <span class="kn">from</span><span class="w"> </span><span class="nn">database</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span>

            <span class="c1"># ×§×‘×œ ××ª ×”×§×•×‘×¥ ××”××¡×“</span>
            <span class="n">file_data</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="n">file_id</span><span class="p">),</span> <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">})</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">file_data</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;âŒ ×§×•×‘×¥ ×œ× × ××¦×&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;â³ ××¢×œ×” ×§×•×‘×¥ ×œ-GitHub...&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">emit_event</span><span class="p">(</span><span class="s2">&quot;github_upload_start&quot;</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">user_id</span><span class="p">),</span> <span class="n">file_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">file_id</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="c1"># ×œ×•×’ ×¤×¨×˜×™ ×”×§×•×‘×¥</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ğŸ“„ ××¢×œ×” ×§×•×‘×¥ ×©××•×¨: </span><span class="si">{</span><span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># ×§×‘×œ ××ª ×”×ª×•×›×Ÿ ××”×§×•×‘×¥ ×”×©××•×¨</span>
            <span class="c1"># ×‘×“×•×§ ×›××” ××¤×©×¨×•×™×•×ª ×œ×©×“×” content</span>
            <span class="n">content</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">)</span>
                <span class="ow">or</span> <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;code&quot;</span><span class="p">)</span>
                <span class="ow">or</span> <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>
                <span class="ow">or</span> <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file_content&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">content</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×ª×•×›×Ÿ ×”×§×•×‘×¥ ×¨×™×§ ××• ×œ× × ××¦×&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="c1"># PyGithub ××§×•×“×“ ××•×˜×•××˜×™×ª ×œ-base64, ××– ×¨×§ × ×•×•×“× ×©×”×ª×•×›×Ÿ ×”×•× string</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âœ… ×ª×•×›×Ÿ ××•×›×Ÿ ×œ×”×¢×œ××”, ×’×•×“×œ: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="si">}</span><span class="s2"> chars&quot;</span><span class="p">)</span>

            <span class="c1"># ×”×ª×—×‘×¨ ×œ-GitHub</span>

            <span class="n">token_opt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token_opt</span><span class="p">)</span> <span class="k">if</span> <span class="n">token_opt</span> <span class="k">else</span> <span class="n">Github</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">token_opt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token_opt</span><span class="p">)</span> <span class="k">if</span> <span class="n">token_opt</span> <span class="k">else</span> <span class="n">Github</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">token_opt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token_opt</span><span class="p">)</span> <span class="k">if</span> <span class="n">token_opt</span> <span class="k">else</span> <span class="n">Github</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

            <span class="c1"># ×‘×“×•×§ rate limit ×œ×¤× ×™ ×”×‘×§×©×”</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">emit_event</span><span class="p">(</span><span class="s2">&quot;github_rate_limit_check&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[GitHub API] Checking rate limit before uploading file&quot;</span><span class="p">)</span>
            <span class="n">rate</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_rate_limit</span><span class="p">()</span>
            <span class="n">core_limit</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="s2">&quot;core&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">core_limit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">resources</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="s2">&quot;resources&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">resources</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">core_limit</span> <span class="o">=</span> <span class="n">resources</span><span class="p">[</span><span class="s2">&quot;core&quot;</span><span class="p">]</span>  <span class="c1"># type: ignore[index]</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">core_limit</span> <span class="o">=</span> <span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;core&quot;</span><span class="p">)</span>  <span class="c1"># type: ignore[attr-defined]</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="n">core_limit</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">core_limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">core_limit</span><span class="p">,</span> <span class="s2">&quot;remaining&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[GitHub API] Rate limit - Remaining: </span><span class="si">{</span><span class="n">core_limit</span><span class="o">.</span><span class="n">remaining</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="n">core_limit</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;limit&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">core_limit</span><span class="o">.</span><span class="n">remaining</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;[GitHub API] Low on API calls! Only </span><span class="si">{</span><span class="n">core_limit</span><span class="o">.</span><span class="n">remaining</span><span class="si">}</span><span class="s2"> remaining&quot;</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="n">core_limit</span><span class="o">.</span><span class="n">remaining</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;â³ ××’×‘×œ×ª API × ××•×›×” ××“×™! × ×•×ª×¨×• ×¨×§ </span><span class="si">{</span><span class="n">core_limit</span><span class="o">.</span><span class="n">remaining</span><span class="si">}</span><span class="s2"> ×‘×§×©×•×ª&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>
                    <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[GitHub API] Rate limit - Remaining: unknown&quot;</span><span class="p">)</span>

            <span class="c1"># ×”×•×¡×£ delay ×‘×™×Ÿ ×‘×§×©×•×ª</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_rate_limit_delay</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[GitHub API] Getting repo: </span><span class="si">{</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;selected_repo&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">])</span>

            <span class="c1"># Resolve target branch and folder</span>
            <span class="n">branch</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;upload_target_branch&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">repo</span><span class="o">.</span><span class="n">default_branch</span> <span class="ow">or</span> <span class="s2">&quot;main&quot;</span>
            <span class="n">folder</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;upload_target_folder&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_folder&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">folder</span> <span class="ow">and</span> <span class="n">folder</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="n">folder</span> <span class="o">=</span> <span class="n">folder</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="n">file_data</span><span class="p">[</span><span class="s2">&quot;file_name&quot;</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ğŸ“ × ×ª×™×‘ ×™×¢×“: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2"> (branch: </span><span class="si">{</span><span class="n">branch</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

            <span class="c1"># × ×¡×” ×œ×”×¢×œ×•×ª ××• ×œ×¢×“×›×Ÿ ××ª ×”×§×•×‘×¥</span>
            <span class="c1"># ××“×™×“×ª ×‘×™×¦×•×¢×™× ×•×”×•×¡×¤×ª ××˜×-××™×“×¢ ×¢×œ ×”×¨×™×¤×•/×”×¢× ×£</span>
            <span class="k">with</span> <span class="n">track_performance</span><span class="p">(</span><span class="s2">&quot;github_upload_saved_file&quot;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;repo&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))}):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[GitHub API] Checking if file exists: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2"> @ </span><span class="si">{</span><span class="n">branch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">existing</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">branch</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[GitHub API] File exists, updating: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">update_file</span><span class="p">(</span>
                        <span class="n">path</span><span class="o">=</span><span class="n">file_path</span><span class="p">,</span>
                        <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Update </span><span class="si">{</span><span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> via Telegram bot&quot;</span><span class="p">,</span>
                        <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>  <span class="c1"># PyGithub ×™×§×•×“×“ ××•×˜×•××˜×™×ª</span>
                        <span class="n">sha</span><span class="o">=</span><span class="n">existing</span><span class="o">.</span><span class="n">sha</span><span class="p">,</span>
                        <span class="n">branch</span><span class="o">=</span><span class="n">branch</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">action</span> <span class="o">=</span> <span class="s2">&quot;×¢×•×“×›×Ÿ&quot;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âœ… ×§×•×‘×¥ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”&quot;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">emit_event</span><span class="p">(</span>
                            <span class="s2">&quot;github_upload_saved_success&quot;</span><span class="p">,</span>
                            <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span>
                            <span class="n">repo</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)),</span>
                            <span class="n">branch</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">branch</span><span class="p">),</span>
                            <span class="n">path</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">file_path</span><span class="p">),</span>
                            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;update&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[GitHub API] File doesn&#39;t exist, creating: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">create_file</span><span class="p">(</span>
                        <span class="n">path</span><span class="o">=</span><span class="n">file_path</span><span class="p">,</span>
                        <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Upload </span><span class="si">{</span><span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> via Telegram bot&quot;</span><span class="p">,</span>
                        <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>  <span class="c1"># PyGithub ×™×§×•×“×“ ××•×˜×•××˜×™×ª</span>
                        <span class="n">branch</span><span class="o">=</span><span class="n">branch</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">action</span> <span class="o">=</span> <span class="s2">&quot;×”×•×¢×œ×”&quot;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[GitHub API] File created successfully: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">emit_event</span><span class="p">(</span>
                            <span class="s2">&quot;github_upload_saved_success&quot;</span><span class="p">,</span>
                            <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span>
                            <span class="n">repo</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)),</span>
                            <span class="n">branch</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">branch</span><span class="p">),</span>
                            <span class="n">path</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">file_path</span><span class="p">),</span>
                            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;create&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>

            <span class="n">raw_url</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;https://raw.githubusercontent.com/</span><span class="si">{</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;selected_repo&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">branch</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;âœ… ×”×§×•×‘×¥ </span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2"> ×‘×”×¦×œ×—×”!</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ“ ×¨×™×¤×•: &lt;code&gt;</span><span class="si">{</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;selected_repo&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ“‚ ××™×§×•×: &lt;code&gt;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ”— ×§×™×©×•×¨ ×™×©×™×¨:</span><span class="se">\n</span><span class="si">{</span><span class="n">raw_url</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;×©×œ×— /github ×›×“×™ ×œ×—×–×•×¨ ×œ×ª×¤×¨×™×˜.&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×”×¢×œ××ª ×§×•×‘×¥ ×©××•×¨: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">emit_event</span><span class="p">(</span><span class="s2">&quot;github_upload_saved_error&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">errors_total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">errors_total</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="s2">&quot;github_upload_saved_error&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="n">error_msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;rate limit&quot;</span> <span class="ow">in</span> <span class="n">error_msg</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;403&quot;</span> <span class="ow">in</span> <span class="n">error_msg</span><span class="p">:</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;â³ ×—×¨×™×’×” ×××’×‘×œ×ª GitHub API</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;× ×¡×” ×©×•×‘ ×‘×¢×•×“ ×›××” ×“×§×•×ª</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;ğŸ’¡ ×˜×™×¤: ×”××ª×Ÿ ××¡×¤×¨ ×“×§×•×ª ×œ×¤× ×™ × ×™×¡×™×•×Ÿ × ×•×¡×£&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×”×¢×œ××”:</span><span class="se">\n</span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">×¤×¨×˜×™× × ×•×¡×¤×™× × ×©××¨×• ×‘×œ×•×’.&quot;</span>

            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.handle_file_upload">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.handle_file_upload">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_file_upload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle file upload&quot;&quot;&quot;</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

        <span class="c1"># ×‘×“×•×§ ×× ×× ×—× ×• ×‘××¦×‘ ×”×¢×œ××” ×œ×’×™×˜×”××‘ (×ª××™×›×” ×‘×©× ×™ ×”××©×ª× ×™×)</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;waiting_for_upload_folder&quot;</span><span class="p">):</span>
            <span class="c1"># Capture folder path from user text and return to pre-upload check</span>
            <span class="n">folder_text</span> <span class="o">=</span> <span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">text</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="c1"># normalize: remove leading/trailing slashes</span>
            <span class="n">folder_norm</span> <span class="o">=</span> <span class="n">folder_text</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;upload_target_folder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">folder_norm</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_upload_folder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âœ… ×ª×™×§×™×™×ª ×™×¢×“ ×¢×•×“×›× ×”. ×—×•×–×¨ ×œ×‘×“×™×§×•×ª...&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_pre_upload_check</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;waiting_for_github_upload&quot;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;upload_mode&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;github&quot;</span>
        <span class="p">):</span>
            <span class="c1"># ×”×¢×œ××” ×œ×’×™×˜×”××‘</span>
            <span class="n">repo_name</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target_repo&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">repo_name</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×§×•×“× ×‘×—×¨ ×¨×™×¤×•!</span><span class="se">\n</span><span class="s2">×©×œ×— /github&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>

            <span class="k">if</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">document</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;â³ ××¢×œ×” ×§×•×‘×¥ ×œ×’×™×˜×”××‘...&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">emit_event</span><span class="p">(</span>
                        <span class="s2">&quot;github_upload_start&quot;</span><span class="p">,</span>
                        <span class="n">user_id</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">user_id</span><span class="p">),</span>
                        <span class="n">file_name</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">file_name</span><span class="p">),</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">file</span> <span class="o">=</span> <span class="k">await</span> <span class="n">context</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">file_id</span><span class="p">)</span>
                    <span class="n">file_data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">file</span><span class="o">.</span><span class="n">download_as_bytearray</span><span class="p">()</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">file_name</span>

                    <span class="c1"># ×œ×•×’ ×’×•×“×œ ×•×¡×•×’ ×”×§×•×‘×¥</span>
                    <span class="n">file_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ğŸ“„ ××¢×œ×” ×§×•×‘×¥: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">, ×’×•×“×œ: </span><span class="si">{</span><span class="n">file_size</span><span class="si">}</span><span class="s2"> bytes&quot;</span><span class="p">)</span>

                    <span class="c1"># PyGithub ××§×•×“×“ ××•×˜×•××˜×™×ª ×œ-base64, ××– × ××™×¨ ×œ-string ×× ×¦×¨×™×š</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_data</span><span class="p">,</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">)):</span>
                        <span class="n">content</span> <span class="o">=</span> <span class="n">file_data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">content</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âœ… ×ª×•×›×Ÿ ××•×›×Ÿ ×œ×”×¢×œ××”, ×’×•×“×œ: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="si">}</span><span class="s2"> chars&quot;</span><span class="p">)</span>

                    <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;GITHUB_TOKEN&quot;</span><span class="p">)</span>

                    <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">login_or_token</span><span class="o">=</span><span class="p">(</span><span class="n">token</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>

                    <span class="c1"># ×‘×“×•×§ rate limit ×œ×¤× ×™ ×”×‘×§×©×”</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">emit_event</span><span class="p">(</span><span class="s2">&quot;github_rate_limit_check&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[GitHub API] Checking rate limit before file upload&quot;</span><span class="p">)</span>
                    <span class="n">rate</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_rate_limit</span><span class="p">()</span>
                    <span class="n">core_limit</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="s2">&quot;core&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">core_limit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">resources</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="s2">&quot;resources&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">resources</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">core_limit</span> <span class="o">=</span> <span class="n">resources</span><span class="p">[</span><span class="s2">&quot;core&quot;</span><span class="p">]</span>  <span class="c1"># type: ignore[index]</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">core_limit</span> <span class="o">=</span> <span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;core&quot;</span><span class="p">)</span>  <span class="c1"># type: ignore[attr-defined]</span>
                                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                    <span class="n">core_limit</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">core_limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">core_limit</span><span class="p">,</span> <span class="s2">&quot;remaining&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;[GitHub API] Rate limit - Remaining: </span><span class="si">{</span><span class="n">core_limit</span><span class="o">.</span><span class="n">remaining</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="n">core_limit</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;limit&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">core_limit</span><span class="o">.</span><span class="n">remaining</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;[GitHub API] Low on API calls! Only </span><span class="si">{</span><span class="n">core_limit</span><span class="o">.</span><span class="n">remaining</span><span class="si">}</span><span class="s2"> remaining&quot;</span>
                            <span class="p">)</span>
                        <span class="k">if</span> <span class="n">core_limit</span><span class="o">.</span><span class="n">remaining</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;â³ ××’×‘×œ×ª API × ××•×›×” ××“×™!</span><span class="se">\n</span><span class="s2">&quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;× ×•×ª×¨×• ×¨×§ </span><span class="si">{</span><span class="n">core_limit</span><span class="o">.</span><span class="n">remaining</span><span class="si">}</span><span class="s2"> ×‘×§×©×•×ª</span><span class="se">\n</span><span class="s2">&quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;× ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨&quot;</span>
                            <span class="p">)</span>
                            <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[GitHub API] Rate limit - Remaining: unknown&quot;</span><span class="p">)</span>

                    <span class="c1"># ×”×•×¡×£ delay ×‘×™×Ÿ ×‘×§×©×•×ª</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_rate_limit_delay</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[GitHub API] Getting repo: </span><span class="si">{</span><span class="n">repo_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span>

                    <span class="c1"># ×‘× ×™×™×ª × ×ª×™×‘ ×”×§×•×‘×¥</span>
                    <span class="n">folder</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;upload_target_folder&quot;</span><span class="p">)</span>
                        <span class="ow">or</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target_folder&quot;</span><span class="p">)</span>
                        <span class="ow">or</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_folder&quot;</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">folder</span> <span class="ow">and</span> <span class="n">folder</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">and</span> <span class="n">folder</span> <span class="o">!=</span> <span class="s2">&quot;root&quot;</span><span class="p">:</span>
                        <span class="c1"># ×”×¡×¨ / ××™×•×ª×¨×™×</span>
                        <span class="n">folder</span> <span class="o">=</span> <span class="n">folder</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
                        <span class="n">file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># ×”×¢×œ×” ×œ-root</span>
                        <span class="n">file_path</span> <span class="o">=</span> <span class="n">filename</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ğŸ“ × ×ª×™×‘ ×™×¢×“: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="k">with</span> <span class="n">track_performance</span><span class="p">(</span><span class="s2">&quot;github_upload_direct_file&quot;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;repo&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)}):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">existing</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
                            <span class="n">result</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">update_file</span><span class="p">(</span>
                                <span class="n">path</span><span class="o">=</span><span class="n">file_path</span><span class="p">,</span>
                                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Update </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> via Telegram bot&quot;</span><span class="p">,</span>
                                <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>  <span class="c1"># PyGithub ×™×§×•×“×“ ××•×˜×•××˜×™×ª</span>
                                <span class="n">sha</span><span class="o">=</span><span class="n">existing</span><span class="o">.</span><span class="n">sha</span><span class="p">,</span>
                            <span class="p">)</span>
                            <span class="n">action</span> <span class="o">=</span> <span class="s2">&quot;×¢×•×“×›×Ÿ&quot;</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âœ… ×§×•×‘×¥ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”&quot;</span><span class="p">)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">emit_event</span><span class="p">(</span>
                                    <span class="s2">&quot;github_upload_direct_success&quot;</span><span class="p">,</span>
                                    <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span>
                                    <span class="n">repo</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">repo_name</span><span class="p">),</span>
                                    <span class="n">path</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">file_path</span><span class="p">),</span>
                                    <span class="n">action</span><span class="o">=</span><span class="s2">&quot;update&quot;</span><span class="p">,</span>
                                <span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="k">pass</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="n">result</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">create_file</span><span class="p">(</span>
                                <span class="n">path</span><span class="o">=</span><span class="n">file_path</span><span class="p">,</span>
                                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Upload </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> via Telegram bot&quot;</span><span class="p">,</span>
                                <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>  <span class="c1"># PyGithub ×™×§×•×“×“ ××•×˜×•××˜×™×ª</span>
                            <span class="p">)</span>
                            <span class="n">action</span> <span class="o">=</span> <span class="s2">&quot;×”×•×¢×œ×”&quot;</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âœ… ×§×•×‘×¥ × ×•×¦×¨ ×‘×”×¦×œ×—×”&quot;</span><span class="p">)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">emit_event</span><span class="p">(</span>
                                    <span class="s2">&quot;github_upload_direct_success&quot;</span><span class="p">,</span>
                                    <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span>
                                    <span class="n">repo</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">repo_name</span><span class="p">),</span>
                                    <span class="n">path</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">file_path</span><span class="p">),</span>
                                    <span class="n">action</span><span class="o">=</span><span class="s2">&quot;create&quot;</span><span class="p">,</span>
                                <span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="k">pass</span>

                    <span class="n">raw_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://raw.githubusercontent.com/</span><span class="si">{</span><span class="n">repo_name</span><span class="si">}</span><span class="s2">/main/</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span>

                    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;âœ… ×”×§×•×‘×¥ </span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2"> ×‘×”×¦×œ×—×” ×œ×’×™×˜×”××‘!</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;ğŸ“ ×¨×™×¤×•: &lt;code&gt;</span><span class="si">{</span><span class="n">repo_name</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;ğŸ“‚ ××™×§×•×: &lt;code&gt;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;ğŸ”— ×§×™×©×•×¨ ×™×©×™×¨:</span><span class="se">\n</span><span class="si">{</span><span class="n">raw_url</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;×©×œ×— /github ×›×“×™ ×œ×—×–×•×¨ ×œ×ª×¤×¨×™×˜.&quot;</span><span class="p">,</span>
                        <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="c1"># × ×§×” ××ª ×”×¡×˜×˜×•×¡</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_github_upload&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;upload_mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×”×¢×œ××”: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">emit_event</span><span class="p">(</span><span class="s2">&quot;github_upload_direct_error&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">errors_total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">errors_total</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="s2">&quot;github_upload_direct_error&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>

                    <span class="n">error_msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

                    <span class="c1"># ×‘×“×•×§ ×× ×–×• ×©×’×™××ª rate limit</span>
                    <span class="k">if</span> <span class="s2">&quot;rate limit&quot;</span> <span class="ow">in</span> <span class="n">error_msg</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;403&quot;</span> <span class="ow">in</span> <span class="n">error_msg</span><span class="p">:</span>
                        <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="s2">&quot;â³ ×—×¨×™×’×” ×××’×‘×œ×ª GitHub API</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="s2">&quot;× ×¡×” ×©×•×‘ ×‘×¢×•×“ ×›××” ×“×§×•×ª</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                            <span class="s2">&quot;ğŸ’¡ ×˜×™×¤: ×”××ª×Ÿ ××¡×¤×¨ ×“×§×•×ª ×œ×¤× ×™ × ×™×¡×™×•×Ÿ × ×•×¡×£&quot;</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×”×¢×œ××”:</span><span class="se">\n</span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">×¤×¨×˜×™× × ×•×¡×¤×™× × ×©××¨×• ×‘×œ×•×’.&quot;</span>

                    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âš ï¸ ×©×œ×— ×§×•×‘×¥ ×œ×”×¢×œ××”&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># ×× ×œ× ×‘××¦×‘ ×”×¢×œ××” ×œ×’×™×˜×”××‘, ×ª×Ÿ ×œ××˜×¤×œ ×”×¨×’×™×œ ×œ×˜×¤×œ ×‘×–×”</span>
            <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.handle_text_input">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.handle_text_input">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_text_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle text input for various states&quot;&quot;&quot;</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">text</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;ğŸ“ GitHub text input handler: user=</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">, waiting_for_repo=</span><span class="si">{</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;waiting_for_repo_url&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="c1"># ×”×–× ×ª × ×ª×™×‘ ×™×¢×“ ×™×“× ×™ ×¢×‘×•×¨ ×”×¢×œ××” (××ª×•×š &#39;âœï¸ ×”×–×Ÿ × ×ª×™×‘ ×™×“× ×™×ª&#39;)</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;waiting_for_upload_folder&quot;</span><span class="p">):</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_upload_folder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">folder_text</span> <span class="o">=</span> <span class="p">(</span><span class="n">text</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="c1"># × ×¨××œ: ×”×•×¡×¨ ×§×•×•×™× × ×˜×•×™×™× ××™×•×ª×¨×™× ×‘×ª×—×™×œ×”/×‘×¡×•×£ ×•×¨×¦×¤×™× ×›×¤×•×œ×™×</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">re</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_re</span>
                <span class="n">folder_clean</span> <span class="o">=</span> <span class="n">_re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;/+&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">folder_text</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">folder_clean</span> <span class="o">=</span> <span class="n">folder_text</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;upload_target_folder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">folder_clean</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âœ… ×ª×™×§×™×™×ª ×™×¢×“ ×¢×•×“×›× ×”. ×—×•×–×¨ ×œ×‘×“×™×§×•×ªâ€¦&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_pre_upload_check</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># ×”× ×ª×™×‘×™× ×œ××—×™×§×”/×”×•×¨×“×” ×¢×•×‘×¨×™× ×“×¨×š ×“×¤×“×¤×Ÿ ×”×›×¤×ª×•×¨×™× ×›×¢×ª, ×œ×›×Ÿ ××™×Ÿ ×¦×•×¨×š ×œ×˜×¤×œ ×›××Ÿ</span>

        <span class="c1"># ×”×–×Ÿ/×‘×—×¨ ×¨×™×¤×• ×œ× ×™×ª×•×—</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;waiting_for_repo_url&quot;</span><span class="p">):</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_repo_url&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_repository</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># ×”×–× ×ª ×©× ×¨×™×¤×• ×—×“×© ×œ×–×¨×™××ª ×™×¦×™×¨×” ×Ö¼ZIP</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;waiting_for_new_repo_name&quot;</span><span class="p">):</span>
            <span class="c1"># × ×§×” ××ª ××¦×‘ ×”×”××ª× ×”</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_new_repo_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">name_raw</span> <span class="o">=</span> <span class="p">(</span><span class="n">text</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="c1"># ×¡× ×™×˜×™×–×¦×™×” ×¤×©×•×˜×”: ×”××¨×ª ×¨×•×•×—×™× ×œ××§×£ ×•××™×©×•×¨ ×ª×•×•×™× ××•×ª×¨×™×</span>
            <span class="n">safe</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">name_raw</span><span class="p">)</span>
            <span class="n">safe</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^A-Za-z0-9._-]&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">safe</span><span class="p">)</span>
            <span class="n">safe</span> <span class="o">=</span> <span class="n">safe</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;.-_&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">safe</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×©× ×¨×™×¤×• ×œ× ×ª×§×™×Ÿ. × ×¡×” ×©×•×‘ ×¢× ××•×ª×™×•×ª/××¡×¤×¨×™×/.-_ ×‘×œ×‘×“.&quot;</span><span class="p">)</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_new_repo_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="c1"># ×©××•×¨ ××ª ×”×©× ×œ×‘×—×™×¨×ª ×™×¦×™×¨×”</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;new_repo_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">safe</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;âœ… ×©× ×”×¨×™×¤×• × ×§×‘×¢: &lt;code&gt;</span><span class="si">{</span><span class="n">safe</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">×©×œ×— ×¢×›×©×™×• ×§×•×‘×¥ ZIP ×œ×¤×¨×™×¡×”.&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># ×–×¨×™××ª ×”×“×‘×§×ª ×§×•×“: ×©×œ×‘ 1 - ×§×‘×œ×ª ×ª×•×›×Ÿ</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;waiting_for_paste_content&quot;</span><span class="p">):</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_paste_content&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">code_text</span> <span class="o">=</span> <span class="n">text</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">code_text</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_paste_content&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                    <span class="s2">&quot;âš ï¸ ×§×™×‘×œ×ª×™ ×ª×•×›×Ÿ ×¨×™×§. ×”×“×‘×§/×™ ××ª ×”×§×•×“ ×©×•×‘.&quot;</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">([</span>
                        <span class="p">[</span>
                            <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;upload_file&quot;</span><span class="p">),</span>
                            <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;âŒ ×‘×™×˜×•×œ&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;cancel_paste_flow&quot;</span><span class="p">),</span>
                        <span class="p">]</span>
                    <span class="p">])</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;paste_content&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">code_text</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_paste_filename&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;ğŸ“„ ××™×š ×œ×§×¨×•× ×œ×§×•×‘×¥?</span><span class="se">\n</span><span class="s2">×”×§×œ×“/×™ ×©× ×›×•×œ×œ ×¡×™×•××ª (×œ×“×•×’××”: app.py ××• index.ts).&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">([</span>
                    <span class="p">[</span>
                        <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;upload_file&quot;</span><span class="p">),</span>
                        <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;âŒ ×‘×™×˜×•×œ&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;cancel_paste_flow&quot;</span><span class="p">),</span>
                    <span class="p">]</span>
                <span class="p">])</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># ×–×¨×™××ª ×”×“×‘×§×ª ×§×•×“: ×©×œ×‘ 2 - ×§×‘×œ×ª ×©× ×§×•×‘×¥ ×•×¤×ª×™×—×ª ××¡×š ×”×‘×“×™×§×•×ª</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;waiting_for_paste_filename&quot;</span><span class="p">):</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_paste_filename&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">raw_name</span> <span class="o">=</span> <span class="p">(</span><span class="n">text</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="c1"># ×•×œ×™×“×¦×™×” ×‘×¡×™×¡×™×ª ×œ×©× ×§×•×‘×¥</span>
            <span class="n">safe_name</span> <span class="o">=</span> <span class="n">raw_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">safe_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">safe_name</span><span class="p">)</span>
            <span class="n">safe_name</span> <span class="o">=</span> <span class="n">safe_name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">safe_name</span> <span class="ow">or</span> <span class="s2">&quot;.&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">safe_name</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_paste_filename&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                    <span class="s2">&quot;âš ï¸ ×©× ×§×•×‘×¥ ×œ× ×ª×§×™×Ÿ. ×•×“× ×©× + ×¡×™×•××ª, ×œ×“×•×’××”: main.py&quot;</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">([</span>
                        <span class="p">[</span>
                            <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;upload_file&quot;</span><span class="p">),</span>
                            <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;âŒ ×‘×™×˜×•×œ&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;cancel_paste_flow&quot;</span><span class="p">),</span>
                        <span class="p">]</span>
                    <span class="p">])</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×§×•×“× ×‘×—×¨/×™ ×¨×™×¤×•. ×©×œ×—/×™ /github&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>

            <span class="n">content</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;paste_content&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">database</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
                <span class="n">doc</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
                    <span class="s2">&quot;file_name&quot;</span><span class="p">:</span> <span class="n">safe_name</span><span class="p">,</span>
                    <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">content</span><span class="p">,</span>
                    <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span>
                    <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;pasted&quot;</span><span class="p">],</span>
                <span class="p">}</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">insert_one</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;pending_saved_file_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">inserted_id</span><span class="p">)</span>
                <span class="c1"># × ×§×” ×ª×•×›×Ÿ ×–×× ×™</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;paste_content&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_pre_upload_check</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×©××™×¨×ª ×”×§×•×‘×¥ ×”×–×× ×™: </span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># ×—×™×¤×•×© ×‘×©× ×§×•×‘×¥ ××ª×•×š ×“×¤×“×¤×Ÿ ×”×¨×™×¤×•</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;browse_search_mode&quot;</span><span class="p">):</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_search_mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">text</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">query</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×©××™×œ×ª×ª ×—×™×¤×•×© ×¨×™×§×”. × ×¡×” ×©×•×‘ ×“×¨×š ×”×›×¤×ª×•×¨.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_search_query&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">query</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_search_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_browse_search_results</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># ×‘×—×™×¨×ª ×ª×™×§×™×™×” (××ª×•×š &quot;×‘×—×¨ ×ª×™×§×™×™×ª ×™×¢×“&quot; ×”×›×œ×œ×™)</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;waiting_for_selected_folder&quot;</span><span class="p">):</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_selected_folder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">folder_raw</span> <span class="o">=</span> <span class="p">(</span><span class="n">text</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="c1"># Normalize: allow &#39;/&#39; or empty for root</span>
            <span class="k">if</span> <span class="n">folder_raw</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">}:</span>
                <span class="n">session</span><span class="p">[</span><span class="s2">&quot;selected_folder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âœ… ×ª×™×§×™×™×ª ×™×¢×“ ×¢×•×“×›× ×” ×œ-root&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># clean slashes and collapse duplicates</span>
                <span class="n">folder_clean</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;/+&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">folder_raw</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">))</span>
                <span class="n">session</span><span class="p">[</span><span class="s2">&quot;selected_folder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">folder_clean</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;âœ… ×ª×™×§×™×™×ª ×™×¢×“ ×¢×•×“×›× ×” ×œ-&lt;code&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">folder_clean</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span><span class="p">,</span>
                    <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="c1"># ×—×–×¨×” ×œ×ª×¤×¨×™×˜ GitHub</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">github_menu_command</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># ×™×¦×™×¨×ª ×ª×™×§×™×™×” ×—×“×©×” (×’× ××”×ª×¤×¨×™×˜ ×•×’× ××ª×•×š ×‘×“×™×§×•×ª ×œ×¤× ×™ ×”×¢×œ××”)</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;waiting_for_new_folder_path&quot;</span><span class="p">):</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_new_folder_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">folder_raw</span> <span class="o">=</span> <span class="p">(</span><span class="n">text</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">folder_raw</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">}:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×™×© ×œ×”×–×™×Ÿ × ×ª×™×‘ ×ª×™×§×™×™×” ×ª×§×™×Ÿ (×œ×“×•×’××”: src/new)&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="n">folder_clean</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;/+&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">folder_raw</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">))</span>

            <span class="c1"># ×¦×•×¨ ×§×•×‘×¥ .gitkeep ×‘×ª×™×§×™×™×” ×”×—×“×©×” ×›×“×™ ×œ×™×¦×•×¨ ××•×ª×” ×‘×’×™×˜</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">repo_full</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_full</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×—×¡×¨ ×˜×•×§×Ÿ ××• ×¨×™×¤×• ×œ× × ×‘×—×¨&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_full</span><span class="p">)</span>
                <span class="n">target_branch</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;upload_target_branch&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="s2">&quot;default_branch&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;main&quot;</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder_clean</span><span class="si">}</span><span class="s2">/.gitkeep&quot;</span>
                <span class="n">content</span> <span class="o">=</span> <span class="s2">&quot;placeholder to keep directory&quot;</span>
                <span class="c1"># × ×¡×” ×œ×™×¦×•×¨, ×•×× ×§×™×™× × ×¢×“×›×Ÿ</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">existing</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">target_branch</span><span class="p">)</span>
                    <span class="n">repo</span><span class="o">.</span><span class="n">update_file</span><span class="p">(</span>
                        <span class="n">path</span><span class="o">=</span><span class="n">file_path</span><span class="p">,</span>
                        <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Update .gitkeep via bot in </span><span class="si">{</span><span class="n">folder_clean</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>
                        <span class="n">sha</span><span class="o">=</span><span class="n">existing</span><span class="o">.</span><span class="n">sha</span><span class="p">,</span>
                        <span class="n">branch</span><span class="o">=</span><span class="n">target_branch</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">repo</span><span class="o">.</span><span class="n">create_file</span><span class="p">(</span>
                        <span class="n">path</span><span class="o">=</span><span class="n">file_path</span><span class="p">,</span>
                        <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Create folder </span><span class="si">{</span><span class="n">folder_clean</span><span class="si">}</span><span class="s2"> via bot&quot;</span><span class="p">,</span>
                        <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>
                        <span class="n">branch</span><span class="o">=</span><span class="n">target_branch</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="c1"># ×× × ×•×¦×¨ ××ª×•×š ×–×¨×™××ª ×”-pre-upload, ×¢×“×›×Ÿ ××ª ×ª×™×§×™×™×ª ×”×™×¢×“ ×•×—×–×•×¨ ×œ×‘×“×™×§×”</span>
                <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;return_to_pre_upload&quot;</span><span class="p">):</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;return_to_pre_upload&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;upload_target_folder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">folder_clean</span>
                    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;âœ… ×”×ª×™×§×™×™×” × ×•×¦×¨×”: &lt;code&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">folder_clean</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">×—×•×–×¨ ×œ××¡×š ×”×‘×“×™×§×•×ªâ€¦&quot;</span><span class="p">,</span>
                        <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_pre_upload_check</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># ××—×¨×ª, ×¢×“×›×Ÿ ×’× ××ª ×”×ª×™×§×™×™×” ×”× ×‘×—×¨×ª ×œ×©×™××•×© ×¢×ª×™×“×™ ×•×—×–×•×¨ ×œ×ª×¤×¨×™×˜</span>
                    <span class="n">session</span><span class="p">[</span><span class="s2">&quot;selected_folder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">folder_clean</span>
                    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;âœ… ×”×ª×™×§×™×™×” × ×•×¦×¨×” ×•× ×‘×—×¨×”: &lt;code&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">folder_clean</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span><span class="p">,</span>
                        <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">github_menu_command</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create folder </span><span class="si">{</span><span class="n">folder_clean</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;âŒ ×™×¦×™×¨×ª ×ª×™×§×™×™×” × ×›×©×œ×”: </span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># ×‘×¨×™×¨×ª ××—×“×œ: ×¡×™×™×</span>
        <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.show_analyze_repo_menu">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_analyze_repo_menu">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">show_analyze_repo_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;××¦×™×’ ×ª×¤×¨×™×˜ ×œ× ×™×ª×•×— ×¨×™×¤×•&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;ğŸ“‹ Starting show_analyze_repo_menu function&quot;</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;ğŸ“Š Session data: selected_repo=</span><span class="si">{</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;selected_repo&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">, has_token=</span><span class="si">{</span><span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="c1"># ×‘×“×•×§ ×× ×™×© ×¨×™×¤×• × ×‘×—×¨</span>
        <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">):</span>
            <span class="c1"># ×× ×™×© ×¨×™×¤×• × ×‘×—×¨, ×”×¦×¢ ×œ× ×ª×— ××•×ª×• ××• ×œ×‘×—×•×¨ ××—×¨</span>
            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;ğŸ“Š × ×ª×— ××ª </span><span class="si">{</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;selected_repo&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;analyze_current_repo&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ” × ×ª×— ×¨×™×¤×• ××—×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;analyze_other_repo&quot;</span><span class="p">)],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨ ×œ×ª×¤×¨×™×˜&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)],</span>
            <span class="p">]</span>

            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="s2">&quot;ğŸ” &lt;b&gt;× ×™×ª×•×— ×¨×™×¤×•×–×™×˜×•×¨×™&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="s2">&quot;×‘×—×¨ ××¤×©×¨×•×ª:&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># ×× ××™×Ÿ ×¨×™×¤×• × ×‘×—×¨, ×‘×§×© URL</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_repo_url</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.request_repo_url">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.request_repo_url">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">request_repo_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;××‘×§×© URL ×©×œ ×¨×™×¤×• ×œ× ×™×ª×•×—&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;ğŸ“ Requesting repository URL from user&quot;</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span> <span class="k">if</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;âŒ ×‘×™×˜×•×œ&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)]]</span>

        <span class="n">message_text</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;ğŸ” &lt;b&gt;× ×™×ª×•×— ×¨×™×¤×•×–×™×˜×•×¨×™&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;×©×œ×— URL ×©×œ ×¨×™×¤×• ×¦×™×‘×•×¨×™ ×‘-GitHub:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;×œ×“×•×’××”: &lt;code&gt;https://github.com/owner/repo&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;ğŸ’¡ ×”×¨×™×¤×• ×—×™×™×‘ ×œ×”×™×•×ª ×¦×™×‘×•×¨×™ ××• ×©×™×© ×œ×š ×’×™×©×” ××œ×™×• ×¢× ×”×˜×•×§×Ÿ&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="n">message_text</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="n">message_text</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span>
            <span class="p">)</span>

        <span class="c1"># ×¡××Ÿ ×©×× ×—× ×• ××—×›×™× ×œ-URL</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_repo_url&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.analyze_another_repo">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.analyze_another_repo">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">analyze_another_repo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;××¦×™×’ ×ª×¤×¨×™×˜ ×‘×—×™×¨×” ×œ× ×™×ª×•×— ×¨×™×¤×• ××—×¨&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>

        <span class="c1"># ×”×¦×’ ×›×¤×ª×•×¨×™× ×œ×‘×—×™×¨×”</span>
        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ“ ×‘×—×¨ ××”×¨×™×¤×•×–×™×˜×•×¨×™× ×©×œ×™&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;choose_my_repo&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”— ×”×›× ×¡ URL ×©×œ ×¨×™×¤×• ×¦×™×‘×•×¨×™&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;enter_repo_url&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;back_to_analysis_menu&quot;</span><span class="p">)],</span>
        <span class="p">]</span>

        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
            <span class="s2">&quot;××™×š ×ª×¨×¦×” ×œ×‘×—×•×¨ ×¨×™×¤×• ×œ× ×™×ª×•×—?&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.analyze_repository">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.analyze_repository">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">analyze_repository</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">repo_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×× ×ª×— ×¨×™×¤×•×–×™×˜×•×¨×™ ×•××¦×™×’ ×ª×•×¦××•×ª&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ğŸ¯ Starting repository analysis for URL: </span><span class="si">{</span><span class="n">repo_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span> <span class="k">if</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ğŸ‘¤ User </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> analyzing repo: </span><span class="si">{</span><span class="n">repo_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># ×”×¦×’ ×”×•×“×¢×ª ×”××ª× ×”</span>
        <span class="n">status_message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_or_edit_message</span><span class="p">(</span>
            <span class="n">update</span><span class="p">,</span> <span class="s2">&quot;ğŸ” ×× ×ª×— ××ª ×”×¨×™×¤×•...</span><span class="se">\n</span><span class="s2">×–×” ×¢×©×•×™ ×œ×§×—×ª ××¡×¤×¨ ×©× ×™×•×ª...&quot;</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># ×¦×•×¨ ×× ×ª×— ×¢× ×”×˜×•×§×Ÿ</span>
            <span class="n">analyzer</span> <span class="o">=</span> <span class="n">RepoAnalyzer</span><span class="p">(</span><span class="n">github_token</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">))</span>

            <span class="c1"># × ×ª×— ××ª ×”×¨×™×¤×•</span>
            <span class="n">analysis</span> <span class="o">=</span> <span class="k">await</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">fetch_and_analyze_repo</span><span class="p">(</span><span class="n">repo_url</span><span class="p">)</span>

            <span class="c1"># ×©××•×¨ ××ª ×”× ×™×ª×•×— ×‘-session</span>
            <span class="n">session</span><span class="p">[</span><span class="s2">&quot;last_analysis&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis</span>
            <span class="n">session</span><span class="p">[</span><span class="s2">&quot;last_analyzed_repo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">repo_url</span>

            <span class="c1"># ×¦×•×¨ ×¡×™×›×•×</span>
            <span class="n">summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_analysis_summary</span><span class="p">(</span><span class="n">analysis</span><span class="p">)</span>

            <span class="c1"># ×¦×•×¨ ×›×¤×ª×•×¨×™×</span>
            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ¯ ×”×¦×’ ×”×¦×¢×•×ª ×œ×©×™×¤×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;show_suggestions&quot;</span><span class="p">)],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ“¥ ×”×•×¨×“ ×“×•×— JSON&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;download_analysis_json&quot;</span><span class="p">)],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ” × ×ª×— ×¨×™×¤×• ××—×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;analyze_other_repo&quot;</span><span class="p">)],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨ ×œ×ª×¤×¨×™×˜&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)],</span>
            <span class="p">]</span>

            <span class="c1"># ×¢×“×›×Ÿ ××ª ×”×”×•×“×¢×” ×¢× ×”×ª×•×¦××•×ª</span>
            <span class="k">await</span> <span class="n">status_message</span><span class="o">.</span><span class="n">edit_text</span><span class="p">(</span>
                <span class="n">summary</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span>
            <span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error analyzing repository: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘× ×™×ª×•×— ×”×¨×™×¤×•:</span><span class="se">\n</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ” × ×¡×” ×¨×™×¤×• ××—×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;analyze_other_repo&quot;</span><span class="p">)],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨ ×œ×ª×¤×¨×™×˜&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)],</span>
            <span class="p">]</span>

            <span class="k">await</span> <span class="n">status_message</span><span class="o">.</span><span class="n">edit_text</span><span class="p">(</span>
                <span class="n">error_message</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
            <span class="p">)</span></div>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_analysis_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analysis</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×™×•×¦×¨ ×¡×™×›×•× ×©×œ ×”× ×™×ª×•×—&quot;&quot;&quot;</span>
        <span class="c1"># Escape HTML special characters</span>
        <span class="n">repo_name</span> <span class="o">=</span> <span class="n">safe_html_escape</span><span class="p">(</span><span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;repo_name&quot;</span><span class="p">])</span>
        <span class="n">language</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">safe_html_escape</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;language&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span> <span class="k">if</span> <span class="n">analysis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;language&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>

        <span class="n">summary</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ğŸ“Š &lt;b&gt;× ×™×ª×•×— ×”×¨×™×¤×• </span><span class="si">{</span><span class="n">repo_name</span><span class="si">}</span><span class="s2">&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>

        <span class="c1"># ×¡×˜×˜×•×¡ ×§×‘×¦×™× ×‘×¡×™×¡×™×™×</span>
        <span class="n">summary</span> <span class="o">+=</span> <span class="s2">&quot;&lt;b&gt;×§×‘×¦×™× ×‘×¡×™×¡×™×™×:&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">summary</span> <span class="o">+=</span> <span class="s2">&quot;âœ… README</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;has_readme&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;âŒ ×—×¡×¨ README</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">summary</span> <span class="o">+=</span> <span class="s2">&quot;âœ… LICENSE</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;has_license&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;âŒ ×—×¡×¨ LICENSE</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">summary</span> <span class="o">+=</span> <span class="s2">&quot;âœ… .gitignore</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;has_gitignore&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;âŒ ×—×¡×¨ .gitignore</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="c1"># ××™×“×¢ ×¢×œ ×”×¤×¨×•×™×§×˜</span>
        <span class="n">summary</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&lt;b&gt;××™×“×¢ ×›×œ×œ×™:&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">language</span><span class="p">:</span>
            <span class="n">summary</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;ğŸ”¤ ×©×¤×” ×¢×™×§×¨×™×ª: </span><span class="si">{</span><span class="n">language</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">summary</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;ğŸ“ </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;file_count&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> ×§×‘×¦×™ ×§×•×“</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="c1"># ×§×‘×¦×™× ×œ×¤×™ ×¡×•×’</span>
        <span class="k">if</span> <span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;files_by_type&quot;</span><span class="p">]:</span>
            <span class="n">top_types</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;files_by_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span>
                <span class="p">:</span><span class="mi">3</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">ext</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">top_types</span><span class="p">:</span>
                <span class="n">ext_escaped</span> <span class="o">=</span> <span class="n">safe_html_escape</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>
                <span class="n">summary</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   â€¢ </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2"> ×§×‘×¦×™ </span><span class="si">{</span><span class="n">ext_escaped</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="c1"># ×ª×œ×•×™×•×ª</span>
        <span class="k">if</span> <span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;dependencies&quot;</span><span class="p">]:</span>
            <span class="n">summary</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;ğŸ“¦ </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;dependencies&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> ×ª×œ×•×™×•×ª</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="c1"># ×‘×¢×™×•×ª ×¤×•×˜× ×¦×™××œ×™×•×ª</span>
        <span class="k">if</span> <span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;large_files&quot;</span><span class="p">]:</span>
            <span class="n">summary</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;âš ï¸ </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;large_files&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> ×§×‘×¦×™× ×’×“×•×œ×™×</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;long_functions&quot;</span><span class="p">]:</span>
            <span class="n">summary</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;âš ï¸ </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;long_functions&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> ×¤×•× ×§×¦×™×•×ª ××¨×•×›×•×ª</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="c1"># ×¦×™×•×Ÿ ××™×›×•×ª</span>
        <span class="n">quality_score</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;quality_score&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">quality_score</span> <span class="o">&gt;=</span> <span class="mi">80</span><span class="p">:</span>
            <span class="n">emoji</span> <span class="o">=</span> <span class="s2">&quot;ğŸŒŸ&quot;</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;××¦×•×™×Ÿ&quot;</span>
        <span class="k">elif</span> <span class="n">quality_score</span> <span class="o">&gt;=</span> <span class="mi">60</span><span class="p">:</span>
            <span class="n">emoji</span> <span class="o">=</span> <span class="s2">&quot;âœ¨&quot;</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;×˜×•×‘&quot;</span>
        <span class="k">elif</span> <span class="n">quality_score</span> <span class="o">&gt;=</span> <span class="mi">40</span><span class="p">:</span>
            <span class="n">emoji</span> <span class="o">=</span> <span class="s2">&quot;â­&quot;</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;×‘×™× ×•× ×™&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">emoji</span> <span class="o">=</span> <span class="s2">&quot;ğŸ’«&quot;</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;×“×•×¨×© ×©×™×¤×•×¨&quot;</span>

        <span class="n">summary</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&lt;b&gt;×¦×™×•×Ÿ ××™×›×•×ª: </span><span class="si">{</span><span class="n">emoji</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">quality_score</span><span class="si">}</span><span class="s2">/100 (</span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s2">)&lt;/b&gt;&quot;</span>

        <span class="k">return</span> <span class="n">summary</span>

<div class="viewcode-block" id="GitHubMenuHandler.show_improvement_suggestions">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_improvement_suggestions">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">show_improvement_suggestions</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;××¦×™×’ ×”×¦×¢×•×ª ×œ×©×™×¤×•×¨&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>

        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;last_analysis&quot;</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="s2">&quot;âŒ ×œ× × ××¦× × ×™×ª×•×—. × ×ª×— ×¨×™×¤×• ×§×•×“×.&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ” × ×ª×— ×¨×™×¤×•&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;analyze_repo&quot;</span><span class="p">)],</span>
                        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨ ×œ×ª×¤×¨×™×˜&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)],</span>
                    <span class="p">]</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># ×¦×•×¨ ×”×¦×¢×•×ª ×œ×©×™×¤×•×¨</span>
        <span class="n">analyzer</span> <span class="o">=</span> <span class="n">RepoAnalyzer</span><span class="p">()</span>
        <span class="n">suggestions</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">generate_improvement_suggestions</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;last_analysis&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">suggestions</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="s2">&quot;ğŸ‰ ××¢×•×œ×”! ×œ× × ××¦××• ×”×¦×¢×•×ª ×œ×©×™×¤×•×¨ ××©××¢×•×ª×™×•×ª.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="s2">&quot;×”×¤×¨×•×™×§×˜ × ×¨××” ××¦×•×™×Ÿ!&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨ ×œ×¡×™×›×•×&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;back_to_analysis&quot;</span><span class="p">)],</span>
                        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ  ×ª×¤×¨×™×˜ ×¨××©×™&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)],</span>
                    <span class="p">]</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># ×©××•×¨ ×”×¦×¢×•×ª ×‘-session</span>
        <span class="n">session</span><span class="p">[</span><span class="s2">&quot;suggestions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">suggestions</span>

        <span class="c1"># ×¦×•×¨ ×›×¤×ª×•×¨×™× ×œ×”×¦×¢×•×ª (××§×¡×™××•× 8 ×”×¦×¢×•×ª)</span>
        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">suggestion</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">suggestions</span><span class="p">[:</span><span class="mi">8</span><span class="p">]):</span>
            <span class="n">impact_emoji</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;ğŸ”´&quot;</span>
                <span class="k">if</span> <span class="n">suggestion</span><span class="p">[</span><span class="s2">&quot;impact&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;high&quot;</span>
                <span class="k">else</span> <span class="s2">&quot;ğŸŸ¡&quot;</span> <span class="k">if</span> <span class="n">suggestion</span><span class="p">[</span><span class="s2">&quot;impact&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;medium&quot;</span> <span class="k">else</span> <span class="s2">&quot;ğŸŸ¢&quot;</span>
            <span class="p">)</span>
            <span class="n">button_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">impact_emoji</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">suggestion</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">button_text</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;suggestion_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>

        <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨ ×œ×¡×™×›×•×&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;back_to_analysis&quot;</span><span class="p">)])</span>

        <span class="c1"># Escape HTML special characters</span>
        <span class="n">repo_name</span> <span class="o">=</span> <span class="n">safe_html_escape</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;last_analysis&quot;</span><span class="p">][</span><span class="s2">&quot;repo_name&quot;</span><span class="p">])</span>

        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ğŸ’¡ &lt;b&gt;×”×¦×¢×•×ª ×œ×©×™×¤×•×¨ ×œ×¨×™×¤×• </span><span class="si">{</span><span class="n">repo_name</span><span class="si">}</span><span class="s2">&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;× ××¦××• </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">suggestions</span><span class="p">)</span><span class="si">}</span><span class="s2"> ×”×¦×¢×•×ª ×œ×©×™×¤×•×¨.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;×‘×—×¨ ×”×¦×¢×” ×œ×¤×¨×˜×™× × ×•×¡×¤×™×:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;ğŸ”´ = ×”×©×¤×¢×” ×’×‘×•×”×” | ğŸŸ¡ = ×‘×™× ×•× ×™×ª | ğŸŸ¢ = × ××•×›×”&quot;</span>

        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
            <span class="n">message</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.show_suggestion_details">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_suggestion_details">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">show_suggestion_details</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">suggestion_index</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;××¦×™×’ ×¤×¨×˜×™ ×”×¦×¢×” ×¡×¤×¦×™×¤×™×ª&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
            <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

            <span class="n">suggestions</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;suggestions&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="n">suggestion_index</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">suggestions</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;âŒ ×”×¦×¢×” ×œ× × ××¦××”&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="n">suggestion</span> <span class="o">=</span> <span class="n">suggestions</span><span class="p">[</span><span class="n">suggestion_index</span><span class="p">]</span>

            <span class="c1"># ××™×¤×•×™ ×”×©×¤×¢×” ×•××××¥ ×œ×¢×‘×¨×™×ª</span>
            <span class="n">impact_map</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;high&quot;</span><span class="p">:</span> <span class="s2">&quot;×’×‘×•×”×”&quot;</span><span class="p">,</span> <span class="s2">&quot;medium&quot;</span><span class="p">:</span> <span class="s2">&quot;×‘×™× ×•× ×™×ª&quot;</span><span class="p">,</span> <span class="s2">&quot;low&quot;</span><span class="p">:</span> <span class="s2">&quot;× ××•×›×”&quot;</span><span class="p">}</span>
            <span class="n">effort_map</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;high&quot;</span><span class="p">:</span> <span class="s2">&quot;×’×‘×•×”&quot;</span><span class="p">,</span> <span class="s2">&quot;medium&quot;</span><span class="p">:</span> <span class="s2">&quot;×‘×™× ×•× ×™&quot;</span><span class="p">,</span> <span class="s2">&quot;low&quot;</span><span class="p">:</span> <span class="s2">&quot;× ××•×š&quot;</span><span class="p">}</span>

            <span class="c1"># Use safe HTML escaping to prevent parsing errors</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">safe_html_escape</span><span class="p">(</span><span class="n">suggestion</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;×”×¦×¢×”&quot;</span><span class="p">))</span>
            <span class="n">why</span> <span class="o">=</span> <span class="n">safe_html_escape</span><span class="p">(</span><span class="n">suggestion</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;why&quot;</span><span class="p">,</span> <span class="s2">&quot;×œ× ×¦×•×™×Ÿ&quot;</span><span class="p">))</span>
            <span class="n">how</span> <span class="o">=</span> <span class="n">safe_html_escape</span><span class="p">(</span><span class="n">suggestion</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;how&quot;</span><span class="p">,</span> <span class="s2">&quot;×œ× ×¦×•×™×Ÿ&quot;</span><span class="p">))</span>
            <span class="n">impact</span> <span class="o">=</span> <span class="n">safe_html_escape</span><span class="p">(</span><span class="n">impact_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">suggestion</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;impact&quot;</span><span class="p">,</span> <span class="s2">&quot;medium&quot;</span><span class="p">),</span> <span class="s2">&quot;×‘×™× ×•× ×™×ª&quot;</span><span class="p">))</span>
            <span class="n">effort</span> <span class="o">=</span> <span class="n">safe_html_escape</span><span class="p">(</span><span class="n">effort_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">suggestion</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;effort&quot;</span><span class="p">,</span> <span class="s2">&quot;medium&quot;</span><span class="p">),</span> <span class="s2">&quot;×‘×™× ×•× ×™&quot;</span><span class="p">))</span>

            <span class="c1"># ×‘× ×” ×”×•×“×¢×” ×‘×˜×•×—×”</span>
            <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;b&gt;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;â“ &lt;b&gt;×œ××”:&lt;/b&gt; </span><span class="si">{</span><span class="n">why</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;ğŸ’¡ &lt;b&gt;××™×š:&lt;/b&gt; </span><span class="si">{</span><span class="n">how</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;ğŸ“Š &lt;b&gt;×”×©×¤×¢×”:&lt;/b&gt; </span><span class="si">{</span><span class="n">impact</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;âš¡ &lt;b&gt;××××¥:&lt;/b&gt; </span><span class="si">{</span><span class="n">effort</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># ×”×•×¡×£ ×›×¤×ª×•×¨ ×œ××™×“×¢ × ×•×¡×£ ×‘×”×ª×× ×œ×§×˜×’×•×¨×™×”</span>
            <span class="n">suggestion_id</span> <span class="o">=</span> <span class="n">suggestion</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">suggestion_id</span> <span class="o">==</span> <span class="s2">&quot;add_license&quot;</span><span class="p">:</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ“š ××™×“×¢ ×¢×œ ×¨×™×©×™×•× ×•×ª&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://choosealicense.com/&quot;</span><span class="p">)]</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">suggestion_id</span> <span class="o">==</span> <span class="s2">&quot;add_gitignore&quot;</span><span class="p">:</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ“š ×™×¦×™×¨×ª .gitignore&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://gitignore.io/&quot;</span><span class="p">)]</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">suggestion_id</span> <span class="o">==</span> <span class="s2">&quot;add_ci_cd&quot;</span><span class="p">:</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                            <span class="s2">&quot;ğŸ“š GitHub Actions&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://docs.github.com/en/actions&quot;</span>
                        <span class="p">)</span>
                    <span class="p">]</span>
                <span class="p">)</span>

            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨ ×œ×”×¦×¢×•×ª&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;show_suggestions&quot;</span><span class="p">)]</span>
            <span class="p">)</span>

            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="n">message</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span>
            <span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in show_suggestion_details: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Fallback to simple text without HTML</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">simple_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;×”×¦×¢×” #</span><span class="si">{</span><span class="n">suggestion_index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="s2">&quot;suggestion&quot;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
                    <span class="n">simple_text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">suggestion</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;×”×¦×¢×”&#39;</span><span class="p">)</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="n">simple_text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;×œ××”: </span><span class="si">{</span><span class="n">suggestion</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;why&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;×œ× ×¦×•×™×Ÿ&#39;</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="n">simple_text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;××™×š: </span><span class="si">{</span><span class="n">suggestion</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;how&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;×œ× ×¦×•×™×Ÿ&#39;</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">simple_text</span> <span class="o">+=</span> <span class="s2">&quot;×œ× × ×™×ª×Ÿ ×œ×”×¦×™×’ ××ª ×¤×¨×˜×™ ×”×”×¦×¢×”&quot;</span>

                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                    <span class="n">simple_text</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span>
                        <span class="p">[[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;show_suggestions&quot;</span><span class="p">)]]</span>
                    <span class="p">),</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">fallback_error</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fallback also failed: </span><span class="si">{</span><span class="n">fallback_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×”×¦×’×ª ×”×”×¦×¢×”&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.show_full_analysis">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_full_analysis">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">show_full_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;××¦×™×’ × ×™×ª×•×— ××œ×&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>

        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

        <span class="n">analysis</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;last_analysis&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">analysis</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;âŒ ×œ× × ××¦× × ×™×ª×•×—&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># ×¦×•×¨ ×“×•×— ××¤×•×¨×˜ - Escape HTML special characters</span>
        <span class="n">repo_name</span> <span class="o">=</span> <span class="n">safe_html_escape</span><span class="p">(</span><span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;repo_name&quot;</span><span class="p">])</span>
        <span class="n">repo_url</span> <span class="o">=</span> <span class="n">safe_html_escape</span><span class="p">(</span><span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;repo_url&quot;</span><span class="p">])</span>
        <span class="n">description</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">safe_html_escape</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">analysis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">)</span>
            <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>
        <span class="n">language</span> <span class="o">=</span> <span class="n">safe_html_escape</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;language&quot;</span><span class="p">,</span> <span class="s2">&quot;×œ× ×–×•×”×ª×”&quot;</span><span class="p">))</span>

        <span class="n">report</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ğŸ“Š &lt;b&gt;×“×•×— ××œ× - </span><span class="si">{</span><span class="n">repo_name</span><span class="si">}</span><span class="s2">&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>

        <span class="c1"># ××™×“×¢ ×‘×¡×™×¡×™</span>
        <span class="n">report</span> <span class="o">+=</span> <span class="s2">&quot;&lt;b&gt;ğŸ“Œ ××™×“×¢ ×›×œ×œ×™:&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;â€¢ URL: </span><span class="si">{</span><span class="n">repo_url</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">description</span><span class="p">:</span>
            <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;â€¢ ×ª×™××•×¨: </span><span class="si">{</span><span class="n">description</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;â€¢ ×©×¤×”: </span><span class="si">{</span><span class="n">language</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;â€¢ ×›×•×›×‘×™×: â­ </span><span class="si">{</span><span class="n">analysis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;stars&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;â€¢ Forks: ğŸ´ </span><span class="si">{</span><span class="n">analysis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;forks&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="c1"># ×§×‘×¦×™×</span>
        <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&lt;b&gt;ğŸ“ ×§×‘×¦×™×:&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;â€¢ ×¡×”×´×› ×§×‘×¦×™ ×§×•×“: </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;file_count&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;files_by_type&quot;</span><span class="p">]:</span>
            <span class="n">report</span> <span class="o">+=</span> <span class="s2">&quot;â€¢ ×œ×¤×™ ×¡×•×’:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">ext</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span>
                <span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;files_by_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">):</span>
                <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="c1"># ×‘×¢×™×•×ª</span>
        <span class="k">if</span> <span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;large_files&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;long_functions&quot;</span><span class="p">]:</span>
            <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&lt;b&gt;âš ï¸ ×‘×¢×™×•×ª ×¤×•×˜× ×¦×™××œ×™×•×ª:&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;large_files&quot;</span><span class="p">]:</span>
                <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;â€¢ </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;large_files&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> ×§×‘×¦×™× ×’×“×•×œ×™× (500+ ×©×•×¨×•×ª)</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;long_functions&quot;</span><span class="p">]:</span>
                <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;â€¢ </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;long_functions&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> ×¤×•× ×§×¦×™×•×ª ××¨×•×›×•×ª (50+ ×©×•×¨×•×ª)</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="c1"># ×ª×œ×•×™×•×ª</span>
        <span class="k">if</span> <span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;dependencies&quot;</span><span class="p">]:</span>
            <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&lt;b&gt;ğŸ“¦ ×ª×œ×•×™×•×ª (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;dependencies&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">):&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="c1"># ×”×¦×’ ×¨×§ 10 ×”×¨××©×•× ×•×ª</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;dependencies&quot;</span><span class="p">][:</span><span class="mi">10</span><span class="p">]:</span>
                <span class="n">dep_name</span> <span class="o">=</span> <span class="n">safe_html_escape</span><span class="p">(</span><span class="n">dep</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
                <span class="n">dep_type</span> <span class="o">=</span> <span class="n">safe_html_escape</span><span class="p">(</span><span class="n">dep</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">])</span>
                <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;â€¢ </span><span class="si">{</span><span class="n">dep_name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">dep_type</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;dependencies&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;â€¢ ... ×•×¢×•×“ </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;dependencies&#39;</span><span class="p">])</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">10</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨ ×œ×¡×™×›×•×&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;back_to_analysis&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ  ×ª×¤×¨×™×˜ ×¨××©×™&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)],</span>
        <span class="p">]</span>

        <span class="c1"># ×—×œ×§ ××ª ×”×”×•×“×¢×” ×× ×”×™× ××¨×•×›×” ××“×™</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">report</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4000</span><span class="p">:</span>
            <span class="n">report</span> <span class="o">=</span> <span class="n">report</span><span class="p">[:</span><span class="mi">3900</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">... (×§×•×¦×¨ ×œ×¦×•×¨×š ×ª×¦×•×’×”)&quot;</span>

        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
            <span class="n">report</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.download_analysis_json">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.download_analysis_json">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">download_analysis_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×©×•×œ×— ×§×•×‘×¥ JSON ×¢× ×”× ×™×ª×•×— ×”××œ×&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>

        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

        <span class="n">analysis</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;last_analysis&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">analysis</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;âŒ ×œ× × ××¦× × ×™×ª×•×—&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># ×”×•×¡×£ ×’× ××ª ×”×”×¦×¢×•×ª ×œ×“×•×—</span>
        <span class="n">analyzer</span> <span class="o">=</span> <span class="n">RepoAnalyzer</span><span class="p">()</span>
        <span class="n">suggestions</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">generate_improvement_suggestions</span><span class="p">(</span><span class="n">analysis</span><span class="p">)</span>

        <span class="n">full_report</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;analysis&quot;</span><span class="p">:</span> <span class="n">analysis</span><span class="p">,</span>
            <span class="s2">&quot;suggestions&quot;</span><span class="p">:</span> <span class="n">suggestions</span><span class="p">,</span>
            <span class="s2">&quot;generated_at&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
        <span class="p">}</span>

        <span class="c1"># ×¦×•×¨ ×§×•×‘×¥ JSON</span>
        <span class="n">json_content</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">full_report</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># ×©×œ×— ×›×§×•×‘×¥</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">io</span>

        <span class="n">file</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">json_content</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
        <span class="n">file</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;repo_analysis_</span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;repo_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.json&quot;</span>

        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_document</span><span class="p">(</span>
            <span class="n">document</span><span class="o">=</span><span class="n">file</span><span class="p">,</span>
            <span class="n">filename</span><span class="o">=</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">caption</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;ğŸ“Š ×“×•×— × ×™×ª×•×— ××œ× ×¢×‘×•×¨ </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;repo_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># ×—×–×•×¨ ×œ×ª×¤×¨×™×˜</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_analyze_results_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.show_analyze_results_menu">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_analyze_results_menu">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">show_analyze_results_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;××¦×™×’ ××—×“×© ××ª ×ª×¤×¨×™×˜ ×”×ª×•×¦××•×ª&quot;&quot;&quot;</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

        <span class="n">analysis</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;last_analysis&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">analysis</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_analysis_summary</span><span class="p">(</span><span class="n">analysis</span><span class="p">)</span>

        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ¯ ×”×¦×’ ×”×¦×¢×•×ª ×œ×©×™×¤×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;show_suggestions&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ“¥ ×”×•×¨×“ ×“×•×— JSON&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;download_analysis_json&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ” × ×ª×— ×¨×™×¤×• ××—×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;analyze_other_repo&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨ ×œ×ª×¤×¨×™×˜&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)],</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="n">summary</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="n">summary</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span>
            <span class="p">)</span></div>


    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_send_or_edit_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×©×•×œ×— ××• ×¢×•×¨×š ×”×•×“×¢×” ×‘×”×ª×× ×œ×¡×•×’ ×”-update&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="GitHubMenuHandler.handle_repo_url_input">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.handle_repo_url_input">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_repo_url_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;××˜×¤×œ ×‘×§×œ×˜ ×©×œ URL ×œ× ×™×ª×•×—&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;ğŸ”— Handling repo URL input: waiting=</span><span class="si">{</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;waiting_for_repo_url&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;waiting_for_repo_url&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">text</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">text</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ğŸ“Œ Received URL: </span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_repo_url&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># ×‘×“×•×§ ×× ×–×” URL ×©×œ GitHub</span>
        <span class="k">if</span> <span class="s2">&quot;github.com&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;âŒ × × ×œ×©×œ×•×— URL ×ª×§×™×Ÿ ×©×œ GitHub</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="s2">&quot;×œ×“×•×’××”: https://github.com/owner/repo&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ” × ×¡×” ×©×•×‘&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;analyze_other_repo&quot;</span><span class="p">)],</span>
                        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨ ×œ×ª×¤×¨×™×˜&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)],</span>
                    <span class="p">]</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># × ×ª×— ××ª ×”×¨×™×¤×•</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_repository</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.show_delete_file_menu">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_delete_file_menu">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">show_delete_file_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;××¦×™×’ ×ª×¤×¨×™×˜ ××—×™×§×ª ×§×•×‘×¥ ××”×¨×™×¤×• (×“×¤×“×•×£ ×‘×›×¤×ª×•×¨×™×)&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">repo</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×œ× × ×‘×—×¨ ×¨×™×¤×•&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;delete&quot;</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># ××¦×‘ ××¨×•×‘×” ×•××—×™×§×” ×‘×˜×•×—×” ×œ××™×¤×•×¡</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;multi_mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;multi_selection&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;safe_delete&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_repo_browser</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.show_delete_repo_menu">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_delete_repo_menu">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">show_delete_repo_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;××¦×™×’ ×ª×¤×¨×™×˜ ××—×™×§×ª ×¨×™×¤×• ×©×œ× ×¢× ××–×”×¨×•×ª&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">repo</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×œ× × ×‘×—×¨ ×¨×™×¤×•&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                    <span class="s2">&quot;âœ… ×× ×™ ××‘×™×Ÿ/×” ×•×××©×¨/×ª ××—×™×§×”&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;confirm_delete_repo_step1&quot;</span>
                <span class="p">)</span>
            <span class="p">],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)],</span>
        <span class="p">]</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
            <span class="s2">&quot;âš ï¸ ××—×™×§×ª ×¨×™×¤×• ×©×œ× ×”×™× ×” ×¤×¢×•×œ×” ×‘×œ×ª×™ ×”×¤×™×›×”!</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;- ×™×™××—×§×• ×›×œ ×”×§×‘×¦×™×, ×”-Issues, ×”-PRs ×•×”-Settings</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;- ×œ× × ×™×ª×Ÿ ×œ×©×—×–×¨ ×œ××—×¨ ×”××—×™×§×”</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;×¨×™×¤×• ×œ××—×™×§×”: &lt;code&gt;</span><span class="si">{</span><span class="n">repo</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;×× ×‘×¨×¦×•× ×š ×œ×”××©×™×š, ×œ×—×¥ ×¢×œ ×”××™×©×•×¨ ×•××– ×ª×ª×‘×§×© ×œ××©×¨ ×©×•×‘.&quot;</span><span class="p">,</span>
            <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span>
            <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.confirm_delete_file">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.confirm_delete_file">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">confirm_delete_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;××‘×¦×¢ ××—×™×§×ª ×§×•×‘×¥ ×œ××—×¨ ××™×©×•×¨&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pending_delete_file_path&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_name</span> <span class="ow">and</span> <span class="n">file_path</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ × ×ª×•× ×™× ×—×¡×¨×™× ×œ××—×™×§×”&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span>
            <span class="c1"># ×‘×“×•×§ ×× ×”×§×•×‘×¥ ×§×™×™× ×•×§×‘×œ sha ×œ×¦×•×¨×š ××—×™×§×”</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
            <span class="n">default_branch</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">default_branch</span> <span class="ow">or</span> <span class="s2">&quot;main&quot;</span>
            <span class="n">repo</span><span class="o">.</span><span class="n">delete_file</span><span class="p">(</span>
                <span class="n">contents</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Delete via bot: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">contents</span><span class="o">.</span><span class="n">sha</span><span class="p">,</span> <span class="n">branch</span><span class="o">=</span><span class="n">default_branch</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;âœ… ×”×§×•×‘×¥ × ××—×§ ×‘×”×¦×œ×—×”: &lt;code&gt;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error deleting file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘××—×™×§×ª ×§×•×‘×¥: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;pending_delete_file_path&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">github_menu_command</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.confirm_delete_repo_step1">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.confirm_delete_repo_step1">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">confirm_delete_repo_step1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;××¡×š ××™×©×•×¨ ×¡×•×¤×™ ×œ×¤× ×™ ××—×™×§×ª ×¨×™×¤×•, ××¤× ×” ×œ×œ×—×¦×Ÿ ××—×™×§×” ×¡×•×¤×™&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">repo</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×œ× × ×‘×—×¨ ×¨×™×¤×•&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ§¨ ×›×Ÿ, ××—×§ ×œ×¦××™×ª×•×ª&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;confirm_delete_repo&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×‘×™×˜×•×œ&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)],</span>
        <span class="p">]</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;âš ï¸ ××™×©×•×¨ ×¡×•×¤×™ ×œ××—×™×§×ª &lt;code&gt;</span><span class="si">{</span><span class="n">repo</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;×¤×¢×•×œ×” ×–×• ×ª××—×§ ×œ×¦××™×ª×•×ª ××ª ×”×¨×™×¤×• ×•×›×œ ×”×ª×•×›×Ÿ ×”××©×•×™×š ××œ×™×•.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;××™×Ÿ ×“×¨×š ×œ×©×—×–×¨ ×œ××—×¨ ××›×Ÿ.&quot;</span><span class="p">,</span>
            <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span>
            <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.confirm_delete_repo">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.confirm_delete_repo">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">confirm_delete_repo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;××‘×¦×¢ ××—×™×§×ª ×¨×™×¤×• ×©×œ× ×œ××—×¨ ××™×©×•×¨&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_name</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ × ×ª×•× ×™× ×—×¡×¨×™× ×œ××—×™×§×”&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span>
            <span class="n">owner</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_user</span><span class="p">()</span>
            <span class="c1"># ×•×“× ×©×œ××©×ª××© ×™×© ×”×¨×©××” ×œ××—×•×§</span>
            <span class="k">if</span> <span class="n">repo</span><span class="o">.</span><span class="n">owner</span><span class="o">.</span><span class="n">login</span> <span class="o">!=</span> <span class="n">owner</span><span class="o">.</span><span class="n">login</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ × ×™×ª×Ÿ ×œ××—×•×§ ×¨×§ ×¨×™×¤×• ×©××ª×” ×‘×¢×œ×™×•&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">repo</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="c1"># × ×§×” ×§××© ×¨×™×¤×•×–×™×˜×•×¨×™×– ×›×“×™ ×©×”×¨×©×™××” ×ª×¨×•×¢× ×Ÿ ×•×œ× ×ª×¦×™×’ ×¤×¨×™×˜×™× ×©× ××—×§×•</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;repos&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;repos_cache_time&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;âœ… ×”×¨×™×¤×• × ××—×§ ×‘×”×¦×œ×—×”: &lt;code&gt;</span><span class="si">{</span><span class="n">repo_name</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span>
            <span class="p">)</span>
            <span class="c1"># × ×§×” ×‘×—×™×¨×” ×œ××—×¨ ××—×™×§×”</span>
            <span class="n">session</span><span class="p">[</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error deleting repository: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘××—×™×§×ª ×¨×™×¤×•: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># ×œ××—×¨ ××—×™×§×”, ×•×“× ×©×§××© ×”×¨×©×™××•×ª ××™× ×• ××©××™×¨ ××ª ×”×¨×™×¤×• ×”×™×©×Ÿ</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;repos&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;repos_cache_time&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">github_menu_command</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.show_danger_delete_menu">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_danger_delete_menu">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">show_danger_delete_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;××¦×™×’ ×ª×¤×¨×™×˜ ××—×™×§×•×ª ××¡×•×›×Ÿ&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">repo</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×œ× × ×‘×—×¨ ×¨×™×¤×•&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ—‘ï¸ ××—×§ ×§×•×‘×¥ ××”×¨×™×¤×•&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;delete_file_menu&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;âš ï¸ ××—×§ ×¨×™×¤×• ×©×œ× (××ª×§×“×)&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;delete_repo_menu&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)],</span>
        <span class="p">]</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;ğŸ§¨ ×¤×¢×•×œ×•×ª ××—×™×§×” ×‘-&lt;code&gt;</span><span class="si">{</span><span class="n">repo</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">×‘×—×¨ ×¤×¢×•×œ×”:&quot;</span><span class="p">,</span>
            <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span>
            <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.show_download_file_menu">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_download_file_menu">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">show_download_file_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;××¦×™×’ ×ª×¤×¨×™×˜ ×”×•×¨×“×ª ×§×•×‘×¥ ××”×¨×™×¤×• (×“×¤×“×•×£ ×‘×›×¤×ª×•×¨×™×)&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">repo</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×œ× × ×‘×—×¨ ×¨×™×¤×•&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># ×”×ª×—×œ ×‘×“×¤×“×•×£ ××”-root ×‘××¦×‘ ×”×•×¨×“×” ×‘×œ×‘×“</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;download&quot;</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># ××¤×¡ ××¦×‘ ××—×™×§×” ×× ×”×•×¤×¢×œ ×§×•×“×</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;multi_mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;multi_selection&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;safe_delete&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_repo_browser</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>

<div class="viewcode-block" id="GitHubMenuHandler.show_repo_browser">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_repo_browser">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">show_repo_browser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">only_keyboard</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;××¦×™×’ ×“×¤×“×¤×Ÿ ×¨×™×¤×• ×œ×¤×™ × ×ª×™×‘ ×•×©×™××•×© (view/download/delete), ×›×•×œ×œ breadcrumbs ×•×¢×™××•×“.&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_name</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×—×¡×¨×™× × ×ª×•× ×™×&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;browse_path&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="c1"># ×§×‘×™×¢×ª ref × ×•×›×—×™ ×œ× ×™×•×•×˜ (×¢× ×£/×ª×’)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">current_ref</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;browse_ref&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="s2">&quot;default_branch&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;main&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">current_ref</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="s2">&quot;default_branch&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;main&quot;</span>
        <span class="c1"># ×§×‘×œ×ª ×ª×•×›×Ÿ ×”×ª×™×§×™×™×”</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="n">path</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">current_ref</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="n">path</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">contents</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="c1"># ×× ×–×” ×§×•×‘×¥ ×™×—×™×“, ×”×¤×•×š ×œ×¨×©×™××” ×œ×¦×•×¨×š ×ª×¦×•×’×”</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="p">[</span><span class="n">contents</span><span class="p">]</span>
        <span class="c1"># ×‘× ×™×™×ª ×¤×¨×™×˜×™× (×ª×™×§×™×•×ª ×§×•×“×, ××—×¨ ×›×š ×§×‘×¦×™×)</span>
        <span class="n">folders</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">contents</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;dir&quot;</span><span class="p">]</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">contents</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;file&quot;</span><span class="p">]</span>
        <span class="c1"># ×‘××¦×‘ ×‘×—×™×¨×ª ×ª×™×§×™×™×”, ×œ× × ×¦×™×’ ×§×‘×¦×™× ×›×œ×œ</span>
        <span class="n">folder_selecting</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;folder_select_mode&quot;</span><span class="p">))</span>
        <span class="n">entry_rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Breadcrumbs</span>
        <span class="n">crumbs_row</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">crumbs_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ  root&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mk_cb</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;browse_open&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">accum</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
                <span class="n">accum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
                <span class="n">crumbs_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mk_cb</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;browse_open&quot;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">accum</span><span class="p">))))</span>
        <span class="k">if</span> <span class="n">crumbs_row</span><span class="p">:</span>
            <span class="n">entry_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">crumbs_row</span><span class="p">)</span>
        <span class="c1"># ×©×•×¨×ª ×›×œ×™×: ×—×™×¤×•×© ×•×‘×—×™×¨×ª ref</span>
        <span class="n">tools_row</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ” ×—×¤×© ×‘×©× ×§×•×‘×¥&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;browse_search&quot;</span><span class="p">),</span>
            <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ğŸŒ¿ ref: </span><span class="si">{</span><span class="n">current_ref</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;browse_ref_menu&quot;</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="n">entry_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tools_row</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">folders</span><span class="p">:</span>
            <span class="c1"># ×ª××™×“ ××¦×™×’×™× ×¤×ª×™×—×ª ×ª×™×§×™×™×”; ××™×Ÿ ×¦×•×¨×š ×‘×›×¤×ª×•×¨ &quot;×‘×—×¨ ×›×™×¢×“&quot; (×”×•×¡×¨×” ×“×¨×™×©×ª×š)</span>
            <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ“‚ </span><span class="si">{</span><span class="n">folder</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mk_cb</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;browse_open&quot;</span><span class="p">,</span> <span class="n">folder</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="p">)]</span>
            <span class="n">entry_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="n">multi_mode</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;multi_mode&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;multi_selection&quot;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">folder_selecting</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">multi_mode</span><span class="p">:</span>
                    <span class="n">checked</span> <span class="o">=</span> <span class="s2">&quot;â˜‘ï¸&quot;</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">path</span> <span class="ow">in</span> <span class="n">selection</span> <span class="k">else</span> <span class="s2">&quot;â¬œï¸&quot;</span>
                    <span class="n">entry_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">checked</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;browse_toggle_select:</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                        <span class="p">]</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mode</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;browse_action&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;download&quot;</span><span class="p">:</span>
                        <span class="n">size_val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span>
                        <span class="n">large_flag</span> <span class="o">=</span> <span class="s2">&quot; âš ï¸&quot;</span> <span class="k">if</span> <span class="n">size_val</span> <span class="ow">and</span> <span class="n">size_val</span> <span class="o">&gt;</span> <span class="n">MAX_INLINE_FILE_BYTES</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                        <span class="n">entry_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">[</span>
                                <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;â¬‡ï¸ </span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="si">}{</span><span class="n">large_flag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                    <span class="n">callback_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mk_cb</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;browse_select_download&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">path</span><span class="p">),</span>
                                <span class="p">)</span>
                            <span class="p">]</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;view&quot;</span><span class="p">:</span>
                        <span class="c1"># ×”×¡×¨ ×›×¤×ª×•×¨ &quot;×©×ª×£ ×§×™×©×•×¨&quot; ××¨×©×™××”; × ×©××™×¨ ×¨×§ ×‘××¡×š ×”×ª×¦×•×’×”</span>
                        <span class="n">entry_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">[</span>
                                <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;ğŸ‘ï¸ </span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mk_cb</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;browse_select_view&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
                                <span class="p">)</span>
                            <span class="p">]</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># ×‘××¦×‘ ×©××™× ×• download ×•××™× ×• view â€” ×–×” ××¦×‘ delete ×‘×œ×‘×“</span>
                        <span class="n">entry_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">[</span>
                                <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;ğŸ—‘ï¸ </span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mk_cb</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;browse_select_delete&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
                                <span class="p">)</span>
                            <span class="p">]</span>
                        <span class="p">)</span>
        <span class="c1"># ×•×“× ×“×’×œ×™× ×‘×¨×™×¨×ª ××—×“×œ ×›×“×™ ×œ×× ×•×¢ ×©×’×™××•×ª ×‘× ×™×•×•×˜</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;browse_page&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;multi_mode&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;multi_mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># ×¢×™××•×“</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">config</span><span class="w"> </span><span class="kn">import</span> <span class="n">config</span> <span class="k">as</span> <span class="n">_cfg</span>  <span class="c1"># type: ignore</span>
            <span class="n">page_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">_cfg</span><span class="p">,</span> <span class="s1">&#39;UI_PAGE_SIZE&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">page_size</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="c1"># ×•×“× ×©×©×•×¨×ª ×”×›×œ×™× (×—×™×¤×•×©/×‘×—×™×¨×ª ref) ×ª××™×“ × ×©××¨×ª ×‘×¨××© ×›×œ ×¢××•×“</span>
        <span class="c1"># × ×‘× ×” ××ª ×”××˜×¨×™×¦×” ×›×š ×©×”×©×•×¨×” ×”×¨××©×•× ×” ×ª×”×™×” ×ª××™×“ ×”×›×œ×™×, ×•×œ× ×ª×™×¡×¤×¨ ×œ×¢×™××•×“</span>
        <span class="c1"># ××¦× ××™× ×“×§×¡ ×ª×—×™×œ×ª ×”×¤×¨×™×˜×™× ×œ×¢×™××•×“ ××—×¨×™ breadcrumbs ×•×©×•×¨×ª ×›×œ×™×</span>
        <span class="c1"># breadcrumbs × ××¦××ª ×‘-entry_rows[0] (×× ×§×™×™××ª), ×•×©×•×¨×ª ×›×œ×™× ×‘-entry_rows[1]</span>
        <span class="n">start_items_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">entry_rows</span><span class="p">:</span>
            <span class="c1"># ×× ×™×© breadcrumbs, ×”× ×‘××™× ×“×§×¡ 0</span>
            <span class="n">start_items_index</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="c1"># ×× ×™×© ×’× ×©×•×¨×ª ×›×œ×™×, ×”×™× ×‘××™× ×“×§×¡ 1</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">entry_rows</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">btn</span><span class="p">,</span> <span class="n">InlineKeyboardButton</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">btn</span><span class="p">,</span> <span class="s1">&#39;callback_data&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;browse_search&#39;</span>
                <span class="k">for</span> <span class="n">btn</span> <span class="ow">in</span> <span class="n">entry_rows</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="n">start_items_index</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">paginable_rows</span> <span class="o">=</span> <span class="n">entry_rows</span><span class="p">[</span><span class="n">start_items_index</span><span class="p">:]</span>
        <span class="n">total_items</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">paginable_rows</span><span class="p">)</span>
        <span class="n">total_pages</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">total_items</span> <span class="o">+</span> <span class="n">page_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">page_size</span><span class="p">)</span>
        <span class="n">current_page</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;browse_page&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span> <span class="n">total_pages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">start_index</span> <span class="o">=</span> <span class="n">current_page</span> <span class="o">*</span> <span class="n">page_size</span>
        <span class="n">end_index</span> <span class="o">=</span> <span class="n">start_index</span> <span class="o">+</span> <span class="n">page_size</span>
        <span class="c1"># ×‘× ×” ××§×œ×“×ª: breadcrumbs (×× ×§×™×™××ª) + ×©×•×¨×ª ×›×œ×™× + ×¤×¨×™×˜×™ ×”×¢××•×“</span>
        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">entry_rows</span> <span class="ow">and</span> <span class="n">start_items_index</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry_rows</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># breadcrumbs</span>
        <span class="k">if</span> <span class="n">entry_rows</span> <span class="ow">and</span> <span class="n">start_items_index</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry_rows</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># tools row (×›×•×œ×œ ×—×™×¤×•×©)</span>
        <span class="n">keyboard</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">paginable_rows</span><span class="p">[</span><span class="n">start_index</span><span class="p">:</span><span class="n">end_index</span><span class="p">])</span>
        <span class="c1"># × ×™×•×•×˜ ×¢××•×“×™×</span>
        <span class="k">if</span> <span class="n">total_pages</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">nav_row</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">current_page</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">nav_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;â¬…ï¸ ×”×§×•×“×&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;browse_page:</span><span class="si">{</span><span class="n">current_page</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">nav_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;×¢××•×“ </span><span class="si">{</span><span class="n">current_page</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total_pages</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;noop&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">current_page</span> <span class="o">&lt;</span> <span class="n">total_pages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">nav_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;×”×‘× â¡ï¸&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;browse_page:</span><span class="si">{</span><span class="n">current_page</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nav_row</span><span class="p">)</span>
        <span class="c1"># ×©×•×¨×” ×ª×—×ª×•× ×”</span>
        <span class="n">bottom</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
            <span class="c1"># ×—×–×¨×” ×œ××¢×œ×”</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">bottom</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;â¬†ï¸ ×œ××¢×œ×”&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mk_cb</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;browse_open&quot;</span><span class="p">,</span> <span class="n">parent</span><span class="p">)))</span>
        <span class="c1"># ×›×¤×ª×•×¨ ×—×–×¨×”/×¡×™×•× ×œ×‘×—×™×¨×ª ×ª×™×§×™×™×”</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;folder_select_mode&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;session&quot;</span><span class="p">:</span>
            <span class="n">bottom</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;âœ… ×¡×™×•× ×‘×—×™×¨×”&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;folder_select_done&quot;</span><span class="p">))</span>
            <span class="n">bottom</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×‘×™×˜×•×œ&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">))</span>
            <span class="c1"># ×”×•×¡×£ ×›×¤×ª×•×¨ ×™×¦×™×¨×ª ×ª×™×§×™×™×” ×—×“×©×” ×‘××¦×‘ ×‘×—×™×¨×ª ×ª×™×§×™×™×”</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;â• ×¦×•×¨ ×ª×™×§×™×™×” ×—×“×©×”&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;create_folder&quot;</span><span class="p">)])</span>
        <span class="c1"># ×¡×“×¨ ×›×¤×ª×•×¨×™× ×œ×©×•×¨×•×ª ×›×“×™ ×œ×× ×•×¢ ×¦×¤×™×¤×•×ª</span>
        <span class="n">row</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">folder_selecting</span><span class="p">)</span> <span class="ow">and</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;browse_action&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;download&quot;</span><span class="p">:</span>
            <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ“¦ ×”×•×¨×“ ×ª×™×§×™×™×” ×›Ö¾ZIP&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mk_cb</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;download_zip&quot;</span><span class="p">,</span> <span class="n">path</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="n">row</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">folder_selecting</span><span class="p">)</span> <span class="ow">and</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;browse_action&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;download&quot;</span><span class="p">:</span>
            <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”— ×©×ª×£ ×§×™×©×•×¨ ×œ×ª×™×§×™×™×”&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mk_cb</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;share_folder_link&quot;</span><span class="p">,</span> <span class="n">path</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">folder_selecting</span><span class="p">:</span>
            <span class="c1"># ×‘××¦×‘ ×”×•×¨×“×” ×œ× ××¦×™×’×™× ×›×œ×œ ×›×¤×ª×•×¨×™ ××—×™×§×”/×‘×—×™×¨×” ××¨×•×‘×” ×œ××—×™×§×”</span>
            <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;browse_action&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;download&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">multi_mode</span><span class="p">:</span>
                    <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                    <span class="n">row</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ“¦ ×”×•×¨×“ × ×‘×—×¨×™× ×›Ö¾ZIP&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;multi_execute&quot;</span><span class="p">))</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”— ×©×ª×£ ×§×™×©×•×¨×™× ×œ× ×‘×—×¨×™×&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;share_selected_links&quot;</span><span class="p">))</span>
                    <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                    <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;â™»ï¸ × ×§×” ×‘×—×™×¨×”&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;multi_clear&quot;</span><span class="p">),</span> <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸš« ×‘×˜×œ ××¦×‘ ××¨×•×‘×”&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;multi_toggle&quot;</span><span class="p">)]</span>
                    <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;âœ… ×‘×—×¨ ××¨×•×‘×™×&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;multi_toggle&quot;</span><span class="p">))</span>
                    <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># ××¦×‘ delete/view â€“ ×”×ª× ×”×’×•×ª ×§×™×™××ª</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">multi_mode</span><span class="p">:</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;âœ… ×‘×—×¨ ××¨×•×‘×™×&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;multi_toggle&quot;</span><span class="p">))</span>
                    <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                    <span class="n">row</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">safe_label</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;××¦×‘ ××—×™×§×” ×‘×˜×•×—: ×¤×¢×™×œ&quot;</span> <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;safe_delete&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;××¦×‘ ××—×™×§×” ×‘×˜×•×—: ×›×‘×•×™&quot;</span>
                    <span class="p">)</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">safe_label</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;safe_toggle&quot;</span><span class="p">))</span>
                    <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                    <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ—‘ï¸ ××—×§ × ×‘×—×¨×™×&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;multi_execute&quot;</span><span class="p">),</span> <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”— ×©×ª×£ ×§×™×©×•×¨×™× ×œ× ×‘×—×¨×™×&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;share_selected_links&quot;</span><span class="p">)]</span>
                    <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                    <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;â™»ï¸ × ×§×” ×‘×—×™×¨×”&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;multi_clear&quot;</span><span class="p">),</span> <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸš« ×‘×˜×œ ××¦×‘ ××¨×•×‘×”&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;multi_toggle&quot;</span><span class="p">)]</span>
                    <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×¨×”&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">bottom</span><span class="p">:</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bottom</span><span class="p">)</span>
        <span class="c1"># ×˜×§×¡×˜</span>
        <span class="n">_mode</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;browse_action&quot;</span><span class="p">)</span>
        <span class="n">action</span> <span class="o">=</span> <span class="s2">&quot;×ª×¦×•×’×”&quot;</span> <span class="k">if</span> <span class="n">_mode</span> <span class="o">==</span> <span class="s2">&quot;view&quot;</span> <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;×”×•×¨×“×”&quot;</span> <span class="k">if</span> <span class="n">_mode</span> <span class="o">==</span> <span class="s2">&quot;download&quot;</span> <span class="k">else</span> <span class="s2">&quot;××—×™×§×”&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">only_keyboard</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">TelegramUtils</span><span class="o">.</span><span class="n">safe_edit_message_reply_markup</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">))</span>
                <span class="k">return</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">if</span> <span class="n">folder_selecting</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">TelegramUtils</span><span class="o">.</span><span class="n">safe_edit_message_text</span><span class="p">(</span>
                    <span class="n">query</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;ğŸ“ ×“×¤×“×•×£ ×¨×™×¤×•: &lt;code&gt;</span><span class="si">{</span><span class="n">repo_name</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;ğŸ”€ ref: &lt;code&gt;</span><span class="si">{</span><span class="n">current_ref</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;ğŸ“‚ × ×ª×™×‘: &lt;code&gt;/</span><span class="si">{</span><span class="n">path</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;×‘×—×¨ ×ª×™×§×™×™×” ×™×¢×“ ××• ×¤×ª×— ×ª×™×§×™×™×” (××¦×™×’ </span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="n">page_size</span><span class="p">,</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">total_items</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_index</span><span class="p">))</span><span class="si">}</span><span class="s2"> ××ª×•×š </span><span class="si">{</span><span class="n">total_items</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span>
                    <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">TelegramUtils</span><span class="o">.</span><span class="n">safe_edit_message_text</span><span class="p">(</span>
                    <span class="n">query</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;ğŸ“ ×“×¤×“×•×£ ×¨×™×¤×•: &lt;code&gt;</span><span class="si">{</span><span class="n">repo_name</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;ğŸ”€ ref: &lt;code&gt;</span><span class="si">{</span><span class="n">current_ref</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;ğŸ“‚ × ×ª×™×‘: &lt;code&gt;/</span><span class="si">{</span><span class="n">path</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;×‘×—×¨ ×§×•×‘×¥ ×œ</span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2"> ××• ×¤×ª×— ×ª×™×§×™×™×” (××¦×™×’ </span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="n">page_size</span><span class="p">,</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">total_items</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_index</span><span class="p">))</span><span class="si">}</span><span class="s2"> ××ª×•×š </span><span class="si">{</span><span class="n">total_items</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span>
                    <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">folder_selecting</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;ğŸ“ ×“×¤×“×•×£ ×¨×™×¤×•: &lt;code&gt;</span><span class="si">{</span><span class="n">repo_name</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;ğŸ”€ ref: &lt;code&gt;</span><span class="si">{</span><span class="n">current_ref</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;ğŸ“‚ × ×ª×™×‘: &lt;code&gt;/</span><span class="si">{</span><span class="n">path</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;×‘×—×¨ ×ª×™×§×™×™×” ×™×¢×“ ××• ×¤×ª×— ×ª×™×§×™×™×” (××¦×™×’ </span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="n">page_size</span><span class="p">,</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">total_items</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_index</span><span class="p">))</span><span class="si">}</span><span class="s2"> ××ª×•×š </span><span class="si">{</span><span class="n">total_items</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span>
                    <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;ğŸ“ ×“×¤×“×•×£ ×¨×™×¤×•: &lt;code&gt;</span><span class="si">{</span><span class="n">repo_name</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;ğŸ”€ ref: &lt;code&gt;</span><span class="si">{</span><span class="n">current_ref</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;ğŸ“‚ × ×ª×™×‘: &lt;code&gt;/</span><span class="si">{</span><span class="n">path</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;×‘×—×¨ ×§×•×‘×¥ ×œ</span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2"> ××• ×¤×ª×— ×ª×™×§×™×™×” (××¦×™×’ </span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="n">page_size</span><span class="p">,</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">total_items</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_index</span><span class="p">))</span><span class="si">}</span><span class="s2"> ××ª×•×š </span><span class="si">{</span><span class="n">total_items</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">,</span>
                        <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span>
                        <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                        <span class="k">raise</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.handle_inline_query">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.handle_inline_query">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_inline_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Inline mode: ×—×™×¤×•×©/×‘×™×¦×•×¢ ×¤×¢×•×œ×•×ª ×™×©×™×¨×•×ª ××›×œ ×¦&#39;××˜&quot;&quot;&quot;</span>
        <span class="n">inline_query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">inline_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">inline_query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="p">(</span><span class="n">inline_query</span><span class="o">.</span><span class="n">query</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_name</span><span class="p">):</span>
            <span class="c1"># ×‘×§×© ××”××©×ª××© ×œ×‘×—×•×¨ ×¨×™×¤×•</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">InlineQueryResultArticle</span><span class="p">(</span>
                    <span class="nb">id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;help-no-repo&quot;</span><span class="p">,</span>
                    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;×‘×—×¨/×”×ª×—×‘×¨ ×œ×¨×™×¤×• ×œ×¤× ×™ ×©×™××•×© ×‘××™× ×œ×™×™×Ÿ&quot;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;×©×œ×— /github ×œ×‘×—×™×¨×ª ×¨×™×¤×• ×•/××• ×”×ª×—×‘×¨×•×ª&quot;</span><span class="p">,</span>
                    <span class="n">input_message_content</span><span class="o">=</span><span class="n">InputTextMessageContent</span><span class="p">(</span>
                        <span class="s2">&quot;ğŸ”§ ×©×œ×— /github ×œ×‘×—×™×¨×ª ×¨×™×¤×• ×•×œ×”×ª×—×‘×¨×•×ª ×œ-GitHub&quot;</span>
                    <span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="n">inline_query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">cache_time</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">is_personal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span>
        <span class="c1"># ×œ×œ× ×§×œ×˜: ××œ ×ª×—×–×™×¨ ×ª×•×¦××•×ª (××‘×˜×œ &#39;×¤×§×•×“×•×ª&#39; ××™× ×œ×™×™×Ÿ ××™×•×ª×¨×•×ª)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">q</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">inline_query</span><span class="o">.</span><span class="n">answer</span><span class="p">([],</span> <span class="n">cache_time</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">is_personal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># ×¤×¨×¡×•×¨ ×¤×©×•×˜: zip &lt;path&gt; / file &lt;path&gt; ××• × ×ª×™×‘ ×™×©×™×¨</span>
        <span class="n">is_zip</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">is_file</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">q</span>
        <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;zip &quot;</span><span class="p">):</span>
            <span class="c1"># ××‘×˜×œ×™× ×ª××™×›×ª zip ×‘××™× ×œ×™×™×Ÿ</span>
            <span class="k">await</span> <span class="n">inline_query</span><span class="o">.</span><span class="n">answer</span><span class="p">([],</span> <span class="n">cache_time</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">is_personal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">q</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;file &quot;</span><span class="p">):</span>
            <span class="n">is_file</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="c1"># ×ª×™×§×™×™×”</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">contents</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="c1"># ×”×¦×’ ×›××” ×§×‘×¦×™× ×¨××©×•× ×™× ×‘×ª×™×§×™×™×” ×œ×”×•×¨×“×” ××”×™×¨×” (×œ×œ× ×”×¦×¢×ª ZIP)</span>
                <span class="n">shown</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">contents</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;file&quot;</span><span class="p">:</span>
                        <span class="n">size_str</span> <span class="o">=</span> <span class="n">format_bytes</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">InlineQueryResultArticle</span><span class="p">(</span>
                                <span class="nb">id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;file-</span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;â¬‡ï¸ </span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">size_str</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
                                <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                <span class="n">input_message_content</span><span class="o">=</span><span class="n">InputTextMessageContent</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;×§×•×‘×¥: /</span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="p">),</span>
                                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span>
                                    <span class="p">[</span>
                                        <span class="p">[</span>
                                            <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                                        <span class="s2">&quot;ğŸ“© ×”×•×¨×“&quot;</span><span class="p">,</span>
                                                <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;inline_download_file:</span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                            <span class="p">)</span>
                                        <span class="p">]</span>
                                    <span class="p">]</span>
                                <span class="p">),</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">shown</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">shown</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>
                            <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># ×§×•×‘×¥ ×‘×•×“×“</span>
                <span class="n">size_str</span> <span class="o">=</span> <span class="n">format_bytes</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">contents</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
                <span class="c1"># × ×¡×” ×œ×”×•×¦×™× snippet ×§×¦×¨ ××”×ª×•×›×Ÿ (×œ×œ× ×¢×œ×•×ª ×’×‘×•×”×” ××“×™)</span>
                <span class="n">snippet</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">raw</span> <span class="o">=</span> <span class="n">contents</span><span class="o">.</span><span class="n">decoded_content</span> <span class="ow">or</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">)</span>
                    <span class="c1"># ×§×— 3 ×©×•×¨×•×ª ×¨××©×•× ×•×ª/×¢×“ 180 ×ª×•×•×™×</span>
                    <span class="n">first_lines</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[:</span><span class="mi">3</span><span class="p">])</span>
                    <span class="n">snippet</span> <span class="o">=</span> <span class="n">first_lines</span><span class="p">[:</span><span class="mi">180</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot; â &quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">snippet</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">desc</span> <span class="o">=</span> <span class="n">snippet</span> <span class="k">if</span> <span class="n">snippet</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">InlineQueryResultArticle</span><span class="p">(</span>
                        <span class="nb">id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;file-</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;â¬‡ï¸ ×”×•×¨×“: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">contents</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">size_str</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
                        <span class="n">description</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span>
                        <span class="n">input_message_content</span><span class="o">=</span><span class="n">InputTextMessageContent</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;×§×•×‘×¥: /</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                        <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span>
                            <span class="p">[</span>
                                <span class="p">[</span>
                                    <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                                        <span class="s2">&quot;ğŸ“© ×”×•×¨×“&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;inline_download_file:</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span>
                                    <span class="p">)</span>
                                <span class="p">]</span>
                            <span class="p">]</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># ×”×—×–×¨ ×¨×§ ×ª×•×¦××ª ×§×•×‘×¥ ×× × ×ª×‘×§×©×” ××¤×•×¨×©×•×ª</span>
            <span class="k">if</span> <span class="n">is_file</span> <span class="ow">and</span> <span class="n">path</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">InlineQueryResultArticle</span><span class="p">(</span>
                        <span class="nb">id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;file-maybe-</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;â¬‡ï¸ ×§×•×‘×¥: /</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;× ×™×¡×™×•×Ÿ ×”×•×¨×“×” ×œ×§×•×‘×¥ (×× ×§×™×™×)&quot;</span><span class="p">,</span>
                        <span class="n">input_message_content</span><span class="o">=</span><span class="n">InputTextMessageContent</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;×§×•×‘×¥: /</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                        <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span>
                            <span class="p">[</span>
                                <span class="p">[</span>
                                    <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                                        <span class="s2">&quot;ğŸ“© ×”×•×¨×“&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;inline_download_file:</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span>
                                    <span class="p">)</span>
                                <span class="p">]</span>
                            <span class="p">]</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># ×‘×œ×™ ×”×•×“×¢×•×ª ×¢×–×¨×”/×“××” â€“ × ×—×–×™×¨ ×¨×™×§</span>
                <span class="k">pass</span>
        <span class="k">await</span> <span class="n">inline_query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="n">results</span><span class="p">[:</span><span class="mi">50</span><span class="p">],</span> <span class="n">cache_time</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">is_personal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.show_notifications_menu">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_notifications_menu">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">show_notifications_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×‘×—×¨ ×¨×™×¤×• ×§×•×“× (/github)&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;notifications&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">enabled</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;enabled&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">pr_on</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pr&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">issues_on</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;issues&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">interval</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;interval&quot;</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
        <span class="c1"># ×”×¦×’×ª ××¨×•×•×— ×–××Ÿ: ×× ×¤×—×•×ª ××“×§×”, ×”×¦×’ ×‘×©× ×™×•×ª; ××—×¨×ª ×‘×“×§×•×ª (×œ×œ× ×”××™×œ×” &quot;×ª×“×™×¨×•×ª&quot;)</span>
        <span class="n">freq_display</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">interval</span><span class="si">}</span><span class="s2"> ×©× ×³&quot;</span> <span class="k">if</span> <span class="n">interval</span> <span class="o">&lt;</span> <span class="mi">60</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">interval</span><span class="o">/</span><span class="mi">60</span><span class="p">)</span><span class="si">}</span><span class="s2"> ×“×³&quot;</span>
        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)],</span>
            <span class="p">[</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                    <span class="s2">&quot;×”×¤×¢×œ&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">enabled</span> <span class="k">else</span> <span class="s2">&quot;×›×‘×”&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;notifications_toggle&quot;</span>
                <span class="p">)</span>
            <span class="p">],</span>
            <span class="p">[</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;PRs: </span><span class="si">{</span><span class="s1">&#39;×¤×¢×™×œ&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">pr_on</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;×›×‘×•×™&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;notifications_toggle_pr&quot;</span>
                <span class="p">)</span>
            <span class="p">],</span>
            <span class="p">[</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Issues: </span><span class="si">{</span><span class="s1">&#39;×¤×¢×™×œ&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">issues_on</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;×›×‘×•×™&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;notifications_toggle_issues&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">],</span>
            <span class="p">[</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;30×©× ×³&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;notifications_interval_30&quot;</span><span class="p">),</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;2×“×³&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;notifications_interval_120&quot;</span><span class="p">),</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;5×“×³&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;notifications_interval_300&quot;</span><span class="p">),</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;15×“×³&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;notifications_interval_900&quot;</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;×‘×“×•×§ ×¢×›×©×™×•&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;notifications_check_now&quot;</span><span class="p">)],</span>
        <span class="p">]</span>
        <span class="c1"># ×›×¤×ª×•×¨ ×‘×“×™×§×ª Sentry ×œ××“××™× ×™× ×‘×œ×‘×“</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">is_admin</span> <span class="o">=</span> <span class="n">user_id</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;ADMIN_USER_IDS&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">is_admin</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># ×”×¦×’ ××ª ×›×¤×ª×•×¨ ×‘×“×™×§×ª Sentry ×¨×§ ×›×©×××•×¤×©×¨ ×‘××¤×•×¨×©</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sentry_btn_enabled</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;SENTRY_TEST_BUTTON_ENABLED&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">sentry_btn_enabled</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">is_admin</span> <span class="ow">and</span> <span class="n">sentry_btn_enabled</span><span class="p">:</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ§ª ×©×œ×— ××™×¨×•×¢ ×‘×“×™×§×” ×œâ€‘Sentry&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;notifications_sentry_test&quot;</span><span class="p">)])</span>
        <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;ğŸ”” ×”×ª×¨××•×ª ×œ×¨×™×¤×•: &lt;code&gt;</span><span class="si">{</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;selected_repo&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;××¦×‘: </span><span class="si">{</span><span class="s1">&#39;×¤×¢×™×œ&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">enabled</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;×›×‘×•×™&#39;</span><span class="si">}</span><span class="s2"> | â± </span><span class="si">{</span><span class="n">freq_display</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;×”×ª×¨××•×ª = ×‘×“×™×§×ª PRs/Issues ×—×“×©×™×/×©×¢×•×“×›× ×• ×•×©×™×’×•×¨ ×”×•×“×¢×” ××œ×™×š.&quot;</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="n">text</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># ×”×ª×¢×œ× ×× ×”×ª×•×›×Ÿ ×œ× ×”×©×ª× ×”</span>
            <span class="k">if</span> <span class="s2">&quot;Message is not modified&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                <span class="k">raise</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.toggle_notifications">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.toggle_notifications">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">toggle_notifications</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
            <span class="s2">&quot;notifications&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;enabled&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;pr&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;issues&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;interval&quot;</span><span class="p">:</span> <span class="mi">300</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;enabled&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;enabled&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># × ×™×”×•×œ job</span>
        <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;notif_</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">jq</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;job_queue&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">application</span><span class="p">,</span> <span class="s2">&quot;job_queue&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">jq</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jq</span><span class="o">.</span><span class="n">get_jobs_by_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="n">job</span><span class="o">.</span><span class="n">schedule_removal</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;enabled&quot;</span><span class="p">]:</span>
                <span class="n">jq</span><span class="o">.</span><span class="n">run_repeating</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_notifications_job</span><span class="p">,</span>
                    <span class="n">interval</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;interval&quot;</span><span class="p">,</span> <span class="mi">300</span><span class="p">),</span>
                    <span class="n">first</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">},</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;××–×”×¨×”: JobQueue ×œ× ×–××™×Ÿ â€” ×”×ª×¨××•×ª ×œ× ×™×¨×•×¦×• ×‘×¨×§×¢&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_notifications_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.toggle_notifications_pr">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.toggle_notifications_pr">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">toggle_notifications_pr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
            <span class="s2">&quot;notifications&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;enabled&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;pr&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;issues&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;interval&quot;</span><span class="p">:</span> <span class="mi">300</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;pr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pr&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_notifications_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.toggle_notifications_issues">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.toggle_notifications_issues">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">toggle_notifications_issues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
            <span class="s2">&quot;notifications&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;enabled&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;pr&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;issues&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;interval&quot;</span><span class="p">:</span> <span class="mi">300</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;issues&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;issues&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_notifications_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.set_notifications_interval">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.set_notifications_interval">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">set_notifications_interval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
            <span class="s2">&quot;notifications&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;enabled&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;pr&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;issues&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;interval&quot;</span><span class="p">:</span> <span class="mi">300</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">interval</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">interval</span> <span class="o">=</span> <span class="mi">300</span>
        <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;interval&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">interval</span>
        <span class="c1"># ×¢×“×›×Ÿ job ×× ×§×™×™×</span>
        <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;notif_</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">jq</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;job_queue&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">application</span><span class="p">,</span> <span class="s2">&quot;job_queue&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">jq</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jq</span><span class="o">.</span><span class="n">get_jobs_by_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="n">job</span><span class="o">.</span><span class="n">schedule_removal</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;enabled&quot;</span><span class="p">):</span>
                <span class="n">jq</span><span class="o">.</span><span class="n">run_repeating</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_notifications_job</span><span class="p">,</span>
                    <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">,</span>
                    <span class="n">first</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">},</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;××–×”×¨×”: JobQueue ×œ× ×–××™×Ÿ â€” ×”×ª×¨××•×ª ×œ× ×™×¨×•×¦×• ×‘×¨×§×¢&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_notifications_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.notifications_check_now">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.notifications_check_now">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">notifications_check_now</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;×‘×•×“×§ ×¢×›×©×™×•...&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_notifications_job</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_notifications_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;Message is not modified&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                <span class="k">raise</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.notifications_sentry_test">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.notifications_sentry_test">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">notifications_sentry_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×©×•×œ×— ××™×¨×•×¢ ×‘×“×™×§×” ×œâ€‘Sentry (××“××™× ×™× ×‘×œ×‘×“).&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;notifications_sentry_test: received&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">user_id</span><span class="p">)})</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="c1"># ×”×¨×©××”: ×¨×§ ××“××™×Ÿ</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">is_admin</span> <span class="o">=</span> <span class="n">user_id</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;ADMIN_USER_IDS&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">is_admin</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_admin</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;notifications_sentry_test: blocked_not_admin&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">user_id</span><span class="p">)})</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;××™×Ÿ ×”×¨×©××”&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">return</span>
        <span class="c1"># ×¤×™×¦&#39;×¨ ×›×‘×•×™ ×›×‘×¨×™×¨×ª ××—×“×œ â€“ ××œ ×ª×‘×¦×¢ ×× ×œ× ×××•×¤×©×¨</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">enabled_flag</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;SENTRY_TEST_BUTTON_ENABLED&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">enabled_flag</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;notifications_sentry_test: disabled_by_flag&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">user_id</span><span class="p">)})</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;×”×¤×™×¦×³×¨ ×× ×•×˜×¨×œ&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">return</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># ×¦×•×¨ ×—×¨×™×’×” ×™×–×•××” ×•×©×œ×— ×œ×¡× ×˜×¨×™ ×¢× Stacktrace</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Sentry test: manual button&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;sentry test button&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>  <span class="c1"># pragma: no cover - ×ª×œ×•×™ ×‘× ×•×›×—×•×ª sentry_sdk</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">sentry_sdk</span>  <span class="c1"># type: ignore</span>
                <span class="n">sentry_sdk</span><span class="o">.</span><span class="n">capture_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>  <span class="c1"># type: ignore[attr-defined]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;× ×©×œ×— ××™×¨×•×¢ ×‘×“×™×§×” ×œâ€‘Sentry&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;notifications_sentry_test: toast_sent&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">user_id</span><span class="p">)})</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="c1"># ×¨×¢× ×Ÿ ×ª×¤×¨×™×˜</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_notifications_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;Message is not modified&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                <span class="k">raise</span></div>


    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_notifications_job</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># × ×ª×‘ ×‘×“×™×§×” ×™×–×•××”: ×× ××•×¤×¢×œ ENV ×•×‘×•×¦×¢×” ×‘×§×©×” ×™×–×•××” (force=True),</span>
            <span class="c1"># ×–×¨×•×§ ×—×¨×™×’×” ××‘×•×§×¨×ª ×›×“×™ ×œ×××ª ××™× ×˜×’×¨×¦×™×™×ª Sentry ××™×“, ×œ×œ× ×”××ª× ×” ×œ××™×¨×•×¢ ×××™×ª×™.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_flag</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SENTRY_TEST_NOTIFICATIONS_JOB&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="s2">&quot;on&quot;</span><span class="p">}</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">_flag</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">force</span> <span class="ow">and</span> <span class="n">_flag</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Sentry test: notifications job forced error&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">job</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;job&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">job</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="n">user_id</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">user_id</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">running_key</span> <span class="o">=</span> <span class="s2">&quot;_notifications_running&quot;</span>
            <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">running_key</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;notifications job skipped (already running)&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">user_id</span><span class="p">)})</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">return</span>
            <span class="n">session</span><span class="p">[</span><span class="n">running_key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
                <span class="n">settings</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;notifications&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">application</span><span class="p">,</span> <span class="s2">&quot;user_data&quot;</span><span class="p">)</span>
                    <span class="k">else</span> <span class="kc">None</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">settings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">settings</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;notifications&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">settings</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_name</span><span class="p">):</span>
                    <span class="k">return</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">settings</span> <span class="ow">and</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;enabled&quot;</span><span class="p">)):</span>
                    <span class="k">return</span>
                <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span>
                <span class="c1"># × ×”×œ ×–×™×›×¨×•×Ÿ &quot;× ×‘×“×§ ×œ××—×¨×•× ×”&quot;</span>
                <span class="n">last</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;notifications_last&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;pr&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;issues&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>
                <span class="n">messages</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1"># PRs</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pr&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                    <span class="n">last_pr_check_time</span> <span class="o">=</span> <span class="n">last</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pr&quot;</span><span class="p">)</span>
                    <span class="c1"># If this is the first run (no baseline), set a baseline without sending backlog</span>
                    <span class="k">if</span> <span class="n">last_pr_check_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">session</span><span class="p">[</span><span class="s2">&quot;notifications_last&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;notifications_last&quot;</span><span class="p">,</span> <span class="p">{})</span>
                        <span class="n">session</span><span class="p">[</span><span class="s2">&quot;notifications_last&quot;</span><span class="p">][</span><span class="s2">&quot;pr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pulls</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_pulls</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="s2">&quot;updated&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;desc&quot;</span><span class="p">)</span>
                        <span class="n">seen_prs</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;notifications_seen_prs&quot;</span><span class="p">,</span> <span class="p">{})</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">interval_seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;interval&quot;</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">300</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="n">interval_seconds</span> <span class="o">=</span> <span class="mi">300</span>
                        <span class="n">interval_seconds</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">interval_seconds</span><span class="p">)</span>
                        <span class="n">cooldown_seconds</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">_PR_UPDATE_MIN_COOLDOWN_SECONDS</span><span class="p">,</span> <span class="n">interval_seconds</span><span class="p">)</span>
                        <span class="n">baseline_dt</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">last_pr_check_time</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
                            <span class="n">baseline_dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_utc_aware</span><span class="p">(</span><span class="n">last_pr_check_time</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">baseline_dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_seen_pr_timestamp</span><span class="p">(</span><span class="n">last_pr_check_time</span><span class="p">)</span>
                        <span class="n">latest_processed_pr_ts</span> <span class="o">=</span> <span class="n">baseline_dt</span>
                        <span class="k">for</span> <span class="n">pr</span> <span class="ow">in</span> <span class="n">pulls</span><span class="p">[:</span><span class="mi">10</span><span class="p">]:</span>
                            <span class="n">updated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_utc_aware</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">pr</span><span class="p">,</span> <span class="s2">&quot;updated_at&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">updated</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span>
                                <span class="n">latest_processed_pr_ts</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">updated</span> <span class="o">&gt;</span> <span class="n">latest_processed_pr_ts</span>
                            <span class="p">):</span>
                                <span class="n">latest_processed_pr_ts</span> <span class="o">=</span> <span class="n">updated</span>
                            <span class="c1"># ×× ××™×Ÿ updated ××• ×©××™×Ÿ ××¤×©×¨×•×ª ×”×©×•×•××” â€” ×¢×¦×•×¨ ×›×“×™ ×œ×× ×•×¢ ×¢×™×‘×•×“ ×™×ª×¨ ×©×œ ×¤×¨×™×˜×™× ×™×©× ×™×</span>
                            <span class="k">if</span> <span class="n">baseline_dt</span> <span class="ow">and</span> <span class="p">(</span><span class="n">updated</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">updated</span> <span class="o">&lt;=</span> <span class="n">baseline_dt</span><span class="p">):</span>
                                <span class="k">break</span>
                            <span class="n">pr_number</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pr</span><span class="p">,</span> <span class="s2">&quot;number&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                            <span class="n">dedup_key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pr_number</span><span class="p">)</span> <span class="k">if</span> <span class="n">pr_number</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
                            <span class="n">last_seen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_seen_pr_timestamp</span><span class="p">(</span>
                                <span class="n">seen_prs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dedup_key</span><span class="p">)</span> <span class="k">if</span> <span class="n">dedup_key</span> <span class="k">else</span> <span class="kc">None</span>
                            <span class="p">)</span>
                            <span class="k">if</span> <span class="n">last_seen</span> <span class="ow">and</span> <span class="n">updated</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">updated</span> <span class="o">&lt;=</span> <span class="n">last_seen</span><span class="p">:</span>
                                <span class="k">continue</span>
                            <span class="n">created</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_utc_aware</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">pr</span><span class="p">,</span> <span class="s2">&quot;created_at&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
                            <span class="n">status</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="s2">&quot;× ×¤×ª×—&quot;</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;open&quot;</span> <span class="ow">and</span> <span class="n">created</span> <span class="ow">and</span> <span class="n">updated</span> <span class="ow">and</span> <span class="n">created</span> <span class="o">==</span> <span class="n">updated</span><span class="p">)</span>
                                <span class="k">else</span> <span class="p">(</span>
                                    <span class="s2">&quot;××•×–×’&quot;</span>
                                    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pr</span><span class="p">,</span> <span class="s2">&quot;merged&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                                    <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;× ×¡×’×¨&quot;</span> <span class="k">if</span> <span class="n">pr</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;closed&quot;</span> <span class="k">else</span> <span class="s2">&quot;×¢×•×“×›×Ÿ&quot;</span><span class="p">)</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                            <span class="k">if</span> <span class="p">(</span>
                                <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;×¢×•×“×›×Ÿ&quot;</span>
                                <span class="ow">and</span> <span class="n">last_seen</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                                <span class="ow">and</span> <span class="n">updated</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                                <span class="ow">and</span> <span class="p">(</span><span class="n">updated</span> <span class="o">-</span> <span class="n">last_seen</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">cooldown_seconds</span>
                            <span class="p">):</span>
                                <span class="k">continue</span>
                            <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s1">&#39;ğŸ”” PR </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s1">: &lt;a href=&quot;</span><span class="si">{</span><span class="n">pr</span><span class="o">.</span><span class="n">html_url</span><span class="si">}</span><span class="s1">&quot;&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">title</span><span class="p">)</span><span class="si">}</span><span class="s1">&lt;/a&gt;&#39;</span>
                            <span class="p">)</span>
                            <span class="k">if</span> <span class="n">dedup_key</span> <span class="ow">and</span> <span class="n">updated</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">seen_prs</span><span class="p">[</span><span class="n">dedup_key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serialize_seen_pr_timestamp</span><span class="p">(</span><span class="n">updated</span><span class="p">)</span>
                        <span class="n">session</span><span class="p">[</span><span class="s2">&quot;notifications_last&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;notifications_last&quot;</span><span class="p">,</span> <span class="p">{})</span>
                        <span class="n">now_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
                        <span class="n">safe_baseline</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">if</span> <span class="n">latest_processed_pr_ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">safe_baseline</span> <span class="o">=</span> <span class="n">latest_processed_pr_ts</span>
                            <span class="k">if</span> <span class="n">safe_baseline</span> <span class="o">&gt;</span> <span class="n">now_dt</span><span class="p">:</span>
                                <span class="n">safe_baseline</span> <span class="o">=</span> <span class="n">now_dt</span>
                        <span class="n">session</span><span class="p">[</span><span class="s2">&quot;notifications_last&quot;</span><span class="p">][</span><span class="s2">&quot;pr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">safe_baseline</span> <span class="ow">or</span> <span class="n">now_dt</span>
                        <span class="c1"># ×”×’×‘×œ×ª ×’×•×“×œ ×”×–×™×›×¨×•×Ÿ ×›×“×™ ×œ×× ×•×¢ ×¦××™×—×” ×œ× ××‘×•×§×¨×ª</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">seen_prs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">60</span><span class="p">:</span>
                                <span class="n">parsed_items</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">seen_prs</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                                    <span class="n">parsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_seen_pr_timestamp</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">parsed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                        <span class="n">seen_prs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                                        <span class="k">continue</span>
                                    <span class="n">seen_prs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serialize_seen_pr_timestamp</span><span class="p">(</span><span class="n">parsed</span><span class="p">)</span>
                                    <span class="n">parsed_items</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">parsed</span><span class="p">))</span>
                                <span class="n">parsed_items</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                                <span class="n">keep_keys</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">parsed_items</span><span class="p">[:</span><span class="mi">50</span><span class="p">]}</span>
                                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">seen_prs</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                                    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keep_keys</span><span class="p">:</span>
                                        <span class="n">seen_prs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                <span class="c1"># Issues</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;issues&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                    <span class="n">last_issues_check_time</span> <span class="o">=</span> <span class="n">last</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;issues&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">last_issues_check_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">session</span><span class="p">[</span><span class="s2">&quot;notifications_last&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;notifications_last&quot;</span><span class="p">,</span> <span class="p">{})</span>
                        <span class="n">session</span><span class="p">[</span><span class="s2">&quot;notifications_last&quot;</span><span class="p">][</span><span class="s2">&quot;issues&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">issues</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_issues</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="s2">&quot;updated&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;desc&quot;</span><span class="p">)</span>
                        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">for</span> <span class="n">issue</span> <span class="ow">in</span> <span class="n">issues</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">issue</span><span class="o">.</span><span class="n">pull_request</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="k">continue</span>
                            <span class="n">updated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_utc_aware</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">issue</span><span class="p">,</span> <span class="s2">&quot;updated_at&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
                            <span class="n">baseline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_utc_aware</span><span class="p">(</span><span class="n">last_issues_check_time</span><span class="p">)</span>
                            <span class="c1"># ×× ××™×Ÿ updated ××• ×©××™×Ÿ ××¤×©×¨×•×ª ×”×©×•×•××” â€” ×¢×¦×•×¨ ×›×“×™ ×œ×× ×•×¢ ×¢×™×‘×•×“ ×™×ª×¨ ×©×œ ×¤×¨×™×˜×™× ×™×©× ×™×</span>
                            <span class="k">if</span> <span class="n">baseline</span> <span class="ow">and</span> <span class="p">(</span><span class="n">updated</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">updated</span> <span class="o">&lt;=</span> <span class="n">baseline</span><span class="p">):</span>
                                <span class="k">break</span>
                            <span class="n">created</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_utc_aware</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">issue</span><span class="p">,</span> <span class="s2">&quot;created_at&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
                            <span class="n">status</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="s2">&quot;× ×¤×ª×—&quot;</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">issue</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;open&quot;</span> <span class="ow">and</span> <span class="n">created</span> <span class="ow">and</span> <span class="n">updated</span> <span class="ow">and</span> <span class="n">created</span> <span class="o">==</span> <span class="n">updated</span><span class="p">)</span>
                                <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;× ×¡×’×¨&quot;</span> <span class="k">if</span> <span class="n">issue</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;closed&quot;</span> <span class="k">else</span> <span class="s2">&quot;×¢×•×“×›×Ÿ&quot;</span><span class="p">)</span>
                            <span class="p">)</span>
                            <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s1">&#39;ğŸ”” Issue </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s1">: &lt;a href=&quot;</span><span class="si">{</span><span class="n">issue</span><span class="o">.</span><span class="n">html_url</span><span class="si">}</span><span class="s1">&quot;&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">issue</span><span class="o">.</span><span class="n">title</span><span class="p">)</span><span class="si">}</span><span class="s1">&lt;/a&gt;&#39;</span>
                            <span class="p">)</span>
                            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>
                                <span class="k">break</span>
                        <span class="n">session</span><span class="p">[</span><span class="s2">&quot;notifications_last&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;notifications_last&quot;</span><span class="p">,</span> <span class="p">{})</span>
                        <span class="n">session</span><span class="p">[</span><span class="s2">&quot;notifications_last&quot;</span><span class="p">][</span><span class="s2">&quot;issues&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
                <span class="c1"># ×©×œ×— ×”×•×“×¢×” ×× ×™×©</span>
                <span class="k">if</span> <span class="n">messages</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
                    <span class="k">await</span> <span class="n">context</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span>
                        <span class="n">chat_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span> <span class="n">disable_web_page_preview</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">running_key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># ×©×œ×— Stacktrace ××œ× ×œ×™×•××Ÿ (Sentry ×™×§×œ×˜ ×“×¨×š LoggingIntegration)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;notifications job error&quot;</span><span class="p">)</span>
            <span class="c1"># ×•×’× × ×¡×” ×œ×“×•×•×— ×™×©×™×¨×•×ª ×œâ€‘Sentry ×›â€‘fallback</span>
            <span class="k">try</span><span class="p">:</span>  <span class="c1"># pragma: no cover - ×ª×œ×•×™ ×‘× ×•×›×—×•×ª sentry_sdk</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">sentry_sdk</span>  <span class="c1"># type: ignore</span>
                <span class="n">sentry_sdk</span><span class="o">.</span><span class="n">capture_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>  <span class="c1"># type: ignore[attr-defined]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

<div class="viewcode-block" id="GitHubMenuHandler.show_pr_menu">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_pr_menu">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">show_pr_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×‘×—×¨ ×¨×™×¤×• ×§×•×“× (/github)&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ†• ×¦×•×¨ PR ××¡× ×™×£&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;create_pr_menu&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”€ ××–×’ PR ×¤×ª×•×—&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;merge_pr_menu&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)],</span>
        <span class="p">]</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;ğŸ”€ ×¤×¢×•×œ×•×ª Pull Request ×¢×‘×•×¨ &lt;code&gt;</span><span class="si">{</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;selected_repo&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span><span class="p">,</span>
            <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span>
            <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="GitHubMenuHandler.show_create_pr_menu">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_create_pr_menu">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">show_create_pr_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_name</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×—×¡×¨×™× × ×ª×•× ×™×&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span>
        <span class="n">branches</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">repo</span><span class="o">.</span><span class="n">get_branches</span><span class="p">())</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pr_branches_page&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">config</span><span class="w"> </span><span class="kn">import</span> <span class="n">config</span> <span class="k">as</span> <span class="n">_cfg</span>  <span class="c1"># type: ignore</span>
            <span class="n">page_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">_cfg</span><span class="p">,</span> <span class="s1">&#39;UI_PAGE_SIZE&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">page_size</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">total_pages</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">branches</span><span class="p">)</span> <span class="o">+</span> <span class="n">page_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">page_size</span><span class="p">)</span>
        <span class="n">page</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">page</span><span class="p">),</span> <span class="n">total_pages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">page</span> <span class="o">*</span> <span class="n">page_size</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">page_size</span>
        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">br</span> <span class="ow">in</span> <span class="n">branches</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]:</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ğŸŒ¿ </span><span class="si">{</span><span class="n">br</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;pr_select_head:</span><span class="si">{</span><span class="n">br</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)]</span>
            <span class="p">)</span>
        <span class="n">nav</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">page</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;â¬…ï¸ ×”×§×•×“×&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;branches_page_</span><span class="si">{</span><span class="n">page</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;×¢××•×“ </span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total_pages</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;noop&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">page</span> <span class="o">&lt;</span> <span class="n">total_pages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;×”×‘× â¡ï¸&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;branches_page_</span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">nav</span><span class="p">:</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nav</span><span class="p">)</span>
        <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;pr_menu&quot;</span><span class="p">)])</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;ğŸ†• ×¦×•×¨ PR â€” ×‘×—×¨ ×¡× ×™×£ head (base ×™×”×™×” ×‘×¨×™×¨×ª ×”××—×“×œ ×©×œ ×”×¨×™×¤×•)&quot;</span><span class="p">,</span>
            <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="GitHubMenuHandler.show_confirm_create_pr">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_confirm_create_pr">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">show_confirm_create_pr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_name</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×—×¡×¨×™× × ×ª×•× ×™×&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">head</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pr_head&quot;</span><span class="p">)</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">default_branch</span> <span class="ow">or</span> <span class="s2">&quot;main&quot;</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;×ª×™×¦×•×¨ PR ×—×“×©?</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;×¨×™×¤×•: &lt;code&gt;</span><span class="si">{</span><span class="n">repo_name</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;base: &lt;code&gt;</span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s2">&lt;/code&gt; â† head: &lt;code&gt;</span><span class="si">{</span><span class="n">head</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;×›×•×ª×¨×ª: &lt;code&gt;PR: </span><span class="si">{</span><span class="n">head</span><span class="si">}</span><span class="s2"> â†’ </span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span>
        <span class="p">)</span>
        <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;âœ… ××©×¨ ×™×¦×™×¨×”&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;confirm_create_pr&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;create_pr_menu&quot;</span><span class="p">)],</span>
        <span class="p">]</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.confirm_create_pr">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.confirm_create_pr">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">confirm_create_pr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_name</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×—×¡×¨×™× × ×ª×•× ×™×&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">head</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pr_head&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span>
            <span class="n">base</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">default_branch</span> <span class="ow">or</span> <span class="s2">&quot;main&quot;</span>
            <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;PR: </span><span class="si">{</span><span class="n">head</span><span class="si">}</span><span class="s2"> â†’ </span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s2"> (via bot)&quot;</span>
            <span class="n">body</span> <span class="o">=</span> <span class="s2">&quot;× ×•×¦×¨ ××•×˜×•××˜×™×ª ×¢×œ ×™×“×™ ×”×‘×•×˜&quot;</span>
            <span class="n">pr</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">create_pull</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="n">base</span><span class="p">,</span> <span class="n">head</span><span class="o">=</span><span class="n">head</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;âœ… × ×•×¦×¨ PR: &lt;a href=&quot;</span><span class="si">{</span><span class="n">pr</span><span class="o">.</span><span class="n">html_url</span><span class="si">}</span><span class="s1">&quot;&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">title</span><span class="p">)</span><span class="si">}</span><span class="s1">&lt;/a&gt;&#39;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª PR: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_pr_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.show_merge_pr_menu">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_merge_pr_menu">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">show_merge_pr_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_name</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×—×¡×¨×™× × ×ª×•× ×™×&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span>
        <span class="n">pulls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">repo</span><span class="o">.</span><span class="n">get_pulls</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;open&quot;</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="s2">&quot;created&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;desc&quot;</span><span class="p">))</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pr_list_page&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">config</span><span class="w"> </span><span class="kn">import</span> <span class="n">config</span> <span class="k">as</span> <span class="n">_cfg</span>  <span class="c1"># type: ignore</span>
            <span class="n">page_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">_cfg</span><span class="p">,</span> <span class="s1">&#39;UI_PAGE_SIZE&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">page_size</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">total_pages</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pulls</span><span class="p">)</span> <span class="o">+</span> <span class="n">page_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">page_size</span><span class="p">)</span>
        <span class="n">page</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">page</span><span class="p">),</span> <span class="n">total_pages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">page</span> <span class="o">*</span> <span class="n">page_size</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">page_size</span>
        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pr</span> <span class="ow">in</span> <span class="n">pulls</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">safe_html_escape</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;#</span><span class="si">{</span><span class="n">pr</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;merge_pr:</span><span class="si">{</span><span class="n">pr</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="n">nav</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">page</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;â¬…ï¸ ×”×§×•×“×&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;prs_page_</span><span class="si">{</span><span class="n">page</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;×¢××•×“ </span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total_pages</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;noop&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">page</span> <span class="o">&lt;</span> <span class="n">total_pages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;×”×‘× â¡ï¸&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;prs_page_</span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">nav</span><span class="p">:</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nav</span><span class="p">)</span>
        <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;pr_menu&quot;</span><span class="p">)])</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;ğŸ”€ ×‘×—×¨ PR ×œ××™×–×•×’ (×¤×ª×•×—×™× ×‘×œ×‘×“)&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.show_confirm_merge_pr">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_confirm_merge_pr">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">show_confirm_merge_pr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="n">pr_number</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pr_to_merge&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_name</span> <span class="ow">and</span> <span class="n">pr_number</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×—×¡×¨×™× × ×ª×•× ×™×&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_pull</span><span class="p">(</span><span class="n">pr_number</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pr</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">checks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">can_merge</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Try to read permissions from repo API result</span>
            <span class="n">perms</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">raw_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;permissions&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="s2">&quot;raw_data&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">perms</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">push_allowed</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">perms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;push&quot;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">push_allowed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">checks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;×”×¨×©××ª push: </span><span class="si">{</span><span class="s1">&#39;×›×Ÿ&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">push_allowed</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;×œ×&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">push_allowed</span><span class="p">:</span>
                <span class="n">can_merge</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">mergeable</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">mergeable</span>
        <span class="n">mergeable_state</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pr</span><span class="p">,</span> <span class="s2">&quot;mergeable_state&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mergeable</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">can_merge</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">checks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;××¦×‘ mergeable: </span><span class="si">{</span><span class="n">mergeable_state</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;×›×Ÿ&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">mergeable</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;×œ× ×™×“×•×¢&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">statuses</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">repo</span><span class="o">.</span><span class="n">get_commit</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">head</span><span class="o">.</span><span class="n">sha</span><span class="p">)</span><span class="o">.</span><span class="n">get_statuses</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">statuses</span><span class="p">:</span>
                <span class="n">latest_state</span> <span class="o">=</span> <span class="n">statuses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">state</span>
                <span class="n">checks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;×¡×˜×˜×•×¡×™×: </span><span class="si">{</span><span class="n">latest_state</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pr</span><span class="p">,</span> <span class="s2">&quot;draft&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">checks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Draft: ×›×Ÿ&quot;</span><span class="p">)</span>
            <span class="n">can_merge</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">checks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Draft: ×œ×&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">reviews</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">get_reviews</span><span class="p">())</span>
            <span class="n">need_changes</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;CHANGES_REQUESTED&#39;</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">reviews</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">need_changes</span><span class="p">:</span>
                <span class="n">checks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;×‘×§×©×•×ª ×©×™× ×•×™ ×¤×ª×•×—×•×ª: ×›×Ÿ&quot;</span><span class="p">)</span>
                <span class="n">can_merge</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;×œ××–×’ PR?</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;#</span><span class="si">{</span><span class="n">pr</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: &lt;b&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">title</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pr</span><span class="o">.</span><span class="n">html_url</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;×‘×“×™×§×•×ª ×œ×¤× ×™ ××™×–×•×’:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;â€¢ </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">checks</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">kb</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”„ ×¨×¢× ×Ÿ ×‘×“×™×§×•×ª&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;refresh_merge_pr&quot;</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">can_merge</span><span class="p">:</span>
            <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;âœ… ××©×¨ ××™×–×•×’&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;confirm_merge_pr&quot;</span><span class="p">)])</span>
        <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;merge_pr_menu&quot;</span><span class="p">)])</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
            <span class="n">txt</span><span class="p">,</span>
            <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span>
            <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
            <span class="n">disable_web_page_preview</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.confirm_merge_pr">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.confirm_merge_pr">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">confirm_merge_pr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="n">pr_number</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pr_to_merge&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_name</span> <span class="ow">and</span> <span class="n">pr_number</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×—×¡×¨×™× × ×ª×•× ×™×&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span>
            <span class="n">pr</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_pull</span><span class="p">(</span><span class="n">pr_number</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">merge_method</span><span class="o">=</span><span class="s2">&quot;merge&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">merged</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;âœ… PR ××•×–×’ ×‘×”×¦×œ×—×”: &lt;a href=</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">pr</span><span class="o">.</span><span class="n">html_url</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&gt;#</span><span class="si">{</span><span class="n">pr</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">&lt;/a&gt;&quot;</span><span class="p">,</span>
                    <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ××™×–×•×’ × ×›×©×œ: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘××™×–×•×’ PR: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_pr_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.git_checkpoint">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.git_checkpoint">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">git_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_full</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">repo_full</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×—×¡×¨ ×˜×•×§×Ÿ ××• ×¨×™×¤×• × ×‘×—×¨&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># Acknowledge the callback early to avoid Telegram timeout spinner</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;×™×•×¦×¨ × ×§×•×“×ª ×©××™×¨×”...&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">login_or_token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_full</span><span class="p">)</span>
            <span class="n">branch_obj</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_branch</span><span class="p">(</span><span class="n">repo</span><span class="o">.</span><span class="n">default_branch</span><span class="p">)</span>
            <span class="n">default_branch</span> <span class="o">=</span> <span class="n">branch_obj</span><span class="o">.</span><span class="n">name</span>
            <span class="n">sha</span> <span class="o">=</span> <span class="n">branch_obj</span><span class="o">.</span><span class="n">commit</span><span class="o">.</span><span class="n">sha</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">-%H%M%S&quot;</span><span class="p">)</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">GIT_CHECKPOINT_PREFIX</span> <span class="ow">or</span> <span class="s2">&quot;checkpoint&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="c1"># ×©××•×¨ ×¢×œ ×ª×•×•×™× ×—×•×§×™×™× ×œ×©××•×ª refs ×‘×¡×™×¡×™×™×</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^A-Za-z0-9._/-]+&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>
            <span class="n">base_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">ts</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">tag_name</span> <span class="o">=</span> <span class="n">base_name</span>
            <span class="c1"># Create lightweight tag by creating a ref refs/tags/&lt;tag&gt;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">repo</span><span class="o">.</span><span class="n">create_git_ref</span><span class="p">(</span><span class="n">ref</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;refs/tags/</span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sha</span><span class="o">=</span><span class="n">sha</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">GithubException</span> <span class="k">as</span> <span class="n">ge</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ge</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="c1"># × ×¡×” ×¤×¢× × ×•×¡×¤×ª ×¢× ×¡×™×•××ª SHA ×‘××§×¨×” ×©×œ ×”×ª× ×’×©×•×™×•×ª ×‘×©×</span>
                <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">422</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">tag_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">sha</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">repo</span><span class="o">.</span><span class="n">create_git_ref</span><span class="p">(</span><span class="n">ref</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;refs/tags/</span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sha</span><span class="o">=</span><span class="n">sha</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">GithubException</span> <span class="k">as</span> <span class="n">ge2</span><span class="p">:</span>
                        <span class="c1"># fallback ×œ-branch</span>
                        <span class="n">branch_name</span> <span class="o">=</span> <span class="n">base_name</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">repo</span><span class="o">.</span><span class="n">create_git_ref</span><span class="p">(</span><span class="n">ref</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;refs/heads/</span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sha</span><span class="o">=</span><span class="n">sha</span><span class="p">)</span>
                        <span class="k">except</span> <span class="n">GithubException</span> <span class="k">as</span> <span class="n">gbe</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">gbe</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="mi">422</span><span class="p">:</span>
                                <span class="n">branch_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">sha</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="n">repo</span><span class="o">.</span><span class="n">create_git_ref</span><span class="p">(</span><span class="n">ref</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;refs/heads/</span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sha</span><span class="o">=</span><span class="n">sha</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="n">ge</span>  <span class="c1"># ×©××•×¨ ×¢×œ ×”×•×“×¢×ª ×”×©×’×™××” ×”××§×•×¨×™×ª ×©×œ ×”-tag</span>
                        <span class="c1"># ×”×¦×œ×—×ª ×’×™×‘×•×™ ×œ×¢× ×£</span>
                        <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;âœ… × ×•×¦×¨ branch (Fallback): &lt;code&gt;</span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&lt;/code&gt; ×¢×œ &lt;code&gt;</span><span class="si">{</span><span class="n">default_branch</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;×¡×™×‘×”: tag × ×—×¡× (HTTP </span><span class="si">{</span><span class="n">status</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;SHA: &lt;code&gt;</span><span class="si">{</span><span class="n">sha</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;×©×—×–×•×¨ ××”×™×¨: &lt;code&gt;git checkout </span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;×¨×•×¦×” ×©××™×¦×•×¨ ×¢×‘×•×¨×š ×§×•×‘×¥ ×”×•×¨××•×ª ×œ×©×—×–×•×¨?&quot;</span>
                        <span class="p">)</span>
                        <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ“ ×¦×•×¨ ×§×•×‘×¥ ×”×•×¨××•×ª&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;git_checkpoint_doc:branch:</span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)],</span>
                            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;×œ× ×ª×•×“×”&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;git_checkpoint_doc_skip&quot;</span><span class="p">)],</span>
                        <span class="p">]</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span>
                        <span class="k">return</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># ×œ× 422: ×¢×‘×•×¨ ×™×©×™×¨×•×ª ×œ×’×™×‘×•×™ ×œ×¢× ×£</span>
                    <span class="n">branch_name</span> <span class="o">=</span> <span class="n">base_name</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">repo</span><span class="o">.</span><span class="n">create_git_ref</span><span class="p">(</span><span class="n">ref</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;refs/heads/</span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sha</span><span class="o">=</span><span class="n">sha</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">GithubException</span> <span class="k">as</span> <span class="n">gbe</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">gbe</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="mi">422</span><span class="p">:</span>
                            <span class="n">branch_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">sha</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="n">repo</span><span class="o">.</span><span class="n">create_git_ref</span><span class="p">(</span><span class="n">ref</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;refs/heads/</span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sha</span><span class="o">=</span><span class="n">sha</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">ge</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;âœ… × ×•×¦×¨ branch (Fallback): &lt;code&gt;</span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&lt;/code&gt; ×¢×œ &lt;code&gt;</span><span class="si">{</span><span class="n">default_branch</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;×¡×™×‘×”: ×™×¦×™×¨×ª tag × ×›×©×œ×” (HTTP </span><span class="si">{</span><span class="n">status</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;SHA: &lt;code&gt;</span><span class="si">{</span><span class="n">sha</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;×©×—×–×•×¨ ××”×™×¨: &lt;code&gt;git checkout </span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;×¨×•×¦×” ×©××™×¦×•×¨ ×¢×‘×•×¨×š ×§×•×‘×¥ ×”×•×¨××•×ª ×œ×©×—×–×•×¨?&quot;</span>
                    <span class="p">)</span>
                    <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ“ ×¦×•×¨ ×§×•×‘×¥ ×”×•×¨××•×ª&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;git_checkpoint_doc:branch:</span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)],</span>
                        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;×œ× ×ª×•×“×”&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;git_checkpoint_doc_skip&quot;</span><span class="p">)],</span>
                    <span class="p">]</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
            <span class="c1"># ×”×¦×œ×—×ª ×™×¦×™×¨×ª tag</span>
            <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;âœ… × ×•×¦×¨ tag: &lt;code&gt;</span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s2">&lt;/code&gt; ×¢×œ &lt;code&gt;</span><span class="si">{</span><span class="n">default_branch</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;SHA: &lt;code&gt;</span><span class="si">{</span><span class="n">sha</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;×©×—×–×•×¨ ××”×™×¨: &lt;code&gt;git checkout tags/</span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;×¨×•×¦×” ×©××™×¦×•×¨ ×¢×‘×•×¨×š ×§×•×‘×¥ ×”×•×¨××•×ª ×œ×©×—×–×•×¨?&quot;</span>
            <span class="p">)</span>
            <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ“ ×¦×•×¨ ×§×•×‘×¥ ×”×•×¨××•×ª&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;git_checkpoint_doc:tag:</span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;×œ× ×ª×•×“×”&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;git_checkpoint_doc_skip&quot;</span><span class="p">)],</span>
            <span class="p">]</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">GithubException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">gh_message</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">gh_message</span> <span class="o">=</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">data</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">)</span>  <span class="c1"># type: ignore[attr-defined]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">gh_message</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">help_lines</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;×‘×“×•×§ ××ª ×”×¨×©××•×ª ×”-Token ×©×œ×š:&quot;</span><span class="p">,</span>
                <span class="s2">&quot;â€¢ ×œ×˜×•×§×Ÿ ×§×œ××¡×™: &lt;b&gt;repo&lt;/b&gt; (×’×™×©×” ××œ××”) ××• ×œ×›×œ ×”×¤×—×•×ª &lt;b&gt;public_repo&lt;/b&gt; ×œ×¨×™×¤×• ×¦×™×‘×•×¨×™.&quot;</span><span class="p">,</span>
                <span class="s2">&quot;â€¢ ×œ×˜×•×§×Ÿ ××¡×•×’ Fine-grained: ×ª×—×ª Repository permissions, ×ª×Ÿ &lt;b&gt;Contents: Read and write&lt;/b&gt; ×•-&lt;b&gt;Metadata: Read-only&lt;/b&gt; ×œ×¨×™×¤×•.&quot;</span><span class="p">,</span>
                <span class="s2">&quot;â€¢ ×•×“× ×©×™×© ×œ×š ×’×™×©×ª ×›×ª×™×‘×” ×œ×¨×™×¤×• (×œ× ×¨×§ ×œ×§×¨×™××”/×¤×•×¨×§).&quot;</span><span class="p">,</span>
                <span class="s2">&quot;â€¢ ×‘××¨×’×•× ×™×, ×™×™×ª×›×Ÿ ×©× ×“×¨×© ×œ××©×¨ ××ª ×”××¤×œ×™×§×¦×™×”/×”×˜×•×§×Ÿ ×‘××¨×’×•×Ÿ.&quot;</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="n">extra</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">status</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="mi">404</span><span class="p">):</span>
                <span class="n">extra</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">×™×™×ª×›×Ÿ ×©××™×Ÿ ×”×¨×©××ª ×›×ª×™×‘×” ××• ×©×”×˜×•×§×Ÿ ××•×’×‘×œ.&quot;</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;âŒ ×™×¦×™×¨×ª × ×§×•×“×ª ×©××™×¨×” ×‘×’×™×˜ × ×›×©×œ×” (HTTP </span><span class="si">{</span><span class="n">status</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="si">}</span><span class="s2">): &lt;b&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">gh_message</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/b&gt;</span><span class="si">{</span><span class="n">extra</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">help_lines</span><span class="p">),</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create git checkpoint: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×™×¦×™×¨×ª × ×§×•×“×ª ×©××™×¨×” ×‘×’×™×˜ × ×›×©×œ×”: </span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.show_pre_upload_check">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_pre_upload_check">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">show_pre_upload_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;××¦×™×’ ×‘×“×™×§×•×ª ×œ×¤× ×™ ×”×¢×œ××ª ×§×•×‘×¥ ×©××•×¨ (×”×¨×©××•×ª/×§×™×•× ×§×•×‘×¥/×¢× ×£/×ª×™×§×™×™×”).&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s2">&quot;callback_query&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span> <span class="k">if</span> <span class="n">query</span> <span class="k">else</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="n">file_id</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pending_saved_file_id&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_name</span> <span class="ow">and</span> <span class="n">file_id</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×—×¡×¨×™× × ×ª×•× ×™× (×˜×•×§×Ÿ/×¨×™×¤×•/×§×•×‘×¥)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×—×¡×¨×™× × ×ª×•× ×™× (×˜×•×§×Ÿ/×¨×™×¤×•/×§×•×‘×¥)&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">database</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">bson</span><span class="w"> </span><span class="kn">import</span> <span class="n">ObjectId</span>
            <span class="n">file_data</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="n">file_id</span><span class="p">),</span> <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">})</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">file_data</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×§×•×‘×¥ ×œ× × ××¦×&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×§×•×‘×¥ ×œ× × ××¦×&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file_name&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;file&quot;</span>
            <span class="c1"># Resolve target folder/branch (overrides take precedence)</span>
            <span class="n">override_folder</span> <span class="o">=</span> <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;upload_target_folder&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">target_folder</span> <span class="o">=</span> <span class="n">override_folder</span> <span class="k">if</span> <span class="n">override_folder</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="k">else</span> <span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_folder&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span>
            <span class="n">override_branch</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;upload_target_branch&quot;</span><span class="p">)</span>
            <span class="n">default_branch</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">default_branch</span> <span class="ow">or</span> <span class="s2">&quot;main&quot;</span>
            <span class="n">target_branch</span> <span class="o">=</span> <span class="n">override_branch</span> <span class="ow">or</span> <span class="n">default_branch</span>
            <span class="c1"># Build file path</span>
            <span class="k">if</span> <span class="n">target_folder</span><span class="p">:</span>
                <span class="n">folder_clean</span> <span class="o">=</span> <span class="n">target_folder</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder_clean</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">folder_clean</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="n">filename</span>
            <span class="c1"># Basic repo flags</span>
            <span class="n">archived</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="s2">&quot;archived&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">perms</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">raw_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;permissions&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="s2">&quot;raw_data&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">push_allowed</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">perms</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="nb">bool</span><span class="p">(</span><span class="n">perms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;push&quot;</span><span class="p">))</span>
            <span class="c1"># Check if file exists on target branch</span>
            <span class="n">exists</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">target_branch</span><span class="p">)</span>
                <span class="n">exists</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">exists</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># Build summary text</span>
            <span class="n">checks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">checks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;×¢× ×£ ×™×¢×“: </span><span class="si">{</span><span class="n">target_branch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">checks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;×ª×™×§×™×™×”: </span><span class="si">{</span><span class="n">folder_clean</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">checks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;×”×¨×©××ª push: </span><span class="si">{</span><span class="s1">&#39;×›×Ÿ&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">push_allowed</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;×œ×&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">checks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Archived: </span><span class="si">{</span><span class="s1">&#39;×›×Ÿ&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">archived</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;×œ×&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">checks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;×”×§×•×‘×¥ ×§×™×™× ×›×‘×¨: </span><span class="si">{</span><span class="s1">&#39;×›×Ÿ (×™×¢×•×“×›×Ÿ)&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">exists</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;×œ× (×™×™×•×•×¦×¨ ×—×“×©)&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">txt</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;×‘×“×™×§×•×ª ×œ×¤× ×™ ×”×¢×œ××”:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;×¨×™×¤×•: &lt;code&gt;</span><span class="si">{</span><span class="n">repo_name</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;×§×•×‘×¥: &lt;code&gt;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;â€¢ </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">checks</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="c1"># Build keyboard</span>
            <span class="n">kb</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸŒ¿ ×‘×—×¨ ×¢× ×£ ×™×¢×“&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;choose_upload_branch&quot;</span><span class="p">)])</span>
            <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ“‚ ×‘×—×¨ ×ª×™×§×™×™×ª ×™×¢×“&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;choose_upload_folder&quot;</span><span class="p">)])</span>
            <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;â• ×¦×•×¨ ×ª×™×§×™×™×” ×—×“×©×”&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;upload_folder_create&quot;</span><span class="p">)])</span>
            <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”„ ×¨×¢× ×Ÿ ×‘×“×™×§×•×ª&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;refresh_saved_checks&quot;</span><span class="p">)])</span>
            <span class="k">if</span> <span class="n">push_allowed</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">archived</span><span class="p">:</span>
                <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;âœ… ××©×¨ ×•×”×¢×œ×”&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;confirm_saved_upload&quot;</span><span class="p">)])</span>
            <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;back_to_menu&quot;</span><span class="p">)])</span>
            <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×‘×“×™×§×•×ª ×œ×¤× ×™ ×”×¢×œ××”: </span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.confirm_saved_upload">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.confirm_saved_upload">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">confirm_saved_upload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
        <span class="c1"># Proceed with the actual upload of the saved file after checks</span>
        <span class="n">file_id</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pending_saved_file_id&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_id</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×œ× × ××¦× ×§×•×‘×¥ ×××ª×™×Ÿ ×œ×”×¢×œ××”&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_saved_file_upload</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">file_id</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.refresh_saved_checks">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.refresh_saved_checks">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">refresh_saved_checks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_pre_upload_check</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.show_upload_branch_menu">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_upload_branch_menu">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">show_upload_branch_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_name</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×—×¡×¨×™× × ×ª×•× ×™×&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span>
        <span class="n">branches</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">repo</span><span class="o">.</span><span class="n">get_branches</span><span class="p">())</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;upload_branches_page&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">page_size</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">total_pages</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">branches</span><span class="p">)</span> <span class="o">+</span> <span class="n">page_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">page_size</span><span class="p">)</span>
        <span class="n">page</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">page</span><span class="p">),</span> <span class="n">total_pages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">page</span> <span class="o">*</span> <span class="n">page_size</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">page_size</span>
        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># ××™×¤×•×™ ×¢× ×¤×™× ×œ-token ×§×¦×¨ ×›×“×™ ×œ×× ×•×¢ ×—×™×ª×•×š/×©×’×™××•×ª ×‘××•×¨×š callback</span>
        <span class="n">branch_tokens</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;upload_branch_tokens&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">br</span> <span class="ow">in</span> <span class="n">branches</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]:</span>
            <span class="n">br_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">br</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="c1"># ×”×¤×§ token ×§×¦×¨ ×•×“×˜×¨××™× ×™×¡×˜×™-××¡×¤×™×§ ×œ×©×™××•×© ×–×× ×™ ×‘×ª×¤×¨×™×˜</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tok</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">tok</span> <span class="o">=</span> <span class="s2">&quot;t&quot;</span>
            <span class="n">tok</span> <span class="o">=</span> <span class="n">tok</span><span class="p">[:</span><span class="mi">24</span><span class="p">]</span>
            <span class="n">branch_tokens</span><span class="p">[</span><span class="n">tok</span><span class="p">]</span> <span class="o">=</span> <span class="n">br_name</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ğŸŒ¿ </span><span class="si">{</span><span class="n">br_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;upload_select_branch_tok:</span><span class="si">{</span><span class="n">tok</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;upload_branch_tokens&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">branch_tokens</span>
        <span class="n">nav</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">page</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;â¬…ï¸ ×”×§×•×“×&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;upload_branches_page_</span><span class="si">{</span><span class="n">page</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;×¢××•×“ </span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total_pages</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;noop&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">page</span> <span class="o">&lt;</span> <span class="n">total_pages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;×”×‘× â¡ï¸&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;upload_branches_page_</span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">nav</span><span class="p">:</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nav</span><span class="p">)</span>
        <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;refresh_saved_checks&quot;</span><span class="p">)])</span>
        <span class="c1"># ×¢×¨×™×›×ª ×”×”×•×“×¢×” ×¢× ×˜×™×¤×•×œ ×‘&quot;message is not modified&quot; â€“ ×‘××§×¨×” ×›×–×” × × ×¡×” ×œ×¢×“×›×Ÿ ×¨×§ ××ª ×”××§×œ×“×ª</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;×‘×—×¨ ×¢× ×£ ×™×¢×“ ×œ×”×¢×œ××”:&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">TelegramUtils</span> <span class="k">as</span> <span class="n">_TU</span>
                    <span class="k">await</span> <span class="n">_TU</span><span class="o">.</span><span class="n">safe_edit_message_reply_markup</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.show_upload_folder_menu">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_upload_folder_menu">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">show_upload_folder_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="c1"># ×”×¦×’ ××ª ×”×ª×™×§×™×™×” ×”×¤×¢×™×œ×” ×”× ×•×›×—×™×ª: ×¢×“×™×¤×•×ª ×œ-override ×–×× ×™ ××–×¨×™××ª ×”×”×¢×œ××”, ××—×¨×ª ×”×ª×™×§×™×™×” ×©× ×‘×—×¨×” ×‘××¤×’×©, ××—×¨×ª root</span>
        <span class="n">current</span> <span class="o">=</span> <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;upload_target_folder&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_folder&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;root&quot;</span><span class="p">)</span>
        <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ“ root (×¨××©×™)&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;upload_folder_root&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ğŸ“‚ ×”×©×ª××© ×‘×ª×™×§×™×™×” ×©× ×‘×—×¨×”: </span><span class="si">{</span><span class="n">current</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;upload_folder_current&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;âœï¸ ×”×–×Ÿ × ×ª×™×‘ ×™×“× ×™×ª&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;upload_folder_custom&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;â• ×¦×•×¨ ×ª×™×§×™×™×” ×—×“×©×”&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;upload_folder_create&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;refresh_saved_checks&quot;</span><span class="p">)],</span>
        <span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;×‘×—×¨ ×ª×™×§×™×™×ª ×™×¢×“:&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">TelegramUtils</span> <span class="k">as</span> <span class="n">_TU</span>
                    <span class="k">await</span> <span class="n">_TU</span><span class="o">.</span><span class="n">safe_edit_message_reply_markup</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.ask_upload_folder">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.ask_upload_folder">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">ask_upload_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_upload_folder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
            <span class="s2">&quot;âœï¸ ×”×§×œ×“ × ×ª×™×‘ ×ª×™×§×™×™×” ×™×¢×“ (×œ××©×œ: src/utils ××• ×¨×™×§ ×œ-root).</span><span class="se">\n</span><span class="s2">×©×œ×— ×˜×§×¡×˜ ×—×•×¤×©×™ ×¢×›×©×™×•.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.create_checkpoint_doc">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.create_checkpoint_doc">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_checkpoint_doc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×™×•×¦×¨ ×§×•×‘×¥ ×”×•×¨××•×ª ×©×—×–×•×¨ ×œ× ×§×•×“×ª ×©××™×¨×” ×•×©×•×œ×— ×œ-flow ×©×œ ×”×¢×œ××”&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_full</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
        <span class="c1"># ×‘× ×” ×ª×•×›×Ÿ Markdown</span>
        <span class="n">is_tag</span> <span class="o">=</span> <span class="p">(</span><span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;tag&quot;</span><span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;# ğŸ·ï¸ × ×§×•×“×ª ×©××™×¨×” ×‘×’×™×˜</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;× ×•×¦×¨ tag ×‘×©× `</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">`&quot;</span> <span class="k">if</span> <span class="n">is_tag</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;× ×•×¦×¨ branch ×‘×©× `</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">`&quot;</span><span class="p">)</span>
        <span class="n">repo_line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;×‘×¨×™×¤×•: `</span><span class="si">{</span><span class="n">repo_full</span><span class="si">}</span><span class="s2">`</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">repo_full</span> <span class="k">else</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">intro</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">what</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="si">{</span><span class="n">repo_line</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="s2">&quot;×›×š × ×™×ª×Ÿ ×œ×©×—×–×¨ ×œ××•×ª×” × ×§×•×“×” ×‘××—×©×‘ ×”××§×•××™:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">is_tag</span><span class="p">:</span>
            <span class="n">commands</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;1. ×¢×“×›×Ÿ ×ª×’×™×•×ª ××”×¨×™×¤×•:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;```bash</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;git fetch --tags</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;```</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;2. ××¢×‘×¨ ×œ×§×¨×™××” ×‘×œ×‘×“ ×œ-tag (××¦×‘ detached):</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;```bash</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;git checkout tags/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;```</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;3. ×œ×—×–×¨×” ×œ×¢× ×£ ×”×¨××©×™ ×œ××—×¨ ××›×Ÿ:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;```bash</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;git checkout -</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;```</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">commands</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;1. ×¢×“×›×Ÿ ×¨×¤×¨× ×¡×™× ××”×¨×™×¤×•:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;```bash</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;git fetch origin</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;```</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;2. ××¢×‘×¨ ×œ×¢× ×£ ×©× ×•×¦×¨:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;```bash</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;git checkout </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;```</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="n">notes</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&gt; ×”×¢×¨×•×ª:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;&gt; - × ×§×•×“×ª ×©××™×¨×” ×”×™× ×¨×¤×¨× ×¡ ×œ-commit (tag ××• branch).</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;&gt; - × ×™×ª×Ÿ ×œ××—×•×§ ××ª ×”×§×•×‘×¥ ×”×–×” ×œ××—×¨ ×”×©×—×–×•×¨.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">title</span> <span class="o">+</span> <span class="n">intro</span> <span class="o">+</span> <span class="n">commands</span> <span class="o">+</span> <span class="n">notes</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;RESTORE_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.md&quot;</span>
        <span class="c1"># ×©××™×¨×” ×‘××¡×“ ×•×”××©×š ×œ-flow ×©×œ ×”×¢×œ××”</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">database</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
            <span class="s2">&quot;file_name&quot;</span><span class="p">:</span> <span class="n">file_name</span><span class="p">,</span>
            <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">content</span><span class="p">,</span>
            <span class="s2">&quot;programming_language&quot;</span><span class="p">:</span> <span class="s2">&quot;markdown&quot;</span><span class="p">,</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;×”×•×¨××•×ª ×©×—×–×•×¨ ×œ× ×§×•×“×ª ×©××™×¨×”&quot;</span><span class="p">,</span>
            <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;checkpoint&quot;</span><span class="p">,</span> <span class="s2">&quot;instructions&quot;</span><span class="p">],</span>
            <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span>
            <span class="s2">&quot;updated_at&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span>
            <span class="s2">&quot;is_active&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">insert_one</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;pending_saved_file_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">inserted_id</span><span class="p">)</span>
            <span class="c1"># ×¤×ª×— ××ª ×‘×“×™×§×•×ª ×”×”×¢×œ××” (×‘×—×™×¨×ª ×¢× ×£/×ª×™×§×™×™×” ×•××™×©×•×¨)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_pre_upload_check</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ × ×›×©×œ ×‘×™×¦×™×¨×ª ×§×•×‘×¥ ×”×•×¨××•×ª: </span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="GitHubMenuHandler.show_restore_checkpoint_menu">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_restore_checkpoint_menu">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">show_restore_checkpoint_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;××¦×™×’ ×¨×©×™××ª ×ª×’×™×•×ª × ×§×•×“×•×ª ×©××™×¨×” ×œ×‘×—×™×¨×” ×œ×©×—×–×•×¨&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_full</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_full</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×—×¡×¨ ×˜×•×§×Ÿ ××• ×¨×™×¤×• × ×‘×—×¨&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="k">raise</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;âŒ ×—×¡×¨ ×˜×•×§×Ÿ ××• ×¨×™×¤×• × ×‘×—×¨&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_full</span><span class="p">)</span>
            <span class="c1"># ××©×•×š ×ª×’×™×•×ª (× ×—×ª×•×š ×œ×›××•×ª ×¡×‘×™×¨×”, ×œ××©×œ 100)</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">repo</span><span class="o">.</span><span class="n">get_tags</span><span class="p">())[:</span><span class="mi">100</span><span class="p">]</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">GIT_CHECKPOINT_PREFIX</span> <span class="ow">or</span> <span class="s2">&quot;checkpoint&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="c1"># ×©××•×ª ×—×•×§×™×™×</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^A-Za-z0-9._/-]+&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>
            <span class="n">checkpoint_tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tags</span> <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span><span class="p">)]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">checkpoint_tags</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;â„¹ï¸ ×œ× × ××¦××• ×ª×’×™×•×ª × ×§×•×“×ª ×©××™×¨×” ×‘×¨×™×¤×•.&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                        <span class="k">raise</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;â„¹ï¸ ×œ× × ××¦××• ×ª×’×™×•×ª × ×§×•×“×ª ×©××™×¨×”&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">return</span>
            <span class="c1"># ×¢×™××•×“</span>
            <span class="n">page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;restore_tags_page&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">per_page</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">checkpoint_tags</span><span class="p">)</span>
            <span class="n">total_pages</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">total</span> <span class="o">+</span> <span class="n">per_page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">per_page</span><span class="p">)</span>
            <span class="n">page</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">page</span><span class="p">),</span> <span class="n">total_pages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">page</span> <span class="o">*</span> <span class="n">per_page</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">per_page</span>
            <span class="n">page_tags</span> <span class="o">=</span> <span class="n">checkpoint_tags</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
            <span class="c1"># ×‘× ×” ××§×œ×“×ª</span>
            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">page_tags</span><span class="p">:</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ğŸ· </span><span class="si">{</span><span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;restore_select_tag:</span><span class="si">{</span><span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
            <span class="n">nav</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">page</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;â¬…ï¸ ×”×§×•×“×&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;restore_tags_page_</span><span class="si">{</span><span class="n">page</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ğŸ“„ </span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total_pages</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;noop&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">page</span> <span class="o">&lt;</span> <span class="n">total_pages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;â¡ï¸ ×”×‘×&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;restore_tags_page_</span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">nav</span><span class="p">:</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nav</span><span class="p">)</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                    <span class="s2">&quot;×‘×—×¨ ×ª×’×™×ª × ×§×•×“×ª ×©××™×¨×” ×œ×©×—×–×•×¨:&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="c1"># ×¤×¨×¡×•× ×”×•×“×¢×” ×—×“×©×” ×›×’×™×‘×•×™</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                        <span class="s2">&quot;×‘×—×¨ ×ª×’×™×ª × ×§×•×“×ª ×©××™×¨×” ×œ×©×—×–×•×¨:&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;××™×Ÿ ×©×™× ×•×™ ×‘×ª×¦×•×’×”&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×ª×’×™×•×ª: </span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="k">raise</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×ª×’×™×•×ª: </span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.show_commit_restore_menu">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_commit_restore_menu">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">show_commit_restore_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;××¦×™×’ ×§×•××™×˜×™× ××—×¨×•× ×™× ×œ×‘×—×™×¨×” ×œ×©×—×–×•×¨&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_full</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_full</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×—×¡×¨ ×˜×•×§×Ÿ ××• ×¨×™×¤×• × ×‘×—×¨&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="k">raise</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;âŒ ×—×¡×¨ ×˜×•×§×Ÿ ××• ×¨×™×¤×• × ×‘×—×¨&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_full</span><span class="p">)</span>
            <span class="n">base_branch</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;browse_ref&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="s2">&quot;default_branch&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;main&quot;</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;restore_commits_branch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_branch</span>
            <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">repo_full</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">base_branch</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">cache_store</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_restore_commits_cache&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="n">cached</span> <span class="o">=</span> <span class="n">cache_store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">commits_data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">cached</span> <span class="ow">and</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">cached</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ts&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">120</span><span class="p">:</span>
                <span class="n">commits_data</span> <span class="o">=</span> <span class="n">cached</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;items&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">commits</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_commits</span><span class="p">(</span><span class="n">sha</span><span class="o">=</span><span class="n">base_branch</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">commit</span> <span class="ow">in</span> <span class="n">islice</span><span class="p">(</span><span class="n">commits</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">):</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="n">author_name</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">author_date</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">commit</span><span class="p">,</span> <span class="s2">&quot;commit&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                            <span class="n">raw_msg</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">commit</span><span class="o">.</span><span class="n">commit</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
                            <span class="n">message</span> <span class="o">=</span> <span class="n">raw_msg</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">raw_msg</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                            <span class="n">author</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">commit</span><span class="o">.</span><span class="n">commit</span><span class="p">,</span> <span class="s2">&quot;author&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                            <span class="n">author_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">author</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                            <span class="n">author_date</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">author</span><span class="p">,</span> <span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="n">commits_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;sha&quot;</span><span class="p">:</span> <span class="n">commit</span><span class="o">.</span><span class="n">sha</span><span class="p">,</span>
                            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
                            <span class="s2">&quot;author&quot;</span><span class="p">:</span> <span class="n">author_name</span><span class="p">,</span>
                            <span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="n">author_date</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
                <span class="n">cache_store</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="n">commits_data</span><span class="p">,</span> <span class="s2">&quot;ts&quot;</span><span class="p">:</span> <span class="n">now</span><span class="p">}</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;_restore_commits_cache&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cache_store</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">commits_data</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;â„¹ï¸ ×œ× × ××¦××• ×§×•××™×˜×™× ×œ×”×¦×’×” ×‘×¢× ×£ &lt;code&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">base_branch</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/code&gt;.&quot;</span><span class="p">,</span>
                    <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">([[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)]]),</span>
                <span class="p">)</span>
                <span class="k">return</span>
            <span class="n">page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;restore_commits_page&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">per_page</span> <span class="o">=</span> <span class="mi">6</span>
            <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">commits_data</span><span class="p">)</span>
            <span class="n">total_pages</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">total</span> <span class="o">+</span> <span class="n">per_page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">per_page</span><span class="p">)</span>
            <span class="n">page</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">page</span><span class="p">),</span> <span class="n">total_pages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">page</span> <span class="o">*</span> <span class="n">per_page</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">per_page</span>
            <span class="n">page_items</span> <span class="o">=</span> <span class="n">commits_data</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">_shorten</span><span class="p">(</span><span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">40</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">msg</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s2">&quot;×œ×œ× ×”×•×“×¢×”&quot;</span>
                <span class="n">clean</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">clean</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clean</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">limit</span> <span class="k">else</span> <span class="p">(</span><span class="n">clean</span><span class="p">[:</span> <span class="n">limit</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;â€¦&quot;</span><span class="p">)</span>

            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">page_items</span><span class="p">:</span>
                <span class="n">sha</span> <span class="o">=</span> <span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sha&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)[:</span><span class="mi">7</span><span class="p">]</span>
                <span class="n">label_msg</span> <span class="o">=</span> <span class="n">_shorten</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sha</span><span class="si">}</span><span class="s2"> â€¢ </span><span class="si">{</span><span class="n">label_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;restore_select_commit:</span><span class="si">{</span><span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sha&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)]</span>
                <span class="p">)</span>
            <span class="n">nav</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">page</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;â¬…ï¸ ×”×§×•×“×&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;restore_commits_page_</span><span class="si">{</span><span class="n">page</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;×¢××•×“ </span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total_pages</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;noop&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">page</span> <span class="o">&lt;</span> <span class="n">total_pages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;×”×‘× â¡ï¸&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;restore_commits_page_</span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">nav</span><span class="p">:</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nav</span><span class="p">)</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)])</span>
            <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ”„ ×‘×—×¨/×™ ×§×•××™×˜ ×œ×—×–×¨×” ×‘×¢× ×£ &lt;code&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">base_branch</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;×¨×™×¤×•: &lt;code&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">repo_full</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;××•×¦×’×™× ×¢×“ 50 ×§×•××™×˜×™× ××—×¨×•× ×™×.&quot;</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;××™×Ÿ ×©×™× ×•×™ ×‘×ª×¦×•×’×”&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
        <span class="k">except</span> <span class="n">GithubException</span> <span class="k">as</span> <span class="n">ge</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ge</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="p">{})</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">ge</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×§×•××™×˜×™×: </span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×§×•××™×˜×™×: </span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.show_commit_restore_actions">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_commit_restore_actions">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">show_commit_restore_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">commit_sha</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;××¦×™×’ ×¤×¢×•×œ×•×ª ×–××™× ×•×ª ×¢×‘×•×¨ ×§×•××™×˜ ××¡×•×™×&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_full</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_full</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×—×¡×¨ ×˜×•×§×Ÿ ××• ×¨×™×¤×• × ×‘×—×¨&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_full</span><span class="p">)</span>
            <span class="n">commit_obj</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_commit</span><span class="p">(</span><span class="n">commit_sha</span><span class="p">)</span>
            <span class="n">commit_msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">author_name</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
            <span class="n">date_str</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">commit_msg</span> <span class="o">=</span> <span class="p">(</span><span class="n">commit_obj</span><span class="o">.</span><span class="n">commit</span><span class="o">.</span><span class="n">message</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">author_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">commit_obj</span><span class="o">.</span><span class="n">commit</span><span class="p">,</span> <span class="s2">&quot;author&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;-&quot;</span>
                <span class="n">commit_date</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">commit_obj</span><span class="o">.</span><span class="n">commit</span><span class="p">,</span> <span class="s2">&quot;author&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">aware</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_utc_aware</span><span class="p">(</span><span class="n">commit_date</span><span class="p">)</span> <span class="k">if</span> <span class="n">commit_date</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">aware</span><span class="p">:</span>
                    <span class="n">date_str</span> <span class="o">=</span> <span class="n">aware</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/%m/%Y %H:%M UTC&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">commit_msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">header</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ§± ×§×•××™×˜ × ×‘×—×¨: &lt;code&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">commit_sha</span><span class="p">[:</span><span class="mi">12</span><span class="p">])</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;××—×‘×¨: </span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">author_name</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;×ª××¨×™×š: </span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">date_str</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">body</span> <span class="o">=</span> <span class="n">safe_html_escape</span><span class="p">(</span><span class="n">commit_msg</span> <span class="ow">or</span> <span class="s2">&quot;×œ×œ× ×”×•×“×¢×ª commit&quot;</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combine_with_telegram_limit</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
            <span class="n">branch_cb</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">CALLBACK_BRANCH_FROM_COMMIT</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">commit_sha</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">revert_cb</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">CALLBACK_REVERT_PR_FROM_COMMIT</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">commit_sha</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”— ×¤×ª×— ×‘×’×™×˜×”××‘&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">commit_obj</span><span class="o">.</span><span class="n">html_url</span><span class="p">),</span>
                <span class="p">],</span>
                <span class="p">[</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸŒ¿ ×¦×•×¨ ×¢× ×£ ××”×§×•××™×˜&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="n">branch_cb</span><span class="p">),</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ” ×¤×ª×— PR ×¨×•×œ×‘××§ ××”×§×•××™×˜&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="n">revert_cb</span><span class="p">),</span>
                <span class="p">],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;restore_commit_menu&quot;</span><span class="p">)],</span>
            <span class="p">]</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">GithubException</span> <span class="k">as</span> <span class="n">ge</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ge</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="p">{})</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">ge</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×§×•××™×˜: </span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×§×•××™×˜: </span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.show_restore_tag_actions">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_restore_tag_actions">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">show_restore_tag_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">tag_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;××¦×™×’ ×¤×¢×•×œ×•×ª ××¤×©×¨×™×•×ª ×œ×©×—×–×•×¨ ××ª×’×™×ª × ×ª×•× ×”&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_full</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">repo_full</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×œ× × ×‘×—×¨ ×¨×™×¤×•&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># ×”×¦×’ ××¤×©×¨×•×™×•×ª: ×¦×•×¨ ×§×•×‘×¥ ×”×•×¨××•×ª / ×¦×•×¨ ×¢× ×£ ××”×ª×’×™×ª</span>
        <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;ğŸ· ×ª×’×™×ª × ×‘×—×¨×”: &lt;code&gt;</span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;×‘×—×¨ ×¤×¢×•×œ×” ×œ×©×—×–×•×¨:&quot;</span> 
        <span class="p">)</span>
        <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ“ ×¦×•×¨ ×§×•×‘×¥ ×”×•×¨××•×ª&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;git_checkpoint_doc:tag:</span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸŒ¿ ×¦×•×¨ ×¢× ×£ ××”×ª×’×™×ª&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;restore_branch_from_tag:</span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ” ×¦×•×¨ PR ×œ×©×—×–×•×¨ (Revert)&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;restore_revert_pr_from_tag:</span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;restore_checkpoint_menu&quot;</span><span class="p">)],</span>
        <span class="p">]</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="GitHubMenuHandler.create_branch_from_tag">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.create_branch_from_tag">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_branch_from_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">tag_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×™×•×¦×¨ ×¢× ×£ ×—×“×© ×©××¦×‘×™×¢ ×œ-commit ×©×œ ×”×ª×’×™×ª ×œ×©×—×–×•×¨ × ×•×—&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_full</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_full</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×—×¡×¨ ×˜×•×§×Ÿ ××• ×¨×™×¤×• × ×‘×—×¨&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_full</span><span class="p">)</span>
            <span class="n">sha</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># × ×¡×” ×œ×”×©×™×’ SHA ××”-ref ×©×œ ×”×ª×’×™×ª</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ref</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_git_ref</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tags/</span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">sha</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">sha</span>
            <span class="k">except</span> <span class="n">GithubException</span><span class="p">:</span>
                <span class="c1"># × ×¤×™×œ×” ×—×–×¨×” ×œ×—×™×¤×•×© ×‘×¨×©×™××ª ×ª×’×™×•×ª</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_tags</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">tag_name</span><span class="p">:</span>
                        <span class="n">sha</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">commit</span><span class="o">.</span><span class="n">sha</span>
                        <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">sha</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×œ× × ××¦××” ×”×ª×’×™×ª ×”××‘×•×§×©×ª&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="c1"># ×©× ×‘×¨×™×¨×ª ××—×“×œ ×œ×¢× ×£ ×©×—×–×•×¨</span>
            <span class="n">base_branch</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^A-Za-z0-9._/-]+&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;restore-</span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">branch_name</span> <span class="o">=</span> <span class="n">base_branch</span>
            <span class="c1"># ×¦×•×¨ ××ª ×”-ref, ×¢× × ×™×¡×™×•×Ÿ ×œ×©××•×¨ ×¢×œ ×™×™×—×•×“×™×•×ª</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">repo</span><span class="o">.</span><span class="n">create_git_ref</span><span class="p">(</span><span class="n">ref</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;refs/heads/</span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sha</span><span class="o">=</span><span class="n">sha</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">GithubException</span> <span class="k">as</span> <span class="n">gbe</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">gbe</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="mi">422</span><span class="p">:</span>
                    <span class="n">branch_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_branch</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">sha</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">repo</span><span class="o">.</span><span class="n">create_git_ref</span><span class="p">(</span><span class="n">ref</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;refs/heads/</span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sha</span><span class="o">=</span><span class="n">sha</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span>
            <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”€ ×¤×ª×— PR ××”×¢× ×£&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;open_pr_from_branch:</span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;restore_checkpoint_menu&quot;</span><span class="p">)],</span>
            <span class="p">]</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;âœ… × ×•×¦×¨ ×¢× ×£ ×©×—×–×•×¨: &lt;code&gt;</span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&lt;/code&gt; ××ª×•×š &lt;code&gt;</span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;×©×—×–×•×¨ ××§×•××™ ××”×™×¨:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;&lt;code&gt;git fetch origin &amp;&amp; git checkout </span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># ×”×¦×’ ××¤×©×¨×•×ª ×œ×”××©×™×š ×œ×™×¦×™×¨×ª PR ×œ×©×—×–×•×¨ ×œ××¨×•×ª ×”×›×™×©×œ×•×Ÿ ×‘×™×¦×™×¨×ª ×¢× ×£</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ” ×¦×•×¨ PR ×œ×©×—×–×•×¨ (Revert)&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;restore_revert_pr_from_tag:</span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)],</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;restore_checkpoint_menu&quot;</span><span class="p">)],</span>
                <span class="p">]</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª ×¢× ×£ ×©×—×–×•×¨: </span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;×ª×•×›×œ ×¢×“×™×™×Ÿ ×œ×™×¦×•×¨ PR ×œ×©×—×–×•×¨ ×™×©×™×¨×•×ª ××”×ª×’×™×ª &lt;code&gt;</span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s2">&lt;/code&gt;.&quot;</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span>
                    <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª ×¢× ×£ ×©×—×–×•×¨: </span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.open_pr_from_branch">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.open_pr_from_branch">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">open_pr_from_branch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">branch_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×¤×•×ª×— Pull Request ××”×¢× ×£ ×©× ×•×¦×¨ ××œ ×”×¢× ×£ ×”×¨××©×™ ×©×œ ×”×¨×™×¤×•&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_full</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_full</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×—×¡×¨ ×˜×•×§×Ÿ ××• ×¨×™×¤×• × ×‘×—×¨&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_full</span><span class="p">)</span>
            <span class="n">base_branch</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">default_branch</span> <span class="ow">or</span> <span class="s2">&quot;main&quot;</span>
            <span class="n">owner_login</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">owner</span><span class="o">.</span><span class="n">login</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="s2">&quot;owner&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="n">repo_full</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># 1) ×× ×›×‘×¨ ×§×™×™× PR ×¤×ª×•×— ××”×¢× ×£ ×”×–×” ×œ×‘×¡×™×¡ â€“ ×”×¦×’ ××•×ª×• ×‘××§×•× ×œ×™×¦×•×¨ ×—×“×©</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">existing_prs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                    <span class="n">repo</span><span class="o">.</span><span class="n">get_pulls</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;open&quot;</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="n">base_branch</span><span class="p">,</span> <span class="n">head</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">owner_login</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">existing_prs</span><span class="p">:</span>
                    <span class="n">pr</span> <span class="o">=</span> <span class="n">existing_prs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">kb</span> <span class="o">=</span> <span class="p">[[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)]]</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;â„¹ï¸ ×›×‘×¨ ×§×™×™× PR ×¤×ª×•×— ××”×¢× ×£ &lt;code&gt;</span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&lt;/code&gt; ×œ-&lt;code&gt;</span><span class="si">{</span><span class="n">base_branch</span><span class="si">}</span><span class="s2">&lt;/code&gt;: &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;&lt;a href=</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">pr</span><span class="o">.</span><span class="n">html_url</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&gt;#</span><span class="si">{</span><span class="n">pr</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">&lt;/a&gt;&quot;</span><span class="p">,</span>
                        <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                        <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="k">return</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># × ××©×™×š ×œ× ×¡×•×ª ×œ×™×¦×•×¨ PR ×× ×œ× ×”×¦×œ×—× ×• ×œ×‘×“×•×§ ×§×™×•×</span>
                <span class="k">pass</span>

            <span class="c1"># 2) ×‘×“×•×§ ×©×™×© ×”×‘×“×œ×™× ×‘×™×Ÿ HEAD ×œ-base (××—×¨×ª GitHub ×™×—×–×™×¨ Validation Failed)</span>
            <span class="n">created_snapshot_commit</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">snapshot_failure_reason</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cmp</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">base_branch</span><span class="p">,</span> <span class="n">branch_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cmp</span><span class="p">,</span> <span class="s2">&quot;ahead_by&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">created_snapshot_commit</span><span class="p">,</span> <span class="n">snapshot_failure_reason</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_branch_snapshot_commit</span><span class="p">(</span>
                        <span class="n">repo</span><span class="p">,</span> <span class="n">base_branch</span><span class="p">,</span> <span class="n">branch_name</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">created_snapshot_commit</span><span class="p">:</span>
                        <span class="n">cmp</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">base_branch</span><span class="p">,</span> <span class="n">branch_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cmp</span><span class="p">,</span> <span class="s2">&quot;ahead_by&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cmp</span><span class="p">,</span> <span class="s2">&quot;behind_by&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;â†©ï¸ ×‘×—×¨ ×ª×’×™×ª ××—×¨×ª&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;restore_checkpoint_menu&quot;</span><span class="p">)],</span>
                        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)],</span>
                    <span class="p">]</span>
                    <span class="n">extra_hint</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="k">if</span> <span class="n">snapshot_failure_reason</span> <span class="o">==</span> <span class="s2">&quot;identical_tree&quot;</span><span class="p">:</span>
                        <span class="n">extra_hint</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">×”×¢× ×£ &lt;code&gt;</span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&lt;/code&gt; ×–×”×” ×›×¨×’×¢ ×œ-&lt;code&gt;</span><span class="si">{</span><span class="n">base_branch</span><span class="si">}</span><span class="s2">&lt;/code&gt;.&quot;</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                        <span class="p">(</span>
                            <span class="s2">&quot;âŒ ×œ× × ×™×ª×Ÿ ×œ×¤×ª×•×— PR: ××™×Ÿ ×©×™× ×•×™×™× ×‘×™×Ÿ ×”×¢× ×£ &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;&lt;code&gt;</span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&lt;/code&gt; ×œ- &lt;code&gt;</span><span class="si">{</span><span class="n">base_branch</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="si">{</span><span class="n">extra_hint</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                            <span class="s2">&quot;× ×¡×” ×œ×‘×—×•×¨ ×ª×’×™×ª ××—×¨×ª ×œ×©×—×–×•×¨, ××• ×‘×¦×¢ ×©×™× ×•×™/commit ×‘×¢× ×£ ×œ×¤× ×™ ×¤×ª×™×—×ª PR.&quot;</span>
                        <span class="p">),</span>
                        <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                        <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="k">return</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># ×× ×”×”×©×•×•××” × ×›×©×œ×”, × × ×¡×” ×‘×›×œ ×–××ª ×œ×™×¦×•×¨ PR â€“ ×™×™×ª×›×Ÿ ×©×”×¢× ×£ ×—×“×© ×××•×“</span>
                <span class="k">pass</span>

            <span class="c1"># 3) ×¦×•×¨ PR</span>
            <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Restore from checkpoint: </span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">body</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Automated PR to restore state from branch `</span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">`.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Created via Telegram bot.&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">created_snapshot_commit</span><span class="p">:</span>
                <span class="n">body</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">×”×‘×•×˜ ×™×¦×¨ commit ×—×“×© ×¢×œ ×’×‘×™ &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;`</span><span class="si">{</span><span class="n">base_branch</span><span class="si">}</span><span class="s2">` ×›×“×™ ×œ×©×—×–×¨ ××ª ×ª×•×›×Ÿ ×”×¢× ×£.&quot;</span>
                <span class="p">)</span>
            <span class="n">pr</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">create_pull</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">,</span> <span class="n">head</span><span class="o">=</span><span class="n">branch_name</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="n">base_branch</span><span class="p">)</span>
            <span class="n">kb</span> <span class="o">=</span> <span class="p">[[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)]]</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;âœ… × ×¤×ª×— PR: &lt;a href=</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">pr</span><span class="o">.</span><span class="n">html_url</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&gt;#</span><span class="si">{</span><span class="n">pr</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">&lt;/a&gt; â† &lt;code&gt;</span><span class="si">{</span><span class="n">base_branch</span><span class="si">}</span><span class="s2">&lt;/code&gt; â† &lt;code&gt;</span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span>
                <span class="o">+</span> <span class="p">(</span><span class="s2">&quot; (× ×•×¡×£ commit ×©×—×–×•×¨ ××•×˜×•××˜×™)&quot;</span> <span class="k">if</span> <span class="n">created_snapshot_commit</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">GithubException</span> <span class="k">as</span> <span class="n">ge</span><span class="p">:</span>
            <span class="c1"># ×¤×¨×©× ×•×ª ××¤×•×¨×˜×ª ×™×•×ª×¨ ×œ×©×’×™××•×ª Validation Failed</span>
            <span class="n">message_text</span> <span class="o">=</span> <span class="s2">&quot;Validation Failed&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">ge</span><span class="o">.</span><span class="n">data</span> <span class="ow">or</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="c1"># ×”×•×“×¢×ª ×¢×œ</span>
                    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">):</span>
                        <span class="n">message_text</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span>
                    <span class="c1"># ×‘×“×•×§ ×¤×™×¨×•×˜ ×©×’×™××•×ª × ×¤×•×¦×•×ª</span>
                    <span class="n">errors</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;errors&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">errors</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">errors</span><span class="p">:</span>
                        <span class="n">details</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">err</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">:</span>
                            <span class="c1"># err ×™×›×•×œ ×œ×”×™×•×ª dict ×¢× ××¤×ª×—×•×ª code/message</span>
                            <span class="n">code</span> <span class="o">=</span> <span class="n">err</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;code&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="n">err</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
                            <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="s2">&quot;custom&quot;</span> <span class="ow">and</span> <span class="n">msg</span><span class="p">:</span>
                                <span class="n">details</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="n">msg</span><span class="p">:</span>
                                <span class="n">details</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">details</span><span class="p">:</span>
                            <span class="n">message_text</span> <span class="o">+=</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="s2">&quot;; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">details</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="c1"># × ×¡×” ×œ×–×”×•×ª ×‘××¤×•×¨×© &quot;No commits between&quot; ××• PR ×§×™×™× ×•×œ×”×¦×™×¢ ×¤×ª×¨×•×Ÿ</span>
            <span class="n">lower_msg</span> <span class="o">=</span> <span class="p">(</span><span class="n">message_text</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">kb</span> <span class="o">=</span> <span class="p">[[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)]]</span>
            <span class="k">if</span> <span class="s2">&quot;no commits between&quot;</span> <span class="ow">in</span> <span class="n">lower_msg</span> <span class="ow">or</span> <span class="s2">&quot;no commits&quot;</span> <span class="ow">in</span> <span class="n">lower_msg</span><span class="p">:</span>
                <span class="n">kb</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;â†©ï¸ ×‘×—×¨ ×ª×’×™×ª ××—×¨×ª&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;restore_checkpoint_menu&quot;</span><span class="p">)])</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="s2">&quot;âŒ ×©×’×™××” ×‘×¤×ª×™×—×ª PR: ××™×Ÿ ×©×™× ×•×™×™× ×‘×™×Ÿ ×”×¢× ×¤×™×.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;×¢× ×£: &lt;code&gt;</span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&lt;/code&gt; â†’ ×‘×¡×™×¡: &lt;code&gt;</span><span class="si">{</span><span class="n">base_branch</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                        <span class="s2">&quot;×‘×—×¨ × ×§×•×“×ª ×©××™×¨×” ××•×§×“××ª ×™×•×ª×¨ ××• ×‘×¦×¢ ×©×™× ×•×™/commit ×‘×¢× ×£ ×•××– × ×¡×” ×©×•×‘.&quot;</span>
                    <span class="p">),</span>
                    <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="s2">&quot;already exists&quot;</span> <span class="ow">in</span> <span class="n">lower_msg</span> <span class="ow">or</span> <span class="s2">&quot;a pull request already exists&quot;</span> <span class="ow">in</span> <span class="n">lower_msg</span><span class="p">:</span>
                <span class="c1"># × ×¡×” ×œ××¦×•× ××ª ×”-PR ×”×§×™×™× ×•×œ×”×¦×™×’ ×§×™×©×•×¨</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">prs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">repo</span><span class="o">.</span><span class="n">get_pulls</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;open&quot;</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="n">base_branch</span><span class="p">,</span> <span class="n">head</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">owner_login</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">prs</span><span class="p">:</span>
                        <span class="n">pr</span> <span class="o">=</span> <span class="n">prs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;â„¹ï¸ ×›×‘×¨ ×§×™×™× PR ×¤×ª×•×—: &lt;a href=</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">pr</span><span class="o">.</span><span class="n">html_url</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&gt;#</span><span class="si">{</span><span class="n">pr</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">&lt;/a&gt;&quot;</span><span class="p">,</span>
                            <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                            <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span>
                        <span class="p">)</span>
                        <span class="k">return</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×¤×ª×™×—×ª PR: </span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">message_text</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×¤×ª×™×—×ª PR: </span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_ensure_branch_snapshot_commit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repo</span><span class="p">,</span> <span class="n">base_branch</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">branch_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×× ×¡×” ×œ×•×•×“× ×©×™×© commit ×—×“×© ×‘×¨××© ×”×¢× ×£ ×©××™×™×¦×¨ diff ××•×œ base.</span>

<span class="sd">        ××—×–×™×¨ tuple ×©×œ (×”×× × ×•×¦×¨ commit ×—×“×©, ×§×•×“ ×¡×™×‘×ª ×›×™×©×œ×•×Ÿ).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">branch_ref</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_git_ref</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;heads/</span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">branch_sha</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">branch_ref</span><span class="p">,</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;sha&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">branch_sha</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;missing_branch_sha&quot;</span>
            <span class="n">branch_commit</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_commit</span><span class="p">(</span><span class="n">branch_sha</span><span class="p">)</span>
            <span class="n">branch_tree_sha</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">branch_commit</span><span class="o">.</span><span class="n">commit</span><span class="p">,</span> <span class="s2">&quot;tree&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;sha&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">branch_tree_sha</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;missing_branch_tree&quot;</span>

            <span class="n">base_ref</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_branch</span><span class="p">(</span><span class="n">base_branch</span><span class="p">)</span>
            <span class="n">base_sha</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">base_ref</span><span class="p">,</span> <span class="s2">&quot;commit&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;sha&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">base_sha</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;missing_base_sha&quot;</span>
            <span class="n">base_commit</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_commit</span><span class="p">(</span><span class="n">base_sha</span><span class="p">)</span>
            <span class="n">base_tree_sha</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">base_commit</span><span class="o">.</span><span class="n">commit</span><span class="p">,</span> <span class="s2">&quot;tree&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;sha&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="c1"># ×× ×”×¢×¦×™× ×–×”×™× â€“ ××™×Ÿ ×¦×•×¨×š ×œ×™×¦×•×¨ commit ××œ××›×•×ª×™</span>
            <span class="k">if</span> <span class="n">branch_tree_sha</span> <span class="ow">and</span> <span class="n">base_tree_sha</span> <span class="ow">and</span> <span class="n">branch_tree_sha</span> <span class="o">==</span> <span class="n">base_tree_sha</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;identical_tree&quot;</span>

            <span class="n">parent_git_commit</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_git_commit</span><span class="p">(</span><span class="n">base_sha</span><span class="p">)</span>
            <span class="n">new_tree</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_git_tree</span><span class="p">(</span><span class="n">branch_tree_sha</span><span class="p">)</span>

            <span class="n">new_commit_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Restore snapshot from </span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2"> onto </span><span class="si">{</span><span class="n">base_branch</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">new_commit</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">create_git_commit</span><span class="p">(</span><span class="n">new_commit_message</span><span class="p">,</span> <span class="n">new_tree</span><span class="p">,</span> <span class="p">[</span><span class="n">parent_git_commit</span><span class="p">])</span>
            <span class="c1"># ×¢×“×›×Ÿ ××ª ×”-ref ×©×œ ×”×¢× ×£ ×œ-commit ×”×—×“×©</span>
            <span class="n">branch_ref</span><span class="o">.</span><span class="n">edit</span><span class="p">(</span><span class="n">new_commit</span><span class="o">.</span><span class="n">sha</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;[open_pr_from_branch] Created snapshot commit=</span><span class="si">%s</span><span class="s2"> on </span><span class="si">%s</span><span class="s2"> from tree=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">new_commit</span><span class="o">.</span><span class="n">sha</span><span class="p">,</span>
                <span class="n">branch_name</span><span class="p">,</span>
                <span class="n">branch_tree_sha</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="n">GithubException</span> <span class="k">as</span> <span class="n">ge</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;[open_pr_from_branch] Failed to create snapshot commit for </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">branch_name</span><span class="p">,</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="n">ge</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">ge</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;github_error&quot;</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;[open_pr_from_branch] Unexpected error while creating snapshot commit for </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">branch_name</span><span class="p">,</span>
                <span class="n">exc</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;unexpected_error&quot;</span>

<div class="viewcode-block" id="GitHubMenuHandler.create_revert_pr_from_tag">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.create_revert_pr_from_tag">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_revert_pr_from_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">tag_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×™×•×¦×¨ PR ×©××©×—×–×¨ ××ª ××¦×‘ ×”×¨×™×¤×• ×œ×ª×’×™×ª ×¢&quot;×™ ×™×¦×™×¨×ª commit ×—×“×© ×¢× ×¢×¥ ×”×ª×’×™×ª ×¢×œ ×’×‘×™ base.</span>
<span class="sd">        ×›×š ×ª××™×“ ×™×”×™×” diff ×•×”-PR ×™×™×¤×ª×— ×‘×”×¦×œ×—×”.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_full</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_full</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×—×¡×¨ ×˜×•×§×Ÿ ××• ×¨×™×¤×• × ×‘×—×¨&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_full</span><span class="p">)</span>
            <span class="n">base_branch</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">default_branch</span> <span class="ow">or</span> <span class="s2">&quot;main&quot;</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[create_revert_pr_from_tag] repo=</span><span class="si">%s</span><span class="s2"> base=</span><span class="si">%s</span><span class="s2"> tag=</span><span class="si">%s</span><span class="s2"> user=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">repo_full</span><span class="p">,</span> <span class="n">base_branch</span><span class="p">,</span> <span class="n">tag_name</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>

            <span class="c1"># ××¦× ××ª ×”-SHA ×©×œ ×¢×¥ ×”×ª×’×™×ª (××ª××•×“×“ ×’× ×¢× ×ª×’×™×•×ª ××•×›×œ×œ×•×ª)</span>
            <span class="n">tag_tree_sha</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ref</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_git_ref</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tags/</span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">ref_obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">ref_type</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ref_obj</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">ref_sha</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ref_obj</span><span class="p">,</span> <span class="s2">&quot;sha&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[create_revert_pr_from_tag] ref_type=</span><span class="si">%s</span><span class="s2"> ref_sha=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ref_type</span><span class="p">,</span> <span class="n">ref_sha</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ref_type</span> <span class="o">==</span> <span class="s2">&quot;commit&quot;</span> <span class="ow">and</span> <span class="n">ref_sha</span><span class="p">:</span>
                    <span class="n">commit</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_commit</span><span class="p">(</span><span class="n">ref_sha</span><span class="p">)</span>
                    <span class="n">tag_tree_sha</span> <span class="o">=</span> <span class="n">commit</span><span class="o">.</span><span class="n">commit</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">sha</span>
                <span class="k">elif</span> <span class="n">ref_type</span> <span class="o">==</span> <span class="s2">&quot;tag&quot;</span> <span class="ow">and</span> <span class="n">ref_sha</span><span class="p">:</span>
                    <span class="c1"># ×ª×’×™×ª ××•×›×œ×œ×ª â€” × ×¤×¨×§ ×œ××•×‘×™×™×§×˜ ×”×™×¢×“</span>
                    <span class="n">tag_obj</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_git_tag</span><span class="p">(</span><span class="n">ref_sha</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[create_revert_pr_from_tag] annotated tag sha=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ref_sha</span><span class="p">)</span>
                    <span class="k">while</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">tag_obj</span><span class="p">,</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;tag&quot;</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[create_revert_pr_from_tag] peeling nested tag sha=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">tag_obj</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">sha</span><span class="p">)</span>
                        <span class="n">tag_obj</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_git_tag</span><span class="p">(</span><span class="n">tag_obj</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">sha</span><span class="p">)</span>
                    <span class="n">target_type</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tag_obj</span><span class="o">.</span><span class="n">object</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">target_sha</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tag_obj</span><span class="o">.</span><span class="n">object</span><span class="p">,</span> <span class="s2">&quot;sha&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[create_revert_pr_from_tag] tag target_type=</span><span class="si">%s</span><span class="s2"> target_sha=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">target_type</span><span class="p">,</span> <span class="n">target_sha</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">target_type</span> <span class="o">==</span> <span class="s2">&quot;commit&quot;</span> <span class="ow">and</span> <span class="n">target_sha</span><span class="p">:</span>
                        <span class="n">commit</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_commit</span><span class="p">(</span><span class="n">target_sha</span><span class="p">)</span>
                        <span class="n">tag_tree_sha</span> <span class="o">=</span> <span class="n">commit</span><span class="o">.</span><span class="n">commit</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">sha</span>
                    <span class="k">elif</span> <span class="n">target_type</span> <span class="o">==</span> <span class="s2">&quot;tree&quot;</span> <span class="ow">and</span> <span class="n">target_sha</span><span class="p">:</span>
                        <span class="n">tag_tree_sha</span> <span class="o">=</span> <span class="n">target_sha</span>
                <span class="k">elif</span> <span class="n">ref_type</span> <span class="o">==</span> <span class="s2">&quot;tree&quot;</span> <span class="ow">and</span> <span class="n">ref_sha</span><span class="p">:</span>
                    <span class="n">tag_tree_sha</span> <span class="o">=</span> <span class="n">ref_sha</span>
            <span class="k">except</span> <span class="n">GithubException</span> <span class="k">as</span> <span class="n">ge</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;[create_revert_pr_from_tag] get_git_ref failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ge</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">ge</span><span class="p">))</span>
                <span class="k">pass</span>

            <span class="c1"># × ×¤×™×œ×” ×œ-backup: ××¢×‘×¨ ×¢×œ get_tags (×¢×•×‘×“ ×œ×¨×•×‘ ×¢×œ ×ª×’×™×•×ª ×§×œ×™×œ×•×ª)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">tag_tree_sha</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[create_revert_pr_from_tag] fallback to repo.get_tags() for </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">tag_name</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_tags</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">tag_name</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">commit</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_commit</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">commit</span><span class="o">.</span><span class="n">sha</span><span class="p">)</span>
                            <span class="n">tag_tree_sha</span> <span class="o">=</span> <span class="n">commit</span><span class="o">.</span><span class="n">commit</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">sha</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[create_revert_pr_from_tag] fallback resolved tree=</span><span class="si">%s</span><span class="s2"> via commit=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">tag_tree_sha</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">commit</span><span class="o">.</span><span class="n">sha</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">inner_e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;[create_revert_pr_from_tag] fallback resolving tag failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">inner_e</span><span class="p">)</span>
                        <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">tag_tree_sha</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×œ× × ××¦××” ×”×ª×’×™×ª ×”××‘×•×§×©×ª&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="c1"># ×¦×•×¨ ×¢× ×£ ×¢×‘×•×“×” ×—×“×© ××©× ×‘×¨×•×¨</span>
            <span class="n">safe_branch</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^A-Za-z0-9._/-]+&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;restore-from-</span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">work_branch</span> <span class="o">=</span> <span class="n">safe_branch</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">base_sha</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_branch</span><span class="p">(</span><span class="n">base_branch</span><span class="p">)</span><span class="o">.</span><span class="n">commit</span><span class="o">.</span><span class="n">sha</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[create_revert_pr_from_tag] creating work branch=</span><span class="si">%s</span><span class="s2"> from base_sha=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">work_branch</span><span class="p">,</span> <span class="n">base_sha</span><span class="p">)</span>
                <span class="n">repo</span><span class="o">.</span><span class="n">create_git_ref</span><span class="p">(</span><span class="n">ref</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;refs/heads/</span><span class="si">{</span><span class="n">work_branch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sha</span><span class="o">=</span><span class="n">base_sha</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">GithubException</span> <span class="k">as</span> <span class="n">gbe</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">gbe</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="mi">422</span><span class="p">:</span>
                    <span class="n">work_branch</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">safe_branch</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">base_sha</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_branch</span><span class="p">(</span><span class="n">base_branch</span><span class="p">)</span><span class="o">.</span><span class="n">commit</span><span class="o">.</span><span class="n">sha</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[create_revert_pr_from_tag] branch exists, retry with </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">work_branch</span><span class="p">)</span>
                    <span class="n">repo</span><span class="o">.</span><span class="n">create_git_ref</span><span class="p">(</span><span class="n">ref</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;refs/heads/</span><span class="si">{</span><span class="n">work_branch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sha</span><span class="o">=</span><span class="n">base_sha</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span>

            <span class="c1"># ×¦×•×¨ commit ×—×“×© ×‘×¢×‘×•×“×” ×¢× tree ×©×œ ×”×ª×’×™×ª ×•×”×•×¨×” ××”-base</span>
            <span class="n">base_head</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_branch</span><span class="p">(</span><span class="n">base_branch</span><span class="p">)</span><span class="o">.</span><span class="n">commit</span><span class="o">.</span><span class="n">sha</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_git_commit</span><span class="p">(</span><span class="n">base_head</span><span class="p">)</span>
            <span class="n">new_tree</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_git_tree</span><span class="p">(</span><span class="n">tag_tree_sha</span><span class="p">)</span>
            <span class="n">new_commit_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Restore repository state from tag </span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[create_revert_pr_from_tag] creating git commit on </span><span class="si">%s</span><span class="s2"> with tree=</span><span class="si">%s</span><span class="s2"> parent=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">work_branch</span><span class="p">,</span> <span class="n">tag_tree_sha</span><span class="p">,</span> <span class="n">base_head</span><span class="p">)</span>
            <span class="n">new_commit</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">create_git_commit</span><span class="p">(</span><span class="n">new_commit_message</span><span class="p">,</span> <span class="n">new_tree</span><span class="p">,</span> <span class="p">[</span><span class="n">parent</span><span class="p">])</span>
            <span class="c1"># ×¢×“×›×Ÿ ××ª ×”-ref ×©×œ ×”×¢× ×£ ×”×—×“×© ×œ-commit ×”×—×“×©</span>
            <span class="n">repo</span><span class="o">.</span><span class="n">get_git_ref</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;heads/</span><span class="si">{</span><span class="n">work_branch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">edit</span><span class="p">(</span><span class="n">new_commit</span><span class="o">.</span><span class="n">sha</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[create_revert_pr_from_tag] updated ref heads/</span><span class="si">%s</span><span class="s2"> -&gt; </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">work_branch</span><span class="p">,</span> <span class="n">new_commit</span><span class="o">.</span><span class="n">sha</span><span class="p">)</span>

            <span class="c1"># ×¤×ª×— PR</span>
            <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Restore to checkpoint: </span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">body</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;This PR restores the repository state to tag `</span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s2">` by creating a new commit with the tag&#39;s tree on top of `</span><span class="si">{</span><span class="n">base_branch</span><span class="si">}</span><span class="s2">`.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Created via Telegram bot.&quot;</span>
            <span class="p">)</span>
            <span class="n">pr</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">create_pull</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">,</span> <span class="n">head</span><span class="o">=</span><span class="n">work_branch</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="n">base_branch</span><span class="p">)</span>
            <span class="n">kb</span> <span class="o">=</span> <span class="p">[[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)]]</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;âœ… × ×¤×ª×— PR: &lt;a href=</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">pr</span><span class="o">.</span><span class="n">html_url</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&gt;#</span><span class="si">{</span><span class="n">pr</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">&lt;/a&gt; â† &lt;code&gt;</span><span class="si">{</span><span class="n">base_branch</span><span class="si">}</span><span class="s2">&lt;/code&gt; â† &lt;code&gt;</span><span class="si">{</span><span class="n">work_branch</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">GithubException</span> <span class="k">as</span> <span class="n">ge</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Validation Failed&quot;</span>
            <span class="n">details</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">ge</span><span class="o">.</span><span class="n">data</span> <span class="ow">or</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">):</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
                <span class="n">details</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;[create_revert_pr_from_tag] GithubException: </span><span class="si">%s</span><span class="s2"> data=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">details</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª PR ×œ×©×—×–×•×¨: </span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;[create_revert_pr_from_tag] Unexpected error: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª PR ×œ×©×—×–×•×¨: </span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.create_branch_from_commit">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.create_branch_from_commit">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_branch_from_commit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">commit_sha</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×™×•×¦×¨ ×¢× ×£ ×—×“×© ×”××¦×‘×™×¢ ×œ-commit ×©× ×‘×—×¨&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_full</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_full</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×—×¡×¨ ×˜×•×§×Ÿ ××• ×¨×™×¤×• × ×‘×—×¨&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_full</span><span class="p">)</span>
            <span class="n">commit_obj</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_commit</span><span class="p">(</span><span class="n">commit_sha</span><span class="p">)</span>
            <span class="n">base_branch_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;restore-</span><span class="si">{</span><span class="n">commit_sha</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">safe_branch</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^A-Za-z0-9._/-]+&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">base_branch_name</span><span class="p">)</span>
            <span class="n">branch_name</span> <span class="o">=</span> <span class="n">safe_branch</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">repo</span><span class="o">.</span><span class="n">create_git_ref</span><span class="p">(</span><span class="n">ref</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;refs/heads/</span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sha</span><span class="o">=</span><span class="n">commit_obj</span><span class="o">.</span><span class="n">sha</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">GithubException</span> <span class="k">as</span> <span class="n">gbe</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">gbe</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="mi">422</span><span class="p">:</span>
                    <span class="n">branch_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">safe_branch</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">repo</span><span class="o">.</span><span class="n">create_git_ref</span><span class="p">(</span><span class="n">ref</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;refs/heads/</span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sha</span><span class="o">=</span><span class="n">commit_obj</span><span class="o">.</span><span class="n">sha</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span>
            <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”€ ×¤×ª×— PR ××”×¢× ×£&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;open_pr_from_branch:</span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;restore_commit_menu&quot;</span><span class="p">)],</span>
            <span class="p">]</span>
            <span class="n">success_text</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;âœ… × ×•×¦×¨ ×¢× ×£ ×©×—×–×•×¨: &lt;code&gt;</span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;SHA ××§×•×¨: &lt;code&gt;</span><span class="si">{</span><span class="n">commit_sha</span><span class="p">[:</span><span class="mi">12</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;×©×—×–×•×¨ ××§×•××™: &lt;code&gt;git fetch origin &amp;&amp; git checkout </span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="n">text</span><span class="o">=</span><span class="n">success_text</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">GithubException</span> <span class="k">as</span> <span class="n">ge</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ge</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="p">{})</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">ge</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª ×¢× ×£: </span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª ×¢× ×£: </span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.create_revert_pr_from_commit">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.create_revert_pr_from_commit">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_revert_pr_from_commit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">commit_sha</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×¤×•×ª×— PR ×©××—×–×™×¨ ××ª ×”×¢× ×£ ×”×¨××©×™ ×œ××¦×‘ ×§×•××™×˜ × ×ª×•×Ÿ&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_full</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_full</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×—×¡×¨ ×˜×•×§×Ÿ ××• ×¨×™×¤×• × ×‘×—×¨&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_full</span><span class="p">)</span>
            <span class="n">preferred_branch</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;restore_commits_branch&quot;</span><span class="p">)</span>
            <span class="n">base_branch</span> <span class="o">=</span> <span class="n">preferred_branch</span> <span class="ow">or</span> <span class="n">repo</span><span class="o">.</span><span class="n">default_branch</span> <span class="ow">or</span> <span class="s2">&quot;main&quot;</span>
            <span class="n">commit_obj</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_commit</span><span class="p">(</span><span class="n">commit_sha</span><span class="p">)</span>
            <span class="n">tree_sha</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">commit_obj</span><span class="o">.</span><span class="n">commit</span><span class="p">,</span> <span class="s2">&quot;tree&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;sha&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">tree_sha</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×œ× × ×™×ª×Ÿ ×œ××ª×¨ ××ª ×¢×¥ ×”×§×•××™×˜ ×œ×©×—×–×•×¨&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">work_branch_base</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^A-Za-z0-9._/-]+&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;restore-from-</span><span class="si">{</span><span class="n">commit_sha</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">work_branch</span> <span class="o">=</span> <span class="n">work_branch_base</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">base_ref</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_branch</span><span class="p">(</span><span class="n">base_branch</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">GithubException</span><span class="p">:</span>
                <span class="n">base_branch</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">default_branch</span> <span class="ow">or</span> <span class="s2">&quot;main&quot;</span>
                <span class="n">base_ref</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_branch</span><span class="p">(</span><span class="n">base_branch</span><span class="p">)</span>
            <span class="n">base_sha</span> <span class="o">=</span> <span class="n">base_ref</span><span class="o">.</span><span class="n">commit</span><span class="o">.</span><span class="n">sha</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">repo</span><span class="o">.</span><span class="n">create_git_ref</span><span class="p">(</span><span class="n">ref</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;refs/heads/</span><span class="si">{</span><span class="n">work_branch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sha</span><span class="o">=</span><span class="n">base_sha</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">GithubException</span> <span class="k">as</span> <span class="n">gbe</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">gbe</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="mi">422</span><span class="p">:</span>
                    <span class="n">work_branch</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">work_branch_base</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">repo</span><span class="o">.</span><span class="n">create_git_ref</span><span class="p">(</span><span class="n">ref</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;refs/heads/</span><span class="si">{</span><span class="n">work_branch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sha</span><span class="o">=</span><span class="n">base_sha</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span>
            <span class="n">parent_commit</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_git_commit</span><span class="p">(</span><span class="n">base_sha</span><span class="p">)</span>
            <span class="n">new_tree</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_git_tree</span><span class="p">(</span><span class="n">tree_sha</span><span class="p">)</span>
            <span class="n">new_commit_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Restore repository state to commit </span><span class="si">{</span><span class="n">commit_sha</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">new_commit</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">create_git_commit</span><span class="p">(</span><span class="n">new_commit_message</span><span class="p">,</span> <span class="n">new_tree</span><span class="p">,</span> <span class="p">[</span><span class="n">parent_commit</span><span class="p">])</span>
            <span class="n">repo</span><span class="o">.</span><span class="n">get_git_ref</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;heads/</span><span class="si">{</span><span class="n">work_branch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">edit</span><span class="p">(</span><span class="n">new_commit</span><span class="o">.</span><span class="n">sha</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Restore to commit </span><span class="si">{</span><span class="n">commit_sha</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">body</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;This PR restores the repository to commit `</span><span class="si">{</span><span class="n">commit_sha</span><span class="si">}</span><span class="s2">` by recreating its tree &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;on top of `</span><span class="si">{</span><span class="n">base_branch</span><span class="si">}</span><span class="s2">`.</span><span class="se">\n\n</span><span class="s2">× ×•×¦×¨ ××•×˜×•××˜×™×ª ×“×¨×š ×‘×•×˜ CodeBot&quot;</span>
            <span class="p">)</span>
            <span class="n">pr</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">create_pull</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">,</span> <span class="n">head</span><span class="o">=</span><span class="n">work_branch</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="n">base_branch</span><span class="p">)</span>
            <span class="n">kb</span> <span class="o">=</span> <span class="p">[[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)]]</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;âœ… × ×¤×ª×— PR: &lt;a href=</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">pr</span><span class="o">.</span><span class="n">html_url</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&gt;#</span><span class="si">{</span><span class="n">pr</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">&lt;/a&gt; â† &lt;code&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">base_branch</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/code&gt; â† &lt;code&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">work_branch</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">GithubException</span> <span class="k">as</span> <span class="n">ge</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ge</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="p">{})</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">ge</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª PR ×¨×•×œ×‘××§: </span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª PR ×¨×•×œ×‘××§: </span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.show_github_backup_menu">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_github_backup_menu">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">show_github_backup_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;××¦×™×’ ×ª×¤×¨×™×˜ ×’×™×‘×•×™/×©×—×–×•×¨ ×¢×‘×•×¨ ×”×¨×™×¤×• ×”× ×‘×—×¨&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_full</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_full</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×—×¡×¨ ×˜×•×§×Ÿ ××• ×¨×™×¤×• × ×‘×—×¨&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="k">raise</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;âŒ ×—×¡×¨ ×˜×•×§×Ÿ ××• ×¨×™×¤×• × ×‘×—×¨&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">return</span>
        <span class="c1"># ×›× ×™×¡×” ×œ×ª×¤×¨×™×˜ ×’×™×‘×•×™/×©×—×–×•×¨ ××ª×—×™×œ×” ×–×¨× ×—×“×© â€“ × ×§×” × ×¢×™×œ×•×ª/×¡×˜×™×™×˜×™× ×§×•×“××™×</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;zip_restore_expected_repo_full&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;github_restore_zip_purge&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;pending_repo_restore_zip_path&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="c1"># ×¡××Ÿ ×”×§×©×¨ ×›×“×™ ×œ××¤×©×¨ ×¡×™× ×•×Ÿ ×’×™×‘×•×™×™× ×œ×¤×™ ×”×¨×™×¤×• ×”× ×•×›×—×™</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;github_backup_context_repo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">repo_full</span>
        <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ“¦ ×”×•×¨×“ ×’×™×‘×•×™ ZIP ×©×œ ×”×¨×™×¤×•&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;download_zip:&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;â™»ï¸ ×©×—×–×¨ ZIP ×œ×¨×™×¤×• (×¤×¨×™×¡×” ×•×”×—×œ×¤×”)&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_restore_zip_to_repo&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ“‚ ×©×—×–×¨ ××’×™×‘×•×™ ×©××•×¨ ×œ×¨×™×¤×•&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_restore_zip_list&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ· × ×§×•×“×ª ×©××™×¨×” ×‘×’×™×˜&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;git_checkpoint&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;â†©ï¸ ×—×–×¨×” ×œ× ×§×•×“×ª ×©××™×¨×”&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;restore_checkpoint_menu&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”„ ×¨×•×œ×‘××§ ×œ×¤×™ ×§×•××™×˜&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;restore_commit_menu&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ—‚ ×’×™×‘×•×™×™ DB ××—×¨×•× ×™×&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_backup_db_list&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;â™»ï¸ ×©×—×–×•×¨ ××’×™×‘×•×™ (ZIP)&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;backup_restore_full_start&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;â„¹ï¸ ×”×¡×‘×¨ ×¢×œ ×”×›×¤×ª×•×¨×™×&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_backup_help&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)],</span>
        <span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ§° ×ª×¤×¨×™×˜ ×’×™×‘×•×™ ×•×©×—×–×•×¨ ×œ×¨×™×¤×•:</span><span class="se">\n</span><span class="s2">&lt;code&gt;</span><span class="si">{</span><span class="n">repo_full</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="c1"># ×¤×¨×¡×•× ×”×•×“×¢×” ×—×“×©×” ×›×’×™×‘×•×™</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;ğŸ§° ×ª×¤×¨×™×˜ ×’×™×‘×•×™ ×•×©×—×–×•×¨ ×œ×¨×™×¤×•:</span><span class="se">\n</span><span class="s2">&lt;code&gt;</span><span class="si">{</span><span class="n">repo_full</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span>
                    <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;××™×Ÿ ×©×™× ×•×™ ×‘×ª×¦×•×’×”&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="k">return</span>

        <span class="c1"># Unreachable guard to satisfy linters if parser confuses block ends</span>
        <span class="k">if</span> <span class="kc">False</span> <span class="ow">and</span> <span class="p">(</span><span class="n">query</span> <span class="ow">and</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;github_restore_zip_to_repo&quot;</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;github_restore_zip_setpurge:&quot;</span><span class="p">):</span>
            <span class="n">purge_flag</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span>
            <span class="c1"># ×•×“× ×©× ×™×§×™× ×• ×“×’×œ×™× ×™×©× ×™× ×©×œ ×”×¢×œ××” ×¨×’×™×œ×” ×›×“×™ ×œ×× ×•×¢ ×‘×œ×‘×•×œ</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_github_upload&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;upload_mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;github_restore_zip_to_repo&quot;</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;github_restore_zip_purge&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">purge_flag</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="p">(</span><span class="s2">&quot;ğŸ§¹ ×™×‘×•×¦×¢ × ×™×§×•×™ ×œ×¤× ×™ ×”×¢×œ××”. &quot;</span> <span class="k">if</span> <span class="n">purge_flag</span> <span class="k">else</span> <span class="s2">&quot;ğŸ” ×œ×œ× ××—×™×§×”. &quot;</span><span class="p">)</span> <span class="o">+</span>
                <span class="s2">&quot;×©×œ×— ×¢×›×©×™×• ×§×•×‘×¥ ZIP ×œ×©×—×–×•×¨ ×œ×¨×™×¤×•.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;github_restore_zip_list&quot;</span><span class="p">:</span>
            <span class="c1"># ×”×¦×’ ×¨×©×™××ª ×’×™×‘×•×™×™× (ZIP) ×©×œ ×”×¨×™×¤×• ×”× ×•×›×—×™ ×œ×¦×•×¨×š ×©×—×–×•×¨ ×œ×¨×™×¤×•</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
            <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">repo_full</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">repo_full</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×§×•×“× ×‘×—×¨ ×¨×™×¤×•!&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">file_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">backup_manager</span>
            <span class="n">backups</span> <span class="o">=</span> <span class="n">backup_manager</span><span class="o">.</span><span class="n">list_backups</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="c1"># ×¡× ×Ÿ ×¨×§ ×’×™×‘×•×™×™× ×¢× metadata ×©×œ ××•×ª×• ×¨×™×¤×•</span>
            <span class="n">backups</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">backups</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s1">&#39;repo&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="n">repo_full</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">backups</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;â„¹ï¸ ××™×Ÿ ×’×™×‘×•×™×™ ZIP ×©××•×¨×™× ×¢×‘×•×¨ ×”×¨×™×¤×•:</span><span class="se">\n</span><span class="s2">&lt;code&gt;</span><span class="si">{</span><span class="n">repo_full</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span><span class="p">,</span>
                    <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">([[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_backup_menu&quot;</span><span class="p">)]])</span>
                <span class="p">)</span>
                <span class="k">return</span>
            <span class="c1"># ×”×¦×’ ×¢×“ 10 ××—×¨×•× ×™×</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">backups</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;×‘×—×¨ ×’×™×‘×•×™ ×œ×©×—×–×•×¨ ×œ×¨×™×¤×•:</span><span class="se">\n</span><span class="s2">&lt;code&gt;</span><span class="si">{</span><span class="n">repo_full</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">]</span>
            <span class="n">kb</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;â€¢ </span><span class="si">{</span><span class="n">b</span><span class="o">.</span><span class="n">backup_id</span><span class="si">}</span><span class="s2"> â€” </span><span class="si">{</span><span class="n">b</span><span class="o">.</span><span class="n">created_at</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/%m/%Y %H:%M&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> â€” </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">total_size</span><span class="o">/</span><span class="mi">1024</span><span class="p">)</span><span class="si">}</span><span class="s2">KB&quot;</span><span class="p">)</span>
                <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;â™»ï¸ ×©×—×–×¨ ×’×™×‘×•×™ ×–×” ×œ×¨×™×¤×•&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;github_restore_zip_from_backup:</span><span class="si">{</span><span class="n">b</span><span class="o">.</span><span class="n">backup_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
            <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×•×¨&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_backup_menu&quot;</span><span class="p">)])</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;github_restore_zip_from_backup:&quot;</span><span class="p">):</span>
            <span class="c1"># ×§×‘×œ backup_id ×•××– ×¤×ª×— ××ª ×ª×”×œ×™×š ×”×©×—×–×•×¨-×œ×¨×™×¤×• ×¢× ×§×•×‘×¥ ×”-ZIP ×”×–×”</span>
            <span class="n">backup_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">file_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">backup_manager</span>
            <span class="n">info_list</span> <span class="o">=</span> <span class="n">backup_manager</span><span class="o">.</span><span class="n">list_backups</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">match</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">info_list</span> <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">backup_id</span> <span class="o">==</span> <span class="n">backup_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">match</span><span class="o">.</span><span class="n">file_path</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">file_path</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×”×’×™×‘×•×™ ×œ× × ××¦× ×‘×“×™×¡×§&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="c1"># ×”×’×“×¨ purge? ×‘×§×© ×‘×—×™×¨×”</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;pending_repo_restore_zip_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">file_path</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="s2">&quot;×”×× ×œ××—×•×§ ×§×•×“× ××ª ×”×ª×•×›×Ÿ ×‘×¨×™×¤×• ×œ×¤× ×™ ×”×¢×œ××”?&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">([</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ§¹ ××—×™×§×” ××œ××” ×œ×¤× ×™ ×”×¢×œ××”&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_repo_restore_backup_setpurge:1&quot;</span><span class="p">)],</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸš« ××œ ×ª××—×§, ×¨×§ ×¢×“×›×Ÿ&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_repo_restore_backup_setpurge:0&quot;</span><span class="p">)],</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;âŒ ×‘×™×˜×•×œ&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_backup_menu&quot;</span><span class="p">)],</span>
                <span class="p">])</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;github_repo_restore_backup_setpurge:&quot;</span><span class="p">):</span>
            <span class="c1"># ×‘×¦×¢ ××ª ×”×”×¢×œ××” ×œ×¨×™×¤×• ××ª×•×š ×§×•×‘×¥ ×”-ZIP ×©××•×¨ ×‘×“×™×¡×§</span>
            <span class="n">purge_flag</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span>
            <span class="n">zip_path</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pending_repo_restore_zip_path&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">zip_path</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">zip_path</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×§×•×‘×¥ ZIP ×œ× × ××¦×&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="c1"># ×”×¤×¢×œ ×¨×™×¡×˜×•×¨ ×œ×¨×™×¤×• ×“×¨×š ×¤×•× ×§×¦×™×” ×—×™×¦×•× ×™×ª ×¤×©×•×˜×” ×©××ª×××©×§×ª ×¢× main.handle_document logic</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;â³ ××©×—×–×¨ ×œ×¨×™×¤×• ××’×™×‘×•×™ × ×‘×—×¨...&quot;</span><span class="p">)</span>
                <span class="c1"># × ×©×ª××© ×‘×œ×•×’×™×§×” ×¤×©×•×˜×”: × ×§×¨× ×œ×¤×•× ×§×¦×™×” ×¤× ×™××™×ª ×©×ª×‘×¦×¢ ××ª ××•×ª×• ×–×¨× ×©×œ ×©×—×–×•×¨ ×œ×¨×™×¤×•</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">restore_zip_file_to_repo</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">zip_path</span><span class="p">,</span> <span class="n">purge_flag</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;âœ… ×”×©×—×–×•×¨ ×”×•×¢×œ×” ×œ×¨×™×¤×• ×‘×”×¦×œ×—×”&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×©×—×–×•×¨ ×œ×¨×™×¤×•: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;pending_repo_restore_zip_path&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">return</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.restore_zip_file_to_repo">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.restore_zip_file_to_repo">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">restore_zip_file_to_repo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">zip_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">purge_first</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×©×—×–×•×¨ ×§×‘×¦×™× ×-ZIP ××§×•××™ ×œ×¨×™×¤×• ×”× ×•×›×—×™ ×‘×××¦×¢×•×ª Trees API (commit ××—×“)&quot;&quot;&quot;</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_full</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_full</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;×—×¡×¨ ×˜×•×§×Ÿ ××• ×¨×™×¤×•&quot;</span><span class="p">)</span>
        <span class="c1"># ×—×’×•×¨×ª ×‘×˜×™×—×•×ª: ××©×¨ ×©×”×™×¢×“ ×ª×•×× ××ª ×”×™×¢×“ ×©× × ×¢×œ ×‘×ª×—×™×œ×ª ×”-flow</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;zip_restore_expected_repo_full&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">expected</span> <span class="ow">and</span> <span class="n">expected</span> <span class="o">!=</span> <span class="n">repo_full</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[restore_zip_from_backup] Target mismatch: expected=</span><span class="si">{</span><span class="n">expected</span><span class="si">}</span><span class="s2">, got=</span><span class="si">{</span><span class="n">repo_full</span><span class="si">}</span><span class="s2">. Aborting.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Target mismatch: expected </span><span class="si">{</span><span class="n">expected</span><span class="si">}</span><span class="s2">, got </span><span class="si">{</span><span class="n">repo_full</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">expected</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;zip_restore_expected_repo_full&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">repo_full</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">zipfile</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">zip_path</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">is_zipfile</span><span class="p">(</span><span class="n">zip_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;ZIP ×œ× ×ª×§×™×Ÿ&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">zip_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zf</span><span class="p">:</span>
            <span class="c1"># ×¡×™× ×•×Ÿ ×§×‘×¦×™ ××¢×¨×›×ª ×œ× ×¨×œ×•×•× ×˜×™×™×</span>
            <span class="n">all_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">zf</span><span class="o">.</span><span class="n">namelist</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)]</span>
            <span class="n">members</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">all_names</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;__MACOSX/&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">n</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;._&#39;</span><span class="p">))]</span>
            <span class="c1"># ×–×™×”×•×™ ×ª×™×§×™×™×ª-×©×•×¨×© ××©×•×ª×¤×ª</span>
            <span class="n">top_levels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">zf</span><span class="o">.</span><span class="n">namelist</span><span class="p">():</span>
                <span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">n</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;__MACOSX/&#39;</span><span class="p">):</span>
                    <span class="n">top_levels</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">common_root</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">top_levels</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">top_levels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[restore_zip_from_backup] Detected common_root=</span><span class="si">{</span><span class="n">common_root</span><span class="si">!r}</span><span class="s2">, files_in_zip=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">members</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">strip_root</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">common_root</span> <span class="ow">and</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">common_root</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">path</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">common_root</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
                <span class="k">return</span> <span class="n">path</span>
            <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">members</span><span class="p">:</span>
                <span class="n">raw</span> <span class="o">=</span> <span class="n">zf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">clean</span> <span class="o">=</span> <span class="n">strip_root</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">clean</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">clean</span><span class="p">,</span> <span class="n">raw</span><span class="p">))</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_full</span><span class="p">)</span>
        <span class="n">target_branch</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">default_branch</span> <span class="ow">or</span> <span class="s1">&#39;main&#39;</span>
        <span class="n">base_ref</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_git_ref</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;heads/</span><span class="si">{</span><span class="n">target_branch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">base_commit</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_git_commit</span><span class="p">(</span><span class="n">base_ref</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">sha</span><span class="p">)</span>
        <span class="n">base_tree</span> <span class="o">=</span> <span class="n">base_commit</span><span class="o">.</span><span class="n">tree</span>
        <span class="n">elements</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">raw</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="c1"># ×›×ª×•×‘ blob ××ª××™×: ×˜×§×¡×˜ ×›-utf-8, ×‘×™× ××¨×™ ×›-base64</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">base64</span>
            <span class="n">is_text</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span> <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="s1">&#39;.md&#39;</span><span class="p">,</span> <span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;.json&#39;</span><span class="p">,</span> <span class="s1">&#39;.yml&#39;</span><span class="p">,</span> <span class="s1">&#39;.yaml&#39;</span><span class="p">,</span> <span class="s1">&#39;.xml&#39;</span><span class="p">,</span> <span class="s1">&#39;.gitignore&#39;</span><span class="p">,</span> <span class="s1">&#39;.py&#39;</span><span class="p">,</span> <span class="s1">&#39;.js&#39;</span><span class="p">,</span> <span class="s1">&#39;.ts&#39;</span><span class="p">,</span> <span class="s1">&#39;.tsx&#39;</span><span class="p">,</span> <span class="s1">&#39;.css&#39;</span><span class="p">,</span> <span class="s1">&#39;.scss&#39;</span><span class="p">,</span> <span class="s1">&#39;.html&#39;</span><span class="p">,</span> <span class="s1">&#39;.sh&#39;</span>
            <span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">is_text</span><span class="p">:</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                    <span class="n">blob</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">create_git_blob</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">b64</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
                    <span class="n">blob</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">create_git_blob</span><span class="p">(</span><span class="n">b64</span><span class="p">,</span> <span class="s1">&#39;base64&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">b64</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
                <span class="n">blob</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">create_git_blob</span><span class="p">(</span><span class="n">b64</span><span class="p">,</span> <span class="s1">&#39;base64&#39;</span><span class="p">)</span>
            <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InputGitTreeElement</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;100644&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;blob&#39;</span><span class="p">,</span> <span class="n">sha</span><span class="o">=</span><span class="n">blob</span><span class="o">.</span><span class="n">sha</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">purge_first</span><span class="p">:</span>
            <span class="c1"># Soft purge: ×™×¦×™×¨×ª ×¢×¥ ×—×“×© ×œ×œ× ×‘×¡×™×¡ (××•×—×§ ×§×‘×¦×™× ×©××™× × ×‘-ZIP)</span>
            <span class="n">new_tree</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">create_git_tree</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_tree</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">create_git_tree</span><span class="p">(</span><span class="n">elements</span><span class="p">,</span> <span class="n">base_tree</span><span class="p">)</span>
        <span class="n">commit_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Restore from ZIP via bot: replace </span><span class="si">{</span><span class="s1">&#39;with purge&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">purge_first</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;update only&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">new_commit</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">create_git_commit</span><span class="p">(</span><span class="n">commit_message</span><span class="p">,</span> <span class="n">new_tree</span><span class="p">,</span> <span class="p">[</span><span class="n">base_commit</span><span class="p">])</span>
        <span class="n">base_ref</span><span class="o">.</span><span class="n">edit</span><span class="p">(</span><span class="n">new_commit</span><span class="o">.</span><span class="n">sha</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[restore_zip_from_backup] Restore commit created: </span><span class="si">{</span><span class="n">new_commit</span><span class="o">.</span><span class="n">sha</span><span class="si">}</span><span class="s2">, files_added=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span><span class="si">}</span><span class="s2">, purge=</span><span class="si">{</span><span class="n">purge_first</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># × ×™×§×•×™ ×¡×˜×™×™×˜ ×”×’× ×” ××—×¨×™ ×”×¦×œ×—×”</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;zip_restore_expected_repo_full&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Development Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>