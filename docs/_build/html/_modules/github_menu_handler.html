

<!DOCTYPE html>
<html class="writer-html5" lang="he" data-content_root="../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>github_menu_handler &mdash; תיעוד Code Keeper Bot 1.0.0</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=2d7a82d5" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=0062297a"></script>
      <script src="../_static/doctools.js?v=9a2dae69"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/translations.js?v=714bf7a6"></script>
      <script src="https://unpkg.com/mermaid@10.2.0/dist/mermaid.min.js"></script>
      <script>mermaid.initialize({startOnLoad:true});</script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="אינדקס" href="../genindex.html" />
    <link rel="search" title="חיפוש" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Code Keeper Bot
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">למפתחים ולסוכני AI:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quickstart-ai.html">התחלה מהירה - סוכני AI</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#id1">מטרה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#id2">מה אסור</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#id3">מה מותר ומומלץ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#id4">פורמטי ציטוט קוד</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#tmp">מחיקה בטוחה (רק ב-/tmp)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#pr">קומיטים ו-PR</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#id5">קישורים מהירים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">התחלה מהירה - מפתחים</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#id2">מטרה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#id3">שלב 1: התקנה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#env">שלב 2: הגדרת .env</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#id4">שלב 3: הרצה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#id5">מה הלאה?</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart-contrib.html">Quickstart לתרומה</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-contrib.html#id1">מטרה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-contrib.html#id2">צעדי הכנה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-contrib.html#id3">סביבת פיתוח</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-contrib.html#id4">הרצת טסטים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-contrib.html#stubs">על ה‑Stubs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-contrib.html#id5">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ai-guidelines.html">הנחיות מלאות לסוכני AI</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../ai-guidelines.html#id1">מגבלות קריטיות</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../ai-guidelines.html#id2">הרצת פקודות</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../ai-guidelines.html#id3">כלי קבצים מאושרים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ai-guidelines.html#id4">עקרונות עריכת קוד</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ai-guidelines.html#pull-requests">קומיטים ו-Pull Requests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ai-guidelines.html#id5">עבודה עם טסטים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ai-guidelines.html#id6">קישורים מהירים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../doc-authoring.html">Doc Authoring Guide (Sphinx/RTD)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../doc-authoring.html#id1">מטרות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../doc-authoring.html#id2">מדיניות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../doc-authoring.html#id3">טיפים מהירים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../doc-authoring.html#id4">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../style-glossary.html">Style &amp; Naming Glossary</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../style-glossary.html#id1">מטרות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../style-glossary.html#id2">מיפוי מונחים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../style-glossary.html#id3">כללים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../style-glossary.html#id4">עוגני תיעוד</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../versioning-stable-anchors.html">Versioning &amp; Stable Anchors</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../versioning-stable-anchors.html#id1">מדיניות עוגנים יציבים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../versioning-stable-anchors.html#whats-new">What’s New</a></li>
<li class="toctree-l2"><a class="reference internal" href="../versioning-stable-anchors.html#anchors">דוגמת Anchors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../versioning-stable-anchors.html#id2">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../whats-new.html">What’s New</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../whats-new.html#id1">2025-10-15</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../architecture.html">ארכיטקטורה</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#id2">סקירה כללית</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#id3">תרשים רכיבים (תמציתי)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#id4">מבנה תיקיות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#id5">זרימות מרכזיות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#id6">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">מדריך תרומה</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../contributing.html#id2">מטרה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributing.html#id3">כללים כלליים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributing.html#workflow">Workflow בסיסי</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributing.html#id4">דוגמאות שימושיות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributing.html#id5">קישורים</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">מדריכים בסיסיים:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">התקנה והגדרה</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#id2">דרישות מערכת</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#id3">התקנה מהירה</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#id4">1. שכפל את הריפוזיטורי</a></li>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#id5">2. התקן תלויות</a></li>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#id6">3. הגדר משתני סביבה</a></li>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#id7">4. הפעל את הבוט</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#docker">התקנה עם Docker</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#image">1. בנה את ה-Image</a></li>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#docker-compose">2. הפעל עם Docker Compose</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#mongodb">הגדרת MongoDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#telegram-bot">הגדרת Telegram Bot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#id8">הגדרות מתקדמות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#id9">בדיקת התקנה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#id10">פתרון בעיות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#id11">תמיכה</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../configuration.html">הגדרות תצורה</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#id2">קובץ התצורה הראשי</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#id3">משתני סביבה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#id4">הגדרות מתקדמות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#mongodb">הגדרת MongoDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#redis-cache">הגדרת Redis Cache</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#id5">הגדרות אבטחה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#id6">תצורה לסביבות שונות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#env">דוגמת קובץ .env מלא</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#id7">טיפים וטריקים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../environment-variables.html">משתני סביבה - רפרנס</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../environment-variables.html#id2">טבלה מרכזית</a></li>
<li class="toctree-l2"><a class="reference internal" href="../environment-variables.html#id3">דוגמאות קונפיגורציה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../environment-variables.html#id4">קישורים</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../api/main.html">main module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/config.html">config module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/config.html#config.BotConfig"><code class="docutils literal notranslate"><span class="pre">BotConfig</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.BOT_TOKEN"><code class="docutils literal notranslate"><span class="pre">BotConfig.BOT_TOKEN</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MONGODB_URL"><code class="docutils literal notranslate"><span class="pre">BotConfig.MONGODB_URL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.DATABASE_NAME"><code class="docutils literal notranslate"><span class="pre">BotConfig.DATABASE_NAME</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.REDIS_URL"><code class="docutils literal notranslate"><span class="pre">BotConfig.REDIS_URL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.CACHE_ENABLED"><code class="docutils literal notranslate"><span class="pre">BotConfig.CACHE_ENABLED</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.GITHUB_TOKEN"><code class="docutils literal notranslate"><span class="pre">BotConfig.GITHUB_TOKEN</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.PASTEBIN_API_KEY"><code class="docutils literal notranslate"><span class="pre">BotConfig.PASTEBIN_API_KEY</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MAX_CODE_SIZE"><code class="docutils literal notranslate"><span class="pre">BotConfig.MAX_CODE_SIZE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MAX_FILES_PER_USER"><code class="docutils literal notranslate"><span class="pre">BotConfig.MAX_FILES_PER_USER</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.SUPPORTED_LANGUAGES"><code class="docutils literal notranslate"><span class="pre">BotConfig.SUPPORTED_LANGUAGES</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.RECYCLE_TTL_DAYS"><code class="docutils literal notranslate"><span class="pre">BotConfig.RECYCLE_TTL_DAYS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.PUBLIC_BASE_URL"><code class="docutils literal notranslate"><span class="pre">BotConfig.PUBLIC_BASE_URL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.WEBAPP_URL"><code class="docutils literal notranslate"><span class="pre">BotConfig.WEBAPP_URL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MAINTENANCE_MODE"><code class="docutils literal notranslate"><span class="pre">BotConfig.MAINTENANCE_MODE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MAINTENANCE_MESSAGE"><code class="docutils literal notranslate"><span class="pre">BotConfig.MAINTENANCE_MESSAGE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MAINTENANCE_AUTO_WARMUP_SECS"><code class="docutils literal notranslate"><span class="pre">BotConfig.MAINTENANCE_AUTO_WARMUP_SECS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.RATE_LIMIT_PER_MINUTE"><code class="docutils literal notranslate"><span class="pre">BotConfig.RATE_LIMIT_PER_MINUTE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.HIGHLIGHT_THEME"><code class="docutils literal notranslate"><span class="pre">BotConfig.HIGHLIGHT_THEME</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.GIT_CHECKPOINT_PREFIX"><code class="docutils literal notranslate"><span class="pre">BotConfig.GIT_CHECKPOINT_PREFIX</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.GOOGLE_CLIENT_ID"><code class="docutils literal notranslate"><span class="pre">BotConfig.GOOGLE_CLIENT_ID</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.GOOGLE_CLIENT_SECRET"><code class="docutils literal notranslate"><span class="pre">BotConfig.GOOGLE_CLIENT_SECRET</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.GOOGLE_OAUTH_SCOPES"><code class="docutils literal notranslate"><span class="pre">BotConfig.GOOGLE_OAUTH_SCOPES</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.GOOGLE_TOKEN_REFRESH_MARGIN_SECS"><code class="docutils literal notranslate"><span class="pre">BotConfig.GOOGLE_TOKEN_REFRESH_MARGIN_SECS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.DRIVE_MENU_V2"><code class="docutils literal notranslate"><span class="pre">BotConfig.DRIVE_MENU_V2</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.DOCUMENTATION_URL"><code class="docutils literal notranslate"><span class="pre">BotConfig.DOCUMENTATION_URL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.BOT_LABEL"><code class="docutils literal notranslate"><span class="pre">BotConfig.BOT_LABEL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.DRIVE_ADD_HASH"><code class="docutils literal notranslate"><span class="pre">BotConfig.DRIVE_ADD_HASH</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.NORMALIZE_CODE_ON_SAVE"><code class="docutils literal notranslate"><span class="pre">BotConfig.NORMALIZE_CODE_ON_SAVE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.__init__"><code class="docutils literal notranslate"><span class="pre">BotConfig.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/config.html#config.load_config"><code class="docutils literal notranslate"><span class="pre">load_config()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/bot_handlers.html">bot_handlers module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/conversation_handlers.html">conversation_handlers module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/database.html">database package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/database.html#submodules">Submodules</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/database.manager.html">database.manager module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/database.models.html">database.models module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/database.repository.html">database.repository module</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/services.html">services package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/services.html#submodules">Submodules</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/services.backup_service.html">services.backup_service module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/services.code_service.html">services.code_service module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/services.github_service.html">services.github_service module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/services.google_drive_service.html">services.google_drive_service module</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/handlers.html">handlers package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/handlers.html#subpackages">Subpackages</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.github.html">handlers.github package</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/handlers.html#submodules">Submodules</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.file_view.html">handlers.file_view module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.pagination.html">handlers.pagination module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.save_flow.html">handlers.save_flow module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.states.html">handlers.states module</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/utils.html">utils module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.CodeErrorLogger"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CodeErrorLogger.__init__"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CodeErrorLogger.log_code_processing_error"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger.log_code_processing_error()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CodeErrorLogger.log_code_activity"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger.log_code_activity()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CodeErrorLogger.log_validation_failure"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger.log_validation_failure()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CodeErrorLogger.log_sanitization_success"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger.log_sanitization_success()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.TimeUtils"><code class="docutils literal notranslate"><span class="pre">TimeUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TimeUtils.format_relative_time"><code class="docutils literal notranslate"><span class="pre">TimeUtils.format_relative_time()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TimeUtils.parse_date_string"><code class="docutils literal notranslate"><span class="pre">TimeUtils.parse_date_string()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TimeUtils.get_time_ranges"><code class="docutils literal notranslate"><span class="pre">TimeUtils.get_time_ranges()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.TextUtils"><code class="docutils literal notranslate"><span class="pre">TextUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils.truncate_text"><code class="docutils literal notranslate"><span class="pre">TextUtils.truncate_text()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils.escape_markdown"><code class="docutils literal notranslate"><span class="pre">TextUtils.escape_markdown()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils.clean_filename"><code class="docutils literal notranslate"><span class="pre">TextUtils.clean_filename()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils.extract_hashtags"><code class="docutils literal notranslate"><span class="pre">TextUtils.extract_hashtags()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils.highlight_text"><code class="docutils literal notranslate"><span class="pre">TextUtils.highlight_text()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils.format_file_size"><code class="docutils literal notranslate"><span class="pre">TextUtils.format_file_size()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils.pluralize_hebrew"><code class="docutils literal notranslate"><span class="pre">TextUtils.pluralize_hebrew()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.SecurityUtils"><code class="docutils literal notranslate"><span class="pre">SecurityUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.SecurityUtils.generate_secure_token"><code class="docutils literal notranslate"><span class="pre">SecurityUtils.generate_secure_token()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.SecurityUtils.hash_content"><code class="docutils literal notranslate"><span class="pre">SecurityUtils.hash_content()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.SecurityUtils.validate_user_input"><code class="docutils literal notranslate"><span class="pre">SecurityUtils.validate_user_input()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.SecurityUtils.sanitize_code"><code class="docutils literal notranslate"><span class="pre">SecurityUtils.sanitize_code()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils"><code class="docutils literal notranslate"><span class="pre">TelegramUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.send_typing_action"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.send_typing_action()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.send_document_action"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.send_document_action()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.safe_answer"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.safe_answer()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.get_user_mention"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.get_user_mention()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.split_long_message"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.split_long_message()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.safe_edit_message_text"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.safe_edit_message_text()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.safe_edit_message_reply_markup"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.safe_edit_message_reply_markup()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.extract_message_text_preserve_markdown"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.extract_message_text_preserve_markdown()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.CallbackQueryGuard"><code class="docutils literal notranslate"><span class="pre">CallbackQueryGuard</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CallbackQueryGuard.DEFAULT_WINDOW_SECONDS"><code class="docutils literal notranslate"><span class="pre">CallbackQueryGuard.DEFAULT_WINDOW_SECONDS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CallbackQueryGuard.should_block"><code class="docutils literal notranslate"><span class="pre">CallbackQueryGuard.should_block()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CallbackQueryGuard.should_block_async"><code class="docutils literal notranslate"><span class="pre">CallbackQueryGuard.should_block_async()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.AsyncUtils"><code class="docutils literal notranslate"><span class="pre">AsyncUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.AsyncUtils.run_with_timeout"><code class="docutils literal notranslate"><span class="pre">AsyncUtils.run_with_timeout()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.AsyncUtils.batch_process"><code class="docutils literal notranslate"><span class="pre">AsyncUtils.batch_process()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.PerformanceUtils"><code class="docutils literal notranslate"><span class="pre">PerformanceUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.PerformanceUtils.timing_decorator"><code class="docutils literal notranslate"><span class="pre">PerformanceUtils.timing_decorator()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.PerformanceUtils.measure_time"><code class="docutils literal notranslate"><span class="pre">PerformanceUtils.measure_time()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.ValidationUtils"><code class="docutils literal notranslate"><span class="pre">ValidationUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.ValidationUtils.is_valid_filename"><code class="docutils literal notranslate"><span class="pre">ValidationUtils.is_valid_filename()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.ValidationUtils.is_safe_code"><code class="docutils literal notranslate"><span class="pre">ValidationUtils.is_safe_code()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.FileUtils"><code class="docutils literal notranslate"><span class="pre">FileUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.FileUtils.download_file"><code class="docutils literal notranslate"><span class="pre">FileUtils.download_file()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.FileUtils.get_file_extension"><code class="docutils literal notranslate"><span class="pre">FileUtils.get_file_extension()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.FileUtils.get_mime_type"><code class="docutils literal notranslate"><span class="pre">FileUtils.get_mime_type()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.FileUtils.create_temp_file"><code class="docutils literal notranslate"><span class="pre">FileUtils.create_temp_file()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.ConfigUtils"><code class="docutils literal notranslate"><span class="pre">ConfigUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.ConfigUtils.load_json_config"><code class="docutils literal notranslate"><span class="pre">ConfigUtils.load_json_config()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.ConfigUtils.save_json_config"><code class="docutils literal notranslate"><span class="pre">ConfigUtils.save_json_config()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.CacheUtils"><code class="docutils literal notranslate"><span class="pre">CacheUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CacheUtils.set"><code class="docutils literal notranslate"><span class="pre">CacheUtils.set()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CacheUtils.get"><code class="docutils literal notranslate"><span class="pre">CacheUtils.get()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CacheUtils.delete"><code class="docutils literal notranslate"><span class="pre">CacheUtils.delete()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CacheUtils.clear"><code class="docutils literal notranslate"><span class="pre">CacheUtils.clear()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.get_memory_usage"><code class="docutils literal notranslate"><span class="pre">get_memory_usage()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.setup_logging"><code class="docutils literal notranslate"><span class="pre">setup_logging()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.generate_summary_stats"><code class="docutils literal notranslate"><span class="pre">generate_summary_stats()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.detect_language_from_filename"><code class="docutils literal notranslate"><span class="pre">detect_language_from_filename()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.get_language_emoji"><code class="docutils literal notranslate"><span class="pre">get_language_emoji()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.SensitiveDataFilter"><code class="docutils literal notranslate"><span class="pre">SensitiveDataFilter</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.SensitiveDataFilter.filter"><code class="docutils literal notranslate"><span class="pre">SensitiveDataFilter.filter()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.install_sensitive_filter"><code class="docutils literal notranslate"><span class="pre">install_sensitive_filter()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.normalize_code"><code class="docutils literal notranslate"><span class="pre">normalize_code()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/modules.html">workspace</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/activity_reporter.html">activity_reporter module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/activity_reporter.html#activity_reporter.SimpleActivityReporter"><code class="docutils literal notranslate"><span class="pre">SimpleActivityReporter</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/activity_reporter.html#activity_reporter.create_reporter"><code class="docutils literal notranslate"><span class="pre">create_reporter()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/autocomplete_manager.html">autocomplete_manager module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/autocomplete_manager.html#autocomplete_manager.AutocompleteManager"><code class="docutils literal notranslate"><span class="pre">AutocompleteManager</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/backup_menu_handler.html">backup_menu_handler module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/backup_menu_handler.html#backup_menu_handler.emit_event"><code class="docutils literal notranslate"><span class="pre">emit_event()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/backup_menu_handler.html#backup_menu_handler.BackupMenuHandler"><code class="docutils literal notranslate"><span class="pre">BackupMenuHandler</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/batch_commands.html">batch_commands module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_commands.html#batch_commands.batch_analyze_command"><code class="docutils literal notranslate"><span class="pre">batch_analyze_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_commands.html#batch_commands.batch_validate_command"><code class="docutils literal notranslate"><span class="pre">batch_validate_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_commands.html#batch_commands.job_status_command"><code class="docutils literal notranslate"><span class="pre">job_status_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_commands.html#batch_commands.large_file_command"><code class="docutils literal notranslate"><span class="pre">large_file_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_commands.html#batch_commands.handle_batch_callbacks"><code class="docutils literal notranslate"><span class="pre">handle_batch_callbacks()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_commands.html#batch_commands.setup_batch_handlers"><code class="docutils literal notranslate"><span class="pre">setup_batch_handlers()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/batch_processor.html">batch_processor module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_processor.html#batch_processor.BatchJob"><code class="docutils literal notranslate"><span class="pre">BatchJob</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_processor.html#batch_processor.BatchProcessor"><code class="docutils literal notranslate"><span class="pre">BatchProcessor</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/bot_handlers.html">bot_handlers module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/cache_commands.html">cache_commands module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_commands.html#cache_commands.cache_stats_command"><code class="docutils literal notranslate"><span class="pre">cache_stats_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_commands.html#cache_commands.clear_cache_command"><code class="docutils literal notranslate"><span class="pre">clear_cache_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_commands.html#cache_commands.setup_cache_handlers"><code class="docutils literal notranslate"><span class="pre">setup_cache_handlers()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/cache_manager.html">cache_manager module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_manager.html#cache_manager.CacheManager"><code class="docutils literal notranslate"><span class="pre">CacheManager</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_manager.html#cache_manager.cached"><code class="docutils literal notranslate"><span class="pre">cached()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_manager.html#cache_manager.async_cached"><code class="docutils literal notranslate"><span class="pre">async_cached()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/code_preview.html">code_preview module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/code_preview.html#code_preview.CodePreviewManager"><code class="docutils literal notranslate"><span class="pre">CodePreviewManager</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/code_processor.html">code_processor module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/config.html">config module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig"><code class="docutils literal notranslate"><span class="pre">BotConfig</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.load_config"><code class="docutils literal notranslate"><span class="pre">load_config()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/conftest.html">conftest module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html">conversation_handlers module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/database.html">database package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/database.html#submodules">Submodules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/file_manager.html">file_manager module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/file_manager.html#file_manager.BackupInfo"><code class="docutils literal notranslate"><span class="pre">BackupInfo</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/file_manager.html#file_manager.BackupManager"><code class="docutils literal notranslate"><span class="pre">BackupManager</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/fix_telegram_parse_error.html">fix_telegram_parse_error module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/fix_telegram_parse_error.html#fix_telegram_parse_error.clean_for_telegram"><code class="docutils literal notranslate"><span class="pre">clean_for_telegram()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/fix_telegram_parse_error.html#fix_telegram_parse_error.apply_fix"><code class="docutils literal notranslate"><span class="pre">apply_fix()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/fix_telegram_parse_error.html#fix_telegram_parse_error.wrap_edit_message_calls"><code class="docutils literal notranslate"><span class="pre">wrap_edit_message_calls()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/github_menu_handler.html">github_menu_handler module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/github_menu_handler.html#github_menu_handler.emit_event"><code class="docutils literal notranslate"><span class="pre">emit_event()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_menu_handler.html#github_menu_handler.safe_html_escape"><code class="docutils literal notranslate"><span class="pre">safe_html_escape()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_menu_handler.html#github_menu_handler.format_bytes"><code class="docutils literal notranslate"><span class="pre">format_bytes()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_menu_handler.html#github_menu_handler.GitHubMenuHandler"><code class="docutils literal notranslate"><span class="pre">GitHubMenuHandler</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/github_upload_fix.html">github_upload_fix module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/github_upload_fix.html#github_upload_fix.github_upload_new_file"><code class="docutils literal notranslate"><span class="pre">github_upload_new_file()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_upload_fix.html#github_upload_fix.handle_document_fixed"><code class="docutils literal notranslate"><span class="pre">handle_document_fixed()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_upload_fix.html#github_upload_fix.upload_to_github_fixed"><code class="docutils literal notranslate"><span class="pre">upload_to_github_fixed()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_upload_fix.html#github_upload_fix.setup_minimal_commands"><code class="docutils literal notranslate"><span class="pre">setup_minimal_commands()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_upload_fix.html#github_upload_fix.stats_command_secured"><code class="docutils literal notranslate"><span class="pre">stats_command_secured()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_upload_fix.html#github_upload_fix.check_commands"><code class="docutils literal notranslate"><span class="pre">check_commands()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/handlers.html">handlers package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.html#subpackages">Subpackages</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.html#submodules">Submodules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/i18n.html">i18n package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/i18n.html#submodules">Submodules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/integrations.html">integrations module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/large_files_handler.html">large_files_handler module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/large_files_handler.html#large_files_handler.LargeFilesHandler"><code class="docutils literal notranslate"><span class="pre">LargeFilesHandler</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/lazy_loader.html">lazy_loader module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/lazy_loader.html#lazy_loader.FileChunk"><code class="docutils literal notranslate"><span class="pre">FileChunk</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/lazy_loader.html#lazy_loader.LazyLoader"><code class="docutils literal notranslate"><span class="pre">LazyLoader</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html">main module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/repo_analyzer.html">repo_analyzer module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/repo_analyzer.html#repo_analyzer.emit_event"><code class="docutils literal notranslate"><span class="pre">emit_event()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/repo_analyzer.html#repo_analyzer.RepoAnalyzer"><code class="docutils literal notranslate"><span class="pre">RepoAnalyzer</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/search_engine.html">search_engine module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/secret_manager.html">secret_manager module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/secret_manager.html#secret_manager.encrypt_secret"><code class="docutils literal notranslate"><span class="pre">encrypt_secret()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/secret_manager.html#secret_manager.decrypt_secret"><code class="docutils literal notranslate"><span class="pre">decrypt_secret()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/services.html">services package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/services.html#submodules">Submodules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/terminal_commands.html">terminal_commands module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/terminal_commands.html#terminal_commands.emit_event"><code class="docutils literal notranslate"><span class="pre">emit_event()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/terminal_commands.html#terminal_commands.run_in_sandbox"><code class="docutils literal notranslate"><span class="pre">run_in_sandbox()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/terminal_commands.html#terminal_commands.terminal_enter"><code class="docutils literal notranslate"><span class="pre">terminal_enter()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/terminal_commands.html#terminal_commands.terminal_exit"><code class="docutils literal notranslate"><span class="pre">terminal_exit()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/terminal_commands.html#terminal_commands.terminal_run_command"><code class="docutils literal notranslate"><span class="pre">terminal_run_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/terminal_commands.html#terminal_commands.terminal_command"><code class="docutils literal notranslate"><span class="pre">terminal_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/terminal_commands.html#terminal_commands.setup_terminal_handlers"><code class="docutils literal notranslate"><span class="pre">setup_terminal_handlers()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/test_basic.html">test_basic module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/test_basic.html#test_basic.test_python_version"><code class="docutils literal notranslate"><span class="pre">test_python_version()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/test_basic.html#test_basic.test_import_main"><code class="docutils literal notranslate"><span class="pre">test_import_main()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/test_basic.html#test_basic.test_environment"><code class="docutils literal notranslate"><span class="pre">test_environment()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/test_basic.html#test_basic.test_basic_calculation"><code class="docutils literal notranslate"><span class="pre">test_basic_calculation()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/test_basic.html#test_basic.TestRequirements"><code class="docutils literal notranslate"><span class="pre">TestRequirements</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/user_stats.html">user_stats module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/user_stats.html#user_stats.UserStats"><code class="docutils literal notranslate"><span class="pre">UserStats</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html">utils module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CodeErrorLogger"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TimeUtils"><code class="docutils literal notranslate"><span class="pre">TimeUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils"><code class="docutils literal notranslate"><span class="pre">TextUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.SecurityUtils"><code class="docutils literal notranslate"><span class="pre">SecurityUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils"><code class="docutils literal notranslate"><span class="pre">TelegramUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CallbackQueryGuard"><code class="docutils literal notranslate"><span class="pre">CallbackQueryGuard</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.AsyncUtils"><code class="docutils literal notranslate"><span class="pre">AsyncUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.PerformanceUtils"><code class="docutils literal notranslate"><span class="pre">PerformanceUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.ValidationUtils"><code class="docutils literal notranslate"><span class="pre">ValidationUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.FileUtils"><code class="docutils literal notranslate"><span class="pre">FileUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.ConfigUtils"><code class="docutils literal notranslate"><span class="pre">ConfigUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CacheUtils"><code class="docutils literal notranslate"><span class="pre">CacheUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.get_memory_usage"><code class="docutils literal notranslate"><span class="pre">get_memory_usage()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.setup_logging"><code class="docutils literal notranslate"><span class="pre">setup_logging()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.generate_summary_stats"><code class="docutils literal notranslate"><span class="pre">generate_summary_stats()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.detect_language_from_filename"><code class="docutils literal notranslate"><span class="pre">detect_language_from_filename()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.get_language_emoji"><code class="docutils literal notranslate"><span class="pre">get_language_emoji()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.SensitiveDataFilter"><code class="docutils literal notranslate"><span class="pre">SensitiveDataFilter</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.install_sensitive_filter"><code class="docutils literal notranslate"><span class="pre">install_sensitive_filter()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.normalize_code"><code class="docutils literal notranslate"><span class="pre">normalize_code()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../modules/index.html">מודולים ראשיים</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#file-management">File Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#github-integration">GitHub Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#backup-system">Backup System</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#code-processing">Code Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#search-engine">Search Engine</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#repository-analysis">Repository Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#batch-processing">Batch Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#large-files-handling">Large Files Handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#cache-management">Cache Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#user-statistics">User Statistics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#activity-reporting">Activity Reporting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#utilities">Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#lazy-loading">Lazy Loading</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#integrations">Integrations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#terminal-commands">Terminal Commands</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#autocomplete-manager">Autocomplete Manager</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../handlers/index.html">Handlers</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#show-command">Show Command</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../handlers/show.html">Show Command</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../handlers/show.html#show">מפרט פקודת <cite>/show</cite></a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/show.html#html">דוגמת תגובת HTML</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/show.html#id1">הערות יישום</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/show.html#id2">קישורים</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#drive-menu">Drive Menu</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../handlers/drive_menu.html">Drive Menu V2</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../handlers/drive_menu.html#id1">סקירה</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/drive_menu.html#id2">דגל פיצ’ר</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/drive_menu.html#id3">זרימות עיקריות</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/drive_menu.html#device-flow">התחברות (Device Flow)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/drive_menu.html#id4">טיפול שגיאות</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/drive_menu.html#id5">ניטור</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/drive_menu.html#module-handlers.drive.menu">API (autodoc)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#file-view-handler">File View Handler</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../handlers/index.html#file-view-handler-module">File View Handler Module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#pagination-handler">Pagination Handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#save-flow-handler">Save Flow Handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#states-handler">States Handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#github-handlers">GitHub Handlers</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../services/index.html">Services</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../services/index.html#code-service">Code Service</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../services/index.html#code-service-module">Code Service Module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../services/index.html#github-service">GitHub Service</a></li>
<li class="toctree-l2"><a class="reference internal" href="../services/index.html#backup-service">Backup Service</a></li>
<li class="toctree-l2"><a class="reference internal" href="../services/index.html#google-drive-service">Google Drive Service</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../services/google_drive_service.html">Google Drive Service</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../services/google_drive_service.html#id1">סקירה</a></li>
<li class="toctree-l4"><a class="reference internal" href="../services/google_drive_service.html#oauth">הערות OAuth</a></li>
<li class="toctree-l4"><a class="reference internal" href="../services/google_drive_service.html#id2">מבני קבצים</a></li>
<li class="toctree-l4"><a class="reference internal" href="../services/google_drive_service.html#api-autodoc">API (autodoc)</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../database/index.html">Database</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../database/index.html#database-manager">Database Manager</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/index.html#models">Models</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../database/index.html#codesnippet-model">CodeSnippet Model</a></li>
<li class="toctree-l3"><a class="reference internal" href="../database/index.html#databasemanager-class">DatabaseManager Class</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../database/index.html#database-operations">Database Operations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../database/index.html#save-operations">Save Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../database/index.html#search-operations">Search Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../database/index.html#delete-operations">Delete Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../database/index.html#statistics-operations">Statistics Operations</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../database/indexing.html">MongoDB Indexing Cookbook</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#id1">למה?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#id2">אינדקסים מומלצים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#python-pymongo">מתכונים (Python / PyMongo)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#explain-mongo-shell">בדיקות explain (Mongo Shell)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#explain">מה לחפש ב-explain?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#id3">בדיקת קיום אינדקסים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#id4">שיטות עבודה מומלצות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#id5">דוגמאות נוספות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#gotchas">Gotchas נפוצים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../database/cursor-pagination.html">Cursor-based Pagination (created_at / _id)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#id1">למה?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#id2">עקרונות מיון יציב</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#python">קידוד/פענוח קורסור (Python)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#id3">תבנית שאילתה (חדש → ישן)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#pymongo">PyMongo – דוגמה מלאה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#id4">דפדוף לאחור (ישן → חדש)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#copypaste">בדיקות ידניות (Copy‑Paste)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#id5">שיטות עבודה מומלצות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#gotchas">Gotchas נפוצים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#id6">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../database-schema.html">Database Schema</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../database-schema.html#collections">Collections</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../database-schema.html#code-snippets"><code class="docutils literal notranslate"><span class="pre">code_snippets</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../database-schema.html#users"><code class="docutils literal notranslate"><span class="pre">users</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../database-schema.html#bookmarks"><code class="docutils literal notranslate"><span class="pre">bookmarks</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../database-schema.html#sessions-webapp"><code class="docutils literal notranslate"><span class="pre">sessions</span></code> (WebApp)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../database-schema.html#indexes">Indexes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database-schema.html#relationships">Relationships</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database-schema.html#id1">קישורים</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">עזרה ודוגמאות:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../examples.html">דוגמאות שימוש</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#id2">שימוש בסיסי</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id3">יצירת אפליקציית בוט</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id4">שמירת קוד חדש</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id5">חיפוש קוד</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#handlers">שימוש ב-Handlers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#command-handler">יצירת Command Handler</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#conversation-handler">יצירת Conversation Handler</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#services">שימוש ב-Services</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id6">זיהוי שפת תכנות</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id7">ניתוח קוד</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#github">אינטגרציה עם GitHub</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#gist">העלאת קוד ל-Gist</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#gists">שליפת Gists של משתמש</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#id8">עבודה עם מסד הנתונים</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id9">ביצוע שאילתות מורכבות</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id10">עדכון קבצים</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id11">סטטיסטיקות</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#id12">טיפול בשגיאות</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id13">טיפול בשגיאות בסיסי</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#retry-logic">Retry Logic</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#id14">בדיקות</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id15">בדיקת יחידה</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id16">בדיקת אינטגרציה</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#id17">דוגמאות מתקדמות</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id18">עיבוד באצווה</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id19">קאשינג</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../testing.html">Testing Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#quickstart">🚀 Quickstart לטסטים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#id1">הנחיות קריטיות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#stubs">טעינת Stubs לטלגרם</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#tmp-path">דוגמת שימוש ב‑tmp_path</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#id2">מחיקה בטוחה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#pytest-cov">כיסוי בדיקות (pytest-cov)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#ci">CI נתמך</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#id3">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ci-cd.html">CI/CD Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../ci-cd.html#id1">חוקים קשיחים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ci-cd.html#id2">סטטוסים נדרשים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ci-cd.html#id3">בדיקות מומלצות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ci-cd.html#id4">בנייה של התיעוד</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ci-cd.html#id5">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../conversation-handlers.html">Conversation Handlers &amp; States</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#id1">סקירה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#states">רשימת States (מבחר בפועל)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#save-flow">Save Flow (תרשים מצבים)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#github-flow">GitHub Flow (תרשים מצבים)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#handler">דוגמת Handler תמציתית</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#id2">טבלת זרימות מלאה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#id3">קישורים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#id4">דוגמאות קוד תמציתיות (ממשיות)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#save">Save – שלבים עיקריים</a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#github">GitHub – תפריט ושיחת העלאה</a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#backup">Backup – תפריט</a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#drive">Drive – תפריט</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#id5">מוקשים נפוצים ופתרונות</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#query-answer"><code class="docutils literal notranslate"><span class="pre">query.answer()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#message-is-not-modified">עריכת הודעות בבטחה – ”Message is not modified“</a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#filters">Filters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#persistent-data-context-user-data">Persistent data (<code class="docutils literal notranslate"><span class="pre">context.user_data</span></code>)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#id6">דוגמאות טסטים קצרות</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#id7">Save – התחלה וזרימה בסיסית</a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#github-upload-conv-handler">GitHub – upload_conv_handler</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting.html">Troubleshooting Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#id1">שגיאות נפוצות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#importerror-telegram-conversationhandler-filters">ImportError בזמן טסטים (telegram / ConversationHandler / filters)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#parse-mode">שגיאות parse_mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#id2">דיבוג מהיר</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#mongodb">בדיקת חיבור MongoDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#id3">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../development.html">Development Workflow</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../development.html#handler">הוספת Handler חדש</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development.html#endpoint-webapp">הוספת Endpoint ל‑WebApp</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development.html#schema">עדכון Schema במסד הנתונים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development.html#id1">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../integrations.html">Integrations</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../integrations.html#github-api">GitHub API</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../integrations.html#gist">יצירת Gist (דוגמה)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../integrations.html#google-drive-oauth-flow">Google Drive (OAuth Flow)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integrations.html#telegram-webhooks-vs-polling">Telegram Webhooks vs Polling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integrations.html#id1">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../security.html">Security Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../security.html#id1">סודות ופרטיות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security.html#id2">הצפנת טוקנים (דוגמה)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security.html#csrf-webapp">CSRF ב‑WebApp</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security.html#rate-limiting">Rate Limiting (דוגמה)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security.html#id3">קישורים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security.html#id4">אבטחת הודעות בטלגרם</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../user/share_code.html">שיתוף קוד (חשוב)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#id2">מה זה עושה?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#id3">איפה הכפתור מופיע?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#id4">איך זה עובד (זרימה)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#env">דרישות סביבתיות (ENV)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#id5">מגבלות והתנהגות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#id6">הודעות הצלחה/שגיאה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#troubleshooting">Troubleshooting קצר</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#id7">דוגמאות (טקסטואליות)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../user/github_browse.html">עיון בקוד GitHub (כולל חיפוש בשם קובץ)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../user/github_browse.html#id1">שורת כלים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/github_browse.html#id2">תוצאות חיפוש</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/github_browse.html#id3">ניווט ריפו</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../user/download_repo.html">הורדת ריפו</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../user/download_repo.html#id2">מה בדיוק מוריד</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/download_repo.html#id3">מגבלות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/download_repo.html#id4">הודעות נפוצות</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">WebApp:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../webapp/overview.html">המיני Web App (סקירה)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/overview.html#id1">מה נותן?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/overview.html#id2">כתובת והרשאות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/overview.html#env">הגדרות ENV</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/overview.html#id3">קישורים ותמונות מסך</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/caching.html">Caching &amp; HTTP Validators (ETag / Last-Modified / 304)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#id1">למה זה חשוב?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#id2">עקרונות בסיס</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#flask-werkzeug">מתכון: Flask + werkzeug</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#copypaste">בדיקות ידניות (Copy‑Paste)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#checklist">Checklist למימוש נכון</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#gotchas">Gotchas נפוצים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#cache-control">שילוב עם Cache-Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#id3">קישורים נוספים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/static-checklist.html">Static Performance &amp; Security Checklist (gzip/br, Cache, SRI)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/static-checklist.html#id1">מטרה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/static-checklist.html#br-gzip">דחיסה (br/gzip)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/static-checklist.html#cache-control">כותרות Cache-Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/static-checklist.html#subresource-integrity-sri">Subresource Integrity (SRI)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/static-checklist.html#copypaste">בדיקות ידניות (Copy‑Paste)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/static-checklist.html#best-practices">Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/static-checklist.html#gotchas">Gotchas</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/api-reference.html">WebApp API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/api-reference.html#endpoints">Endpoints</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/api-reference.html#authentication-flow">Authentication Flow</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/api-reference.html#response-schema-example">Response Schema Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/api-reference.html#errors">Errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/api-reference.html#id1">קישורים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/api-reference.html#files">מסנן ושדות קלט ל-<code class="docutils literal notranslate"><span class="pre">/files</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../webapp/api-reference.html#id2">טבלת פרמטרים</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/api-reference.html#id3">דוגמאות בקשה</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/api-reference.html#id4">דוגמאות תגובה</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/bulk-actions.html">Bulk actions (בחירה מרובה)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/bulk-actions.html#id1">סקירה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/bulk-actions.html#endpoints">Endpoints</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../webapp/bulk-actions.html#post-api-files-bulk-favorite"><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/api/files/bulk-favorite</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/bulk-actions.html#post-api-files-bulk-unfavorite"><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/api/files/bulk-unfavorite</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/bulk-actions.html#post-api-files-bulk-tag"><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/api/files/bulk-tag</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/bulk-actions.html#post-api-files-create-zip"><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/api/files/create-zip</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/bulk-actions.html#post-api-files-bulk-delete-soft-delete"><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/api/files/bulk-delete</span></code> (Soft Delete)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/bulk-actions.html#post-api-files-create-share-link"><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/api/files/create-share-link</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/bulk-actions.html#id2">שגיאות נפוצות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/bulk-actions.html#id3">הערות למפתחים</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Observability</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../observability.html">אובזרווביליות (Observability)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../observability.html#id1">מטרות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability.html#id2">קהלי יעד</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability.html#id3">תצורה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability.html#id4">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../logging_schema.html">סכמת לוגים</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../logging_schema.html#id2">שדות חובה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logging_schema.html#id3">שדות מומלצים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logging_schema.html#id4">דוגמה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logging_schema.html#error-codes">טקסונומיית שגיאות (Error codes)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../metrics.html">מדדים (Metrics)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../metrics.html#id1">נקודת קצה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metrics.html#id2">מטריקות קיימות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metrics.html#promql">דוגמאות PromQL</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../alerts.html">התראות (Alerts)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../alerts.html#id1">חוקי התראה לדוגמה</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../sentry.html">Sentry</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../sentry.html#id1">הפעלה (משתני סביבה)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sentry.html#id2">עקרונות</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../runbooks/logging-levels.html">שינוי רמות לוגים</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/logging-levels.html#debug">מתי להעלות ל-DEBUG</a></li>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/logging-levels.html#id2">טיפ</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Observability – Advanced</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../observability/events_catalog.html">קטלוג אירועים קנוניים</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../observability/events_catalog.html#github">GitHub</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/events_catalog.html#db">DB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/events_catalog.html#web-share">Web/Share</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/events_catalog.html#alerts">Alerts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/events_catalog.html#repo-analyzer">Repo Analyzer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/events_catalog.html#business">Business</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../observability/error_codes.html">מילון קודי שגיאה (Error Codes)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../observability/error_codes.html#id1">דוגמאות מיפוי</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/error_codes.html#id2">הנחיות</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../observability/metrics_promql.html">שאילתות PromQL שימושיות</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../observability/metrics_promql.html#latency">זמן תגובה (Latency)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/metrics_promql.html#id1">שיעור שגיאות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/metrics_promql.html#id2">אירועי ביזנס</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../observability/alerts_playbook.html">Playbook קצר להתראות</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../observability/alerts_playbook.html#id1">זרימה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/alerts_playbook.html#id2">קישורים בקוד</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/alerts_playbook.html#id3">דגשים</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Code Keeper Bot</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">github_menu_handler</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>הראה קוד מקור ל github_menu_handler</h1><div class="highlight"><pre>
<span></span><span class="c1"># FIXED: Changed from Markdown to HTML parsing (2025-01-10)</span>
<span class="c1"># This fixes Telegram parsing errors with special characters in suggestions</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timezone</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">from</span> <span class="nn">html</span> <span class="kn">import</span> <span class="n">escape</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="kn">from</span> <span class="nn">github</span> <span class="kn">import</span> <span class="n">Github</span><span class="p">,</span> <span class="n">GithubException</span>
<span class="kn">from</span> <span class="nn">github.InputGitTreeElement</span> <span class="kn">import</span> <span class="n">InputGitTreeElement</span>
<span class="kn">from</span> <span class="nn">telegram</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">InlineKeyboardButton</span><span class="p">,</span>
    <span class="n">InlineKeyboardMarkup</span><span class="p">,</span>
    <span class="n">InlineQueryResultArticle</span><span class="p">,</span>
    <span class="n">InputTextMessageContent</span><span class="p">,</span>
    <span class="n">Update</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">telegram.error</span> <span class="kn">import</span> <span class="n">BadRequest</span>
<span class="kn">import</span> <span class="nn">secrets</span>
<span class="kn">from</span> <span class="nn">telegram.ext</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ContextTypes</span><span class="p">,</span>
    <span class="n">ConversationHandler</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">repo_analyzer</span> <span class="kn">import</span> <span class="n">RepoAnalyzer</span>
<span class="kn">from</span> <span class="nn">config</span> <span class="kn">import</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">file_manager</span> <span class="kn">import</span> <span class="n">backup_manager</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">TelegramUtils</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">observability</span> <span class="kn">import</span> <span class="n">emit_event</span>  <span class="c1"># type: ignore</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
<div class="viewcode-block" id="emit_event">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.emit_event">[תיעוד]</a>
    <span class="k">def</span> <span class="nf">emit_event</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">severity</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">fields</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">metrics</span> <span class="kn">import</span> <span class="n">track_performance</span><span class="p">,</span> <span class="n">errors_total</span>  <span class="c1"># type: ignore</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
    <span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
    <span class="n">errors_total</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>
    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">track_performance</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
        <span class="k">yield</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">metrics</span> <span class="kn">import</span> <span class="n">track_github_sync</span>  <span class="c1"># type: ignore</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
    <span class="k">def</span> <span class="nf">track_github_sync</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
        <span class="k">return</span> <span class="kc">None</span>

<span class="c1"># הגדרת לוגר</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># מצבי שיחה</span>
<span class="n">REPO_SELECT</span><span class="p">,</span> <span class="n">FILE_UPLOAD</span><span class="p">,</span> <span class="n">FOLDER_SELECT</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="c1"># מגבלות קבצים גדולים</span>
<span class="n">MAX_INLINE_FILE_BYTES</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>  <span class="c1"># 5MB לשליחה ישירה בבוט</span>
<span class="n">MAX_ZIP_TOTAL_BYTES</span> <span class="o">=</span> <span class="mi">50</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>  <span class="c1"># 50MB לקובץ ZIP אחד</span>
<span class="n">MAX_ZIP_FILES</span> <span class="o">=</span> <span class="mi">500</span>  <span class="c1"># מקסימום קבצים ב-ZIP אחד</span>

<span class="c1"># מגבלות ייבוא ריפו (ייבוא תוכן, לא גיבוי)</span>
<span class="n">IMPORT_MAX_FILE_BYTES</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>  <span class="c1"># 1MB לקובץ יחיד</span>
<span class="n">IMPORT_MAX_TOTAL_BYTES</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>  <span class="c1"># 20MB לכל הייבוא</span>
<span class="n">IMPORT_MAX_FILES</span> <span class="o">=</span> <span class="mi">2000</span>  <span class="c1"># הגבלה סבירה למספר קבצים</span>
<span class="c1"># הרחבת רשימת תיקיות כבדות לדילוג בכל עומק עץ – משפר סריקה/קריאה לאחר חליצה</span>
<span class="n">IMPORT_SKIP_DIRS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;.git&quot;</span><span class="p">,</span> <span class="s2">&quot;.github&quot;</span><span class="p">,</span> <span class="s2">&quot;__pycache__&quot;</span><span class="p">,</span> <span class="s2">&quot;node_modules&quot;</span><span class="p">,</span> <span class="s2">&quot;dist&quot;</span><span class="p">,</span> <span class="s2">&quot;build&quot;</span><span class="p">,</span>
    <span class="s2">&quot;_build&quot;</span><span class="p">,</span> <span class="s2">&quot;_static&quot;</span><span class="p">,</span> <span class="s2">&quot;_images&quot;</span><span class="p">,</span>  <span class="c1"># תבניות שנפוצות תחת docs/</span>
    <span class="s2">&quot;.venv&quot;</span><span class="p">,</span> <span class="s2">&quot;venv&quot;</span><span class="p">,</span> <span class="s2">&quot;.tox&quot;</span>
<span class="p">}</span>

<span class="c1"># מגבלות עזר לשליפת תאריכי ענפים למיון</span>
<span class="n">MAX_BRANCH_DATE_FETCH</span> <span class="o">=</span> <span class="mi">120</span>  <span class="c1"># אם יש יותר מזה — נוותר על מיון לפי תאריך (למעט ברירת המחדל)</span>

<span class="c1"># תצוגת קובץ חלקית</span>
<span class="n">VIEW_LINES_PER_PAGE</span> <span class="o">=</span> <span class="mi">80</span>


<span class="k">def</span> <span class="nf">_safe_rmtree_tmp</span><span class="p">(</span><span class="n">target_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;מחיקה בטוחה של תיקייה תחת /tmp בלבד, עם סורגי בטיחות.</span>

<span class="sd">    יזרוק חריגה אם הנתיב אינו תחת /tmp או שגוי.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">target_path</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">rp_target</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">target_path</span><span class="p">)</span>
        <span class="n">rp_base</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="s2">&quot;/tmp&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rp_target</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">rp_base</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Refusing to delete non-tmp path: </span><span class="si">{</span><span class="n">rp_target</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rp_target</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()}:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Refusing to delete unsafe path: </span><span class="si">{</span><span class="n">rp_target</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">rp_target</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="c1"># לא מפסיק את הזרימה במקרה של שגיאה בניקוי</span>
        <span class="k">pass</span>


<div class="viewcode-block" id="safe_html_escape">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.safe_html_escape">[תיעוד]</a>
<span class="k">def</span> <span class="nf">safe_html_escape</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Escape text for Telegram HTML; preserves \n/\r/\t and keeps existing HTML entities.</span>

<span class="sd">    מרחיב ניקוי תווים בלתי נראים: ZWSP/ZWNJ/ZWJ, BOM/ZWNBSP, ותווי כיווניות LRM/RLM/LRE/RLE/PDF/LRO/RLO/LRI/RLI/FSI/PDI.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">text</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
    <span class="c1"># נקה תווים בלתי נראים (Zero-width) + BOM</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[\u200b\u200c\u200d\u2060\ufeff]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
    <span class="c1"># נקה סימוני כיווניות (Cf) נפוצים שגורמים לבלבול בהצגה</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[\u200e\u200f\u202a\u202b\u202c\u202d\u202e\u2066\u2067\u2068\u2069]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
    <span class="c1"># נקה תווי בקרה אך השאר \n, \r, \t</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[\x00-\x08\x0b\x0c\x0e-\x1f\x7f-\x9f]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span></div>



<div class="viewcode-block" id="format_bytes">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.format_bytes">[תיעוד]</a>
<span class="k">def</span> <span class="nf">format_bytes</span><span class="p">(</span><span class="n">num</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;פורמט נחמד לגודל קובץ&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;KB&quot;</span><span class="p">,</span> <span class="s2">&quot;MB&quot;</span><span class="p">,</span> <span class="s2">&quot;GB&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">num</span> <span class="o">&lt;</span> <span class="mf">1024.0</span> <span class="ow">or</span> <span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;GB&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">num</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">unit</span> <span class="o">!=</span> <span class="s2">&quot;B&quot;</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">num</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">num</span> <span class="o">/=</span> <span class="mf">1024.0</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)</span></div>



<div class="viewcode-block" id="GitHubMenuHandler">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler">[תיעוד]</a>
<span class="k">class</span> <span class="nc">GitHubMenuHandler</span><span class="p">:</span>
<div class="viewcode-block" id="GitHubMenuHandler.__init__">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.__init__">[תיעוד]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_sessions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_api_call</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.get_user_session">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.get_user_session">[תיעוד]</a>
    <span class="k">def</span> <span class="nf">get_user_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;מחזיר או יוצר סשן משתמש בזיכרון&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_sessions</span><span class="p">:</span>
            <span class="c1"># נסה לטעון ריפו מועדף מהמסד, עם נפילה בטוחה בסביבת בדיקות/CI</span>
            <span class="n">selected_repo</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>  <span class="c1"># type: ignore</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">selected_repo</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_selected_repo</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">selected_repo</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">selected_repo</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_sessions</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;selected_repo&quot;</span><span class="p">:</span> <span class="n">selected_repo</span><span class="p">,</span>  <span class="c1"># טען מהמסד נתונים</span>
                <span class="s2">&quot;selected_folder&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># None = root של הריפו</span>
                <span class="s2">&quot;github_token&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_sessions</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span></div>


    <span class="c1"># --- Date/time helpers ---</span>
    <span class="k">def</span> <span class="nf">_to_utc_aware</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Normalize datetime to timezone-aware UTC to avoid comparison errors.</span>

<span class="sd">        PyGithub often returns naive UTC datetimes. We must not compare</span>
<span class="sd">        naive and aware datetimes, so we coerce to aware UTC.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dt</span><span class="o">.</span><span class="n">tzinfo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">dt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dt</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># Fallback: return as-is if unexpected type</span>
            <span class="k">return</span> <span class="n">dt</span>

<div class="viewcode-block" id="GitHubMenuHandler.show_browse_ref_menu">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_browse_ref_menu">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">show_browse_ref_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;תפריט בחירת ref (ענף/תג) עם עימוד וטאבים.&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_full</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_full</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ חסר טוקן או ריפו נבחר&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_full</span><span class="p">)</span>
        <span class="n">current_ref</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;browse_ref&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="s2">&quot;default_branch&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;main&quot;</span><span class="p">)</span>
        <span class="n">tab</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;browse_ref_tab&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;branches&quot;</span>
        <span class="n">kb</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># טאבים</span>
        <span class="n">tabs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🌿 ענפים&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;browse_refs_branches_page_0&quot;</span><span class="p">),</span>
            <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🏷 תגיות&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;browse_refs_tags_page_0&quot;</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tabs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tab</span> <span class="o">==</span> <span class="s2">&quot;branches&quot;</span><span class="p">:</span>
            <span class="n">page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;browse_refs_branches_page&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">repo</span><span class="o">.</span><span class="n">get_branches</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">page_size</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">page</span> <span class="o">*</span> <span class="n">page_size</span>
            <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">page_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">br</span> <span class="ow">in</span> <span class="n">items</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;✅ &quot;</span> <span class="o">+</span> <span class="n">br</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">br</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">current_ref</span> <span class="k">else</span> <span class="n">br</span><span class="o">.</span><span class="n">name</span>
                <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;browse_select_ref:</span><span class="si">{</span><span class="n">br</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
            <span class="c1"># עימוד</span>
            <span class="n">nav</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">page</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;⬅️ הקודם&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;browse_refs_branches_page_</span><span class="si">{</span><span class="n">page</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">end</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
                <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;הבא ➡️&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;browse_refs_branches_page_</span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">nav</span><span class="p">:</span>
                <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nav</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;browse_refs_tags_page&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">repo</span><span class="o">.</span><span class="n">get_tags</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">page_size</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">page</span> <span class="o">*</span> <span class="n">page_size</span>
            <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">page_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">tg</span> <span class="ow">in</span> <span class="n">items</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tg</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;✅ &quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="n">current_ref</span> <span class="k">else</span> <span class="n">name</span>
                <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;browse_select_ref:</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
            <span class="n">nav</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">page</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;⬅️ הקודם&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;browse_refs_tags_page_</span><span class="si">{</span><span class="n">page</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">end</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
                <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;הבא ➡️&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;browse_refs_tags_page_</span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">nav</span><span class="p">:</span>
                <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nav</span><span class="p">)</span>
        <span class="c1"># תחתית</span>
        <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזרה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)])</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;בחר/י ref לדפדוף (נוכחי: &lt;code&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">current_ref</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/code&gt;)&quot;</span><span class="p">,</span>
            <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span>
            <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.show_browse_search_results">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_browse_search_results">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">show_browse_search_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;חיפוש לפי שם קובץ (prefix/contains) עם עימוד ותוצאות לפתיחה.&quot;&quot;&quot;</span>
        <span class="c1"># שימוש ב-Contents API: אין חיפוש שמות ישיר; נשתמש ב-Search API code:in:path/name</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s2">&quot;callback_query&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span> <span class="k">if</span> <span class="n">query</span> <span class="k">else</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_full</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;browse_search_query&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;browse_search_page&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_full</span> <span class="ow">and</span> <span class="n">q</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ חסרים נתונים לחיפוש&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;❌ חסרים נתונים לחיפוש&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="c1"># הפורמט: repo:owner/name in:path &lt;query&gt;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">owner</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">repo_full</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">owner</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">repo_full</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
        <span class="c1"># בניית שאילתה: נחפש במחרוזת הנתיב בלבד (in:name לא נתמך ב-code search)</span>
        <span class="n">q_safe</span> <span class="o">=</span> <span class="p">(</span><span class="n">q</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">term</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">q_safe</span><span class="si">}</span><span class="s1">&quot;&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="ow">in</span> <span class="n">q_safe</span><span class="p">)</span> <span class="k">else</span> <span class="n">q_safe</span>
        <span class="n">gh_query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;repo:</span><span class="si">{</span><span class="n">owner</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> in:path </span><span class="si">{</span><span class="n">term</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># PyGithub מחזיר PaginatedList; נהפוך לרשימה בטוחה עם הגבלה כדי למנוע 403/timeout</span>
            <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">search_code</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">gh_query</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s2">&quot;desc&quot;</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br</span><span class="p">:</span>
            <span class="c1"># ננהל את טלגרם &quot;message is not modified&quot; בעדינות</span>
            <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;אין שינוי בתוצאה&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">return</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s2">&quot;callback_query&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;שגיאה בחיפוש: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה בחיפוש: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">return</span>
        <span class="c1"># עימוד ידני</span>
        <span class="n">per_page</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">items</span> <span class="o">=</span> <span class="n">results</span>  <span class="c1"># כבר רשימה</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">items</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;🔎 אין תוצאות עבור &lt;code&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/code&gt; ב-&lt;code&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">repo_full</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span>
            <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">([[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזרה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)]]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">per_page</span>
        <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">per_page</span><span class="p">,</span> <span class="n">total</span><span class="p">)</span>
        <span class="n">shown</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
        <span class="c1"># אפס מיפוי אינדקסים למסך זה (ל-callback קצרים)</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_idx_map&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># סימון מצב: תצוגת תוצאות חיפוש פעילה (לצורך חזרה אחורה מתצוגת קובץ)</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;last_results_were_search&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">kb</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">shown</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">view_cb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mk_cb</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;browse_select_view&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
                <span class="c1"># כפתור יחיד: &quot;path 👁️&quot; לצפייה בקובץ</span>
                <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> 👁️&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="n">view_cb</span><span class="p">)</span>
                <span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="n">nav</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">total_pages</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">total</span> <span class="o">+</span> <span class="n">per_page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">per_page</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">page</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;⬅️ הקודם&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;browse_search_page:</span><span class="si">{</span><span class="n">page</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">page</span> <span class="o">&lt;</span> <span class="n">total_pages</span><span class="p">:</span>
            <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;הבא ➡️&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;browse_search_page:</span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">nav</span><span class="p">:</span>
            <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nav</span><span class="p">)</span>
        <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזרה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)])</span>
        <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;🔎 תוצאות חיפוש עבור &lt;code&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/code&gt; — מציג </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">shown</span><span class="p">)</span><span class="si">}</span><span class="s2"> מתוך </span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.check_rate_limit">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.check_rate_limit">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">check_rate_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">github_client</span><span class="p">:</span> <span class="n">Github</span><span class="p">,</span> <span class="n">update_or_query</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;בודק את מגבלת ה-API של GitHub&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rate_limit</span> <span class="o">=</span> <span class="n">github_client</span><span class="o">.</span><span class="n">get_rate_limit</span><span class="p">()</span>
            <span class="n">core_limit</span> <span class="o">=</span> <span class="n">rate_limit</span><span class="o">.</span><span class="n">core</span>

            <span class="k">if</span> <span class="n">core_limit</span><span class="o">.</span><span class="n">remaining</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">reset_time</span> <span class="o">=</span> <span class="n">core_limit</span><span class="o">.</span><span class="n">reset</span>
                <span class="n">minutes_until_reset</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">((</span><span class="n">reset_time</span> <span class="o">-</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span> <span class="o">/</span> <span class="mi">60</span><span class="p">))</span>

                <span class="n">error_message</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;⏳ חריגה ממגבלת GitHub API</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;נותרו רק </span><span class="si">{</span><span class="n">core_limit</span><span class="o">.</span><span class="n">remaining</span><span class="si">}</span><span class="s2"> בקשות</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;המגבלה תתאפס בעוד </span><span class="si">{</span><span class="n">minutes_until_reset</span><span class="si">}</span><span class="s2"> דקות</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;💡 נסה שוב מאוחר יותר&quot;</span>
                <span class="p">)</span>

                <span class="c1"># בדוק אם זה callback query או update רגיל</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">update_or_query</span><span class="p">,</span> <span class="s2">&quot;answer&quot;</span><span class="p">):</span>
                    <span class="c1"># זה callback query</span>
                    <span class="k">await</span> <span class="n">update_or_query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="n">error_message</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># זה update רגיל</span>
                    <span class="k">await</span> <span class="n">update_or_query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>

                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error checking rate limit: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">emit_event</span><span class="p">(</span><span class="s2">&quot;github_rate_limit_check_error&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">errors_total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">errors_total</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="s2">&quot;github_rate_limit_check_error&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># במקרה של שגיאה, נמשיך בכל זאת</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.apply_rate_limit_delay">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.apply_rate_limit_delay">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">apply_rate_limit_delay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;מוסיף השהייה בין בקשות API&quot;&quot;&quot;</span>
        <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">last_call</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_api_call</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># אם עברו פחות מ-2 שניות מהבקשה האחרונה, נחכה</span>
        <span class="n">time_since_last</span> <span class="o">=</span> <span class="n">current_time</span> <span class="o">-</span> <span class="n">last_call</span>
        <span class="k">if</span> <span class="n">time_since_last</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="n">time_since_last</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">last_api_call</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.get_user_token">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.get_user_token">[תיעוד]</a>
    <span class="k">def</span> <span class="nf">get_user_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;מקבל טוקן של משתמש - מהסשן או מהמסד נתונים&quot;&quot;&quot;</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

        <span class="c1"># נסה מהסשן</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;github_token&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">token</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">token</span>

        <span class="c1"># נסה מהמסד נתונים</span>
        <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>

        <span class="n">token</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_github_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">token</span><span class="p">:</span>
            <span class="c1"># שמור בסשן לשימוש מהיר</span>
            <span class="n">session</span><span class="p">[</span><span class="s2">&quot;github_token&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">token</span>

        <span class="k">return</span> <span class="n">token</span></div>


    <span class="c1"># --- Helpers to keep Telegram callback_data &lt;= 64 bytes ---</span>
    <span class="k">def</span> <span class="nf">_mk_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;יוצר callback_data בטוח. אם ארוך מדי, משתמש באינדקס זמני במפה ב-context.user_data.&quot;&quot;&quot;</span>
        <span class="n">safe_path</span> <span class="o">=</span> <span class="n">path</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">safe_path</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">64</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">data</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">64</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">data</span>
        <span class="n">idx_map</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;browse_idx_map&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">idx_map</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">idx_map</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_idx_map&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx_map</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idx_map</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">idx_map</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">safe_path</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_i:</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="nf">_get_path_from_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;שחזור נתיב מתוך callback_data רגיל או ממופה (_i:).&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;_i:&quot;</span><span class="p">):</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;browse_idx_map&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
                <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_render_file_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;מציג דף תצוגה חלקית של קובץ עם כפתורי &#39;הצג עוד&#39;, &#39;הורד&#39;, &#39;חזרה&#39;.&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;repo&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;view_file_path&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;view_file_text&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="n">page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;view_page_index&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="c1"># חישוב חלוקה לשורות</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="n">total_lines</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">page</span> <span class="o">*</span> <span class="n">VIEW_LINES_PER_PAGE</span>
        <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">VIEW_LINES_PER_PAGE</span><span class="p">,</span> <span class="n">total_lines</span><span class="p">)</span>
        <span class="n">chunk</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">])</span>
        <span class="c1"># טקסט לתצוגה + גודל ושפה מזוהה</span>
        <span class="n">size_bytes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;view_file_size&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">lang</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;view_detected_language&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;text&quot;</span>
        <span class="n">header</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;📄 תצוגת קובץ</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;📁 &lt;code&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;📄 &lt;code&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;🔤 שפה: &lt;code&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">lang</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/code&gt; | 💾 גודל: &lt;code&gt;</span><span class="si">{</span><span class="n">format_bytes</span><span class="p">(</span><span class="n">size_bytes</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;שורות </span><span class="si">{</span><span class="n">start</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">end</span><span class="si">}</span><span class="s2"> מתוך </span><span class="si">{</span><span class="n">total_lines</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="c1"># בניית מקלדת</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזרה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;view_back&quot;</span><span class="p">)],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;⬇️ הורד&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mk_cb</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;browse_select_download&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">))]]</span>
        <span class="c1"># כפתור שיתוף קישור לקובץ – רק במסך התצוגה (לא ברשימה)</span>
        <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔗 שתף קישור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mk_cb</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;share_selected_links_single&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">))])</span>
        <span class="k">if</span> <span class="n">end</span> <span class="o">&lt;</span> <span class="n">total_lines</span><span class="p">:</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;הצג עוד ⤵️&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;view_more&quot;</span><span class="p">)])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># הדגשת תחביר קיימת במודול code_processor.highlight_code; נשתמש בה ואז ננקה ל-Telegram</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">services</span> <span class="kn">import</span> <span class="n">code_service</span> <span class="k">as</span> <span class="n">code_processor</span>
                <span class="c1"># פורמט שמירת שורות כברירת מחדל</span>
                <span class="n">lower_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">path</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="c1"># אם YAML – נסה צביעה ישירה, אחרת כללי</span>
                <span class="k">if</span> <span class="n">lower_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.yml&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">lower_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.yaml&#39;</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">highlighted_html</span> <span class="o">=</span> <span class="n">code_processor</span><span class="o">.</span><span class="n">highlight_code</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="s1">&#39;yaml&#39;</span><span class="p">)</span>
                        <span class="n">body</span> <span class="o">=</span> <span class="n">highlighted_html</span> <span class="ow">or</span> <span class="sa">f</span><span class="s2">&quot;&lt;pre&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/pre&gt;&quot;</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;pre&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/pre&gt;&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># שמירת שורות בכוח עבור סוגי קבצים רגישים לעיצוב</span>
                    <span class="n">force_pre_exts</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;.md&#39;</span><span class="p">,</span> <span class="s1">&#39;.markdown&#39;</span><span class="p">,</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">lower_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">force_pre_exts</span><span class="p">):</span>
                        <span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;pre&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/pre&gt;&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># נסה היילייט; אם יוצרת בלגן, fallback ל-pre</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">highlighted_html</span> <span class="o">=</span> <span class="n">code_processor</span><span class="o">.</span><span class="n">highlight_code</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">lang</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">highlighted_html</span> <span class="ow">or</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">chunk</span><span class="p">:</span>
                                <span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;pre&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/pre&gt;&quot;</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">body</span> <span class="o">=</span> <span class="n">highlighted_html</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;pre&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/pre&gt;&quot;</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;pre&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/pre&gt;&quot;</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">header</span> <span class="o">+</span> <span class="n">body</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">rows</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">raise</span>

<div class="viewcode-block" id="GitHubMenuHandler.show_import_branch_menu">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_import_branch_menu">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">show_import_branch_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;מציג בחירת ענף לייבוא ריפו (עימוד).&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_full</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_full</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ חסר טוקן או ריפו נבחר&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># הודעת טעינה בזמן שליפת הענפים</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">TelegramUtils</span><span class="o">.</span><span class="n">safe_edit_message_text</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s2">&quot;⏳ טוען רשימת ענפים…&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_full</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># אין ענף בשלב זה; דווח רק על הריפו</span>
                <span class="n">emit_event</span><span class="p">(</span><span class="s2">&quot;github_import_repo_error&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">repo</span><span class="o">=</span><span class="n">repo_full</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה בטעינת ריפו: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">branches</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">repo</span><span class="o">.</span><span class="n">get_branches</span><span class="p">())</span>
            <span class="c1"># מיין: main ראשון; אחריו לפי עדכון commit אחרון (חדש→ישן)</span>
            <span class="k">def</span> <span class="nf">_branch_sort_key</span><span class="p">(</span><span class="n">br</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># commit.last_modified לא קיים תמיד; ניקח commit.commit.author.date</span>
                    <span class="k">return</span> <span class="n">br</span><span class="o">.</span><span class="n">commit</span><span class="o">.</span><span class="n">commit</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">date</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">min</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
            <span class="c1"># רשימת ענפים מלאה</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">branches</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">MAX_BRANCH_DATE_FETCH</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">branches_sorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">branches</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">_branch_sort_key</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">branches_sorted</span> <span class="o">=</span> <span class="n">branches</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">branches_sorted</span> <span class="o">=</span> <span class="n">branches</span>
            <span class="c1"># הוצא main לראש (אם קיים)</span>
            <span class="n">main_idx</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">branches_sorted</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;main&#39;</span> <span class="ow">or</span> <span class="n">b</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;master&#39;</span><span class="p">)),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">main_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">main_br</span> <span class="o">=</span> <span class="n">branches_sorted</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">main_idx</span><span class="p">)</span>
                <span class="n">branches_sorted</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">main_br</span><span class="p">)</span>
            <span class="n">branches</span> <span class="o">=</span> <span class="n">branches_sorted</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה בשליפת ענפים: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;import_branches_page&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">page_size</span> <span class="o">=</span> <span class="mi">8</span>
        <span class="n">total_pages</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">branches</span><span class="p">)</span> <span class="o">+</span> <span class="n">page_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">page_size</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">page</span> <span class="o">*</span> <span class="n">page_size</span>
        <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">page_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">branches</span><span class="p">))</span>
        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># מיפוי אסימונים קצרים לשמות ענפים כדי לעמוד במגבלת 64 בתים של Telegram</span>
        <span class="n">token_map</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;import_branch_token_map&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="c1"># תצוגה אחידה: main ראשון (כבר מוקפץ למעלה במיון) ואז כל הענפים – ממוינים מהחדש לישן</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">br</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">branches</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]):</span>
            <span class="n">token</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;i</span><span class="si">{</span><span class="n">start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">token_map</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="o">=</span> <span class="n">br</span><span class="o">.</span><span class="n">name</span>
            <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;🌿 </span><span class="si">{</span><span class="n">br</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;import_repo_select_branch:</span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
        <span class="n">nav</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">page</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;⬅️ הקודם&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;import_repo_branches_page_</span><span class="si">{</span><span class="n">page</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📄 </span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total_pages</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;noop&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">page</span> <span class="o">&lt;</span> <span class="n">total_pages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;הבא ➡️&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;import_repo_branches_page_</span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">nav</span><span class="p">:</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nav</span><span class="p">)</span>
        <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)])</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
            <span class="s2">&quot;⬇️ בחר/י ענף לייבוא קבצים מהריפו:&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
        <span class="p">)</span></div>


    <span class="k">async</span> <span class="k">def</span> <span class="nf">_confirm_import_repo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;מסך אישור לייבוא עם הסבר קצר כדי למנוע בלבול עם גיבויים.&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_full</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;⬇️ ייבוא ריפו מ-GitHub</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;זהו &lt;b&gt;ייבוא קבצים&lt;/b&gt; ולא יצירת גיבוי ZIP.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;נוריד ZIP רשמי, נחלץ ל-/tmp, נקלט לקבצים במסד עם תגיות:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;&lt;code&gt;repo:</span><span class="si">{</span><span class="n">repo_full</span><span class="si">}</span><span class="s2">&lt;/code&gt;, &lt;code&gt;source:github&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;נכבד מגבלות גודל/כמות, נדלג על בינאריים ו-&lt;code&gt;.git&lt;/code&gt; ותיקיות מיותרות.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;ענף: &lt;code&gt;</span><span class="si">{</span><span class="n">branch</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;להמשיך?&quot;</span>
        <span class="p">)</span>
        <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;✅ כן, ייבא&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;import_repo_start&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;❌ ביטול&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;import_repo_cancel&quot;</span><span class="p">)],</span>
        <span class="p">]</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="GitHubMenuHandler.import_repo_from_zip">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.import_repo_from_zip">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">import_repo_from_zip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">repo_full</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;מוריד ZIP רשמי של GitHub (zipball) לענף, מחלץ ל-tmp, ומקליט קבצים ל-DB עם תגיות repo/source.</span>

<span class="sd">        שמירה: CodeSnippet לקבצים טקסטואליים קטנים (עד IMPORT_MAX_FILE_BYTES) עד סך IMPORT_MAX_TOTAL_BYTES ומקס&#39; IMPORT_MAX_FILES.</span>
<span class="sd">        מדלג על בינאריים, קבצי ענק, ותיקיות מיותרות. מנקה tmp בסוף.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">emit_event</span><span class="p">(</span><span class="s2">&quot;github_import_repo_error&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="s2">&quot;missing_token&quot;</span><span class="p">,</span> <span class="n">repo</span><span class="o">=</span><span class="n">repo_full</span><span class="p">,</span> <span class="n">branch</span><span class="o">=</span><span class="n">branch</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ חסר טוקן GitHub&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># יצירת לקוח GitHub</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">emit_event</span><span class="p">(</span><span class="s2">&quot;github_import_repo_error&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">repo</span><span class="o">=</span><span class="n">repo_full</span><span class="p">,</span> <span class="n">branch</span><span class="o">=</span><span class="n">branch</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה בהכנת חיבור ל‑GitHub: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_full</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה בטעינת ריפו: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;⏳ מוריד ZIP רשמי ומייבא קבצים… זה עשוי לקחת 1–8 דקות&quot;</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">zipfile</span> <span class="k">as</span> <span class="nn">_zip</span>
        <span class="n">tmp_dir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">zip_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">extracted_dir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">saved</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">updated</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_bytes</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">skipped</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># קבלת קישור zipball עבור branch</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_archive_link</span><span class="p">(</span><span class="s2">&quot;zipball&quot;</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">branch</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="c1"># גרסאות PyGithub ישנות לא מקבלות ref; ננסה ללא ref</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_archive_link</span><span class="p">(</span><span class="s2">&quot;zipball&quot;</span><span class="p">)</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="c1"># עבודה ב-/tmp בלבד</span>
            <span class="n">tmp_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;codebot-gh-import-&quot;</span><span class="p">)</span>
            <span class="n">zip_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="s2">&quot;repo.zip&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">zip_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="c1"># חליצה לתת-תיקייה ייעודית</span>
            <span class="n">extracted_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="s2">&quot;repo&quot;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">extracted_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># מדוד זמן חליצה</span>
            <span class="k">with</span> <span class="n">track_performance</span><span class="p">(</span><span class="s2">&quot;github_zip_extract&quot;</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">_zip</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">zip_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zf</span><span class="p">:</span>
                    <span class="n">zf</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">extracted_dir</span><span class="p">)</span>
            <span class="c1"># מצא שורש (github zip מוסיף תיקיית prefix)</span>
            <span class="c1"># נבחר תיקייה הראשונה מתחת extracted_dir</span>
            <span class="n">roots</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">extracted_dir</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">extracted_dir</span><span class="p">)]</span>
            <span class="n">root</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">roots</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
                    <span class="n">root</span> <span class="o">=</span> <span class="n">p</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">root</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ לא נמצאו קבצים לאחר חליצה&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>
            <span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">detect_language_from_filename</span>
            <span class="n">repo_tag</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;repo:</span><span class="si">{</span><span class="n">repo_full</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">source_tag</span> <span class="o">=</span> <span class="s2">&quot;source:github&quot;</span>
            <span class="c1"># מעבר על קבצים</span>
            <span class="k">for</span> <span class="n">cur_dir</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>
                <span class="c1"># סינון תיקיות מיותרות</span>
                <span class="n">dirnames</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dirnames</span> <span class="k">if</span> <span class="n">d</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">IMPORT_SKIP_DIRS</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
                    <span class="c1"># דלג על קבצי ZIP עצמם או קבצים מוסתרים ענקיים</span>
                    <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.zip&#39;</span><span class="p">):</span>
                        <span class="n">skipped</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">continue</span>
                    <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cur_dir</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                    <span class="n">rel_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span>
                    <span class="c1"># דלג על נתיבים חשודים</span>
                    <span class="k">if</span> <span class="n">rel_path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
                        <span class="n">skipped</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">continue</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># קרא כ-bytes ובדוק בינארי/גודל</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                            <span class="n">raw</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">IMPORT_MAX_FILE_BYTES</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">IMPORT_MAX_FILE_BYTES</span><span class="p">:</span>
                            <span class="n">skipped</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">continue</span>
                        <span class="c1"># heuristic: אם יש אפס-בייטים רבים → כנראה בינארי</span>
                        <span class="k">if</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">raw</span><span class="p">:</span>
                            <span class="n">skipped</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">continue</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">text</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">text</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;latin-1&#39;</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="n">skipped</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">total_bytes</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">IMPORT_MAX_TOTAL_BYTES</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">saved</span> <span class="o">&gt;=</span> <span class="n">IMPORT_MAX_FILES</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">lang</span> <span class="o">=</span> <span class="n">detect_language_from_filename</span><span class="p">(</span><span class="n">rel_path</span><span class="p">)</span>
                        <span class="c1"># בדוק אם קיים כבר עבור אותו ריפו (לפי תגית repo:)</span>
                        <span class="n">prev_doc</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">rel_path</span><span class="p">)</span>
                        <span class="n">prev_tags</span> <span class="o">=</span> <span class="p">(</span><span class="n">prev_doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[])</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prev_doc</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span>
                        <span class="n">existed_for_repo</span> <span class="o">=</span> <span class="nb">any</span><span class="p">((</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">t</span> <span class="o">==</span> <span class="n">repo_tag</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">prev_tags</span><span class="p">)</span>
                        <span class="c1"># מדידת ביצוע עבור שמירה בודדת (דגימה קלה כדי לא להעמיס)</span>
                        <span class="k">with</span> <span class="n">track_performance</span><span class="p">(</span><span class="s2">&quot;github_import_save_file&quot;</span><span class="p">):</span>
                            <span class="n">ok</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">save_file</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="n">rel_path</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="n">text</span><span class="p">,</span> <span class="n">programming_language</span><span class="o">=</span><span class="n">lang</span><span class="p">,</span> <span class="n">extra_tags</span><span class="o">=</span><span class="p">[</span><span class="n">repo_tag</span><span class="p">,</span> <span class="n">source_tag</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">existed_for_repo</span><span class="p">:</span>
                                <span class="n">updated</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">saved</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="n">total_bytes</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">skipped</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">skipped</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">track_github_sync</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">files_count</span><span class="o">=</span><span class="n">saved</span> <span class="o">+</span> <span class="n">updated</span><span class="p">,</span> <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">emit_event</span><span class="p">(</span><span class="s2">&quot;github_sync&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">user_id</span><span class="p">),</span> <span class="n">files_count</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">saved</span> <span class="o">+</span> <span class="n">updated</span><span class="p">),</span> <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;✅ ייבוא הושלם: </span><span class="si">{</span><span class="n">saved</span><span class="si">}</span><span class="s2"> חדשים, </span><span class="si">{</span><span class="n">updated</span><span class="si">}</span><span class="s2"> עודכנו, </span><span class="si">{</span><span class="n">skipped</span><span class="si">}</span><span class="s2"> דילוגים.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;🔖 תיוג: &lt;code&gt;</span><span class="si">{</span><span class="n">repo_tag</span><span class="si">}</span><span class="s2">&lt;/code&gt; (ו-&lt;code&gt;</span><span class="si">{</span><span class="n">source_tag</span><span class="si">}</span><span class="s2">&lt;/code&gt;)</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;ℹ️ זהו ייבוא תוכן — לא נוצר גיבוי ZIP.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;תוכל למצוא את הקבצים ב׳🗂 לפי ריפו׳.&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">emit_event</span><span class="p">(</span><span class="s2">&quot;github_import_repo_error&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">repo</span><span class="o">=</span><span class="n">repo_full</span><span class="p">,</span> <span class="n">branch</span><span class="o">=</span><span class="n">branch</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה בייבוא: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># ניקוי בטוח של tmp ושל קובץ ה-ZIP</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">zip_path</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">zip_path</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">zip_path</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">_safe_rmtree_tmp</span><span class="p">(</span><span class="n">extracted_dir</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">_safe_rmtree_tmp</span><span class="p">(</span><span class="n">tmp_dir</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.github_menu_command">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.github_menu_command">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">github_menu_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;מציג תפריט GitHub&quot;&quot;&quot;</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>

        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

        <span class="c1"># נקה דגלי זרימת &quot;הדבק קוד&quot; אם היו פעילים, כדי למנוע תקיעה בזרימה</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;waiting_for_paste_content&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;waiting_for_paste_filename&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;paste_content&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># בנה הודעת סטטוס</span>
        <span class="n">status_msg</span> <span class="o">=</span> <span class="s2">&quot;&lt;b&gt;🔧 תפריט GitHub&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">token</span><span class="p">:</span>
            <span class="n">status_msg</span> <span class="o">+=</span> <span class="s2">&quot;🔑 &lt;b&gt;מחובר ל-GitHub&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">status_msg</span> <span class="o">+=</span> <span class="s2">&quot;🔒 &lt;b&gt;לא מחובר&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">):</span>
            <span class="n">status_msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;📁 ריפו נבחר: &lt;code&gt;</span><span class="si">{</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;selected_repo&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_folder&quot;</span><span class="p">):</span>
            <span class="n">status_msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;📂 תיקיית יעד: &lt;code&gt;</span><span class="si">{</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;selected_folder&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># כפתור הגדרת טוקן</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔑 הגדר טוקן GitHub&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;set_token&quot;</span><span class="p">)]</span>
            <span class="p">)</span>

        <span class="c1"># כפתור בחירת ריפו - זמין רק עם טוקן</span>
        <span class="k">if</span> <span class="n">token</span><span class="p">:</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📁 בחר ריפו&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;select_repo&quot;</span><span class="p">)])</span>
            <span class="c1"># יצירת ריפו חדש מ-ZIP גם ללא ריפו נבחר</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🆕 צור ריפו חדש מּZIP&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_create_repo_from_zip&quot;</span><span class="p">)])</span>

        <span class="c1"># כפתורי העלאה - מוצגים רק אם יש ריפו נבחר</span>
        <span class="k">if</span> <span class="n">token</span> <span class="ow">and</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">):</span>
            <span class="c1"># העבר את &quot;בחר תיקיית יעד&quot; למעלה, ישירות אחרי &quot;בחר ריפו&quot;</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📂 בחר תיקיית יעד&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;set_folder&quot;</span><span class="p">)])</span>
            <span class="c1"># ניווט בריפו</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🗃️ עיין בריפו&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;browse_repo&quot;</span><span class="p">)])</span>
            <span class="c1"># כפתור העלאה</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📤 העלה קובץ חדש&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;upload_file&quot;</span><span class="p">)])</span>
            <span class="c1"># פעולות נוספות בטוחות</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📥 הורד קובץ מהריפו&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;download_file_menu&quot;</span><span class="p">)]</span>
            <span class="p">)</span>
            <span class="c1"># כפתור ייבוא ריפו (ZIP רשמי → ייבוא קבצים ל-DB)</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;⬇️ הורד ריפו&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_import_repo&quot;</span><span class="p">)]</span>
            <span class="p">)</span>
            <span class="c1"># ריכוז פעולות מחיקה בתפריט משנה</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🧨 מחק קובץ/ריפו שלם&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;danger_delete_menu&quot;</span><span class="p">)]</span>
            <span class="p">)</span>
            <span class="c1"># התראות חכמות</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔔 התראות חכמות&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;notifications_menu&quot;</span><span class="p">)]</span>
            <span class="p">)</span>
            <span class="c1"># תפריט גיבוי/שחזור מרוכז</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🧰 גיבוי ושחזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_backup_menu&quot;</span><span class="p">)]</span>
            <span class="p">)</span>

        <span class="c1"># כפתור ניתוח ריפו - תמיד מוצג אם יש טוקן</span>
        <span class="k">if</span> <span class="n">token</span><span class="p">:</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔍 נתח ריפו&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;analyze_repo&quot;</span><span class="p">)])</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;✅ בדוק תקינות ריפו&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;validate_repo&quot;</span><span class="p">)])</span>
            <span class="c1"># כפתור יציאה (מחיקת טוקן) כאשר יש טוקן</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🚪 התנתק מגיטהאב&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;logout_github&quot;</span><span class="p">)]</span>
            <span class="p">)</span>

        <span class="c1"># כפתור הצגת הגדרות</span>
        <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📋 הצג הגדרות נוכחיות&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;show_current&quot;</span><span class="p">)]</span>
        <span class="p">)</span>

        <span class="c1"># כפתור סגירה</span>
        <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;❌ סגור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;close_menu&quot;</span><span class="p">)])</span>

        <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="n">status_msg</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="n">status_msg</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="GitHubMenuHandler.handle_menu_callback">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.handle_menu_callback">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">handle_menu_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle menu button clicks&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;📱 GitHub handler received callback: </span><span class="si">{</span><span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="si">}</span><span class="s2"> from user </span><span class="si">{</span><span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">emit_event</span><span class="p">(</span>
                <span class="s2">&quot;github_callback_received&quot;</span><span class="p">,</span>
                <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)),</span>
                <span class="n">user_id</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s2">&quot;from_user&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>

        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;select_repo&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_repo_selection</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;browse_repo&quot;</span><span class="p">:</span>
            <span class="c1"># מצב עיון בריפו עם תצוגת קבצים</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;view&quot;</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;multi_mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;multi_selection&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_repo_browser</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;upload_file&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ קודם בחר ריפו!</span><span class="se">\n</span><span class="s2">שלח /github ובחר &#39;בחר ריפו&#39;&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">folder_display</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_folder&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;root&quot;</span>
                <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;✍️ הדבק קוד&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;upload_paste_code&quot;</span><span class="p">)],</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🗂 לפי ריפו&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;gh_upload_cat:repos&quot;</span><span class="p">)],</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📦 קבצי ZIP&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;gh_upload_cat:zips&quot;</span><span class="p">)],</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📂 קבצים גדולים&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;gh_upload_cat:large&quot;</span><span class="p">)],</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📁 שאר הקבצים&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;gh_upload_cat:other&quot;</span><span class="p">)],</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)],</span>
                <span class="p">]</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;📤 &lt;b&gt;העלאת קובץ לריפו&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;ריפו: &lt;code&gt;</span><span class="si">{</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;selected_repo&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;📂 תיקייה: &lt;code&gt;</span><span class="si">{</span><span class="n">folder_display</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;בחר מקור להעלאה:&quot;</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span>
                    <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">return</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;cancel_paste_flow&quot;</span><span class="p">:</span>
            <span class="c1"># ביטול מפורש של זרימת &quot;הדבק קוד&quot;: נקה דגלים וחזור לתפריט העלאה</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;waiting_for_paste_content&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;waiting_for_paste_filename&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;paste_content&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="c1"># נווט חזרה למסך &quot;העלה קובץ חדש&quot;</span>
            <span class="c1"># על ידי קריאה עצמית לסעיף upload_file</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ קודם בחר ריפו!</span><span class="se">\n</span><span class="s2">שלח /github ובחר &#39;בחר ריפו&#39;&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">folder_display</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_folder&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;root&quot;</span>
                <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;✍️ הדבק קוד&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;upload_paste_code&quot;</span><span class="p">)],</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🗂 לפי ריפו&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;gh_upload_cat:repos&quot;</span><span class="p">)],</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📦 קבצי ZIP&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;gh_upload_cat:zips&quot;</span><span class="p">)],</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📂 קבצים גדולים&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;gh_upload_cat:large&quot;</span><span class="p">)],</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📁 שאר הקבצים&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;gh_upload_cat:other&quot;</span><span class="p">)],</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)],</span>
                <span class="p">]</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;📤 &lt;b&gt;העלאת קובץ לריפו&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;ריפו: &lt;code&gt;</span><span class="si">{</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;selected_repo&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;📂 תיקייה: &lt;code&gt;</span><span class="si">{</span><span class="n">folder_display</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;בחר מקור להעלאה:&quot;</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span>
                    <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;upload_paste_code&quot;</span><span class="p">:</span>
            <span class="c1"># התחלת זרימת &quot;הדבק קוד&quot;</span>
            <span class="c1"># נקה דגלים ישנים</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;waiting_for_paste_content&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;waiting_for_paste_filename&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;paste_content&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_paste_content&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="s2">&quot;✍️ שלח/י כאן את הקוד להעלאה כטקסט.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;לאחר מכן אבקש את שם הקובץ (כולל סיומת).&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">([</span>
                    <span class="p">[</span>
                        <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;upload_file&quot;</span><span class="p">),</span>
                        <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;❌ ביטול&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;cancel_paste_flow&quot;</span><span class="p">),</span>
                    <span class="p">]</span>
                <span class="p">]),</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;gh_upload_cat:repos&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_upload_repos</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;gh_upload_cat:zips&quot;</span><span class="p">:</span>
            <span class="c1"># הצג את כל קבצי ה‑ZIP ששמורים בבוט, ללא סינון לפי ריפו</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;zip_back_to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;github_upload&#39;</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;github_backup_context_repo&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">backup_handler</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">bot_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;backup_handler&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">backup_handler</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span> <span class="nn">backup_menu_handler</span> <span class="kn">import</span> <span class="n">BackupMenuHandler</span>  <span class="c1"># טעינה עצלה למניעת תלות מעגלית</span>
                    <span class="n">backup_handler</span> <span class="o">=</span> <span class="n">BackupMenuHandler</span><span class="p">()</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">bot_data</span><span class="p">[</span><span class="s1">&#39;backup_handler&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">backup_handler</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ רכיב גיבוי לא זמין: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">backup_handler</span><span class="o">.</span><span class="n">_show_backups_list</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה בטעינת קבצי ZIP: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;gh_upload_zip_browse:&quot;</span><span class="p">):</span>
            <span class="c1"># עיון בקובץ ZIP שמור ובחירת קובץ מתוכו להעלאה לריפו</span>
            <span class="n">backup_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
            <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_name</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ חסרים נתונים (בחר ריפו עם /github)&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">infos</span> <span class="o">=</span> <span class="n">backup_manager</span><span class="o">.</span><span class="n">list_backups</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                <span class="n">match</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">infos</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s1">&#39;backup_id&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">backup_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">match</span><span class="o">.</span><span class="n">file_path</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">file_path</span><span class="p">):</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ הגיבוי לא נמצא בדיסק&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="c1"># קרא שמות קבצים מתוך ה‑ZIP (ללא תיקיות ו-metadata.json)</span>
                <span class="kn">import</span> <span class="nn">zipfile</span> <span class="k">as</span> <span class="nn">_zip</span>
                <span class="n">names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">with</span> <span class="n">_zip</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zf</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">zf</span><span class="o">.</span><span class="n">namelist</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="s1">&#39;metadata.json&#39;</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">names</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;ℹ️ אין קבצים ב‑ZIP&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="c1"># עימוד בסיסי</span>
                <span class="n">page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gh_zip_browse_page&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">PAGE</span> <span class="o">=</span> <span class="mi">10</span>
                <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
                <span class="n">total_pages</span> <span class="o">=</span> <span class="p">(</span><span class="n">total</span> <span class="o">+</span> <span class="n">PAGE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">PAGE</span>
                <span class="k">if</span> <span class="n">page</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">page</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">page</span> <span class="o">&gt;</span> <span class="n">total_pages</span><span class="p">:</span>
                    <span class="n">page</span> <span class="o">=</span> <span class="n">total_pages</span>
                <span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">PAGE</span>
                <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">PAGE</span><span class="p">,</span> <span class="n">total</span><span class="p">)</span>
                <span class="n">slice_names</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
                <span class="c1"># שמירת מיפוי שמות בקאש הסשן כדי להימנע מ-callback ארוך מדי</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">cache</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;gh_zip_cache&#39;</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="n">cache</span><span class="p">[</span><span class="n">backup_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;names&#39;</span><span class="p">:</span> <span class="n">names</span><span class="p">}</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="c1"># בנה כפתורים לבחירת קובץ להעלאה + עימוד + חזרה (לפי אינדקס)</span>
                <span class="n">kb</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">slice_names</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">):</span>
                    <span class="n">safe_label</span> <span class="o">=</span> <span class="n">n</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">64</span> <span class="k">else</span> <span class="p">(</span><span class="n">n</span><span class="p">[:</span><span class="mi">30</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;…&#39;</span> <span class="o">+</span> <span class="n">n</span><span class="p">[</span><span class="o">-</span><span class="mi">30</span><span class="p">:])</span>
                    <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">safe_label</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;gh_upload_zip_select_idx:</span><span class="si">{</span><span class="n">backup_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
                <span class="c1"># עימוד</span>
                <span class="n">nav</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">page</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;⬅️ הקודם&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;gh_upload_zip_page:</span><span class="si">{</span><span class="n">backup_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">page</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">page</span> <span class="o">&lt;</span> <span class="n">total_pages</span><span class="p">:</span>
                    <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;הבא ➡️&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;gh_upload_zip_page:</span><span class="si">{</span><span class="n">backup_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">nav</span><span class="p">:</span>
                    <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nav</span><span class="p">)</span>
                <span class="c1"># חזור לרשימת ה‑ZIPים של העלאה</span>
                <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;gh_upload_cat:zips&quot;</span><span class="p">)])</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;בחר קובץ מתוך ZIP להעלאה לריפו:</span><span class="se">\n</span><span class="s2">&lt;code&gt;</span><span class="si">{</span><span class="n">backup_id</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">עמוד </span><span class="si">{</span><span class="n">page</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total_pages</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span>
                    <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה בקריאת ZIP: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;gh_upload_zip_page:&quot;</span><span class="p">):</span>
            <span class="c1"># ניווט עמודים בעיון ה‑ZIP</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">backup_id</span><span class="p">,</span> <span class="n">page_str</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;gh_zip_browse_page&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">page_str</span><span class="p">))</span>
                <span class="c1"># הביא מחדש את אותו מסך</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_menu_callback</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
                <span class="c1"># החלף את ה-callback ל-browse כדי להפעיל את העדכון</span>
                <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;gh_upload_zip_browse:</span><span class="si">{</span><span class="n">backup_id</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_menu_callback</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;שגיאת עימוד&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;gh_upload_zip_select_idx:&quot;</span><span class="p">):</span>
            <span class="c1"># בחירת קובץ מתוך ZIP לפי אינדקס כדי לעמוד במגבלת 64 בתים של callback_data</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">backup_id</span><span class="p">,</span> <span class="n">idx_str</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">idx_str</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;בקשה לא תקפה&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
            <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_name</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ חסרים נתונים (בחר ריפו עם /github)&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="c1"># מצא את הנתיב הפנימי לפי הקאש; אם לא קיים — טען מחדש מה‑ZIP</span>
            <span class="n">inner_path</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cache</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gh_zip_cache&#39;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">names</span> <span class="o">=</span> <span class="p">(</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">backup_id</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;names&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">):</span>
                    <span class="n">inner_path</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">inner_path</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">inner_path</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">infos</span> <span class="o">=</span> <span class="n">backup_manager</span><span class="o">.</span><span class="n">list_backups</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">infos</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s1">&#39;backup_id&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">backup_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">match</span><span class="o">.</span><span class="n">file_path</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">file_path</span><span class="p">):</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ הגיבוי לא נמצא בדיסק&quot;</span><span class="p">)</span>
                        <span class="k">return</span>
                    <span class="kn">import</span> <span class="nn">zipfile</span> <span class="k">as</span> <span class="nn">_zip</span>
                    <span class="k">with</span> <span class="n">_zip</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zf</span><span class="p">:</span>
                        <span class="n">all_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">zf</span><span class="o">.</span><span class="n">namelist</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">n</span> <span class="o">!=</span> <span class="s1">&#39;metadata.json&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_names</span><span class="p">):</span>
                        <span class="n">inner_path</span> <span class="o">=</span> <span class="n">all_names</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ פריט לא קיים ב‑ZIP&quot;</span><span class="p">)</span>
                        <span class="k">return</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה בקריאת ZIP: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
            <span class="c1"># המשך זרימת העלאה זהה לבחירה לפי מחרוזת</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">infos</span> <span class="o">=</span> <span class="n">backup_manager</span><span class="o">.</span><span class="n">list_backups</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                <span class="n">match</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">infos</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s1">&#39;backup_id&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">backup_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">match</span><span class="o">.</span><span class="n">file_path</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">file_path</span><span class="p">):</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ הגיבוי לא נמצא בדיסק&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="kn">import</span> <span class="nn">zipfile</span> <span class="k">as</span> <span class="nn">_zip</span>
                <span class="k">with</span> <span class="n">_zip</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zf</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">raw</span> <span class="o">=</span> <span class="n">zf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">inner_path</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ קובץ לא נמצא בתוך ה‑ZIP&quot;</span><span class="p">)</span>
                        <span class="k">return</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">content_text</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">content_text</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;latin-1&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ לא ניתן לפענח את הקובץ: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">return</span>
                <span class="n">target_folder</span> <span class="o">=</span> <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;upload_target_folder&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_folder&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
                <span class="n">target_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target_folder</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">inner_path</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">target_folder</span> <span class="k">else</span> <span class="n">inner_path</span>
                <span class="kn">import</span> <span class="nn">re</span> <span class="k">as</span> <span class="nn">_re</span>
                <span class="n">target_path</span> <span class="o">=</span> <span class="n">_re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;/+&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">target_path</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">))</span>
                <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span>
                <span class="n">branch</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;upload_target_branch&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">repo</span><span class="o">.</span><span class="n">default_branch</span> <span class="ow">or</span> <span class="s2">&quot;main&quot;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">existing</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="n">target_path</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">branch</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">update_file</span><span class="p">(</span>
                        <span class="n">path</span><span class="o">=</span><span class="n">target_path</span><span class="p">,</span>
                        <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Update </span><span class="si">{</span><span class="n">inner_path</span><span class="si">}</span><span class="s2"> via Telegram bot&quot;</span><span class="p">,</span>
                        <span class="n">content</span><span class="o">=</span><span class="n">content_text</span><span class="p">,</span>
                        <span class="n">sha</span><span class="o">=</span><span class="n">existing</span><span class="o">.</span><span class="n">sha</span><span class="p">,</span>
                        <span class="n">branch</span><span class="o">=</span><span class="n">branch</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ הקובץ עודכן בהצלחה ל-&lt;code&gt;</span><span class="si">{</span><span class="n">target_path</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">create_file</span><span class="p">(</span>
                        <span class="n">path</span><span class="o">=</span><span class="n">target_path</span><span class="p">,</span>
                        <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Upload </span><span class="si">{</span><span class="n">inner_path</span><span class="si">}</span><span class="s2"> via Telegram bot&quot;</span><span class="p">,</span>
                        <span class="n">content</span><span class="o">=</span><span class="n">content_text</span><span class="p">,</span>
                        <span class="n">branch</span><span class="o">=</span><span class="n">branch</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ הקובץ הועלה בהצלחה ל-&lt;code&gt;</span><span class="si">{</span><span class="n">target_path</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span>
                <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;➕ העלה קובץ נוסף מה‑ZIP&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;gh_upload_zip_browse:</span><span class="si">{</span><span class="n">backup_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)],</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;gh_upload_cat:zips&quot;</span><span class="p">)],</span>
                <span class="p">]</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;🎯 בחר פעולה:&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה בהעלאה: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;gh_upload_zip_select:&quot;</span><span class="p">):</span>
            <span class="c1"># בחירת קובץ ספציפי מתוך ZIP להעלאה לריפו</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">backup_id</span><span class="p">,</span> <span class="n">inner_path</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;בקשה לא תקפה&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
            <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_name</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ חסרים נתונים (בחר ריפו עם /github)&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="c1"># בדוק את ה‑ZIP והוצא את התוכן של הקובץ</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">infos</span> <span class="o">=</span> <span class="n">backup_manager</span><span class="o">.</span><span class="n">list_backups</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                <span class="n">match</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">infos</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s1">&#39;backup_id&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">backup_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">match</span><span class="o">.</span><span class="n">file_path</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">file_path</span><span class="p">):</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ הגיבוי לא נמצא בדיסק&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="kn">import</span> <span class="nn">zipfile</span> <span class="k">as</span> <span class="nn">_zip</span>
                <span class="k">with</span> <span class="n">_zip</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zf</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">raw</span> <span class="o">=</span> <span class="n">zf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">inner_path</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ קובץ לא נמצא בתוך ה‑ZIP&quot;</span><span class="p">)</span>
                        <span class="k">return</span>
                <span class="c1"># המרת תוכן לטקסט (utf-8 או latin-1)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">content_text</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">content_text</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;latin-1&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ לא ניתן לפענח את הקובץ: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">return</span>
                <span class="c1"># יעד: נתיב התיקייה שנבחרה + שם הקובץ המקורי מה‑ZIP</span>
                <span class="n">target_folder</span> <span class="o">=</span> <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;upload_target_folder&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_folder&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
                <span class="n">target_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target_folder</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">inner_path</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">target_folder</span> <span class="k">else</span> <span class="n">inner_path</span>
                <span class="c1"># ודא שימוש בנתיב נקי ללא כפילויות &#39;/&#39;</span>
                <span class="kn">import</span> <span class="nn">re</span> <span class="k">as</span> <span class="nn">_re</span>
                <span class="n">target_path</span> <span class="o">=</span> <span class="n">_re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;/+&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">target_path</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">))</span>
                <span class="c1"># בצע יצירה/עדכון</span>
                <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span>
                <span class="n">branch</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;upload_target_branch&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">repo</span><span class="o">.</span><span class="n">default_branch</span> <span class="ow">or</span> <span class="s2">&quot;main&quot;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">existing</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="n">target_path</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">branch</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">update_file</span><span class="p">(</span>
                        <span class="n">path</span><span class="o">=</span><span class="n">target_path</span><span class="p">,</span>
                        <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Update </span><span class="si">{</span><span class="n">inner_path</span><span class="si">}</span><span class="s2"> via Telegram bot&quot;</span><span class="p">,</span>
                        <span class="n">content</span><span class="o">=</span><span class="n">content_text</span><span class="p">,</span>
                        <span class="n">sha</span><span class="o">=</span><span class="n">existing</span><span class="o">.</span><span class="n">sha</span><span class="p">,</span>
                        <span class="n">branch</span><span class="o">=</span><span class="n">branch</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ הקובץ עודכן בהצלחה ל-&lt;code&gt;</span><span class="si">{</span><span class="n">target_path</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">create_file</span><span class="p">(</span>
                        <span class="n">path</span><span class="o">=</span><span class="n">target_path</span><span class="p">,</span>
                        <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Upload </span><span class="si">{</span><span class="n">inner_path</span><span class="si">}</span><span class="s2"> via Telegram bot&quot;</span><span class="p">,</span>
                        <span class="n">content</span><span class="o">=</span><span class="n">content_text</span><span class="p">,</span>
                        <span class="n">branch</span><span class="o">=</span><span class="n">branch</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ הקובץ הועלה בהצלחה ל-&lt;code&gt;</span><span class="si">{</span><span class="n">target_path</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span>
                <span class="c1"># הצע פעולות המשך: בחר קובץ נוסף מה‑ZIP או חזור</span>
                <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;➕ העלה קובץ נוסף מה‑ZIP&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;gh_upload_zip_browse:</span><span class="si">{</span><span class="n">backup_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)],</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;gh_upload_cat:zips&quot;</span><span class="p">)],</span>
                <span class="p">]</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;🎯 בחר פעולה:&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה בהעלאה: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;gh_upload_cat:large&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">upload_large_files_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;gh_upload_cat:other&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_upload_other_files</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="c1"># --- Create new repository from ZIP ---</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;github_create_repo_from_zip&quot;</span><span class="p">:</span>
            <span class="c1"># הכנה לזרימת יצירת ריפו חדש מתוך ZIP</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
            <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ אין חיבור ל-GitHub. שלח /github כדי להגדיר טוקן&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="c1"># נקה דגלים ישנים כדי למנוע בלבול בקליטת המסמכים</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_github_upload&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;upload_mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;github_create_repo_from_zip&quot;</span>
            <span class="c1"># ברירת מחדל: ריפו פרטי</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;new_repo_private&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">vis_text</span> <span class="o">=</span> <span class="s2">&quot;פרטי&quot;</span> <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;new_repo_private&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;ציבורי&quot;</span>
            <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;✍️ הקלד שם ריפו&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_new_repo_name&quot;</span><span class="p">)],</span>
                <span class="p">[</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                        <span class="s2">&quot;🔒 פרטי ✅&quot;</span> <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;new_repo_private&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;🔒 פרטי&quot;</span><span class="p">,</span>
                        <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_set_new_repo_visibility:1&quot;</span>
                    <span class="p">),</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                        <span class="s2">&quot;🌐 ציבורי ✅&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;new_repo_private&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;🌐 ציבורי&quot;</span><span class="p">,</span>
                        <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_set_new_repo_visibility:0&quot;</span>
                    <span class="p">),</span>
                <span class="p">],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)],</span>
            <span class="p">]</span>
            <span class="n">help_txt</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;🆕 &lt;b&gt;יצירת ריפו חדש מּZIP&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;1) ניתן להקליד שם לריפו (ללא רווחים)</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;2) בחר אם הריפו יהיה &lt;b&gt;פרטי&lt;/b&gt; או &lt;b&gt;ציבורי&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;3) שלח עכשיו קובץ ZIP עם כל הקבצים</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;אם לא תוקלד שם, ננסה לחלץ שם מתיקיית-הבסיס בּZIP או משם הקובץ.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;ברירת מחדל: &lt;code&gt;repo-&amp;lt;timestamp&amp;gt;&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;נראות נוכחית: &lt;b&gt;</span><span class="si">{</span><span class="n">vis_text</span><span class="si">}</span><span class="s2">&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;לאחר השליחה, ניצור ריפו לפי בחירתך ונפרוס את התוכן ב-commit אחד.&quot;</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">help_txt</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;github_new_repo_name&quot;</span><span class="p">:</span>
            <span class="c1"># בקשת שם לריפו החדש</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_new_repo_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="s2">&quot;✏️ הקלד שם לריפו החדש (מותר אותיות, מספרים, נקודות, מקפים וקו תחתון).</span><span class="se">\n</span><span class="s2">שלח טקסט עכשיו.&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">([[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_create_repo_from_zip&quot;</span><span class="p">)]])</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;github_set_new_repo_visibility:&quot;</span><span class="p">):</span>
            <span class="c1"># בחירת נראות (פרטי/ציבורי) לריפו החדש</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">is_private</span> <span class="o">=</span> <span class="n">flag</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;new_repo_private&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_private</span>
            <span class="n">vis_text</span> <span class="o">=</span> <span class="s2">&quot;פרטי&quot;</span> <span class="k">if</span> <span class="n">is_private</span> <span class="k">else</span> <span class="s2">&quot;ציבורי&quot;</span>
            <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;✍️ הקלד שם ריפו&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_new_repo_name&quot;</span><span class="p">)],</span>
                <span class="p">[</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                        <span class="s2">&quot;🔒 פרטי ✅&quot;</span> <span class="k">if</span> <span class="n">is_private</span> <span class="k">else</span> <span class="s2">&quot;🔒 פרטי&quot;</span><span class="p">,</span>
                        <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_set_new_repo_visibility:1&quot;</span>
                    <span class="p">),</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                        <span class="s2">&quot;🌐 ציבורי ✅&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">is_private</span> <span class="k">else</span> <span class="s2">&quot;🌐 ציבורי&quot;</span><span class="p">,</span>
                        <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_set_new_repo_visibility:0&quot;</span>
                    <span class="p">),</span>
                <span class="p">],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)],</span>
            <span class="p">]</span>
            <span class="n">help_txt</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;🆕 &lt;b&gt;יצירת ריפו חדש מּZIP&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;1) ניתן להקליד שם לריפו (ללא רווחים)</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;2) בחר אם הריפו יהיה &lt;b&gt;פרטי&lt;/b&gt; או &lt;b&gt;ציבורי&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;3) שלח עכשיו קובץ ZIP עם כל הקבצים</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;אם לא תוקלד שם, ננסה לחלץ שם מתיקיית-הבסיס בּZIP או משם הקובץ.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;ברירת מחדל: &lt;code&gt;repo-&amp;lt;timestamp&amp;gt;&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;נראות נוכחית: &lt;b&gt;</span><span class="si">{</span><span class="n">vis_text</span><span class="si">}</span><span class="s2">&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;לאחר השליחה, ניצור ריפו לפי בחירתך ונפרוס את התוכן ב-commit אחד.&quot;</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">help_txt</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="k">raise</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;עודכנה הנראות&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;gh_upload_repo:&quot;</span><span class="p">):</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_upload_repo_files</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;other_files_page_&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="c1"># שמירת עמוד, כדי שלא נקפוץ לעמוד הראשון אחרי פעולה</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;other_files_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_upload_other_files</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;repo_files_page:&quot;</span><span class="p">):</span>
            <span class="c1"># פורמט: repo_files_page:&lt;repo_tag&gt;:&lt;page&gt;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">repo_tag</span><span class="p">,</span> <span class="n">page_s</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">page_s</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">repo_tag</span><span class="p">,</span> <span class="n">page</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">repo_tag</span><span class="p">:</span>
                <span class="c1"># שמור עמוד נוכחי לכל תגית</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;repo_files_page&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
                <span class="n">d</span><span class="p">[</span><span class="n">repo_tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;repo_files_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_upload_repo_files</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">repo_tag</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;gh_upload_large:&quot;</span><span class="p">):</span>
            <span class="n">file_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_large_file_upload</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">file_id</span><span class="p">)</span>

        <span class="c1"># הוסר: &quot;upload_saved&quot; — הזרימה כלולה ב&quot;העלה קובץ חדש&quot;</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;repos_page_&quot;</span><span class="p">):</span>
            <span class="n">page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_repos</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;upload_saved_&quot;</span><span class="p">):</span>
            <span class="n">file_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
            <span class="c1"># Show pre-upload check screen before actual upload</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;pending_saved_file_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_id</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_pre_upload_check</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;choose_upload_branch&quot;</span><span class="p">:</span>
            <span class="c1"># מענה מיידי כדי לשחרר את ה-UI לפני טעינת רשימת ענפים</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;טוען ענפים…&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_upload_branch_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;upload_branches_page_&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;upload_branches_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_upload_branch_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;upload_select_branch_tok:&quot;</span><span class="p">):</span>
            <span class="n">tok</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">br</span> <span class="o">=</span> <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;upload_branch_tokens&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tok</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">br</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;⚠️ לא נמצא ענף לבחירה&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;upload_target_branch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">br</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_pre_upload_check</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;choose_upload_folder&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;טוען תיקיות…&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_upload_folder_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;upload_select_folder:&quot;</span><span class="p">):</span>
            <span class="c1"># בחירת תיקייה מתוך דפדפן הריפו</span>
            <span class="n">folder_path</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># normalize to no leading/trailing slashes</span>
            <span class="n">folder_norm</span> <span class="o">=</span> <span class="p">(</span><span class="n">folder_path</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;upload_target_folder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">folder_norm</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_pre_upload_check</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;upload_folder_root&quot;</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;upload_target_folder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_pre_upload_check</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;upload_folder_current&quot;</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;upload_target_folder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_folder&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_pre_upload_check</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;upload_folder_custom&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;הקלד/י נתיב יעד…&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">ask_upload_folder</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;upload_folder_create&quot;</span><span class="p">:</span>
            <span class="c1"># פתח זרימת יצירת תיקייה (תואם למסלול בהמשך עבור create_folder)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_new_folder_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># חזרה למסך הבדיקות לאחר היצירה</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;return_to_pre_upload&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[[</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;create_folder_back&quot;</span><span class="p">),</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;❌ ביטול&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;create_folder_cancel&quot;</span><span class="p">)</span>
            <span class="p">]]</span>
            <span class="c1"># שחרר את ה‑UI מיד כדי למנוע תחושת תקיעה</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;הקלד/י נתיב תיקייה…&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="c1"># נסה לערוך את ההודעה, ובמקרה של &quot;message is not modified&quot; עדכן רק את המקלדת, או שלח הודעה חדשה</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                    <span class="s2">&quot;➕ יצירת תיקייה חדשה</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;✏️ כתוב נתיב תיקייה חדשה (לדוגמה: src/new/section).</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;ניצור קובץ ‎.gitkeep‎ בתוך התיקייה כדי ש‑Git ישמור אותה.&quot;</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">TelegramUtils</span> <span class="k">as</span> <span class="n">_TU</span>
                        <span class="k">await</span> <span class="n">_TU</span><span class="o">.</span><span class="n">safe_edit_message_reply_markup</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="c1"># כגיבוי, שלח הודעה חדשה</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                                <span class="s2">&quot;➕ יצירת תיקייה חדשה</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                                <span class="s2">&quot;✏️ כתוב נתיב תיקייה חדשה (לדוגמה: src/new/section).</span><span class="se">\n</span><span class="s2">&quot;</span>
                                <span class="s2">&quot;ניצור קובץ ‎.gitkeep‎ בתוך התיקייה כדי ש‑Git ישמור אותה.&quot;</span><span class="p">,</span>
                                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
                            <span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span>
            <span class="k">return</span> <span class="n">REPO_SELECT</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;confirm_saved_upload&quot;</span><span class="p">:</span>
            <span class="n">file_id</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pending_saved_file_id&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">file_id</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ לא נמצא קובץ ממתין להעלאה&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_saved_file_upload</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">file_id</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;refresh_saved_checks&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_pre_upload_check</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;back_to_menu&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">github_menu_command</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;folder_select_done&quot;</span><span class="p">:</span>
            <span class="c1"># סיום בחירת תיקייה דרך הדפדפן והצגת מצב</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;folder_select_mode&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">github_menu_command</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;folder_set_session:&quot;</span><span class="p">):</span>
            <span class="n">folder_path</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">session</span><span class="p">[</span><span class="s2">&quot;selected_folder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">folder_path</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ תיקיית יעד עודכנה ל-</span><span class="si">{</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;selected_folder&#39;</span><span class="p">]</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># יציאה ממסך בחירת תיקייה וחזרה לתפריט הראשי כדי למנוע שגיאת &quot;Message is not modified&quot;</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;folder_select_mode&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">github_menu_command</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;noop&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="n">cache_time</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># לא עושה כלום, רק לכפתור התצוגה</span>

        <span class="c1"># --- New: logout GitHub token from menu ---</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;logout_github&quot;</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>

            <span class="n">removed</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">delete_github_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">session</span><span class="p">[</span><span class="s2">&quot;github_token&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="c1"># נקה גם בחירות קודמות כאשר מתנתקים</span>
                <span class="n">session</span><span class="p">[</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">session</span><span class="p">[</span><span class="s2">&quot;selected_folder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="c1"># נקה קאש ריפוזיטוריז</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;repos&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;repos_cache_time&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">removed</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;🔐 התנתקת מ-GitHub והטוקן נמחק.⏳ מרענן תפריט...&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;ℹ️ לא נמצא טוקן או שאירעה שגיאה.⏳ מרענן תפריט...&quot;</span><span class="p">)</span>
            <span class="c1"># refresh the menu after logout</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">github_menu_command</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;github_import_repo&quot;</span><span class="p">:</span>
            <span class="c1"># פתיחת זרימת ייבוא ריפו (בחירת ענף → ייבוא)</span>
            <span class="n">repo_full</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">repo_full</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ קודם בחר ריפו!</span><span class="se">\n</span><span class="s2">שלח /github ובחר &#39;בחר ריפו&#39;&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_import_branch_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;import_repo_branches_page_&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;import_branches_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_import_branch_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;import_repo_select_branch:&quot;</span><span class="p">):</span>
            <span class="n">token</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">token_map</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;import_branch_token_map&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">branch</span> <span class="o">=</span> <span class="n">token_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;import_repo_branch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">branch</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_confirm_import_repo</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">branch</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;import_repo_start&quot;</span><span class="p">:</span>
            <span class="c1"># התחלת ייבוא בפועל</span>
            <span class="n">repo_full</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
            <span class="n">branch</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;import_repo_branch&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">repo_full</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">branch</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ חסרים נתונים ליבוא. בחר ריפו וענף מחדש.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">import_repo_from_zip</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">repo_full</span><span class="p">,</span> <span class="n">branch</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;import_repo_cancel&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">github_menu_command</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;analyze_repo&quot;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🔍 User </span><span class="si">{</span><span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> clicked &#39;analyze_repo&#39; button&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_analyze_repo_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;analyze_current_repo&quot;</span><span class="p">:</span>
            <span class="c1"># נתח את הריפו הנבחר</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📊 User </span><span class="si">{</span><span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> analyzing current repo&quot;</span><span class="p">)</span>
            <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="n">repo_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://github.com/</span><span class="si">{</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;selected_repo&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_repository</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">repo_url</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;back_to_github_menu&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">github_menu_command</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;analyze_other_repo&quot;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🔄 User </span><span class="si">{</span><span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> wants to analyze another repo&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_another_repo</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;show_suggestions&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_improvement_suggestions</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;show_full_analysis&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_full_analysis</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;download_analysis_json&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_analysis_json</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;github_backup_menu&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_github_backup_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;github_backup_db_list&quot;</span><span class="p">:</span>
            <span class="c1"># מעבר לרשימת &quot;גיבויי DB אחרונים&quot; מתוך תפריט GitHub, עם חזרה ל-GitHub</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">backup_handler</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">bot_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;backup_handler&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">backup_handler</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="kn">from</span> <span class="nn">backup_menu_handler</span> <span class="kn">import</span> <span class="n">BackupMenuHandler</span>
                    <span class="n">backup_handler</span> <span class="o">=</span> <span class="n">BackupMenuHandler</span><span class="p">()</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">bot_data</span><span class="p">[</span><span class="s1">&#39;backup_handler&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">backup_handler</span>
                <span class="c1"># קבע הקשר חזרה ל-GitHub והסר סינון לפי ריפו לרשימה זו</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;zip_back_to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;github&#39;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;github_backup_context_repo&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">await</span> <span class="n">backup_handler</span><span class="o">.</span><span class="n">_show_backups_list</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה בטעינת גיבויים: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;github_restore_zip_to_repo&quot;</span><span class="p">:</span>
            <span class="c1"># התחלת שחזור ZIP ידני לריפו: הגדר מצב העלאה ובקש בחירת purge</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
            <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">repo_full</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_full</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ חסר טוקן או ריפו נבחר&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                        <span class="k">raise</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;❌ חסר טוקן או ריפו נבחר&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">return</span>
            <span class="c1"># ודא שניקינו דגלים ישנים של העלאה רגילה כדי למנוע בלבול</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_github_upload&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;upload_mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;github_restore_zip_to_repo&quot;</span>
            <span class="c1"># נעל את יעד הריפו הצפוי לשחזור (חגורת בטיחות נגד ריפו אחר)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;zip_restore_expected_repo_full&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">repo_full</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># לא קריטי אם נכשלת שמירת סטייט - נאתר בהמשך</span>
                <span class="k">pass</span>
            <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🧹 מחיקה מלאה לפני העלאה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_restore_zip_setpurge:1&quot;</span><span class="p">)],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🚫 אל תמחק, רק עדכן&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_restore_zip_setpurge:0&quot;</span><span class="p">)],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;❌ ביטול&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_backup_menu&quot;</span><span class="p">)],</span>
            <span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                    <span class="s2">&quot;בחר מצב שחזור ZIP לריפו, ואז שלח קובץ ZIP עכשיו:&quot;</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                        <span class="s2">&quot;בחר מצב שחזור ZIP לריפו, ואז שלח קובץ ZIP עכשיו:&quot;</span><span class="p">,</span>
                        <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;אין שינוי בתצוגה&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;github_restore_zip_setpurge:&quot;</span><span class="p">):</span>
            <span class="c1"># טיפול בבחירת מצב מחיקה/עדכון לפני העלאה</span>
            <span class="n">purge_flag</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span>
            <span class="c1"># ודא שניקינו דגלים ישנים של העלאה רגילה כדי למנוע בלבול</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_github_upload&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;upload_mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;github_restore_zip_to_repo&quot;</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;github_restore_zip_purge&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">purge_flag</span>
            <span class="c1"># השאר את היעד הצפוי אם כבר נקבע קודם</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;zip_restore_expected_repo_full&quot;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;zip_restore_expected_repo_full&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="p">(</span><span class="s2">&quot;🧹 יבוצע ניקוי לפני העלאה. &quot;</span> <span class="k">if</span> <span class="n">purge_flag</span> <span class="k">else</span> <span class="s2">&quot;🔁 ללא מחיקה. &quot;</span><span class="p">)</span> <span class="o">+</span>
                <span class="s2">&quot;שלח עכשיו קובץ ZIP לשחזור לריפו.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;github_restore_zip_list&quot;</span><span class="p">:</span>
            <span class="c1"># הצג רשימת גיבויים (ZIP) של הריפו הנוכחי לצורך שחזור לריפו</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
            <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">repo_full</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">repo_full</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ קודם בחר ריפו!&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">backups</span> <span class="o">=</span> <span class="n">backup_manager</span><span class="o">.</span><span class="n">list_backups</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="c1"># סנן רק גיבויים עם metadata של אותו ריפו</span>
            <span class="n">backups</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">backups</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s1">&#39;repo&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="n">repo_full</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">backups</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;ℹ️ אין גיבויי ZIP שמורים עבור הריפו:</span><span class="se">\n</span><span class="s2">&lt;code&gt;</span><span class="si">{</span><span class="n">repo_full</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span><span class="p">,</span>
                    <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">([[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_backup_menu&quot;</span><span class="p">)]])</span>
                <span class="p">)</span>
                <span class="k">return</span>
            <span class="c1"># הצג עד 10 אחרונים</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">backups</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;בחר גיבוי לשחזור לריפו:</span><span class="se">\n</span><span class="s2">&lt;code&gt;</span><span class="si">{</span><span class="n">repo_full</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">]</span>
            <span class="n">kb</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;• </span><span class="si">{</span><span class="n">b</span><span class="o">.</span><span class="n">backup_id</span><span class="si">}</span><span class="s2"> — </span><span class="si">{</span><span class="n">b</span><span class="o">.</span><span class="n">created_at</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/%m/%Y %H:%M&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> — </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">total_size</span><span class="o">/</span><span class="mi">1024</span><span class="p">)</span><span class="si">}</span><span class="s2">KB&quot;</span><span class="p">)</span>
                <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;♻️ שחזר גיבוי זה לריפו&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;github_restore_zip_from_backup:</span><span class="si">{</span><span class="n">b</span><span class="o">.</span><span class="n">backup_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
            <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_backup_menu&quot;</span><span class="p">)])</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;github_restore_zip_from_backup:&quot;</span><span class="p">):</span>
            <span class="c1"># קבל backup_id ואז פתח את תהליך השחזור-לריפו עם קובץ ה-ZIP הזה</span>
            <span class="n">backup_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
            <span class="n">info_list</span> <span class="o">=</span> <span class="n">backup_manager</span><span class="o">.</span><span class="n">list_backups</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">match</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">info_list</span> <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">backup_id</span> <span class="o">==</span> <span class="n">backup_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">match</span><span class="o">.</span><span class="n">file_path</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">file_path</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ הגיבוי לא נמצא בדיסק&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="c1"># הגדר purge? בקש בחירה</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;pending_repo_restore_zip_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">file_path</span>
            <span class="c1"># נעל את יעד הריפו הצפוי עבור השחזור מתוך גיבוי</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;zip_restore_expected_repo_full&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="s2">&quot;האם למחוק קודם את התוכן בריפו לפני העלאה?&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">([</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🧹 מחיקה מלאה לפני העלאה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_repo_restore_backup_setpurge:1&quot;</span><span class="p">)],</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🚫 אל תמחק, רק עדכן&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_repo_restore_backup_setpurge:0&quot;</span><span class="p">)],</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;❌ ביטול&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_backup_menu&quot;</span><span class="p">)],</span>
                <span class="p">])</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;github_backup_help&quot;</span><span class="p">:</span>
            <span class="n">help_text</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;&lt;b&gt;הסבר על הכפתורים:&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;📦 &lt;b&gt;הורד גיבוי ZIP של הריפו&lt;/b&gt;: יוצר ומוריד ZIP של כל התוכן (או תיקייה נוכחית), וגם שומר כגיבוי לשימוש עתידי.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;♻️ &lt;b&gt;שחזר ZIP לריפו (פריסה והחלפה)&lt;/b&gt;: שלח ZIP מהמחשב, והבוט יפרוס אותו לריפו בקומיט אחד. ניתן לבחור מחיקה מלאה לפני או עדכון בלבד.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;📂 &lt;b&gt;שחזר מגיבוי שמור לריפו&lt;/b&gt;: בחר ZIP ששמור בבוט עבור הריפו הזה, והבוט יפרוס אותו לריפו (מחיקה/עדכון לפי בחירה).</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;🏷 &lt;b&gt;נקודת שמירה בגיט&lt;/b&gt;: יוצר תגית/ענף נקודת שמירה של הריפו הנוכחי כדי שתוכל לחזור אליה.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;↩️ &lt;b&gt;חזרה לנקודת שמירה&lt;/b&gt;: פעולות לשחזור מצב מהרפרנס של נקודת שמירה (תגית/ענף) — כולל יצירת ענף/PR לשחזור.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;🗂 &lt;b&gt;גיבויי DB אחרונים&lt;/b&gt;: מציג גיבויים של קבצים בבוט עצמו (לא קשור ל‑GitHub).</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;♻️ &lt;b&gt;שחזור מגיבוי (ZIP)&lt;/b&gt;: שחזור מלא לקבצים בבוט עצמו מקובץ ZIP. מוחק את כל הקבצים בבוט ואז משחזר.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;🔙 &lt;b&gt;חזור&lt;/b&gt;: חזרה לתפריט הראשי של GitHub.&quot;</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">help_text</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">([[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_backup_menu&quot;</span><span class="p">)]]))</span>
            <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="k">raise</span>
            <span class="k">return</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;backup_menu&quot;</span><span class="p">:</span>
            <span class="c1"># האצלת תצוגת תפריט הגיבוי/שחזור של DB ל-BackupMenuHandler</span>
            <span class="n">backup_handler</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">bot_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;backup_handler&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">backup_handler</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">backup_handler</span><span class="o">.</span><span class="n">show_backup_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ רכיב גיבוי לא זמין&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;back_to_analysis&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_full_analysis</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;back_to_analysis_menu&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_analyze_results_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;back_to_summary&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_analyze_results_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;choose_my_repo&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_repos</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;enter_repo_url&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_repo_url</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;suggestion_&quot;</span><span class="p">):</span>
            <span class="n">suggestion_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_suggestion_details</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">suggestion_index</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;show_current&quot;</span><span class="p">:</span>
            <span class="n">current_repo</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">,</span> <span class="s2">&quot;לא נבחר&quot;</span><span class="p">)</span>
            <span class="n">current_folder</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_folder&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;root&quot;</span>
            <span class="n">has_token</span> <span class="o">=</span> <span class="s2">&quot;✅&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;❌&quot;</span>

            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזרה לתפריט&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)]]</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;📊 &lt;b&gt;הגדרות נוכחיות:&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;📁 ריפו: &lt;code&gt;</span><span class="si">{</span><span class="n">current_repo</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;📂 תיקייה: &lt;code&gt;</span><span class="si">{</span><span class="n">current_folder</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;🔑 טוקן מוגדר: </span><span class="si">{</span><span class="n">has_token</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;💡 טיפ: השתמש ב-&#39;בחר תיקיית יעד&#39; כדי לשנות את מיקום ההעלאה&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;set_token&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="s2">&quot;🔑 שלח לי את הטוקן של GitHub:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;הטוקן יישמר בצורה מאובטחת לחשבון שלך לצורך שימוש עתידי.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;תוכל להסיר אותו בכל עת עם הפקודה /github_logout.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;💡 טיפ: צור טוקן ב:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;https://github.com/settings/tokens&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">REPO_SELECT</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;set_folder&quot;</span><span class="p">:</span>
            <span class="c1"># פתח דפדפן ריפו לבחירת תיקיה אמיתית מתוך הריפו</span>
            <span class="c1"># סימון מצב בחירת תיקיה עבור session</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;folder_select_mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;session&quot;</span>
            <span class="c1"># אתחל מצב דפדוף</span>
            <span class="n">current</span> <span class="o">=</span> <span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_folder&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;download&quot;</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;multi_mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;multi_selection&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># מענה מיידי כדי למנוע תחושת תקיעה</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;טוען דפדפן תיקיות…&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_repo_browser</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;folder_&quot;</span><span class="p">):</span>
            <span class="n">folder</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;folder_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">folder</span> <span class="o">==</span> <span class="s2">&quot;custom&quot;</span><span class="p">:</span>
                <span class="c1"># בקש קלט לתיקייה מותאמת אישית</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_selected_folder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                    <span class="s2">&quot;✏️ הקלד שם תיקייה (לדוגמה: src/images)</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;השאר ריק או הקלד / כדי לבחור root&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">FOLDER_SELECT</span>
            <span class="k">elif</span> <span class="n">folder</span> <span class="o">==</span> <span class="s2">&quot;root&quot;</span><span class="p">:</span>
                <span class="n">session</span><span class="p">[</span><span class="s2">&quot;selected_folder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;✅ תיקייה עודכנה ל-root&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">github_menu_command</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">session</span><span class="p">[</span><span class="s2">&quot;selected_folder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">folder</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ תיקייה עודכנה ל-</span><span class="si">{</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;selected_folder&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">github_menu_command</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;create_folder&quot;</span><span class="p">,</span> <span class="s2">&quot;upload_folder_create&quot;</span><span class="p">):</span>
            <span class="c1"># בקש מהמשתמש נתיב תיקייה חדשה ליצירה (ניצור .gitkeep בתוך התיקייה)</span>
            <span class="n">return_to_pre</span> <span class="o">=</span> <span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;upload_folder_create&quot;</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_new_folder_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;return_to_pre_upload&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">return_to_pre</span>
            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;create_folder_back&quot;</span><span class="p">),</span> <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;❌ ביטול&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;create_folder_cancel&quot;</span><span class="p">)]]</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="s2">&quot;➕ יצירת תיקייה חדשה</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;✏️ כתוב נתיב תיקייה חדשה (לדוגמה: src/new/section).</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;ניצור קובץ ‎.gitkeep‎ בתוך התיקייה כדי ש‑Git ישמור אותה.&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">REPO_SELECT</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;create_folder_back&quot;</span><span class="p">:</span>
            <span class="c1"># חזרה למסך &quot;תיקיית יעד&quot;</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_new_folder_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_upload_folder_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">REPO_SELECT</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;create_folder_cancel&quot;</span><span class="p">:</span>
            <span class="c1"># ביטול יצירת תיקייה וחזרה לתפריט GitHub</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_new_folder_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;return_to_pre_upload&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">github_menu_command</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">REPO_SELECT</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;github_menu&quot;</span><span class="p">:</span>
            <span class="c1"># חזרה לתפריט הראשי של GitHub</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_github_upload&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;in_github_menu&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;folder_select_mode&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="c1"># נקה דגל סינון גיבויים לפי ריפו, אם קיים</span>
            <span class="c1"># נקה דגלים זמניים של יצירת ריפו חדש</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;waiting_for_new_repo_name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;new_repo_name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;upload_mode&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;github_create_repo_from_zip&quot;</span><span class="p">:</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;upload_mode&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;new_repo_private&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;github_backup_context_repo&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">github_menu_command</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
        
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;git_checkpoint&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">git_checkpoint</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;git_checkpoint_doc:&quot;</span><span class="p">):</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">kind</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_checkpoint_doc</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;git_checkpoint_doc_skip&quot;</span><span class="p">:</span>
            <span class="n">kb</span> <span class="o">=</span> <span class="p">[[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;back_to_menu&quot;</span><span class="p">)]]</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="s2">&quot;✅ נקודת שמירה נוצרה. ניתן לחזור לתפריט או להעלות קבצים שמורים.&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span>
            <span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;restore_checkpoint_menu&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_restore_checkpoint_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;restore_tags_page_&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;restore_tags_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_restore_checkpoint_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;restore_select_tag:&quot;</span><span class="p">):</span>
            <span class="n">tag_name</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_restore_tag_actions</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">tag_name</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;restore_branch_from_tag:&quot;</span><span class="p">):</span>
            <span class="n">tag_name</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_branch_from_tag</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">tag_name</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;open_pr_from_branch:&quot;</span><span class="p">):</span>
            <span class="n">branch_name</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_pr_from_branch</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">branch_name</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;restore_revert_pr_from_tag:&quot;</span><span class="p">):</span>
            <span class="n">tag_name</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_revert_pr_from_tag</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">tag_name</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;close_menu&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;👋 התפריט נסגר&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;repo_&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;repo_manual&quot;</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                    <span class="s2">&quot;✏️ הקלד שם ריפו בפורמט:</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;&lt;code&gt;owner/repository&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;לדוגמה: &lt;code&gt;amirbiron/CodeBot&lt;/code&gt;&quot;</span><span class="p">,</span>
                    <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">REPO_SELECT</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">repo_name</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;repo_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">session</span><span class="p">[</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">repo_name</span>
                <span class="c1"># איפוס תיקיות יעד ישנות בעת בחירת ריפו חדש</span>
                <span class="n">session</span><span class="p">[</span><span class="s2">&quot;selected_folder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;upload_target_folder&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;upload_target_branch&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

                <span class="c1"># נקה סטייטים זמניים של זרם שחזור/גיבוי כדי למנוע נעילה לריפו קודם</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;zip_restore_expected_repo_full&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;github_restore_zip_purge&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;pending_repo_restore_zip_path&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;upload_mode&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>

                <span class="c1"># שמור במסד נתונים</span>
                <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>

                <span class="n">db</span><span class="o">.</span><span class="n">save_selected_repo</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">repo_name</span><span class="p">)</span>

                <span class="c1"># הצג את התפריט המלא אחרי בחירת הריפו</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">github_menu_command</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;danger_delete_menu&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_danger_delete_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;delete_file_menu&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_delete_file_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;delete_repo_menu&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_delete_repo_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;confirm_delete_file&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">confirm_delete_file</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;confirm_delete_repo_step1&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">confirm_delete_repo_step1</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;confirm_delete_repo&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">confirm_delete_repo</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;download_file_menu&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_download_file_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;browse_open:&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;browse_open_i:&quot;</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_path_from_cb</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;browse_open&quot;</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># מצב מרובה ומחיקה בטוחה לאיפוס</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;multi_selection&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_repo_browser</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;browse_ref_menu&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_browse_ref_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;browse_refs_branches_page_&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_refs_branches_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_ref_tab&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;branches&quot;</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_browse_ref_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;browse_refs_tags_page_&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_refs_tags_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_ref_tab&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;tags&quot;</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_browse_ref_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;browse_select_ref:&quot;</span><span class="p">):</span>
            <span class="c1"># עדכון ref נוכחי והחזרה לדפדפן</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_ref&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_repo_browser</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;browse_search&quot;</span><span class="p">:</span>
            <span class="c1"># בקש מהמשתמש להזין מחרוזת חיפוש לשמות קבצים</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_search_mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;הקלד עכשיו את השם לחיפוש (למשל: README)&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                    <span class="s2">&quot;🔎 הזן/י מחרוזת לחיפוש בשם קובץ (לדוגמה: README או app.py)&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="k">raise</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;browse_search_page:&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">page</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_search_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_browse_search_results</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;browse_select_download:&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;browse_select_download_i:&quot;</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_path_from_cb</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;browse_select_download&quot;</span><span class="p">)</span>
            <span class="c1"># שמור על browse_action=download כדי שלא ייחשפו כפתורי מחיקה לאחר ההורדה</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;waiting_for_download_file_path&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="c1"># אל תאפס את browse_action; נשמור אותו כ-download</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;browse_action&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;download&quot;</span><span class="p">:</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;download&quot;</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;download&quot;</span>
            <span class="c1"># שמור את הנתיב האחרון כדי שהדפדפן יישאר באותו מיקום</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;browse_path&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">path</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="c1"># הורדה מיידית</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">repo_name</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ חסר טוקן או ריפו נבחר&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="c1"># אם הקובץ גדול מדי, שלח קישור להורדה במקום תוכן מלא</span>
            <span class="n">size</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">contents</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">size</span> <span class="ow">and</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">MAX_INLINE_FILE_BYTES</span><span class="p">:</span>
                <span class="n">download_url</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">contents</span><span class="p">,</span> <span class="s2">&quot;download_url&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">download_url</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;⚠️ הקובץ גדול (</span><span class="si">{</span><span class="n">format_bytes</span><span class="p">(</span><span class="n">size</span><span class="p">)</span><span class="si">}</span><span class="s1">). להורדה: &lt;a href=&quot;</span><span class="si">{</span><span class="n">download_url</span><span class="si">}</span><span class="s1">&quot;&gt;קישור ישיר&lt;/a&gt;&#39;</span><span class="p">,</span>
                        <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;⚠️ הקובץ גדול (</span><span class="si">{</span><span class="n">format_bytes</span><span class="p">(</span><span class="n">size</span><span class="p">)</span><span class="si">}</span><span class="s2">) ולא ניתן להורידו ישירות כרגע.&quot;</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">contents</span><span class="o">.</span><span class="n">decoded_content</span>
                <span class="n">base</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="s1">&#39;os&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">path</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">contents</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;downloaded_file&quot;</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_document</span><span class="p">(</span><span class="n">document</span><span class="o">=</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
            <span class="c1"># הישאר בדפדפן במצב הורדה בלבד, עדכן מקלדת בלי להחליף טקסט</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_repo_browser</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">only_keyboard</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;browse_select_view:&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;browse_select_view_i:&quot;</span><span class="p">):</span>
            <span class="c1"># מצב תצוגת קובץ חלקית עם &quot;הצג עוד&quot;</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_path_from_cb</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;browse_select_view&quot;</span><span class="p">)</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
            <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_name</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ חסרים נתונים (בחר ריפו עם /github)&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span>
            <span class="c1"># כבדוק ref נוכחי</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">current_ref</span> <span class="o">=</span> <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;browse_ref&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="s2">&quot;default_branch&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;main&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">current_ref</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="s2">&quot;default_branch&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;main&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">contents</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">current_ref</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">contents</span><span class="o">.</span><span class="n">decoded_content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">)</span>
                <span class="c1"># שמירת נתוני עזר: גודל ושפה מזוהה</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">detect_language_from_filename</span>
                    <span class="n">detected_lang</span> <span class="o">=</span> <span class="n">detect_language_from_filename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">detected_lang</span> <span class="o">=</span> <span class="s2">&quot;text&quot;</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;view_file_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">contents</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;view_detected_language&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">detected_lang</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה בטעינת קובץ: </span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="c1"># שימור טקסט בזיכרון קצר (user_data) + אינדקס עמוד</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;view_file_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;view_file_text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;view_page_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_render_file_view</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;view_more&quot;</span><span class="p">:</span>
            <span class="c1"># הצג עוד עמוד; נגן מפני None/מחרוזת</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">current_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;view_page_index&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">current_index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;view_page_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_index</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_render_file_view</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;view_back&quot;</span><span class="p">:</span>
            <span class="c1"># אם הגענו מתוצאות חיפוש – חזרה לעמוד החיפוש האחרון</span>
            <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;last_results_were_search&quot;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_browse_search_results</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="c1"># ננקה את הדגל רק אחרי שחזרנו למסך החיפוש</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;last_results_were_search&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># חזרה לעץ הריפו (שומר path)</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;view&quot;</span>
                <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;browse_page&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_repo_browser</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;browse_select_delete:&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;browse_select_delete_i:&quot;</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_path_from_cb</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;browse_select_delete&quot;</span><span class="p">)</span>
            <span class="c1"># דרוש אישור לפני מחיקה</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;pending_delete_file_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;✅ אישור מחיקה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;confirm_delete_file&quot;</span><span class="p">)],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)],</span>
            <span class="p">]</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="s2">&quot;האם אתה בטוח שברצונך למחוק את הקובץ הבא?</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="sa">f</span><span class="s2">&quot;&lt;code&gt;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;download_zip:&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;download_zip_i:&quot;</span><span class="p">):</span>
            <span class="c1"># הורדת התיקייה הנוכחית כקובץ ZIP</span>
            <span class="n">current_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_path_from_cb</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;download_zip&quot;</span><span class="p">)</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
            <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_name</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ חסרים נתונים&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span>
                    <span class="s2">&quot;מוריד תיקייה כ־ZIP, התהליך עשוי להימשך 1–2 דקות.&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span>
                <span class="c1"># Fast path: הורדת ZIP מלא של הריפו דרך zipball</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">current_path</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="kn">import</span> <span class="nn">zipfile</span> <span class="k">as</span> <span class="nn">_zip</span>
                        <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span> <span class="k">as</span> <span class="n">_dt</span><span class="p">,</span> <span class="n">timezone</span> <span class="k">as</span> <span class="n">_tz</span>
                        <span class="n">url</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_archive_link</span><span class="p">(</span><span class="s2">&quot;zipball&quot;</span><span class="p">)</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
                        <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
                        <span class="c1"># בנה ZIP חדש עם metadata.json משולב כדי לאפשר רישום בגיבויים</span>
                        <span class="n">src_buf</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
                        <span class="k">with</span> <span class="n">_zip</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">src_buf</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zin</span><span class="p">:</span>
                            <span class="c1"># ספר קבצים (דלג על תיקיות)</span>
                            <span class="n">file_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">zin</span><span class="o">.</span><span class="n">namelist</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)]</span>
                            <span class="n">file_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_names</span><span class="p">)</span>
                            <span class="n">total_bytes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
                            <span class="c1"># צור ZIP חדש עם metadata</span>
                            <span class="n">out_buf</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
                            <span class="k">with</span> <span class="n">_zip</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">out_buf</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="n">_zip</span><span class="o">.</span><span class="n">ZIP_DEFLATED</span><span class="p">)</span> <span class="k">as</span> <span class="n">zout</span><span class="p">:</span>
                                <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
                                    <span class="s2">&quot;backup_id&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;backup_</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">_dt</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">_tz</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
                                    <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="n">_dt</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">_tz</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                                    <span class="s2">&quot;backup_type&quot;</span><span class="p">:</span> <span class="s2">&quot;github_repo_zip&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;include_versions&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                    <span class="s2">&quot;file_count&quot;</span><span class="p">:</span> <span class="n">file_count</span><span class="p">,</span>
                                    <span class="s2">&quot;created_by&quot;</span><span class="p">:</span> <span class="s2">&quot;Code Keeper Bot&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;repo&quot;</span><span class="p">:</span> <span class="n">repo</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span>
                                    <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">current_path</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
                                <span class="p">}</span>
                                <span class="n">zout</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="s2">&quot;metadata.json&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
                                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">file_names</span><span class="p">:</span>
                                    <span class="n">zout</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">zin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
                            <span class="n">out_buf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                            <span class="c1"># שמור גיבוי (Mongo/FS בהתאם לקונפיג)</span>
                            <span class="n">backup_manager</span><span class="o">.</span><span class="n">save_backup_bytes</span><span class="p">(</span><span class="n">out_buf</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),</span> <span class="n">metadata</span><span class="p">)</span>
                            <span class="c1"># שלח למשתמש</span>
                            <span class="c1"># השתמש בשם ידידותי: BKP zip &lt;repo&gt; vN - DD/MM/YY</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">infos</span> <span class="o">=</span> <span class="n">backup_manager</span><span class="o">.</span><span class="n">list_backups</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                                <span class="n">vcount</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">infos</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s1">&#39;repo&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="n">repo</span><span class="o">.</span><span class="n">full_name</span><span class="p">])</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="n">vcount</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="n">date_str</span> <span class="o">=</span> <span class="n">_dt</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">_tz</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%m-%y %H.%M&#39;</span><span class="p">)</span>
                            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;BKP zip </span><span class="si">{</span><span class="n">repo</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> v</span><span class="si">{</span><span class="n">vcount</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">date_str</span><span class="si">}</span><span class="s2">.zip&quot;</span>
                            <span class="n">out_buf</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">filename</span>
                            <span class="n">caption</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;📦 ריפו מלא — </span><span class="si">{</span><span class="n">format_bytes</span><span class="p">(</span><span class="n">total_bytes</span><span class="p">)</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">💾 נשמר ברשימת הגיבויים.&quot;</span>
                            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_document</span><span class="p">(</span>
                                <span class="n">document</span><span class="o">=</span><span class="n">out_buf</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">caption</span><span class="o">=</span><span class="n">caption</span>
                            <span class="p">)</span>
                            <span class="c1"># הצג שורת סיכום בסגנון המבוקש ואז בקש תיוג</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">backup_id</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;backup_id&quot;</span><span class="p">)</span>
                                <span class="n">date_str</span> <span class="o">=</span> <span class="n">_dt</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">_tz</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/%m/%y %H:%M&#39;</span><span class="p">)</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="c1"># חשב גרסת גיבוי (מספר רצים לאותו ריפו)</span>
                                    <span class="n">infos</span> <span class="o">=</span> <span class="n">backup_manager</span><span class="o">.</span><span class="n">list_backups</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                                    <span class="n">vcount</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">infos</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s1">&#39;repo&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="n">repo</span><span class="o">.</span><span class="n">full_name</span><span class="p">])</span>
                                    <span class="n">v_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;(v</span><span class="si">{</span><span class="n">vcount</span><span class="si">}</span><span class="s2">) &quot;</span> <span class="k">if</span> <span class="n">vcount</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                    <span class="n">v_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                                <span class="n">summary_line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;⬇️ backup zip </span><span class="si">{</span><span class="n">repo</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> – </span><span class="si">{</span><span class="n">date_str</span><span class="si">}</span><span class="s2"> – </span><span class="si">{</span><span class="n">v_text</span><span class="si">}{</span><span class="n">format_bytes</span><span class="p">(</span><span class="n">total_bytes</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span> <span class="k">as</span> <span class="n">_db</span>
                                    <span class="n">existing_note</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">get_backup_note</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">backup_id</span><span class="p">))</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
                                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                    <span class="n">existing_note</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                                <span class="n">note_btn_text</span> <span class="o">=</span> <span class="s2">&quot;📝 ערוך הערה&quot;</span> <span class="k">if</span> <span class="n">existing_note</span> <span class="k">else</span> <span class="s2">&quot;📝 הוסף הערה&quot;</span>
                                <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🏆 מצוין&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;backup_rate:</span><span class="si">{</span><span class="n">backup_id</span><span class="si">}</span><span class="s2">:excellent&quot;</span><span class="p">)],</span>
                                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;👍 טוב&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;backup_rate:</span><span class="si">{</span><span class="n">backup_id</span><span class="si">}</span><span class="s2">:good&quot;</span><span class="p">)],</span>
                                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🤷 סביר&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;backup_rate:</span><span class="si">{</span><span class="n">backup_id</span><span class="si">}</span><span class="s2">:ok&quot;</span><span class="p">)],</span>
                                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">note_btn_text</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;backup_add_note:</span><span class="si">{</span><span class="n">backup_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)],</span>
                                <span class="p">]</span>
                                <span class="n">msg</span> <span class="o">=</span> <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">summary_line</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">s</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;backup_summaries&quot;</span><span class="p">,</span> <span class="p">{})</span>
                                    <span class="n">s</span><span class="p">[</span><span class="n">backup_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;chat_id&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&quot;message_id&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="o">.</span><span class="n">message_id</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">summary_line</span><span class="p">}</span>
                                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                    <span class="k">pass</span>
                                <span class="c1"># Rating buttons already attached above; no need to call external handler</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="k">pass</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error fetching repo zipball: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">emit_event</span><span class="p">(</span>
                                <span class="s2">&quot;github_zipball_fetch_error&quot;</span><span class="p">,</span>
                                <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span>
                                <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                                <span class="n">repo</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="s2">&quot;full_name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)),</span>
                            <span class="p">)</span>
                            <span class="k">if</span> <span class="n">errors_total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">errors_total</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="s2">&quot;github_zipball_fetch_error&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה בהורדת ZIP של הריפו: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br</span><span class="p">:</span>
                            <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                                <span class="k">raise</span>
                    <span class="c1"># לאחר יצירת והורדת ה‑ZIP, הצג את רשימת הגיבויים עבור הריפו הנוכחי</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">backup_handler</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">bot_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;backup_handler&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">backup_handler</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="kn">from</span> <span class="nn">backup_menu_handler</span> <span class="kn">import</span> <span class="n">BackupMenuHandler</span>
                            <span class="n">backup_handler</span> <span class="o">=</span> <span class="n">BackupMenuHandler</span><span class="p">()</span>
                            <span class="n">context</span><span class="o">.</span><span class="n">bot_data</span><span class="p">[</span><span class="s1">&#39;backup_handler&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">backup_handler</span>
                        <span class="c1"># הגדר הקשר חזרה לסאב־תפריט GitHub וגבילת הרשימה לריפו הנוכחי</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;zip_back_to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;github&#39;</span>
                            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;github_backup_context_repo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">full_name</span>
                            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;backup_highlight_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;backup_id&#39;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="k">await</span> <span class="n">backup_handler</span><span class="o">.</span><span class="n">_show_backups_list</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">br</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_github_backup_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
                        <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br2</span><span class="p">:</span>
                            <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br2</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                                <span class="k">raise</span>
                    <span class="k">return</span>

                <span class="n">zip_buffer</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
                <span class="n">total_bytes</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">total_files</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">skipped_large</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">zip_buffer</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="n">zipfile</span><span class="o">.</span><span class="n">ZIP_DEFLATED</span><span class="p">)</span> <span class="k">as</span> <span class="n">zipf</span><span class="p">:</span>
                    <span class="c1"># קבע שם תיקיית השורש בתוך ה-ZIP</span>
                    <span class="n">zip_root</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">current_path</span> <span class="k">else</span> <span class="n">current_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                    <span class="k">async</span> <span class="k">def</span> <span class="nf">add_path_to_zip</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">rel_prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="c1"># קבל את התוכן עבור הנתיב</span>
                        <span class="n">contents</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="n">path</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">contents</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="n">contents</span> <span class="o">=</span> <span class="p">[</span><span class="n">contents</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">contents</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;dir&quot;</span><span class="p">:</span>
                                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_rate_limit_delay</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                                <span class="k">await</span> <span class="n">add_path_to_zip</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rel_prefix</span><span class="si">}{</span><span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/&quot;</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="n">item</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;file&quot;</span><span class="p">:</span>
                                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_rate_limit_delay</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                                <span class="n">file_obj</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
                                <span class="n">file_size</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">file_obj</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span>
                                <span class="k">nonlocal</span> <span class="n">total_bytes</span><span class="p">,</span> <span class="n">total_files</span><span class="p">,</span> <span class="n">skipped_large</span>
                                <span class="k">if</span> <span class="n">file_size</span> <span class="o">&gt;</span> <span class="n">MAX_INLINE_FILE_BYTES</span><span class="p">:</span>
                                    <span class="n">skipped_large</span> <span class="o">+=</span> <span class="mi">1</span>
                                    <span class="k">continue</span>
                                <span class="k">if</span> <span class="n">total_files</span> <span class="o">&gt;=</span> <span class="n">MAX_ZIP_FILES</span><span class="p">:</span>
                                    <span class="k">continue</span>
                                <span class="k">if</span> <span class="n">total_bytes</span> <span class="o">+</span> <span class="n">file_size</span> <span class="o">&gt;</span> <span class="n">MAX_ZIP_TOTAL_BYTES</span><span class="p">:</span>
                                    <span class="k">continue</span>
                                <span class="n">data</span> <span class="o">=</span> <span class="n">file_obj</span><span class="o">.</span><span class="n">decoded_content</span>
                                <span class="n">arcname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">zip_root</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">rel_prefix</span><span class="si">}{</span><span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="n">zipf</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="n">arcname</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                                <span class="n">total_bytes</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                                <span class="n">total_files</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="k">await</span> <span class="n">add_path_to_zip</span><span class="p">(</span><span class="n">current_path</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="c1"># הוסף metadata.json</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;backup_id&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;backup_</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
                    <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                    <span class="s2">&quot;backup_type&quot;</span><span class="p">:</span> <span class="s2">&quot;github_repo_zip&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;include_versions&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;file_count&quot;</span><span class="p">:</span> <span class="n">total_files</span><span class="p">,</span>
                    <span class="s2">&quot;created_by&quot;</span><span class="p">:</span> <span class="s2">&quot;Code Keeper Bot&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;repo&quot;</span><span class="p">:</span> <span class="n">repo</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span>
                    <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">current_path</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
                <span class="p">}</span>
                <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">zip_buffer</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="n">zipfile</span><span class="o">.</span><span class="n">ZIP_DEFLATED</span><span class="p">)</span> <span class="k">as</span> <span class="n">zipf</span><span class="p">:</span>
                    <span class="n">zipf</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="s2">&quot;metadata.json&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

                <span class="n">zip_buffer</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="c1"># שם ידידותי ל-folder/repo</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">infos</span> <span class="o">=</span> <span class="n">backup_manager</span><span class="o">.</span><span class="n">list_backups</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                    <span class="n">vcount</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">infos</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s1">&#39;repo&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="n">repo</span><span class="o">.</span><span class="n">full_name</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">vcount</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">date_str</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%m-%y %H.%M&#39;</span><span class="p">)</span>
                <span class="n">name_part</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">current_path</span> <span class="k">else</span> <span class="n">current_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;BKP zip </span><span class="si">{</span><span class="n">name_part</span><span class="si">}</span><span class="s2"> v</span><span class="si">{</span><span class="n">vcount</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">date_str</span><span class="si">}</span><span class="s2">.zip&quot;</span>
                <span class="n">zip_buffer</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">filename</span>
                <span class="n">caption</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;📦 קובץ ZIP לתיקייה: /</span><span class="si">{</span><span class="n">current_path</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;מכיל </span><span class="si">{</span><span class="n">total_files</span><span class="si">}</span><span class="s2"> קבצים, </span><span class="si">{</span><span class="n">format_bytes</span><span class="p">(</span><span class="n">total_bytes</span><span class="p">)</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;💾 נשמר ברשימת הגיבויים.&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">skipped_large</span><span class="p">:</span>
                    <span class="n">caption</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">⚠️ דילג על </span><span class="si">{</span><span class="n">skipped_large</span><span class="si">}</span><span class="s2"> קבצים גדולים (&gt; </span><span class="si">{</span><span class="n">format_bytes</span><span class="p">(</span><span class="n">MAX_INLINE_FILE_BYTES</span><span class="p">)</span><span class="si">}</span><span class="s2">).&quot;</span>
                <span class="c1"># שמור גיבוי (Mongo/FS בהתאם לקונפיג)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">backup_manager</span><span class="o">.</span><span class="n">save_backup_bytes</span><span class="p">(</span><span class="n">zip_buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),</span> <span class="n">metadata</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to persist GitHub ZIP: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">emit_event</span><span class="p">(</span>
                            <span class="s2">&quot;github_zip_persist_error&quot;</span><span class="p">,</span>
                            <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;warn&quot;</span><span class="p">,</span>
                            <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                            <span class="n">repo</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="s2">&quot;full_name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)),</span>
                        <span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_document</span><span class="p">(</span>
                    <span class="n">document</span><span class="o">=</span><span class="n">zip_buffer</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">caption</span><span class="o">=</span><span class="n">caption</span>
                <span class="p">)</span>
                <span class="c1"># הצג שורת סיכום בסגנון המבוקש ואז בקש תיוג</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">backup_id</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;backup_id&quot;</span><span class="p">)</span>
                    <span class="n">date_str</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/%m/%y %H:%M&#39;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">infos</span> <span class="o">=</span> <span class="n">backup_manager</span><span class="o">.</span><span class="n">list_backups</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                        <span class="n">vcount</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">infos</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s1">&#39;repo&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="n">repo</span><span class="o">.</span><span class="n">full_name</span><span class="p">])</span>
                        <span class="n">v_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;(v</span><span class="si">{</span><span class="n">vcount</span><span class="si">}</span><span class="s2">) &quot;</span> <span class="k">if</span> <span class="n">vcount</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">v_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="n">summary_line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;⬇️ backup zip </span><span class="si">{</span><span class="n">repo</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> – </span><span class="si">{</span><span class="n">date_str</span><span class="si">}</span><span class="s2"> – </span><span class="si">{</span><span class="n">v_text</span><span class="si">}{</span><span class="n">format_bytes</span><span class="p">(</span><span class="n">total_bytes</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span> <span class="k">as</span> <span class="n">_db</span>
                        <span class="n">existing_note</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">get_backup_note</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">backup_id</span><span class="p">))</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">existing_note</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="n">note_btn_text</span> <span class="o">=</span> <span class="s2">&quot;📝 ערוך הערה&quot;</span> <span class="k">if</span> <span class="n">existing_note</span> <span class="k">else</span> <span class="s2">&quot;📝 הוסף הערה&quot;</span>
                    <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🏆 מצוין&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;backup_rate:</span><span class="si">{</span><span class="n">backup_id</span><span class="si">}</span><span class="s2">:excellent&quot;</span><span class="p">)],</span>
                        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;👍 טוב&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;backup_rate:</span><span class="si">{</span><span class="n">backup_id</span><span class="si">}</span><span class="s2">:good&quot;</span><span class="p">)],</span>
                        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🤷 סביר&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;backup_rate:</span><span class="si">{</span><span class="n">backup_id</span><span class="si">}</span><span class="s2">:ok&quot;</span><span class="p">)],</span>
                        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">note_btn_text</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;backup_add_note:</span><span class="si">{</span><span class="n">backup_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)],</span>
                    <span class="p">]</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">summary_line</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;backup_summaries&quot;</span><span class="p">,</span> <span class="p">{})</span>
                        <span class="n">s</span><span class="p">[</span><span class="n">backup_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;chat_id&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&quot;message_id&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="o">.</span><span class="n">message_id</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">summary_line</span><span class="p">}</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="c1"># Rating buttons already attached above; no need to call external handler</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating ZIP: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">emit_event</span><span class="p">(</span>
                        <span class="s2">&quot;github_zip_create_error&quot;</span><span class="p">,</span>
                        <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span>
                        <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                        <span class="n">repo</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="s2">&quot;full_name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)),</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">errors_total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">errors_total</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="s2">&quot;github_zip_create_error&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה בהכנת ZIP: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                        <span class="k">raise</span>
                <span class="k">return</span>
            <span class="c1"># החזר לדפדפן באותו מקום</span>
            <span class="c1"># לאחר יצירת והורדת ה‑ZIP, הצג את רשימת הגיבויים עבור הריפו הנוכחי</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">backup_handler</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">bot_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;backup_handler&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">backup_handler</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="kn">from</span> <span class="nn">backup_menu_handler</span> <span class="kn">import</span> <span class="n">BackupMenuHandler</span>
                    <span class="n">backup_handler</span> <span class="o">=</span> <span class="n">BackupMenuHandler</span><span class="p">()</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">bot_data</span><span class="p">[</span><span class="s1">&#39;backup_handler&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">backup_handler</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;zip_back_to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;github&#39;</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;github_backup_context_repo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">full_name</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;backup_highlight_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;backup_id&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">await</span> <span class="n">backup_handler</span><span class="o">.</span><span class="n">_show_backups_list</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">br</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_repo_browser</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br2</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br2</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                        <span class="k">raise</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;inline_download_file:&quot;</span><span class="p">):</span>
            <span class="c1"># הורדת קובץ שנבחר דרך אינליין</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
            <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_name</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ חסרים נתונים (בחר ריפו עם /github)&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="c1"># במצב Inline אין query.message ולכן reply_* יקרוס. נערוך את ההודעה המקורית</span>
            <span class="c1"># להודעת &quot;+ מתחיל בהורדה&quot; ונשלח את הקובץ בפרטי למשתמש.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">TelegramUtils</span><span class="o">.</span><span class="n">safe_edit_message_text</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s2">&quot;⬇️ מתחיל בהורדה…&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>

                <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span>
                <span class="n">contents</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="n">size</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">contents</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span>

                <span class="c1"># פונקציות שליחה בהתאם לסוג ההודעה</span>
                <span class="k">async</span> <span class="k">def</span> <span class="nf">_send_text</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">parse_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">parse_mode</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">context</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">chat_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">parse_mode</span><span class="p">)</span>

                <span class="k">async</span> <span class="k">def</span> <span class="nf">_send_document</span><span class="p">(</span><span class="n">buf</span><span class="p">:</span> <span class="n">BytesIO</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">caption</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_document</span><span class="p">(</span><span class="n">document</span><span class="o">=</span><span class="n">buf</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">caption</span><span class="o">=</span><span class="n">caption</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">context</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">send_document</span><span class="p">(</span><span class="n">chat_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">document</span><span class="o">=</span><span class="n">buf</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">caption</span><span class="o">=</span><span class="n">caption</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">size</span> <span class="ow">and</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">MAX_INLINE_FILE_BYTES</span><span class="p">:</span>
                    <span class="n">download_url</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">contents</span><span class="p">,</span> <span class="s2">&quot;download_url&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">download_url</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">_send_text</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s1">&#39;⚠️ הקובץ גדול (</span><span class="si">{</span><span class="n">format_bytes</span><span class="p">(</span><span class="n">size</span><span class="p">)</span><span class="si">}</span><span class="s1">). להורדה: &lt;a href=&quot;</span><span class="si">{</span><span class="n">download_url</span><span class="si">}</span><span class="s1">&quot;&gt;קישור ישיר&lt;/a&gt;&#39;</span><span class="p">,</span>
                            <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">_send_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ הקובץ גדול (</span><span class="si">{</span><span class="n">format_bytes</span><span class="p">(</span><span class="n">size</span><span class="p">)</span><span class="si">}</span><span class="s2">) ולא ניתן להורידו ישירות כרגע.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">contents</span><span class="o">.</span><span class="n">decoded_content</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">contents</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;downloaded_file&quot;</span>
                    <span class="k">await</span> <span class="n">_send_document</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">filename</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inline download error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">emit_event</span><span class="p">(</span>
                        <span class="s2">&quot;github_inline_download_error&quot;</span><span class="p">,</span>
                        <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span>
                        <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                        <span class="n">repo</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="s2">&quot;full_name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)),</span>
                        <span class="n">path</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">errors_total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">errors_total</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="s2">&quot;github_inline_download_error&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה בהורדה: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">context</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">chat_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה בהורדה: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">return</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;browse_page:&quot;</span><span class="p">):</span>
            <span class="c1"># מעבר עמודים בדפדפן הריפו</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">page_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">page_index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">page_index</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_repo_browser</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">only_keyboard</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;multi_toggle&quot;</span><span class="p">:</span>
            <span class="c1"># הפעל/בטל מצב בחירה מרובה</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;multi_mode&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;multi_mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">current</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;multi_mode&quot;</span><span class="p">]:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;multi_selection&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;מצב בחירה מרובה בוטל&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;מצב בחירה מרובה הופעל — סמן קבצים מהרשימה&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_repo_browser</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">only_keyboard</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;browse_toggle_select:&quot;</span><span class="p">):</span>
            <span class="c1"># הוסף/הסר בחירה של קובץ</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">selection</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;multi_selection&quot;</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="k">if</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">:</span>
                <span class="n">selection</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">selection</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;multi_selection&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_repo_browser</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">only_keyboard</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;multi_clear&quot;</span><span class="p">:</span>
            <span class="c1"># נקה בחירות</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;multi_selection&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_repo_browser</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">only_keyboard</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;safe_toggle&quot;</span><span class="p">:</span>
            <span class="c1"># החלף מצב מחיקה בטוחה</span>
            <span class="n">new_state</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;safe_delete&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;safe_delete&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_state</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;מחיקה בטוחה &quot;</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;פעילה (PR)&quot;</span> <span class="k">if</span> <span class="n">new_state</span> <span class="k">else</span> <span class="s2">&quot;כבויה — מוחק ישירות&quot;</span><span class="p">),</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_repo_browser</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">only_keyboard</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;multi_execute&quot;</span><span class="p">:</span>
            <span class="c1"># בצע פעולה על הבחירה (ZIP בהורדה | מחיקה במצב מחיקה)</span>
            <span class="n">selection</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;multi_selection&quot;</span><span class="p">,</span> <span class="p">[])))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">selection</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;לא נבחרו קבצים&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
            <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_name</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ חסרים נתונים&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;browse_action&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;download&quot;</span><span class="p">:</span>
                <span class="c1"># ארוז את הבחירה ל-ZIP</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">zip_buffer</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
                    <span class="n">total_bytes</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">total_files</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">skipped_large</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">zip_buffer</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="n">zipfile</span><span class="o">.</span><span class="n">ZIP_DEFLATED</span><span class="p">)</span> <span class="k">as</span> <span class="n">zipf</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">:</span>
                            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_rate_limit_delay</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">file_obj</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">file_obj</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;file&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;file&quot;</span><span class="p">:</span>
                                    <span class="k">continue</span>
                                <span class="n">file_size</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">file_obj</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span>
                                <span class="k">if</span> <span class="n">file_size</span> <span class="o">&gt;</span> <span class="n">MAX_INLINE_FILE_BYTES</span><span class="p">:</span>
                                    <span class="n">skipped_large</span> <span class="o">+=</span> <span class="mi">1</span>
                                    <span class="k">continue</span>
                                <span class="k">if</span> <span class="n">total_files</span> <span class="o">&gt;=</span> <span class="n">MAX_ZIP_FILES</span><span class="p">:</span>
                                    <span class="k">continue</span>
                                <span class="k">if</span> <span class="n">total_bytes</span> <span class="o">+</span> <span class="n">file_size</span> <span class="o">&gt;</span> <span class="n">MAX_ZIP_TOTAL_BYTES</span><span class="p">:</span>
                                    <span class="k">continue</span>
                                <span class="n">data</span> <span class="o">=</span> <span class="n">file_obj</span><span class="o">.</span><span class="n">decoded_content</span>
                                <span class="n">arcname</span> <span class="o">=</span> <span class="n">file_obj</span><span class="o">.</span><span class="n">path</span>  <span class="c1"># שמור מבנה נתיב</span>
                                <span class="n">zipf</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="n">arcname</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                                <span class="n">total_bytes</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                                <span class="n">total_files</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">total_files</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;אין קבצים מתאימים לאריזה&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">zip_buffer</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">repo</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">-selected.zip&quot;</span>
                        <span class="n">caption</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;📦 ZIP לקבצים נבחרים — </span><span class="si">{</span><span class="n">total_files</span><span class="si">}</span><span class="s2"> קבצים, </span><span class="si">{</span><span class="n">format_bytes</span><span class="p">(</span><span class="n">total_bytes</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
                        <span class="k">if</span> <span class="n">skipped_large</span><span class="p">:</span>
                            <span class="n">caption</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">⚠️ דילג על </span><span class="si">{</span><span class="n">skipped_large</span><span class="si">}</span><span class="s2"> קבצים גדולים (&gt; </span><span class="si">{</span><span class="n">format_bytes</span><span class="p">(</span><span class="n">MAX_INLINE_FILE_BYTES</span><span class="p">)</span><span class="si">}</span><span class="s2">).&quot;</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_document</span><span class="p">(</span>
                            <span class="n">document</span><span class="o">=</span><span class="n">zip_buffer</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">caption</span><span class="o">=</span><span class="n">caption</span>
                        <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Multi ZIP error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">emit_event</span><span class="p">(</span>
                            <span class="s2">&quot;github_multi_zip_error&quot;</span><span class="p">,</span>
                            <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span>
                            <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                            <span class="n">repo</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="s2">&quot;full_name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)),</span>
                            <span class="n">selected_count</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">set</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="k">else</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">errors_total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">errors_total</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="s2">&quot;github_multi_zip_error&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה באריזת ZIP: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="c1"># לאחר פעולה, שמור בדפדפן</span>
                    <span class="k">pass</span>
                <span class="c1"># השאר בדפדפן</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_repo_browser</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># מחיקה של נבחרים</span>
                <span class="n">safe_delete</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;safe_delete&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="n">default_branch</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">default_branch</span> <span class="ow">or</span> <span class="s2">&quot;main&quot;</span>
                <span class="n">successes</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">failures</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">pr_url</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">safe_delete</span><span class="p">:</span>
                    <span class="c1"># צור סניף חדש ומחוק בו, ואז פתח PR</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">base_ref</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_git_ref</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;heads/</span><span class="si">{</span><span class="n">default_branch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">new_branch</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;delete-bot-</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">repo</span><span class="o">.</span><span class="n">create_git_ref</span><span class="p">(</span><span class="n">ref</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;refs/heads/</span><span class="si">{</span><span class="n">new_branch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sha</span><span class="o">=</span><span class="n">base_ref</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">sha</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">:</span>
                            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_rate_limit_delay</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">contents</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">new_branch</span><span class="p">)</span>
                                <span class="n">repo</span><span class="o">.</span><span class="n">delete_file</span><span class="p">(</span>
                                    <span class="n">contents</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                                    <span class="sa">f</span><span class="s2">&quot;Delete via bot: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                    <span class="n">contents</span><span class="o">.</span><span class="n">sha</span><span class="p">,</span>
                                    <span class="n">branch</span><span class="o">=</span><span class="n">new_branch</span><span class="p">,</span>
                                <span class="p">)</span>
                                <span class="n">successes</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">pr</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">create_pull</span><span class="p">(</span>
                            <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Delete </span><span class="si">{</span><span class="n">successes</span><span class="si">}</span><span class="s2"> files via bot&quot;</span><span class="p">,</span>
                            <span class="n">body</span><span class="o">=</span><span class="s2">&quot;Automated deletion&quot;</span><span class="p">,</span>
                            <span class="n">base</span><span class="o">=</span><span class="n">default_branch</span><span class="p">,</span>
                            <span class="n">head</span><span class="o">=</span><span class="n">new_branch</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">pr_url</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">html_url</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Safe delete failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">emit_event</span><span class="p">(</span>
                                <span class="s2">&quot;github_safe_delete_error&quot;</span><span class="p">,</span>
                                <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span>
                                <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                                <span class="n">repo</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="s2">&quot;full_name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)),</span>
                                <span class="n">branch</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">default_branch</span><span class="p">),</span>
                            <span class="p">)</span>
                            <span class="k">if</span> <span class="n">errors_total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">errors_total</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="s2">&quot;github_safe_delete_error&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה במחיקה בטוחה: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">return</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># מחיקה ישירה בבראנץ&#39; ברירת המחדל</span>
                    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">:</span>
                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_rate_limit_delay</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">contents</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                            <span class="n">repo</span><span class="o">.</span><span class="n">delete_file</span><span class="p">(</span>
                                <span class="n">contents</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                                <span class="sa">f</span><span class="s2">&quot;Delete via bot: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                <span class="n">contents</span><span class="o">.</span><span class="n">sha</span><span class="p">,</span>
                                <span class="n">branch</span><span class="o">=</span><span class="n">default_branch</span><span class="p">,</span>
                            <span class="p">)</span>
                            <span class="n">successes</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Delete file failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">emit_event</span><span class="p">(</span>
                                    <span class="s2">&quot;github_delete_file_error&quot;</span><span class="p">,</span>
                                    <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span>
                                    <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                                    <span class="n">repo</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="s2">&quot;full_name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)),</span>
                                    <span class="n">path</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">),</span>
                                <span class="p">)</span>
                                <span class="k">if</span> <span class="n">errors_total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">errors_total</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="s2">&quot;github_delete_file_error&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="k">pass</span>
                            <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c1"># סכם והצג</span>
                <span class="n">summary</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;✅ נמחקו </span><span class="si">{</span><span class="n">successes</span><span class="si">}</span><span class="s2"> | ❌ נכשלו </span><span class="si">{</span><span class="n">failures</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">pr_url</span><span class="p">:</span>
                    <span class="n">summary</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">🔗 נפתח PR: &lt;a href=&quot;</span><span class="si">{</span><span class="n">pr_url</span><span class="si">}</span><span class="s1">&quot;&gt;קישור&lt;/a&gt;&#39;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="c1"># אפס מצב מרובה וחזור לתפריט הדפדפן</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;multi_mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;multi_selection&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_repo_browser</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;share_folder_link:&quot;</span><span class="p">):</span>
            <span class="c1"># שיתוף קישור לתיקייה</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
            <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_name</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;❌ חסרים נתונים&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span>
            <span class="n">branch</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">default_branch</span> <span class="ow">or</span> <span class="s2">&quot;main&quot;</span>
            <span class="n">clean_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">path</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">url</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;https://github.com/</span><span class="si">{</span><span class="n">repo</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">/tree/</span><span class="si">{</span><span class="n">branch</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">clean_path</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">clean_path</span>
                <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;https://github.com/</span><span class="si">{</span><span class="n">repo</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">/tree/</span><span class="si">{</span><span class="n">branch</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🔗 קישור לתיקייה:</span><span class="se">\n</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;הקישור נשלח בהודעה חדשה&quot;</span><span class="p">)</span>
            <span class="c1"># הישאר בדפדפן</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_repo_browser</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;share_selected_links&quot;</span><span class="p">:</span>
            <span class="c1"># שיתוף קישורים לקבצים נבחרים</span>
            <span class="n">selection</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;multi_selection&quot;</span><span class="p">,</span> <span class="p">[])))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">selection</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;לא נבחרו קבצים&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
            <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_name</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;❌ חסרים נתונים&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span>
            <span class="n">branch</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">default_branch</span> <span class="ow">or</span> <span class="s2">&quot;main&quot;</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">[:</span><span class="mi">50</span><span class="p">]:</span>
                <span class="c1"># guard: ensure string before strip</span>
                <span class="n">clean</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
                <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://github.com/</span><span class="si">{</span><span class="n">repo</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">/blob/</span><span class="si">{</span><span class="n">branch</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">clean</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;• </span><span class="si">{</span><span class="n">clean</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;🔗 קישורים לקבצים נבחרים:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;share_selected_links error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">emit_event</span><span class="p">(</span>
                        <span class="s2">&quot;github_share_selected_links_error&quot;</span><span class="p">,</span>
                        <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span>
                        <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                        <span class="n">repo</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="s2">&quot;full_name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)),</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">errors_total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">errors_total</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="s2">&quot;github_share_selected_links_error&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;שגיאה בשיתוף קישורים&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># השאר בדפדפן</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_repo_browser</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;share_selected_links_single:&quot;</span><span class="p">):</span>
            <span class="c1"># שיתוף קישור לקובץ יחיד מתצוגה רגילה</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
            <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_name</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;❌ חסרים נתונים&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span>
            <span class="n">branch</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">default_branch</span> <span class="ow">or</span> <span class="s2">&quot;main&quot;</span>
            <span class="n">clean</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://github.com/</span><span class="si">{</span><span class="n">repo</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">/blob/</span><span class="si">{</span><span class="n">branch</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">clean</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🔗 קישור לקובץ:</span><span class="se">\n</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;share_single_link error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">emit_event</span><span class="p">(</span>
                        <span class="s2">&quot;github_share_single_link_error&quot;</span><span class="p">,</span>
                        <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span>
                        <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                        <span class="n">repo</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="s2">&quot;full_name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)),</span>
                        <span class="n">path</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">errors_total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">errors_total</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="s2">&quot;github_share_single_link_error&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;שגיאה בשיתוף קישור&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_repo_browser</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">only_keyboard</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;notifications_menu&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_notifications_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;notifications_toggle&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">toggle_notifications</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;notifications_toggle_pr&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">toggle_notifications_pr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;notifications_toggle_issues&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">toggle_notifications_issues</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;notifications_interval_&quot;</span><span class="p">):</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_notifications_interval</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;notifications_check_now&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">notifications_check_now</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;pr_menu&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_pr_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;create_pr_menu&quot;</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;pr_branches_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_create_pr_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;branches_page_&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;pr_branches_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_create_pr_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;pr_select_head:&quot;</span><span class="p">):</span>
            <span class="n">head</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;pr_head&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">head</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_confirm_create_pr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;confirm_create_pr&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">confirm_create_pr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;merge_pr_menu&quot;</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;pr_list_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_merge_pr_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;prs_page_&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;pr_list_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_merge_pr_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;merge_pr:&quot;</span><span class="p">):</span>
            <span class="n">pr_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;pr_to_merge&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pr_number</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_confirm_merge_pr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;refresh_merge_pr&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_confirm_merge_pr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;confirm_merge_pr&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">confirm_merge_pr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;validate_repo&quot;</span><span class="p">:</span>
            <span class="n">status_message</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">done_event</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
            <span class="n">progress_task</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">status_message</span> <span class="o">=</span> <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;⏳ בודק תקינות הריפו... 0%&quot;</span><span class="p">)</span>

                <span class="k">async</span> <span class="k">def</span> <span class="nf">_progress_updater</span><span class="p">():</span>
                    <span class="n">percent</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">while</span> <span class="ow">not</span> <span class="n">done_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                            <span class="n">percent</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">percent</span> <span class="o">+</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">90</span><span class="p">)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">await</span> <span class="n">status_message</span><span class="o">.</span><span class="n">edit_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⏳ בודק תקינות הריפו... </span><span class="si">{</span><span class="n">percent</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="k">pass</span>
                            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>

                <span class="n">progress_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">_progress_updater</span><span class="p">())</span>
                <span class="kn">import</span> <span class="nn">tempfile</span><span class="o">,</span> <span class="nn">zipfile</span>
                <span class="n">token_opt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">login_or_token</span><span class="o">=</span><span class="p">(</span><span class="n">token_opt</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
                <span class="n">repo_full</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">repo_full</span><span class="p">:</span>
                    <span class="n">done_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">progress_task</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">await</span> <span class="n">progress_task</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                    <span class="k">await</span> <span class="p">(</span><span class="n">status_message</span><span class="o">.</span><span class="n">edit_text</span><span class="p">(</span><span class="s2">&quot;❌ קודם בחר ריפו!&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">status_message</span> <span class="k">else</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ קודם בחר ריפו!&quot;</span><span class="p">))</span>
                    <span class="k">return</span>

                <span class="k">def</span> <span class="nf">do_validate</span><span class="p">():</span>
                    <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_full</span><span class="p">)</span>
                    <span class="n">url</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_archive_link</span><span class="p">(</span><span class="s2">&quot;zipball&quot;</span><span class="p">)</span>
                    <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;repo_val_&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tmp</span><span class="p">:</span>
                        <span class="n">zip_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="s2">&quot;repo.zip&quot;</span><span class="p">)</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
                        <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">zip_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
                        <span class="n">extract_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="s2">&quot;repo&quot;</span><span class="p">)</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">extract_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">zip_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zf</span><span class="p">:</span>
                            <span class="n">zf</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">extract_dir</span><span class="p">)</span>
                        <span class="c1"># GitHub zip יוצר תיקיית-שורש יחידה</span>
                        <span class="n">entries</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">extract_dir</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">extract_dir</span><span class="p">)]</span>
                        <span class="n">root</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">entries</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">p</span><span class="p">)),</span> <span class="n">extract_dir</span><span class="p">)</span>
                        <span class="c1"># העתק קבצי קונפיג אם יש</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;.flake8&quot;</span><span class="p">,</span> <span class="s2">&quot;pyproject.toml&quot;</span><span class="p">,</span> <span class="s2">&quot;mypy.ini&quot;</span><span class="p">,</span> <span class="s2">&quot;bandit.yaml&quot;</span><span class="p">):</span>
                                <span class="n">src</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">name</span><span class="p">)</span>
                                <span class="n">dst</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span>
                                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">d</span><span class="p">:</span>
                                        <span class="n">d</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="c1"># הרצת כלים על כל הריפו</span>
                        <span class="k">def</span> <span class="nf">_run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">):</span>
                            <span class="kn">import</span> <span class="nn">subprocess</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">cp</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">root</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
                                <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">stdout</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">stderr</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                                <span class="k">return</span> <span class="n">cp</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">out</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">TimeoutExpired</span><span class="p">:</span>
                                <span class="k">return</span> <span class="mi">124</span><span class="p">,</span> <span class="s2">&quot;Timeout&quot;</span>
                            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                                <span class="k">return</span> <span class="mi">127</span><span class="p">,</span> <span class="s2">&quot;Tool not installed&quot;</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="k">return</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                        
                        <span class="c1"># העדפת כלים מה-venv המקומי אם קיים</span>
                        <span class="n">venv_bin</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s2">&quot;.venv&quot;</span><span class="p">,</span> <span class="s2">&quot;bin&quot;</span><span class="p">)</span>
                        <span class="n">venv_python</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">venv_bin</span><span class="p">,</span> <span class="s2">&quot;python&quot;</span><span class="p">)</span>
                        
                        <span class="k">def</span> <span class="nf">_resolve_tool_candidates</span><span class="p">(</span><span class="n">tool_name</span><span class="p">):</span>
                            <span class="n">candidates</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">venv_bin</span><span class="p">):</span>
                                <span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">venv_bin</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">venv_python</span><span class="p">):</span>
                                <span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">venv_python</span><span class="p">,</span> <span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">])</span>
                            <span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tool_name</span><span class="p">)</span>
                            <span class="k">return</span> <span class="n">candidates</span>

                        <span class="k">def</span> <span class="nf">_run_any</span><span class="p">(</span><span class="n">tool_name</span><span class="p">,</span> <span class="n">base_args</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">):</span>
                            <span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">_resolve_tool_candidates</span><span class="p">(</span><span class="n">tool_name</span><span class="p">):</span>
                                <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="n">candidate</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">candidate</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">candidate</span><span class="p">])</span> <span class="o">+</span> <span class="n">base_args</span>
                                <span class="n">rc</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">_run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
                                <span class="c1"># אם הכלי לא נמצא, נסה מועמד הבא</span>
                                <span class="k">if</span> <span class="n">rc</span> <span class="o">==</span> <span class="mi">127</span><span class="p">:</span>
                                    <span class="k">continue</span>
                                <span class="k">return</span> <span class="n">rc</span><span class="p">,</span> <span class="n">out</span>
                            <span class="k">return</span> <span class="mi">127</span><span class="p">,</span> <span class="s2">&quot;Tool not installed&quot;</span>
                        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;flake8&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_run_any</span><span class="p">(</span><span class="s2">&quot;flake8&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;.&quot;</span><span class="p">])</span>
                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;mypy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_run_any</span><span class="p">(</span><span class="s2">&quot;mypy&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;.&quot;</span><span class="p">])</span>
                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;bandit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_run_any</span><span class="p">(</span><span class="s2">&quot;bandit&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="s2">&quot;-r&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">])</span> 
                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;black&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_run_any</span><span class="p">(</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;--check&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">])</span> 
                        <span class="k">return</span> <span class="n">results</span><span class="p">,</span> <span class="n">repo_full</span>

                <span class="c1"># הריץ ברקע כדי לא לחסום את לולאת האירועים</span>
                <span class="n">results</span><span class="p">,</span> <span class="n">repo_name_for_msg</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">to_thread</span><span class="p">(</span><span class="n">do_validate</span><span class="p">)</span>
                <span class="n">done_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">progress_task</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">progress_task</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>

                <span class="c1"># פורמט תוצאות מעוצב</span>
                <span class="k">def</span> <span class="nf">status_label</span><span class="p">(</span><span class="n">rc</span><span class="p">):</span>
                    <span class="k">return</span> <span class="s2">&quot;OK&quot;</span> <span class="k">if</span> <span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;MISSING&quot;</span> <span class="k">if</span> <span class="n">rc</span> <span class="o">==</span> <span class="mi">127</span> <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;TIMEOUT&quot;</span> <span class="k">if</span> <span class="n">rc</span> <span class="o">==</span> <span class="mi">124</span> <span class="k">else</span> <span class="s2">&quot;FAIL&quot;</span><span class="p">))</span>

                <span class="k">def</span> <span class="nf">status_emoji</span><span class="p">(</span><span class="n">rc</span><span class="p">):</span>
                    <span class="k">return</span> <span class="s2">&quot;✅&quot;</span> <span class="k">if</span> <span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;⛔&quot;</span> <span class="k">if</span> <span class="n">rc</span> <span class="o">==</span> <span class="mi">127</span> <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;⏱️&quot;</span> <span class="k">if</span> <span class="n">rc</span> <span class="o">==</span> <span class="mi">124</span> <span class="k">else</span> <span class="s2">&quot;❌&quot;</span><span class="p">))</span>

                <span class="c1"># תרגום סטטוסים לעברית להצגה</span>
                <span class="n">he_label</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;OK&quot;</span><span class="p">:</span> <span class="s2">&quot;תקין&quot;</span><span class="p">,</span> <span class="s2">&quot;FAIL&quot;</span><span class="p">:</span> <span class="s2">&quot;נכשל&quot;</span><span class="p">,</span> <span class="s2">&quot;TIMEOUT&quot;</span><span class="p">:</span> <span class="s2">&quot;פג זמן&quot;</span><span class="p">,</span> <span class="s2">&quot;MISSING&quot;</span><span class="p">:</span> <span class="s2">&quot;לא מותקן&quot;</span><span class="p">}</span>

                <span class="n">counts</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;OK&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;FAIL&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;TIMEOUT&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;MISSING&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
                <span class="n">max_tool_len</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">tool</span><span class="p">,</span> <span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="n">status_label</span><span class="p">(</span><span class="n">rc</span><span class="p">)</span>
                    <span class="n">counts</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">first_line</span> <span class="o">=</span> <span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="ow">or</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">][:</span><span class="mi">120</span><span class="p">]</span>
                    <span class="n">suffix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; — </span><span class="si">{</span><span class="n">escape</span><span class="p">(</span><span class="n">first_line</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">label</span> <span class="o">!=</span> <span class="s2">&quot;OK&quot;</span> <span class="ow">and</span> <span class="n">first_line</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                    <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tool</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">max_tool_len</span><span class="p">)</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">status_emoji</span><span class="p">(</span><span class="n">rc</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">he_label</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span><span class="w"> </span><span class="n">label</span><span class="p">)</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="n">header</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;🧪 בדיקות מתקדמות לריפו &lt;code&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">repo_name_for_msg</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">summary</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;סיכום: ✅ </span><span class="si">{</span><span class="n">counts</span><span class="p">[</span><span class="s1">&#39;OK&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">  ❌ </span><span class="si">{</span><span class="n">counts</span><span class="p">[</span><span class="s1">&#39;FAIL&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">  ⏱️ </span><span class="si">{</span><span class="n">counts</span><span class="p">[</span><span class="s1">&#39;TIMEOUT&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">  ⛔ </span><span class="si">{</span><span class="n">counts</span><span class="p">[</span><span class="s1">&#39;MISSING&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">body</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>

                <span class="c1"># יצירת הצעות ממוקדות</span>
                <span class="n">suggestions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="c1"># flake8 – הצעה להסרת ייבוא שלא בשימוש</span>
                <span class="n">rc_flake8</span><span class="p">,</span> <span class="n">out_flake8</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;flake8&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">rc_flake8</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">out_flake8</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">re</span> <span class="k">as</span> <span class="nn">_re</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">_re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(?P&lt;file&gt;[^:\n]+):(?P&lt;line&gt;\d+):\d+:\s*F401\s+&#39;([^&#39;]+)&#39;\s+imported but unused&quot;</span><span class="p">,</span> <span class="n">out_flake8</span><span class="p">,</span> <span class="n">_re</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                        <span class="n">file_p</span> <span class="o">=</span> <span class="n">safe_html_escape</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;file&quot;</span><span class="p">))</span>
                        <span class="n">line_p</span> <span class="o">=</span> <span class="n">safe_html_escape</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;line&quot;</span><span class="p">))</span>
                        <span class="c1"># לא תמיד אפשר לשלוף את השם בבטחה בטלגרם – משאירים כללי</span>
                        <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;b&gt;flake8&lt;/b&gt;: הסר ייבוא שלא בשימוש בשורה </span><span class="si">{</span><span class="n">line_p</span><span class="si">}</span><span class="s2"> בקובץ &lt;code&gt;</span><span class="si">{</span><span class="n">file_p</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span><span class="p">)</span>

                <span class="c1"># mypy – הצעה ל-Optional כאשר ברירת מחדל None לסוג לא-Optional</span>
                <span class="n">rc_mypy</span><span class="p">,</span> <span class="n">out_mypy</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mypy&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">rc_mypy</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">out_mypy</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">re</span> <span class="k">as</span> <span class="nn">_re</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">_re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Incompatible default for argument </span><span class="se">\&quot;</span><span class="s2">(?P&lt;arg&gt;[^</span><span class="se">\&quot;</span><span class="s2">]+)</span><span class="se">\&quot;</span><span class="s2"> \(default has type </span><span class="se">\&quot;</span><span class="s2">None</span><span class="se">\&quot;</span><span class="s2">, argument has type </span><span class="se">\&quot;</span><span class="s2">(?P&lt;typ&gt;[^</span><span class="se">\&quot;</span><span class="s2">]+)</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">out_mypy</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                        <span class="n">arg_p</span> <span class="o">=</span> <span class="n">safe_html_escape</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;arg&quot;</span><span class="p">))</span>
                        <span class="n">typ_p</span> <span class="o">=</span> <span class="n">safe_html_escape</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;typ&quot;</span><span class="p">))</span>
                        <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;b&gt;mypy&lt;/b&gt;: הגדר Optional[</span><span class="si">{</span><span class="n">typ_p</span><span class="si">}</span><span class="s2">] לפרמטר &lt;code&gt;</span><span class="si">{</span><span class="n">arg_p</span><span class="si">}</span><span class="s2">&lt;/code&gt; או שנה את ברירת המחדל מ-None&quot;</span><span class="p">)</span>

                <span class="c1"># black – הצעה להריץ black על קבצים ספציפיים</span>
                <span class="n">rc_black</span><span class="p">,</span> <span class="n">out_black</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">rc_black</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">out_black</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">re</span> <span class="k">as</span> <span class="nn">_re</span>
                    <span class="n">files</span> <span class="o">=</span> <span class="n">_re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;would reformat\s+(.+)&quot;</span><span class="p">,</span> <span class="n">out_black</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">files</span><span class="p">:</span>
                        <span class="n">raw_path</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="c1"># נסה לקצר מסלול זמני של zip לנתיב יחסי בתוך הריפו</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">_m</span> <span class="o">=</span> <span class="n">_re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;.*/repo/[^/]+/(.+)$&quot;</span><span class="p">,</span> <span class="n">raw_path</span><span class="p">)</span>
                            <span class="n">short_path</span> <span class="o">=</span> <span class="n">_m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">_m</span> <span class="k">else</span> <span class="n">raw_path</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="n">short_path</span> <span class="o">=</span> <span class="n">raw_path</span>
                        <span class="n">file1</span> <span class="o">=</span> <span class="n">safe_html_escape</span><span class="p">(</span><span class="n">short_path</span><span class="p">)</span>
                        <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;b&gt;black&lt;/b&gt;: הרץ black על &lt;code&gt;</span><span class="si">{</span><span class="n">file1</span><span class="si">}</span><span class="s2">&lt;/code&gt; או על הפרויקט כולו ליישור פורמט&quot;</span><span class="p">)</span>

                <span class="c1"># bandit – הצעות כלליות בהתאם לדפוסים נפוצים</span>
                <span class="n">rc_bandit</span><span class="p">,</span> <span class="n">out_bandit</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bandit&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">rc_bandit</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">out_bandit</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;eval(&quot;</span> <span class="ow">in</span> <span class="n">out_bandit</span> <span class="ow">or</span> <span class="s2">&quot;B307&quot;</span> <span class="ow">in</span> <span class="n">out_bandit</span><span class="p">:</span>
                        <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&lt;b&gt;bandit&lt;/b&gt;: החלף שימוש ב-eval בפתרון בטוח יותר (למשל ast.literal_eval)&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="s2">&quot;exec(&quot;</span> <span class="ow">in</span> <span class="n">out_bandit</span> <span class="ow">or</span> <span class="s2">&quot;B102&quot;</span> <span class="ow">in</span> <span class="n">out_bandit</span><span class="p">:</span>
                        <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&lt;b&gt;bandit&lt;/b&gt;: הימנע מ-exec והשתמש באלטרנטיבות בטוחות&quot;</span><span class="p">)</span>

                <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">header</span><span class="si">}{</span><span class="n">summary</span><span class="si">}</span><span class="se">\n</span><span class="s2">&lt;pre&gt;</span><span class="si">{</span><span class="n">body</span><span class="si">}</span><span class="s2">&lt;/pre&gt;&quot;</span>
                <span class="k">if</span> <span class="n">suggestions</span><span class="p">:</span>
                    <span class="c1"># שימור תגיות HTML בתוך ההצעות תוך בריחה של תוכן דינמי נעשה כבר בשלב בניית ההצעות</span>
                    <span class="n">sug_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;• </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">suggestions</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
                    <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">💡 הצעות ממוקדות:</span><span class="se">\n</span><span class="si">{</span><span class="n">sug_text</span><span class="si">}</span><span class="s2">&quot;</span>

                <span class="c1"># הוסף כפתור חזרה לתפריט GitHub</span>
                <span class="n">kb</span> <span class="o">=</span> <span class="p">[[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזרה לתפריט GitHub&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)]]</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># ודא סגירת עדכון התקדמות גם בשגיאה</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">done_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">progress_task</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">await</span> <span class="n">progress_task</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Repo validation failed&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה בבדיקת הריפו: </span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.show_repo_selection">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_repo_selection">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">show_repo_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Show repository selection menu&quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_repos</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.show_repos">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_repos">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">show_repos</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">page</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;מציג רשימת ריפוזיטוריז עם pagination&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>

        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_sessions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="p">{})</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;❌ נא להגדיר טוקן קודם&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;❌ נא להגדיר טוקן קודם&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># בדוק אם יש repos ב-context.user_data ואם הם עדיין תקפים</span>
            <span class="n">cache_time</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;repos_cache_time&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">cache_age</span> <span class="o">=</span> <span class="n">current_time</span> <span class="o">-</span> <span class="n">cache_time</span>
            <span class="n">cache_max_age</span> <span class="o">=</span> <span class="mi">3600</span>  <span class="c1"># שעה אחת</span>

            <span class="n">needs_refresh</span> <span class="o">=</span> <span class="s2">&quot;repos&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span> <span class="ow">or</span> <span class="n">cache_age</span> <span class="o">&gt;</span> <span class="n">cache_max_age</span>

            <span class="k">if</span> <span class="n">needs_refresh</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[GitHub API] Fetching repos for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> (cache age: </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">cache_age</span><span class="p">)</span><span class="si">}</span><span class="s2">s)&quot;</span>
                <span class="p">)</span>

                <span class="c1"># אם אין cache או שהוא ישן, בצע בקשה ל-API</span>

                <span class="n">_tok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">login_or_token</span><span class="o">=</span><span class="p">(</span><span class="n">_tok</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>

                <span class="c1"># בדוק rate limit לפני הבקשה</span>
                <span class="n">rate</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_rate_limit</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[GitHub API] Rate limit - Remaining: </span><span class="si">{</span><span class="n">rate</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">remaining</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">rate</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">limit</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">rate</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">remaining</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;[GitHub API] Low on API calls! Only </span><span class="si">{</span><span class="n">rate</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">remaining</span><span class="si">}</span><span class="s2"> remaining&quot;</span>
                    <span class="p">)</span>

                <span class="k">if</span> <span class="n">rate</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">remaining</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="c1"># אם יש cache ישן, השתמש בו במקום לחסום</span>
                    <span class="k">if</span> <span class="s2">&quot;repos&quot;</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[GitHub API] Using stale cache due to rate limit&quot;</span><span class="p">)</span>
                        <span class="n">all_repos</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;repos&quot;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
                            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;⏳ מגבלת API נמוכה! נותרו רק </span><span class="si">{</span><span class="n">rate</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">remaining</span><span class="si">}</span><span class="s2"> בקשות&quot;</span><span class="p">,</span>
                                <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="p">)</span>
                            <span class="k">return</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># הוסף delay בין בקשות</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_rate_limit_delay</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

                    <span class="n">user</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_user</span><span class="p">()</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[GitHub API] Getting repos for user: </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">login</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="c1"># קבל את כל הריפוזיטוריז - טען רק פעם אחת!</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;repos&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">get_repos</span><span class="p">())</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;repos_cache_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_time</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;[GitHub API] Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;repos&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> repos into cache&quot;</span>
                    <span class="p">)</span>
                    <span class="n">all_repos</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;repos&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[Cache] Using cached repos for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;repos&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[]))</span><span class="si">}</span><span class="s2"> repos (age: </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">cache_age</span><span class="p">)</span><span class="si">}</span><span class="s2">s)&quot;</span>
                <span class="p">)</span>
                <span class="n">all_repos</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;repos&quot;</span><span class="p">]</span>

            <span class="c1"># הגדרות pagination</span>
            <span class="n">repos_per_page</span> <span class="o">=</span> <span class="mi">8</span>
            <span class="n">total_repos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_repos</span><span class="p">)</span>
            <span class="n">total_pages</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_repos</span> <span class="o">+</span> <span class="n">repos_per_page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">repos_per_page</span>

            <span class="c1"># חשב אינדקסים</span>
            <span class="n">start_idx</span> <span class="o">=</span> <span class="n">page</span> <span class="o">*</span> <span class="n">repos_per_page</span>
            <span class="n">end_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start_idx</span> <span class="o">+</span> <span class="n">repos_per_page</span><span class="p">,</span> <span class="n">total_repos</span><span class="p">)</span>

            <span class="c1"># ריפוזיטוריז לעמוד הנוכחי</span>
            <span class="n">page_repos</span> <span class="o">=</span> <span class="n">all_repos</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span>

            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># הוסף ריפוזיטוריז</span>
            <span class="k">for</span> <span class="n">repo</span> <span class="ow">in</span> <span class="n">page_repos</span><span class="p">:</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;📁 </span><span class="si">{</span><span class="n">repo</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;repo_</span><span class="si">{</span><span class="n">repo</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                    <span class="p">]</span>
                <span class="p">)</span>

            <span class="c1"># כפתורי ניווט</span>
            <span class="n">nav_buttons</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">page</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">nav_buttons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;⬅️ הקודם&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;repos_page_</span><span class="si">{</span><span class="n">page</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="n">nav_buttons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📄 </span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total_pages</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;noop&quot;</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">page</span> <span class="o">&lt;</span> <span class="n">total_pages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">nav_buttons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;➡️ הבא&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;repos_page_</span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">nav_buttons</span><span class="p">:</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nav_buttons</span><span class="p">)</span>

            <span class="c1"># כפתורים נוספים</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;✍️ הקלד שם ריפו ידנית&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;repo_manual&quot;</span><span class="p">)]</span>
            <span class="p">)</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;back_to_menu&quot;</span><span class="p">)])</span>

            <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;בחר ריפוזיטורי (עמוד </span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> מתוך </span><span class="si">{</span><span class="n">total_pages</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;בחר ריפוזיטורי (עמוד </span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> מתוך </span><span class="si">{</span><span class="n">total_pages</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;בחר ריפוזיטורי (עמוד </span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> מתוך </span><span class="si">{</span><span class="n">total_pages</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">,</span>
                        <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span><span class="p">,</span>
                    <span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

            <span class="c1"># בדוק אם זו שגיאת rate limit</span>
            <span class="k">if</span> <span class="s2">&quot;rate limit&quot;</span> <span class="ow">in</span> <span class="n">error_msg</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;403&quot;</span> <span class="ow">in</span> <span class="n">error_msg</span><span class="p">:</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;⏳ חריגה ממגבלת GitHub API</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="s2">&quot;נסה שוב בעוד כמה דקות&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;❌ שגיאה: </span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span></div>

 

<div class="viewcode-block" id="GitHubMenuHandler.show_upload_other_files">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_upload_other_files">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">show_upload_other_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;מציג רק קבצים שאינם מתויגים repo: ואינם קבצים גדולים, עם עימוד ואימוג&#39;י לפי שפה.&quot;&quot;&quot;</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># קריאת נתונים</span>
            <span class="n">all_files</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user_files</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
            <span class="n">large_files</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user_large_files</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">per_page</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
            <span class="n">large_names</span> <span class="o">=</span> <span class="p">{</span><span class="n">lf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">lf</span> <span class="ow">in</span> <span class="n">large_files</span> <span class="k">if</span> <span class="n">lf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">)}</span>

            <span class="n">other_files</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">all_files</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">)</span>
                <span class="n">tags</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">large_names</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">t</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;repo:&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">):</span>
                    <span class="n">other_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">other_files</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;ℹ️ אין &#39;שאר קבצים&#39; להצגה (לא מתויגים כריפו ואינם גדולים)&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="c1"># מצב עמוד ובחירה</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;other_files_page&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">page</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">per_page</span> <span class="o">=</span> <span class="mi">20</span>
            <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">other_files</span><span class="p">)</span>
            <span class="n">pages</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">total</span> <span class="o">+</span> <span class="n">per_page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">per_page</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">page</span> <span class="o">&gt;</span> <span class="n">pages</span><span class="p">:</span>
                <span class="n">page</span> <span class="o">=</span> <span class="n">pages</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;other_files_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span>
            <span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">per_page</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">per_page</span>
            <span class="n">page_items</span> <span class="o">=</span> <span class="n">other_files</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>

            <span class="c1"># בניית מקלדת לבחירת קובץ יחיד להעלאה</span>
            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">get_language_emoji</span><span class="p">,</span> <span class="n">detect_language_from_filename</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">page_items</span><span class="p">:</span>
                <span class="n">fid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">))</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span> <span class="s1">&#39;ללא שם&#39;</span><span class="p">)</span>
                <span class="n">lang</span> <span class="o">=</span> <span class="n">detect_language_from_filename</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">emoji</span> <span class="o">=</span> <span class="n">get_language_emoji</span><span class="p">(</span><span class="n">lang</span><span class="p">)</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">emoji</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;upload_saved_</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>

            <span class="c1"># ניווט עמודים</span>
            <span class="n">nav</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">page</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;⬅️ הקודם&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;other_files_page_</span><span class="si">{</span><span class="n">page</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">page</span> <span class="o">&lt;</span> <span class="n">pages</span><span class="p">:</span>
                <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;➡️ הבא&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;other_files_page_</span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">nav</span><span class="p">:</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nav</span><span class="p">)</span>

            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;upload_file&quot;</span><span class="p">)])</span>

            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;בחר/י קובץ להעלאה (שאר הקבצים) — עמוד </span><span class="si">{</span><span class="n">page</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">pages</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה בטעינת &#39;שאר הקבצים&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.show_upload_repos">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_upload_repos">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">show_upload_repos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;מציג תפריט ריפואים לבחירת קבצים שמורים עם תגית repo: להעלאה&quot;&quot;&quot;</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user_files</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
            <span class="n">repo_to_count</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">t</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;repo:&#39;</span><span class="p">):</span>
                        <span class="n">repo_to_count</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">repo_to_count</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">repo_to_count</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;ℹ️ אין קבצים עם תגית ריפו (repo:owner/name)&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">cnt</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">repo_to_count</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])[:</span><span class="mi">50</span><span class="p">]:</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">cnt</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;gh_upload_repo:</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;upload_file&quot;</span><span class="p">)])</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;בחר/י ריפו (מתוך תגיות הקבצים השמורים):&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה בטעינת רשימת ריפואים: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="GitHubMenuHandler.show_upload_repo_files">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_upload_repo_files">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">show_upload_repo_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span><span class="n">_repo_tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;מציג קבצים שמורים תחת תגית ריפו שנבחרה ומאפשר להעלותם עם עימוד&quot;&quot;&quot;</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">repo_tag</span> <span class="o">=</span> <span class="n">_repo_tag</span>
            <span class="c1"># עימוד: קרא מה-context או התחל בעמוד 1</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;repo_files_page&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">repo_tag</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">page</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">per_page</span> <span class="o">=</span> <span class="mi">50</span>
            <span class="n">files</span><span class="p">,</span> <span class="n">total</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user_files_by_repo</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">repo_tag</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="n">page</span><span class="p">,</span> <span class="n">per_page</span><span class="o">=</span><span class="n">per_page</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;ℹ️ אין קבצים תחת התגית הזו&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">pages</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">total</span> <span class="o">+</span> <span class="n">per_page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">per_page</span><span class="p">)</span>
            <span class="c1"># בניית כפתורים</span>
            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="n">fid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">))</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span> <span class="s1">&#39;ללא שם&#39;</span><span class="p">)</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📄 </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;upload_saved_</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
            <span class="n">nav</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">page</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;⬅️ הקודם&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;repo_files_page:</span><span class="si">{</span><span class="n">repo_tag</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">page</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">page</span> <span class="o">&lt;</span> <span class="n">pages</span><span class="p">:</span>
                <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;➡️ הבא&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;repo_files_page:</span><span class="si">{</span><span class="n">repo_tag</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">nav</span><span class="p">:</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nav</span><span class="p">)</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;gh_upload_cat:repos&quot;</span><span class="p">)])</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;בחר/י קובץ להעלאה מהתגית </span><span class="si">{</span><span class="n">repo_tag</span><span class="si">}</span><span class="s2"> (עמוד </span><span class="si">{</span><span class="n">page</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">pages</span><span class="si">}</span><span class="s2">, סך הכל </span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה בטעינת קבצים: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.upload_large_files_menu">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.upload_large_files_menu">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">upload_large_files_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;מציג רשימת קבצים גדולים להעלאה לריפו הנבחר&quot;&quot;&quot;</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">large_files</span><span class="p">,</span> <span class="n">total</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user_large_files</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">per_page</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">large_files</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;ℹ️ אין קבצים גדולים שמורים&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">lf</span> <span class="ow">in</span> <span class="n">large_files</span><span class="p">:</span>
                <span class="n">fid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">lf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">))</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">lf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span> <span class="s1">&#39;ללא שם&#39;</span><span class="p">)</span>
                <span class="n">size_kb</span> <span class="o">=</span> <span class="p">(</span><span class="n">lf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_size&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1024</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📄 </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">size_kb</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">KB)&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;gh_upload_large:</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;upload_file&quot;</span><span class="p">)])</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;בחר/י קובץ גדול להעלאה:&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה בטעינת קבצים גדולים: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.handle_large_file_upload">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.handle_large_file_upload">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">handle_large_file_upload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">file_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;מעלה קובץ גדול שנבחר לגיטהאב (עם אותן בדיקות כמו קובץ שמור רגיל)&quot;&quot;&quot;</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">token</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ קודם בחר ריפו/טוקן בגיטהאב&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># שלוף את תוכן הקובץ הגדול</span>
        <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>
        <span class="kn">from</span> <span class="nn">bson</span> <span class="kn">import</span> <span class="n">ObjectId</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">large_files_collection</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="n">file_id</span><span class="p">),</span> <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">doc</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ קובץ גדול לא נמצא&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># מאחדים עם זרימת show_pre_upload_check: נשתמש ב-pending_saved_file_id אחרי יצירת מסמך זמני</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># צור מסמך זמני בקולקשן הרגיל כדי למחזר את מסך הבדיקות</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
                <span class="s2">&quot;file_name&quot;</span><span class="p">:</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file_name&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;large_file.txt&quot;</span><span class="p">,</span>
                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">insert_one</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;pending_saved_file_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">inserted_id</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_pre_upload_check</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה בהכנת קובץ גדול להעלאה: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.handle_saved_file_upload">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.handle_saved_file_upload">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">handle_saved_file_upload</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">file_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;מטפל בהעלאת קובץ שמור ל-GitHub&quot;&quot;&quot;</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;❌ נא לבחור ריפו קודם&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">bson</span> <span class="kn">import</span> <span class="n">ObjectId</span>

            <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>

            <span class="c1"># קבל את הקובץ מהמסד</span>
            <span class="n">file_data</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="n">file_id</span><span class="p">),</span> <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">})</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">file_data</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;❌ קובץ לא נמצא&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;⏳ מעלה קובץ ל-GitHub...&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">emit_event</span><span class="p">(</span><span class="s2">&quot;github_upload_start&quot;</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">user_id</span><span class="p">),</span> <span class="n">file_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">file_id</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="c1"># לוג פרטי הקובץ</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📄 מעלה קובץ שמור: </span><span class="si">{</span><span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># קבל את התוכן מהקובץ השמור</span>
            <span class="c1"># בדוק כמה אפשרויות לשדה content</span>
            <span class="n">content</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">)</span>
                <span class="ow">or</span> <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;code&quot;</span><span class="p">)</span>
                <span class="ow">or</span> <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>
                <span class="ow">or</span> <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file_content&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">content</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ תוכן הקובץ ריק או לא נמצא&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="c1"># PyGithub מקודד אוטומטית ל-base64, אז רק נוודא שהתוכן הוא string</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ תוכן מוכן להעלאה, גודל: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="si">}</span><span class="s2"> chars&quot;</span><span class="p">)</span>

            <span class="c1"># התחבר ל-GitHub</span>

            <span class="n">token_opt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token_opt</span><span class="p">)</span> <span class="k">if</span> <span class="n">token_opt</span> <span class="k">else</span> <span class="n">Github</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">token_opt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token_opt</span><span class="p">)</span> <span class="k">if</span> <span class="n">token_opt</span> <span class="k">else</span> <span class="n">Github</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">token_opt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token_opt</span><span class="p">)</span> <span class="k">if</span> <span class="n">token_opt</span> <span class="k">else</span> <span class="n">Github</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

            <span class="c1"># בדוק rate limit לפני הבקשה</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">emit_event</span><span class="p">(</span><span class="s2">&quot;github_rate_limit_check&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[GitHub API] Checking rate limit before uploading file&quot;</span><span class="p">)</span>
            <span class="n">rate</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_rate_limit</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[GitHub API] Rate limit - Remaining: </span><span class="si">{</span><span class="n">rate</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">remaining</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">rate</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">limit</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">rate</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">remaining</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[GitHub API] Low on API calls! Only </span><span class="si">{</span><span class="n">rate</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">remaining</span><span class="si">}</span><span class="s2"> remaining&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">rate</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">remaining</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;⏳ מגבלת API נמוכה מדי! נותרו רק </span><span class="si">{</span><span class="n">rate</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">remaining</span><span class="si">}</span><span class="s2"> בקשות&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="k">return</span>

            <span class="c1"># הוסף delay בין בקשות</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_rate_limit_delay</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[GitHub API] Getting repo: </span><span class="si">{</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;selected_repo&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">])</span>

            <span class="c1"># Resolve target branch and folder</span>
            <span class="n">branch</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;upload_target_branch&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">repo</span><span class="o">.</span><span class="n">default_branch</span> <span class="ow">or</span> <span class="s2">&quot;main&quot;</span>
            <span class="n">folder</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;upload_target_folder&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_folder&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">folder</span> <span class="ow">and</span> <span class="n">folder</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="n">folder</span> <span class="o">=</span> <span class="n">folder</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="n">file_data</span><span class="p">[</span><span class="s2">&quot;file_name&quot;</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📁 נתיב יעד: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2"> (branch: </span><span class="si">{</span><span class="n">branch</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

            <span class="c1"># נסה להעלות או לעדכן את הקובץ</span>
            <span class="c1"># מדידת ביצועים והוספת מטא-מידע על הריפו/הענף</span>
            <span class="k">with</span> <span class="n">track_performance</span><span class="p">(</span><span class="s2">&quot;github_upload_saved_file&quot;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;repo&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))}):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[GitHub API] Checking if file exists: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2"> @ </span><span class="si">{</span><span class="n">branch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">existing</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">branch</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[GitHub API] File exists, updating: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">update_file</span><span class="p">(</span>
                        <span class="n">path</span><span class="o">=</span><span class="n">file_path</span><span class="p">,</span>
                        <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Update </span><span class="si">{</span><span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> via Telegram bot&quot;</span><span class="p">,</span>
                        <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>  <span class="c1"># PyGithub יקודד אוטומטית</span>
                        <span class="n">sha</span><span class="o">=</span><span class="n">existing</span><span class="o">.</span><span class="n">sha</span><span class="p">,</span>
                        <span class="n">branch</span><span class="o">=</span><span class="n">branch</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">action</span> <span class="o">=</span> <span class="s2">&quot;עודכן&quot;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ קובץ עודכן בהצלחה&quot;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">emit_event</span><span class="p">(</span>
                            <span class="s2">&quot;github_upload_saved_success&quot;</span><span class="p">,</span>
                            <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span>
                            <span class="n">repo</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)),</span>
                            <span class="n">branch</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">branch</span><span class="p">),</span>
                            <span class="n">path</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">file_path</span><span class="p">),</span>
                            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;update&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[GitHub API] File doesn&#39;t exist, creating: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">create_file</span><span class="p">(</span>
                        <span class="n">path</span><span class="o">=</span><span class="n">file_path</span><span class="p">,</span>
                        <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Upload </span><span class="si">{</span><span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> via Telegram bot&quot;</span><span class="p">,</span>
                        <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>  <span class="c1"># PyGithub יקודד אוטומטית</span>
                        <span class="n">branch</span><span class="o">=</span><span class="n">branch</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">action</span> <span class="o">=</span> <span class="s2">&quot;הועלה&quot;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[GitHub API] File created successfully: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">emit_event</span><span class="p">(</span>
                            <span class="s2">&quot;github_upload_saved_success&quot;</span><span class="p">,</span>
                            <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span>
                            <span class="n">repo</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)),</span>
                            <span class="n">branch</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">branch</span><span class="p">),</span>
                            <span class="n">path</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">file_path</span><span class="p">),</span>
                            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;create&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>

            <span class="n">raw_url</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;https://raw.githubusercontent.com/</span><span class="si">{</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;selected_repo&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">branch</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;✅ הקובץ </span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2"> בהצלחה!</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;📁 ריפו: &lt;code&gt;</span><span class="si">{</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;selected_repo&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;📂 מיקום: &lt;code&gt;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;🔗 קישור ישיר:</span><span class="se">\n</span><span class="si">{</span><span class="n">raw_url</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;שלח /github כדי לחזור לתפריט.&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה בהעלאת קובץ שמור: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">emit_event</span><span class="p">(</span><span class="s2">&quot;github_upload_saved_error&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">errors_total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">errors_total</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="s2">&quot;github_upload_saved_error&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="n">error_msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;rate limit&quot;</span> <span class="ow">in</span> <span class="n">error_msg</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;403&quot;</span> <span class="ow">in</span> <span class="n">error_msg</span><span class="p">:</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;⏳ חריגה ממגבלת GitHub API</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;נסה שוב בעוד כמה דקות</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;💡 טיפ: המתן מספר דקות לפני ניסיון נוסף&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;❌ שגיאה בהעלאה:</span><span class="se">\n</span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">פרטים נוספים נשמרו בלוג.&quot;</span>

            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.handle_file_upload">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.handle_file_upload">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">handle_file_upload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle file upload&quot;&quot;&quot;</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

        <span class="c1"># בדוק אם אנחנו במצב העלאה לגיטהאב (תמיכה בשני המשתנים)</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;waiting_for_upload_folder&quot;</span><span class="p">):</span>
            <span class="c1"># Capture folder path from user text and return to pre-upload check</span>
            <span class="n">folder_text</span> <span class="o">=</span> <span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">text</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="c1"># normalize: remove leading/trailing slashes</span>
            <span class="n">folder_norm</span> <span class="o">=</span> <span class="n">folder_text</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;upload_target_folder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">folder_norm</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_upload_folder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;✅ תיקיית יעד עודכנה. חוזר לבדיקות...&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_pre_upload_check</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;waiting_for_github_upload&quot;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;upload_mode&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;github&quot;</span>
        <span class="p">):</span>
            <span class="c1"># העלאה לגיטהאב</span>
            <span class="n">repo_name</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target_repo&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">repo_name</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;❌ קודם בחר ריפו!</span><span class="se">\n</span><span class="s2">שלח /github&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>

            <span class="k">if</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">document</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;⏳ מעלה קובץ לגיטהאב...&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">emit_event</span><span class="p">(</span>
                        <span class="s2">&quot;github_upload_start&quot;</span><span class="p">,</span>
                        <span class="n">user_id</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">user_id</span><span class="p">),</span>
                        <span class="n">file_name</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">file_name</span><span class="p">),</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">file</span> <span class="o">=</span> <span class="k">await</span> <span class="n">context</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">file_id</span><span class="p">)</span>
                    <span class="n">file_data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">file</span><span class="o">.</span><span class="n">download_as_bytearray</span><span class="p">()</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">file_name</span>

                    <span class="c1"># לוג גודל וסוג הקובץ</span>
                    <span class="n">file_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📄 מעלה קובץ: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">, גודל: </span><span class="si">{</span><span class="n">file_size</span><span class="si">}</span><span class="s2"> bytes&quot;</span><span class="p">)</span>

                    <span class="c1"># PyGithub מקודד אוטומטית ל-base64, אז נמיר ל-string אם צריך</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_data</span><span class="p">,</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">)):</span>
                        <span class="n">content</span> <span class="o">=</span> <span class="n">file_data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">content</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ תוכן מוכן להעלאה, גודל: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="si">}</span><span class="s2"> chars&quot;</span><span class="p">)</span>

                    <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;GITHUB_TOKEN&quot;</span><span class="p">)</span>

                    <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">login_or_token</span><span class="o">=</span><span class="p">(</span><span class="n">token</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>

                    <span class="c1"># בדוק rate limit לפני הבקשה</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">emit_event</span><span class="p">(</span><span class="s2">&quot;github_rate_limit_check&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[GitHub API] Checking rate limit before file upload&quot;</span><span class="p">)</span>
                    <span class="n">rate</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_rate_limit</span><span class="p">()</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;[GitHub API] Rate limit - Remaining: </span><span class="si">{</span><span class="n">rate</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">remaining</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">rate</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">limit</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">rate</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">remaining</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;[GitHub API] Low on API calls! Only </span><span class="si">{</span><span class="n">rate</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">remaining</span><span class="si">}</span><span class="s2"> remaining&quot;</span>
                        <span class="p">)</span>

                    <span class="k">if</span> <span class="n">rate</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">remaining</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;⏳ מגבלת API נמוכה מדי!</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;נותרו רק </span><span class="si">{</span><span class="n">rate</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">remaining</span><span class="si">}</span><span class="s2"> בקשות</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;נסה שוב מאוחר יותר&quot;</span>
                        <span class="p">)</span>
                        <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>

                    <span class="c1"># הוסף delay בין בקשות</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_rate_limit_delay</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[GitHub API] Getting repo: </span><span class="si">{</span><span class="n">repo_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span>

                    <span class="c1"># בניית נתיב הקובץ</span>
                    <span class="n">folder</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;upload_target_folder&quot;</span><span class="p">)</span>
                        <span class="ow">or</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target_folder&quot;</span><span class="p">)</span>
                        <span class="ow">or</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_folder&quot;</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">folder</span> <span class="ow">and</span> <span class="n">folder</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">and</span> <span class="n">folder</span> <span class="o">!=</span> <span class="s2">&quot;root&quot;</span><span class="p">:</span>
                        <span class="c1"># הסר / מיותרים</span>
                        <span class="n">folder</span> <span class="o">=</span> <span class="n">folder</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
                        <span class="n">file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># העלה ל-root</span>
                        <span class="n">file_path</span> <span class="o">=</span> <span class="n">filename</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📁 נתיב יעד: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="k">with</span> <span class="n">track_performance</span><span class="p">(</span><span class="s2">&quot;github_upload_direct_file&quot;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;repo&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)}):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">existing</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
                            <span class="n">result</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">update_file</span><span class="p">(</span>
                                <span class="n">path</span><span class="o">=</span><span class="n">file_path</span><span class="p">,</span>
                                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Update </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> via Telegram bot&quot;</span><span class="p">,</span>
                                <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>  <span class="c1"># PyGithub יקודד אוטומטית</span>
                                <span class="n">sha</span><span class="o">=</span><span class="n">existing</span><span class="o">.</span><span class="n">sha</span><span class="p">,</span>
                            <span class="p">)</span>
                            <span class="n">action</span> <span class="o">=</span> <span class="s2">&quot;עודכן&quot;</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ קובץ עודכן בהצלחה&quot;</span><span class="p">)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">emit_event</span><span class="p">(</span>
                                    <span class="s2">&quot;github_upload_direct_success&quot;</span><span class="p">,</span>
                                    <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span>
                                    <span class="n">repo</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">repo_name</span><span class="p">),</span>
                                    <span class="n">path</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">file_path</span><span class="p">),</span>
                                    <span class="n">action</span><span class="o">=</span><span class="s2">&quot;update&quot;</span><span class="p">,</span>
                                <span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="k">pass</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="n">result</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">create_file</span><span class="p">(</span>
                                <span class="n">path</span><span class="o">=</span><span class="n">file_path</span><span class="p">,</span>
                                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Upload </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> via Telegram bot&quot;</span><span class="p">,</span>
                                <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>  <span class="c1"># PyGithub יקודד אוטומטית</span>
                            <span class="p">)</span>
                            <span class="n">action</span> <span class="o">=</span> <span class="s2">&quot;הועלה&quot;</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ קובץ נוצר בהצלחה&quot;</span><span class="p">)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">emit_event</span><span class="p">(</span>
                                    <span class="s2">&quot;github_upload_direct_success&quot;</span><span class="p">,</span>
                                    <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span>
                                    <span class="n">repo</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">repo_name</span><span class="p">),</span>
                                    <span class="n">path</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">file_path</span><span class="p">),</span>
                                    <span class="n">action</span><span class="o">=</span><span class="s2">&quot;create&quot;</span><span class="p">,</span>
                                <span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="k">pass</span>

                    <span class="n">raw_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://raw.githubusercontent.com/</span><span class="si">{</span><span class="n">repo_name</span><span class="si">}</span><span class="s2">/main/</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span>

                    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;✅ הקובץ </span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2"> בהצלחה לגיטהאב!</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;📁 ריפו: &lt;code&gt;</span><span class="si">{</span><span class="n">repo_name</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;📂 מיקום: &lt;code&gt;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;🔗 קישור ישיר:</span><span class="se">\n</span><span class="si">{</span><span class="n">raw_url</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;שלח /github כדי לחזור לתפריט.&quot;</span><span class="p">,</span>
                        <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="c1"># נקה את הסטטוס</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_github_upload&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;upload_mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה בהעלאה: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">emit_event</span><span class="p">(</span><span class="s2">&quot;github_upload_direct_error&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">errors_total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">errors_total</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="s2">&quot;github_upload_direct_error&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>

                    <span class="n">error_msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

                    <span class="c1"># בדוק אם זו שגיאת rate limit</span>
                    <span class="k">if</span> <span class="s2">&quot;rate limit&quot;</span> <span class="ow">in</span> <span class="n">error_msg</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;403&quot;</span> <span class="ow">in</span> <span class="n">error_msg</span><span class="p">:</span>
                        <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="s2">&quot;⏳ חריגה ממגבלת GitHub API</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="s2">&quot;נסה שוב בעוד כמה דקות</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                            <span class="s2">&quot;💡 טיפ: המתן מספר דקות לפני ניסיון נוסף&quot;</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;❌ שגיאה בהעלאה:</span><span class="se">\n</span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">פרטים נוספים נשמרו בלוג.&quot;</span>

                    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;⚠️ שלח קובץ להעלאה&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># אם לא במצב העלאה לגיטהאב, תן למטפל הרגיל לטפל בזה</span>
            <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.handle_text_input">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.handle_text_input">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">handle_text_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle text input for various states&quot;&quot;&quot;</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">text</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;📝 GitHub text input handler: user=</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">, waiting_for_repo=</span><span class="si">{</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;waiting_for_repo_url&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="c1"># הנתיבים למחיקה/הורדה עוברים דרך דפדפן הכפתורים כעת, לכן אין צורך לטפל כאן</span>

        <span class="c1"># הזן/בחר ריפו לניתוח</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;waiting_for_repo_url&quot;</span><span class="p">):</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_repo_url&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_repository</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># הזנת שם ריפו חדש לזרימת יצירה מּZIP</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;waiting_for_new_repo_name&quot;</span><span class="p">):</span>
            <span class="c1"># נקה את מצב ההמתנה</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_new_repo_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">name_raw</span> <span class="o">=</span> <span class="p">(</span><span class="n">text</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="c1"># סניטיזציה פשוטה: המרת רווחים למקף ואישור תווים מותרים</span>
            <span class="n">safe</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">name_raw</span><span class="p">)</span>
            <span class="n">safe</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^A-Za-z0-9._-]&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">safe</span><span class="p">)</span>
            <span class="n">safe</span> <span class="o">=</span> <span class="n">safe</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;.-_&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">safe</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;❌ שם ריפו לא תקין. נסה שוב עם אותיות/מספרים/.-_ בלבד.&quot;</span><span class="p">)</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_new_repo_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="c1"># שמור את השם לבחירת יצירה</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;new_repo_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">safe</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;✅ שם הריפו נקבע: &lt;code&gt;</span><span class="si">{</span><span class="n">safe</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">שלח עכשיו קובץ ZIP לפריסה.&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># זרימת הדבקת קוד: שלב 1 - קבלת תוכן</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;waiting_for_paste_content&quot;</span><span class="p">):</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_paste_content&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">code_text</span> <span class="o">=</span> <span class="n">text</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">code_text</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_paste_content&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                    <span class="s2">&quot;⚠️ קיבלתי תוכן ריק. הדבק/י את הקוד שוב.&quot;</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">([</span>
                        <span class="p">[</span>
                            <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;upload_file&quot;</span><span class="p">),</span>
                            <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;❌ ביטול&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;cancel_paste_flow&quot;</span><span class="p">),</span>
                        <span class="p">]</span>
                    <span class="p">])</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;paste_content&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">code_text</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_paste_filename&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;📄 איך לקרוא לקובץ?</span><span class="se">\n</span><span class="s2">הקלד/י שם כולל סיומת (לדוגמה: app.py או index.ts).&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">([</span>
                    <span class="p">[</span>
                        <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;upload_file&quot;</span><span class="p">),</span>
                        <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;❌ ביטול&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;cancel_paste_flow&quot;</span><span class="p">),</span>
                    <span class="p">]</span>
                <span class="p">])</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># זרימת הדבקת קוד: שלב 2 - קבלת שם קובץ ופתיחת מסך הבדיקות</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;waiting_for_paste_filename&quot;</span><span class="p">):</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_paste_filename&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">raw_name</span> <span class="o">=</span> <span class="p">(</span><span class="n">text</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="c1"># ולידציה בסיסית לשם קובץ</span>
            <span class="n">safe_name</span> <span class="o">=</span> <span class="n">raw_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">safe_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">safe_name</span><span class="p">)</span>
            <span class="n">safe_name</span> <span class="o">=</span> <span class="n">safe_name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">safe_name</span> <span class="ow">or</span> <span class="s2">&quot;.&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">safe_name</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_paste_filename&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                    <span class="s2">&quot;⚠️ שם קובץ לא תקין. ודא שם + סיומת, לדוגמה: main.py&quot;</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">([</span>
                        <span class="p">[</span>
                            <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;upload_file&quot;</span><span class="p">),</span>
                            <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;❌ ביטול&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;cancel_paste_flow&quot;</span><span class="p">),</span>
                        <span class="p">]</span>
                    <span class="p">])</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;❌ קודם בחר/י ריפו. שלח/י /github&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>

            <span class="n">content</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;paste_content&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>
                <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
                <span class="n">doc</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
                    <span class="s2">&quot;file_name&quot;</span><span class="p">:</span> <span class="n">safe_name</span><span class="p">,</span>
                    <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">content</span><span class="p">,</span>
                    <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">(),</span>
                    <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;pasted&quot;</span><span class="p">],</span>
                <span class="p">}</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">insert_one</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;pending_saved_file_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">inserted_id</span><span class="p">)</span>
                <span class="c1"># נקה תוכן זמני</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;paste_content&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_pre_upload_check</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה בשמירת הקובץ הזמני: </span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># חיפוש בשם קובץ מתוך דפדפן הריפו</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;browse_search_mode&quot;</span><span class="p">):</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_search_mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">text</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">query</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;❌ שאילתת חיפוש ריקה. נסה שוב דרך הכפתור.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_search_query&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">query</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_search_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_browse_search_results</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># בחירת תיקייה (מתוך &quot;בחר תיקיית יעד&quot; הכללי)</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;waiting_for_selected_folder&quot;</span><span class="p">):</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_selected_folder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">folder_raw</span> <span class="o">=</span> <span class="p">(</span><span class="n">text</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="c1"># Normalize: allow &#39;/&#39; or empty for root</span>
            <span class="k">if</span> <span class="n">folder_raw</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">}:</span>
                <span class="n">session</span><span class="p">[</span><span class="s2">&quot;selected_folder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;✅ תיקיית יעד עודכנה ל-root&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># clean slashes and collapse duplicates</span>
                <span class="n">folder_clean</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;/+&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">folder_raw</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">))</span>
                <span class="n">session</span><span class="p">[</span><span class="s2">&quot;selected_folder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">folder_clean</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;✅ תיקיית יעד עודכנה ל-&lt;code&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">folder_clean</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span><span class="p">,</span>
                    <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="c1"># חזרה לתפריט GitHub</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">github_menu_command</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># יצירת תיקייה חדשה (גם מהתפריט וגם מתוך בדיקות לפני העלאה)</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;waiting_for_new_folder_path&quot;</span><span class="p">):</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_new_folder_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">folder_raw</span> <span class="o">=</span> <span class="p">(</span><span class="n">text</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">folder_raw</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">}:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;❌ יש להזין נתיב תיקייה תקין (לדוגמה: src/new)&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="n">folder_clean</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;/+&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">folder_raw</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">))</span>

            <span class="c1"># צור קובץ .gitkeep בתיקייה החדשה כדי ליצור אותה בגיט</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">repo_full</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_full</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;❌ חסר טוקן או ריפו לא נבחר&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_full</span><span class="p">)</span>
                <span class="n">target_branch</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;upload_target_branch&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="s2">&quot;default_branch&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;main&quot;</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder_clean</span><span class="si">}</span><span class="s2">/.gitkeep&quot;</span>
                <span class="n">content</span> <span class="o">=</span> <span class="s2">&quot;placeholder to keep directory&quot;</span>
                <span class="c1"># נסה ליצור, ואם קיים נעדכן</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">existing</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">target_branch</span><span class="p">)</span>
                    <span class="n">repo</span><span class="o">.</span><span class="n">update_file</span><span class="p">(</span>
                        <span class="n">path</span><span class="o">=</span><span class="n">file_path</span><span class="p">,</span>
                        <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Update .gitkeep via bot in </span><span class="si">{</span><span class="n">folder_clean</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>
                        <span class="n">sha</span><span class="o">=</span><span class="n">existing</span><span class="o">.</span><span class="n">sha</span><span class="p">,</span>
                        <span class="n">branch</span><span class="o">=</span><span class="n">target_branch</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">repo</span><span class="o">.</span><span class="n">create_file</span><span class="p">(</span>
                        <span class="n">path</span><span class="o">=</span><span class="n">file_path</span><span class="p">,</span>
                        <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Create folder </span><span class="si">{</span><span class="n">folder_clean</span><span class="si">}</span><span class="s2"> via bot&quot;</span><span class="p">,</span>
                        <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>
                        <span class="n">branch</span><span class="o">=</span><span class="n">target_branch</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="c1"># אם נוצר מתוך זרימת ה-pre-upload, עדכן את תיקיית היעד וחזור לבדיקה</span>
                <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;return_to_pre_upload&quot;</span><span class="p">):</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;return_to_pre_upload&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;upload_target_folder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">folder_clean</span>
                    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;✅ התיקייה נוצרה: &lt;code&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">folder_clean</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">חוזר למסך הבדיקות…&quot;</span><span class="p">,</span>
                        <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_pre_upload_check</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># אחרת, עדכן גם את התיקייה הנבחרת לשימוש עתידי וחזור לתפריט</span>
                    <span class="n">session</span><span class="p">[</span><span class="s2">&quot;selected_folder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">folder_clean</span>
                    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;✅ התיקייה נוצרה ונבחרה: &lt;code&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">folder_clean</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span><span class="p">,</span>
                        <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">github_menu_command</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create folder </span><span class="si">{</span><span class="n">folder_clean</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;❌ יצירת תיקייה נכשלה: </span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># ברירת מחדל: סיים</span>
        <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.show_analyze_repo_menu">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_analyze_repo_menu">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">show_analyze_repo_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;מציג תפריט לניתוח ריפו&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;📋 Starting show_analyze_repo_menu function&quot;</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;📊 Session data: selected_repo=</span><span class="si">{</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;selected_repo&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">, has_token=</span><span class="si">{</span><span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="c1"># בדוק אם יש ריפו נבחר</span>
        <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">):</span>
            <span class="c1"># אם יש ריפו נבחר, הצע לנתח אותו או לבחור אחר</span>
            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;📊 נתח את </span><span class="si">{</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;selected_repo&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;analyze_current_repo&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔍 נתח ריפו אחר&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;analyze_other_repo&quot;</span><span class="p">)],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור לתפריט&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)],</span>
            <span class="p">]</span>

            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="s2">&quot;🔍 &lt;b&gt;ניתוח ריפוזיטורי&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="s2">&quot;בחר אפשרות:&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># אם אין ריפו נבחר, בקש URL</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_repo_url</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.request_repo_url">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.request_repo_url">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">request_repo_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;מבקש URL של ריפו לניתוח&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;📝 Requesting repository URL from user&quot;</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span> <span class="k">if</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;❌ ביטול&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)]]</span>

        <span class="n">message_text</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;🔍 &lt;b&gt;ניתוח ריפוזיטורי&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;שלח URL של ריפו ציבורי ב-GitHub:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;לדוגמה: &lt;code&gt;https://github.com/owner/repo&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;💡 הריפו חייב להיות ציבורי או שיש לך גישה אליו עם הטוקן&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="n">message_text</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="n">message_text</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span>
            <span class="p">)</span>

        <span class="c1"># סמן שאנחנו מחכים ל-URL</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_repo_url&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.analyze_another_repo">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.analyze_another_repo">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">analyze_another_repo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;מציג תפריט בחירה לניתוח ריפו אחר&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>

        <span class="c1"># הצג כפתורים לבחירה</span>
        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📁 בחר מהריפוזיטורים שלי&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;choose_my_repo&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔗 הכנס URL של ריפו ציבורי&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;enter_repo_url&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;back_to_analysis_menu&quot;</span><span class="p">)],</span>
        <span class="p">]</span>

        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
            <span class="s2">&quot;איך תרצה לבחור ריפו לניתוח?&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.analyze_repository">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.analyze_repository">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">analyze_repository</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">repo_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;מנתח ריפוזיטורי ומציג תוצאות&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🎯 Starting repository analysis for URL: </span><span class="si">{</span><span class="n">repo_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span> <span class="k">if</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;👤 User </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> analyzing repo: </span><span class="si">{</span><span class="n">repo_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># הצג הודעת המתנה</span>
        <span class="n">status_message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_or_edit_message</span><span class="p">(</span>
            <span class="n">update</span><span class="p">,</span> <span class="s2">&quot;🔍 מנתח את הריפו...</span><span class="se">\n</span><span class="s2">זה עשוי לקחת מספר שניות...&quot;</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># צור מנתח עם הטוקן</span>
            <span class="n">analyzer</span> <span class="o">=</span> <span class="n">RepoAnalyzer</span><span class="p">(</span><span class="n">github_token</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">))</span>

            <span class="c1"># נתח את הריפו</span>
            <span class="n">analysis</span> <span class="o">=</span> <span class="k">await</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">fetch_and_analyze_repo</span><span class="p">(</span><span class="n">repo_url</span><span class="p">)</span>

            <span class="c1"># שמור את הניתוח ב-session</span>
            <span class="n">session</span><span class="p">[</span><span class="s2">&quot;last_analysis&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis</span>
            <span class="n">session</span><span class="p">[</span><span class="s2">&quot;last_analyzed_repo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">repo_url</span>

            <span class="c1"># צור סיכום</span>
            <span class="n">summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_analysis_summary</span><span class="p">(</span><span class="n">analysis</span><span class="p">)</span>

            <span class="c1"># צור כפתורים</span>
            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🎯 הצג הצעות לשיפור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;show_suggestions&quot;</span><span class="p">)],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📥 הורד דוח JSON&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;download_analysis_json&quot;</span><span class="p">)],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔍 נתח ריפו אחר&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;analyze_other_repo&quot;</span><span class="p">)],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור לתפריט&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)],</span>
            <span class="p">]</span>

            <span class="c1"># עדכן את ההודעה עם התוצאות</span>
            <span class="k">await</span> <span class="n">status_message</span><span class="o">.</span><span class="n">edit_text</span><span class="p">(</span>
                <span class="n">summary</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span>
            <span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error analyzing repository: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;❌ שגיאה בניתוח הריפו:</span><span class="se">\n</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔍 נסה ריפו אחר&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;analyze_other_repo&quot;</span><span class="p">)],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור לתפריט&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)],</span>
            <span class="p">]</span>

            <span class="k">await</span> <span class="n">status_message</span><span class="o">.</span><span class="n">edit_text</span><span class="p">(</span>
                <span class="n">error_message</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
            <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_create_analysis_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analysis</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;יוצר סיכום של הניתוח&quot;&quot;&quot;</span>
        <span class="c1"># Escape HTML special characters</span>
        <span class="n">repo_name</span> <span class="o">=</span> <span class="n">safe_html_escape</span><span class="p">(</span><span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;repo_name&quot;</span><span class="p">])</span>
        <span class="n">language</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">safe_html_escape</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;language&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span> <span class="k">if</span> <span class="n">analysis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;language&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>

        <span class="n">summary</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;📊 &lt;b&gt;ניתוח הריפו </span><span class="si">{</span><span class="n">repo_name</span><span class="si">}</span><span class="s2">&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>

        <span class="c1"># סטטוס קבצים בסיסיים</span>
        <span class="n">summary</span> <span class="o">+=</span> <span class="s2">&quot;&lt;b&gt;קבצים בסיסיים:&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">summary</span> <span class="o">+=</span> <span class="s2">&quot;✅ README</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;has_readme&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;❌ חסר README</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">summary</span> <span class="o">+=</span> <span class="s2">&quot;✅ LICENSE</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;has_license&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;❌ חסר LICENSE</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">summary</span> <span class="o">+=</span> <span class="s2">&quot;✅ .gitignore</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;has_gitignore&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;❌ חסר .gitignore</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="c1"># מידע על הפרויקט</span>
        <span class="n">summary</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&lt;b&gt;מידע כללי:&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">language</span><span class="p">:</span>
            <span class="n">summary</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;🔤 שפה עיקרית: </span><span class="si">{</span><span class="n">language</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">summary</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;📁 </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;file_count&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> קבצי קוד</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="c1"># קבצים לפי סוג</span>
        <span class="k">if</span> <span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;files_by_type&quot;</span><span class="p">]:</span>
            <span class="n">top_types</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;files_by_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span>
                <span class="p">:</span><span class="mi">3</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">ext</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">top_types</span><span class="p">:</span>
                <span class="n">ext_escaped</span> <span class="o">=</span> <span class="n">safe_html_escape</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>
                <span class="n">summary</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   • </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2"> קבצי </span><span class="si">{</span><span class="n">ext_escaped</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="c1"># תלויות</span>
        <span class="k">if</span> <span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;dependencies&quot;</span><span class="p">]:</span>
            <span class="n">summary</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;📦 </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;dependencies&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> תלויות</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="c1"># בעיות פוטנציאליות</span>
        <span class="k">if</span> <span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;large_files&quot;</span><span class="p">]:</span>
            <span class="n">summary</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;⚠️ </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;large_files&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> קבצים גדולים</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;long_functions&quot;</span><span class="p">]:</span>
            <span class="n">summary</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;⚠️ </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;long_functions&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> פונקציות ארוכות</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="c1"># ציון איכות</span>
        <span class="n">quality_score</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;quality_score&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">quality_score</span> <span class="o">&gt;=</span> <span class="mi">80</span><span class="p">:</span>
            <span class="n">emoji</span> <span class="o">=</span> <span class="s2">&quot;🌟&quot;</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;מצוין&quot;</span>
        <span class="k">elif</span> <span class="n">quality_score</span> <span class="o">&gt;=</span> <span class="mi">60</span><span class="p">:</span>
            <span class="n">emoji</span> <span class="o">=</span> <span class="s2">&quot;✨&quot;</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;טוב&quot;</span>
        <span class="k">elif</span> <span class="n">quality_score</span> <span class="o">&gt;=</span> <span class="mi">40</span><span class="p">:</span>
            <span class="n">emoji</span> <span class="o">=</span> <span class="s2">&quot;⭐&quot;</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;בינוני&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">emoji</span> <span class="o">=</span> <span class="s2">&quot;💫&quot;</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;דורש שיפור&quot;</span>

        <span class="n">summary</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&lt;b&gt;ציון איכות: </span><span class="si">{</span><span class="n">emoji</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">quality_score</span><span class="si">}</span><span class="s2">/100 (</span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s2">)&lt;/b&gt;&quot;</span>

        <span class="k">return</span> <span class="n">summary</span>

<div class="viewcode-block" id="GitHubMenuHandler.show_improvement_suggestions">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_improvement_suggestions">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">show_improvement_suggestions</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;מציג הצעות לשיפור&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>

        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;last_analysis&quot;</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="s2">&quot;❌ לא נמצא ניתוח. נתח ריפו קודם.&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔍 נתח ריפו&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;analyze_repo&quot;</span><span class="p">)],</span>
                        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור לתפריט&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)],</span>
                    <span class="p">]</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># צור הצעות לשיפור</span>
        <span class="n">analyzer</span> <span class="o">=</span> <span class="n">RepoAnalyzer</span><span class="p">()</span>
        <span class="n">suggestions</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">generate_improvement_suggestions</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;last_analysis&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">suggestions</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="s2">&quot;🎉 מעולה! לא נמצאו הצעות לשיפור משמעותיות.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="s2">&quot;הפרויקט נראה מצוין!&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור לסיכום&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;back_to_analysis&quot;</span><span class="p">)],</span>
                        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🏠 תפריט ראשי&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)],</span>
                    <span class="p">]</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># שמור הצעות ב-session</span>
        <span class="n">session</span><span class="p">[</span><span class="s2">&quot;suggestions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">suggestions</span>

        <span class="c1"># צור כפתורים להצעות (מקסימום 8 הצעות)</span>
        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">suggestion</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">suggestions</span><span class="p">[:</span><span class="mi">8</span><span class="p">]):</span>
            <span class="n">impact_emoji</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;🔴&quot;</span>
                <span class="k">if</span> <span class="n">suggestion</span><span class="p">[</span><span class="s2">&quot;impact&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;high&quot;</span>
                <span class="k">else</span> <span class="s2">&quot;🟡&quot;</span> <span class="k">if</span> <span class="n">suggestion</span><span class="p">[</span><span class="s2">&quot;impact&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;medium&quot;</span> <span class="k">else</span> <span class="s2">&quot;🟢&quot;</span>
            <span class="p">)</span>
            <span class="n">button_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">impact_emoji</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">suggestion</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">button_text</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;suggestion_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>

        <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור לסיכום&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;back_to_analysis&quot;</span><span class="p">)])</span>

        <span class="c1"># Escape HTML special characters</span>
        <span class="n">repo_name</span> <span class="o">=</span> <span class="n">safe_html_escape</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;last_analysis&quot;</span><span class="p">][</span><span class="s2">&quot;repo_name&quot;</span><span class="p">])</span>

        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;💡 &lt;b&gt;הצעות לשיפור לריפו </span><span class="si">{</span><span class="n">repo_name</span><span class="si">}</span><span class="s2">&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;נמצאו </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">suggestions</span><span class="p">)</span><span class="si">}</span><span class="s2"> הצעות לשיפור.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;בחר הצעה לפרטים נוספים:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;🔴 = השפעה גבוהה | 🟡 = בינונית | 🟢 = נמוכה&quot;</span>

        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
            <span class="n">message</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.show_suggestion_details">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_suggestion_details">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">show_suggestion_details</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">suggestion_index</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;מציג פרטי הצעה ספציפית&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
            <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

            <span class="n">suggestions</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;suggestions&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="n">suggestion_index</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">suggestions</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;❌ הצעה לא נמצאה&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="n">suggestion</span> <span class="o">=</span> <span class="n">suggestions</span><span class="p">[</span><span class="n">suggestion_index</span><span class="p">]</span>

            <span class="c1"># מיפוי השפעה ומאמץ לעברית</span>
            <span class="n">impact_map</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;high&quot;</span><span class="p">:</span> <span class="s2">&quot;גבוהה&quot;</span><span class="p">,</span> <span class="s2">&quot;medium&quot;</span><span class="p">:</span> <span class="s2">&quot;בינונית&quot;</span><span class="p">,</span> <span class="s2">&quot;low&quot;</span><span class="p">:</span> <span class="s2">&quot;נמוכה&quot;</span><span class="p">}</span>
            <span class="n">effort_map</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;high&quot;</span><span class="p">:</span> <span class="s2">&quot;גבוה&quot;</span><span class="p">,</span> <span class="s2">&quot;medium&quot;</span><span class="p">:</span> <span class="s2">&quot;בינוני&quot;</span><span class="p">,</span> <span class="s2">&quot;low&quot;</span><span class="p">:</span> <span class="s2">&quot;נמוך&quot;</span><span class="p">}</span>

            <span class="c1"># Use safe HTML escaping to prevent parsing errors</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">safe_html_escape</span><span class="p">(</span><span class="n">suggestion</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;הצעה&quot;</span><span class="p">))</span>
            <span class="n">why</span> <span class="o">=</span> <span class="n">safe_html_escape</span><span class="p">(</span><span class="n">suggestion</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;why&quot;</span><span class="p">,</span> <span class="s2">&quot;לא צוין&quot;</span><span class="p">))</span>
            <span class="n">how</span> <span class="o">=</span> <span class="n">safe_html_escape</span><span class="p">(</span><span class="n">suggestion</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;how&quot;</span><span class="p">,</span> <span class="s2">&quot;לא צוין&quot;</span><span class="p">))</span>
            <span class="n">impact</span> <span class="o">=</span> <span class="n">safe_html_escape</span><span class="p">(</span><span class="n">impact_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">suggestion</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;impact&quot;</span><span class="p">,</span> <span class="s2">&quot;medium&quot;</span><span class="p">),</span> <span class="s2">&quot;בינונית&quot;</span><span class="p">))</span>
            <span class="n">effort</span> <span class="o">=</span> <span class="n">safe_html_escape</span><span class="p">(</span><span class="n">effort_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">suggestion</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;effort&quot;</span><span class="p">,</span> <span class="s2">&quot;medium&quot;</span><span class="p">),</span> <span class="s2">&quot;בינוני&quot;</span><span class="p">))</span>

            <span class="c1"># בנה הודעה בטוחה</span>
            <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;b&gt;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;❓ &lt;b&gt;למה:&lt;/b&gt; </span><span class="si">{</span><span class="n">why</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;💡 &lt;b&gt;איך:&lt;/b&gt; </span><span class="si">{</span><span class="n">how</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;📊 &lt;b&gt;השפעה:&lt;/b&gt; </span><span class="si">{</span><span class="n">impact</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;⚡ &lt;b&gt;מאמץ:&lt;/b&gt; </span><span class="si">{</span><span class="n">effort</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># הוסף כפתור למידע נוסף בהתאם לקטגוריה</span>
            <span class="n">suggestion_id</span> <span class="o">=</span> <span class="n">suggestion</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">suggestion_id</span> <span class="o">==</span> <span class="s2">&quot;add_license&quot;</span><span class="p">:</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📚 מידע על רישיונות&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://choosealicense.com/&quot;</span><span class="p">)]</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">suggestion_id</span> <span class="o">==</span> <span class="s2">&quot;add_gitignore&quot;</span><span class="p">:</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📚 יצירת .gitignore&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://gitignore.io/&quot;</span><span class="p">)]</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">suggestion_id</span> <span class="o">==</span> <span class="s2">&quot;add_ci_cd&quot;</span><span class="p">:</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                            <span class="s2">&quot;📚 GitHub Actions&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://docs.github.com/en/actions&quot;</span>
                        <span class="p">)</span>
                    <span class="p">]</span>
                <span class="p">)</span>

            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור להצעות&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;show_suggestions&quot;</span><span class="p">)]</span>
            <span class="p">)</span>

            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="n">message</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span>
            <span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in show_suggestion_details: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Fallback to simple text without HTML</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">simple_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;הצעה #</span><span class="si">{</span><span class="n">suggestion_index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="s2">&quot;suggestion&quot;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
                    <span class="n">simple_text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">suggestion</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;הצעה&#39;</span><span class="p">)</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="n">simple_text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;למה: </span><span class="si">{</span><span class="n">suggestion</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;why&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;לא צוין&#39;</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="n">simple_text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;איך: </span><span class="si">{</span><span class="n">suggestion</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;how&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;לא צוין&#39;</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">simple_text</span> <span class="o">+=</span> <span class="s2">&quot;לא ניתן להציג את פרטי ההצעה&quot;</span>

                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                    <span class="n">simple_text</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span>
                        <span class="p">[[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;show_suggestions&quot;</span><span class="p">)]]</span>
                    <span class="p">),</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">fallback_error</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fallback also failed: </span><span class="si">{</span><span class="n">fallback_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;❌ שגיאה בהצגת ההצעה&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.show_full_analysis">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_full_analysis">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">show_full_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;מציג ניתוח מלא&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>

        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

        <span class="n">analysis</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;last_analysis&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">analysis</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;❌ לא נמצא ניתוח&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># צור דוח מפורט - Escape HTML special characters</span>
        <span class="n">repo_name</span> <span class="o">=</span> <span class="n">safe_html_escape</span><span class="p">(</span><span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;repo_name&quot;</span><span class="p">])</span>
        <span class="n">repo_url</span> <span class="o">=</span> <span class="n">safe_html_escape</span><span class="p">(</span><span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;repo_url&quot;</span><span class="p">])</span>
        <span class="n">description</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">safe_html_escape</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">analysis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">)</span>
            <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>
        <span class="n">language</span> <span class="o">=</span> <span class="n">safe_html_escape</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;language&quot;</span><span class="p">,</span> <span class="s2">&quot;לא זוהתה&quot;</span><span class="p">))</span>

        <span class="n">report</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;📊 &lt;b&gt;דוח מלא - </span><span class="si">{</span><span class="n">repo_name</span><span class="si">}</span><span class="s2">&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>

        <span class="c1"># מידע בסיסי</span>
        <span class="n">report</span> <span class="o">+=</span> <span class="s2">&quot;&lt;b&gt;📌 מידע כללי:&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;• URL: </span><span class="si">{</span><span class="n">repo_url</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">description</span><span class="p">:</span>
            <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;• תיאור: </span><span class="si">{</span><span class="n">description</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;• שפה: </span><span class="si">{</span><span class="n">language</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;• כוכבים: ⭐ </span><span class="si">{</span><span class="n">analysis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;stars&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;• Forks: 🍴 </span><span class="si">{</span><span class="n">analysis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;forks&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="c1"># קבצים</span>
        <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&lt;b&gt;📁 קבצים:&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;• סה״כ קבצי קוד: </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;file_count&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;files_by_type&quot;</span><span class="p">]:</span>
            <span class="n">report</span> <span class="o">+=</span> <span class="s2">&quot;• לפי סוג:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">ext</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span>
                <span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;files_by_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">):</span>
                <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="c1"># בעיות</span>
        <span class="k">if</span> <span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;large_files&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;long_functions&quot;</span><span class="p">]:</span>
            <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&lt;b&gt;⚠️ בעיות פוטנציאליות:&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;large_files&quot;</span><span class="p">]:</span>
                <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;• </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;large_files&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> קבצים גדולים (500+ שורות)</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;long_functions&quot;</span><span class="p">]:</span>
                <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;• </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;long_functions&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> פונקציות ארוכות (50+ שורות)</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="c1"># תלויות</span>
        <span class="k">if</span> <span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;dependencies&quot;</span><span class="p">]:</span>
            <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&lt;b&gt;📦 תלויות (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;dependencies&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">):&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="c1"># הצג רק 10 הראשונות</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;dependencies&quot;</span><span class="p">][:</span><span class="mi">10</span><span class="p">]:</span>
                <span class="n">dep_name</span> <span class="o">=</span> <span class="n">safe_html_escape</span><span class="p">(</span><span class="n">dep</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
                <span class="n">dep_type</span> <span class="o">=</span> <span class="n">safe_html_escape</span><span class="p">(</span><span class="n">dep</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">])</span>
                <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;• </span><span class="si">{</span><span class="n">dep_name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">dep_type</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;dependencies&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;• ... ועוד </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;dependencies&#39;</span><span class="p">])</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">10</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור לסיכום&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;back_to_analysis&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🏠 תפריט ראשי&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)],</span>
        <span class="p">]</span>

        <span class="c1"># חלק את ההודעה אם היא ארוכה מדי</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">report</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4000</span><span class="p">:</span>
            <span class="n">report</span> <span class="o">=</span> <span class="n">report</span><span class="p">[:</span><span class="mi">3900</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">... (קוצר לצורך תצוגה)&quot;</span>

        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
            <span class="n">report</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.download_analysis_json">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.download_analysis_json">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">download_analysis_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;שולח קובץ JSON עם הניתוח המלא&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>

        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

        <span class="n">analysis</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;last_analysis&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">analysis</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;❌ לא נמצא ניתוח&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># הוסף גם את ההצעות לדוח</span>
        <span class="n">analyzer</span> <span class="o">=</span> <span class="n">RepoAnalyzer</span><span class="p">()</span>
        <span class="n">suggestions</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">generate_improvement_suggestions</span><span class="p">(</span><span class="n">analysis</span><span class="p">)</span>

        <span class="n">full_report</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;analysis&quot;</span><span class="p">:</span> <span class="n">analysis</span><span class="p">,</span>
            <span class="s2">&quot;suggestions&quot;</span><span class="p">:</span> <span class="n">suggestions</span><span class="p">,</span>
            <span class="s2">&quot;generated_at&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
        <span class="p">}</span>

        <span class="c1"># צור קובץ JSON</span>
        <span class="n">json_content</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">full_report</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># שלח כקובץ</span>
        <span class="kn">import</span> <span class="nn">io</span>

        <span class="n">file</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">json_content</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
        <span class="n">file</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;repo_analysis_</span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;repo_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.json&quot;</span>

        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_document</span><span class="p">(</span>
            <span class="n">document</span><span class="o">=</span><span class="n">file</span><span class="p">,</span>
            <span class="n">filename</span><span class="o">=</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">caption</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;📊 דוח ניתוח מלא עבור </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;repo_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># חזור לתפריט</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_analyze_results_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.show_analyze_results_menu">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_analyze_results_menu">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">show_analyze_results_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;מציג מחדש את תפריט התוצאות&quot;&quot;&quot;</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

        <span class="n">analysis</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;last_analysis&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">analysis</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_analysis_summary</span><span class="p">(</span><span class="n">analysis</span><span class="p">)</span>

        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🎯 הצג הצעות לשיפור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;show_suggestions&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📥 הורד דוח JSON&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;download_analysis_json&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔍 נתח ריפו אחר&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;analyze_other_repo&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור לתפריט&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)],</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="n">summary</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="n">summary</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span>
            <span class="p">)</span></div>


    <span class="k">async</span> <span class="k">def</span> <span class="nf">_send_or_edit_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;שולח או עורך הודעה בהתאם לסוג ה-update&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="GitHubMenuHandler.handle_repo_url_input">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.handle_repo_url_input">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">handle_repo_url_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;מטפל בקלט של URL לניתוח&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;🔗 Handling repo URL input: waiting=</span><span class="si">{</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;waiting_for_repo_url&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;waiting_for_repo_url&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">text</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">text</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📌 Received URL: </span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_repo_url&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># בדוק אם זה URL של GitHub</span>
        <span class="k">if</span> <span class="s2">&quot;github.com&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;❌ נא לשלוח URL תקין של GitHub</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="s2">&quot;לדוגמה: https://github.com/owner/repo&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔍 נסה שוב&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;analyze_other_repo&quot;</span><span class="p">)],</span>
                        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור לתפריט&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)],</span>
                    <span class="p">]</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># נתח את הריפו</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_repository</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.show_delete_file_menu">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_delete_file_menu">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">show_delete_file_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;מציג תפריט מחיקת קובץ מהריפו (דפדוף בכפתורים)&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">repo</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ לא נבחר ריפו&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;delete&quot;</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># מצב מרובה ומחיקה בטוחה לאיפוס</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;multi_mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;multi_selection&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;safe_delete&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_repo_browser</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.show_delete_repo_menu">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_delete_repo_menu">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">show_delete_repo_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;מציג תפריט מחיקת ריפו שלם עם אזהרות&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">repo</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ לא נבחר ריפו&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                    <span class="s2">&quot;✅ אני מבין/ה ומאשר/ת מחיקה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;confirm_delete_repo_step1&quot;</span>
                <span class="p">)</span>
            <span class="p">],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)],</span>
        <span class="p">]</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
            <span class="s2">&quot;⚠️ מחיקת ריפו שלם הינה פעולה בלתי הפיכה!</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;- יימחקו כל הקבצים, ה-Issues, ה-PRs וה-Settings</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;- לא ניתן לשחזר לאחר המחיקה</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;ריפו למחיקה: &lt;code&gt;</span><span class="si">{</span><span class="n">repo</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;אם ברצונך להמשיך, לחץ על האישור ואז תתבקש לאשר שוב.&quot;</span><span class="p">,</span>
            <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span>
            <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.confirm_delete_file">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.confirm_delete_file">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">confirm_delete_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;מבצע מחיקת קובץ לאחר אישור&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pending_delete_file_path&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_name</span> <span class="ow">and</span> <span class="n">file_path</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ נתונים חסרים למחיקה&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span>
            <span class="c1"># בדוק אם הקובץ קיים וקבל sha לצורך מחיקה</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
            <span class="n">default_branch</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">default_branch</span> <span class="ow">or</span> <span class="s2">&quot;main&quot;</span>
            <span class="n">repo</span><span class="o">.</span><span class="n">delete_file</span><span class="p">(</span>
                <span class="n">contents</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Delete via bot: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">contents</span><span class="o">.</span><span class="n">sha</span><span class="p">,</span> <span class="n">branch</span><span class="o">=</span><span class="n">default_branch</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;✅ הקובץ נמחק בהצלחה: &lt;code&gt;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error deleting file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה במחיקת קובץ: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;pending_delete_file_path&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">github_menu_command</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.confirm_delete_repo_step1">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.confirm_delete_repo_step1">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">confirm_delete_repo_step1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;מסך אישור סופי לפני מחיקת ריפו, מפנה ללחצן מחיקה סופי&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">repo</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ לא נבחר ריפו&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🧨 כן, מחק לצמיתות&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;confirm_delete_repo&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 ביטול&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)],</span>
        <span class="p">]</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;⚠️ אישור סופי למחיקת &lt;code&gt;</span><span class="si">{</span><span class="n">repo</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;פעולה זו תמחק לצמיתות את הריפו וכל התוכן המשויך אליו.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;אין דרך לשחזר לאחר מכן.&quot;</span><span class="p">,</span>
            <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span>
            <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.confirm_delete_repo">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.confirm_delete_repo">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">confirm_delete_repo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;מבצע מחיקת ריפו שלם לאחר אישור&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_name</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ נתונים חסרים למחיקה&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span>
            <span class="n">owner</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_user</span><span class="p">()</span>
            <span class="c1"># ודא שלמשתמש יש הרשאה למחוק</span>
            <span class="k">if</span> <span class="n">repo</span><span class="o">.</span><span class="n">owner</span><span class="o">.</span><span class="n">login</span> <span class="o">!=</span> <span class="n">owner</span><span class="o">.</span><span class="n">login</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ ניתן למחוק רק ריפו שאתה בעליו&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">repo</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="c1"># נקה קאש ריפוזיטוריז כדי שהרשימה תרוענן ולא תציג פריטים שנמחקו</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;repos&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;repos_cache_time&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;✅ הריפו נמחק בהצלחה: &lt;code&gt;</span><span class="si">{</span><span class="n">repo_name</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span>
            <span class="p">)</span>
            <span class="c1"># נקה בחירה לאחר מחיקה</span>
            <span class="n">session</span><span class="p">[</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error deleting repository: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה במחיקת ריפו: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># לאחר מחיקה, ודא שקאש הרשימות אינו משאיר את הריפו הישן</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;repos&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;repos_cache_time&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">github_menu_command</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.show_danger_delete_menu">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_danger_delete_menu">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">show_danger_delete_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;מציג תפריט מחיקות מסוכן&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">repo</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ לא נבחר ריפו&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🗑️ מחק קובץ מהריפו&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;delete_file_menu&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;⚠️ מחק ריפו שלם (מתקדם)&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;delete_repo_menu&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)],</span>
        <span class="p">]</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;🧨 פעולות מחיקה ב-&lt;code&gt;</span><span class="si">{</span><span class="n">repo</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">בחר פעולה:&quot;</span><span class="p">,</span>
            <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span>
            <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.show_download_file_menu">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_download_file_menu">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">show_download_file_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;מציג תפריט הורדת קובץ מהריפו (דפדוף בכפתורים)&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">repo</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ לא נבחר ריפו&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># התחל בדפדוף מה-root במצב הורדה בלבד</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;download&quot;</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># אפס מצב מחיקה אם הופעל קודם</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;multi_mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;multi_selection&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;safe_delete&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_repo_browser</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>

<div class="viewcode-block" id="GitHubMenuHandler.show_repo_browser">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_repo_browser">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">show_repo_browser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">only_keyboard</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;מציג דפדפן ריפו לפי נתיב ושימוש (view/download/delete), כולל breadcrumbs ועימוד.&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_name</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ חסרים נתונים&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;browse_path&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="c1"># קביעת ref נוכחי לניווט (ענף/תג)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">current_ref</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;browse_ref&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="s2">&quot;default_branch&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;main&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">current_ref</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="s2">&quot;default_branch&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;main&quot;</span>
        <span class="c1"># קבלת תוכן התיקייה</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="n">path</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">current_ref</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="n">path</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">contents</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="c1"># אם זה קובץ יחיד, הפוך לרשימה לצורך תצוגה</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="p">[</span><span class="n">contents</span><span class="p">]</span>
        <span class="c1"># בניית פריטים (תיקיות קודם, אחר כך קבצים)</span>
        <span class="n">folders</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">contents</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;dir&quot;</span><span class="p">]</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">contents</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;file&quot;</span><span class="p">]</span>
        <span class="c1"># במצב בחירת תיקייה, לא נציג קבצים כלל</span>
        <span class="n">folder_selecting</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;folder_select_mode&quot;</span><span class="p">))</span>
        <span class="n">entry_rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Breadcrumbs</span>
        <span class="n">crumbs_row</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">crumbs_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🏠 root&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mk_cb</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;browse_open&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">accum</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
                <span class="n">accum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
                <span class="n">crumbs_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mk_cb</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;browse_open&quot;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">accum</span><span class="p">))))</span>
        <span class="k">if</span> <span class="n">crumbs_row</span><span class="p">:</span>
            <span class="n">entry_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">crumbs_row</span><span class="p">)</span>
        <span class="c1"># שורת כלים: חיפוש ובחירת ref</span>
        <span class="n">tools_row</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔎 חפש בשם קובץ&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;browse_search&quot;</span><span class="p">),</span>
            <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🌿 ref: </span><span class="si">{</span><span class="n">current_ref</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;browse_ref_menu&quot;</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="n">entry_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tools_row</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">folders</span><span class="p">:</span>
            <span class="c1"># תמיד מציגים פתיחת תיקייה; אין צורך בכפתור &quot;בחר כיעד&quot; (הוסרה דרישתך)</span>
            <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;📂 </span><span class="si">{</span><span class="n">folder</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mk_cb</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;browse_open&quot;</span><span class="p">,</span> <span class="n">folder</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="p">)]</span>
            <span class="n">entry_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="n">multi_mode</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;multi_mode&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;multi_selection&quot;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">folder_selecting</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">multi_mode</span><span class="p">:</span>
                    <span class="n">checked</span> <span class="o">=</span> <span class="s2">&quot;☑️&quot;</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">path</span> <span class="ow">in</span> <span class="n">selection</span> <span class="k">else</span> <span class="s2">&quot;⬜️&quot;</span>
                    <span class="n">entry_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">checked</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;browse_toggle_select:</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                        <span class="p">]</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mode</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;browse_action&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;download&quot;</span><span class="p">:</span>
                        <span class="n">size_val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span>
                        <span class="n">large_flag</span> <span class="o">=</span> <span class="s2">&quot; ⚠️&quot;</span> <span class="k">if</span> <span class="n">size_val</span> <span class="ow">and</span> <span class="n">size_val</span> <span class="o">&gt;</span> <span class="n">MAX_INLINE_FILE_BYTES</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                        <span class="n">entry_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">[</span>
                                <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;⬇️ </span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="si">}{</span><span class="n">large_flag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                    <span class="n">callback_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mk_cb</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;browse_select_download&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">path</span><span class="p">),</span>
                                <span class="p">)</span>
                            <span class="p">]</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;view&quot;</span><span class="p">:</span>
                        <span class="c1"># הסר כפתור &quot;שתף קישור&quot; מרשימה; נשאיר רק במסך התצוגה</span>
                        <span class="n">entry_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">[</span>
                                <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;👁️ </span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mk_cb</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;browse_select_view&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
                                <span class="p">)</span>
                            <span class="p">]</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># במצב שאינו download ואינו view — זה מצב delete בלבד</span>
                        <span class="n">entry_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">[</span>
                                <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;🗑️ </span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mk_cb</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;browse_select_delete&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
                                <span class="p">)</span>
                            <span class="p">]</span>
                        <span class="p">)</span>
        <span class="c1"># ודא דגלים ברירת מחדל כדי למנוע שגיאות בניווט</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;browse_page&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;browse_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;multi_mode&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;multi_mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># עימוד</span>
        <span class="n">page_size</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="c1"># ודא ששורת הכלים (חיפוש/בחירת ref) תמיד נשמרת בראש כל עמוד</span>
        <span class="c1"># נבנה את המטריצה כך שהשורה הראשונה תהיה תמיד הכלים, ולא תיספר לעימוד</span>
        <span class="c1"># מצא אינדקס תחילת הפריטים לעימוד אחרי breadcrumbs ושורת כלים</span>
        <span class="c1"># breadcrumbs נמצאת ב-entry_rows[0] (אם קיימת), ושורת כלים ב-entry_rows[1]</span>
        <span class="n">start_items_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">entry_rows</span><span class="p">:</span>
            <span class="c1"># אם יש breadcrumbs, הם באינדקס 0</span>
            <span class="n">start_items_index</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="c1"># אם יש גם שורת כלים, היא באינדקס 1</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">entry_rows</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">btn</span><span class="p">,</span> <span class="n">InlineKeyboardButton</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">btn</span><span class="p">,</span> <span class="s1">&#39;callback_data&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;browse_search&#39;</span>
                <span class="k">for</span> <span class="n">btn</span> <span class="ow">in</span> <span class="n">entry_rows</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="n">start_items_index</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">paginable_rows</span> <span class="o">=</span> <span class="n">entry_rows</span><span class="p">[</span><span class="n">start_items_index</span><span class="p">:]</span>
        <span class="n">total_items</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">paginable_rows</span><span class="p">)</span>
        <span class="n">total_pages</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">total_items</span> <span class="o">+</span> <span class="n">page_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">page_size</span><span class="p">)</span>
        <span class="n">current_page</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;browse_page&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span> <span class="n">total_pages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">start_index</span> <span class="o">=</span> <span class="n">current_page</span> <span class="o">*</span> <span class="n">page_size</span>
        <span class="n">end_index</span> <span class="o">=</span> <span class="n">start_index</span> <span class="o">+</span> <span class="n">page_size</span>
        <span class="c1"># בנה מקלדת: breadcrumbs (אם קיימת) + שורת כלים + פריטי העמוד</span>
        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">entry_rows</span> <span class="ow">and</span> <span class="n">start_items_index</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry_rows</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># breadcrumbs</span>
        <span class="k">if</span> <span class="n">entry_rows</span> <span class="ow">and</span> <span class="n">start_items_index</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry_rows</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># tools row (כולל חיפוש)</span>
        <span class="n">keyboard</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">paginable_rows</span><span class="p">[</span><span class="n">start_index</span><span class="p">:</span><span class="n">end_index</span><span class="p">])</span>
        <span class="c1"># ניווט עמודים</span>
        <span class="k">if</span> <span class="n">total_pages</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">nav_row</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">current_page</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">nav_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;⬅️ הקודם&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;browse_page:</span><span class="si">{</span><span class="n">current_page</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">nav_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;עמוד </span><span class="si">{</span><span class="n">current_page</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total_pages</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;noop&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">current_page</span> <span class="o">&lt;</span> <span class="n">total_pages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">nav_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;הבא ➡️&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;browse_page:</span><span class="si">{</span><span class="n">current_page</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nav_row</span><span class="p">)</span>
        <span class="c1"># שורה תחתונה</span>
        <span class="n">bottom</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
            <span class="c1"># חזרה למעלה</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">bottom</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;⬆️ למעלה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mk_cb</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;browse_open&quot;</span><span class="p">,</span> <span class="n">parent</span><span class="p">)))</span>
        <span class="c1"># כפתור חזרה/סיום לבחירת תיקייה</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;folder_select_mode&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;session&quot;</span><span class="p">:</span>
            <span class="n">bottom</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;✅ סיום בחירה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;folder_select_done&quot;</span><span class="p">))</span>
            <span class="n">bottom</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 ביטול&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">))</span>
            <span class="c1"># הוסף כפתור יצירת תיקייה חדשה במצב בחירת תיקייה</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;➕ צור תיקייה חדשה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;create_folder&quot;</span><span class="p">)])</span>
        <span class="c1"># סדר כפתורים לשורות כדי למנוע צפיפות</span>
        <span class="n">row</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">folder_selecting</span><span class="p">)</span> <span class="ow">and</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;browse_action&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;download&quot;</span><span class="p">:</span>
            <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📦 הורד תיקייה כ־ZIP&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mk_cb</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;download_zip&quot;</span><span class="p">,</span> <span class="n">path</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="n">row</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">folder_selecting</span><span class="p">)</span> <span class="ow">and</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;browse_action&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;download&quot;</span><span class="p">:</span>
            <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔗 שתף קישור לתיקייה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mk_cb</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;share_folder_link&quot;</span><span class="p">,</span> <span class="n">path</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">folder_selecting</span><span class="p">:</span>
            <span class="c1"># במצב הורדה לא מציגים כלל כפתורי מחיקה/בחירה מרובה למחיקה</span>
            <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;browse_action&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;download&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">multi_mode</span><span class="p">:</span>
                    <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                    <span class="n">row</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📦 הורד נבחרים כ־ZIP&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;multi_execute&quot;</span><span class="p">))</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔗 שתף קישורים לנבחרים&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;share_selected_links&quot;</span><span class="p">))</span>
                    <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                    <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;♻️ נקה בחירה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;multi_clear&quot;</span><span class="p">),</span> <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🚫 בטל מצב מרובה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;multi_toggle&quot;</span><span class="p">)]</span>
                    <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;✅ בחר מרובים&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;multi_toggle&quot;</span><span class="p">))</span>
                    <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># מצב delete/view – התנהגות קיימת</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">multi_mode</span><span class="p">:</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;✅ בחר מרובים&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;multi_toggle&quot;</span><span class="p">))</span>
                    <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                    <span class="n">row</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">safe_label</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;מצב מחיקה בטוח: פעיל&quot;</span> <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;safe_delete&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;מצב מחיקה בטוח: כבוי&quot;</span>
                    <span class="p">)</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">safe_label</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;safe_toggle&quot;</span><span class="p">))</span>
                    <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                    <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🗑️ מחק נבחרים&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;multi_execute&quot;</span><span class="p">),</span> <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔗 שתף קישורים לנבחרים&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;share_selected_links&quot;</span><span class="p">)]</span>
                    <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                    <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;♻️ נקה בחירה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;multi_clear&quot;</span><span class="p">),</span> <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🚫 בטל מצב מרובה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;multi_toggle&quot;</span><span class="p">)]</span>
                    <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזרה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">bottom</span><span class="p">:</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bottom</span><span class="p">)</span>
        <span class="c1"># טקסט</span>
        <span class="n">_mode</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;browse_action&quot;</span><span class="p">)</span>
        <span class="n">action</span> <span class="o">=</span> <span class="s2">&quot;תצוגה&quot;</span> <span class="k">if</span> <span class="n">_mode</span> <span class="o">==</span> <span class="s2">&quot;view&quot;</span> <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;הורדה&quot;</span> <span class="k">if</span> <span class="n">_mode</span> <span class="o">==</span> <span class="s2">&quot;download&quot;</span> <span class="k">else</span> <span class="s2">&quot;מחיקה&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">only_keyboard</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">TelegramUtils</span><span class="o">.</span><span class="n">safe_edit_message_reply_markup</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">))</span>
                <span class="k">return</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">if</span> <span class="n">folder_selecting</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">TelegramUtils</span><span class="o">.</span><span class="n">safe_edit_message_text</span><span class="p">(</span>
                    <span class="n">query</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;📁 דפדוף ריפו: &lt;code&gt;</span><span class="si">{</span><span class="n">repo_name</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;🔀 ref: &lt;code&gt;</span><span class="si">{</span><span class="n">current_ref</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;📂 נתיב: &lt;code&gt;/</span><span class="si">{</span><span class="n">path</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;בחר תיקייה יעד או פתח תיקייה (מציג </span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="n">page_size</span><span class="p">,</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">total_items</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_index</span><span class="p">))</span><span class="si">}</span><span class="s2"> מתוך </span><span class="si">{</span><span class="n">total_items</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span>
                    <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">TelegramUtils</span><span class="o">.</span><span class="n">safe_edit_message_text</span><span class="p">(</span>
                    <span class="n">query</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;📁 דפדוף ריפו: &lt;code&gt;</span><span class="si">{</span><span class="n">repo_name</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;🔀 ref: &lt;code&gt;</span><span class="si">{</span><span class="n">current_ref</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;📂 נתיב: &lt;code&gt;/</span><span class="si">{</span><span class="n">path</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;בחר קובץ ל</span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2"> או פתח תיקייה (מציג </span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="n">page_size</span><span class="p">,</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">total_items</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_index</span><span class="p">))</span><span class="si">}</span><span class="s2"> מתוך </span><span class="si">{</span><span class="n">total_items</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span>
                    <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">folder_selecting</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;📁 דפדוף ריפו: &lt;code&gt;</span><span class="si">{</span><span class="n">repo_name</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;🔀 ref: &lt;code&gt;</span><span class="si">{</span><span class="n">current_ref</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;📂 נתיב: &lt;code&gt;/</span><span class="si">{</span><span class="n">path</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;בחר תיקייה יעד או פתח תיקייה (מציג </span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="n">page_size</span><span class="p">,</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">total_items</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_index</span><span class="p">))</span><span class="si">}</span><span class="s2"> מתוך </span><span class="si">{</span><span class="n">total_items</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span>
                    <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;📁 דפדוף ריפו: &lt;code&gt;</span><span class="si">{</span><span class="n">repo_name</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;🔀 ref: &lt;code&gt;</span><span class="si">{</span><span class="n">current_ref</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;📂 נתיב: &lt;code&gt;/</span><span class="si">{</span><span class="n">path</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;בחר קובץ ל</span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2"> או פתח תיקייה (מציג </span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="n">page_size</span><span class="p">,</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">total_items</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_index</span><span class="p">))</span><span class="si">}</span><span class="s2"> מתוך </span><span class="si">{</span><span class="n">total_items</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">,</span>
                        <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span>
                        <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                        <span class="k">raise</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.handle_inline_query">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.handle_inline_query">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">handle_inline_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Inline mode: חיפוש/ביצוע פעולות ישירות מכל צ&#39;אט&quot;&quot;&quot;</span>
        <span class="n">inline_query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">inline_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">inline_query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="p">(</span><span class="n">inline_query</span><span class="o">.</span><span class="n">query</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_name</span><span class="p">):</span>
            <span class="c1"># בקש מהמשתמש לבחור ריפו</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">InlineQueryResultArticle</span><span class="p">(</span>
                    <span class="nb">id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;help-no-repo&quot;</span><span class="p">,</span>
                    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;בחר/התחבר לריפו לפני שימוש באינליין&quot;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;שלח /github לבחירת ריפו ו/או התחברות&quot;</span><span class="p">,</span>
                    <span class="n">input_message_content</span><span class="o">=</span><span class="n">InputTextMessageContent</span><span class="p">(</span>
                        <span class="s2">&quot;🔧 שלח /github לבחירת ריפו ולהתחברות ל-GitHub&quot;</span>
                    <span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="n">inline_query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">cache_time</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">is_personal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span>
        <span class="c1"># ללא קלט: אל תחזיר תוצאות (מבטל &#39;פקודות&#39; אינליין מיותרות)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">q</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">inline_query</span><span class="o">.</span><span class="n">answer</span><span class="p">([],</span> <span class="n">cache_time</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">is_personal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># פרסור פשוט: zip &lt;path&gt; / file &lt;path&gt; או נתיב ישיר</span>
        <span class="n">is_zip</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">is_file</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">q</span>
        <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;zip &quot;</span><span class="p">):</span>
            <span class="c1"># מבטלים תמיכת zip באינליין</span>
            <span class="k">await</span> <span class="n">inline_query</span><span class="o">.</span><span class="n">answer</span><span class="p">([],</span> <span class="n">cache_time</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">is_personal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">q</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;file &quot;</span><span class="p">):</span>
            <span class="n">is_file</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="c1"># תיקייה</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">contents</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="c1"># הצג כמה קבצים ראשונים בתיקייה להורדה מהירה (ללא הצעת ZIP)</span>
                <span class="n">shown</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">contents</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;file&quot;</span><span class="p">:</span>
                        <span class="n">size_str</span> <span class="o">=</span> <span class="n">format_bytes</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">InlineQueryResultArticle</span><span class="p">(</span>
                                <span class="nb">id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;file-</span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;⬇️ </span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">size_str</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
                                <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                <span class="n">input_message_content</span><span class="o">=</span><span class="n">InputTextMessageContent</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;קובץ: /</span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="p">),</span>
                                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span>
                                    <span class="p">[</span>
                                        <span class="p">[</span>
                                            <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                                        <span class="s2">&quot;📩 הורד&quot;</span><span class="p">,</span>
                                                <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;inline_download_file:</span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                            <span class="p">)</span>
                                        <span class="p">]</span>
                                    <span class="p">]</span>
                                <span class="p">),</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">shown</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">shown</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>
                            <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># קובץ בודד</span>
                <span class="n">size_str</span> <span class="o">=</span> <span class="n">format_bytes</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">contents</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
                <span class="c1"># נסה להוציא snippet קצר מהתוכן (ללא עלות גבוהה מדי)</span>
                <span class="n">snippet</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">raw</span> <span class="o">=</span> <span class="n">contents</span><span class="o">.</span><span class="n">decoded_content</span> <span class="ow">or</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">)</span>
                    <span class="c1"># קח 3 שורות ראשונות/עד 180 תווים</span>
                    <span class="n">first_lines</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[:</span><span class="mi">3</span><span class="p">])</span>
                    <span class="n">snippet</span> <span class="o">=</span> <span class="n">first_lines</span><span class="p">[:</span><span class="mi">180</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot; ⏎ &quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">snippet</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">desc</span> <span class="o">=</span> <span class="n">snippet</span> <span class="k">if</span> <span class="n">snippet</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">InlineQueryResultArticle</span><span class="p">(</span>
                        <span class="nb">id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;file-</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;⬇️ הורד: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">contents</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">size_str</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
                        <span class="n">description</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span>
                        <span class="n">input_message_content</span><span class="o">=</span><span class="n">InputTextMessageContent</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;קובץ: /</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                        <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span>
                            <span class="p">[</span>
                                <span class="p">[</span>
                                    <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                                        <span class="s2">&quot;📩 הורד&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;inline_download_file:</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span>
                                    <span class="p">)</span>
                                <span class="p">]</span>
                            <span class="p">]</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># החזר רק תוצאת קובץ אם נתבקשה מפורשות</span>
            <span class="k">if</span> <span class="n">is_file</span> <span class="ow">and</span> <span class="n">path</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">InlineQueryResultArticle</span><span class="p">(</span>
                        <span class="nb">id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;file-maybe-</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;⬇️ קובץ: /</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;ניסיון הורדה לקובץ (אם קיים)&quot;</span><span class="p">,</span>
                        <span class="n">input_message_content</span><span class="o">=</span><span class="n">InputTextMessageContent</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;קובץ: /</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                        <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span>
                            <span class="p">[</span>
                                <span class="p">[</span>
                                    <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                                        <span class="s2">&quot;📩 הורד&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;inline_download_file:</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span>
                                    <span class="p">)</span>
                                <span class="p">]</span>
                            <span class="p">]</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># בלי הודעות עזרה/דמה – נחזיר ריק</span>
                <span class="k">pass</span>
        <span class="k">await</span> <span class="n">inline_query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="n">results</span><span class="p">[:</span><span class="mi">50</span><span class="p">],</span> <span class="n">cache_time</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">is_personal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.show_notifications_menu">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_notifications_menu">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">show_notifications_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ בחר ריפו קודם (/github)&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;notifications&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">enabled</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;enabled&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">pr_on</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pr&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">issues_on</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;issues&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">interval</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;interval&quot;</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
        <span class="c1"># הצגת תדירות: אם פחות מדקה, הצג בשניות; אחרת בדקות</span>
        <span class="n">freq_display</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">interval</span><span class="si">}</span><span class="s2"> שנ׳&quot;</span> <span class="k">if</span> <span class="n">interval</span> <span class="o">&lt;</span> <span class="mi">60</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">interval</span><span class="o">/</span><span class="mi">60</span><span class="p">)</span><span class="si">}</span><span class="s2"> ד׳&quot;</span>
        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)],</span>
            <span class="p">[</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                    <span class="s2">&quot;הפעל&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">enabled</span> <span class="k">else</span> <span class="s2">&quot;כבה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;notifications_toggle&quot;</span>
                <span class="p">)</span>
            <span class="p">],</span>
            <span class="p">[</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;PRs: </span><span class="si">{</span><span class="s1">&#39;פעיל&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">pr_on</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;כבוי&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;notifications_toggle_pr&quot;</span>
                <span class="p">)</span>
            <span class="p">],</span>
            <span class="p">[</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Issues: </span><span class="si">{</span><span class="s1">&#39;פעיל&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">issues_on</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;כבוי&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;notifications_toggle_issues&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">],</span>
            <span class="p">[</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;תדירות: 30שנ׳&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;notifications_interval_30&quot;</span><span class="p">),</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;2ד׳&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;notifications_interval_120&quot;</span><span class="p">),</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;5ד׳&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;notifications_interval_300&quot;</span><span class="p">),</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;15ד׳&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;notifications_interval_900&quot;</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;בדוק עכשיו&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;notifications_check_now&quot;</span><span class="p">)],</span>
        <span class="p">]</span>
        <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;🔔 התראות לריפו: &lt;code&gt;</span><span class="si">{</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;selected_repo&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;מצב: </span><span class="si">{</span><span class="s1">&#39;פעיל&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">enabled</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;כבוי&#39;</span><span class="si">}</span><span class="s2"> | תדירות: </span><span class="si">{</span><span class="n">freq_display</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;התראות = בדיקת PRs/Issues חדשים/שעודכנו ושיגור הודעה אליך.&quot;</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="n">text</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># התעלם אם התוכן לא השתנה</span>
            <span class="k">if</span> <span class="s2">&quot;Message is not modified&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                <span class="k">raise</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.toggle_notifications">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.toggle_notifications">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">toggle_notifications</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
            <span class="s2">&quot;notifications&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;enabled&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;pr&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;issues&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;interval&quot;</span><span class="p">:</span> <span class="mi">300</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;enabled&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;enabled&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># ניהול job</span>
        <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;notif_</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">jq</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;job_queue&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">application</span><span class="p">,</span> <span class="s2">&quot;job_queue&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">jq</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jq</span><span class="o">.</span><span class="n">get_jobs_by_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="n">job</span><span class="o">.</span><span class="n">schedule_removal</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;enabled&quot;</span><span class="p">]:</span>
                <span class="n">jq</span><span class="o">.</span><span class="n">run_repeating</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_notifications_job</span><span class="p">,</span>
                    <span class="n">interval</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;interval&quot;</span><span class="p">,</span> <span class="mi">300</span><span class="p">),</span>
                    <span class="n">first</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">},</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;אזהרה: JobQueue לא זמין — התראות לא ירוצו ברקע&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_notifications_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.toggle_notifications_pr">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.toggle_notifications_pr">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">toggle_notifications_pr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
            <span class="s2">&quot;notifications&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;enabled&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;pr&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;issues&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;interval&quot;</span><span class="p">:</span> <span class="mi">300</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;pr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pr&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_notifications_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.toggle_notifications_issues">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.toggle_notifications_issues">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">toggle_notifications_issues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
            <span class="s2">&quot;notifications&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;enabled&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;pr&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;issues&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;interval&quot;</span><span class="p">:</span> <span class="mi">300</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;issues&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;issues&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_notifications_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.set_notifications_interval">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.set_notifications_interval">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">set_notifications_interval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
            <span class="s2">&quot;notifications&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;enabled&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;pr&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;issues&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;interval&quot;</span><span class="p">:</span> <span class="mi">300</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">interval</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">interval</span> <span class="o">=</span> <span class="mi">300</span>
        <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;interval&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">interval</span>
        <span class="c1"># עדכן job אם קיים</span>
        <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;notif_</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">jq</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;job_queue&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">application</span><span class="p">,</span> <span class="s2">&quot;job_queue&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">jq</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jq</span><span class="o">.</span><span class="n">get_jobs_by_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="n">job</span><span class="o">.</span><span class="n">schedule_removal</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;enabled&quot;</span><span class="p">):</span>
                <span class="n">jq</span><span class="o">.</span><span class="n">run_repeating</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_notifications_job</span><span class="p">,</span>
                    <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">,</span>
                    <span class="n">first</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">},</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;אזהרה: JobQueue לא זמין — התראות לא ירוצו ברקע&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_notifications_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.notifications_check_now">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.notifications_check_now">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">notifications_check_now</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;בודק עכשיו...&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_notifications_job</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_notifications_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;Message is not modified&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                <span class="k">raise</span></div>


    <span class="k">async</span> <span class="k">def</span> <span class="nf">_notifications_job</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">job</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;job&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">job</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="n">user_id</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">user_id</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
            <span class="n">settings</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">context</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;notifications&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">application</span><span class="p">,</span> <span class="s2">&quot;user_data&quot;</span><span class="p">)</span>
                <span class="k">else</span> <span class="kc">None</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">settings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">settings</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;notifications&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_name</span><span class="p">):</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">settings</span> <span class="ow">and</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;enabled&quot;</span><span class="p">)):</span>
                <span class="k">return</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span>
            <span class="c1"># נהל זיכרון &quot;נבדק לאחרונה&quot;</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;notifications_last&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;pr&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;issues&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>
            <span class="n">messages</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># PRs</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pr&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                <span class="n">last_pr_check_time</span> <span class="o">=</span> <span class="n">last</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pr&quot;</span><span class="p">)</span>
                <span class="c1"># If this is the first run (no baseline), set a baseline without sending backlog</span>
                <span class="k">if</span> <span class="n">last_pr_check_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">session</span><span class="p">[</span><span class="s2">&quot;notifications_last&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;notifications_last&quot;</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="n">session</span><span class="p">[</span><span class="s2">&quot;notifications_last&quot;</span><span class="p">][</span><span class="s2">&quot;pr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pulls</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_pulls</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="s2">&quot;updated&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;desc&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">pr</span> <span class="ow">in</span> <span class="n">pulls</span><span class="p">[:</span><span class="mi">10</span><span class="p">]:</span>
                        <span class="n">updated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_utc_aware</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">pr</span><span class="p">,</span> <span class="s2">&quot;updated_at&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
                        <span class="c1"># Normalize baseline too (safety in case it was saved naive somehow)</span>
                        <span class="n">baseline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_utc_aware</span><span class="p">(</span><span class="n">last_pr_check_time</span><span class="p">)</span>
                        <span class="c1"># אם אין updated או שאין אפשרות השוואה — עצור כדי למנוע עיבוד יתר של פריטים ישנים</span>
                        <span class="k">if</span> <span class="n">baseline</span> <span class="ow">and</span> <span class="p">(</span><span class="n">updated</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">updated</span> <span class="o">&lt;=</span> <span class="n">baseline</span><span class="p">):</span>
                            <span class="k">break</span>
                        <span class="n">created</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_utc_aware</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">pr</span><span class="p">,</span> <span class="s2">&quot;created_at&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
                        <span class="n">status</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="s2">&quot;נפתח&quot;</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;open&quot;</span> <span class="ow">and</span> <span class="n">created</span> <span class="ow">and</span> <span class="n">updated</span> <span class="ow">and</span> <span class="n">created</span> <span class="o">==</span> <span class="n">updated</span><span class="p">)</span>
                            <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;מוזג&quot;</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pr</span><span class="p">,</span> <span class="s2">&quot;merged&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;נסגר&quot;</span> <span class="k">if</span> <span class="n">pr</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;closed&quot;</span> <span class="k">else</span> <span class="s2">&quot;עודכן&quot;</span><span class="p">))</span>
                        <span class="p">)</span>
                        <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s1">&#39;🔔 PR </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s1">: &lt;a href=&quot;</span><span class="si">{</span><span class="n">pr</span><span class="o">.</span><span class="n">html_url</span><span class="si">}</span><span class="s1">&quot;&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">title</span><span class="p">)</span><span class="si">}</span><span class="s1">&lt;/a&gt;&#39;</span>
                        <span class="p">)</span>
                    <span class="n">session</span><span class="p">[</span><span class="s2">&quot;notifications_last&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;notifications_last&quot;</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="n">session</span><span class="p">[</span><span class="s2">&quot;notifications_last&quot;</span><span class="p">][</span><span class="s2">&quot;pr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
            <span class="c1"># Issues</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;issues&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                <span class="n">last_issues_check_time</span> <span class="o">=</span> <span class="n">last</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;issues&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">last_issues_check_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">session</span><span class="p">[</span><span class="s2">&quot;notifications_last&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;notifications_last&quot;</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="n">session</span><span class="p">[</span><span class="s2">&quot;notifications_last&quot;</span><span class="p">][</span><span class="s2">&quot;issues&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">issues</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_issues</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="s2">&quot;updated&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;desc&quot;</span><span class="p">)</span>
                    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">issue</span> <span class="ow">in</span> <span class="n">issues</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">issue</span><span class="o">.</span><span class="n">pull_request</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">updated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_utc_aware</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">issue</span><span class="p">,</span> <span class="s2">&quot;updated_at&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
                        <span class="n">baseline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_utc_aware</span><span class="p">(</span><span class="n">last_issues_check_time</span><span class="p">)</span>
                        <span class="c1"># אם אין updated או שאין אפשרות השוואה — עצור כדי למנוע עיבוד יתר של פריטים ישנים</span>
                        <span class="k">if</span> <span class="n">baseline</span> <span class="ow">and</span> <span class="p">(</span><span class="n">updated</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">updated</span> <span class="o">&lt;=</span> <span class="n">baseline</span><span class="p">):</span>
                            <span class="k">break</span>
                        <span class="n">created</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_utc_aware</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">issue</span><span class="p">,</span> <span class="s2">&quot;created_at&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
                        <span class="n">status</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="s2">&quot;נפתח&quot;</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">issue</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;open&quot;</span> <span class="ow">and</span> <span class="n">created</span> <span class="ow">and</span> <span class="n">updated</span> <span class="ow">and</span> <span class="n">created</span> <span class="o">==</span> <span class="n">updated</span><span class="p">)</span>
                            <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;נסגר&quot;</span> <span class="k">if</span> <span class="n">issue</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;closed&quot;</span> <span class="k">else</span> <span class="s2">&quot;עודכן&quot;</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s1">&#39;🔔 Issue </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s1">: &lt;a href=&quot;</span><span class="si">{</span><span class="n">issue</span><span class="o">.</span><span class="n">html_url</span><span class="si">}</span><span class="s1">&quot;&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">issue</span><span class="o">.</span><span class="n">title</span><span class="p">)</span><span class="si">}</span><span class="s1">&lt;/a&gt;&#39;</span>
                        <span class="p">)</span>
                        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>
                            <span class="k">break</span>
                    <span class="n">session</span><span class="p">[</span><span class="s2">&quot;notifications_last&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;notifications_last&quot;</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="n">session</span><span class="p">[</span><span class="s2">&quot;notifications_last&quot;</span><span class="p">][</span><span class="s2">&quot;issues&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
            <span class="c1"># שלח הודעה אם יש</span>
            <span class="k">if</span> <span class="n">messages</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">context</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span>
                    <span class="n">chat_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span> <span class="n">disable_web_page_preview</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;notifications job error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="GitHubMenuHandler.show_pr_menu">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_pr_menu">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">show_pr_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ בחר ריפו קודם (/github)&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🆕 צור PR מסניף&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;create_pr_menu&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔀 מזג PR פתוח&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;merge_pr_menu&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)],</span>
        <span class="p">]</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;🔀 פעולות Pull Request עבור &lt;code&gt;</span><span class="si">{</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;selected_repo&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span><span class="p">,</span>
            <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span>
            <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="GitHubMenuHandler.show_create_pr_menu">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_create_pr_menu">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">show_create_pr_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_name</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ חסרים נתונים&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span>
        <span class="n">branches</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">repo</span><span class="o">.</span><span class="n">get_branches</span><span class="p">())</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pr_branches_page&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">page_size</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">total_pages</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">branches</span><span class="p">)</span> <span class="o">+</span> <span class="n">page_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">page_size</span><span class="p">)</span>
        <span class="n">page</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">page</span><span class="p">),</span> <span class="n">total_pages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">page</span> <span class="o">*</span> <span class="n">page_size</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">page_size</span>
        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">br</span> <span class="ow">in</span> <span class="n">branches</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]:</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🌿 </span><span class="si">{</span><span class="n">br</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;pr_select_head:</span><span class="si">{</span><span class="n">br</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)]</span>
            <span class="p">)</span>
        <span class="n">nav</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">page</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;⬅️ הקודם&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;branches_page_</span><span class="si">{</span><span class="n">page</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;עמוד </span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total_pages</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;noop&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">page</span> <span class="o">&lt;</span> <span class="n">total_pages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;הבא ➡️&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;branches_page_</span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">nav</span><span class="p">:</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nav</span><span class="p">)</span>
        <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;pr_menu&quot;</span><span class="p">)])</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;🆕 צור PR — בחר סניף head (base יהיה ברירת המחדל של הריפו)&quot;</span><span class="p">,</span>
            <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="GitHubMenuHandler.show_confirm_create_pr">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_confirm_create_pr">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">show_confirm_create_pr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_name</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ חסרים נתונים&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">head</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pr_head&quot;</span><span class="p">)</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">default_branch</span> <span class="ow">or</span> <span class="s2">&quot;main&quot;</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;תיצור PR חדש?</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;ריפו: &lt;code&gt;</span><span class="si">{</span><span class="n">repo_name</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;base: &lt;code&gt;</span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s2">&lt;/code&gt; ← head: &lt;code&gt;</span><span class="si">{</span><span class="n">head</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;כותרת: &lt;code&gt;PR: </span><span class="si">{</span><span class="n">head</span><span class="si">}</span><span class="s2"> → </span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span>
        <span class="p">)</span>
        <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;✅ אשר יצירה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;confirm_create_pr&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;create_pr_menu&quot;</span><span class="p">)],</span>
        <span class="p">]</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.confirm_create_pr">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.confirm_create_pr">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">confirm_create_pr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_name</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ חסרים נתונים&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">head</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pr_head&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span>
            <span class="n">base</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">default_branch</span> <span class="ow">or</span> <span class="s2">&quot;main&quot;</span>
            <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;PR: </span><span class="si">{</span><span class="n">head</span><span class="si">}</span><span class="s2"> → </span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s2"> (via bot)&quot;</span>
            <span class="n">body</span> <span class="o">=</span> <span class="s2">&quot;נוצר אוטומטית על ידי הבוט&quot;</span>
            <span class="n">pr</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">create_pull</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="n">base</span><span class="p">,</span> <span class="n">head</span><span class="o">=</span><span class="n">head</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;✅ נוצר PR: &lt;a href=&quot;</span><span class="si">{</span><span class="n">pr</span><span class="o">.</span><span class="n">html_url</span><span class="si">}</span><span class="s1">&quot;&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">title</span><span class="p">)</span><span class="si">}</span><span class="s1">&lt;/a&gt;&#39;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה ביצירת PR: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_pr_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.show_merge_pr_menu">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_merge_pr_menu">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">show_merge_pr_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_name</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ חסרים נתונים&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span>
        <span class="n">pulls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">repo</span><span class="o">.</span><span class="n">get_pulls</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;open&quot;</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="s2">&quot;created&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;desc&quot;</span><span class="p">))</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pr_list_page&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">page_size</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">total_pages</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pulls</span><span class="p">)</span> <span class="o">+</span> <span class="n">page_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">page_size</span><span class="p">)</span>
        <span class="n">page</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">page</span><span class="p">),</span> <span class="n">total_pages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">page</span> <span class="o">*</span> <span class="n">page_size</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">page_size</span>
        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pr</span> <span class="ow">in</span> <span class="n">pulls</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">safe_html_escape</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;#</span><span class="si">{</span><span class="n">pr</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;merge_pr:</span><span class="si">{</span><span class="n">pr</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="n">nav</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">page</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;⬅️ הקודם&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;prs_page_</span><span class="si">{</span><span class="n">page</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;עמוד </span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total_pages</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;noop&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">page</span> <span class="o">&lt;</span> <span class="n">total_pages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;הבא ➡️&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;prs_page_</span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">nav</span><span class="p">:</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nav</span><span class="p">)</span>
        <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;pr_menu&quot;</span><span class="p">)])</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;🔀 בחר PR למיזוג (פתוחים בלבד)&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.show_confirm_merge_pr">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_confirm_merge_pr">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">show_confirm_merge_pr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="n">pr_number</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pr_to_merge&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_name</span> <span class="ow">and</span> <span class="n">pr_number</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ חסרים נתונים&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_pull</span><span class="p">(</span><span class="n">pr_number</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pr</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">checks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">can_merge</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Try to read permissions from repo API result</span>
            <span class="n">perms</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">raw_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;permissions&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="s2">&quot;raw_data&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">perms</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">push_allowed</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">perms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;push&quot;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">push_allowed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">checks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;הרשאת push: </span><span class="si">{</span><span class="s1">&#39;כן&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">push_allowed</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;לא&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">push_allowed</span><span class="p">:</span>
                <span class="n">can_merge</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">mergeable</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">mergeable</span>
        <span class="n">mergeable_state</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pr</span><span class="p">,</span> <span class="s2">&quot;mergeable_state&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mergeable</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">can_merge</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">checks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;מצב mergeable: </span><span class="si">{</span><span class="n">mergeable_state</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;כן&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">mergeable</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;לא ידוע&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">statuses</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">repo</span><span class="o">.</span><span class="n">get_commit</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">head</span><span class="o">.</span><span class="n">sha</span><span class="p">)</span><span class="o">.</span><span class="n">get_statuses</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">statuses</span><span class="p">:</span>
                <span class="n">latest_state</span> <span class="o">=</span> <span class="n">statuses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">state</span>
                <span class="n">checks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;סטטוסים: </span><span class="si">{</span><span class="n">latest_state</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pr</span><span class="p">,</span> <span class="s2">&quot;draft&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">checks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Draft: כן&quot;</span><span class="p">)</span>
            <span class="n">can_merge</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">checks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Draft: לא&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">reviews</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">get_reviews</span><span class="p">())</span>
            <span class="n">need_changes</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;CHANGES_REQUESTED&#39;</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">reviews</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">need_changes</span><span class="p">:</span>
                <span class="n">checks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;בקשות שינוי פתוחות: כן&quot;</span><span class="p">)</span>
                <span class="n">can_merge</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;למזג PR?</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;#</span><span class="si">{</span><span class="n">pr</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">: &lt;b&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">title</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pr</span><span class="o">.</span><span class="n">html_url</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;בדיקות לפני מיזוג:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;• </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">checks</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">kb</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔄 רענן בדיקות&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;refresh_merge_pr&quot;</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">can_merge</span><span class="p">:</span>
            <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;✅ אשר מיזוג&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;confirm_merge_pr&quot;</span><span class="p">)])</span>
        <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;merge_pr_menu&quot;</span><span class="p">)])</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
            <span class="n">txt</span><span class="p">,</span>
            <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span>
            <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
            <span class="n">disable_web_page_preview</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.confirm_merge_pr">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.confirm_merge_pr">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">confirm_merge_pr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="n">pr_number</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pr_to_merge&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_name</span> <span class="ow">and</span> <span class="n">pr_number</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ חסרים נתונים&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span>
            <span class="n">pr</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_pull</span><span class="p">(</span><span class="n">pr_number</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">merge_method</span><span class="o">=</span><span class="s2">&quot;merge&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">merged</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;✅ PR מוזג בהצלחה: &lt;a href=</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">pr</span><span class="o">.</span><span class="n">html_url</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&gt;#</span><span class="si">{</span><span class="n">pr</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">&lt;/a&gt;&quot;</span><span class="p">,</span>
                    <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ מיזוג נכשל: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה במיזוג PR: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_pr_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.git_checkpoint">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.git_checkpoint">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">git_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_full</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">repo_full</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ חסר טוקן או ריפו נבחר&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># Acknowledge the callback early to avoid Telegram timeout spinner</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;יוצר נקודת שמירה...&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">datetime</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">login_or_token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_full</span><span class="p">)</span>
            <span class="n">branch_obj</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_branch</span><span class="p">(</span><span class="n">repo</span><span class="o">.</span><span class="n">default_branch</span><span class="p">)</span>
            <span class="n">default_branch</span> <span class="o">=</span> <span class="n">branch_obj</span><span class="o">.</span><span class="n">name</span>
            <span class="n">sha</span> <span class="o">=</span> <span class="n">branch_obj</span><span class="o">.</span><span class="n">commit</span><span class="o">.</span><span class="n">sha</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">-%H%M%S&quot;</span><span class="p">)</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">GIT_CHECKPOINT_PREFIX</span> <span class="ow">or</span> <span class="s2">&quot;checkpoint&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="c1"># שמור על תווים חוקיים לשמות refs בסיסיים</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^A-Za-z0-9._/-]+&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>
            <span class="n">base_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">ts</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">tag_name</span> <span class="o">=</span> <span class="n">base_name</span>
            <span class="c1"># Create lightweight tag by creating a ref refs/tags/&lt;tag&gt;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">repo</span><span class="o">.</span><span class="n">create_git_ref</span><span class="p">(</span><span class="n">ref</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;refs/tags/</span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sha</span><span class="o">=</span><span class="n">sha</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">GithubException</span> <span class="k">as</span> <span class="n">ge</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ge</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="c1"># נסה פעם נוספת עם סיומת SHA במקרה של התנגשויות בשם</span>
                <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">422</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">tag_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">sha</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">repo</span><span class="o">.</span><span class="n">create_git_ref</span><span class="p">(</span><span class="n">ref</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;refs/tags/</span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sha</span><span class="o">=</span><span class="n">sha</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">GithubException</span> <span class="k">as</span> <span class="n">ge2</span><span class="p">:</span>
                        <span class="c1"># fallback ל-branch</span>
                        <span class="n">branch_name</span> <span class="o">=</span> <span class="n">base_name</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">repo</span><span class="o">.</span><span class="n">create_git_ref</span><span class="p">(</span><span class="n">ref</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;refs/heads/</span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sha</span><span class="o">=</span><span class="n">sha</span><span class="p">)</span>
                        <span class="k">except</span> <span class="n">GithubException</span> <span class="k">as</span> <span class="n">gbe</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">gbe</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="mi">422</span><span class="p">:</span>
                                <span class="n">branch_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">sha</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="n">repo</span><span class="o">.</span><span class="n">create_git_ref</span><span class="p">(</span><span class="n">ref</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;refs/heads/</span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sha</span><span class="o">=</span><span class="n">sha</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="n">ge</span>  <span class="c1"># שמור על הודעת השגיאה המקורית של ה-tag</span>
                        <span class="c1"># הצלחת גיבוי לענף</span>
                        <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;✅ נוצר branch (Fallback): &lt;code&gt;</span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&lt;/code&gt; על &lt;code&gt;</span><span class="si">{</span><span class="n">default_branch</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;סיבה: tag נחסם (HTTP </span><span class="si">{</span><span class="n">status</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;SHA: &lt;code&gt;</span><span class="si">{</span><span class="n">sha</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;שחזור מהיר: &lt;code&gt;git checkout </span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;רוצה שאיצור עבורך קובץ הוראות לשחזור?&quot;</span>
                        <span class="p">)</span>
                        <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📝 צור קובץ הוראות&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;git_checkpoint_doc:branch:</span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)],</span>
                            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;לא תודה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;git_checkpoint_doc_skip&quot;</span><span class="p">)],</span>
                        <span class="p">]</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span>
                        <span class="k">return</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># לא 422: עבור ישירות לגיבוי לענף</span>
                    <span class="n">branch_name</span> <span class="o">=</span> <span class="n">base_name</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">repo</span><span class="o">.</span><span class="n">create_git_ref</span><span class="p">(</span><span class="n">ref</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;refs/heads/</span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sha</span><span class="o">=</span><span class="n">sha</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">GithubException</span> <span class="k">as</span> <span class="n">gbe</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">gbe</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="mi">422</span><span class="p">:</span>
                            <span class="n">branch_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">sha</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="n">repo</span><span class="o">.</span><span class="n">create_git_ref</span><span class="p">(</span><span class="n">ref</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;refs/heads/</span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sha</span><span class="o">=</span><span class="n">sha</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">ge</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;✅ נוצר branch (Fallback): &lt;code&gt;</span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&lt;/code&gt; על &lt;code&gt;</span><span class="si">{</span><span class="n">default_branch</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;סיבה: יצירת tag נכשלה (HTTP </span><span class="si">{</span><span class="n">status</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;SHA: &lt;code&gt;</span><span class="si">{</span><span class="n">sha</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;שחזור מהיר: &lt;code&gt;git checkout </span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;רוצה שאיצור עבורך קובץ הוראות לשחזור?&quot;</span>
                    <span class="p">)</span>
                    <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📝 צור קובץ הוראות&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;git_checkpoint_doc:branch:</span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)],</span>
                        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;לא תודה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;git_checkpoint_doc_skip&quot;</span><span class="p">)],</span>
                    <span class="p">]</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
            <span class="c1"># הצלחת יצירת tag</span>
            <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;✅ נוצר tag: &lt;code&gt;</span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s2">&lt;/code&gt; על &lt;code&gt;</span><span class="si">{</span><span class="n">default_branch</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;SHA: &lt;code&gt;</span><span class="si">{</span><span class="n">sha</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;שחזור מהיר: &lt;code&gt;git checkout tags/</span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;רוצה שאיצור עבורך קובץ הוראות לשחזור?&quot;</span>
            <span class="p">)</span>
            <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📝 צור קובץ הוראות&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;git_checkpoint_doc:tag:</span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;לא תודה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;git_checkpoint_doc_skip&quot;</span><span class="p">)],</span>
            <span class="p">]</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">GithubException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">gh_message</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">gh_message</span> <span class="o">=</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">data</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">)</span>  <span class="c1"># type: ignore[attr-defined]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">gh_message</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">help_lines</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;בדוק את הרשאות ה-Token שלך:&quot;</span><span class="p">,</span>
                <span class="s2">&quot;• לטוקן קלאסי: &lt;b&gt;repo&lt;/b&gt; (גישה מלאה) או לכל הפחות &lt;b&gt;public_repo&lt;/b&gt; לריפו ציבורי.&quot;</span><span class="p">,</span>
                <span class="s2">&quot;• לטוקן מסוג Fine-grained: תחת Repository permissions, תן &lt;b&gt;Contents: Read and write&lt;/b&gt; ו-&lt;b&gt;Metadata: Read-only&lt;/b&gt; לריפו.&quot;</span><span class="p">,</span>
                <span class="s2">&quot;• ודא שיש לך גישת כתיבה לריפו (לא רק לקריאה/פורק).&quot;</span><span class="p">,</span>
                <span class="s2">&quot;• בארגונים, ייתכן שנדרש לאשר את האפליקציה/הטוקן בארגון.&quot;</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="n">extra</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">status</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="mi">404</span><span class="p">):</span>
                <span class="n">extra</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ייתכן שאין הרשאת כתיבה או שהטוקן מוגבל.&quot;</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;❌ יצירת נקודת שמירה בגיט נכשלה (HTTP </span><span class="si">{</span><span class="n">status</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="si">}</span><span class="s2">): &lt;b&gt;</span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">gh_message</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/b&gt;</span><span class="si">{</span><span class="n">extra</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">help_lines</span><span class="p">),</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create git checkpoint: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ יצירת נקודת שמירה בגיט נכשלה: </span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.show_pre_upload_check">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_pre_upload_check">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">show_pre_upload_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;מציג בדיקות לפני העלאת קובץ שמור (הרשאות/קיום קובץ/ענף/תיקייה).&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s2">&quot;callback_query&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span> <span class="k">if</span> <span class="n">query</span> <span class="k">else</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="n">file_id</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pending_saved_file_id&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_name</span> <span class="ow">and</span> <span class="n">file_id</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ חסרים נתונים (טוקן/ריפו/קובץ)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;❌ חסרים נתונים (טוקן/ריפו/קובץ)&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">bson</span> <span class="kn">import</span> <span class="n">ObjectId</span>
            <span class="n">file_data</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="n">file_id</span><span class="p">),</span> <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">})</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">file_data</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ קובץ לא נמצא&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;❌ קובץ לא נמצא&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file_name&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;file&quot;</span>
            <span class="c1"># Resolve target folder/branch (overrides take precedence)</span>
            <span class="n">override_folder</span> <span class="o">=</span> <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;upload_target_folder&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">target_folder</span> <span class="o">=</span> <span class="n">override_folder</span> <span class="k">if</span> <span class="n">override_folder</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="k">else</span> <span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_folder&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span>
            <span class="n">override_branch</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;upload_target_branch&quot;</span><span class="p">)</span>
            <span class="n">default_branch</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">default_branch</span> <span class="ow">or</span> <span class="s2">&quot;main&quot;</span>
            <span class="n">target_branch</span> <span class="o">=</span> <span class="n">override_branch</span> <span class="ow">or</span> <span class="n">default_branch</span>
            <span class="c1"># Build file path</span>
            <span class="k">if</span> <span class="n">target_folder</span><span class="p">:</span>
                <span class="n">folder_clean</span> <span class="o">=</span> <span class="n">target_folder</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder_clean</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">folder_clean</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="n">filename</span>
            <span class="c1"># Basic repo flags</span>
            <span class="n">archived</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="s2">&quot;archived&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">perms</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">raw_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;permissions&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="s2">&quot;raw_data&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">push_allowed</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">perms</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="nb">bool</span><span class="p">(</span><span class="n">perms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;push&quot;</span><span class="p">))</span>
            <span class="c1"># Check if file exists on target branch</span>
            <span class="n">exists</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">target_branch</span><span class="p">)</span>
                <span class="n">exists</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">exists</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># Build summary text</span>
            <span class="n">checks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">checks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ענף יעד: </span><span class="si">{</span><span class="n">target_branch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">checks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;תיקייה: </span><span class="si">{</span><span class="n">folder_clean</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">checks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;הרשאת push: </span><span class="si">{</span><span class="s1">&#39;כן&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">push_allowed</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;לא&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">checks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Archived: </span><span class="si">{</span><span class="s1">&#39;כן&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">archived</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;לא&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">checks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;הקובץ קיים כבר: </span><span class="si">{</span><span class="s1">&#39;כן (יעודכן)&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">exists</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;לא (ייווצר חדש)&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">txt</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;בדיקות לפני העלאה:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;ריפו: &lt;code&gt;</span><span class="si">{</span><span class="n">repo_name</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;קובץ: &lt;code&gt;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;• </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">checks</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="c1"># Build keyboard</span>
            <span class="n">kb</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🌿 בחר ענף יעד&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;choose_upload_branch&quot;</span><span class="p">)])</span>
            <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📂 בחר תיקיית יעד&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;choose_upload_folder&quot;</span><span class="p">)])</span>
            <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;➕ צור תיקייה חדשה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;upload_folder_create&quot;</span><span class="p">)])</span>
            <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔄 רענן בדיקות&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;refresh_saved_checks&quot;</span><span class="p">)])</span>
            <span class="k">if</span> <span class="n">push_allowed</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">archived</span><span class="p">:</span>
                <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;✅ אשר והעלה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;confirm_saved_upload&quot;</span><span class="p">)])</span>
            <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;back_to_menu&quot;</span><span class="p">)])</span>
            <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;❌ שגיאה בבדיקות לפני העלאה: </span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.confirm_saved_upload">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.confirm_saved_upload">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">confirm_saved_upload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
        <span class="c1"># Proceed with the actual upload of the saved file after checks</span>
        <span class="n">file_id</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pending_saved_file_id&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_id</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ לא נמצא קובץ ממתין להעלאה&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_saved_file_upload</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">file_id</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.refresh_saved_checks">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.refresh_saved_checks">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">refresh_saved_checks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_pre_upload_check</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.show_upload_branch_menu">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_upload_branch_menu">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">show_upload_branch_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_name</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ חסרים נתונים&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_name</span><span class="p">)</span>
        <span class="n">branches</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">repo</span><span class="o">.</span><span class="n">get_branches</span><span class="p">())</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;upload_branches_page&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">page_size</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">total_pages</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">branches</span><span class="p">)</span> <span class="o">+</span> <span class="n">page_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">page_size</span><span class="p">)</span>
        <span class="n">page</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">page</span><span class="p">),</span> <span class="n">total_pages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">page</span> <span class="o">*</span> <span class="n">page_size</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">page_size</span>
        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># מיפוי ענפים ל-token קצר כדי למנוע חיתוך/שגיאות באורך callback</span>
        <span class="n">branch_tokens</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;upload_branch_tokens&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">br</span> <span class="ow">in</span> <span class="n">branches</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]:</span>
            <span class="n">br_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">br</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="c1"># הפק token קצר ודטרמיניסטי-מספיק לשימוש זמני בתפריט</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tok</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">tok</span> <span class="o">=</span> <span class="s2">&quot;t&quot;</span>
            <span class="n">tok</span> <span class="o">=</span> <span class="n">tok</span><span class="p">[:</span><span class="mi">24</span><span class="p">]</span>
            <span class="n">branch_tokens</span><span class="p">[</span><span class="n">tok</span><span class="p">]</span> <span class="o">=</span> <span class="n">br_name</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🌿 </span><span class="si">{</span><span class="n">br_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;upload_select_branch_tok:</span><span class="si">{</span><span class="n">tok</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;upload_branch_tokens&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">branch_tokens</span>
        <span class="n">nav</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">page</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;⬅️ הקודם&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;upload_branches_page_</span><span class="si">{</span><span class="n">page</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;עמוד </span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total_pages</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;noop&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">page</span> <span class="o">&lt;</span> <span class="n">total_pages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;הבא ➡️&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;upload_branches_page_</span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">nav</span><span class="p">:</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nav</span><span class="p">)</span>
        <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;refresh_saved_checks&quot;</span><span class="p">)])</span>
        <span class="c1"># עריכת ההודעה עם טיפול ב&quot;message is not modified&quot; – במקרה כזה ננסה לעדכן רק את המקלדת</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;בחר ענף יעד להעלאה:&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">TelegramUtils</span> <span class="k">as</span> <span class="n">_TU</span>
                    <span class="k">await</span> <span class="n">_TU</span><span class="o">.</span><span class="n">safe_edit_message_reply_markup</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.show_upload_folder_menu">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_upload_folder_menu">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">show_upload_folder_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="c1"># הצג את התיקייה הפעילה הנוכחית: עדיפות ל-override זמני מזרימת ההעלאה, אחרת התיקייה שנבחרה במפגש, אחרת root</span>
        <span class="n">current</span> <span class="o">=</span> <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;upload_target_folder&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_folder&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;root&quot;</span><span class="p">)</span>
        <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📁 root (ראשי)&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;upload_folder_root&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📂 השתמש בתיקייה שנבחרה: </span><span class="si">{</span><span class="n">current</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;upload_folder_current&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;✏️ הזן נתיב ידנית&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;upload_folder_custom&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;➕ צור תיקייה חדשה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;upload_folder_create&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;refresh_saved_checks&quot;</span><span class="p">)],</span>
        <span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;בחר תיקיית יעד:&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">TelegramUtils</span> <span class="k">as</span> <span class="n">_TU</span>
                    <span class="k">await</span> <span class="n">_TU</span><span class="o">.</span><span class="n">safe_edit_message_reply_markup</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.ask_upload_folder">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.ask_upload_folder">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">ask_upload_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_upload_folder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
            <span class="s2">&quot;✏️ הקלד נתיב תיקייה יעד (למשל: src/utils או ריק ל-root).</span><span class="se">\n</span><span class="s2">שלח טקסט חופשי עכשיו.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.create_checkpoint_doc">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.create_checkpoint_doc">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">create_checkpoint_doc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;יוצר קובץ הוראות שחזור לנקודת שמירה ושולח ל-flow של העלאה&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_full</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
        <span class="c1"># בנה תוכן Markdown</span>
        <span class="n">is_tag</span> <span class="o">=</span> <span class="p">(</span><span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;tag&quot;</span><span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;# 🏷️ נקודת שמירה בגיט</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;נוצר tag בשם `</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">`&quot;</span> <span class="k">if</span> <span class="n">is_tag</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;נוצר branch בשם `</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">`&quot;</span><span class="p">)</span>
        <span class="n">repo_line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;בריפו: `</span><span class="si">{</span><span class="n">repo_full</span><span class="si">}</span><span class="s2">`</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">repo_full</span> <span class="k">else</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">intro</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">what</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="si">{</span><span class="n">repo_line</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="s2">&quot;כך ניתן לשחזר לאותה נקודה במחשב המקומי:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">is_tag</span><span class="p">:</span>
            <span class="n">commands</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;1. עדכן תגיות מהריפו:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;```bash</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;git fetch --tags</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;```</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;2. מעבר לקריאה בלבד ל-tag (מצב detached):</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;```bash</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;git checkout tags/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;```</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;3. לחזרה לענף הראשי לאחר מכן:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;```bash</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;git checkout -</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;```</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">commands</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;1. עדכן רפרנסים מהריפו:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;```bash</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;git fetch origin</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;```</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;2. מעבר לענף שנוצר:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;```bash</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;git checkout </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;```</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="n">notes</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&gt; הערות:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;&gt; - נקודת שמירה היא רפרנס ל-commit (tag או branch).</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;&gt; - ניתן למחוק את הקובץ הזה לאחר השחזור.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">title</span> <span class="o">+</span> <span class="n">intro</span> <span class="o">+</span> <span class="n">commands</span> <span class="o">+</span> <span class="n">notes</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;RESTORE_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.md&quot;</span>
        <span class="c1"># שמירה במסד והמשך ל-flow של העלאה</span>
        <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
            <span class="s2">&quot;file_name&quot;</span><span class="p">:</span> <span class="n">file_name</span><span class="p">,</span>
            <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">content</span><span class="p">,</span>
            <span class="s2">&quot;programming_language&quot;</span><span class="p">:</span> <span class="s2">&quot;markdown&quot;</span><span class="p">,</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;הוראות שחזור לנקודת שמירה&quot;</span><span class="p">,</span>
            <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;checkpoint&quot;</span><span class="p">,</span> <span class="s2">&quot;instructions&quot;</span><span class="p">],</span>
            <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span>
            <span class="s2">&quot;updated_at&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span>
            <span class="s2">&quot;is_active&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">insert_one</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;pending_saved_file_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">inserted_id</span><span class="p">)</span>
            <span class="c1"># פתח את בדיקות ההעלאה (בחירת ענף/תיקייה ואישור)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_pre_upload_check</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ נכשל ביצירת קובץ הוראות: </span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="GitHubMenuHandler.show_restore_checkpoint_menu">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_restore_checkpoint_menu">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">show_restore_checkpoint_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;מציג רשימת תגיות נקודות שמירה לבחירה לשחזור&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_full</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_full</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ חסר טוקן או ריפו נבחר&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="k">raise</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;❌ חסר טוקן או ריפו נבחר&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_full</span><span class="p">)</span>
            <span class="c1"># משוך תגיות (נחתוך לכמות סבירה, למשל 100)</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">repo</span><span class="o">.</span><span class="n">get_tags</span><span class="p">())[:</span><span class="mi">100</span><span class="p">]</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">GIT_CHECKPOINT_PREFIX</span> <span class="ow">or</span> <span class="s2">&quot;checkpoint&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="c1"># שמות חוקיים</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^A-Za-z0-9._/-]+&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>
            <span class="n">checkpoint_tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tags</span> <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span><span class="p">)]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">checkpoint_tags</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;ℹ️ לא נמצאו תגיות נקודת שמירה בריפו.&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                        <span class="k">raise</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;ℹ️ לא נמצאו תגיות נקודת שמירה&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">return</span>
            <span class="c1"># עימוד</span>
            <span class="n">page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;restore_tags_page&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">per_page</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">checkpoint_tags</span><span class="p">)</span>
            <span class="n">total_pages</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">total</span> <span class="o">+</span> <span class="n">per_page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">per_page</span><span class="p">)</span>
            <span class="n">page</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">page</span><span class="p">),</span> <span class="n">total_pages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">page</span> <span class="o">*</span> <span class="n">per_page</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">per_page</span>
            <span class="n">page_tags</span> <span class="o">=</span> <span class="n">checkpoint_tags</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
            <span class="c1"># בנה מקלדת</span>
            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">page_tags</span><span class="p">:</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🏷 </span><span class="si">{</span><span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;restore_select_tag:</span><span class="si">{</span><span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
            <span class="n">nav</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">page</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;⬅️ הקודם&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;restore_tags_page_</span><span class="si">{</span><span class="n">page</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📄 </span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total_pages</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;noop&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">page</span> <span class="o">&lt;</span> <span class="n">total_pages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;➡️ הבא&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;restore_tags_page_</span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">nav</span><span class="p">:</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nav</span><span class="p">)</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                    <span class="s2">&quot;בחר תגית נקודת שמירה לשחזור:&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="c1"># פרסום הודעה חדשה כגיבוי</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                        <span class="s2">&quot;בחר תגית נקודת שמירה לשחזור:&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;אין שינוי בתצוגה&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה בטעינת תגיות: </span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="k">raise</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה בטעינת תגיות: </span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.show_restore_tag_actions">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_restore_tag_actions">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">show_restore_tag_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">tag_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;מציג פעולות אפשריות לשחזור מתגית נתונה&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_full</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">repo_full</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ לא נבחר ריפו&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># הצג אפשרויות: צור קובץ הוראות / צור ענף מהתגית</span>
        <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;🏷 תגית נבחרה: &lt;code&gt;</span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;בחר פעולה לשחזור:&quot;</span> 
        <span class="p">)</span>
        <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📝 צור קובץ הוראות&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;git_checkpoint_doc:tag:</span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🌿 צור ענף מהתגית&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;restore_branch_from_tag:</span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔁 צור PR לשחזור (Revert)&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;restore_revert_pr_from_tag:</span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;restore_checkpoint_menu&quot;</span><span class="p">)],</span>
        <span class="p">]</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="GitHubMenuHandler.create_branch_from_tag">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.create_branch_from_tag">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">create_branch_from_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">tag_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;יוצר ענף חדש שמצביע ל-commit של התגית לשחזור נוח&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_full</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_full</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ חסר טוקן או ריפו נבחר&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_full</span><span class="p">)</span>
            <span class="n">sha</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># נסה להשיג SHA מה-ref של התגית</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ref</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_git_ref</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tags/</span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">sha</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">sha</span>
            <span class="k">except</span> <span class="n">GithubException</span><span class="p">:</span>
                <span class="c1"># נפילה חזרה לחיפוש ברשימת תגיות</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_tags</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">tag_name</span><span class="p">:</span>
                        <span class="n">sha</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">commit</span><span class="o">.</span><span class="n">sha</span>
                        <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">sha</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ לא נמצאה התגית המבוקשת&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="c1"># שם ברירת מחדל לענף שחזור</span>
            <span class="n">base_branch</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^A-Za-z0-9._/-]+&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;restore-</span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">branch_name</span> <span class="o">=</span> <span class="n">base_branch</span>
            <span class="c1"># צור את ה-ref, עם ניסיון לשמור על ייחודיות</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">repo</span><span class="o">.</span><span class="n">create_git_ref</span><span class="p">(</span><span class="n">ref</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;refs/heads/</span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sha</span><span class="o">=</span><span class="n">sha</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">GithubException</span> <span class="k">as</span> <span class="n">gbe</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">gbe</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="mi">422</span><span class="p">:</span>
                    <span class="n">branch_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_branch</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">sha</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">repo</span><span class="o">.</span><span class="n">create_git_ref</span><span class="p">(</span><span class="n">ref</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;refs/heads/</span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sha</span><span class="o">=</span><span class="n">sha</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span>
            <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔀 פתח PR מהענף&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;open_pr_from_branch:</span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;restore_checkpoint_menu&quot;</span><span class="p">)],</span>
            <span class="p">]</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;✅ נוצר ענף שחזור: &lt;code&gt;</span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&lt;/code&gt; מתוך &lt;code&gt;</span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;שחזור מקומי מהיר:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;&lt;code&gt;git fetch origin &amp;&amp; git checkout </span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># הצג אפשרות להמשיך ליצירת PR לשחזור למרות הכישלון ביצירת ענף</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔁 צור PR לשחזור (Revert)&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;restore_revert_pr_from_tag:</span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)],</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;restore_checkpoint_menu&quot;</span><span class="p">)],</span>
                <span class="p">]</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;❌ שגיאה ביצירת ענף שחזור: </span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;תוכל עדיין ליצור PR לשחזור ישירות מהתגית &lt;code&gt;</span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s2">&lt;/code&gt;.&quot;</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span>
                    <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה ביצירת ענף שחזור: </span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.open_pr_from_branch">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.open_pr_from_branch">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">open_pr_from_branch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">branch_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;פותח Pull Request מהענף שנוצר אל הענף הראשי של הריפו&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_full</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_full</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ חסר טוקן או ריפו נבחר&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_full</span><span class="p">)</span>
            <span class="n">base_branch</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">default_branch</span> <span class="ow">or</span> <span class="s2">&quot;main&quot;</span>
            <span class="n">owner_login</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">owner</span><span class="o">.</span><span class="n">login</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="s2">&quot;owner&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="n">repo_full</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># 1) אם כבר קיים PR פתוח מהענף הזה לבסיס – הצג אותו במקום ליצור חדש</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">existing_prs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                    <span class="n">repo</span><span class="o">.</span><span class="n">get_pulls</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;open&quot;</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="n">base_branch</span><span class="p">,</span> <span class="n">head</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">owner_login</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">existing_prs</span><span class="p">:</span>
                    <span class="n">pr</span> <span class="o">=</span> <span class="n">existing_prs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">kb</span> <span class="o">=</span> <span class="p">[[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)]]</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;ℹ️ כבר קיים PR פתוח מהענף &lt;code&gt;</span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&lt;/code&gt; ל-&lt;code&gt;</span><span class="si">{</span><span class="n">base_branch</span><span class="si">}</span><span class="s2">&lt;/code&gt;: &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;&lt;a href=</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">pr</span><span class="o">.</span><span class="n">html_url</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&gt;#</span><span class="si">{</span><span class="n">pr</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">&lt;/a&gt;&quot;</span><span class="p">,</span>
                        <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                        <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="k">return</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># נמשיך לנסות ליצור PR אם לא הצלחנו לבדוק קיום</span>
                <span class="k">pass</span>

            <span class="c1"># 2) בדוק שיש הבדלים בין HEAD ל-base (אחרת GitHub יחזיר Validation Failed)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cmp</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">base_branch</span><span class="p">,</span> <span class="n">branch_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cmp</span><span class="p">,</span> <span class="s2">&quot;ahead_by&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cmp</span><span class="p">,</span> <span class="s2">&quot;behind_by&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;↩️ בחר תגית אחרת&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;restore_checkpoint_menu&quot;</span><span class="p">)],</span>
                        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)],</span>
                    <span class="p">]</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                        <span class="p">(</span>
                            <span class="s2">&quot;❌ לא ניתן לפתוח PR: אין שינויים בין הענף &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;&lt;code&gt;</span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&lt;/code&gt; ל- &lt;code&gt;</span><span class="si">{</span><span class="n">base_branch</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                            <span class="s2">&quot;נסה לבחור תגית אחרת לשחזור, או בצע שינוי/commit בענף לפני פתיחת PR.&quot;</span>
                        <span class="p">),</span>
                        <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                        <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="k">return</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># אם ההשוואה נכשלה, ננסה בכל זאת ליצור PR – ייתכן שהענף חדש מאוד</span>
                <span class="k">pass</span>

            <span class="c1"># 3) צור PR</span>
            <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Restore from checkpoint: </span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">body</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Automated PR to restore state from branch `</span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">`.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Created via Telegram bot.&quot;</span>
            <span class="p">)</span>
            <span class="n">pr</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">create_pull</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">,</span> <span class="n">head</span><span class="o">=</span><span class="n">branch_name</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="n">base_branch</span><span class="p">)</span>
            <span class="n">kb</span> <span class="o">=</span> <span class="p">[[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)]]</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;✅ נפתח PR: &lt;a href=</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">pr</span><span class="o">.</span><span class="n">html_url</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&gt;#</span><span class="si">{</span><span class="n">pr</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">&lt;/a&gt; ← &lt;code&gt;</span><span class="si">{</span><span class="n">base_branch</span><span class="si">}</span><span class="s2">&lt;/code&gt; ← &lt;code&gt;</span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">GithubException</span> <span class="k">as</span> <span class="n">ge</span><span class="p">:</span>
            <span class="c1"># פרשנות מפורטת יותר לשגיאות Validation Failed</span>
            <span class="n">message_text</span> <span class="o">=</span> <span class="s2">&quot;Validation Failed&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">ge</span><span class="o">.</span><span class="n">data</span> <span class="ow">or</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="c1"># הודעת על</span>
                    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">):</span>
                        <span class="n">message_text</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span>
                    <span class="c1"># בדוק פירוט שגיאות נפוצות</span>
                    <span class="n">errors</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;errors&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">errors</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">errors</span><span class="p">:</span>
                        <span class="n">details</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">err</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">:</span>
                            <span class="c1"># err יכול להיות dict עם מפתחות code/message</span>
                            <span class="n">code</span> <span class="o">=</span> <span class="n">err</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;code&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="n">err</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
                            <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="s2">&quot;custom&quot;</span> <span class="ow">and</span> <span class="n">msg</span><span class="p">:</span>
                                <span class="n">details</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="n">msg</span><span class="p">:</span>
                                <span class="n">details</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">details</span><span class="p">:</span>
                            <span class="n">message_text</span> <span class="o">+=</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="s2">&quot;; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">details</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="c1"># נסה לזהות במפורש &quot;No commits between&quot; או PR קיים ולהציע פתרון</span>
            <span class="n">lower_msg</span> <span class="o">=</span> <span class="p">(</span><span class="n">message_text</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">kb</span> <span class="o">=</span> <span class="p">[[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)]]</span>
            <span class="k">if</span> <span class="s2">&quot;no commits between&quot;</span> <span class="ow">in</span> <span class="n">lower_msg</span> <span class="ow">or</span> <span class="s2">&quot;no commits&quot;</span> <span class="ow">in</span> <span class="n">lower_msg</span><span class="p">:</span>
                <span class="n">kb</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;↩️ בחר תגית אחרת&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;restore_checkpoint_menu&quot;</span><span class="p">)])</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="s2">&quot;❌ שגיאה בפתיחת PR: אין שינויים בין הענפים.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;ענף: &lt;code&gt;</span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&lt;/code&gt; → בסיס: &lt;code&gt;</span><span class="si">{</span><span class="n">base_branch</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                        <span class="s2">&quot;בחר נקודת שמירה מוקדמת יותר או בצע שינוי/commit בענף ואז נסה שוב.&quot;</span>
                    <span class="p">),</span>
                    <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="s2">&quot;already exists&quot;</span> <span class="ow">in</span> <span class="n">lower_msg</span> <span class="ow">or</span> <span class="s2">&quot;a pull request already exists&quot;</span> <span class="ow">in</span> <span class="n">lower_msg</span><span class="p">:</span>
                <span class="c1"># נסה למצוא את ה-PR הקיים ולהציג קישור</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">prs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">repo</span><span class="o">.</span><span class="n">get_pulls</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;open&quot;</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="n">base_branch</span><span class="p">,</span> <span class="n">head</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">owner_login</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">branch_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">prs</span><span class="p">:</span>
                        <span class="n">pr</span> <span class="o">=</span> <span class="n">prs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;ℹ️ כבר קיים PR פתוח: &lt;a href=</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">pr</span><span class="o">.</span><span class="n">html_url</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&gt;#</span><span class="si">{</span><span class="n">pr</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">&lt;/a&gt;&quot;</span><span class="p">,</span>
                            <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                            <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span>
                        <span class="p">)</span>
                        <span class="k">return</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה בפתיחת PR: </span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">message_text</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה בפתיחת PR: </span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.create_revert_pr_from_tag">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.create_revert_pr_from_tag">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">create_revert_pr_from_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">tag_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;יוצר PR שמשחזר את מצב הריפו לתגית ע&quot;י יצירת commit חדש עם עץ התגית על גבי base.</span>
<span class="sd">        כך תמיד יהיה diff וה-PR ייפתח בהצלחה.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_full</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_full</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ חסר טוקן או ריפו נבחר&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_full</span><span class="p">)</span>
            <span class="n">base_branch</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">default_branch</span> <span class="ow">or</span> <span class="s2">&quot;main&quot;</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[create_revert_pr_from_tag] repo=</span><span class="si">%s</span><span class="s2"> base=</span><span class="si">%s</span><span class="s2"> tag=</span><span class="si">%s</span><span class="s2"> user=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">repo_full</span><span class="p">,</span> <span class="n">base_branch</span><span class="p">,</span> <span class="n">tag_name</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>

            <span class="c1"># מצא את ה-SHA של עץ התגית (מתמודד גם עם תגיות מוכללות)</span>
            <span class="n">tag_tree_sha</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ref</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_git_ref</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tags/</span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">ref_obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">ref_type</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ref_obj</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">ref_sha</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ref_obj</span><span class="p">,</span> <span class="s2">&quot;sha&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[create_revert_pr_from_tag] ref_type=</span><span class="si">%s</span><span class="s2"> ref_sha=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ref_type</span><span class="p">,</span> <span class="n">ref_sha</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ref_type</span> <span class="o">==</span> <span class="s2">&quot;commit&quot;</span> <span class="ow">and</span> <span class="n">ref_sha</span><span class="p">:</span>
                    <span class="n">commit</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_commit</span><span class="p">(</span><span class="n">ref_sha</span><span class="p">)</span>
                    <span class="n">tag_tree_sha</span> <span class="o">=</span> <span class="n">commit</span><span class="o">.</span><span class="n">commit</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">sha</span>
                <span class="k">elif</span> <span class="n">ref_type</span> <span class="o">==</span> <span class="s2">&quot;tag&quot;</span> <span class="ow">and</span> <span class="n">ref_sha</span><span class="p">:</span>
                    <span class="c1"># תגית מוכללת — נפרק לאובייקט היעד</span>
                    <span class="n">tag_obj</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_git_tag</span><span class="p">(</span><span class="n">ref_sha</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[create_revert_pr_from_tag] annotated tag sha=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ref_sha</span><span class="p">)</span>
                    <span class="k">while</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">tag_obj</span><span class="p">,</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;tag&quot;</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[create_revert_pr_from_tag] peeling nested tag sha=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">tag_obj</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">sha</span><span class="p">)</span>
                        <span class="n">tag_obj</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_git_tag</span><span class="p">(</span><span class="n">tag_obj</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">sha</span><span class="p">)</span>
                    <span class="n">target_type</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tag_obj</span><span class="o">.</span><span class="n">object</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">target_sha</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tag_obj</span><span class="o">.</span><span class="n">object</span><span class="p">,</span> <span class="s2">&quot;sha&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[create_revert_pr_from_tag] tag target_type=</span><span class="si">%s</span><span class="s2"> target_sha=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">target_type</span><span class="p">,</span> <span class="n">target_sha</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">target_type</span> <span class="o">==</span> <span class="s2">&quot;commit&quot;</span> <span class="ow">and</span> <span class="n">target_sha</span><span class="p">:</span>
                        <span class="n">commit</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_commit</span><span class="p">(</span><span class="n">target_sha</span><span class="p">)</span>
                        <span class="n">tag_tree_sha</span> <span class="o">=</span> <span class="n">commit</span><span class="o">.</span><span class="n">commit</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">sha</span>
                    <span class="k">elif</span> <span class="n">target_type</span> <span class="o">==</span> <span class="s2">&quot;tree&quot;</span> <span class="ow">and</span> <span class="n">target_sha</span><span class="p">:</span>
                        <span class="n">tag_tree_sha</span> <span class="o">=</span> <span class="n">target_sha</span>
                <span class="k">elif</span> <span class="n">ref_type</span> <span class="o">==</span> <span class="s2">&quot;tree&quot;</span> <span class="ow">and</span> <span class="n">ref_sha</span><span class="p">:</span>
                    <span class="n">tag_tree_sha</span> <span class="o">=</span> <span class="n">ref_sha</span>
            <span class="k">except</span> <span class="n">GithubException</span> <span class="k">as</span> <span class="n">ge</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;[create_revert_pr_from_tag] get_git_ref failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ge</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">ge</span><span class="p">))</span>
                <span class="k">pass</span>

            <span class="c1"># נפילה ל-backup: מעבר על get_tags (עובד לרוב על תגיות קלילות)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">tag_tree_sha</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[create_revert_pr_from_tag] fallback to repo.get_tags() for </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">tag_name</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_tags</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">tag_name</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">commit</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_commit</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">commit</span><span class="o">.</span><span class="n">sha</span><span class="p">)</span>
                            <span class="n">tag_tree_sha</span> <span class="o">=</span> <span class="n">commit</span><span class="o">.</span><span class="n">commit</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">sha</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[create_revert_pr_from_tag] fallback resolved tree=</span><span class="si">%s</span><span class="s2"> via commit=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">tag_tree_sha</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">commit</span><span class="o">.</span><span class="n">sha</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">inner_e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;[create_revert_pr_from_tag] fallback resolving tag failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">inner_e</span><span class="p">)</span>
                        <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">tag_tree_sha</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ לא נמצאה התגית המבוקשת&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="c1"># צור ענף עבודה חדש משם ברור</span>
            <span class="n">safe_branch</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^A-Za-z0-9._/-]+&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;restore-from-</span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">work_branch</span> <span class="o">=</span> <span class="n">safe_branch</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">base_sha</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_branch</span><span class="p">(</span><span class="n">base_branch</span><span class="p">)</span><span class="o">.</span><span class="n">commit</span><span class="o">.</span><span class="n">sha</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[create_revert_pr_from_tag] creating work branch=</span><span class="si">%s</span><span class="s2"> from base_sha=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">work_branch</span><span class="p">,</span> <span class="n">base_sha</span><span class="p">)</span>
                <span class="n">repo</span><span class="o">.</span><span class="n">create_git_ref</span><span class="p">(</span><span class="n">ref</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;refs/heads/</span><span class="si">{</span><span class="n">work_branch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sha</span><span class="o">=</span><span class="n">base_sha</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">GithubException</span> <span class="k">as</span> <span class="n">gbe</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">gbe</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="mi">422</span><span class="p">:</span>
                    <span class="n">work_branch</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">safe_branch</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">base_sha</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_branch</span><span class="p">(</span><span class="n">base_branch</span><span class="p">)</span><span class="o">.</span><span class="n">commit</span><span class="o">.</span><span class="n">sha</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[create_revert_pr_from_tag] branch exists, retry with </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">work_branch</span><span class="p">)</span>
                    <span class="n">repo</span><span class="o">.</span><span class="n">create_git_ref</span><span class="p">(</span><span class="n">ref</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;refs/heads/</span><span class="si">{</span><span class="n">work_branch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sha</span><span class="o">=</span><span class="n">base_sha</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span>

            <span class="c1"># צור commit חדש בעבודה עם tree של התגית והורה מה-base</span>
            <span class="n">base_head</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_branch</span><span class="p">(</span><span class="n">base_branch</span><span class="p">)</span><span class="o">.</span><span class="n">commit</span><span class="o">.</span><span class="n">sha</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_git_commit</span><span class="p">(</span><span class="n">base_head</span><span class="p">)</span>
            <span class="n">new_tree</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_git_tree</span><span class="p">(</span><span class="n">tag_tree_sha</span><span class="p">)</span>
            <span class="n">new_commit_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Restore repository state from tag </span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[create_revert_pr_from_tag] creating git commit on </span><span class="si">%s</span><span class="s2"> with tree=</span><span class="si">%s</span><span class="s2"> parent=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">work_branch</span><span class="p">,</span> <span class="n">tag_tree_sha</span><span class="p">,</span> <span class="n">base_head</span><span class="p">)</span>
            <span class="n">new_commit</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">create_git_commit</span><span class="p">(</span><span class="n">new_commit_message</span><span class="p">,</span> <span class="n">new_tree</span><span class="p">,</span> <span class="p">[</span><span class="n">parent</span><span class="p">])</span>
            <span class="c1"># עדכן את ה-ref של הענף החדש ל-commit החדש</span>
            <span class="n">repo</span><span class="o">.</span><span class="n">get_git_ref</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;heads/</span><span class="si">{</span><span class="n">work_branch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">edit</span><span class="p">(</span><span class="n">new_commit</span><span class="o">.</span><span class="n">sha</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[create_revert_pr_from_tag] updated ref heads/</span><span class="si">%s</span><span class="s2"> -&gt; </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">work_branch</span><span class="p">,</span> <span class="n">new_commit</span><span class="o">.</span><span class="n">sha</span><span class="p">)</span>

            <span class="c1"># פתח PR</span>
            <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Restore to checkpoint: </span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">body</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;This PR restores the repository state to tag `</span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s2">` by creating a new commit with the tag&#39;s tree on top of `</span><span class="si">{</span><span class="n">base_branch</span><span class="si">}</span><span class="s2">`.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Created via Telegram bot.&quot;</span>
            <span class="p">)</span>
            <span class="n">pr</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">create_pull</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">,</span> <span class="n">head</span><span class="o">=</span><span class="n">work_branch</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="n">base_branch</span><span class="p">)</span>
            <span class="n">kb</span> <span class="o">=</span> <span class="p">[[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)]]</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;✅ נפתח PR: &lt;a href=</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">pr</span><span class="o">.</span><span class="n">html_url</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&gt;#</span><span class="si">{</span><span class="n">pr</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">&lt;/a&gt; ← &lt;code&gt;</span><span class="si">{</span><span class="n">base_branch</span><span class="si">}</span><span class="s2">&lt;/code&gt; ← &lt;code&gt;</span><span class="si">{</span><span class="n">work_branch</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">GithubException</span> <span class="k">as</span> <span class="n">ge</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Validation Failed&quot;</span>
            <span class="n">details</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">ge</span><span class="o">.</span><span class="n">data</span> <span class="ow">or</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">):</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
                <span class="n">details</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;[create_revert_pr_from_tag] GithubException: </span><span class="si">%s</span><span class="s2"> data=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">details</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה ביצירת PR לשחזור: </span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;[create_revert_pr_from_tag] Unexpected error: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה ביצירת PR לשחזור: </span><span class="si">{</span><span class="n">safe_html_escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.show_github_backup_menu">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.show_github_backup_menu">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">show_github_backup_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;מציג תפריט גיבוי/שחזור עבור הריפו הנבחר&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_full</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_full</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ חסר טוקן או ריפו נבחר&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="k">raise</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;❌ חסר טוקן או ריפו נבחר&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">return</span>
        <span class="c1"># כניסה לתפריט גיבוי/שחזור מתחילה זרם חדש – נקה נעילות/סטייטים קודמים</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;zip_restore_expected_repo_full&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;github_restore_zip_purge&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;pending_repo_restore_zip_path&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="c1"># סמן הקשר כדי לאפשר סינון גיבויים לפי הריפו הנוכחי</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;github_backup_context_repo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">repo_full</span>
        <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📦 הורד גיבוי ZIP של הריפו&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;download_zip:&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;♻️ שחזר ZIP לריפו (פריסה והחלפה)&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_restore_zip_to_repo&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📂 שחזר מגיבוי שמור לריפו&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_restore_zip_list&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🏷 נקודת שמירה בגיט&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;git_checkpoint&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;↩️ חזרה לנקודת שמירה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;restore_checkpoint_menu&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🗂 גיבויי DB אחרונים&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_backup_db_list&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;♻️ שחזור מגיבוי (ZIP)&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;backup_restore_full_start&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ℹ️ הסבר על הכפתורים&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_backup_help&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_menu&quot;</span><span class="p">)],</span>
        <span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;🧰 תפריט גיבוי ושחזור לריפו:</span><span class="se">\n</span><span class="s2">&lt;code&gt;</span><span class="si">{</span><span class="n">repo_full</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="c1"># פרסום הודעה חדשה כגיבוי</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;🧰 תפריט גיבוי ושחזור לריפו:</span><span class="se">\n</span><span class="s2">&lt;code&gt;</span><span class="si">{</span><span class="n">repo_full</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span>
                    <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;אין שינוי בתצוגה&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="k">return</span>

        <span class="c1"># Unreachable guard to satisfy linters if parser confuses block ends</span>
        <span class="k">if</span> <span class="kc">False</span> <span class="ow">and</span> <span class="p">(</span><span class="n">query</span> <span class="ow">and</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;github_restore_zip_to_repo&quot;</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;github_restore_zip_setpurge:&quot;</span><span class="p">):</span>
            <span class="n">purge_flag</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span>
            <span class="c1"># ודא שניקינו דגלים ישנים של העלאה רגילה כדי למנוע בלבול</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_github_upload&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;upload_mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;github_restore_zip_to_repo&quot;</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;github_restore_zip_purge&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">purge_flag</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="p">(</span><span class="s2">&quot;🧹 יבוצע ניקוי לפני העלאה. &quot;</span> <span class="k">if</span> <span class="n">purge_flag</span> <span class="k">else</span> <span class="s2">&quot;🔁 ללא מחיקה. &quot;</span><span class="p">)</span> <span class="o">+</span>
                <span class="s2">&quot;שלח עכשיו קובץ ZIP לשחזור לריפו.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;github_restore_zip_list&quot;</span><span class="p">:</span>
            <span class="c1"># הצג רשימת גיבויים (ZIP) של הריפו הנוכחי לצורך שחזור לריפו</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
            <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">repo_full</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">repo_full</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ קודם בחר ריפו!&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="kn">from</span> <span class="nn">file_manager</span> <span class="kn">import</span> <span class="n">backup_manager</span>
            <span class="n">backups</span> <span class="o">=</span> <span class="n">backup_manager</span><span class="o">.</span><span class="n">list_backups</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="c1"># סנן רק גיבויים עם metadata של אותו ריפו</span>
            <span class="n">backups</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">backups</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s1">&#39;repo&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="n">repo_full</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">backups</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;ℹ️ אין גיבויי ZIP שמורים עבור הריפו:</span><span class="se">\n</span><span class="s2">&lt;code&gt;</span><span class="si">{</span><span class="n">repo_full</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span><span class="p">,</span>
                    <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">([[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_backup_menu&quot;</span><span class="p">)]])</span>
                <span class="p">)</span>
                <span class="k">return</span>
            <span class="c1"># הצג עד 10 אחרונים</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">backups</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;בחר גיבוי לשחזור לריפו:</span><span class="se">\n</span><span class="s2">&lt;code&gt;</span><span class="si">{</span><span class="n">repo_full</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">]</span>
            <span class="n">kb</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;• </span><span class="si">{</span><span class="n">b</span><span class="o">.</span><span class="n">backup_id</span><span class="si">}</span><span class="s2"> — </span><span class="si">{</span><span class="n">b</span><span class="o">.</span><span class="n">created_at</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/%m/%Y %H:%M&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> — </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">total_size</span><span class="o">/</span><span class="mi">1024</span><span class="p">)</span><span class="si">}</span><span class="s2">KB&quot;</span><span class="p">)</span>
                <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;♻️ שחזר גיבוי זה לריפו&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;github_restore_zip_from_backup:</span><span class="si">{</span><span class="n">b</span><span class="o">.</span><span class="n">backup_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
            <span class="n">kb</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_backup_menu&quot;</span><span class="p">)])</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;github_restore_zip_from_backup:&quot;</span><span class="p">):</span>
            <span class="c1"># קבל backup_id ואז פתח את תהליך השחזור-לריפו עם קובץ ה-ZIP הזה</span>
            <span class="n">backup_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
            <span class="kn">from</span> <span class="nn">file_manager</span> <span class="kn">import</span> <span class="n">backup_manager</span>
            <span class="n">info_list</span> <span class="o">=</span> <span class="n">backup_manager</span><span class="o">.</span><span class="n">list_backups</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">match</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">info_list</span> <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">backup_id</span> <span class="o">==</span> <span class="n">backup_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">match</span><span class="o">.</span><span class="n">file_path</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">file_path</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ הגיבוי לא נמצא בדיסק&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="c1"># הגדר purge? בקש בחירה</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;pending_repo_restore_zip_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">file_path</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="s2">&quot;האם למחוק קודם את התוכן בריפו לפני העלאה?&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">([</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🧹 מחיקה מלאה לפני העלאה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_repo_restore_backup_setpurge:1&quot;</span><span class="p">)],</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🚫 אל תמחק, רק עדכן&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_repo_restore_backup_setpurge:0&quot;</span><span class="p">)],</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;❌ ביטול&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;github_backup_menu&quot;</span><span class="p">)],</span>
                <span class="p">])</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;github_repo_restore_backup_setpurge:&quot;</span><span class="p">):</span>
            <span class="c1"># בצע את ההעלאה לריפו מתוך קובץ ה-ZIP שמור בדיסק</span>
            <span class="n">purge_flag</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span>
            <span class="n">zip_path</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pending_repo_restore_zip_path&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">zip_path</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">zip_path</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ קובץ ZIP לא נמצא&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="c1"># הפעל ריסטור לריפו דרך פונקציה חיצונית פשוטה שמתממשקת עם main.handle_document logic</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;⏳ משחזר לריפו מגיבוי נבחר...&quot;</span><span class="p">)</span>
                <span class="c1"># נשתמש בלוגיקה פשוטה: נקרא לפונקציה פנימית שתבצע את אותו זרם של שחזור לריפו</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">restore_zip_file_to_repo</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">zip_path</span><span class="p">,</span> <span class="n">purge_flag</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;✅ השחזור הועלה לריפו בהצלחה&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה בשחזור לריפו: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;pending_repo_restore_zip_path&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">return</span></div>


<div class="viewcode-block" id="GitHubMenuHandler.restore_zip_file_to_repo">
<a class="viewcode-back" href="../modules/index.html#github_menu_handler.GitHubMenuHandler.restore_zip_file_to_repo">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">restore_zip_file_to_repo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">zip_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">purge_first</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;שחזור קבצים מ-ZIP מקומי לריפו הנוכחי באמצעות Trees API (commit אחד)&quot;&quot;&quot;</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">repo_full</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_repo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_full</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;חסר טוקן או ריפו&quot;</span><span class="p">)</span>
        <span class="c1"># חגורת בטיחות: אשר שהיעד תואם את היעד שננעל בתחילת ה-flow</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;zip_restore_expected_repo_full&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">expected</span> <span class="ow">and</span> <span class="n">expected</span> <span class="o">!=</span> <span class="n">repo_full</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[restore_zip_from_backup] Target mismatch: expected=</span><span class="si">{</span><span class="n">expected</span><span class="si">}</span><span class="s2">, got=</span><span class="si">{</span><span class="n">repo_full</span><span class="si">}</span><span class="s2">. Aborting.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Target mismatch: expected </span><span class="si">{</span><span class="n">expected</span><span class="si">}</span><span class="s2">, got </span><span class="si">{</span><span class="n">repo_full</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">expected</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;zip_restore_expected_repo_full&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">repo_full</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="kn">import</span> <span class="nn">zipfile</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">zip_path</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">is_zipfile</span><span class="p">(</span><span class="n">zip_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;ZIP לא תקין&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">zip_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zf</span><span class="p">:</span>
            <span class="c1"># סינון קבצי מערכת לא רלוונטיים</span>
            <span class="n">all_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">zf</span><span class="o">.</span><span class="n">namelist</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)]</span>
            <span class="n">members</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">all_names</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;__MACOSX/&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">n</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;._&#39;</span><span class="p">))]</span>
            <span class="c1"># זיהוי תיקיית-שורש משותפת</span>
            <span class="n">top_levels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">zf</span><span class="o">.</span><span class="n">namelist</span><span class="p">():</span>
                <span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">n</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;__MACOSX/&#39;</span><span class="p">):</span>
                    <span class="n">top_levels</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">common_root</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">top_levels</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">top_levels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[restore_zip_from_backup] Detected common_root=</span><span class="si">{</span><span class="n">common_root</span><span class="si">!r}</span><span class="s2">, files_in_zip=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">members</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">strip_root</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">common_root</span> <span class="ow">and</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">common_root</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">path</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">common_root</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
                <span class="k">return</span> <span class="n">path</span>
            <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">members</span><span class="p">:</span>
                <span class="n">raw</span> <span class="o">=</span> <span class="n">zf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">clean</span> <span class="o">=</span> <span class="n">strip_root</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">clean</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">clean</span><span class="p">,</span> <span class="n">raw</span><span class="p">))</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_full</span><span class="p">)</span>
        <span class="n">target_branch</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">default_branch</span> <span class="ow">or</span> <span class="s1">&#39;main&#39;</span>
        <span class="n">base_ref</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_git_ref</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;heads/</span><span class="si">{</span><span class="n">target_branch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">base_commit</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_git_commit</span><span class="p">(</span><span class="n">base_ref</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">sha</span><span class="p">)</span>
        <span class="n">base_tree</span> <span class="o">=</span> <span class="n">base_commit</span><span class="o">.</span><span class="n">tree</span>
        <span class="n">elements</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">raw</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="c1"># כתוב blob מתאים: טקסט כ-utf-8, בינארי כ-base64</span>
            <span class="kn">import</span> <span class="nn">base64</span>
            <span class="n">is_text</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span> <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="s1">&#39;.md&#39;</span><span class="p">,</span> <span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;.json&#39;</span><span class="p">,</span> <span class="s1">&#39;.yml&#39;</span><span class="p">,</span> <span class="s1">&#39;.yaml&#39;</span><span class="p">,</span> <span class="s1">&#39;.xml&#39;</span><span class="p">,</span> <span class="s1">&#39;.gitignore&#39;</span><span class="p">,</span> <span class="s1">&#39;.py&#39;</span><span class="p">,</span> <span class="s1">&#39;.js&#39;</span><span class="p">,</span> <span class="s1">&#39;.ts&#39;</span><span class="p">,</span> <span class="s1">&#39;.tsx&#39;</span><span class="p">,</span> <span class="s1">&#39;.css&#39;</span><span class="p">,</span> <span class="s1">&#39;.scss&#39;</span><span class="p">,</span> <span class="s1">&#39;.html&#39;</span><span class="p">,</span> <span class="s1">&#39;.sh&#39;</span>
            <span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">is_text</span><span class="p">:</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                    <span class="n">blob</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">create_git_blob</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">b64</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
                    <span class="n">blob</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">create_git_blob</span><span class="p">(</span><span class="n">b64</span><span class="p">,</span> <span class="s1">&#39;base64&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">b64</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
                <span class="n">blob</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">create_git_blob</span><span class="p">(</span><span class="n">b64</span><span class="p">,</span> <span class="s1">&#39;base64&#39;</span><span class="p">)</span>
            <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InputGitTreeElement</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;100644&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;blob&#39;</span><span class="p">,</span> <span class="n">sha</span><span class="o">=</span><span class="n">blob</span><span class="o">.</span><span class="n">sha</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">purge_first</span><span class="p">:</span>
            <span class="c1"># Soft purge: יצירת עץ חדש ללא בסיס (מוחק קבצים שאינם ב-ZIP)</span>
            <span class="n">new_tree</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">create_git_tree</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_tree</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">create_git_tree</span><span class="p">(</span><span class="n">elements</span><span class="p">,</span> <span class="n">base_tree</span><span class="p">)</span>
        <span class="n">commit_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Restore from ZIP via bot: replace </span><span class="si">{</span><span class="s1">&#39;with purge&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">purge_first</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;update only&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">new_commit</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">create_git_commit</span><span class="p">(</span><span class="n">commit_message</span><span class="p">,</span> <span class="n">new_tree</span><span class="p">,</span> <span class="p">[</span><span class="n">base_commit</span><span class="p">])</span>
        <span class="n">base_ref</span><span class="o">.</span><span class="n">edit</span><span class="p">(</span><span class="n">new_commit</span><span class="o">.</span><span class="n">sha</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[restore_zip_from_backup] Restore commit created: </span><span class="si">{</span><span class="n">new_commit</span><span class="o">.</span><span class="n">sha</span><span class="si">}</span><span class="s2">, files_added=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span><span class="si">}</span><span class="s2">, purge=</span><span class="si">{</span><span class="n">purge_first</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># ניקוי סטייט הגנה אחרי הצלחה</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;zip_restore_expected_repo_full&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Development Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>