

<!DOCTYPE html>
<html class="writer-html5" lang="he" data-content_root="../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>main &mdash; ×ª×™×¢×•×“ Code Keeper Bot 1.0.0</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=2d7a82d5" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=0062297a"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/translations.js?v=a336edf7"></script>
      <script type="module" src="https://cdn.jsdelivr.net/npm/mermaid@11.12.1/dist/mermaid.esm.min.mjs"></script>
      <script type="module" src="https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.2.0/dist/mermaid-layout-elk.esm.min.mjs"></script>
      <script type="module">import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.12.1/dist/mermaid.esm.min.mjs";import elkLayouts from "https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.2.0/dist/mermaid-layout-elk.esm.min.mjs";mermaid.registerLayoutLoaders(elkLayouts);mermaid.initialize({startOnLoad:false});</script>
      <script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>
      <script type="module">import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.12.1/dist/mermaid.esm.min.mjs";

const defaultStyle = document.createElement('style');
defaultStyle.textContent = `pre.mermaid {
    /* Same as .mermaid-container > pre */
    display: block;
    width: 100%;
}

pre.mermaid > svg {
    /* Same as .mermaid-container > pre > svg */
    height: 500px;
    width: 100%;
    max-width: 100% !important;
}
`;
document.head.appendChild(defaultStyle);

const fullscreenStyle = document.createElement('style');
fullscreenStyle.textContent = `.mermaid-container {
    display: flex;
    flex-direction: row;
    width: 100%;
}

.mermaid-container > pre {
    display: block;
    width: 100%;
}

.mermaid-container > pre > svg {
    height: 500px;
    width: 100%;
    max-width: 100% !important;
}

.mermaid-fullscreen-btn {
    width: 28px;
    height: 28px;
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(0, 0, 0, 0.3);
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    font-size: 14px;
    line-height: 1;
    padding: 0;
    color: #333;
}

.mermaid-fullscreen-btn:hover {
    opacity: 100% !important;
    background: rgba(255, 255, 255, 1);
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
    transform: scale(1.1);
}

.mermaid-fullscreen-btn.dark-theme {
    background: rgba(50, 50, 50, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: #e0e0e0;
}

.mermaid-fullscreen-btn.dark-theme:hover {
    background: rgba(60, 60, 60, 1);
    box-shadow: 0 3px 10px rgba(255, 255, 255, 0.2);
}

.mermaid-fullscreen-modal {
    display: none;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 95vw;
    height: 100vh;
    background: rgba(255, 255, 255, 0.98);
    z-index: 9999;
    padding: 20px;
    overflow: auto;
}

.mermaid-fullscreen-modal.dark-theme {
    background: rgba(0, 0, 0, 0.98);
}

.mermaid-fullscreen-modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
}

.mermaid-container-fullscreen {
    position: relative;
    width: 95vw;
    height: 90vh;
    max-width: 95vw;
    max-height: 90vh;
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    overflow: auto;
    display: flex;
    align-items: center;
    justify-content: center;
}

.mermaid-container-fullscreen.dark-theme {
    background: #1a1a1a;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
}

.mermaid-container-fullscreen pre.mermaid {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.mermaid-container-fullscreen .mermaid svg {
    height: 100% !important;
    width: 100% !important;
    cursor: grab;
}

.mermaid-fullscreen-close {
    position: fixed !important;
    top: 20px !important;
    right: 20px !important;
    width: 40px;
    height: 40px;
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(0, 0, 0, 0.2);
    border-radius: 50%;
    cursor: pointer;
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    transition: all 0.2s;
    font-size: 24px;
    line-height: 1;
    color: #333;
}

.mermaid-fullscreen-close:hover {
    background: white;
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
    transform: scale(1.1);
}

.mermaid-fullscreen-close.dark-theme {
    background: rgba(50, 50, 50, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: #e0e0e0;
}

.mermaid-fullscreen-close.dark-theme:hover {
    background: rgba(60, 60, 60, 1);
    box-shadow: 0 6px 16px rgba(255, 255, 255, 0.2);
}

.mermaid-fullscreen-modal .mermaid-fullscreen-btn {
    display: none !important;
}`;
document.head.appendChild(fullscreenStyle);

// Detect if page has dark background
const isDarkTheme = () => {
    const bgColor = window.getComputedStyle(document.body).backgroundColor;
    const match = bgColor.match(/rgb\((\d+),\s*(\d+),\s*(\d+)/);
    if (match) {
        const r = parseInt(match[1]);
        const g = parseInt(match[2]);
        const b = parseInt(match[3]);
        const brightness = (r * 299 + g * 587 + b * 114) / 1000;
        return brightness < 128;
    }
    return false;
};

const load = async () => {
    await mermaid.run();

    const all_mermaids = document.querySelectorAll(".mermaid");
    const mermaids_processed = document.querySelectorAll(".mermaid[data-processed='true']");

    if ("False" === "True") {
        const mermaids_to_add_zoom = -1 === -1 ? all_mermaids.length : -1;
        if(mermaids_to_add_zoom > 0) {
            var svgs = d3.selectAll("");
            if(all_mermaids.length !== mermaids_processed.length) {
                setTimeout(load, 200);
                return;
            } else if(svgs.size() !== mermaids_to_add_zoom) {
                setTimeout(load, 200);
                return;
            } else {
                svgs.each(function() {
                    var svg = d3.select(this);
                    svg.html("<g class='wrapper'>" + svg.html() + "</g>");
                    var inner = svg.select("g");
                    var zoom = d3.zoom().on("zoom", function(event) {
                        inner.attr("transform", event.transform);
                    });
                    svg.call(zoom);
                });
            }
        }
    } else if(all_mermaids.length !== mermaids_processed.length) {
        // Wait for mermaid to process all diagrams
        setTimeout(load, 200);
        return;
    }

    const darkTheme = isDarkTheme();

    // Stop here if not adding fullscreen capability
    if ("True" !== "True") return;

    const modal = document.createElement('div');
    modal.className = 'mermaid-fullscreen-modal' + (darkTheme ? ' dark-theme' : '');
    modal.setAttribute('role', 'dialog');
    modal.setAttribute('aria-modal', 'true');
    modal.setAttribute('aria-label', 'Fullscreen diagram viewer');
    modal.innerHTML = `
        <button class="mermaid-fullscreen-close${darkTheme ? ' dark-theme' : ''}" aria-label="Close fullscreen">âœ•</button>
        <div class="mermaid-container-fullscreen${darkTheme ? ' dark-theme' : ''}"></div>
    `;
    document.body.appendChild(modal);

    const modalContent = modal.querySelector('.mermaid-container-fullscreen');
    const closeBtn = modal.querySelector('.mermaid-fullscreen-close');

    let previousScrollOffset = [window.scrollX, window.scrollY];

    const closeModal = () => {
        modal.classList.remove('active');
        modalContent.innerHTML = '';
        document.body.style.overflow = ''
        window.scrollTo({left: previousScrollOffset[0], top: previousScrollOffset[1], behavior: 'instant'});
    };

    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('active')) {
            closeModal();
        }
    });

    const allButtons = [];

    document.querySelectorAll('.mermaid').forEach((mermaidDiv) => {
        if (mermaidDiv.parentNode.classList.contains('mermaid-container') ||
            mermaidDiv.closest('.mermaid-fullscreen-modal')) {
            return;
        }

        const container = document.createElement('div');
        container.className = 'mermaid-container';
        mermaidDiv.parentNode.insertBefore(container, mermaidDiv);
        container.appendChild(mermaidDiv);

        const fullscreenBtn = document.createElement('button');
        fullscreenBtn.className = 'mermaid-fullscreen-btn' + (darkTheme ? ' dark-theme' : '');
        fullscreenBtn.setAttribute('aria-label', 'View diagram in fullscreen');
        fullscreenBtn.textContent = 'â›¶';
        fullscreenBtn.style.opacity = '50%';

        // Calculate dynamic position based on diagram's margin and padding
        const diagramStyle = window.getComputedStyle(mermaidDiv);
        const marginTop = parseFloat(diagramStyle.marginTop) || 0;
        const marginRight = parseFloat(diagramStyle.marginRight) || 0;
        const paddingTop = parseFloat(diagramStyle.paddingTop) || 0;
        const paddingRight = parseFloat(diagramStyle.paddingRight) || 0;
        fullscreenBtn.style.top = `${marginTop + paddingTop + 4}px`;
        fullscreenBtn.style.right = `${marginRight + paddingRight + 4}px`;

        fullscreenBtn.addEventListener('click', () => {
            previousScrollOffset = [window.scroll, window.scrollY];
            const clone = mermaidDiv.cloneNode(true);
            modalContent.innerHTML = '';
            modalContent.appendChild(clone);

            const svg = clone.querySelector('svg');
            if (svg) {
                svg.removeAttribute('width');
                svg.removeAttribute('height');
                svg.style.width = '100%';
                svg.style.height = 'auto';
                svg.style.maxWidth = '100%';
                svg.style.sdisplay = 'block';

                if ("False" === "True") {
                    setTimeout(() => {
                        const g = svg.querySelector('g');
                        if (g) {
                            var svgD3 = d3.select(svg);
                            svgD3.html("<g class='wrapper'>" + svgD3.html() + "</g>");
                            var inner = svgD3.select("g");
                            var zoom = d3.zoom().on("zoom", function(event) {
                                inner.attr("transform", event.transform);
                            });
                            svgD3.call(zoom);
                        }
                    }, 100);
                }
            }

            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        });

        container.appendChild(fullscreenBtn);
        allButtons.push(fullscreenBtn);
    });

    // Update theme classes when theme changes
    const updateTheme = () => {
        const dark = isDarkTheme();
        allButtons.forEach(btn => {
            if (dark) {
                btn.classList.add('dark-theme');
            } else {
                btn.classList.remove('dark-theme');
            }
        });
        if (dark) {
            modal.classList.add('dark-theme');
            modalContent.classList.add('dark-theme');
            closeBtn.classList.add('dark-theme');
        } else {
            modal.classList.remove('dark-theme');
            modalContent.classList.remove('dark-theme');
            closeBtn.classList.remove('dark-theme');
        }
    };

    // Watch for theme changes
    const observer = new MutationObserver(updateTheme);
    observer.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ['class', 'style', 'data-theme']
    });
    observer.observe(document.body, {
        attributes: true,
        attributeFilter: ['class', 'style']
    });
};

window.addEventListener("load", load);
</script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="××™× ×“×§×¡" href="../genindex.html" />
    <link rel="search" title="×—×™×¤×•×©" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Code Keeper Bot
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">×œ××¤×ª×—×™× ×•×œ×¡×•×›× ×™ AI:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quickstart-ai.html">×”×ª×—×œ×” ××”×™×¨×” - ×¡×•×›× ×™ AI</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#id1">××˜×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#id2">××” ××¡×•×¨</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#id3">××” ××•×ª×¨ ×•××•××œ×¥</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#id4">×¤×•×¨××˜×™ ×¦×™×˜×•×˜ ×§×•×“</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#tmp">××—×™×§×” ×‘×˜×•×—×” (×¨×§ ×‘-/tmp)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#pr">×§×•××™×˜×™× ×•-PR</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#id5">×§×™×©×•×¨×™× ××”×™×¨×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#cheatsheet-github-cli-gh">Cheatsheet â€“ GitHub CLI (gh)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">×”×ª×—×œ×” ××”×™×¨×” - ××¤×ª×—×™×</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#id2">××˜×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#id3">×©×œ×‘ 1: ×”×ª×§× ×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#env">×©×œ×‘ 2: ×”×’×“×¨×ª .env</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#id4">×©×œ×‘ 3: ×”×¨×¦×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#id5">××” ×”×œ××”?</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart-contrib.html">Quickstart ×œ×ª×¨×•××”</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-contrib.html#id1">××˜×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-contrib.html#id2">×¦×¢×“×™ ×”×›× ×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-contrib.html#id3">×¡×‘×™×‘×ª ×¤×™×ª×•×—</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-contrib.html#id4">×”×¨×¦×ª ×˜×¡×˜×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-contrib.html#stubs">×¢×œ ×”â€‘Stubs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-contrib.html#id5">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ai-guidelines.html">×”× ×—×™×•×ª ××œ××•×ª ×œ×¡×•×›× ×™ AI</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../ai-guidelines.html#id1">××’×‘×œ×•×ª ×§×¨×™×˜×™×•×ª</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../ai-guidelines.html#id2">×”×¨×¦×ª ×¤×§×•×“×•×ª</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../ai-guidelines.html#id3">×›×œ×™ ×§×‘×¦×™× ×××•×©×¨×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ai-guidelines.html#id4">×¢×§×¨×•× ×•×ª ×¢×¨×™×›×ª ×§×•×“</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ai-guidelines.html#pull-requests">×§×•××™×˜×™× ×•-Pull Requests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ai-guidelines.html#id5">×¢×‘×•×“×” ×¢× ×˜×¡×˜×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ai-guidelines.html#id6">×§×™×©×•×¨×™× ××”×™×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../agents/rate-limiting.html">ğŸš¦ ××¢×¨×›×ª Rate Limiting ×œ×¡×•×›× ×™ AI ×•×œ×•×•×‘</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#shadow-mode">××¡×˜×¨×˜×’×™×” â€“ Shadow Mode ×ª×—×™×œ×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#id1">××©×ª× ×™ ×¡×‘×™×‘×” ×•×§×•× ×¤×™×’</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#id2">××™× ×˜×’×¨×¦×™×” â€“ ×‘×•×˜ ×˜×œ×’×¨×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#flask-webapp">××™× ×˜×’×¨×¦×™×” â€“ Flask/WebApp</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#id3">×”×—×¨×’×•×ª ×—×©×•×‘×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#prometheus">× ×™×˜×•×¨ ×•××“×“×™× (Prometheus)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#id4">××‘×˜×—×” ×•×”×’× ×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#pydantic-settings">×§×•× ×¤×™×’×•×¨×¦×™×” (Pydantic Settings)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#id5">×ª×§×œ×•×ª × ×¤×•×¦×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#id6">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../doc-authoring.html">Doc Authoring Guide (Sphinx/RTD)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../doc-authoring.html#id1">××˜×¨×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../doc-authoring.html#id2">××“×™× ×™×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../doc-authoring.html#id3">×˜×™×¤×™× ××”×™×¨×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../doc-authoring.html#id4">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../style-glossary.html">Style &amp; Naming Glossary</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../style-glossary.html#id1">××˜×¨×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../style-glossary.html#id2">××™×¤×•×™ ××•× ×—×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../style-glossary.html#id3">×›×œ×œ×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../style-glossary.html#id4">×¢×•×’× ×™ ×ª×™×¢×•×“</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../versioning-stable-anchors.html">Versioning &amp; Stable Anchors</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../versioning-stable-anchors.html#id1">××“×™× ×™×•×ª ×¢×•×’× ×™× ×™×¦×™×‘×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../versioning-stable-anchors.html#whats-new">Whatâ€™s New</a></li>
<li class="toctree-l2"><a class="reference internal" href="../versioning-stable-anchors.html#anchors">×“×•×’××ª Anchors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../versioning-stable-anchors.html#id2">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../whats-new.html">Whatâ€™s New</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../whats-new.html#id1">2025-11-11</a></li>
<li class="toctree-l2"><a class="reference internal" href="../whats-new.html#id2">2025-11-06</a></li>
<li class="toctree-l2"><a class="reference internal" href="../whats-new.html#id3">2025-11-05</a></li>
<li class="toctree-l2"><a class="reference internal" href="../whats-new.html#id4">2025-10-30</a></li>
<li class="toctree-l2"><a class="reference internal" href="../whats-new.html#id5">2025-10-29</a></li>
<li class="toctree-l2"><a class="reference internal" href="../whats-new.html#id6">2025-10-15</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../architecture.html">××¨×›×™×˜×§×˜×•×¨×”</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#id2">×¡×§×™×¨×” ×›×œ×œ×™×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#id3">×ª×¨×©×™× ×¨×›×™×‘×™× (×ª××¦×™×ª×™)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#id4">××‘× ×” ×ª×™×§×™×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#id5">×–×¨×™××•×ª ××¨×›×–×™×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#id6">×§×™×©×•×¨×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#http-aiohttp">×ª×©×ª×™×ª HTTP â€“ ×¡×©×Ÿ aiohttp ××©×•×ª×£</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#documenthandler">×”×¤×¨×“×ª ××—×¨×™×•×ª â€“ DocumentHandler</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">××“×¨×™×š ×ª×¨×•××”</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../contributing.html#id2">××˜×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributing.html#id3">×›×œ×œ×™× ×›×œ×œ×™×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributing.html#workflow">Workflow ×‘×¡×™×¡×™</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributing.html#pre-commit">Pre-commit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributing.html#conventional-commits">Conventional Commits</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributing.html#id4">×“×•×’×××•×ª ×©×™××•×©×™×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributing.html#id5">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../branch-protection-and-pr-rules.html">Branch Protection &amp; PR Rules</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../branch-protection-and-pr-rules.html#id1">××˜×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../branch-protection-and-pr-rules.html#id2">×›×œ×œ×™ ×¢× ×¤×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../branch-protection-and-pr-rules.html#pr">×—×•×§×™ PR</a></li>
<li class="toctree-l2"><a class="reference internal" href="../branch-protection-and-pr-rules.html#ci-required-checks">CI â€“ Required Checks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../branch-protection-and-pr-rules.html#id3">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">××“×¨×™×›×™× ×‘×¡×™×¡×™×™×:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">×”×ª×§× ×” ×•×”×’×“×¨×”</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#id2">×“×¨×™×©×•×ª ××¢×¨×›×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#id3">×”×ª×§× ×” ××”×™×¨×”</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#id4">1. ×©×›×¤×œ ××ª ×”×¨×™×¤×•×–×™×˜×•×¨×™</a></li>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#id5">2. ×”×ª×§×Ÿ ×ª×œ×•×™×•×ª</a></li>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#id6">3. ×”×’×“×¨ ××©×ª× ×™ ×¡×‘×™×‘×”</a></li>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#id7">4. ×”×¤×¢×œ ××ª ×”×‘×•×˜</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#docker">×”×ª×§× ×” ×¢× Docker</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#image">1. ×‘× ×” ××ª ×”-Image</a></li>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#docker-compose">2. ×”×¤×¢×œ ×¢× Docker Compose</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#mongodb">×”×’×“×¨×ª MongoDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#telegram-bot">×”×’×“×¨×ª Telegram Bot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#id8">×”×’×“×¨×•×ª ××ª×§×“××•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#id9">×‘×“×™×§×ª ×”×ª×§× ×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#id10">×¤×ª×¨×•×Ÿ ×‘×¢×™×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#id11">×ª××™×›×”</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../configuration.html">Rate Limiting</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#environment-variables">Environment variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#databases-and-cache-pooling-timeouts">Databases and Cache (Pooling/Timeouts)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#http-clients">HTTP Clients</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#http-async-async-http">×©×™××•×© ×‘â€‘http_async (Async HTTP)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#http-sync-sync-http">×©×™××•×© ×‘â€‘http_sync (Sync HTTP)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#flask">Flask</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#telegram-bot">Telegram Bot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#metrics">Metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#security">Security</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#id1">Databases and Cache (Pooling/Timeouts)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#id2">HTTP Clients</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#id3">×©×™××•×© ×‘-http_sync (Sync HTTP)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../configuration.html#config-via-pydantic-settings">Config via Pydantic Settings</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#id4">×”×™×¨×¨×›×™×™×ª ×˜×¢×™× ×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#id5">×•×œ×™×“×¦×™×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#env-example">.env.example</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#id6">×©×™××•×© ×œ×¡×•×›× ×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#id7">×¤×¨××˜×¨×™ ×§×•× ×¤×™×’×•×¨×¦×™×” ××¨×›×–×™×™× (×—×“×©×™×)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#id8">××™×—×•×“ ×ª×™×¢×•×“ ×§×•× ×¤×™×’×•×¨×¦×™×”</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../environment-variables.html">××©×ª× ×™ ×¡×‘×™×‘×” - ×¨×¤×¨× ×¡</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../environment-variables.html#id2">×˜×‘×œ×” ××¨×›×–×™×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../environment-variables.html#id3">×“×•×’×××•×ª ×§×•× ×¤×™×’×•×¨×¦×™×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../environment-variables.html#id4">×§×™×©×•×¨×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../environment-variables.html#scopes-github">×˜×‘×œ×ª Scopes ×œ×¤×™×¦â€™×¨×™× ×©×œ GitHub</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../performance-scaling.html">×‘×™×¦×•×¢×™× ×•×”×¨×—×‘×” (Performance &amp; Scaling)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../performance-scaling.html#pagination">×¢×™××•×“ (Pagination)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance-scaling.html#projection">Projection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance-scaling.html#id1">×“×’×©×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance-scaling.html#connection-pooling-timeouts">×›×•×•× ×•×Ÿ Connection Pooling ×•-Timeouts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance-scaling.html#id2">×œ×•×’×™ ××™×˜×™×•×ª (××”×™×¨ ×œ××™×ª×•×¨ ×¦×•×•××¨×™ ×‘×§×‘×•×§)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance-scaling.html#env">×‘×“×™×§×•×ª ××”×™×¨×•×ª ××—×¨×™ ×©×™× ×•×™ ENV</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance-scaling.html#id3">×”× ×—×™×•×ª ×œ×¤×™ ×¡×‘×™×‘×”</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../large-files-runbook.html">×˜×™×¤×•×œ ×‘×§×‘×¦×™× ×’×“×•×œ×™× (Large Files)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../large-files-runbook.html#id1">××’×‘×œ×•×ª ×•×¤×•×œ×‘×§×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../large-files-runbook.html#id2">×”× ×—×™×•×ª ×”×¤×¢×œ×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../large-files-runbook.html#id3">× ×™×˜×•×¨</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../api/main.html">main module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.get_admin_ids"><code class="docutils literal notranslate"><span class="pre">get_admin_ids()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.notify_admins"><code class="docutils literal notranslate"><span class="pre">notify_admins()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.recycle_backfill_command"><code class="docutils literal notranslate"><span class="pre">recycle_backfill_command()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.log_user_activity"><code class="docutils literal notranslate"><span class="pre">log_user_activity()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.get_lock_collection"><code class="docutils literal notranslate"><span class="pre">get_lock_collection()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.ensure_lock_indexes"><code class="docutils literal notranslate"><span class="pre">ensure_lock_indexes()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.cleanup_mongo_lock"><code class="docutils literal notranslate"><span class="pre">cleanup_mongo_lock()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.manage_mongo_lock"><code class="docutils literal notranslate"><span class="pre">manage_mongo_lock()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.HelpEntry"><code class="docutils literal notranslate"><span class="pre">HelpEntry</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.HelpEntry.commands"><code class="docutils literal notranslate"><span class="pre">HelpEntry.commands</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.HelpEntry.description"><code class="docutils literal notranslate"><span class="pre">HelpEntry.description</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.HelpEntry.suffix"><code class="docutils literal notranslate"><span class="pre">HelpEntry.suffix</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.HelpSection"><code class="docutils literal notranslate"><span class="pre">HelpSection</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.HelpSection.title"><code class="docutils literal notranslate"><span class="pre">HelpSection.title</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.HelpSection.entries"><code class="docutils literal notranslate"><span class="pre">HelpSection.entries</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.application"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.application</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.github_handler"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.github_handler</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.backup_handler"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.backup_handler</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.__init__"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.setup_handlers"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.setup_handlers()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.help_command"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.help_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.save_command"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.save_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.list_command"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.list_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.search_command"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.search_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.check_commands"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.check_commands()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.stats_command"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.stats_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.handle_document"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.handle_document()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.handle_text_message"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.handle_text_message()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.error_handler"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.error_handler()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.start"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.start()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.stop"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.stop()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.signal_handler"><code class="docutils literal notranslate"><span class="pre">signal_handler()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.setup_handlers"><code class="docutils literal notranslate"><span class="pre">setup_handlers()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.main"><code class="docutils literal notranslate"><span class="pre">main()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.setup_bot_data"><code class="docutils literal notranslate"><span class="pre">setup_bot_data()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/config.html">config module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/config.html#config.BotConfig"><code class="docutils literal notranslate"><span class="pre">BotConfig</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.BOT_TOKEN"><code class="docutils literal notranslate"><span class="pre">BotConfig.BOT_TOKEN</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MONGODB_URL"><code class="docutils literal notranslate"><span class="pre">BotConfig.MONGODB_URL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.DATABASE_NAME"><code class="docutils literal notranslate"><span class="pre">BotConfig.DATABASE_NAME</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MONGODB_MAX_POOL_SIZE"><code class="docutils literal notranslate"><span class="pre">BotConfig.MONGODB_MAX_POOL_SIZE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MONGODB_MIN_POOL_SIZE"><code class="docutils literal notranslate"><span class="pre">BotConfig.MONGODB_MIN_POOL_SIZE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MONGODB_MAX_IDLE_TIME_MS"><code class="docutils literal notranslate"><span class="pre">BotConfig.MONGODB_MAX_IDLE_TIME_MS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MONGODB_WAIT_QUEUE_TIMEOUT_MS"><code class="docutils literal notranslate"><span class="pre">BotConfig.MONGODB_WAIT_QUEUE_TIMEOUT_MS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MONGODB_SERVER_SELECTION_TIMEOUT_MS"><code class="docutils literal notranslate"><span class="pre">BotConfig.MONGODB_SERVER_SELECTION_TIMEOUT_MS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MONGODB_SOCKET_TIMEOUT_MS"><code class="docutils literal notranslate"><span class="pre">BotConfig.MONGODB_SOCKET_TIMEOUT_MS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MONGODB_CONNECT_TIMEOUT_MS"><code class="docutils literal notranslate"><span class="pre">BotConfig.MONGODB_CONNECT_TIMEOUT_MS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MONGODB_RETRY_WRITES"><code class="docutils literal notranslate"><span class="pre">BotConfig.MONGODB_RETRY_WRITES</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MONGODB_RETRY_READS"><code class="docutils literal notranslate"><span class="pre">BotConfig.MONGODB_RETRY_READS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MONGODB_APPNAME"><code class="docutils literal notranslate"><span class="pre">BotConfig.MONGODB_APPNAME</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MONGODB_COMPRESSORS"><code class="docutils literal notranslate"><span class="pre">BotConfig.MONGODB_COMPRESSORS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MONGODB_HEARTBEAT_FREQUENCY_MS"><code class="docutils literal notranslate"><span class="pre">BotConfig.MONGODB_HEARTBEAT_FREQUENCY_MS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.REDIS_URL"><code class="docutils literal notranslate"><span class="pre">BotConfig.REDIS_URL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.CACHE_ENABLED"><code class="docutils literal notranslate"><span class="pre">BotConfig.CACHE_ENABLED</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.REDIS_MAX_CONNECTIONS"><code class="docutils literal notranslate"><span class="pre">BotConfig.REDIS_MAX_CONNECTIONS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.REDIS_CONNECT_TIMEOUT"><code class="docutils literal notranslate"><span class="pre">BotConfig.REDIS_CONNECT_TIMEOUT</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.REDIS_SOCKET_TIMEOUT"><code class="docutils literal notranslate"><span class="pre">BotConfig.REDIS_SOCKET_TIMEOUT</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.AIOHTTP_POOL_LIMIT"><code class="docutils literal notranslate"><span class="pre">BotConfig.AIOHTTP_POOL_LIMIT</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.AIOHTTP_TIMEOUT_TOTAL"><code class="docutils literal notranslate"><span class="pre">BotConfig.AIOHTTP_TIMEOUT_TOTAL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.AIOHTTP_LIMIT_PER_HOST"><code class="docutils literal notranslate"><span class="pre">BotConfig.AIOHTTP_LIMIT_PER_HOST</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.REQUESTS_POOL_CONNECTIONS"><code class="docutils literal notranslate"><span class="pre">BotConfig.REQUESTS_POOL_CONNECTIONS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.REQUESTS_POOL_MAXSIZE"><code class="docutils literal notranslate"><span class="pre">BotConfig.REQUESTS_POOL_MAXSIZE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.REQUESTS_TIMEOUT"><code class="docutils literal notranslate"><span class="pre">BotConfig.REQUESTS_TIMEOUT</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.REQUESTS_RETRIES"><code class="docutils literal notranslate"><span class="pre">BotConfig.REQUESTS_RETRIES</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.REQUESTS_RETRY_BACKOFF"><code class="docutils literal notranslate"><span class="pre">BotConfig.REQUESTS_RETRY_BACKOFF</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.RATE_LIMIT_ENABLED"><code class="docutils literal notranslate"><span class="pre">BotConfig.RATE_LIMIT_ENABLED</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.RATE_LIMIT_SHADOW_MODE"><code class="docutils literal notranslate"><span class="pre">BotConfig.RATE_LIMIT_SHADOW_MODE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.RATE_LIMIT_STRATEGY"><code class="docutils literal notranslate"><span class="pre">BotConfig.RATE_LIMIT_STRATEGY</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.ADMIN_USER_IDS"><code class="docutils literal notranslate"><span class="pre">BotConfig.ADMIN_USER_IDS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.GITHUB_TOKEN"><code class="docutils literal notranslate"><span class="pre">BotConfig.GITHUB_TOKEN</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.PASTEBIN_API_KEY"><code class="docutils literal notranslate"><span class="pre">BotConfig.PASTEBIN_API_KEY</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MAX_CODE_SIZE"><code class="docutils literal notranslate"><span class="pre">BotConfig.MAX_CODE_SIZE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MAX_FILES_PER_USER"><code class="docutils literal notranslate"><span class="pre">BotConfig.MAX_FILES_PER_USER</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.SUPPORTED_LANGUAGES"><code class="docutils literal notranslate"><span class="pre">BotConfig.SUPPORTED_LANGUAGES</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.RECYCLE_TTL_DAYS"><code class="docutils literal notranslate"><span class="pre">BotConfig.RECYCLE_TTL_DAYS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.PUBLIC_BASE_URL"><code class="docutils literal notranslate"><span class="pre">BotConfig.PUBLIC_BASE_URL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.WEBAPP_URL"><code class="docutils literal notranslate"><span class="pre">BotConfig.WEBAPP_URL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MAINTENANCE_MODE"><code class="docutils literal notranslate"><span class="pre">BotConfig.MAINTENANCE_MODE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MAINTENANCE_MESSAGE"><code class="docutils literal notranslate"><span class="pre">BotConfig.MAINTENANCE_MESSAGE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MAINTENANCE_AUTO_WARMUP_SECS"><code class="docutils literal notranslate"><span class="pre">BotConfig.MAINTENANCE_AUTO_WARMUP_SECS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MAINTENANCE_WARMUP_GRACE_SECS"><code class="docutils literal notranslate"><span class="pre">BotConfig.MAINTENANCE_WARMUP_GRACE_SECS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.RATE_LIMIT_PER_MINUTE"><code class="docutils literal notranslate"><span class="pre">BotConfig.RATE_LIMIT_PER_MINUTE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.HIGHLIGHT_THEME"><code class="docutils literal notranslate"><span class="pre">BotConfig.HIGHLIGHT_THEME</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.GIT_CHECKPOINT_PREFIX"><code class="docutils literal notranslate"><span class="pre">BotConfig.GIT_CHECKPOINT_PREFIX</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.GOOGLE_CLIENT_ID"><code class="docutils literal notranslate"><span class="pre">BotConfig.GOOGLE_CLIENT_ID</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.GOOGLE_CLIENT_SECRET"><code class="docutils literal notranslate"><span class="pre">BotConfig.GOOGLE_CLIENT_SECRET</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.GOOGLE_OAUTH_SCOPES"><code class="docutils literal notranslate"><span class="pre">BotConfig.GOOGLE_OAUTH_SCOPES</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.GOOGLE_TOKEN_REFRESH_MARGIN_SECS"><code class="docutils literal notranslate"><span class="pre">BotConfig.GOOGLE_TOKEN_REFRESH_MARGIN_SECS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.DRIVE_MENU_V2"><code class="docutils literal notranslate"><span class="pre">BotConfig.DRIVE_MENU_V2</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.DOCUMENTATION_URL"><code class="docutils literal notranslate"><span class="pre">BotConfig.DOCUMENTATION_URL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.BOT_LABEL"><code class="docutils literal notranslate"><span class="pre">BotConfig.BOT_LABEL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.DRIVE_ADD_HASH"><code class="docutils literal notranslate"><span class="pre">BotConfig.DRIVE_ADD_HASH</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.NORMALIZE_CODE_ON_SAVE"><code class="docutils literal notranslate"><span class="pre">BotConfig.NORMALIZE_CODE_ON_SAVE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.FEATURE_MY_COLLECTIONS"><code class="docutils literal notranslate"><span class="pre">BotConfig.FEATURE_MY_COLLECTIONS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.COMMUNITY_LIBRARY_ENABLED"><code class="docutils literal notranslate"><span class="pre">BotConfig.COMMUNITY_LIBRARY_ENABLED</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.SEARCH_PAGE_SIZE"><code class="docutils literal notranslate"><span class="pre">BotConfig.SEARCH_PAGE_SIZE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.UI_PAGE_SIZE"><code class="docutils literal notranslate"><span class="pre">BotConfig.UI_PAGE_SIZE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.SENTRY_DSN"><code class="docutils literal notranslate"><span class="pre">BotConfig.SENTRY_DSN</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.SENTRY_TEST_BUTTON_ENABLED"><code class="docutils literal notranslate"><span class="pre">BotConfig.SENTRY_TEST_BUTTON_ENABLED</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.METRICS_DB_ENABLED"><code class="docutils literal notranslate"><span class="pre">BotConfig.METRICS_DB_ENABLED</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.METRICS_COLLECTION"><code class="docutils literal notranslate"><span class="pre">BotConfig.METRICS_COLLECTION</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.METRICS_BATCH_SIZE"><code class="docutils literal notranslate"><span class="pre">BotConfig.METRICS_BATCH_SIZE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.METRICS_FLUSH_INTERVAL_SEC"><code class="docutils literal notranslate"><span class="pre">BotConfig.METRICS_FLUSH_INTERVAL_SEC</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.model_config"><code class="docutils literal notranslate"><span class="pre">BotConfig.model_config</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.settings_customise_sources"><code class="docutils literal notranslate"><span class="pre">BotConfig.settings_customise_sources()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/config.html#config.load_config"><code class="docutils literal notranslate"><span class="pre">load_config()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/bot_handlers.html">bot_handlers module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.set_activity_reporter"><code class="docutils literal notranslate"><span class="pre">set_activity_reporter()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.__init__"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.setup_advanced_handlers"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.setup_advanced_handlers()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.show_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.show_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.favorite_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.favorite_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.favorites_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.favorites_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.edit_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.edit_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.delete_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.delete_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.versions_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.versions_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.analyze_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.analyze_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.status_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.status_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.sentry_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.sentry_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.uptime_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.uptime_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.observe_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.observe_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.alerts_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.alerts_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.incidents_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.incidents_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.predict_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.predict_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.silence_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.silence_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.unsilence_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.unsilence_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.silences_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.silences_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.accuracy_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.accuracy_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.errors_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.errors_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.triage_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.triage_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.system_info_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.system_info_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.metrics_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.metrics_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.rate_limit_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.rate_limit_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.enable_backoff_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.enable_backoff_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.disable_backoff_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.disable_backoff_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.validate_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.validate_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.share_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.share_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.share_help_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.share_help_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.help_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.help_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.download_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.download_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.tags_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.tags_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.recent_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.recent_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.info_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.info_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.search_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.search_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.broadcast_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.broadcast_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.dm_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.dm_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.handle_callback_query"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.handle_callback_query()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.lang_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.lang_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.lang_debug_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.lang_debug_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.image_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.image_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.preview_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.preview_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers.image_all_command"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers.image_all_command()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.check_db_connection"><code class="docutils literal notranslate"><span class="pre">check_db_connection()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/conversation_handlers.html">conversation_handlers module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.set_activity_reporter"><code class="docutils literal notranslate"><span class="pre">set_activity_reporter()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.start_command"><code class="docutils literal notranslate"><span class="pre">start_command()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_community_hub"><code class="docutils literal notranslate"><span class="pre">show_community_hub()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_catalog_menu"><code class="docutils literal notranslate"><span class="pre">community_catalog_menu()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippets_menu"><code class="docutils literal notranslate"><span class="pre">snippets_menu()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_hub_callback"><code class="docutils literal notranslate"><span class="pre">community_hub_callback()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.main_menu_callback"><code class="docutils literal notranslate"><span class="pre">main_menu_callback()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.submit_flows_cancel"><code class="docutils literal notranslate"><span class="pre">submit_flows_cancel()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_help_page"><code class="docutils literal notranslate"><span class="pre">show_help_page()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.setup_favorites_category_handlers"><code class="docutils literal notranslate"><span class="pre">setup_favorites_category_handlers()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.start_repo_zip_import"><code class="docutils literal notranslate"><span class="pre">start_repo_zip_import()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.start_zip_create_flow"><code class="docutils literal notranslate"><span class="pre">start_zip_create_flow()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_by_repo_menu"><code class="docutils literal notranslate"><span class="pre">show_by_repo_menu()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_by_repo_menu_callback"><code class="docutils literal notranslate"><span class="pre">show_by_repo_menu_callback()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_all_files"><code class="docutils literal notranslate"><span class="pre">show_all_files()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_large_files_direct"><code class="docutils literal notranslate"><span class="pre">show_large_files_direct()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_github_menu"><code class="docutils literal notranslate"><span class="pre">show_github_menu()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_all_files_callback"><code class="docutils literal notranslate"><span class="pre">show_all_files_callback()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_submit_start"><code class="docutils literal notranslate"><span class="pre">community_submit_start()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_collect_title"><code class="docutils literal notranslate"><span class="pre">community_collect_title()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_collect_description"><code class="docutils literal notranslate"><span class="pre">community_collect_description()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_collect_url"><code class="docutils literal notranslate"><span class="pre">community_collect_url()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_collect_logo"><code class="docutils literal notranslate"><span class="pre">community_collect_logo()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_inline_approve"><code class="docutils literal notranslate"><span class="pre">community_inline_approve()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_reject_start"><code class="docutils literal notranslate"><span class="pre">community_reject_start()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_collect_reject_reason"><code class="docutils literal notranslate"><span class="pre">community_collect_reject_reason()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_queue_command"><code class="docutils literal notranslate"><span class="pre">community_queue_command()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_approve_command"><code class="docutils literal notranslate"><span class="pre">community_approve_command()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_reject_command"><code class="docutils literal notranslate"><span class="pre">community_reject_command()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_submit_start"><code class="docutils literal notranslate"><span class="pre">snippet_submit_start()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_collect_title"><code class="docutils literal notranslate"><span class="pre">snippet_collect_title()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_collect_description"><code class="docutils literal notranslate"><span class="pre">snippet_collect_description()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_mode_regular_start"><code class="docutils literal notranslate"><span class="pre">snippet_mode_regular_start()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_mode_long_start"><code class="docutils literal notranslate"><span class="pre">snippet_mode_long_start()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_long_collect_receive"><code class="docutils literal notranslate"><span class="pre">snippet_long_collect_receive()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_long_collect_done"><code class="docutils literal notranslate"><span class="pre">snippet_long_collect_done()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_collect_code"><code class="docutils literal notranslate"><span class="pre">snippet_collect_code()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_collect_language"><code class="docutils literal notranslate"><span class="pre">snippet_collect_language()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_inline_approve"><code class="docutils literal notranslate"><span class="pre">snippet_inline_approve()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_reject_start"><code class="docutils literal notranslate"><span class="pre">snippet_reject_start()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_collect_reject_reason"><code class="docutils literal notranslate"><span class="pre">snippet_collect_reject_reason()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_queue_command"><code class="docutils literal notranslate"><span class="pre">snippet_queue_command()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_approve_command"><code class="docutils literal notranslate"><span class="pre">snippet_approve_command()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_reject_command"><code class="docutils literal notranslate"><span class="pre">snippet_reject_command()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_regular_files_callback"><code class="docutils literal notranslate"><span class="pre">show_regular_files_callback()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_favorites_callback"><code class="docutils literal notranslate"><span class="pre">show_favorites_callback()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_favorites_page_callback"><code class="docutils literal notranslate"><span class="pre">show_favorites_page_callback()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_regular_files_page_callback"><code class="docutils literal notranslate"><span class="pre">show_regular_files_page_callback()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_recycle_bin"><code class="docutils literal notranslate"><span class="pre">show_recycle_bin()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.recycle_restore"><code class="docutils literal notranslate"><span class="pre">recycle_restore()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.recycle_purge"><code class="docutils literal notranslate"><span class="pre">recycle_purge()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.share_single_by_id"><code class="docutils literal notranslate"><span class="pre">share_single_by_id()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_duplicate_callback"><code class="docutils literal notranslate"><span class="pre">handle_duplicate_callback()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_file_menu"><code class="docutils literal notranslate"><span class="pre">handle_file_menu()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_view_file"><code class="docutils literal notranslate"><span class="pre">handle_view_file()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_edit_code"><code class="docutils literal notranslate"><span class="pre">handle_edit_code()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.receive_new_code"><code class="docutils literal notranslate"><span class="pre">receive_new_code()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_edit_name"><code class="docutils literal notranslate"><span class="pre">handle_edit_name()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_edit_note"><code class="docutils literal notranslate"><span class="pre">handle_edit_note()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.receive_new_name"><code class="docutils literal notranslate"><span class="pre">receive_new_name()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_versions_history"><code class="docutils literal notranslate"><span class="pre">handle_versions_history()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_download_file"><code class="docutils literal notranslate"><span class="pre">handle_download_file()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_delete_confirmation"><code class="docutils literal notranslate"><span class="pre">handle_delete_confirmation()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_delete_file"><code class="docutils literal notranslate"><span class="pre">handle_delete_file()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_file_info"><code class="docutils literal notranslate"><span class="pre">handle_file_info()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_callback_query"><code class="docutils literal notranslate"><span class="pre">handle_callback_query()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.cancel"><code class="docutils literal notranslate"><span class="pre">cancel()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.get_save_conversation_handler"><code class="docutils literal notranslate"><span class="pre">get_save_conversation_handler()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_view_version"><code class="docutils literal notranslate"><span class="pre">handle_view_version()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_revert_version"><code class="docutils literal notranslate"><span class="pre">handle_revert_version()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_preview_button"><code class="docutils literal notranslate"><span class="pre">handle_preview_button()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_autocomplete_button"><code class="docutils literal notranslate"><span class="pre">handle_autocomplete_button()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_batch_button"><code class="docutils literal notranslate"><span class="pre">handle_batch_button()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_batch_menu"><code class="docutils literal notranslate"><span class="pre">show_batch_menu()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_batch_repos_menu"><code class="docutils literal notranslate"><span class="pre">show_batch_repos_menu()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_batch_files_menu"><code class="docutils literal notranslate"><span class="pre">show_batch_files_menu()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_batch_zips_menu"><code class="docutils literal notranslate"><span class="pre">show_batch_zips_menu()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_batch_actions_menu"><code class="docutils literal notranslate"><span class="pre">show_batch_actions_menu()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.execute_batch_on_current_selection"><code class="docutils literal notranslate"><span class="pre">execute_batch_on_current_selection()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/database.html">database package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/database.html#database.init_database"><code class="docutils literal notranslate"><span class="pre">init_database()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/database.html#submodules">Submodules</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/database.bookmark.html">database.bookmark module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/database.bookmarks_manager.html">database.bookmarks_manager module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/database.collections_manager.html">database.collections_manager module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/database.manager.html">database.manager module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/database.models.html">database.models module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/database.repository.html">database.repository module</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/services.html">services package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/services.html#submodules">Submodules</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/services.backoff_state.html">services.backoff_state module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/services.backup_service.html">services.backup_service module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/services.code_service.html">services.code_service module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/services.github_service.html">services.github_service module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/services.google_drive_service.html">services.google_drive_service module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/services.investigation_service.html">services.investigation_service module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/services.webserver.html">services.webserver module</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/handlers.html">handlers package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/handlers.html#subpackages">Subpackages</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.github.html">handlers.github package</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/handlers.html#submodules">Submodules</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.documents.html">handlers.documents module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.file_view.html">handlers.file_view module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.pagination.html">handlers.pagination module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.save_flow.html">handlers.save_flow module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.states.html">handlers.states module</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/utils.html">utils module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.CodeErrorLogger"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CodeErrorLogger.__init__"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CodeErrorLogger.log_code_processing_error"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger.log_code_processing_error()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CodeErrorLogger.log_code_activity"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger.log_code_activity()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CodeErrorLogger.log_validation_failure"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger.log_validation_failure()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CodeErrorLogger.log_sanitization_success"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger.log_sanitization_success()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.TimeUtils"><code class="docutils literal notranslate"><span class="pre">TimeUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TimeUtils.format_relative_time"><code class="docutils literal notranslate"><span class="pre">TimeUtils.format_relative_time()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TimeUtils.parse_date_string"><code class="docutils literal notranslate"><span class="pre">TimeUtils.parse_date_string()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TimeUtils.get_time_ranges"><code class="docutils literal notranslate"><span class="pre">TimeUtils.get_time_ranges()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.TextUtils"><code class="docutils literal notranslate"><span class="pre">TextUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils.truncate_text"><code class="docutils literal notranslate"><span class="pre">TextUtils.truncate_text()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils.escape_markdown"><code class="docutils literal notranslate"><span class="pre">TextUtils.escape_markdown()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils.clean_filename"><code class="docutils literal notranslate"><span class="pre">TextUtils.clean_filename()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils.extract_hashtags"><code class="docutils literal notranslate"><span class="pre">TextUtils.extract_hashtags()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils.highlight_text"><code class="docutils literal notranslate"><span class="pre">TextUtils.highlight_text()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils.format_file_size"><code class="docutils literal notranslate"><span class="pre">TextUtils.format_file_size()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils.pluralize_hebrew"><code class="docutils literal notranslate"><span class="pre">TextUtils.pluralize_hebrew()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.SecurityUtils"><code class="docutils literal notranslate"><span class="pre">SecurityUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.SecurityUtils.generate_secure_token"><code class="docutils literal notranslate"><span class="pre">SecurityUtils.generate_secure_token()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.SecurityUtils.hash_content"><code class="docutils literal notranslate"><span class="pre">SecurityUtils.hash_content()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.SecurityUtils.validate_user_input"><code class="docutils literal notranslate"><span class="pre">SecurityUtils.validate_user_input()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.SecurityUtils.sanitize_code"><code class="docutils literal notranslate"><span class="pre">SecurityUtils.sanitize_code()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils"><code class="docutils literal notranslate"><span class="pre">TelegramUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.send_typing_action"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.send_typing_action()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.send_document_action"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.send_document_action()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.safe_answer"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.safe_answer()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.get_user_mention"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.get_user_mention()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.split_long_message"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.split_long_message()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.safe_edit_message_text"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.safe_edit_message_text()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.safe_edit_message_reply_markup"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.safe_edit_message_reply_markup()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.extract_message_text_preserve_markdown"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.extract_message_text_preserve_markdown()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.CallbackQueryGuard"><code class="docutils literal notranslate"><span class="pre">CallbackQueryGuard</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CallbackQueryGuard.DEFAULT_WINDOW_SECONDS"><code class="docutils literal notranslate"><span class="pre">CallbackQueryGuard.DEFAULT_WINDOW_SECONDS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CallbackQueryGuard.should_block"><code class="docutils literal notranslate"><span class="pre">CallbackQueryGuard.should_block()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CallbackQueryGuard.should_block_async"><code class="docutils literal notranslate"><span class="pre">CallbackQueryGuard.should_block_async()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.AsyncUtils"><code class="docutils literal notranslate"><span class="pre">AsyncUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.AsyncUtils.run_with_timeout"><code class="docutils literal notranslate"><span class="pre">AsyncUtils.run_with_timeout()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.AsyncUtils.batch_process"><code class="docutils literal notranslate"><span class="pre">AsyncUtils.batch_process()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.PerformanceUtils"><code class="docutils literal notranslate"><span class="pre">PerformanceUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.PerformanceUtils.timing_decorator"><code class="docutils literal notranslate"><span class="pre">PerformanceUtils.timing_decorator()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.PerformanceUtils.measure_time"><code class="docutils literal notranslate"><span class="pre">PerformanceUtils.measure_time()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.ValidationUtils"><code class="docutils literal notranslate"><span class="pre">ValidationUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.ValidationUtils.is_valid_filename"><code class="docutils literal notranslate"><span class="pre">ValidationUtils.is_valid_filename()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.ValidationUtils.is_safe_code"><code class="docutils literal notranslate"><span class="pre">ValidationUtils.is_safe_code()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.FileUtils"><code class="docutils literal notranslate"><span class="pre">FileUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.FileUtils.download_file"><code class="docutils literal notranslate"><span class="pre">FileUtils.download_file()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.FileUtils.get_file_extension"><code class="docutils literal notranslate"><span class="pre">FileUtils.get_file_extension()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.FileUtils.get_mime_type"><code class="docutils literal notranslate"><span class="pre">FileUtils.get_mime_type()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.FileUtils.create_temp_file"><code class="docutils literal notranslate"><span class="pre">FileUtils.create_temp_file()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.ConfigUtils"><code class="docutils literal notranslate"><span class="pre">ConfigUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.ConfigUtils.load_json_config"><code class="docutils literal notranslate"><span class="pre">ConfigUtils.load_json_config()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.ConfigUtils.save_json_config"><code class="docutils literal notranslate"><span class="pre">ConfigUtils.save_json_config()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.CacheUtils"><code class="docutils literal notranslate"><span class="pre">CacheUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CacheUtils.set"><code class="docutils literal notranslate"><span class="pre">CacheUtils.set()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CacheUtils.get"><code class="docutils literal notranslate"><span class="pre">CacheUtils.get()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CacheUtils.delete"><code class="docutils literal notranslate"><span class="pre">CacheUtils.delete()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CacheUtils.clear"><code class="docutils literal notranslate"><span class="pre">CacheUtils.clear()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.get_memory_usage"><code class="docutils literal notranslate"><span class="pre">get_memory_usage()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.setup_logging"><code class="docutils literal notranslate"><span class="pre">setup_logging()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.generate_summary_stats"><code class="docutils literal notranslate"><span class="pre">generate_summary_stats()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.detect_language_from_filename"><code class="docutils literal notranslate"><span class="pre">detect_language_from_filename()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.get_language_emoji"><code class="docutils literal notranslate"><span class="pre">get_language_emoji()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.SensitiveDataFilter"><code class="docutils literal notranslate"><span class="pre">SensitiveDataFilter</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.SensitiveDataFilter.filter"><code class="docutils literal notranslate"><span class="pre">SensitiveDataFilter.filter()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.install_sensitive_filter"><code class="docutils literal notranslate"><span class="pre">install_sensitive_filter()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.normalize_code"><code class="docutils literal notranslate"><span class="pre">normalize_code()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/modules.html">workspace</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/activity_reporter.html">activity_reporter module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/activity_reporter.html#activity_reporter.get_mongo_client"><code class="docutils literal notranslate"><span class="pre">get_mongo_client()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/activity_reporter.html#activity_reporter.close_mongo_client"><code class="docutils literal notranslate"><span class="pre">close_mongo_client()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/activity_reporter.html#activity_reporter.SimpleActivityReporter"><code class="docutils literal notranslate"><span class="pre">SimpleActivityReporter</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/activity_reporter.html#activity_reporter.create_reporter"><code class="docutils literal notranslate"><span class="pre">create_reporter()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/alert_forwarder.html">alert_forwarder module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/alert_forwarder.html#alert_forwarder.forward_alerts"><code class="docutils literal notranslate"><span class="pre">forward_alerts()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/alert_manager.html">alert_manager module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/alert_manager.html#alert_manager.reset_state_for_tests"><code class="docutils literal notranslate"><span class="pre">reset_state_for_tests()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/alert_manager.html#alert_manager.note_request"><code class="docutils literal notranslate"><span class="pre">note_request()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/alert_manager.html#alert_manager.get_current_error_rate_percent"><code class="docutils literal notranslate"><span class="pre">get_current_error_rate_percent()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/alert_manager.html#alert_manager.get_current_avg_latency_seconds"><code class="docutils literal notranslate"><span class="pre">get_current_avg_latency_seconds()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/alert_manager.html#alert_manager.bump_threshold"><code class="docutils literal notranslate"><span class="pre">bump_threshold()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/alert_manager.html#alert_manager.get_thresholds_snapshot"><code class="docutils literal notranslate"><span class="pre">get_thresholds_snapshot()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/alert_manager.html#alert_manager.check_and_emit_alerts"><code class="docutils literal notranslate"><span class="pre">check_and_emit_alerts()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/alert_manager.html#alert_manager.forward_critical_alert"><code class="docutils literal notranslate"><span class="pre">forward_critical_alert()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/alert_manager.html#alert_manager.get_dispatch_log"><code class="docutils literal notranslate"><span class="pre">get_dispatch_log()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/autocomplete_manager.html">autocomplete_manager module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/autocomplete_manager.html#autocomplete_manager.AutocompleteManager"><code class="docutils literal notranslate"><span class="pre">AutocompleteManager</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/backup_menu_handler.html">backup_menu_handler module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/backup_menu_handler.html#backup_menu_handler.BackupMenuHandler"><code class="docutils literal notranslate"><span class="pre">BackupMenuHandler</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/batch_commands.html">batch_commands module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_commands.html#batch_commands.batch_analyze_command"><code class="docutils literal notranslate"><span class="pre">batch_analyze_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_commands.html#batch_commands.batch_validate_command"><code class="docutils literal notranslate"><span class="pre">batch_validate_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_commands.html#batch_commands.job_status_command"><code class="docutils literal notranslate"><span class="pre">job_status_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_commands.html#batch_commands.large_file_command"><code class="docutils literal notranslate"><span class="pre">large_file_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_commands.html#batch_commands.handle_batch_callbacks"><code class="docutils literal notranslate"><span class="pre">handle_batch_callbacks()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_commands.html#batch_commands.setup_batch_handlers"><code class="docutils literal notranslate"><span class="pre">setup_batch_handlers()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/batch_processor.html">batch_processor module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_processor.html#batch_processor.BatchJob"><code class="docutils literal notranslate"><span class="pre">BatchJob</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_processor.html#batch_processor.BatchProcessor"><code class="docutils literal notranslate"><span class="pre">BatchProcessor</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/bot_handlers.html">bot_handlers module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.set_activity_reporter"><code class="docutils literal notranslate"><span class="pre">set_activity_reporter()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.AdvancedBotHandlers"><code class="docutils literal notranslate"><span class="pre">AdvancedBotHandlers</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_handlers.html#bot_handlers.check_db_connection"><code class="docutils literal notranslate"><span class="pre">check_db_connection()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/bot_rate_limiter.html">bot_rate_limiter module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_rate_limiter.html#bot_rate_limiter.RateLimitExceeded"><code class="docutils literal notranslate"><span class="pre">RateLimitExceeded</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_rate_limiter.html#bot_rate_limiter.check_rate_limit"><code class="docutils literal notranslate"><span class="pre">check_rate_limit()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/bot_rate_limiter.html#bot_rate_limiter.rate_limit"><code class="docutils literal notranslate"><span class="pre">rate_limit()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/cache_commands.html">cache_commands module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_commands.html#cache_commands.cache_stats_command"><code class="docutils literal notranslate"><span class="pre">cache_stats_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_commands.html#cache_commands.clear_cache_command"><code class="docutils literal notranslate"><span class="pre">clear_cache_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_commands.html#cache_commands.setup_cache_handlers"><code class="docutils literal notranslate"><span class="pre">setup_cache_handlers()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_commands.html#cache_commands.cache_warm_command"><code class="docutils literal notranslate"><span class="pre">cache_warm_command()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/cache_manager.html">cache_manager module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_manager.html#cache_manager.DynamicTTL"><code class="docutils literal notranslate"><span class="pre">DynamicTTL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_manager.html#cache_manager.ActivityBasedTTL"><code class="docutils literal notranslate"><span class="pre">ActivityBasedTTL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_manager.html#cache_manager.build_cache_key"><code class="docutils literal notranslate"><span class="pre">build_cache_key()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_manager.html#cache_manager.CacheManager"><code class="docutils literal notranslate"><span class="pre">CacheManager</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_manager.html#cache_manager.dynamic_cache"><code class="docutils literal notranslate"><span class="pre">dynamic_cache()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_manager.html#cache_manager.cached"><code class="docutils literal notranslate"><span class="pre">cached()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_manager.html#cache_manager.async_cached"><code class="docutils literal notranslate"><span class="pre">async_cached()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/chatops.html">chatops package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/chatops.html#submodules">Submodules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/code_preview.html">code_preview module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/code_preview.html#code_preview.CodePreviewManager"><code class="docutils literal notranslate"><span class="pre">CodePreviewManager</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/code_processor.html">code_processor module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/config.html">config module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig"><code class="docutils literal notranslate"><span class="pre">BotConfig</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.load_config"><code class="docutils literal notranslate"><span class="pre">load_config()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/conftest.html">conftest module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/conftest.html#conftest.pytest_addoption"><code class="docutils literal notranslate"><span class="pre">pytest_addoption()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conftest.html#conftest.pytest_configure"><code class="docutils literal notranslate"><span class="pre">pytest_configure()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conftest.html#conftest.pytest_collection_modifyitems"><code class="docutils literal notranslate"><span class="pre">pytest_collection_modifyitems()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conftest.html#conftest.pytest_runtest_makereport"><code class="docutils literal notranslate"><span class="pre">pytest_runtest_makereport()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conftest.html#conftest.pytest_sessionfinish"><code class="docutils literal notranslate"><span class="pre">pytest_sessionfinish()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html">conversation_handlers module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.set_activity_reporter"><code class="docutils literal notranslate"><span class="pre">set_activity_reporter()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.start_command"><code class="docutils literal notranslate"><span class="pre">start_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_community_hub"><code class="docutils literal notranslate"><span class="pre">show_community_hub()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_catalog_menu"><code class="docutils literal notranslate"><span class="pre">community_catalog_menu()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippets_menu"><code class="docutils literal notranslate"><span class="pre">snippets_menu()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_hub_callback"><code class="docutils literal notranslate"><span class="pre">community_hub_callback()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.main_menu_callback"><code class="docutils literal notranslate"><span class="pre">main_menu_callback()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.submit_flows_cancel"><code class="docutils literal notranslate"><span class="pre">submit_flows_cancel()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_help_page"><code class="docutils literal notranslate"><span class="pre">show_help_page()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.setup_favorites_category_handlers"><code class="docutils literal notranslate"><span class="pre">setup_favorites_category_handlers()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.start_repo_zip_import"><code class="docutils literal notranslate"><span class="pre">start_repo_zip_import()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.start_zip_create_flow"><code class="docutils literal notranslate"><span class="pre">start_zip_create_flow()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_by_repo_menu"><code class="docutils literal notranslate"><span class="pre">show_by_repo_menu()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_by_repo_menu_callback"><code class="docutils literal notranslate"><span class="pre">show_by_repo_menu_callback()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_all_files"><code class="docutils literal notranslate"><span class="pre">show_all_files()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_large_files_direct"><code class="docutils literal notranslate"><span class="pre">show_large_files_direct()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_github_menu"><code class="docutils literal notranslate"><span class="pre">show_github_menu()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_all_files_callback"><code class="docutils literal notranslate"><span class="pre">show_all_files_callback()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_submit_start"><code class="docutils literal notranslate"><span class="pre">community_submit_start()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_collect_title"><code class="docutils literal notranslate"><span class="pre">community_collect_title()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_collect_description"><code class="docutils literal notranslate"><span class="pre">community_collect_description()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_collect_url"><code class="docutils literal notranslate"><span class="pre">community_collect_url()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_collect_logo"><code class="docutils literal notranslate"><span class="pre">community_collect_logo()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_inline_approve"><code class="docutils literal notranslate"><span class="pre">community_inline_approve()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_reject_start"><code class="docutils literal notranslate"><span class="pre">community_reject_start()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_collect_reject_reason"><code class="docutils literal notranslate"><span class="pre">community_collect_reject_reason()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_queue_command"><code class="docutils literal notranslate"><span class="pre">community_queue_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_approve_command"><code class="docutils literal notranslate"><span class="pre">community_approve_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.community_reject_command"><code class="docutils literal notranslate"><span class="pre">community_reject_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_submit_start"><code class="docutils literal notranslate"><span class="pre">snippet_submit_start()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_collect_title"><code class="docutils literal notranslate"><span class="pre">snippet_collect_title()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_collect_description"><code class="docutils literal notranslate"><span class="pre">snippet_collect_description()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_mode_regular_start"><code class="docutils literal notranslate"><span class="pre">snippet_mode_regular_start()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_mode_long_start"><code class="docutils literal notranslate"><span class="pre">snippet_mode_long_start()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_long_collect_receive"><code class="docutils literal notranslate"><span class="pre">snippet_long_collect_receive()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_long_collect_done"><code class="docutils literal notranslate"><span class="pre">snippet_long_collect_done()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_collect_code"><code class="docutils literal notranslate"><span class="pre">snippet_collect_code()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_collect_language"><code class="docutils literal notranslate"><span class="pre">snippet_collect_language()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_inline_approve"><code class="docutils literal notranslate"><span class="pre">snippet_inline_approve()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_reject_start"><code class="docutils literal notranslate"><span class="pre">snippet_reject_start()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_collect_reject_reason"><code class="docutils literal notranslate"><span class="pre">snippet_collect_reject_reason()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_queue_command"><code class="docutils literal notranslate"><span class="pre">snippet_queue_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_approve_command"><code class="docutils literal notranslate"><span class="pre">snippet_approve_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.snippet_reject_command"><code class="docutils literal notranslate"><span class="pre">snippet_reject_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_regular_files_callback"><code class="docutils literal notranslate"><span class="pre">show_regular_files_callback()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_favorites_callback"><code class="docutils literal notranslate"><span class="pre">show_favorites_callback()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_favorites_page_callback"><code class="docutils literal notranslate"><span class="pre">show_favorites_page_callback()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_regular_files_page_callback"><code class="docutils literal notranslate"><span class="pre">show_regular_files_page_callback()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_recycle_bin"><code class="docutils literal notranslate"><span class="pre">show_recycle_bin()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.recycle_restore"><code class="docutils literal notranslate"><span class="pre">recycle_restore()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.recycle_purge"><code class="docutils literal notranslate"><span class="pre">recycle_purge()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.share_single_by_id"><code class="docutils literal notranslate"><span class="pre">share_single_by_id()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_duplicate_callback"><code class="docutils literal notranslate"><span class="pre">handle_duplicate_callback()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_file_menu"><code class="docutils literal notranslate"><span class="pre">handle_file_menu()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_view_file"><code class="docutils literal notranslate"><span class="pre">handle_view_file()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_edit_code"><code class="docutils literal notranslate"><span class="pre">handle_edit_code()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.receive_new_code"><code class="docutils literal notranslate"><span class="pre">receive_new_code()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_edit_name"><code class="docutils literal notranslate"><span class="pre">handle_edit_name()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_edit_note"><code class="docutils literal notranslate"><span class="pre">handle_edit_note()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.receive_new_name"><code class="docutils literal notranslate"><span class="pre">receive_new_name()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_versions_history"><code class="docutils literal notranslate"><span class="pre">handle_versions_history()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_download_file"><code class="docutils literal notranslate"><span class="pre">handle_download_file()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_delete_confirmation"><code class="docutils literal notranslate"><span class="pre">handle_delete_confirmation()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_delete_file"><code class="docutils literal notranslate"><span class="pre">handle_delete_file()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_file_info"><code class="docutils literal notranslate"><span class="pre">handle_file_info()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_callback_query"><code class="docutils literal notranslate"><span class="pre">handle_callback_query()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.cancel"><code class="docutils literal notranslate"><span class="pre">cancel()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.get_save_conversation_handler"><code class="docutils literal notranslate"><span class="pre">get_save_conversation_handler()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_view_version"><code class="docutils literal notranslate"><span class="pre">handle_view_version()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_revert_version"><code class="docutils literal notranslate"><span class="pre">handle_revert_version()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_preview_button"><code class="docutils literal notranslate"><span class="pre">handle_preview_button()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_autocomplete_button"><code class="docutils literal notranslate"><span class="pre">handle_autocomplete_button()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.handle_batch_button"><code class="docutils literal notranslate"><span class="pre">handle_batch_button()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_batch_menu"><code class="docutils literal notranslate"><span class="pre">show_batch_menu()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_batch_repos_menu"><code class="docutils literal notranslate"><span class="pre">show_batch_repos_menu()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_batch_files_menu"><code class="docutils literal notranslate"><span class="pre">show_batch_files_menu()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_batch_zips_menu"><code class="docutils literal notranslate"><span class="pre">show_batch_zips_menu()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.show_batch_actions_menu"><code class="docutils literal notranslate"><span class="pre">show_batch_actions_menu()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conversation_handlers.html#conversation_handlers.execute_batch_on_current_selection"><code class="docutils literal notranslate"><span class="pre">execute_batch_on_current_selection()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/database.html">database package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/database.html#database.init_database"><code class="docutils literal notranslate"><span class="pre">init_database()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/database.html#submodules">Submodules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/duplicate_detector.html">duplicate_detector module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/duplicate_detector.html#duplicate_detector.scan_duplicates"><code class="docutils literal notranslate"><span class="pre">scan_duplicates()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/file_manager.html">file_manager module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/file_manager.html#file_manager.BackupInfo"><code class="docutils literal notranslate"><span class="pre">BackupInfo</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/file_manager.html#file_manager.BackupManager"><code class="docutils literal notranslate"><span class="pre">BackupManager</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/fix_telegram_parse_error.html">fix_telegram_parse_error module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/fix_telegram_parse_error.html#fix_telegram_parse_error.clean_for_telegram"><code class="docutils literal notranslate"><span class="pre">clean_for_telegram()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/fix_telegram_parse_error.html#fix_telegram_parse_error.apply_fix"><code class="docutils literal notranslate"><span class="pre">apply_fix()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/fix_telegram_parse_error.html#fix_telegram_parse_error.wrap_edit_message_calls"><code class="docutils literal notranslate"><span class="pre">wrap_edit_message_calls()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/github_menu_handler.html">github_menu_handler module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/github_menu_handler.html#github_menu_handler.http_request"><code class="docutils literal notranslate"><span class="pre">http_request()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_menu_handler.html#github_menu_handler.safe_html_escape"><code class="docutils literal notranslate"><span class="pre">safe_html_escape()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_menu_handler.html#github_menu_handler.format_bytes"><code class="docutils literal notranslate"><span class="pre">format_bytes()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_menu_handler.html#github_menu_handler.GitHubMenuHandler"><code class="docutils literal notranslate"><span class="pre">GitHubMenuHandler</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/github_upload_fix.html">github_upload_fix module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/github_upload_fix.html#github_upload_fix.github_upload_new_file"><code class="docutils literal notranslate"><span class="pre">github_upload_new_file()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_upload_fix.html#github_upload_fix.handle_document_fixed"><code class="docutils literal notranslate"><span class="pre">handle_document_fixed()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_upload_fix.html#github_upload_fix.upload_to_github_fixed"><code class="docutils literal notranslate"><span class="pre">upload_to_github_fixed()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_upload_fix.html#github_upload_fix.setup_minimal_commands"><code class="docutils literal notranslate"><span class="pre">setup_minimal_commands()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_upload_fix.html#github_upload_fix.stats_command_secured"><code class="docutils literal notranslate"><span class="pre">stats_command_secured()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_upload_fix.html#github_upload_fix.check_commands"><code class="docutils literal notranslate"><span class="pre">check_commands()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/handlers.html">handlers package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.html#subpackages">Subpackages</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.html#submodules">Submodules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/http_async.html">http_async module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/http_async.html#http_async.CircuitOpenError"><code class="docutils literal notranslate"><span class="pre">CircuitOpenError</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/http_async.html#http_async.get_session"><code class="docutils literal notranslate"><span class="pre">get_session()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/http_async.html#http_async.request"><code class="docutils literal notranslate"><span class="pre">request()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/http_async.html#http_async.close_session"><code class="docutils literal notranslate"><span class="pre">close_session()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/http_sync.html">http_sync module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/http_sync.html#http_sync.CircuitOpenError"><code class="docutils literal notranslate"><span class="pre">CircuitOpenError</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/http_sync.html#http_sync.get_session"><code class="docutils literal notranslate"><span class="pre">get_session()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/http_sync.html#http_sync.request"><code class="docutils literal notranslate"><span class="pre">request()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/i18n.html">i18n package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/i18n.html#submodules">Submodules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/integrations.html">integrations module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/integrations_github_monitor.html">integrations_github_monitor module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/integrations_github_monitor.html#integrations_github_monitor.fetch_rate_limit"><code class="docutils literal notranslate"><span class="pre">fetch_rate_limit()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/integrations_github_monitor.html#integrations_github_monitor.summarize_rate_limit"><code class="docutils literal notranslate"><span class="pre">summarize_rate_limit()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/integrations_sentry.html">integrations_sentry module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/integrations_sentry.html#integrations_sentry.is_configured"><code class="docutils literal notranslate"><span class="pre">is_configured()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/integrations_sentry.html#integrations_sentry.get_recent_issues"><code class="docutils literal notranslate"><span class="pre">get_recent_issues()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/integrations_sentry.html#integrations_sentry.search_events"><code class="docutils literal notranslate"><span class="pre">search_events()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/integrations_sentry.html#integrations_sentry.get_issue_events"><code class="docutils literal notranslate"><span class="pre">get_issue_events()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/internal_alerts.html">internal_alerts module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/internal_alerts.html#internal_alerts.emit_internal_alert"><code class="docutils literal notranslate"><span class="pre">emit_internal_alert()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/internal_alerts.html#internal_alerts.get_recent_alerts"><code class="docutils literal notranslate"><span class="pre">get_recent_alerts()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/large_files_handler.html">large_files_handler module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/large_files_handler.html#large_files_handler.LargeFilesHandler"><code class="docutils literal notranslate"><span class="pre">LargeFilesHandler</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/lazy_loader.html">lazy_loader module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/lazy_loader.html#lazy_loader.FileChunk"><code class="docutils literal notranslate"><span class="pre">FileChunk</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/lazy_loader.html#lazy_loader.LazyLoader"><code class="docutils literal notranslate"><span class="pre">LazyLoader</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html">main module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.get_admin_ids"><code class="docutils literal notranslate"><span class="pre">get_admin_ids()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.notify_admins"><code class="docutils literal notranslate"><span class="pre">notify_admins()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.recycle_backfill_command"><code class="docutils literal notranslate"><span class="pre">recycle_backfill_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.log_user_activity"><code class="docutils literal notranslate"><span class="pre">log_user_activity()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.get_lock_collection"><code class="docutils literal notranslate"><span class="pre">get_lock_collection()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.ensure_lock_indexes"><code class="docutils literal notranslate"><span class="pre">ensure_lock_indexes()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.cleanup_mongo_lock"><code class="docutils literal notranslate"><span class="pre">cleanup_mongo_lock()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.manage_mongo_lock"><code class="docutils literal notranslate"><span class="pre">manage_mongo_lock()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.HelpEntry"><code class="docutils literal notranslate"><span class="pre">HelpEntry</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.HelpSection"><code class="docutils literal notranslate"><span class="pre">HelpSection</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.signal_handler"><code class="docutils literal notranslate"><span class="pre">signal_handler()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.setup_handlers"><code class="docutils literal notranslate"><span class="pre">setup_handlers()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.main"><code class="docutils literal notranslate"><span class="pre">main()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.setup_bot_data"><code class="docutils literal notranslate"><span class="pre">setup_bot_data()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/metrics.html">metrics module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.track_performance"><code class="docutils literal notranslate"><span class="pre">track_performance()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.metrics_endpoint_bytes"><code class="docutils literal notranslate"><span class="pre">metrics_endpoint_bytes()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.metrics_content_type"><code class="docutils literal notranslate"><span class="pre">metrics_content_type()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.note_active_user"><code class="docutils literal notranslate"><span class="pre">note_active_user()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.record_request_outcome"><code class="docutils literal notranslate"><span class="pre">record_request_outcome()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.record_http_request"><code class="docutils literal notranslate"><span class="pre">record_http_request()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.record_outbound_request_duration"><code class="docutils literal notranslate"><span class="pre">record_outbound_request_duration()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.increment_outbound_retry"><code class="docutils literal notranslate"><span class="pre">increment_outbound_retry()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.set_circuit_state"><code class="docutils literal notranslate"><span class="pre">set_circuit_state()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.set_circuit_success_rate"><code class="docutils literal notranslate"><span class="pre">set_circuit_success_rate()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.get_boot_monotonic"><code class="docutils literal notranslate"><span class="pre">get_boot_monotonic()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.mark_startup_complete"><code class="docutils literal notranslate"><span class="pre">mark_startup_complete()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.note_first_request_latency"><code class="docutils literal notranslate"><span class="pre">note_first_request_latency()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.get_process_uptime_seconds"><code class="docutils literal notranslate"><span class="pre">get_process_uptime_seconds()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.record_dependency_init"><code class="docutils literal notranslate"><span class="pre">record_dependency_init()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.record_db_operation"><code class="docutils literal notranslate"><span class="pre">record_db_operation()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.get_uptime_percentage"><code class="docutils literal notranslate"><span class="pre">get_uptime_percentage()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.set_adaptive_observability_gauges"><code class="docutils literal notranslate"><span class="pre">set_adaptive_observability_gauges()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.track_file_saved"><code class="docutils literal notranslate"><span class="pre">track_file_saved()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.track_search_performed"><code class="docutils literal notranslate"><span class="pre">track_search_performed()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/metrics.html#metrics.track_github_sync"><code class="docutils literal notranslate"><span class="pre">track_github_sync()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/monitoring.html">monitoring package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/monitoring.html#submodules">Submodules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/observability.html">observability module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/observability.html#observability.get_observability_context"><code class="docutils literal notranslate"><span class="pre">get_observability_context()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/observability.html#observability.get_request_id"><code class="docutils literal notranslate"><span class="pre">get_request_id()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/observability.html#observability.bind_command"><code class="docutils literal notranslate"><span class="pre">bind_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/observability.html#observability.bind_user_context"><code class="docutils literal notranslate"><span class="pre">bind_user_context()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/observability.html#observability.prepare_outgoing_headers"><code class="docutils literal notranslate"><span class="pre">prepare_outgoing_headers()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/observability.html#observability.classify_error"><code class="docutils literal notranslate"><span class="pre">classify_error()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/observability.html#observability.setup_structlog_logging"><code class="docutils literal notranslate"><span class="pre">setup_structlog_logging()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/observability.html#observability.generate_request_id"><code class="docutils literal notranslate"><span class="pre">generate_request_id()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/observability.html#observability.bind_request_id"><code class="docutils literal notranslate"><span class="pre">bind_request_id()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/observability.html#observability.emit_event"><code class="docutils literal notranslate"><span class="pre">emit_event()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/observability.html#observability.init_sentry"><code class="docutils literal notranslate"><span class="pre">init_sentry()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/observability.html#observability.get_recent_errors"><code class="docutils literal notranslate"><span class="pre">get_recent_errors()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/observability.html#observability.emit_anomaly"><code class="docutils literal notranslate"><span class="pre">emit_anomaly()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/observability_instrumentation.html">observability_instrumentation module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/observability_instrumentation.html#observability_instrumentation.traced"><code class="docutils literal notranslate"><span class="pre">traced()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/observability_instrumentation.html#observability_instrumentation.start_span"><code class="docutils literal notranslate"><span class="pre">start_span()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/observability_instrumentation.html#observability_instrumentation.set_current_span_attributes"><code class="docutils literal notranslate"><span class="pre">set_current_span_attributes()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/observability_otel.html">observability_otel module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/observability_otel.html#observability_otel.setup_telemetry"><code class="docutils literal notranslate"><span class="pre">setup_telemetry()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/predictive_engine.html">predictive_engine module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/predictive_engine.html#predictive_engine.Trend"><code class="docutils literal notranslate"><span class="pre">Trend</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/predictive_engine.html#predictive_engine.note_observation"><code class="docutils literal notranslate"><span class="pre">note_observation()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/predictive_engine.html#predictive_engine.evaluate_predictions"><code class="docutils literal notranslate"><span class="pre">evaluate_predictions()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/predictive_engine.html#predictive_engine.reset_state_for_tests"><code class="docutils literal notranslate"><span class="pre">reset_state_for_tests()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/predictive_engine.html#predictive_engine.maybe_recompute_and_preempt"><code class="docutils literal notranslate"><span class="pre">maybe_recompute_and_preempt()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/predictive_engine.html#predictive_engine.get_recent_predictions"><code class="docutils literal notranslate"><span class="pre">get_recent_predictions()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/predictive_engine.html#predictive_engine.get_trend_snapshot"><code class="docutils literal notranslate"><span class="pre">get_trend_snapshot()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/rate_limiter.html">rate_limiter module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/rate_limiter.html#rate_limiter.RateLimiter"><code class="docutils literal notranslate"><span class="pre">RateLimiter</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/refactor_handlers.html">refactor_handlers module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/refactor_handlers.html#refactor_handlers.set_activity_reporter"><code class="docutils literal notranslate"><span class="pre">set_activity_reporter()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/refactor_handlers.html#refactor_handlers.RefactorHandlers"><code class="docutils literal notranslate"><span class="pre">RefactorHandlers</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/refactor_handlers.html#refactor_handlers.setup_refactor_handlers"><code class="docutils literal notranslate"><span class="pre">setup_refactor_handlers()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/refactoring_engine.html">refactoring_engine module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/refactoring_engine.html#id1">××“×™× ×™×•×ª ×•×§×•× ×¤×™×’×•×¨×¦×™×”</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/refactoring_engine.html#safe-decomposition-models-py">××§×¨×” ××™×•×—×“: Safe Decomposition ×œâ€‘<code class="docutils literal notranslate"><span class="pre">models.py</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/remediation_manager.html">remediation_manager module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/remediation_manager.html#remediation_manager.handle_critical_incident"><code class="docutils literal notranslate"><span class="pre">handle_critical_incident()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/remediation_manager.html#remediation_manager.get_incidents"><code class="docutils literal notranslate"><span class="pre">get_incidents()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/reminders.html">reminders package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/reminders.html#submodules">Submodules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/repo_analyzer.html">repo_analyzer module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/repo_analyzer.html#repo_analyzer.RepoAnalyzer"><code class="docutils literal notranslate"><span class="pre">RepoAnalyzer</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/search_engine.html">search_engine module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/secret_manager.html">secret_manager module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/secret_manager.html#secret_manager.encrypt_secret"><code class="docutils literal notranslate"><span class="pre">encrypt_secret()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/secret_manager.html#secret_manager.decrypt_secret"><code class="docutils literal notranslate"><span class="pre">decrypt_secret()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/services.html">services package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/services.html#submodules">Submodules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/setup_bookmarks.html">setup_bookmarks module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/setup_bookmarks.html#setup_bookmarks.check_mongodb_connection"><code class="docutils literal notranslate"><span class="pre">check_mongodb_connection()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/setup_bookmarks.html#setup_bookmarks.setup_bookmarks_collection"><code class="docutils literal notranslate"><span class="pre">setup_bookmarks_collection()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/setup_bookmarks.html#setup_bookmarks.verify_installation"><code class="docutils literal notranslate"><span class="pre">verify_installation()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/setup_bookmarks.html#setup_bookmarks.main"><code class="docutils literal notranslate"><span class="pre">main()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/terminal_commands.html">terminal_commands module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/terminal_commands.html#terminal_commands.run_in_sandbox"><code class="docutils literal notranslate"><span class="pre">run_in_sandbox()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/terminal_commands.html#terminal_commands.terminal_enter"><code class="docutils literal notranslate"><span class="pre">terminal_enter()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/terminal_commands.html#terminal_commands.terminal_exit"><code class="docutils literal notranslate"><span class="pre">terminal_exit()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/terminal_commands.html#terminal_commands.terminal_run_command"><code class="docutils literal notranslate"><span class="pre">terminal_run_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/terminal_commands.html#terminal_commands.terminal_command"><code class="docutils literal notranslate"><span class="pre">terminal_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/terminal_commands.html#terminal_commands.setup_terminal_handlers"><code class="docutils literal notranslate"><span class="pre">setup_terminal_handlers()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/test_basic.html">test_basic module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/test_basic.html#test_basic.test_python_version"><code class="docutils literal notranslate"><span class="pre">test_python_version()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/test_basic.html#test_basic.test_import_main"><code class="docutils literal notranslate"><span class="pre">test_import_main()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/test_basic.html#test_basic.test_environment"><code class="docutils literal notranslate"><span class="pre">test_environment()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/test_basic.html#test_basic.test_basic_calculation"><code class="docutils literal notranslate"><span class="pre">test_basic_calculation()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/test_basic.html#test_basic.TestRequirements"><code class="docutils literal notranslate"><span class="pre">TestRequirements</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/test_bookmarks.html">test_bookmarks module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/test_bookmarks.html#test_bookmarks.TestFileBookmarkModel"><code class="docutils literal notranslate"><span class="pre">TestFileBookmarkModel</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/test_bookmarks.html#test_bookmarks.TestBookmarksManager"><code class="docutils literal notranslate"><span class="pre">TestBookmarksManager</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/test_bookmarks.html#test_bookmarks.TestSyncFunctionality"><code class="docutils literal notranslate"><span class="pre">TestSyncFunctionality</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/test_bookmarks.html#test_bookmarks.TestIntegration"><code class="docutils literal notranslate"><span class="pre">TestIntegration</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/test_bookmarks.html#test_bookmarks.run_tests"><code class="docutils literal notranslate"><span class="pre">run_tests()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/user_stats.html">user_stats module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/user_stats.html#user_stats.UserStats"><code class="docutils literal notranslate"><span class="pre">UserStats</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html">utils module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CodeErrorLogger"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TimeUtils"><code class="docutils literal notranslate"><span class="pre">TimeUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils"><code class="docutils literal notranslate"><span class="pre">TextUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.SecurityUtils"><code class="docutils literal notranslate"><span class="pre">SecurityUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils"><code class="docutils literal notranslate"><span class="pre">TelegramUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CallbackQueryGuard"><code class="docutils literal notranslate"><span class="pre">CallbackQueryGuard</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.AsyncUtils"><code class="docutils literal notranslate"><span class="pre">AsyncUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.PerformanceUtils"><code class="docutils literal notranslate"><span class="pre">PerformanceUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.ValidationUtils"><code class="docutils literal notranslate"><span class="pre">ValidationUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.FileUtils"><code class="docutils literal notranslate"><span class="pre">FileUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.ConfigUtils"><code class="docutils literal notranslate"><span class="pre">ConfigUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CacheUtils"><code class="docutils literal notranslate"><span class="pre">CacheUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.get_memory_usage"><code class="docutils literal notranslate"><span class="pre">get_memory_usage()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.setup_logging"><code class="docutils literal notranslate"><span class="pre">setup_logging()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.generate_summary_stats"><code class="docutils literal notranslate"><span class="pre">generate_summary_stats()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.detect_language_from_filename"><code class="docutils literal notranslate"><span class="pre">detect_language_from_filename()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.get_language_emoji"><code class="docutils literal notranslate"><span class="pre">get_language_emoji()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.SensitiveDataFilter"><code class="docutils literal notranslate"><span class="pre">SensitiveDataFilter</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.install_sensitive_filter"><code class="docutils literal notranslate"><span class="pre">install_sensitive_filter()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.normalize_code"><code class="docutils literal notranslate"><span class="pre">normalize_code()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/webapp.html">webapp package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/webapp.html#submodules">Submodules</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../modules/index.html">××•×“×•×œ×™× ×¨××©×™×™×</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#file-management">File Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#github-integration">GitHub Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#backup-system">Backup System</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#code-processing">Code Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#search-engine">Search Engine</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#repository-analysis">Repository Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#batch-processing">Batch Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#large-files-handling">Large Files Handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#cache-management">Cache Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#user-statistics">User Statistics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#activity-reporting">Activity Reporting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#utilities">Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#lazy-loading">Lazy Loading</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#integrations">Integrations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#terminal-commands">Terminal Commands</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#autocomplete-manager">Autocomplete Manager</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../handlers/index.html">Handlers</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#show-command">Show Command</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../handlers/show.html">Show Command</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../handlers/show.html#show">××¤×¨×˜ ×¤×§×•×“×ª <cite>/show</cite></a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/show.html#html">×“×•×’××ª ×ª×’×•×‘×ª HTML</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/show.html#id1">×”×¢×¨×•×ª ×™×™×©×•×</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/show.html#id2">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#drive-menu">Drive Menu</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../handlers/drive_menu.html">Drive Menu V2</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../handlers/drive_menu.html#id1">×¡×§×™×¨×”</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/drive_menu.html#id2">×“×’×œ ×¤×™×¦â€™×¨</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/drive_menu.html#id3">×–×¨×™××•×ª ×¢×™×§×¨×™×•×ª</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/drive_menu.html#device-flow">×”×ª×—×‘×¨×•×ª (Device Flow)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/drive_menu.html#id4">×˜×™×¤×•×œ ×©×’×™××•×ª</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/drive_menu.html#id5">× ×™×˜×•×¨</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/drive_menu.html#module-handlers.drive.menu">API (autodoc)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#file-view-handler">File View Handler</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../handlers/index.html#file-view-handler-module">File View Handler Module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#pagination-handler">Pagination Handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#save-flow-handler">Save Flow Handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#states-handler">States Handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#github-handlers">GitHub Handlers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#document-flow">Document Flow</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../handlers/document-flow.html">×–×¨×™××ª ×”×˜×™×¤×•×œ ×‘××¡××›×™× (Document Flow)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../handlers/document-flow.html#id1">××¤×” ×•×ª×¤×§×™×“×™×</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/document-flow.html#id2">×–×¨×™××ª ×˜×™×¤×•×œ ×‘×§×•×‘×¥</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/document-flow.html#upload-mode">××¦×‘×™ upload_mode</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/document-flow.html#id3">×ª×œ×•×™×•×ª ×•×”×–×¨×§×•×ª</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/document-flow.html#best-practices">Best Practices</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/document-flow.html#filesfacade-db">×©×›×‘×ª ××—×¡×•×Ÿ (FilesFacade ××•×œ DB ×”×™×©×Ÿ)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/document-flow.html#id4">×¨××• ×’×</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../services/index.html">Services</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../services/index.html#code-service">Code Service</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../services/index.html#code-service-module">Code Service Module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../services/index.html#github-service">GitHub Service</a></li>
<li class="toctree-l2"><a class="reference internal" href="../services/index.html#backup-service">Backup Service</a></li>
<li class="toctree-l2"><a class="reference internal" href="../services/index.html#google-drive-service">Google Drive Service</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../services/google_drive_service.html">Google Drive Service</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../services/google_drive_service.html#id1">×¡×§×™×¨×”</a></li>
<li class="toctree-l4"><a class="reference internal" href="../services/google_drive_service.html#oauth">×”×¢×¨×•×ª OAuth</a></li>
<li class="toctree-l4"><a class="reference internal" href="../services/google_drive_service.html#id2">××‘× ×™ ×§×‘×¦×™×</a></li>
<li class="toctree-l4"><a class="reference internal" href="../services/google_drive_service.html#api-autodoc">API (autodoc)</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../database/index.html">Database</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../database/index.html#database-manager">Database Manager</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/index.html#models">Models</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../database/index.html#codesnippet-model">CodeSnippet Model</a></li>
<li class="toctree-l3"><a class="reference internal" href="../database/index.html#databasemanager-class">DatabaseManager Class</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../database/index.html#database-operations">Database Operations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../database/index.html#save-operations">Save Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../database/index.html#search-operations">Search Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../database/index.html#delete-operations">Delete Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../database/index.html#statistics-operations">Statistics Operations</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../database/index.html#users">××™× ×“×§×¡×™× ×‘×§×•×œ×§×¦×™×™×ª users</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../database/indexing.html">MongoDB Indexing Cookbook</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#id1">×œ××”?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#id2">××™× ×“×§×¡×™× ××•××œ×¦×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#python-pymongo">××ª×›×•× ×™× (Python / PyMongo)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#explain-mongo-shell">×‘×“×™×§×•×ª explain (Mongo Shell)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#explain">××” ×œ×—×¤×© ×‘-explain?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#id3">×‘×“×™×§×ª ×§×™×•× ××™× ×“×§×¡×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#id4">×©×™×˜×•×ª ×¢×‘×•×“×” ××•××œ×¦×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#id5">×“×•×’×××•×ª × ×•×¡×¤×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#gotchas">Gotchas × ×¤×•×¦×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../database/cursor-pagination.html">Cursor-based Pagination (created_at / _id)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#id1">×œ××”?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#id2">×¢×§×¨×•× ×•×ª ××™×•×Ÿ ×™×¦×™×‘</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#python">×§×™×“×•×“/×¤×¢× ×•×— ×§×•×¨×¡×•×¨ (Python)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#id3">×ª×‘× ×™×ª ×©××™×œ×ª×” (×—×“×© â†’ ×™×©×Ÿ)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#pymongo">PyMongo â€“ ×“×•×’××” ××œ××”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#id4">×“×¤×“×•×£ ×œ××—×•×¨ (×™×©×Ÿ â†’ ×—×“×©)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#copypaste">×‘×“×™×§×•×ª ×™×“× ×™×•×ª (Copyâ€‘Paste)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#id5">×©×™×˜×•×ª ×¢×‘×•×“×” ××•××œ×¦×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#gotchas">Gotchas × ×¤×•×¦×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#id6">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../database-schema.html">Database Schema</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../database-schema.html#collections">Collections</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../database-schema.html#code-snippets"><code class="docutils literal notranslate"><span class="pre">code_snippets</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../database-schema.html#users"><code class="docutils literal notranslate"><span class="pre">users</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../database-schema.html#bookmarks"><code class="docutils literal notranslate"><span class="pre">bookmarks</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../database-schema.html#sessions-webapp"><code class="docutils literal notranslate"><span class="pre">sessions</span></code> (WebApp)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../database-schema.html#indexes">Indexes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database-schema.html#relationships">Relationships</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database-schema.html#id1">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../database/detailed-schema.html">××‘× ×” × ×ª×•× ×™× ××¤×•×¨×˜ (Detailed Database Schema)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../database/detailed-schema.html#id1">×¡×§×™×¨×” ×›×œ×œ×™×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/detailed-schema.html#code-snippets">××•×¡×£: code_snippets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/detailed-schema.html#large-files">××•×¡×£: large_files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/detailed-schema.html#users">××•×¡×£: users</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/detailed-schema.html#bookmarks">××•×¡×£: bookmarks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/detailed-schema.html#collections">××•×¡×£: collections</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/detailed-schema.html#backups">××•×¡×£: backups</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/detailed-schema.html#id2">×™×—×¡×™× ×‘×™×Ÿ ××•×¡×¤×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/detailed-schema.html#best-practices">Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/detailed-schema.html#id3">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">×¢×–×¨×” ×•×“×•×’×××•×ª:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../examples.html">×“×•×’×××•×ª ×©×™××•×©</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#id2">×©×™××•×© ×‘×¡×™×¡×™</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id3">×™×¦×™×¨×ª ××¤×œ×™×§×¦×™×™×ª ×‘×•×˜</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id4">×©××™×¨×ª ×§×•×“ ×—×“×©</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id5">×—×™×¤×•×© ×§×•×“</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#handlers">×©×™××•×© ×‘-Handlers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#command-handler">×™×¦×™×¨×ª Command Handler</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#conversation-handler">×™×¦×™×¨×ª Conversation Handler</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#services">×©×™××•×© ×‘-Services</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id6">×–×™×”×•×™ ×©×¤×ª ×ª×›× ×•×ª</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id7">× ×™×ª×•×— ×§×•×“</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#github">××™× ×˜×’×¨×¦×™×” ×¢× GitHub</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#gist">×”×¢×œ××ª ×§×•×“ ×œ-Gist</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#gists">×©×œ×™×¤×ª Gists ×©×œ ××©×ª××©</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#id8">×¢×‘×•×“×” ×¢× ××¡×“ ×”× ×ª×•× ×™×</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id9">×‘×™×¦×•×¢ ×©××™×œ×ª×•×ª ××•×¨×›×‘×•×ª</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id10">×¢×“×›×•×Ÿ ×§×‘×¦×™×</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id11">×¡×˜×˜×™×¡×˜×™×§×•×ª</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#id12">×˜×™×¤×•×œ ×‘×©×’×™××•×ª</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id13">×˜×™×¤×•×œ ×‘×©×’×™××•×ª ×‘×¡×™×¡×™</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#retry-logic">Retry Logic</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#id14">×‘×“×™×§×•×ª</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id15">×‘×“×™×§×ª ×™×—×™×“×”</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id16">×‘×“×™×§×ª ××™× ×˜×’×¨×¦×™×”</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#id17">×“×•×’×××•×ª ××ª×§×“××•×ª</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id18">×¢×™×‘×•×“ ×‘××¦×•×•×”</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id19">×§××©×™× ×’</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#api-curl">×©×™×ª×•×£ ×¦×™×‘×•×¨×™ ×“×¨×š ×”â€‘API (curl)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#markdown">×“×•×’××ª Markdown ××ª×§×“××ª ×œ×ª×¦×•×’×”</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../testing.html">Testing Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#quickstart">ğŸš€ Quickstart ×œ×˜×¡×˜×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#id1">×”× ×—×™×•×ª ×§×¨×™×˜×™×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#stubs">×˜×¢×™× ×ª Stubs ×œ×˜×œ×’×¨×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#tmp-path">×“×•×’××ª ×©×™××•×© ×‘â€‘tmp_path</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#id2">××—×™×§×” ×‘×˜×•×—×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#mocking-http-github-menu-handler">Mocking HTTP ×‘â€‘github_menu_handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#blueprint">×¨×™×©×•× Blueprint ×‘×¡×‘×™×‘×ª ×˜×¡×˜×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#pytest-cov">×›×™×¡×•×™ ×‘×“×™×§×•×ª (pytest-cov)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#ci">CI × ×ª××š</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#performance">×‘×“×™×§×•×ª ×‘×™×¦×•×¢×™× (Performance)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#id3">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../testing-rate-limit-examples.html">×“×•×’×××•×ª ×˜×¡×˜×™× â€“ Rate Limiting ×•××¡×™× ×›×¨×•× ×™×•×ª</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../testing-rate-limit-examples.html#rate-limiting-redis-mock">Rate Limiting (Redis Mock)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing-rate-limit-examples.html#id1">×˜×¡×˜×™× ××¡×™× ×›×¨×•× ×™×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../performance-tests.html">×‘×“×™×§×•×ª ×‘×™×¦×•×¢×™× (Performance Tests)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../performance-tests.html#id1">××˜×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance-tests.html#id2">×¡×™××•×Ÿ ×˜×¡×˜×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance-tests.html#id3">×”×¨×¦×” ××§×•××™×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance-tests.html#ci-github-actions">CI / GitHub Actions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance-tests.html#id4">×“×•×—×•×ª ×•×–×× ×™ ×¨×™×¦×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance-tests.html#id5">×˜×™×¤×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ci-cd.html">CI/CD Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../ci-cd.html#id1">×—×•×§×™× ×§×©×™×—×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ci-cd.html#id2">×¡×˜×˜×•×¡×™× × ×“×¨×©×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ci-cd.html#ci-overview">×¨×™×›×•×– CI (Overview)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ci-cd.html#id3">×‘×“×™×§×•×ª ××•××œ×¦×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ci-cd.html#id4">×‘× ×™×™×” ×©×œ ×”×ª×™×¢×•×“</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ci-cd.html#id5">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../conversation-handlers.html">Conversation Handlers &amp; States</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#id1">×¡×§×™×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#states">×¨×©×™××ª States (××‘×—×¨ ×‘×¤×•×¢×œ)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#save-flow">Save Flow (×ª×¨×©×™× ××¦×‘×™×)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#github-flow">GitHub Flow (×ª×¨×©×™× ××¦×‘×™×)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#bot">×¡×¤×¨×™×™×ª ×¡× ×™×¤×˜×™× â€“ ×–×¨×™××ª ×”×’×©×” (Bot)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#id2">×‘×™×˜×•×œ ×”×•×’×Ÿ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#id3">×”×ª×¨××•×ª ××“××™×Ÿ ×•×”×•×“×¢×ª ××©×ª××©</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#handler">×“×•×’××ª Handler ×ª××¦×™×ª×™×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#id4">×˜×‘×œ×ª ×–×¨×™××•×ª ××œ××”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#id5">×§×™×©×•×¨×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#id6">×“×•×’×××•×ª ×§×•×“ ×ª××¦×™×ª×™×•×ª (×××©×™×•×ª)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#save">Save â€“ ×©×œ×‘×™× ×¢×™×§×¨×™×™×</a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#github">GitHub â€“ ×ª×¤×¨×™×˜ ×•×©×™×—×ª ×”×¢×œ××”</a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#backup">Backup â€“ ×ª×¤×¨×™×˜</a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#drive">Drive â€“ ×ª×¤×¨×™×˜</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#id7">××•×§×©×™× × ×¤×•×¦×™× ×•×¤×ª×¨×•× ×•×ª</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#query-answer"><code class="docutils literal notranslate"><span class="pre">query.answer()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#message-is-not-modified">×¢×¨×™×›×ª ×”×•×“×¢×•×ª ×‘×‘×˜×—×” â€“ â€Message is not modifiedâ€œ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#filters">Filters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#persistent-data-context-user-data">Persistent data (<code class="docutils literal notranslate"><span class="pre">context.user_data</span></code>)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#id8">×“×•×’×××•×ª ×˜×¡×˜×™× ×§×¦×¨×•×ª</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#id9">Save â€“ ×”×ª×—×œ×” ×•×–×¨×™××” ×‘×¡×™×¡×™×ª</a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#github-upload-conv-handler">GitHub â€“ upload_conv_handler</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting.html">Troubleshooting Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#id1">×©×’×™××•×ª × ×¤×•×¦×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#importerror-telegram-conversationhandler-filters">ImportError ×‘×–××Ÿ ×˜×¡×˜×™× (telegram / ConversationHandler / filters)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#parse-mode">×©×’×™××•×ª parse_mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#asyncio-attached-to-a-different-loop-event-loop-is-closed">×©×’×™××•×ª asyncio: â€attached to a different loopâ€œ / â€Event loop is closedâ€œ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#id2">×“×™×‘×•×’ ××”×™×¨</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#mongodb">×‘×“×™×§×ª ×—×™×‘×•×¨ MongoDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#id3">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../development.html">Development Workflow</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../development.html#handler">×”×•×¡×¤×ª Handler ×—×“×©</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development.html#endpoint-webapp">×”×•×¡×¤×ª Endpoint ×œâ€‘WebApp</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development.html#schema">×¢×“×›×•×Ÿ Schema ×‘××¡×“ ×”× ×ª×•× ×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development.html#id1">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../development/pre-commit.html">Pre-commit Hooks</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../development/pre-commit.html#id1">××˜×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development/pre-commit.html#id2">×”×ª×§× ×” ×•×”×¨×¦×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development/pre-commit.html#hooks">Hooks ×¤×¢×™×œ×™× (×¢×™×§×¨×™×™×)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development/pre-commit.html#id3">×˜×™×¤×™× ×œ×¤×ª×¨×•×Ÿ ×‘×¢×™×•×ª</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../integrations.html">Integrations</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../integrations.html#github-api">GitHub API</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../integrations.html#gist">×™×¦×™×¨×ª Gist (×“×•×’××”)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../integrations.html#google-drive-oauth-flow">Google Drive (OAuth Flow)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integrations.html#telegram-webhooks-vs-polling">Telegram Webhooks vs Polling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integrations.html#id1">×§×™×©×•×¨×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integrations.html#github-scopes">GitHub â€“ Scopes × ×“×¨×©×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integrations.html#troubleshooting-github-rate-limits">Troubleshooting GitHub â€“ Rate limits</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integrations.html#github-cli-gh">GitHub CLI (gh) â€“ ×ª×§×¦×™×¨ ×§×¦×¨</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integrations.html#repository-providers">Repository Providers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integrations.html#best-practices-monorepos">Best Practices â€“ ×××’×¨×™× ×’×“×•×œ×™×/Monorepos</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../repository-integrations.html">Repository Integrations</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../repository-integrations.html#id1">×¡×§×™×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../repository-integrations.html#id2">××¦×‘ ×ª××™×›×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../repository-integrations.html#id3">×”×¢×¨×•×ª</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../security.html">Security Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../security.html#id1">×¡×•×“×•×ª ×•×¤×¨×˜×™×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security.html#id2">×”×¦×¤× ×ª ×˜×•×§× ×™× (×“×•×’××”)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security.html#csrf-webapp">CSRF ×‘â€‘WebApp</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security.html#rate-limiting">Rate Limiting (×“×•×’××”)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security.html#id3">×§×™×©×•×¨×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security.html#id4">××‘×˜×—×ª ×”×•×“×¢×•×ª ×‘×˜×œ×’×¨×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../monitoring.html">Smart Observability v7 â€“ Predictive Health &amp; Adaptive Feedback</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../monitoring.html#grafana-telegram-webhook">×—×™×‘×•×¨ Grafana â†’ Telegram (Webhook)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../monitoring.html#grafana-annotations">Grafana Annotations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../monitoring.html#adaptive-thresholds">Adaptive Thresholds (×¡×¤×™× ×“×™× ××™×™×)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../monitoring.html#predictive-health-v7">Predictive Health (v7)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../monitoring.html#safe-mode">SAFE_MODE ×•×“×™×œ×•×’ ×¢×œ ×¤×¢×•×œ×•×ª ×× ×¢</a></li>
<li class="toctree-l3"><a class="reference internal" href="../monitoring.html#chatops">ChatOps</a></li>
<li class="toctree-l3"><a class="reference internal" href="../monitoring.html#chatops-rate-limit">×”×¨×©××•×ª ChatOps ×•-Rate Limit</a></li>
<li class="toctree-l3"><a class="reference internal" href="../monitoring.html#grafana">Grafana â€“ ×™×™×‘×•× ×“×©×‘×•×¨×“ ×œ×“×•×’××”</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../monitoring.html#grafana-accuracy-prevention-panels">Grafana â€“ Accuracy &amp; Prevention Panels</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../monitoring.html#feedback-loop">×ª×¨×©×™× ×–×¨×™××ª Feedback Loop</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../monitoring.html#autoremediation-v5">Autoâ€‘Remediation (v5)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../monitoring.html#incident-memory">Incident Memory</a></li>
<li class="toctree-l3"><a class="reference internal" href="../monitoring.html#id1">Feedback Loop ×œ××™×¨×•×¢×™× ×—×•×–×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../monitoring.html#chatops-observe">ChatOps â€“ /observe</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../monitoring.html#id2">×”×¨×—×‘×•×ª ××¦×‘ ××¤×•×¨×˜</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../monitoring.html#endpoints">Endpoints</a></li>
<li class="toctree-l2"><a class="reference internal" href="../monitoring.html#id3">×§×™×©×•×¨×™× ×œ×ª×™×¢×•×“ ChatOps</a></li>
<li class="toctree-l2"><a class="reference internal" href="../monitoring.html#id4">×˜×™×¤×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../git-lfs.html">Git LFS Integration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../git-lfs.html#id1">××˜×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../git-lfs.html#lfs">××ª×™ ×œ×”×©×ª××© ×‘â€‘LFS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../git-lfs.html#id2">×”×ª×§× ×” ×‘×¡×™×¡×™×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../git-lfs.html#best-practices">Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../git-lfs.html#id3">××’×‘×œ×•×ª ×•×’×‘×•×œ×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../git-lfs.html#id4">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../user/bookmarks.html">×¡×™×× ×™×•×ª (Bookmarks)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../user/bookmarks.html#id1">××”×Ÿ ×¡×™×× ×™×•×ª?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/bookmarks.html#id2">××™×š ×œ×”×•×¡×™×£ ×¡×™×× ×™×™×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/bookmarks.html#id3">×¤×× ×œ ×”×¡×™×× ×™×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/bookmarks.html#anchor">Anchor ×™×¦×™×‘</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/bookmarks.html#id4">××’×‘×œ×•×ª, ××‘×˜×—×” ×•×¤×¨×˜×™×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/bookmarks.html#api">API ×§×¦×¨ (×œ××¤×ª×—×™×)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/bookmarks.html#id5">×”×¢×¨×•×ª ×©×™××•×©×™×•×ª</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../user/sticky_notes.html">×¤×ª×§×™× ×“×‘×™×§×™× (Sticky Notes)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../user/sticky_notes.html#id1">××”× ×¤×ª×§×™× ×“×‘×™×§×™×?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/sticky_notes.html#id2">××™×š ××•×¡×™×¤×™× ×•×× ×”×œ×™× ×¤×ª×§×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/sticky_notes.html#id3">×¢×™×’×•×Ÿ ×™×¦×™×‘ ×œ×¢×•××ª ××™×§×•× ×§×‘×•×¢</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/sticky_notes.html#id4">×©×™×œ×•×‘ ×¢× ×¡×™×× ×™×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/sticky_notes.html#id5">××’×‘×œ×•×ª, ×¤×¨×˜×™×•×ª ×•××‘×˜×—×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/sticky_notes.html#id6">×˜×™×¤×™× ×©×™××•×©×™×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/sticky_notes.html#api">API ×§×¦×¨ (×œ××¤×ª×—×™×)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/sticky_notes.html#reminders">×”×ª×¨××•×ª ×•×ª×–×›×•×¨×•×ª (Reminders)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../user/sticky_notes.html#id7">××™×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../user/sticky_notes.html#troubleshooting">Troubleshooting ×§×¦×¨</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../user/sticky_notes.html#id8">×‘×¢×™×•×ª × ×¤×•×¦×•×ª ×‘×ª×–×›×•×¨×•×ª</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../user/my_collections.html">×”××•×¡×¤×™× ×©×œ×™ (My Collections)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../user/my_collections.html#id1">××”× ××•×¡×¤×™×?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/my_collections.html#id2">×™×›×•×œ×•×ª ××¨×›×–×™×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/my_collections.html#id3">××™×š ××©×ª××©×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/my_collections.html#id4">×©×™×œ×•×‘ ×¢× ×¡×™×× ×™×•×ª ×•×¤×ª×§×™× ×“×‘×™×§×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/my_collections.html#id5">××’×‘×œ×•×ª ×•×¤×¨×˜×™×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/my_collections.html#api">API ×§×¦×¨ (×œ××¤×ª×—×™×)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/my_collections.html#id6">×˜×™×¤×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/my_collections.html#id7">××•×‘×™×™×œ/×˜××‘×œ×˜ â€“ ×’×¨×™×¨×” ×œ×¡×™×“×•×¨</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../user/share_code.html">×©×™×ª×•×£ ×§×•×“ (×—×©×•×‘)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#id2">××” ×–×” ×¢×•×©×”?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#id3">××™×¤×” ×”×›×¤×ª×•×¨ ××•×¤×™×¢?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#id4">××™×š ×–×” ×¢×•×‘×“ (×–×¨×™××”)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#env">×“×¨×™×©×•×ª ×¡×‘×™×‘×ª×™×•×ª (ENV)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#id5">××’×‘×œ×•×ª ×•×”×ª× ×”×’×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#id6">×”×•×“×¢×•×ª ×”×¦×œ×—×”/×©×’×™××”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#troubleshooting">Troubleshooting ×§×¦×¨</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#id7">×“×•×’×××•×ª (×˜×§×¡×˜×•××œ×™×•×ª)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../user/github_browse.html">×¢×™×•×Ÿ ×‘×§×•×“ GitHub (×›×•×œ×œ ×—×™×¤×•×© ×‘×©× ×§×•×‘×¥)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../user/github_browse.html#id1">×©×•×¨×ª ×›×œ×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/github_browse.html#id2">×ª×•×¦××•×ª ×—×™×¤×•×©</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/github_browse.html#id3">× ×™×•×•×˜ ×¨×™×¤×•</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../user/download_repo.html">×”×•×¨×“×ª ×¨×™×¤×•</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../user/download_repo.html#id2">××” ×‘×“×™×•×§ ××•×¨×™×“</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/download_repo.html#id3">××’×‘×œ×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/download_repo.html#id4">×”×•×“×¢×•×ª × ×¤×•×¦×•×ª</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../BOT_TEST_PLAN_CONTAINER.html">×ª×›× ×™×ª ×‘×“×™×§×•×ª ×œ×‘×•×˜ â€“ Composition Root (Container) ×œ×©×™×¨×•×ª Snippet</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../BOT_TEST_PLAN_CONTAINER.html#id1">××™×š ×œ×‘×“×•×§</a></li>
<li class="toctree-l2"><a class="reference internal" href="../BOT_TEST_PLAN_CONTAINER.html#copy-paste">×¡×˜ ×“×•×’×××•×ª ×œ×©××™×¨×” (Copy/Paste)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../BOT_TEST_PLAN_CONTAINER.html#id2">×‘×“×™×§×•×ª × ×•×¡×¤×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../BOT_TEST_PLAN_CONTAINER.html#id3">×ª×§×œ×•×ª ×©×›×“××™ ×œ×¢×§×•×‘ ××—×¨×™×”×Ÿ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../BOT_TEST_PLAN_CONTAINER.html#facade-container">×‘×“×™×§×•×ª ×–×¨×™××” ××•×¨×—×‘×•×ª (×œ××—×¨ ××¢×‘×¨ ×œ-Facade/Container)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../BOT_TEST_PLAN_CONTAINER.html#id4">1) ×©××™×¨×”/×ª×¦×•×’×”/×¢×¨×™×›×” (×§×‘×¦×™× ×¨×’×™×œ×™×)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../BOT_TEST_PLAN_CONTAINER.html#id5">2) ×§×‘×¦×™× ×’×“×•×œ×™×</a></li>
<li class="toctree-l3"><a class="reference internal" href="../BOT_TEST_PLAN_CONTAINER.html#id6">3) ××¡××›×™×/×”×¢×œ××•×ª</a></li>
<li class="toctree-l3"><a class="reference internal" href="../BOT_TEST_PLAN_CONTAINER.html#google-drive">4) Google Drive</a></li>
<li class="toctree-l3"><a class="reference internal" href="../BOT_TEST_PLAN_CONTAINER.html#chatops">5) ChatOps â€“ ×–×™×”×•×™ ×©×¤×” (×©×§×™×¤×•×ª ×•×“×™×‘×•×’)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../BOT_TEST_PLAN_CONTAINER.html#id7">6) ×¨×’×¨×¡×™×” ×›×œ×œ×™×ª</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">×–×¨×™××•×ª ×¢×‘×•×“×”:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../workflows/index.html">×–×¨×™××•×ª ×¢×‘×•×“×” (Workflows)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../workflows/index.html#id1">×¡×§×™×¨×” ×›×œ×œ×™×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../workflows/index.html#id2">×¨×©×™××ª ×–×¨×™××•×ª</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../workflows/save-flow.html">×–×¨×™××ª ×©××™×¨×ª ×§×•×“ (Save Flow)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../workflows/save-flow.html#id1">×¡×§×™×¨×” ×›×œ×œ×™×ª</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/save-flow.html#id2">××¦×‘×™ ×©××™×¨×”</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/save-flow.html#id3">×–×¨×™××ª ×¢×‘×•×“×” ×‘×¡×™×¡×™×ª</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/save-flow.html#long-collect">××¦×‘ ××™×¡×•×£ ××¨×•×š (LONG_COLLECT)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/save-flow.html#secrets-detection">×–×™×”×•×™ ×¡×•×“×•×ª (Secrets Detection)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/save-flow.html#id4">×˜×™×¤×•×œ ×‘×›×¤×™×œ×•×™×•×ª</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/save-flow.html#id5">× ×¨××•×œ ×§×•×“</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/save-flow.html#edge-cases">Edge Cases</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/save-flow.html#id6">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../workflows/search-flow.html">×–×¨×™××ª ×—×™×¤×•×© (Search Flow)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../workflows/search-flow.html#id1">×¡×§×™×¨×” ×›×œ×œ×™×ª</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/search-flow.html#id2">×¡×•×’×™ ×—×™×¤×•×©</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/search-flow.html#id3">×–×¨×™××ª ×¢×‘×•×“×”</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/search-flow.html#searchindex">××‘× ×” SearchIndex</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/search-flow.html#id4">×¤×™×œ×˜×¨×™×</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/search-flow.html#regex">×˜×™×¤×•×œ ×‘×©×’×™××•×ª Regex</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/search-flow.html#id5">××™×•×Ÿ ×ª×•×¦××•×ª</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/search-flow.html#relevance-score">×—×™×©×•×‘ Relevance Score</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/search-flow.html#edge-cases">Edge Cases</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/search-flow.html#id6">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../workflows/refactor-flow.html">×–×¨×™××ª ×¨×¤×§×˜×•×¨×™× ×’ (Refactor Flow)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#id1">×¡×§×™×¨×” ×›×œ×œ×™×ª</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#id2">×¡×•×’×™ ×¨×¤×§×˜×•×¨×™× ×’</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#id3">×–×¨×™××ª ×¢×‘×•×“×”</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#telegram">×©×™××•×© ×‘×‘×•×˜ (Telegram)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#codeanalyzer">CodeAnalyzer</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#id4">×™×¦×™×¨×ª ×”×¦×¢×ª ×¨×¤×§×˜×•×¨×™× ×’</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#id5">××™××•×ª ×œ×¤× ×™ ×•××—×¨×™</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#id6">×™×™×¦×•× ×œ×’×™×¡×˜ (××•×¤×¦×™×•× ×œ×™)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#id7">×©××™×¨×ª ×’×¨×¡×”</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#edge-cases">Edge Cases</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#cohesion-policy">××“×™× ×™×•×ª ×§×™×‘×•×¥ ×•×¤×™×¦×•×œ (Cohesion Policy)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#smart-clustering-cycle-guard">Smart Clustering ×•â€‘Cycle Guard</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#safe-decomposition-models-py">Safe Decomposition ×œâ€‘models.py</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#canonical">×©××•×ª ×§×‘×¦×™× ×“×•××™×™× ×™×™× (Canonical)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#layered">××¦×‘ ×©×›×‘×•×ª (Layered)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#id8">×¤×¨××˜×¨×™× × ×™×ª× ×™× ×œ×›×•×•× ×•×Ÿ</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#id9">××’×‘×œ×•×ª ×™×“×•×¢×•×ª</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/refactor-flow.html#id10">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../workflows/backup-flow.html">×–×¨×™××ª ×’×™×‘×•×™ ×•×©×—×–×•×¨ (Backup Flow)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../workflows/backup-flow.html#id1">×¡×§×™×¨×” ×›×œ×œ×™×ª</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/backup-flow.html#id2">×¡×•×’×™ ×’×™×‘×•×™×™×</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/backup-flow.html#id3">×™×¦×™×¨×ª ×’×™×‘×•×™ ××œ×</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/backup-flow.html#id4">×©×—×–×•×¨ ××’×™×‘×•×™</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/backup-flow.html#google-drive">×’×™×‘×•×™ ×œ-Google Drive</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/backup-flow.html#id5">× ×™×”×•×œ ×’×™×‘×•×™×™×</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/backup-flow.html#zip">×™×™×‘×•× ZIP ×—×™×¦×•× ×™</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/backup-flow.html#edge-cases">Edge Cases</a></li>
<li class="toctree-l4"><a class="reference internal" href="../workflows/backup-flow.html#id6">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../workflows/index.html#id3">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">×× ×•×¢×™ ×”××¢×¨×›×ª:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../engines/overview.html">×× ×•×¢×™ ×”××¢×¨×›×ª (System Engines)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../engines/overview.html#id1">×¡×§×™×¨×” ×›×œ×œ×™×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../engines/overview.html#search-engine">×× ×•×¢ ×—×™×¤×•×© (Search Engine)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../engines/overview.html#refactoring-engine">×× ×•×¢ ×¨×¤×§×˜×•×¨×™× ×’ (Refactoring Engine)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../engines/overview.html#smart-clustering-cycle-guard">×™×›×•×œ×•×ª ××ª×§×“××•×ª (Smart Clustering, Cycle Guard)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../engines/overview.html#layered-mode">××¦×‘ ×©×›×‘×•×ª (Layered Mode)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../engines/overview.html#safe-decomposition-models-py-models">Safe Decomposition ×œâ€‘models.py (×¤×™×¦×•×œ ×‘×˜×•×— ×œ×—×‘×™×œ×ª models/)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../engines/overview.html#code-processor">××¢×‘×“ ×§×•×“ (Code Processor)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../engines/overview.html#code-analyzer">×× ×•×¢ × ×™×ª×•×— (Code Analyzer)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../engines/overview.html#backup-service">×× ×•×¢ ×’×™×‘×•×™×™× (Backup Service)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../engines/overview.html#integration-services">×× ×•×¢ ××™× ×˜×’×¨×¦×™×•×ª (Integration Services)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../engines/overview.html#observability">×× ×•×¢ Observability</a></li>
<li class="toctree-l2"><a class="reference internal" href="../engines/overview.html#id2">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Edge Cases ×•×˜×™×¤×•×œ ×‘×©×’×™××•×ª:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../edge-cases.html">Edge Cases ×•×˜×™×¤×•×œ ×‘×©×’×™××•×ª</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../edge-cases.html#id1">×¡×§×™×¨×” ×›×œ×œ×™×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../edge-cases.html#id2">×§×‘×¦×™× ×’×“×•×œ×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../edge-cases.html#id3">×§×™×“×•×“×™× ×œ× ×¡×˜× ×“×¨×˜×™×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../edge-cases.html#github-rate-limits">GitHub Rate Limits</a></li>
<li class="toctree-l2"><a class="reference internal" href="../edge-cases.html#mongodb-connection-errors">MongoDB Connection Errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../edge-cases.html#redis-unavailability">Redis Unavailability</a></li>
<li class="toctree-l2"><a class="reference internal" href="../edge-cases.html#parsing">×©×’×™××•×ª Parsing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../edge-cases.html#file-i-o">×©×’×™××•×ª File I/O</a></li>
<li class="toctree-l2"><a class="reference internal" href="../edge-cases.html#network">×©×’×™××•×ª Network</a></li>
<li class="toctree-l2"><a class="reference internal" href="../edge-cases.html#validation">×©×’×™××•×ª Validation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../edge-cases.html#concurrent-access">×©×’×™××•×ª Concurrent Access</a></li>
<li class="toctree-l2"><a class="reference internal" href="../edge-cases.html#best-practices">Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../edge-cases.html#id4">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">××™×›×•×ª ×•×§×•× ×‘× ×¦×™×•×ª:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quality/type-safety.html">ğŸ“ Type Hints â€“ Best Practices</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../quality/type-safety.html#id1">××¡×˜×¨×˜×’×™×”: ×”×§×©×—×” ×”×“×¨×’×ª×™×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quality/type-safety.html#id2">×¤×¨×•×˜×•×§×•×œ×™× ×•×¡×˜××‘×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quality/type-safety.html#id3">×“×•×’×××•×ª ××”×§×•×“</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quality/type-safety.html#mypy">×”×’×“×¨×•×ª MyPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quality/type-safety.html#id4">××¡×œ×•×œ ××™×’×¨×¦×™×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quality/type-safety.html#id5">×”× ×—×™×•×ª ×œ×¡×•×›× ×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quality/type-safety.html#id6">×“×•×’×××•×ª ×§×¦×¨×•×ª</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../quality/code-normalization.html">× ×¨××•×œ ×§×•×“ (Code Normalization)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../quality/code-normalization.html#id1">×œ××” ×‘×›×œ×œ ×× ×¨××œ×™×?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quality/code-normalization.html#id2">××ª×™ ×•××™×¤×” ×”×× ×’× ×•×Ÿ ×¨×¥?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quality/code-normalization.html#id3">××” ×‘×“×™×•×§ ×§×•×¨×” ×‘××”×œ×š ×”× ×¨××•×œ?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quality/code-normalization.html#api">××™×š ×œ×‘×—×•×¨ API?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quality/code-normalization.html#id4">×“×’×©×™× ×œ×¡×•×›× ×™× ×‘×¢×ª ×›×ª×™×‘×ª ×§×•×“</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quality/code-normalization.html#id5">×˜×¡×˜×™×, ×“×™×‘×•×’ ×•×©×—×–×•×¨ ×ª×§×œ×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quality/code-normalization.html#id6">×©××œ×•×ª × ×¤×•×¦×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quality/code-normalization.html#id7">××” ×œ×¢×©×•×ª ×›×©××•×¡×™×¤×™× ×–×¨×™××” ×—×“×©×”?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quality/code-normalization.html#id8">×§×™×©×•×¨×™× ×¨×œ×•×•× ×˜×™×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ARCHITECTURE_LAYER_RULES.html">×›×œ×œ×™ ×©×›×‘×•×ª â€“ CodeBot</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../ARCHITECTURE_LAYER_RULES.html#id1">×©×›×‘×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ARCHITECTURE_LAYER_RULES.html#composition-root">Composition Root</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ARCHITECTURE_LAYER_RULES.html#id2">×–×™×”×•×™ ×©×¤×” â€“ ××§×•×¨ ×××ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ARCHITECTURE_LAYER_RULES.html#id3">×‘×“×™×§×•×ª ××›×™×¤×”</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">WebApp:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../webapp/overview.html">×”××™× ×™ Web App (×¡×§×™×¨×”)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/overview.html#id1">××” × ×•×ª×Ÿ?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/overview.html#id2">×“×©×‘×•×¨×“ ×—×“×©</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../webapp/overview.html#id3">××™×™×§×•× ×™ ×©×¤×” ××—×™×“×™×</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../webapp/overview.html#id4">×˜×‘×œ×ª ××™×™×§×•× ×™× × ×¤×•×¦×™×</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/overview.html#ai">×”× ×—×™×•×ª ×œ×¡×•×›× ×™ AI</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/overview.html#id5">×›×ª×•×‘×ª ×•×”×¨×©××•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/overview.html#env">×”×’×“×¨×•×ª ENV</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/overview.html#id6">×§×™×©×•×¨×™× ×•×ª××•× ×•×ª ××¡×š</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/overview.html#id7">×¨××• ×’×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/overview.html#id8">×‘×× ×¨ ×”×›×¨×–×•×ª ×‘×¨××© ×”××¡×š</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../webapp/overview.html#id9">××™×š ××¤×¢×™×œ×™×?</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/overview.html#id10">×”×¢×¨×•×ª ×•×§×™×©×•×¨×™×</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/overview.html#id11">××” ×§×•×¨×” ×××—×•×¨×™ ×”×§×œ×¢×™×?</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/overview.html#id12">×›×™×‘×•×™ ×–×× ×™</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/overview.html#id13">×”××œ×¦×•×ª ×œ×ª×•×›×Ÿ</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../DEV_WEB_PUSH.html">Web Push â€“ Sticky Notes Reminders</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../DEV_WEB_PUSH.html#id1">×“×¨×™×©×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../DEV_WEB_PUSH.html#vapid">×”×’×“×¨×ª ××¤×ª×—×•×ª VAPID</a></li>
<li class="toctree-l2"><a class="reference internal" href="../DEV_WEB_PUSH.html#id2">×”×¤×¢×œ×”/×›×™×‘×•×™</a></li>
<li class="toctree-l2"><a class="reference internal" href="../DEV_WEB_PUSH.html#remote-worker">××¦×‘ Remote Worker (××•××œ×¥ ×œ×¤×¨×•×“×§×©×Ÿ)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../DEV_WEB_PUSH.html#sidecar-render">×—×œ×•×¤×”: Sidecar (×œ×œ× ×©×™×¨×•×ª Render × ×•×¡×£)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../DEV_WEB_PUSH.html#server">× ×§×•×“×•×ª ×§×¦×” (Server)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../DEV_WEB_PUSH.html#service-worker">Service Worker</a></li>
<li class="toctree-l2"><a class="reference internal" href="../DEV_WEB_PUSH.html#id3">×¦×“â€‘×œ×§×•×—</a></li>
<li class="toctree-l2"><a class="reference internal" href="../DEV_WEB_PUSH.html#id4">×©×œ×™×—×” ×‘×–××Ÿ ×××ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../DEV_WEB_PUSH.html#id5">×‘×“×™×§×•×ª</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/user-interfaces.html">×××©×§×™ ××©×ª××©×™× (Web)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/user-interfaces.html#id1">××” ×–×”?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/user-interfaces.html#id2">×”×™×›×Ÿ ×–×” × ××¦×?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/user-interfaces.html#id3">×–×¨×™××ª ×¢×‘×•×“×” ×“×¨×š ×”×‘×•×˜</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/user-interfaces.html#id4">×©×“×•×ª ×—×•×‘×” ×•×œ×•×’×™×§×ª ×•×œ×™×“×¦×™×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/user-interfaces.html#id5">×—×™×•×•×™ ××¦×‘ ×ª×”×œ×™×š</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/user-interfaces.html#id6">×××©×§ ××“××™×Ÿ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/user-interfaces.html#ai">×“×•×’×××•×ª ×©×™××•×© ×œ×¡×•×›× ×™ AI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/user-interfaces.html#id7">××‘×˜×—×” ×•×¤×¨×˜×™×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/user-interfaces.html#id8">×”×¢×¨×•×ª ×ª××™××•×ª</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/snippet-library.html">×¡×¤×¨×™×™×ª ×¡× ×™×¤×˜×™× (Web)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/snippet-library.html#id1">××” ×–×”?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/snippet-library.html#ui">×××¤×™×™× ×™ UI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/snippet-library.html#api-json">API â€“ JSON</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../webapp/snippet-library.html#openapi">OpenAPI (×ª×§×¦×™×¨)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/snippet-library.html#json-schema-response">JSON Schema (Response)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/snippet-library.html#id2">×›×œ×œ×™ ×“×¤×“×•×£/×¡×¤×™×¨×”</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/snippet-library.html#id3">×©×’×™××•×ª</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/snippet-library.html#curl">×“×•×’×××•×ª cURL</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/snippet-library.html#id4">×”×’×©×•×ª, ××™×©×•×¨ ×•× ×™×”×•×œ (××“××™×Ÿ)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/snippet-library.html#id5">×™×™×‘×•× ××¡××š (××“××™×Ÿ)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/snippet-library.html#id6">×”×’×©×” ×“×¨×š ×”×‘×•×˜</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/snippet-library.html#id7">UI ×‘×‘×•×˜ â€“ ×”×¡×¨×•×ª ×•×©×™×¤×•×¨×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/snippet-library.html#id8">×’×¨×¡×” ××©×•×“×¨×’×ª â€“ ××” ×—×“×©</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/snippet-library.html#ai">××“×¨×™×š ×§×¦×¨ ×œ×¡×•×›× ×™ AI</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/onboarding.html">ğŸ‰ Onboarding (Welcome Modal) â€“ WebApp</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/onboarding.html#id1">××˜×¨×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/onboarding.html#id2">×–×¨×™××ª ××©×ª××©</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/onboarding.html#anchors">×§×™×©×•×¨×™ ××“×¨×™×›×™× (Anchors)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/onboarding.html#best-practices">Best Practices â€“ ××™× ×“×™×§×¦×™×” ×œ××©×ª××©×™× ×—×“×©×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/onboarding.html#js-ajax">×“×•×’××ª JS â€“ ××•×“××œ ×¢× Ajax</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/onboarding.html#api">API ×§×©×•×¨</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/onboarding.html#id3">××“×™×”</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/caching.html">Caching &amp; HTTP Validators (ETag / Last-Modified / 304)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#id1">×œ××” ×–×” ×—×©×•×‘?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#id2">×¢×§×¨×•× ×•×ª ×‘×¡×™×¡</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#flask-werkzeug">××ª×›×•×Ÿ: Flask + werkzeug</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#copypaste">×‘×“×™×§×•×ª ×™×“× ×™×•×ª (Copyâ€‘Paste)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#checklist">Checklist ×œ××™××•×© × ×›×•×Ÿ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#gotchas">Gotchas × ×¤×•×¦×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#cache-control">×©×™×œ×•×‘ ×¢× Cache-Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#id3">×§×™×©×•×¨×™× × ×•×¡×¤×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/advanced-caching.html">××¢×¨×›×ª Caching ××ª×§×“××ª ×¢× TTL ×“×™× ××™</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/advanced-caching.html#id1">×¢×§×¨×•× ×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/advanced-caching.html#id2">×§×•×“ ×œ×“×•×’××”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/advanced-caching.html#id3">×“×’×©×™× ×ª×¤×¢×•×œ×™×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/advanced-caching.html#id4">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/static-checklist.html">Static Performance &amp; Security Checklist (gzip/br, Cache, SRI)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/static-checklist.html#id1">××˜×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/static-checklist.html#br-gzip">×“×—×™×¡×” (br/gzip)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/static-checklist.html#cache-control">×›×•×ª×¨×•×ª Cache-Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/static-checklist.html#subresource-integrity-sri">Subresource Integrity (SRI)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/static-checklist.html#copypaste">×‘×“×™×§×•×ª ×™×“× ×™×•×ª (Copyâ€‘Paste)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/static-checklist.html#best-practices">Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/static-checklist.html#gotchas">Gotchas</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/api-reference.html">WebApp API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/api-reference.html#endpoints">Endpoints</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/api-reference.html#authentication-flow">Authentication Flow</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/api-reference.html#response-schema-example">Response Schema Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/api-reference.html#errors">Errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/api-reference.html#post-api-shared-save">×©×’×™××•×ª × ×¤×•×¦×•×ª â€“ <code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/api/shared/save</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/api-reference.html#id1">×§×™×©×•×¨×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/api-reference.html#files">××¡× ×Ÿ ×•×©×“×•×ª ×§×œ×˜ ×œ-<code class="docutils literal notranslate"><span class="pre">/files</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../webapp/api-reference.html#id2">×˜×‘×œ×ª ×¤×¨××˜×¨×™×</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/api-reference.html#id3">×“×•×’×××•×ª ×‘×§×©×”</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/api-reference.html#id4">×“×•×’×××•×ª ×ª×’×•×‘×”</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/bulk-actions.html">Bulk actions (×‘×—×™×¨×” ××¨×•×‘×”)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/bulk-actions.html#id1">×¡×§×™×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/bulk-actions.html#endpoints">Endpoints</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../webapp/bulk-actions.html#post-api-files-bulk-favorite"><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/api/files/bulk-favorite</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/bulk-actions.html#post-api-files-bulk-unfavorite"><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/api/files/bulk-unfavorite</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/bulk-actions.html#post-api-files-bulk-tag"><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/api/files/bulk-tag</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/bulk-actions.html#post-api-files-create-zip"><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/api/files/create-zip</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/bulk-actions.html#post-api-files-bulk-delete-soft-delete"><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/api/files/bulk-delete</span></code> (Soft Delete)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/bulk-actions.html#post-api-files-create-share-link"><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/api/files/create-share-link</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/bulk-actions.html#id2">×©×’×™××•×ª × ×¤×•×¦×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/bulk-actions.html#id3">×”×¢×¨×•×ª ×œ××¤×ª×—×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/editor.html">âŒ¨ï¸ ×¢×•×¨×š ×§×•×“ (WebApp Editor)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/editor.html#codemirror-isloading">×˜×¢×™× ×ª CodeMirror ×•××¦×‘ isLoading</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/editor.html#api">×©××™×¨×ª ×”×¢×“×¤×•×ª ××©×ª××© â€“ ×©× ×™ × ×ª×™×‘×™ API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/editor.html#id1">×”××œ×¦×•×ª</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/markdown-folding.html">Markdown â€“ ××¦×‘ ××¦×•××¦× (×§×™×¤×•×œ ×›×•×ª×¨×•×ª ###) â€“ ××“××™×Ÿ ×‘×œ×‘×“</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/markdown-folding.html#id1">×××¤×™×™× ×™× ×¢×™×§×¨×™×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/markdown-folding.html#id2">×”×–×¨×§×ª ×“×’×œ ×”×¨×©××” ×œ×ª×‘× ×™×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/markdown-folding.html#id3">×¢×§×¨×•× ×•×ª ×”××™××•×© ×‘×¦×“ ×”×œ×§×•×—</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/markdown-folding.html#id4">×¦â€™×§â€‘×œ×™×¡×˜ ×œ×¤×™×¦â€™×¨×™× ××§×•××™×™× ×“×•××™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/smooth-scrolling.html">Smooth Scrolling (WebApp) â€” ××“×¨×™×š ×ª××¦×™×ª×™ ×œ×¡×•×›× ×™ AI</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/smooth-scrolling.html#id1">××” ×¤×¢×™×œ ×›×‘×¨</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/smooth-scrolling.html#api">API ×œ×©×™××•×© ×§×œ×™×™× ×˜</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/smooth-scrolling.html#id2">×©××™×¨×ª ×”×¢×“×¤×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/smooth-scrolling.html#id3">×××©×§ ×”×’×“×¨×•×ª ××•×‘× ×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/smooth-scrolling.html#ai">×”× ×—×™×•×ª ×œ×¡×•×›× ×™ AI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/smooth-scrolling.html#id4">×× ×“×¨×•××™×“ â€” ××” ×™×© ×•××” ×œ×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/smooth-scrolling.html#id5">× ×’×™×©×•×ª ×•×‘×™×¦×•×¢×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/smooth-scrolling.html#id6">×¤×ª×¨×•×Ÿ ×ª×§×œ×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/smooth-scrolling.html#roadmap">×ª×•×›× ×™×ª ×”××©×š (Roadmap ××§×•×¦×¨)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/smooth-scrolling.html#id7">×§×™×©×•×¨×™× ×¤× ×™××™×™×</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Observability</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../observability.html">××•×‘×–×¨×•×•×‘×™×œ×™×•×ª (Observability)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../observability.html#id1">××˜×¨×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability.html#id2">×§×”×œ×™ ×™×¢×“</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability.html#id3">×ª×¦×•×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability.html#backend-traces">×‘×—×™×¨×ª Backend ×œÖ¾Traces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability.html#otlp">×”×’×“×¨×ª OTLP ×œ×¡×‘×™×‘×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability.html#id4">×§×™×©×•×¨×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability.html#manual-instrumentation">××™× ×¡×˜×¨×•×× ×˜×¦×™×” ×™×“× ×™×ª (Manual Instrumentation)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability.html#jaeger">×“×•×§×¨ ×§×•××¤×•×– â€“ ×”×¤×¢×œ×” ××”×™×¨×” ×¢× Jaeger</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../observability.html#quick-start-jaeger">Quick start â€“ ××™××•×ª ×¡×¤×× ×™× ×‘Ö¾Jaeger</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../observability.html#traced">×›×™×¡×•×™ ×“×§×•×¨×˜×•×¨ &#64;traced</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability.html#staging">××™××•×ª ×‘-Staging</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../rate-limiting.html">Rate Limiting</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../rate-limiting.html#id1">××‘×•×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rate-limiting.html#shadow-mode">Shadow Mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rate-limiting.html#softwarning-80">Softâ€‘Warning (80%)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rate-limiting.html#admin-bypass">Admin Bypass</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rate-limiting.html#monitoring">Monitoring</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rate-limiting.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rate-limiting.html#id2">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../observability/guidelines.html">ğŸ“Š ×”× ×—×™×•×ª Observability ×•××™×¨×•×¢×™×</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../observability/guidelines.html#id1">×ª×‘× ×™×ª ××™×¨×•×¢/×œ×•×’ â€“ ×©×“×•×ª ×—×•×‘×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/guidelines.html#fail-open">×¢×§×¨×•×Ÿ Fail-Open</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/guidelines.html#id2">×”× ×—×™×•×ª ×˜×™×¤×•×œ ×‘×©×’×™××•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/guidelines.html#request-id">×§×•×¨×œ×¦×™×” ×¢× request_id</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/guidelines.html#id3">×¡×˜× ×“×¨×˜×™× × ×•×¡×¤×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../logging_schema.html">×¡×›××ª ×œ×•×’×™× ×•××™×¨×•×¢×™× (Observability)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../logging_schema.html#id1">×©×“×•×ª ×—×•×‘×” ×‘×›×œ ××™×¨×•×¢</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logging_schema.html#id2">×©×“×•×ª ××•××œ×¦×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logging_schema.html#id3">××™×¨×•×¢×™× ××¨×›×–×™×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logging_schema.html#sampling">×“×’×™××” (Sampling)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logging_schema.html#id4">×¤×¨×˜×™×•×ª</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../metrics.html">××“×“×™× (Metrics)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../metrics.html#id1">× ×§×•×“×ª ×§×¦×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metrics.html#id2">××˜×¨×™×§×•×ª ×§×™×™××•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metrics.html#codebot-handlers-commands-db">××“×“×™ CodeBot ×™×™×¢×•×“×™×™× (Handlers/Commands/DB)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metrics.html#opentelemetry">××˜×¨×™×§×•×ª OpenTelemetry (×× ×–××™× ×•×ª)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metrics.html#promql">×“×•×’×××•×ª PromQL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metrics.html#tracing-grafana">Tracing ×‘-Grafana</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metrics.html#slo-sli">SLO/SLI ×œ×“×•×’××”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metrics.html#prometheus-alerting-rules">×”×ª×¨××•×ª (Prometheus alerting rules)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../resilience.html">Resilience ×œ×©×™×¨×•×ª×™× ×—×™×¦×•× ×™×™×</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../resilience.html#id1">×œ××” ×©×›×‘×” ××¨×•×›×–×ª?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../resilience.html#id2">××™×š ×–×” ×¢×•×‘×“?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../resilience.html#env">×§×•× ×¤×™×’×•×¨×¦×™×” ×—×©×•×‘×” (ENV)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../resilience.html#id3">×˜×™×¤</a></li>
<li class="toctree-l2"><a class="reference internal" href="../resilience.html#id4">×©×™××•×© ×‘×§×•×“</a></li>
<li class="toctree-l2"><a class="reference internal" href="../resilience.html#id5">×¨××• ×’×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../alerts.html">×”×ª×¨××•×ª (Alerts)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../alerts.html#id1">×¡×§×™×¨×” ××”×™×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../alerts.html#id2">×—×•×§×™ ×‘×¨×™×¨×ª ×”××—×“×œ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../alerts.html#id3">×”×ª×××” ×œ×¦×¨×›×™× ×©×œ×š</a></li>
<li class="toctree-l2"><a class="reference internal" href="../alerts.html#alert-manager">×§×•× ×¤×™×’×•×¨×¦×™×™×ª <code class="docutils literal notranslate"><span class="pre">alert_manager</span></code> ×‘××¤×œ×™×§×¦×™×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../alerts.html#id4">×˜×¢×™× ×ª ×©×™× ×•×™×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../alerts.html#id5">×‘×“×™×§×ª ×”×–×¨×™××” ×‘×§×¦×” ×”×©× ×™</a></li>
<li class="toctree-l2"><a class="reference internal" href="../alerts.html#id6">×˜×™×¤×™× ××—×¨×•× ×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../alerts.html#id7">×¨××• ×’×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../alerts.html#id8">×”×ª×¨××•×ª ××¢×¨×›×ª â€“ ×“×™×¡×§ ×›××¢×˜ ××œ×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../observability/log_based_alerts.html">×”×ª×¨××•×ª ××‘×•×¡×¡×•×ª ×œ×•×’×™× (Logâ€‘based Alerts)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#id1">××” ×–×” ×•×œ××”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#id2">×”×¨×›×™×‘×™× ×‘×§×•×“</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#id3">×§×‘×¦×™ ×§×•× ×¤×™×’</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../observability/log_based_alerts.html#config-error-signatures-yml">×“×•×’××” ××™× ×™××œ×™×ª: <code class="docutils literal notranslate"><span class="pre">config/error_signatures.yml</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../observability/log_based_alerts.html#config-alerts-yml">×“×•×’××” ××™× ×™××œ×™×ª: <code class="docutils literal notranslate"><span class="pre">config/alerts.yml</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#option-b">Option B â€“ ×—×™×‘×•×¨ ×‘×ª×•×š ×”×§×•×“ (××•××©)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../observability/log_based_alerts.html#id4">××©×ª× ×™ ×¡×‘×™×‘×”</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#option-a-sidecar">Option A â€“ Sidecar ××–×¨× ×œ×•×’×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#id5">×¡×¤×™× ×•×§×™×‘×•×¥ â€“ ×‘×¨×™×¨×•×ª ××—×“×œ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#fingerprint">××¡×˜×¨×˜×’×™×™×ª fingerprint ×•×§× ×•× ×™×§×œ×™×–×¦×™×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#id6">×¦â€™×§×œ×™×¡×˜ ×œ××¤×ª×—×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#id7">×‘×“×™×§×” ××§×•××™×ª (×¡×™××•×œ×¦×™×”)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#ai">×”× ×—×™×•×ª ×œ×¡×•×›× ×™ AI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#id8">××‘×˜×—×” ×•×¤×¨×˜×™×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#rollout">Rollout ××•××œ×¥</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#id9">×¨××• ×’×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#id10">×§×™×©×•×¨×™× ×œ×§×•×“</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#id11">×˜×§×¡×•× ×•××™×™×ª ×©×’×™××•×ª ×•×—×ª×™××•×ª</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../observability/log_based_alerts.html#id12">×ª×¨×©×™× ×–×¨×™××” ××§×•×¦×¨</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#chatops">×ª×¦×•×’×” ×‘â€‘ChatOps</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../observability/log_based_alerts.html#placeholder">×¤×œ×˜ ×œ×“×•×’××” (Placeholder)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../observability/log_based_alerts.html#classify-error">×§×¨×™××ª ×”××©×š â€“ <code class="docutils literal notranslate"><span class="pre">classify_error()</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../sentry.html">Sentry</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../sentry.html#id1">×”×¤×¢×œ×” (××©×ª× ×™ ×¡×‘×™×‘×”)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sentry.html#id2">×¢×§×¨×•× ×•×ª</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../runbooks/incident-checklist.html">Incident Checklist (Onâ€‘Call)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/incident-checklist.html#incident">×‘×¢×ª ×¤×ª×™×—×ª Incident</a></li>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/incident-checklist.html#id1">×¡×˜×˜×•×¡×™ ××¢×§×‘ ××—×™×“×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/incident-checklist.html#id2">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../runbooks/logging-levels.html">×©×™× ×•×™ ×¨××•×ª ×œ×•×’×™×</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/logging-levels.html#debug">××ª×™ ×œ×”×¢×œ×•×ª ×œ-DEBUG</a></li>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/logging-levels.html#id2">×˜×™×¤</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../runbooks/github_backup_restore.html">GitHub Backup &amp; Restore Runbook</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/github_backup_restore.html#id1">××˜×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/github_backup_restore.html#id2">×“×¨×™×©×•×ª ××§×“×™××•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/github_backup_restore.html#checkpoint-tag">×™×¦×™×¨×ª × ×§×•×“×ª ×’×™×‘×•×™ (Checkpoint Tag)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/github_backup_restore.html#zip">×™×¦×™×¨×ª ××¨×›×™×•×Ÿ ZIP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/github_backup_restore.html#id3">×©×—×–×•×¨ â€“ ×‘×“×™×§×” ××§×•××™×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/github_backup_restore.html#id4">×©×—×–×•×¨ ××œ× ×œ×¤×¨×•×“×§×©×Ÿ (×–×”×™×¨×•×ª!)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/github_backup_restore.html#id5">×©×—×–×•×¨ ×§×‘×¦×™×/×ª×™×§×™×•×ª × ×§×•×“×ª×™×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/github_backup_restore.html#id6">×˜×™×¤×™× ×•×‘×˜×™×—×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/github_backup_restore.html#id7">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../runbooks/slo.html">Runbooks â€“ SLO Incidents</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/slo.html#higherrorrate">HighErrorRate</a></li>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/slo.html#sloavailabilitybreach-99-9">SLOAvailabilityBreach (×–××™× ×•×ª &lt; 99.9%)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/slo.html#slolatencyp95breach-p95-0-5s">SLOLatencyP95Breach (P95 &gt; 0.5s)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/slo.html#id1">×“×©×‘×•×¨×“</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ChatOps</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../chatops/overview.html">ChatOps â€“ ×¡×§×™×¨×” ×›×œ×œ×™×ª</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../chatops/overview.html#id1">×¢×§×¨×•× ×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/overview.html#id2">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../chatops/commands.html">×¤×§×•×“×•×ª ChatOps</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#status">/status</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#errors">/errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#mappings">×¡×˜×˜×•×¡×™ ×ª×•×¦××•×ª (Mappings)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#triage">/triage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#predict">/predict</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#observe-v">/observe -v (××¤×•×¨×˜)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#observe-vv">/observe -vv (××¤×•×¨×˜ ×××•×“)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#rate-limit">/rate_limit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#lang">/lang</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#lang-debug">/lang_debug</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#dm">/dm</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../chatops/observe.html">ChatOps â€“ /observe: ×”×¨×—×‘×•×ª -v ×•- -vv</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../chatops/observe.html#id1">×ª×—×‘×™×¨ ×•×¤×¨××˜×¨×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/observe.html#id2">×“×•×’×××•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/observe.html#v">×¤×œ×˜ ×œ×“×•×’××” â€“ â€-v</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/observe.html#vv">×¤×œ×˜ ×œ×“×•×’××” â€“ â€-vv</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/observe.html#id3">×”×¢×¨×•×ª ×©×™××•×©</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/observe.html#id4">×§×™×©×•×¨×™× ×¨×œ×•×•× ×˜×™×™×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../chatops/playbooks.html">Playbooks â€“ ×ª×¨×—×™×©×™× × ×¤×•×¦×™×</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../chatops/playbooks.html#p95-latency">p95 Latency ×¢×œ×” ××¢×œ ×”×¡×£</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/playbooks.html#error-rate-1">Error Rate &gt; 1%</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/playbooks.html#memory-usage">Memory Usage ××˜×¤×¡</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/playbooks.html#id1">×©×™×¨×•×ª ×—×™×¦×•× ×™ ××™×˜×™</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/playbooks.html#repeated-incident-15">Repeated Incident ×ª×—×ª 15 ×“×§Â«</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../chatops/permissions.html">×”×¨×©××•×ª ×•-Rate Limit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chatops/troubleshooting.html">×¤×ª×¨×•×Ÿ ×ª×§×œ×•×ª (FAQ)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chatops/faq.html">×©××œ×•×ª × ×¤×•×¦×•×ª</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">×¡×•×›× ×™ AI:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../ai-agents/guide.html">ğŸ¤– ××“×¨×™×š ×œ×¡×•×›× ×™ AI</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../ai-agents/guide.html#id1">× ×§×•×“×ª ×¤×ª×™×—×” ××”×™×¨×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ai-agents/guide.html#id2">××‘× ×” ×”×¤×¨×•×™×§×˜ (×‘×§×¦×¨×”)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ai-agents/guide.html#id3">×”×•×¡×¤×ª ×¤×™×¦â€™×¨×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ai-agents/guide.html#id4">×¡×§×¨×™×¤×˜×™× ×—×©×•×‘×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ai-agents/guide.html#id5">××¤×ª ×“×¨×›×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ai-agents/guide.html#github-issues-chatops">GitHub Issues ×•-ChatOps</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../agents/rate-limiting.html">ğŸš¦ ××¢×¨×›×ª Rate Limiting ×œ×¡×•×›× ×™ AI ×•×œ×•×•×‘</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#shadow-mode">××¡×˜×¨×˜×’×™×” â€“ Shadow Mode ×ª×—×™×œ×”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#id1">××©×ª× ×™ ×¡×‘×™×‘×” ×•×§×•× ×¤×™×’</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#id2">××™× ×˜×’×¨×¦×™×” â€“ ×‘×•×˜ ×˜×œ×’×¨×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#flask-webapp">××™× ×˜×’×¨×¦×™×” â€“ Flask/WebApp</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#id3">×”×—×¨×’×•×ª ×—×©×•×‘×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#prometheus">× ×™×˜×•×¨ ×•××“×“×™× (Prometheus)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#id4">××‘×˜×—×” ×•×”×’× ×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#pydantic-settings">×§×•× ×¤×™×’×•×¨×¦×™×” (Pydantic Settings)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#id5">×ª×§×œ×•×ª × ×¤×•×¦×•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../agents/rate-limiting.html#id6">×§×™×©×•×¨×™×</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Observability â€“ Advanced</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../observability/events_catalog.html">×§×˜×œ×•×’ ××™×¨×•×¢×™× ×§× ×•× ×™×™×</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../observability/events_catalog.html#github">GitHub</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/events_catalog.html#db">DB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/events_catalog.html#web-share">Web/Share</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/events_catalog.html#alerts">Alerts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/events_catalog.html#repo-analyzer">Repo Analyzer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/events_catalog.html#business">Business</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../observability/error_codes.html">××™×œ×•×Ÿ ×§×•×“×™ ×©×’×™××” (Error Codes)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../observability/error_codes.html#id1">×“×•×’×××•×ª ××™×¤×•×™</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/error_codes.html#id2">×”× ×—×™×•×ª</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../observability/tracing_hotspots.html">Tracing ×××•×§×“ ×‘× ×§×•×“×•×ª ×—××•×ª</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../observability/tracing_hotspots.html#id1">×ª×¨×©×™××™ ×–×¨×™××”</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../observability/tracing_hotspots.html#bot-update">×–×¨×™××ª bot.update</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../observability/tracing_hotspots.html#spans-bot-update">×××¤×™×™× ×™× ××•××œ×¦×™× ×œâ€‘Spans (bot.update)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../observability/tracing_hotspots.html#web-request">×–×¨×™××ª web.request</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../observability/tracing_hotspots.html#spans-web-request">×××¤×™×™× ×™× ××•××œ×¦×™× ×œâ€‘Spans (web.request)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../observability/tracing_hotspots.html#id2">×˜×‘×œ×ª â€×”×™×›×Ÿ ×¢×•×˜×¤×™×â€œ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/tracing_hotspots.html#trace-viewer">×“×•×’××ª Trace Viewer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/tracing_hotspots.html#id3">×”×˜××¢×ª ×“×§×•×¨×˜×•×¨ ×•×©×™××•×© ×‘×¤×•× ×§×¦×™×•×ª ×¢×–×¨</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/tracing_hotspots.html#best-practices">Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/tracing_hotspots.html#id4">×¨××• ×’×</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../observability/metrics_promql.html">×©××™×œ×ª×•×ª PromQL ×©×™××•×©×™×•×ª</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../observability/metrics_promql.html#latency">×–××Ÿ ×ª×’×•×‘×” (Latency)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/metrics_promql.html#id1">×©×™×¢×•×¨ ×©×’×™××•×ª</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/metrics_promql.html#id2">××™×¨×•×¢×™ ×‘×™×–× ×¡</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../observability/alerts_playbook.html">Playbook ×§×¦×¨ ×œ×”×ª×¨××•×ª</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../observability/alerts_playbook.html#id1">×–×¨×™××”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/alerts_playbook.html#id2">×§×™×©×•×¨×™× ×‘×§×•×“</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/alerts_playbook.html#id3">×“×’×©×™×</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/alerts_playbook.html#id4">×›×™×•×•× ×•×Ÿ ×¨×¢×©</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/alerts_playbook.html#id5">×˜×™×¤×™× ××”×™×¨×™×</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Code Keeper Bot</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">main</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>×”×¨××” ×§×•×“ ××§×•×¨ ×œ main</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">×‘×•×˜ ×©×•××¨ ×§×‘×¦×™ ×§×•×“ - Code Keeper Bot</span>
<span class="sd">× ×§×•×“×ª ×”×›× ×™×¡×” ×”×¨××©×™×ª ×œ×‘×•×˜</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="c1"># ×”×’×“×¨×•×ª ××ª×§×“××•×ª</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">functools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">TypedDict</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">NotRequired</span>  <span class="c1"># type: ignore[attr-defined]</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">typing_extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">NotRequired</span>  <span class="c1"># type: ignore[assignment]</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="k">class</span><span class="w"> </span><span class="nc">_NotRequiredShim</span><span class="p">:</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">__class_getitem__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">item</span>
        <span class="n">NotRequired</span> <span class="o">=</span> <span class="n">_NotRequiredShim</span>  <span class="c1"># type: ignore[misc,assignment]</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">signal</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">urlparse</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">pymongo</span>
    <span class="n">_HAS_PYMONGO</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="n">pymongo</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># fallback ×œ×œ× type: ignore</span>
    <span class="n">_HAS_PYMONGO</span> <span class="o">=</span> <span class="kc">False</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timezone</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">atexit</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">pymongo.errors</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">pymongo.errors</span><span class="w"> </span><span class="kn">import</span> <span class="n">DuplicateKeyError</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">_DummyErr</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">_DummyErrors</span><span class="p">:</span>
        <span class="n">InvalidOperation</span> <span class="o">=</span> <span class="n">_DummyErr</span>
        <span class="n">OperationFailure</span> <span class="o">=</span> <span class="n">_DummyErr</span>
    <span class="n">DuplicateKeyError</span> <span class="o">=</span> <span class="n">_DummyErr</span>
    <span class="n">pymongo</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="s2">&quot;_PM&quot;</span><span class="p">,</span> <span class="p">(),</span> <span class="p">{</span><span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="n">_DummyErrors</span><span class="p">})()</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">telegram</span><span class="w"> </span><span class="kn">import</span> <span class="n">Update</span><span class="p">,</span> <span class="n">ReplyKeyboardMarkup</span><span class="p">,</span> <span class="n">InlineKeyboardButton</span><span class="p">,</span> <span class="n">InlineKeyboardMarkup</span><span class="p">,</span> <span class="n">BotCommand</span><span class="p">,</span> <span class="n">BotCommandScopeChat</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">telegram.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">ParseMode</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">telegram.ext</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span><span class="n">Application</span><span class="p">,</span> <span class="n">CommandHandler</span><span class="p">,</span> <span class="n">ContextTypes</span><span class="p">,</span>
                          <span class="n">MessageHandler</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span> <span class="n">Defaults</span><span class="p">,</span> <span class="n">ConversationHandler</span><span class="p">,</span> <span class="n">CallbackQueryHandler</span><span class="p">,</span>
                          <span class="n">PicklePersistence</span><span class="p">,</span> <span class="n">InlineQueryHandler</span><span class="p">,</span> <span class="n">ApplicationHandlerStop</span><span class="p">,</span> <span class="n">TypeHandler</span><span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">config</span><span class="w"> </span><span class="kn">import</span> <span class="n">config</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">observability</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_observability</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="n">_observability</span> <span class="o">=</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_noop</span><span class="p">(</span><span class="o">*</span><span class="n">_a</span><span class="p">,</span> <span class="o">**</span><span class="n">_k</span><span class="p">):</span>  <span class="c1"># type: ignore[unused-argument]</span>
    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_default_generate_request_id</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">))[</span><span class="o">-</span><span class="mi">8</span><span class="p">:]</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_observability_attr</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">_observability</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">default</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">_observability</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">default</span>


<span class="n">setup_structlog_logging</span> <span class="o">=</span> <span class="n">_observability_attr</span><span class="p">(</span><span class="s2">&quot;setup_structlog_logging&quot;</span><span class="p">,</span> <span class="n">_noop</span><span class="p">)</span>
<span class="n">init_sentry</span> <span class="o">=</span> <span class="n">_observability_attr</span><span class="p">(</span><span class="s2">&quot;init_sentry&quot;</span><span class="p">,</span> <span class="n">_noop</span><span class="p">)</span>
<span class="n">bind_request_id</span> <span class="o">=</span> <span class="n">_observability_attr</span><span class="p">(</span><span class="s2">&quot;bind_request_id&quot;</span><span class="p">,</span> <span class="n">_noop</span><span class="p">)</span>
<span class="n">generate_request_id</span> <span class="o">=</span> <span class="n">_observability_attr</span><span class="p">(</span><span class="s2">&quot;generate_request_id&quot;</span><span class="p">,</span> <span class="n">_default_generate_request_id</span><span class="p">)</span>
<span class="n">emit_event</span> <span class="o">=</span> <span class="n">_observability_attr</span><span class="p">(</span><span class="s2">&quot;emit_event&quot;</span><span class="p">,</span> <span class="n">_noop</span><span class="p">)</span>
<span class="n">bind_user_context</span> <span class="o">=</span> <span class="n">_observability_attr</span><span class="p">(</span><span class="s2">&quot;bind_user_context&quot;</span><span class="p">,</span> <span class="n">_noop</span><span class="p">)</span>
<span class="n">bind_command</span> <span class="o">=</span> <span class="n">_observability_attr</span><span class="p">(</span><span class="s2">&quot;bind_command&quot;</span><span class="p">,</span> <span class="n">_noop</span><span class="p">)</span>
<span class="n">get_observability_context</span> <span class="o">=</span> <span class="n">_observability_attr</span><span class="p">(</span><span class="s2">&quot;get_observability_context&quot;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="p">{})</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">telegram_updates_total</span><span class="p">,</span>
    <span class="n">track_file_saved</span><span class="p">,</span>
    <span class="n">track_search_performed</span><span class="p">,</span>
    <span class="n">track_performance</span><span class="p">,</span>
    <span class="n">errors_total</span><span class="p">,</span>
    <span class="n">record_request_outcome</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rate_limiter</span><span class="w"> </span><span class="kn">import</span> <span class="n">RateLimiter</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># Optional advanced limits backend (limits + Redis)</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">limits</span><span class="w"> </span><span class="kn">import</span> <span class="n">RateLimitItemPerMinute</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">limits.storage</span><span class="w"> </span><span class="kn">import</span> <span class="n">RedisStorage</span><span class="p">,</span> <span class="n">MemoryStorage</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">limits.strategies</span><span class="w"> </span><span class="kn">import</span> <span class="n">MovingWindowRateLimiter</span>
    <span class="n">_LIMITS_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="n">RateLimitItemPerMinute</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore[assignment]</span>
    <span class="n">RedisStorage</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore[assignment]</span>
    <span class="n">MemoryStorage</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore[assignment]</span>
    <span class="n">MovingWindowRateLimiter</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore[assignment]</span>
    <span class="n">_LIMITS_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">database</span><span class="w"> </span><span class="kn">import</span> <span class="n">CodeSnippet</span><span class="p">,</span> <span class="n">DatabaseManager</span><span class="p">,</span> <span class="n">db</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">services</span><span class="w"> </span><span class="kn">import</span> <span class="n">code_service</span> <span class="k">as</span> <span class="n">code_processor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bot_handlers</span><span class="w"> </span><span class="kn">import</span> <span class="n">AdvancedBotHandlers</span>  <span class="c1"># still used by legacy code</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bot_handlers</span><span class="w"> </span><span class="kn">import</span> <span class="n">set_activity_reporter</span> <span class="k">as</span> <span class="n">set_bh_activity_reporter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">conversation_handlers</span><span class="w"> </span><span class="kn">import</span> <span class="n">MAIN_KEYBOARD</span><span class="p">,</span> <span class="n">get_save_conversation_handler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">conversation_handlers</span><span class="w"> </span><span class="kn">import</span> <span class="n">set_activity_reporter</span> <span class="k">as</span> <span class="n">set_ch_activity_reporter</span>
<span class="c1"># ×™×™×‘×•× ×“×—×•×™ ×©×œ ×”-activity_reporter ×‘×ª×•×š ×”-run-time ×‘×œ×‘×“ ×›×“×™ ×œ×× ×•×¢ ×™×¦×™×¨×ª ×—×™×‘×•×¨×™× ×‘×–××Ÿ import</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">github_menu_handler</span><span class="w"> </span><span class="kn">import</span> <span class="n">GitHubMenuHandler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">backup_menu_handler</span><span class="w"> </span><span class="kn">import</span> <span class="n">BackupMenuHandler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">handlers.drive.menu</span><span class="w"> </span><span class="kn">import</span> <span class="n">GoogleDriveMenuHandler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">handlers.documents</span><span class="w"> </span><span class="kn">import</span> <span class="n">DocumentHandler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">file_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">backup_manager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">large_files_handler</span><span class="w"> </span><span class="kn">import</span> <span class="n">large_files_handler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">user_stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">user_stats</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cache_commands</span><span class="w"> </span><span class="kn">import</span> <span class="n">setup_cache_handlers</span>  <span class="c1"># enabled</span>
<span class="c1"># from enhanced_commands import setup_enhanced_handlers  # disabled</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">batch_commands</span><span class="w"> </span><span class="kn">import</span> <span class="n">setup_batch_handlers</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">html</span><span class="w"> </span><span class="kn">import</span> <span class="n">escape</span> <span class="k">as</span> <span class="n">html_escape</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">aiohttp</span><span class="w"> </span><span class="kn">import</span> <span class="n">web</span>  <span class="c1"># for internal web server</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">_DummyWeb</span><span class="p">:</span>
        <span class="k">class</span><span class="w"> </span><span class="nc">Application</span><span class="p">:</span>
            <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span> <span class="k">pass</span>
        <span class="k">class</span><span class="w"> </span><span class="nc">AppRunner</span><span class="p">:</span>
            <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span> <span class="k">pass</span>
            <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">pass</span>
        <span class="k">class</span><span class="w"> </span><span class="nc">TCPSite</span><span class="p">:</span>
            <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span> <span class="k">pass</span>
            <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">pass</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">json_response</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
    <span class="n">web</span> <span class="o">=</span> <span class="n">_DummyWeb</span><span class="p">()</span>

<span class="c1"># (Lock mechanism constants removed)</span>

<span class="c1"># ×”×’×“×¨×ª ×œ×•×’×™× ×‘×¡×™×¡×™×ª + structlog + Sentry</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
    <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(name)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
    <span class="n">handlers</span><span class="o">=</span><span class="p">[</span><span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)],</span>
<span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">install_sensitive_filter</span>
    <span class="n">install_sensitive_filter</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">setup_structlog_logging</span><span class="p">(</span><span class="s2">&quot;INFO&quot;</span><span class="p">)</span>
    <span class="n">init_sentry</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="c1"># ××œ ×ª×›×©×™×œ ××ª ×”××¤×œ×™×§×¦×™×” ×× ×ª×¦×•×¨×ª observability × ×›×©×œ×”</span>
    <span class="k">pass</span>

<span class="c1"># ×¡×’×™×¨×ª ×¡×©×Ÿ aiohttp ××©×•×ª×£ ×‘×¡×™×•× ×”×ª×”×œ×™×š (best-effort)</span>
<span class="nd">@atexit</span><span class="o">.</span><span class="n">register</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_shutdown_http_shared_session</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">http_async</span><span class="w"> </span><span class="kn">import</span> <span class="n">close_session</span>  <span class="c1"># type: ignore</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">loop</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">AbstractEventLoop</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">loop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">loop</span><span class="o">.</span><span class="n">is_closed</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">running</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">loop</span><span class="o">.</span><span class="n">is_running</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">running</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">coro</span> <span class="o">=</span> <span class="n">close_session</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">coro</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">coro</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">coro</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">coro</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># type: ignore[attr-defined]</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span>
        <span class="c1"># ×× ×”×œ×•×œ××” ×¤×¢×™×œ×” ××™ ××¤×©×¨ ×œ×”××ª×™×Ÿ ×œ×” ×›××Ÿ â€“ × ×©×ª××© ×‘×œ×•×œ××” ×–×× ×™×ª</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">tmp_loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">new_event_loop</span><span class="p">()</span>
        <span class="n">original_loop</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">AbstractEventLoop</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">original_loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                <span class="n">original_loop</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">asyncio</span><span class="o">.</span><span class="n">set_event_loop</span><span class="p">(</span><span class="n">tmp_loop</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">coro</span> <span class="o">=</span> <span class="n">close_session</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">coro</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">coro</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">tmp_loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">coro</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">coro</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># type: ignore[attr-defined]</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">tmp_loop</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">original_loop</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="n">original_loop</span><span class="o">.</span><span class="n">is_closed</span><span class="p">()</span> <span class="k">if</span> <span class="n">original_loop</span> <span class="k">else</span> <span class="kc">True</span><span class="p">):</span>
                    <span class="n">asyncio</span><span class="o">.</span><span class="n">set_event_loop</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">asyncio</span><span class="o">.</span><span class="n">set_event_loop</span><span class="p">(</span><span class="n">original_loop</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="c1"># ××œ ×ª×”×¨×•×¡ ×›×™×‘×•×™</span>
        <span class="k">pass</span>

<span class="c1"># Optional: Initialize OpenTelemetry for the bot process as well (no Flask app here)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">observability_otel</span><span class="w"> </span><span class="kn">import</span> <span class="n">setup_telemetry</span> <span class="k">as</span> <span class="n">_setup_otel</span>
    <span class="n">_setup_otel</span><span class="p">(</span>
        <span class="n">service_name</span><span class="o">=</span><span class="s2">&quot;code-keeper-bot&quot;</span><span class="p">,</span>
        <span class="n">service_version</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;APP_VERSION&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
        <span class="n">environment</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;ENVIRONMENT&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;ENV&quot;</span><span class="p">,</span> <span class="s2">&quot;production&quot;</span><span class="p">)),</span>
        <span class="n">flask_app</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_command_label_from_handler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;×”×¤×§×ª ×©× ×¤×§×•×“×” ×™×“×™×“×•×ª×™ ×œ××“×“×™× ××ª×•×š CommandHandler.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">commands</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="s2">&quot;commands&quot;</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">commands</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">commands</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">commands</span> <span class="k">if</span> <span class="n">cmd</span><span class="p">)[:</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">base</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">handler</span><span class="o">.</span><span class="n">callback</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">base</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="n">base</span> <span class="ow">or</span> <span class="s2">&quot;command&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">base</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">base</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_wrap_command_callback</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">command_label</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="s2">&quot;_metrics_wrapped&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">callback</span>

    <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">iscoroutinefunction</span><span class="p">(</span><span class="n">callback</span><span class="p">):</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_wrapped</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">__orig</span><span class="o">=</span><span class="n">callback</span><span class="p">):</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
            <span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
            <span class="n">status_label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">__orig</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ApplicationHandlerStop</span><span class="p">:</span>
                <span class="n">status_code</span> <span class="o">=</span> <span class="mi">499</span>
                <span class="n">status_label</span> <span class="o">=</span> <span class="s2">&quot;cancelled&quot;</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">status_code</span> <span class="o">=</span> <span class="mi">500</span>
                <span class="n">status_label</span> <span class="o">=</span> <span class="s2">&quot;error&quot;</span>
                <span class="k">raise</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">record_request_outcome</span><span class="p">(</span>
                        <span class="n">status_code</span><span class="p">,</span>
                        <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span>
                        <span class="n">source</span><span class="o">=</span><span class="s2">&quot;telegram&quot;</span><span class="p">,</span>
                        <span class="n">command</span><span class="o">=</span><span class="n">command_label</span><span class="p">,</span>
                        <span class="n">cache_hit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">status_label</span><span class="o">=</span><span class="n">status_label</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="n">_wrapped</span><span class="o">.</span><span class="n">_metrics_wrapped</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># type: ignore[attr-defined]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_wrapped</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="s2">&quot;wrapped_command&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">_wrapped</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_wrapped_sync</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">__orig</span><span class="o">=</span><span class="n">callback</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="n">status_label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">__orig</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ApplicationHandlerStop</span><span class="p">:</span>
            <span class="n">status_code</span> <span class="o">=</span> <span class="mi">499</span>
            <span class="n">status_label</span> <span class="o">=</span> <span class="s2">&quot;cancelled&quot;</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">status_code</span> <span class="o">=</span> <span class="mi">500</span>
            <span class="n">status_label</span> <span class="o">=</span> <span class="s2">&quot;error&quot;</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">record_request_outcome</span><span class="p">(</span>
                    <span class="n">status_code</span><span class="p">,</span>
                    <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span>
                    <span class="n">source</span><span class="o">=</span><span class="s2">&quot;telegram&quot;</span><span class="p">,</span>
                    <span class="n">command</span><span class="o">=</span><span class="n">command_label</span><span class="p">,</span>
                    <span class="n">cache_hit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">status_label</span><span class="o">=</span><span class="n">status_label</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="n">_wrapped_sync</span><span class="o">.</span><span class="n">_metrics_wrapped</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># type: ignore[attr-defined]</span>
    <span class="k">return</span> <span class="n">_wrapped_sync</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_instrument_command_handlers</span><span class="p">(</span><span class="n">application</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">telegram.ext</span><span class="w"> </span><span class="kn">import</span> <span class="n">CommandHandler</span> <span class="k">as</span> <span class="n">_CommandHandler</span>  <span class="c1"># local import to avoid cycles</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">raw_handlers</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="s2">&quot;handlers&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">handlers</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw_handlers</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">raw_handlers</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">handlers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">group</span> <span class="ow">or</span> <span class="p">[]))</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">continue</span>
    <span class="k">elif</span> <span class="n">raw_handlers</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">handlers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">raw_handlers</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">handlers</span> <span class="o">=</span> <span class="p">[</span><span class="n">raw_handlers</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">handlers</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">_CommandHandler</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">callback</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">callback</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="s2">&quot;_metrics_wrapped&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">_command_label_from_handler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
        <span class="n">wrapped</span> <span class="o">=</span> <span class="n">_wrap_command_callback</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">wrapped</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_wrap_github_callback</span><span class="p">(</span><span class="n">callback</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="s2">&quot;_metrics_wrapped&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">callback</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_wrapped</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">__orig</span><span class="o">=</span><span class="n">callback</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s2">&quot;callback_query&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">action</span> <span class="o">=</span> <span class="p">(</span><span class="n">raw</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;unknown&quot;</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="n">status_label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">__orig</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ApplicationHandlerStop</span><span class="p">:</span>
            <span class="n">status_code</span> <span class="o">=</span> <span class="mi">499</span>
            <span class="n">status_label</span> <span class="o">=</span> <span class="s2">&quot;cancelled&quot;</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">status_code</span> <span class="o">=</span> <span class="mi">500</span>
            <span class="n">status_label</span> <span class="o">=</span> <span class="s2">&quot;error&quot;</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">record_request_outcome</span><span class="p">(</span>
                    <span class="n">status_code</span><span class="p">,</span>
                    <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span>
                    <span class="n">source</span><span class="o">=</span><span class="s2">&quot;telegram&quot;</span><span class="p">,</span>
                    <span class="n">handler</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;github:</span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">cache_hit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">status_label</span><span class="o">=</span><span class="n">status_label</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="n">_wrapped</span><span class="o">.</span><span class="n">_metrics_wrapped</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># type: ignore[attr-defined]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">_wrapped</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="s2">&quot;github_callback&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">_wrapped</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_wrap_handler_callback</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">handler_label</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="s2">&quot;_metrics_wrapped&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">callback</span>

    <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">iscoroutinefunction</span><span class="p">(</span><span class="n">callback</span><span class="p">):</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_wrapped</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">__orig</span><span class="o">=</span><span class="n">callback</span><span class="p">):</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
            <span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
            <span class="n">status_label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">__orig</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ApplicationHandlerStop</span><span class="p">:</span>
                <span class="n">status_code</span> <span class="o">=</span> <span class="mi">499</span>
                <span class="n">status_label</span> <span class="o">=</span> <span class="s2">&quot;cancelled&quot;</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">status_code</span> <span class="o">=</span> <span class="mi">500</span>
                <span class="n">status_label</span> <span class="o">=</span> <span class="s2">&quot;error&quot;</span>
                <span class="k">raise</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">record_request_outcome</span><span class="p">(</span>
                        <span class="n">status_code</span><span class="p">,</span>
                        <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span>
                        <span class="n">source</span><span class="o">=</span><span class="s2">&quot;telegram&quot;</span><span class="p">,</span>
                        <span class="n">handler</span><span class="o">=</span><span class="n">handler_label</span><span class="p">,</span>
                        <span class="n">cache_hit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">status_label</span><span class="o">=</span><span class="n">status_label</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="n">_wrapped</span><span class="o">.</span><span class="n">_metrics_wrapped</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># type: ignore[attr-defined]</span>
        <span class="k">return</span> <span class="n">_wrapped</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_wrapped_sync</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">__orig</span><span class="o">=</span><span class="n">callback</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="n">status_label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">__orig</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ApplicationHandlerStop</span><span class="p">:</span>
            <span class="n">status_code</span> <span class="o">=</span> <span class="mi">499</span>
            <span class="n">status_label</span> <span class="o">=</span> <span class="s2">&quot;cancelled&quot;</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">status_code</span> <span class="o">=</span> <span class="mi">500</span>
            <span class="n">status_label</span> <span class="o">=</span> <span class="s2">&quot;error&quot;</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">record_request_outcome</span><span class="p">(</span>
                    <span class="n">status_code</span><span class="p">,</span>
                    <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span>
                    <span class="n">source</span><span class="o">=</span><span class="s2">&quot;telegram&quot;</span><span class="p">,</span>
                    <span class="n">handler</span><span class="o">=</span><span class="n">handler_label</span><span class="p">,</span>
                    <span class="n">cache_hit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">status_label</span><span class="o">=</span><span class="n">status_label</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="n">_wrapped_sync</span><span class="o">.</span><span class="n">_metrics_wrapped</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># type:ignore[attr-defined]</span>
    <span class="k">return</span> <span class="n">_wrapped_sync</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_cancel_command_fallback</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handler ××¡×™× ×›×¨×•× ×™ ××—×™×“ ×œ×¡×™×•× ×©×™×—×” ×›××©×¨ ×”××©×ª××© ××¤×¢×™×œ /cancel.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_redis_socket_available</span><span class="p">(</span><span class="n">redis_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ×‘×“×™×§×ª reachability ×‘×¡×™×¡×™×ª ×œ-Redis ×›×“×™ ×œ×”×™×× ×¢ ××”××ª× ×” ××¨×•×›×” ×‘×–××Ÿ ×˜×¡×˜×™×/CI.</span>

<span class="sd">    ×× ×œ× × ×™×ª×Ÿ ×œ×”×’×™×¢ ×œ-Redis ×‘××”×™×¨×•×ª, × ×—×–×•×¨ False ×•× ×©×ª××© ×‘×¤×•×œ×‘×§.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">redis_url</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">redis_url</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">scheme</span> <span class="o">=</span> <span class="p">(</span><span class="n">parsed</span><span class="o">.</span><span class="n">scheme</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">default_ports</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;redis&quot;</span><span class="p">:</span> <span class="mi">6379</span><span class="p">,</span>
        <span class="s2">&quot;rediss&quot;</span><span class="p">:</span> <span class="mi">6379</span><span class="p">,</span>
        <span class="s2">&quot;redis+sentinel&quot;</span><span class="p">:</span> <span class="mi">26379</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">default_port</span> <span class="o">=</span> <span class="n">default_ports</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">scheme</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">default_port</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">host</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">hostname</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">port</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">port</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">host</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">netloc</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">netloc</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">netloc</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s2">&quot;@&quot;</span> <span class="ow">in</span> <span class="n">netloc</span><span class="p">:</span>
            <span class="n">netloc</span> <span class="o">=</span> <span class="n">netloc</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">first_endpoint</span> <span class="o">=</span> <span class="n">netloc</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">first_endpoint</span> <span class="o">=</span> <span class="n">first_endpoint</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">first_endpoint</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">first_endpoint</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;]&quot;</span> <span class="ow">in</span> <span class="n">first_endpoint</span><span class="p">:</span>
            <span class="n">end_idx</span> <span class="o">=</span> <span class="n">first_endpoint</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">)</span>
            <span class="n">host</span> <span class="o">=</span> <span class="n">first_endpoint</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span>
            <span class="n">remainder</span> <span class="o">=</span> <span class="n">first_endpoint</span><span class="p">[</span><span class="n">end_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
            <span class="k">if</span> <span class="n">remainder</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">remainder</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">port</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">first_endpoint</span><span class="p">:</span>
                <span class="n">host_part</span><span class="p">,</span> <span class="n">port_part</span> <span class="o">=</span> <span class="n">first_endpoint</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">host</span> <span class="o">=</span> <span class="n">host_part</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">port_part</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">port</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">host</span> <span class="o">=</span> <span class="n">first_endpoint</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">host</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">port</span> <span class="o">=</span> <span class="n">port</span> <span class="ow">or</span> <span class="n">default_port</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">port</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">create_connection</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">port</span><span class="p">)),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="kc">True</span>

<span class="c1"># ×”×‘×˜×—×ª ×œ×•×œ××ª asyncio ×›×‘×¨×™×¨×ª ××—×“×œ (×ª××™×›×” ×‘-Python 3.11 ×‘×¡×‘×™×‘×ª ×˜×¡×˜×™×)</span>
<span class="c1"># ××ª×§×™×Ÿ Policy ×—×¡×™×Ÿ ×©××™×™×¦×¨ ×œ×•×œ××” ×—×“×©×” ×× ××™×Ÿ ××—×ª ×–××™× ×”, ×’× ×× asyncio.run() × ×™×§×” ××ª ×”×œ×•×œ××”.</span>
<span class="k">try</span><span class="p">:</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">_ResilientEventLoopPolicy</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">DefaultEventLoopPolicy</span><span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">get_event_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># type: ignore[override]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                <span class="n">loop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_event_loop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_event_loop</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">loop</span>

    <span class="c1"># ×”×ª×§× ×” ×—×“-×¤×¢××™×ª ×©×œ ×”-Policy. ×× ×›×‘×¨ ×”×•×ª×§×Ÿ Policy ×—×™×¦×•× ×™ (×›×’×•×Ÿ uvloop) ×œ× × × ×¡×” ×œ×”×—×œ×™×£ ×‘×›×•×—.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">current_policy</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop_policy</span><span class="p">()</span>
        <span class="c1"># × ×ª×§×™×Ÿ ×¨×§ ×× ×–×• ×”-DefaultPolicy ×›×“×™ ×œ× ×œ×©×‘×•×¨ ×§×•× ×¤×™×’ ×§×™×™×</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">current_policy</span><span class="p">,</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">DefaultEventLoopPolicy</span><span class="p">):</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">set_event_loop_policy</span><span class="p">(</span><span class="n">_ResilientEventLoopPolicy</span><span class="p">())</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="c1"># ×‘××™×“×” ×•×”×§×¨×™××” get_event_loop_policy ×¢×¦××” × ×›×©×œ×ª, × × ×¡×” ×œ×”×ª×§×™×Ÿ ×™×©×™×¨×•×ª</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">set_event_loop_policy</span><span class="p">(</span><span class="n">_ResilientEventLoopPolicy</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="c1"># fail-safe: × ×¡×” ×œ×•×•×“× ×©×™×© ×œ×•×œ××” × ×•×›×—×™×ª ×’× ×›×¢×ª</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">new_event_loop</span><span class="p">()</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">set_event_loop</span><span class="p">(</span><span class="n">_loop</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># Fail-open: ××™×Ÿ ×œ×”×¤×™×œ ×‘×–××Ÿ import</span>
            <span class="k">pass</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="c1"># ×œ× × ×›×©×™×œ ××ª ×”-import ×× ×™×© ×‘×¢×™×” ×‘××“×™× ×™×•×ª ×”×œ×•×œ××”</span>
    <span class="k">pass</span>

<span class="c1"># ×¨×©×™××ª ×§×™×“×•×“×™× ×œ× ×™×¡×™×•×Ÿ ×§×¨×™××ª ×§×‘×¦×™× (× ×™×ª× ×ª ×œ×“×¨×™×¡×” ×‘×˜×¡×˜×™×)</span>
<span class="n">ENCODINGS_TO_TRY</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;utf-8&#39;</span><span class="p">,</span>
    <span class="s1">&#39;windows-1255&#39;</span><span class="p">,</span>
    <span class="s1">&#39;iso-8859-8&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cp1255&#39;</span><span class="p">,</span>
    <span class="s1">&#39;utf-16&#39;</span><span class="p">,</span>
    <span class="s1">&#39;latin-1&#39;</span><span class="p">,</span>
<span class="p">]</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_register_catch_all_callback</span><span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="n">callback_fn</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;×¨×™×©×•× CallbackQueryHandler ×›×œ×œ×™ ×‘×§×‘×•×¦×” ×××•×—×¨×ª, ×¢× fallback ×›×©×”-API ×œ× ×ª×•××š ×‘-group.</span>

<span class="sd">    × ×•×¢×“ ×œ×”×™×× ×¢ ××›×©×œ×™ ×˜×¡×˜×™×/×¡×˜××‘×™× (TypeError ×¢×œ group), ×•×‘×• ×‘×–××Ÿ ×œ×©××¨ ×§×“×™××•×™×•×ª ×‘×¤×¨×•×“×§×©×Ÿ.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">handler</span> <span class="o">=</span> <span class="n">CallbackQueryHandler</span><span class="p">(</span><span class="n">callback_fn</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="c1"># ×¡×‘×™×‘×ª ×˜×¡×˜/×¡×˜××‘ ×œ×œ× ×ª××™×›×” ×‘×¤×¨××˜×¨ group</span>
        <span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># ×“×•×•×— ×—×¨×™×’×” ×›×“×™ ×©×œ× × ×‘×œ×¢ ×©×’×™××•×ª ×¨×™×©×•× ×©×§×˜×•×ª</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to register catch-all CallbackQueryHandler: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># ×”×•×“×¢×ª ×”×ª×—×œ×” ××¨×©×™××”</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;ğŸš€ ××¤×¢×™×œ ×‘×•×˜ ×§×•×“ ××ª×§×“× - ×’×¨×¡×” ×¤×¨×•!&quot;</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">emit_event</span><span class="p">(</span><span class="s2">&quot;bot_start&quot;</span><span class="p">,</span> <span class="n">msg_he</span><span class="o">=</span><span class="s2">&quot;××¤×¢×™×œ ××ª ×”×‘×•×˜&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="c1"># ×”×¤×—×ª×ª ×¨×¢×© ×‘×œ×•×’×™×</span>
<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;httpx&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>  <span class="c1"># ×¨×§ ×©×’×™××•×ª ×§×¨×™×˜×™×•×ª</span>
<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;telegram.ext.Updater&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;telegram.ext.Application&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>

<span class="c1"># Reporter ×™×•×•×¦×¨ ×•×™×•×–×¨×§ ×‘×–××Ÿ ×¨×™×¦×” ×œ××—×¨ ×‘× ×™×™×ª ×”××¤×œ×™×§×¦×™×” ×•×”×§×•× ×¤×™×’</span>
<span class="n">reporter</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># ===== ×¢×–×¨: ×©×œ×™×—×ª ×”×•×“×¢×ª ××“××™×Ÿ =====</span>
<div class="viewcode-block" id="get_admin_ids">
<a class="viewcode-back" href="../api/main.html#main.get_admin_ids">[×ª×™×¢×•×“]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_admin_ids</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;ADMIN_USER_IDS&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">raw</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">raw</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()]</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="notify_admins">
<a class="viewcode-back" href="../api/main.html#main.notify_admins">[×ª×™×¢×•×“]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">notify_admins</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">admin_ids</span> <span class="o">=</span> <span class="n">get_admin_ids</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">admin_ids</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">admin_id</span> <span class="ow">in</span> <span class="n">admin_ids</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">context</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">chat_id</span><span class="o">=</span><span class="n">admin_id</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span></div>


<span class="c1"># ===== Admin: /recycle_backfill =====</span>
<div class="viewcode-block" id="recycle_backfill_command">
<a class="viewcode-back" href="../api/main.html#main.recycle_backfill_command">[×ª×™×¢×•×“]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">recycle_backfill_command</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;×××œ× deleted_at ×•-deleted_expires_at ×œ×¨×©×•××•×ª ××—×•×§×•×ª ×¨×›×•×ª ×•×—×•×©×‘ TTL.</span>

<span class="sd">    ×©×™××•×©: /recycle_backfill [X]</span>
<span class="sd">    X = ×™××™× ×œ×ª×•×§×£ ×¡×œ (×‘×¨×™×¨×ª ××—×“×œ ××”×§×•× ×¤×™×’ RECYCLE_TTL_DAYS)</span>
<span class="sd">    ×”×¤×§×•×“×” ×–××™× ×” ×œ×× ×”×œ×™× ×‘×œ×‘×“.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span> <span class="k">if</span> <span class="n">update</span> <span class="ow">and</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">admin_ids</span> <span class="o">=</span> <span class="n">get_admin_ids</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">admin_ids</span> <span class="ow">or</span> <span class="n">user_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">admin_ids</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×¤×§×•×“×” ×–××™× ×” ×œ×× ×”×œ×™× ×‘×œ×‘×“&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">return</span>

        <span class="c1"># ×§×‘×™×¢×ª TTL ×‘×™××™×</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ttl_days</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;RECYCLE_TTL_DAYS&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">7</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">ttl_days</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;RECYCLE_TTL_DAYS&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">7</span><span class="p">)</span>
        <span class="n">ttl_days</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ttl_days</span><span class="p">)</span>

        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
        <span class="n">expires</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">ttl_days</span><span class="p">)</span>

        <span class="c1"># ×•×“× ××™× ×“×§×¡×™ TTL ×•××—&quot;×› Backfill ×‘×©×ª×™ ×”×§×•×œ×§×¦×™×•×ª</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">database</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span> <span class="k">as</span> <span class="n">_db</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">coll_name</span><span class="p">,</span> <span class="n">friendly</span> <span class="ow">in</span> <span class="p">((</span><span class="s2">&quot;collection&quot;</span><span class="p">,</span> <span class="s2">&quot;×§×‘×¦×™× ×¨×’×™×œ×™×&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;large_files_collection&quot;</span><span class="p">,</span> <span class="s2">&quot;×§×‘×¦×™× ×’×“×•×œ×™×&quot;</span><span class="p">)):</span>
            <span class="n">coll</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">coll_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="c1"># ×—×©×•×‘: ××œ ×ª×©×ª××©×• ×‘-truthiness ×¢×œ ×§×•×œ×§×¦×™×” ×©×œ PyMongo</span>
            <span class="k">if</span> <span class="n">coll</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">friendly</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;collection-missing&quot;</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="c1"># ensure TTL index idempotently</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">coll</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span><span class="s2">&quot;deleted_expires_at&quot;</span><span class="p">,</span> <span class="n">expireAfterSeconds</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;deleted_ttl&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># ×œ× ×§×¨×™×˜×™; × ××©×™×š</span>
                <span class="k">pass</span>

            <span class="n">modified_deleted_at</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">modified_deleted_exp</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># backfill deleted_at where missing</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">coll</span><span class="p">,</span> <span class="s1">&#39;update_many&#39;</span><span class="p">):</span>
                    <span class="n">r1</span> <span class="o">=</span> <span class="n">coll</span><span class="o">.</span><span class="n">update_many</span><span class="p">({</span><span class="s2">&quot;is_active&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;deleted_at&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$exists&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}},</span> <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;deleted_at&quot;</span><span class="p">:</span> <span class="n">now</span><span class="p">}})</span>
                    <span class="n">modified_deleted_at</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="s1">&#39;modified_count&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="c1"># backfill deleted_expires_at where missing</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">coll</span><span class="p">,</span> <span class="s1">&#39;update_many&#39;</span><span class="p">):</span>
                    <span class="n">r2</span> <span class="o">=</span> <span class="n">coll</span><span class="o">.</span><span class="n">update_many</span><span class="p">({</span><span class="s2">&quot;is_active&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;deleted_expires_at&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$exists&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}},</span> <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;deleted_expires_at&quot;</span><span class="p">:</span> <span class="n">expires</span><span class="p">}})</span>
                    <span class="n">modified_deleted_exp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="s1">&#39;modified_count&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">friendly</span><span class="p">,</span> <span class="n">modified_deleted_at</span><span class="p">,</span> <span class="n">modified_deleted_exp</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>

        <span class="c1"># ×“×•&quot;×—</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;ğŸ§¹ Backfill ×¡×œ ××™×—×–×•×¨ (TTL=</span><span class="si">{</span><span class="n">ttl_days</span><span class="si">}</span><span class="s2"> ×™××™×)&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">friendly</span><span class="p">,</span> <span class="n">c_at</span><span class="p">,</span> <span class="n">c_exp</span><span class="p">,</span> <span class="n">err</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;â€¢ </span><span class="si">{</span><span class="n">friendly</span><span class="si">}</span><span class="s2">: ×“×™×œ×•×’ (</span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;â€¢ </span><span class="si">{</span><span class="n">friendly</span><span class="si">}</span><span class="s2">: deleted_at=</span><span class="si">{</span><span class="n">c_at</span><span class="si">}</span><span class="s2">, deleted_expires_at=</span><span class="si">{</span><span class="n">c_exp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘-backfill: </span><span class="si">{</span><span class="n">html_escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span></div>


<div class="viewcode-block" id="log_user_activity">
<a class="viewcode-back" href="../api/main.html#main.log_user_activity">[×ª×™×¢×•×“]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">log_user_activity</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ×¨×™×©×•× ×¤×¢×™×œ×•×ª ××©×ª××© ×‘××¢×¨×›×ª.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        update: ××•×‘×™×™×§×˜ Update ××˜×œ×’×¨×</span>
<span class="sd">        context: ×”×§×•× ×˜×§×¡×˜ ×©×œ ×”×©×™×—×”</span>
<span class="sd">    </span>
<span class="sd">    Note:</span>
<span class="sd">        ×¤×•× ×§×¦×™×” ×–×• × ×§×¨××ª ××•×˜×•××˜×™×ª ×¢×‘×•×¨ ×›×œ ×¤×¢×•×œ×” ×©×œ ××©×ª××©</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># ×“×’×™××” ×œ×”×¤×—×ª×ª ×¢×•××¡: ×¨×§ ~25% ××”××™×¨×•×¢×™× ×™×¢×“×›× ×• ××™×™×“×™×ª ××ª ×”-DB</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">random</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_rnd</span>
        <span class="n">sampled</span> <span class="o">=</span> <span class="p">(</span><span class="n">_rnd</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.25</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">sampled</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># ×¨×™×©×•× ×‘×¡×™×¡×™ ×œ×’××¨×™ ××—×•×¥ ×œ-try ×›×“×™ ×œ× ×œ×—×¡×•× ××ª ×”×¤×œ×•××•</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># ×›×“×™ ×œ×©××¨ ×¡×¤×™ milestones, ×× ×“×•×’××™× â€” × ×›×¤×™×œ ××ª ×”××©×§×œ ×‘×”×ª×× ×œ×”×¡×ª×‘×¨×•×ª ×”×“×’×™××”</span>
        <span class="k">if</span> <span class="n">sampled</span><span class="p">:</span>
            <span class="c1"># p=0.25 -&gt; weight=4; ×× ××©×ª× ×” â€” × ×©××‘ ××”×§×•× ×¤×™×’ ×‘×¢×ª×™×“</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user_stats</span><span class="o">.</span><span class="n">log_user</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">weight</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="c1"># ×ª××™××•×ª ×œ××—×•×¨ ×œ×˜×¡×˜×™×/×¡×‘×™×‘×” ×™×©× ×” ×œ×œ× ×¤×¨××˜×¨ weight</span>
                <span class="n">user_stats</span><span class="o">.</span><span class="n">log_user</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="c1"># milestones â€” ×œ×”×¨×¦×” ××¡×™× ×›×¨×•× ×™×ª ×›×š ×©×œ× ×ª×—×¡×•× ××ª ×”×”×•×“×¢×” ×œ××©×ª××©</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_milestones_job</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># ×˜×¢×™× ×” ×“×™× ××™×ª ×©×œ ××•×“×•×œ ×”-DB ×›×“×™ ×œ×¢×‘×•×“ ×”×™×˜×‘ ×¢× monkeypatch ×‘×˜×¡×˜×™×</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">database</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span> <span class="k">as</span> <span class="n">_db</span>
            <span class="n">users_collection</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">users</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="s1">&#39;db&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">users_collection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="n">users_collection</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;total_actions&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;milestones_sent&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="n">total_actions</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;total_actions&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">already_sent</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;milestones_sent&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[])</span>
            <span class="n">milestones</span> <span class="o">=</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">1000</span><span class="p">]</span>
            <span class="n">pending</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">milestones</span> <span class="k">if</span> <span class="n">m</span> <span class="o">&lt;=</span> <span class="n">total_actions</span> <span class="ow">and</span> <span class="n">m</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">already_sent</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pending</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">milestone</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">pending</span><span class="p">)</span>
            <span class="c1"># ×”×ª×¨××ª ××“××™×Ÿ ××•×§×“××ª (×œ×¦×•×¨×š × ×™×˜×•×¨), ×‘× ×•×¡×£ ×œ×”×ª×¨××” ××—×¨×™ ×¢×“×›×•×Ÿ DB</span>
            <span class="k">if</span> <span class="n">milestone</span> <span class="o">&gt;=</span> <span class="mi">500</span><span class="p">:</span>
                <span class="n">uname</span> <span class="o">=</span> <span class="p">(</span><span class="n">username</span> <span class="ow">or</span> <span class="sa">f</span><span class="s2">&quot;User_</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">display</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;@</span><span class="si">{</span><span class="n">uname</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">uname</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">str</span><span class="p">(</span><span class="n">uname</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">uname</span><span class="p">)</span>
                <span class="c1"># ×§×¨×™××” ×™×©×™×¨×” ×œ×œ× ×¢×˜×™×¤×ª try ×›×“×™ ×©×œ× × ×‘×œ×¢ ×‘×©×•×’×’; ×”-wrapper ×”×—×™×¦×•× ×™ ×™×ª×¤×•×¡ ×—×¨×™×’×•×ª</span>
                <span class="k">await</span> <span class="n">notify_admins</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;ğŸ“¢ ××©×ª××© </span><span class="si">{</span><span class="n">display</span><span class="si">}</span><span class="s2"> ×”×’×™×¢ ×œÖ¾</span><span class="si">{</span><span class="n">milestone</span><span class="si">}</span><span class="s2"> ×¤×¢×•×œ×•×ª ×‘×‘×•×˜&quot;</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">users_collection</span><span class="o">.</span><span class="n">update_one</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span> <span class="s2">&quot;milestones_sent&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$ne&quot;</span><span class="p">:</span> <span class="n">milestone</span><span class="p">}},</span>
                <span class="p">{</span><span class="s2">&quot;$addToSet&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;milestones_sent&quot;</span><span class="p">:</span> <span class="n">milestone</span><span class="p">},</span> <span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;updated_at&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)}}</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="s1">&#39;modified_count&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">messages</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="mi">50</span><span class="p">:</span> <span class="p">(</span>
                        <span class="s2">&quot;×•×•××•! ××ª×” ×‘×™×Ÿ ×”××©×ª××©×™× ×”××•×‘×™×œ×™× ×‘×‘×•×˜ ğŸ”¥</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="s2">&quot;×”× ×•×›×—×•×ª ×©×œ×š ×¢×•×©×” ×œ× ×• ×©××— ğŸ˜Š</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="s2">&quot;×™×© ×œ×š ×¨×¢×™×•× ×•×ª ××• ×“×‘×¨×™× ×©×”×™×™×ª ×¨×•×¦×” ×œ×¨××•×ª ×›××Ÿ?</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="s2">&quot;××•×–××Ÿ ×œ×›×ª×•×‘ ×œÖ¾@moominAmir&quot;</span>
                    <span class="p">),</span>
                    <span class="mi">100</span><span class="p">:</span> <span class="p">(</span>
                        <span class="s2">&quot;ğŸ’¯ ×¤×¢×•×œ×•×ª!</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="s2">&quot;×›× ×¨××” ×©××ª×” ×›×‘×¨ ×™×•×“×¢ ××ª ×”×‘×•×˜ ×™×•×ª×¨ ×˜×•×‘ ××× ×™ ğŸ˜‚</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="s2">&quot;×™××œ×œ×”, ××•×œ×™ × ×¢×©×” ×œ×š ×ª×¢×•×“×ª ××©×ª××© ×•×ª×™×§? ğŸ†&quot;</span>
                    <span class="p">),</span>
                    <span class="mi">200</span><span class="p">:</span> <span class="p">(</span>
                        <span class="s2">&quot;×•×•××•! 200 ×¤×¢×•×œ×•×ª! ğŸš€</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="s2">&quot;××ª×” ×œ×’××¨×™ ×‘×™×Ÿ ×”××©×ª××©×™× ×”×›×™ ×¤×¢×™×œ×™×.</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="s2">&quot;×™×© ×¤×™×¦&#39;×¨ ×©×”×™×™×ª ×¨×•×¦×” ×œ×¨××•×ª ×‘×”××©×š?</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="s2">&quot;×¡×¤×¨ ×œ× ×• ×‘Ö¾@moominAmir&quot;</span>
                    <span class="p">),</span>
                    <span class="mi">500</span><span class="p">:</span> <span class="p">(</span>
                        <span class="s2">&quot;500 ×¤×¢×•×œ×•×ª! ğŸ”¥</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="s2">&quot;××’×™×¢ ×œ×š ×ª×•×“×” ×¢× ×§×™×ª ×¢×œ ×”×ª××™×›×”! ğŸ©µ&quot;</span>
                    <span class="p">),</span>
                    <span class="mi">1000</span><span class="p">:</span> <span class="p">(</span>
                        <span class="s2">&quot;×”×’×¢×ª ×œÖ¾1000 ×¤×¢×•×œ×•×ª! ğŸ‰</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="s2">&quot;××ª×” ××’×“×” ×—×™×” ×©×œ ×”×‘×•×˜ ×”×–×” ğŸ™Œ</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="s2">&quot;×ª×•×“×” ×©××ª×” ××™×ª× ×• ×œ××•×¨×š ×”×“×¨×š ğŸ’™</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="s2">&quot;×”×¦×¢×•×ª ×œ×©×™×¤×•×¨ ×™×ª×§×‘×œ×• ×‘×‘×¨×›×” â£ï¸</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="s2">&quot;@moominAmir&quot;</span>
                    <span class="p">),</span>
                <span class="p">}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">context</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">chat_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">messages</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">milestone</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="c1"># ×”×ª×¨××” ×œ××“××™×Ÿ ×œ××™×œ×¡×˜×•× ×™× ××©××¢×•×ª×™×™× (500+) â€” ×’× ×× ×›×‘×¨ ×¡×•××Ÿ, ×œ× ××¡×•×›×Ÿ ×œ×©×œ×•×— ×¤×¢× × ×•×¡×¤×ª</span>
            <span class="k">if</span> <span class="n">milestone</span> <span class="o">&gt;=</span> <span class="mi">500</span><span class="p">:</span>
                <span class="n">uname</span> <span class="o">=</span> <span class="p">(</span><span class="n">username</span> <span class="ow">or</span> <span class="sa">f</span><span class="s2">&quot;User_</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">display</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;@</span><span class="si">{</span><span class="n">uname</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">uname</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">str</span><span class="p">(</span><span class="n">uname</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">uname</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">notify_admins</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;ğŸ“¢ ××©×ª××© </span><span class="si">{</span><span class="n">display</span><span class="si">}</span><span class="s2"> ×”×’×™×¢ ×œÖ¾</span><span class="si">{</span><span class="n">milestone</span><span class="si">}</span><span class="s2"> ×¤×¢×•×œ×•×ª ×‘×‘×•×˜&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">jq</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;job_queue&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">application</span><span class="p">,</span> <span class="s2">&quot;job_queue&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">jq</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># ×”×¨×¦×” ××™×™×“×™×ª ×‘×¨×§×¢ ×œ×œ× ×—×¡×™××”</span>
            <span class="n">jq</span><span class="o">.</span><span class="n">run_once</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_ctx</span><span class="p">:</span> <span class="n">context</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">_milestones_job</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">username</span><span class="p">)),</span> <span class="n">when</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># fallback: ×™×¦×™×¨×ª ××©×™××” ××¡×™× ×›×¨×•× ×™×ª ×™×©×™×¨×•×ª</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_aio</span>
            <span class="n">_aio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">_milestones_job</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">username</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># MONGODB LOCK MANAGEMENT (FINAL, NO-GUESSING VERSION)</span>
<span class="c1"># =============================================================================</span>

<span class="n">LOCK_ID</span> <span class="o">=</span> <span class="s2">&quot;code_keeper_bot_lock&quot;</span>
<span class="n">LOCK_COLLECTION</span> <span class="o">=</span> <span class="s2">&quot;locks&quot;</span>
<span class="n">LOCK_TIMEOUT_MINUTES</span> <span class="o">=</span> <span class="mi">5</span>

<div class="viewcode-block" id="get_lock_collection">
<a class="viewcode-back" href="../api/main.html#main.get_lock_collection">[×ª×™×¢×•×“]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_lock_collection</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ××—×–×™×¨ ××ª ×§×•×œ×§×¦×™×™×ª ×”× ×¢×™×œ×•×ª ×××¡×“ ×”× ×ª×•× ×™×.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        pymongo.collection.Collection: ×§×•×œ×§×¦×™×™×ª ×”× ×¢×™×œ×•×ª</span>
<span class="sd">    </span>
<span class="sd">    Raises:</span>
<span class="sd">        SystemExit: ×× ××¡×“ ×”× ×ª×•× ×™× ×œ× ××•×ª×—×œ ×›×¨××•×™</span>
<span class="sd">    </span>
<span class="sd">    Note:</span>
<span class="sd">        ××©×ª××© ×‘××¡×“ ×”× ×ª×•× ×™× ×©×›×‘×¨ × ×‘×—×¨ ×‘-DatabaseManager</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Use the already-selected database from DatabaseManager</span>
        <span class="n">selected_db</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">db</span>
        <span class="k">if</span> <span class="n">selected_db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;DatabaseManager.db is not initialized!&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">emit_event</span><span class="p">(</span><span class="s2">&quot;db_lock_db_missing&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;critical&quot;</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="s2">&quot;db_lock_db_missing&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Optional: small debug to help diagnose DB mismatches</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using DB for locks: </span><span class="si">{</span><span class="n">selected_db</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">selected_db</span><span class="p">[</span><span class="n">LOCK_COLLECTION</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to get lock collection from DatabaseManager: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">emit_event</span><span class="p">(</span><span class="s2">&quot;db_lock_get_failed&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;critical&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>


<span class="c1"># New: ensure TTL index on expires_at so stale locks get auto-removed</span>

<div class="viewcode-block" id="ensure_lock_indexes">
<a class="viewcode-back" href="../api/main.html#main.ensure_lock_indexes">[×ª×™×¢×•×“]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">ensure_lock_indexes</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ×™×•×¦×¨ ××™× ×“×§×¡ TTL ×¢×œ ×©×“×” expires_at ×œ× ×™×§×•×™ ××•×˜×•××˜×™ ×©×œ × ×¢×™×œ×•×ª ×™×©× ×•×ª.</span>
<span class="sd">    </span>
<span class="sd">    Note:</span>
<span class="sd">        ×× ×™×¦×™×¨×ª ×”××™× ×“×§×¡ × ×›×©×œ×ª, ×”××¢×¨×›×ª ×ª××©×™×š ×œ×¢×‘×•×“ ×œ×œ× TTL ××•×˜×•××˜×™</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">lock_collection</span> <span class="o">=</span> <span class="n">get_lock_collection</span><span class="p">()</span>
        <span class="c1"># TTL based on the absolute expiration time in the document</span>
        <span class="n">lock_collection</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span><span class="s2">&quot;expires_at&quot;</span><span class="p">,</span> <span class="n">expireAfterSeconds</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;lock_expires_ttl&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Non-fatal; continue without TTL if index creation fails</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not ensure TTL index for lock collection: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">emit_event</span><span class="p">(</span><span class="s2">&quot;lock_ttl_index_failed&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;warn&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span></div>


<div class="viewcode-block" id="cleanup_mongo_lock">
<a class="viewcode-back" href="../api/main.html#main.cleanup_mongo_lock">[×ª×™×¢×•×“]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">cleanup_mongo_lock</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ×× ×§×” ××ª × ×¢×™×œ×ª MongoDB ×‘×¢×ª ×™×¦×™××” ××”×ª×•×›× ×™×ª.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        bool: True ×× ×”× ×™×§×•×™ ×‘×•×¦×¢ ×œ×œ× ×©×’×™××” ×œ×•×’×™×ª/×—×™×‘×•×¨, False ×× ×›×©×œ (×œ××©×œ client ×¡×’×•×¨)</span>
<span class="sd">    </span>
<span class="sd">    Note:</span>
<span class="sd">        ×¤×•× ×§×¦×™×” ×–×• × ×¨×©××ª ×¢× atexit ×•×¨×¦×” ××•×˜×•××˜×™×ª ×‘×¡×™×•× ×”×ª×•×›× ×™×ª</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># If DB client is not available, skip quietly (× ×—×©×‘ ×›×”×¦×œ×—×” â€” ××™×Ÿ ××” ×œ× ×§×•×ª)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;db&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s2">&quot;client&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Mongo client not available during lock cleanup; skipping.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">lock_collection</span> <span class="o">=</span> <span class="n">get_lock_collection</span><span class="p">()</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">lock_collection</span><span class="o">.</span><span class="n">delete_one</span><span class="p">({</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">LOCK_ID</span><span class="p">,</span> <span class="s2">&quot;pid&quot;</span><span class="p">:</span> <span class="n">pid</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">deleted_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Lock &#39;</span><span class="si">{</span><span class="n">LOCK_ID</span><span class="si">}</span><span class="s2">&#39; released successfully by PID: </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">emit_event</span><span class="p">(</span><span class="s2">&quot;lock_released&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="o">=</span><span class="n">pid</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="c1"># ×’× ×× ×œ× × ××—×§ â€” ×”× ×™×§×•×™ idempotent; × ×—×©×‘ ×›×”×¦×œ×—×”</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="n">pymongo</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidOperation</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Mongo client already closed; skipping lock cleanup.&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">emit_event</span><span class="p">(</span><span class="s2">&quot;lock_cleanup_skipped_client_closed&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;warn&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error while releasing MongoDB lock: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">emit_event</span><span class="p">(</span><span class="s2">&quot;lock_release_error&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="manage_mongo_lock">
<a class="viewcode-back" href="../api/main.html#main.manage_mongo_lock">[×ª×™×¢×•×“]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">manage_mongo_lock</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ×¨×•×›×© × ×¢×™×œ×” ××‘×•×–×¨×ª ×‘-MongoDB ×›×“×™ ×œ×”×‘×˜×™×— ×©×¨×§ ××•×¤×¢ ××—×“ ×©×œ ×”×‘×•×˜ ×¨×¥.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        bool: True ×× ×”× ×¢×™×œ×” × ×¨×›×©×” ×‘×”×¦×œ×—×”, False ××—×¨×ª</span>
<span class="sd">    </span>
<span class="sd">    Note:</span>
<span class="sd">        ×ª×•××š ×‘×”××ª× ×” ×œ×©×—×¨×•×¨ × ×¢×™×œ×” ×§×™×™××ª ×¢×‘×•×¨ blue/green deployments</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ensure_lock_indexes</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;could not ensure lock indexes; continuing&quot;</span><span class="p">)</span>
        <span class="n">lock_collection</span> <span class="o">=</span> <span class="n">get_lock_collection</span><span class="p">()</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
        <span class="n">expires_at</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">LOCK_TIMEOUT_MINUTES</span><span class="p">)</span>

        <span class="c1"># Try to create the lock document</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lock_collection</span><span class="o">.</span><span class="n">insert_one</span><span class="p">({</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">LOCK_ID</span><span class="p">,</span> <span class="s2">&quot;pid&quot;</span><span class="p">:</span> <span class="n">pid</span><span class="p">,</span> <span class="s2">&quot;expires_at&quot;</span><span class="p">:</span> <span class="n">expires_at</span><span class="p">})</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âœ… MongoDB lock acquired by PID </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">emit_event</span><span class="p">(</span><span class="s2">&quot;lock_acquired&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="o">=</span><span class="n">pid</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">except</span> <span class="n">DuplicateKeyError</span><span class="p">:</span>
            <span class="c1"># A lock already exists</span>
            <span class="c1"># First, attempt immediate takeover if the lock is expired</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
                <span class="n">expires_at</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">LOCK_TIMEOUT_MINUTES</span><span class="p">)</span>

                <span class="n">doc</span> <span class="o">=</span> <span class="n">lock_collection</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">LOCK_ID</span><span class="p">})</span>
                <span class="k">if</span> <span class="n">doc</span> <span class="ow">and</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;expires_at&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;expires_at&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">now</span><span class="p">:</span>
                    <span class="c1"># Attempt to take over an expired lock</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">lock_collection</span><span class="o">.</span><span class="n">find_one_and_update</span><span class="p">(</span>
                        <span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">LOCK_ID</span><span class="p">,</span> <span class="s2">&quot;expires_at&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$lt&quot;</span><span class="p">:</span> <span class="n">now</span><span class="p">}},</span>
                        <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;pid&quot;</span><span class="p">:</span> <span class="n">pid</span><span class="p">,</span> <span class="s2">&quot;expires_at&quot;</span><span class="p">:</span> <span class="n">expires_at</span><span class="p">}},</span>
                        <span class="n">return_document</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âœ… MongoDB lock re-acquired by PID </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2"> (expired lock)&quot;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">emit_event</span><span class="p">(</span><span class="s2">&quot;lock_reacquired&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="o">=</span><span class="n">pid</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Not expired: wait and retry instead of exiting to support blue/green deploys</span>
                    <span class="n">max_wait_seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LOCK_MAX_WAIT_SECONDS&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">))</span>  <span class="c1"># 0 = wait indefinitely</span>
                    <span class="n">retry_interval_seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LOCK_RETRY_INTERVAL_SECONDS&quot;</span><span class="p">,</span> <span class="s2">&quot;5&quot;</span><span class="p">))</span>

                    <span class="k">if</span> <span class="n">max_wait_seconds</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">deadline</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">max_wait_seconds</span>
                        <span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">deadline</span><span class="p">:</span>
                            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">retry_interval_seconds</span><span class="p">)</span>
                            <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
                            <span class="n">doc</span> <span class="o">=</span> <span class="n">lock_collection</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">LOCK_ID</span><span class="p">})</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">doc</span> <span class="ow">or</span> <span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;expires_at&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;expires_at&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">now</span><span class="p">):</span>
                                <span class="k">break</span>
                        <span class="c1"># loop will re-check and attempt takeover at the top</span>
                        <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">deadline</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Timeout waiting for existing lock to release. Exiting gracefully.&quot;</span><span class="p">)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">emit_event</span><span class="p">(</span><span class="s2">&quot;lock_wait_timeout&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;warn&quot;</span><span class="p">,</span> <span class="n">max_wait_seconds</span><span class="o">=</span><span class="n">max_wait_seconds</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="k">pass</span>
                            <span class="k">return</span> <span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Infinite wait with periodic log</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Another bot instance is already running (lock present). Waiting for lock releaseâ€¦&quot;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">emit_event</span><span class="p">(</span><span class="s2">&quot;lock_waiting_existing&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;warn&quot;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">retry_interval_seconds</span><span class="p">)</span>
                        <span class="k">continue</span>
                <span class="c1"># If we reach here without breaking, loop will retry</span>
            
        <span class="c1"># Ensure lock is released on exit</span>
        <span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">cleanup_mongo_lock</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to acquire MongoDB lock: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">emit_event</span><span class="p">(</span><span class="s2">&quot;lock_acquire_failed&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="c1"># Fail-open to not crash the app, but log loudly</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Global reference to the current bot instance</span>
<span class="c1"># ××©××© ×›×“×™ ×œ××¤×©×¨ ×œ-main() ×œ×¢×©×•×ª reuse ×©×œ ××™× ×¡×˜× ×¡ ×§×™×™× (×œ×¦×¨×›×™ ×˜×¡×˜×™×/××ª×—×•×œ)</span>
<span class="n">CURRENT_BOT</span><span class="p">:</span> <span class="n">CodeKeeperBot</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># ×™×•×’×“×¨ ×‘×ª×•×š CodeKeeperBot.__init__</span>


<div class="viewcode-block" id="HelpEntry">
<a class="viewcode-back" href="../api/main.html#main.HelpEntry">[×ª×™×¢×•×“]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">HelpEntry</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;×ª×™××•×¨ ×©×œ ×©×•×¨×ª ×¢×–×¨×”.&quot;&quot;&quot;</span>
    <span class="n">commands</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="n">suffix</span><span class="p">:</span> <span class="n">NotRequired</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span></div>



<div class="viewcode-block" id="HelpSection">
<a class="viewcode-back" href="../api/main.html#main.HelpSection">[×ª×™×¢×•×“]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">HelpSection</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;×§×‘×•×¦×ª ×¤×§×•×“×•×ª ×œ×œ× ×›×¤×ª×•×¨×™×.&quot;&quot;&quot;</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">entries</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">HelpEntry</span><span class="p">]</span></div>



<span class="n">HELP_SECTIONS</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">HelpSection</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;ğŸ”” &lt;b&gt;×ª×–×›×•×¨×•×ª&lt;/b&gt;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;entries&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span><span class="s2">&quot;commands&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;remind&quot;</span><span class="p">,),</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;×™×¦×™×¨×ª ×ª×–×›×•×¨×ª ×—×›××”&quot;</span><span class="p">},</span>
            <span class="p">{</span><span class="s2">&quot;commands&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;reminders&quot;</span><span class="p">,),</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;×¨×©×™××ª ×ª×–×›×•×¨×•×ª ×•× ×™×”×•×œ&quot;</span><span class="p">},</span>
        <span class="p">],</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;ğŸ¨ &lt;b&gt;×ª××•× ×•×ª ×§×•×“&lt;/b&gt;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;entries&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span><span class="s2">&quot;commands&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;image&quot;</span><span class="p">,),</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;×™×™×¦×•×¨ ×ª××•× ×” ××¢×•×¦×‘×ª&quot;</span><span class="p">,</span> <span class="s2">&quot;suffix&quot;</span><span class="p">:</span> <span class="s2">&quot; &amp;lt;×§×•×‘×¥&amp;gt;&quot;</span><span class="p">},</span>
            <span class="p">{</span><span class="s2">&quot;commands&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;preview&quot;</span><span class="p">,),</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;×ª×¦×•×’×” ××§×“×™××” ×©×œ ×§×•×‘×¥&quot;</span><span class="p">,</span> <span class="s2">&quot;suffix&quot;</span><span class="p">:</span> <span class="s2">&quot; &amp;lt;×§×•×‘×¥&amp;gt;&quot;</span><span class="p">},</span>
        <span class="p">],</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;ğŸ§° &lt;b&gt;××˜××•×Ÿ&lt;/b&gt;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;entries&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span><span class="s2">&quot;commands&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;cache_stats&quot;</span><span class="p">,),</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;×”×¦×’×ª ×¡×˜×˜×™×¡×˜×™×§×•×ª ××˜××•×Ÿ (Cache)&quot;</span><span class="p">},</span>
            <span class="p">{</span><span class="s2">&quot;commands&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;clear_cache&quot;</span><span class="p">,),</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;× ×™×§×•×™ ××˜××•×Ÿ ×œ××©×ª××© ×”× ×•×›×—×™&quot;</span><span class="p">},</span>
        <span class="p">],</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;ğŸ—ï¸ &lt;b&gt;×¨×¤×§×˜×•×¨×™× ×’&lt;/b&gt;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;entries&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span><span class="s2">&quot;commands&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;refactor&quot;</span><span class="p">,),</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;×¨×¤×§×˜×•×¨×™× ×’ ××•×˜×•××˜×™ ×œ×§×•×‘×¥&quot;</span><span class="p">,</span> <span class="s2">&quot;suffix&quot;</span><span class="p">:</span> <span class="s2">&quot; &amp;lt;×§×•×‘×¥&amp;gt;&quot;</span><span class="p">},</span>
        <span class="p">],</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;âš™ï¸ &lt;b&gt;×× ×”×œ (××•×’×‘×œ)&lt;/b&gt;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;entries&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span><span class="s2">&quot;commands&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">,</span> <span class="s2">&quot;errors&quot;</span><span class="p">,</span> <span class="s2">&quot;metrics&quot;</span><span class="p">,</span> <span class="s2">&quot;uptime&quot;</span><span class="p">),</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
        <span class="p">],</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="n">SUPPORT_FOOTER</span> <span class="o">=</span> <span class="s2">&quot;×œ×‘×¢×™×•×ª ××• ×”×¦×¢×•×ª: @moominAmir&quot;</span>

<span class="n">HELP_SECTION_COMMANDS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">cmd</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">HELP_SECTIONS</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">section</span><span class="p">[</span><span class="s2">&quot;entries&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;commands&quot;</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">HELP_EXCLUDED_COMMANDS</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="s2">&quot;help&quot;</span><span class="p">,</span> <span class="s2">&quot;cancel&quot;</span><span class="p">,</span> <span class="s2">&quot;done&quot;</span><span class="p">}</span>

<span class="n">STATIC_HELP_MESSAGE</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;&lt;b&gt;ğŸ“š ×¢×–×¨×” â€“ ×¤×§×•×“×•×ª ×œ×œ× ×›×¤×ª×•×¨×™×&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
    <span class="s2">&quot;ğŸ”” &lt;b&gt;×ª×–×›×•×¨×•×ª&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="s2">&quot;â€¢ &lt;code&gt;/remind&lt;/code&gt; â€“ ×™×¦×™×¨×ª ×ª×–×›×•×¨×ª ×—×›××”</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="s2">&quot;â€¢ &lt;code&gt;/reminders&lt;/code&gt; â€“ ×¨×©×™××ª ×ª×–×›×•×¨×•×ª ×•× ×™×”×•×œ</span><span class="se">\n\n</span><span class="s2">&quot;</span>
    <span class="s2">&quot;ğŸ¨ &lt;b&gt;×ª××•× ×•×ª ×§×•×“&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="s2">&quot;â€¢ &lt;code&gt;/image&lt;/code&gt; &amp;lt;×§×•×‘×¥&amp;gt; â€“ ×™×™×¦×•×¨ ×ª××•× ×” ××¢×•×¦×‘×ª</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="s2">&quot;â€¢ &lt;code&gt;/preview&lt;/code&gt; &amp;lt;×§×•×‘×¥&amp;gt; â€“ ×ª×¦×•×’×” ××§×“×™××”</span><span class="se">\n\n</span><span class="s2">&quot;</span>
    <span class="s2">&quot;ğŸ§° &lt;b&gt;××˜××•×Ÿ&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="s2">&quot;â€¢ &lt;code&gt;/cache_stats&lt;/code&gt; â€“ ×”×¦×’×ª ×¡×˜×˜×™×¡×˜×™×§×•×ª ××˜××•×Ÿ (Cache)</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="s2">&quot;â€¢ &lt;code&gt;/clear_cache&lt;/code&gt; â€“ × ×™×§×•×™ ××˜××•×Ÿ ×œ××©×ª××© ×”× ×•×›×—×™</span><span class="se">\n\n</span><span class="s2">&quot;</span>
    <span class="s2">&quot;ğŸ—ï¸ &lt;b&gt;×¨×¤×§×˜×•×¨×™× ×’&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="s2">&quot;â€¢ &lt;code&gt;/refactor&lt;/code&gt; &amp;lt;×§×•×‘×¥&amp;gt; â€“ ×¨×¤×§×˜×•×¨×™× ×’ ××•×˜×•××˜×™ ×œ×§×•×‘×¥</span><span class="se">\n\n</span><span class="s2">&quot;</span>
    <span class="s2">&quot;âš™ï¸ &lt;b&gt;×× ×”×œ (××•×’×‘×œ)&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="s2">&quot;â€¢ &lt;code&gt;/status&lt;/code&gt; &lt;code&gt;/errors&lt;/code&gt; &lt;code&gt;/metrics&lt;/code&gt; &lt;code&gt;/uptime&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">SUPPORT_FOOTER</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_collect_commands_from_handler</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">seen_ids</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract command names (lowercase) from a handler or nested handlers.&quot;&quot;&quot;</span>
    <span class="n">commands</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">handler</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">commands</span>
    <span class="n">handler_id</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">handler_id</span> <span class="ow">in</span> <span class="n">seen_ids</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">commands</span>
    <span class="n">seen_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">handler_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">CommandHandler</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="s2">&quot;commands&quot;</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
            <span class="n">names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmd</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">candidate</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s2">&quot;command&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">candidate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">candidate</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">candidate</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">candidate</span><span class="p">]</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">candidate</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">set</span><span class="p">)):</span>
                    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">candidate</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">str</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
                    <span class="n">commands</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">commands</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">ConversationHandler</span><span class="p">):</span>
        <span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="s2">&quot;kwargs&quot;</span><span class="p">,</span> <span class="p">{})</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="s2">&quot;kwargs&quot;</span><span class="p">,</span> <span class="p">{}),</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="n">entry_points</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="s2">&quot;entry_points&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">entry_points</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">entry_points</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;entry_points&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">nested</span> <span class="ow">in</span> <span class="n">entry_points</span> <span class="ow">or</span> <span class="p">[]:</span>
            <span class="n">commands</span> <span class="o">|=</span> <span class="n">_collect_commands_from_handler</span><span class="p">(</span><span class="n">nested</span><span class="p">,</span> <span class="n">seen_ids</span><span class="p">)</span>
        <span class="n">states</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="s2">&quot;states&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">states</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">states</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;states&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">nested_list</span> <span class="ow">in</span> <span class="p">(</span><span class="n">states</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">nested</span> <span class="ow">in</span> <span class="n">nested_list</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="n">commands</span> <span class="o">|=</span> <span class="n">_collect_commands_from_handler</span><span class="p">(</span><span class="n">nested</span><span class="p">,</span> <span class="n">seen_ids</span><span class="p">)</span>
        <span class="n">fallbacks</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="s2">&quot;fallbacks&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fallbacks</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fallbacks</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fallbacks&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">nested</span> <span class="ow">in</span> <span class="n">fallbacks</span> <span class="ow">or</span> <span class="p">[]:</span>
            <span class="n">commands</span> <span class="o">|=</span> <span class="n">_collect_commands_from_handler</span><span class="p">(</span><span class="n">nested</span><span class="p">,</span> <span class="n">seen_ids</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">commands</span>

    <span class="c1"># Composite handler (tuple/list) â€“ iterate children if ×§×™×™××™×</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">set</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">nested</span> <span class="ow">in</span> <span class="n">handler</span><span class="p">:</span>
            <span class="n">commands</span> <span class="o">|=</span> <span class="n">_collect_commands_from_handler</span><span class="p">(</span><span class="n">nested</span><span class="p">,</span> <span class="n">seen_ids</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">commands</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_get_registered_commands</span><span class="p">(</span><span class="n">application</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the set of command names registered on the given application.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">application</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">()</span>

    <span class="n">handlers_container</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="s2">&quot;handlers&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">handlers_container</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">()</span>

    <span class="n">command_names</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">handlers_container</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">iterable</span> <span class="o">=</span> <span class="n">handlers_container</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">iterable</span> <span class="o">=</span> <span class="n">handlers_container</span>

    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">iterable</span><span class="p">:</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="n">entry</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="n">entry</span><span class="p">:</span>
            <span class="n">handler</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">command_names</span> <span class="o">|=</span> <span class="n">_collect_commands_from_handler</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">command_names</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_build_help_message</span><span class="p">(</span><span class="n">registered_commands</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compose the help text for commands without dedicated buttons.&quot;&quot;&quot;</span>
    <span class="n">available_commands</span> <span class="o">=</span> <span class="p">{</span><span class="n">cmd</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">registered_commands</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="nb">str</span><span class="p">)}</span>
    <span class="n">lines</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&lt;b&gt;ğŸ“š ×¢×–×¨×” â€“ ×¤×§×•×“×•×ª ×œ×œ× ×›×¤×ª×•×¨×™×&lt;/b&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>
    <span class="n">has_sections</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">HELP_SECTIONS</span><span class="p">:</span>
        <span class="n">section_lines</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">section</span><span class="p">[</span><span class="s2">&quot;entries&quot;</span><span class="p">]:</span>
            <span class="n">commands</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmd</span> <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;commands&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">available_commands</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">commands</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;suffix&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">cmd_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;code&gt;/</span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span> <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">commands</span><span class="p">)</span> <span class="o">+</span> <span class="n">suffix</span>
            <span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]:</span>
                <span class="n">section_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;â€¢ </span><span class="si">{</span><span class="n">cmd_text</span><span class="si">}</span><span class="s2"> â€“ </span><span class="si">{</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">section_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;â€¢ </span><span class="si">{</span><span class="n">cmd_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">section_lines</span><span class="p">:</span>
            <span class="n">has_sections</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">section</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">])</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">section_lines</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="c1"># ×”×¡×¨×ª ×¡×¢×™×£ &quot;×¤×§×•×“×•×ª × ×•×¡×¤×•×ª&quot; ×œ×¤×™ ×”×“×¨×™×©×” â€“ ××¦×™×’×™× ×¨×§ ××ª ×”×§×˜×’×•×¨×™×•×ª ×”××•×’×“×¨×•×ª</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">has_sections</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">STATIC_HELP_MESSAGE</span>

    <span class="k">while</span> <span class="n">lines</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SUPPORT_FOOTER</span><span class="p">)</span>

    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>


<div class="viewcode-block" id="CodeKeeperBot">
<a class="viewcode-back" href="../api/main.html#main.CodeKeeperBot">[×ª×™×¢×•×“]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CodeKeeperBot</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ×”××—×œ×§×” ×”×¨××©×™×ª ×©×œ Code Keeper Bot.</span>
<span class="sd">    </span>
<span class="sd">    ××—×œ×§×” ×–×• ×× ×”×œ×ª ××ª ×›×œ ×”×¤×•× ×§×¦×™×•× ×œ×™×•×ª ×©×œ ×”×‘×•×˜, ×›×•×œ×œ:</span>
<span class="sd">    - ×”×’×“×¨×ª handlers ×œ×¤×§×•×“×•×ª ×•××¡×¨×™×</span>
<span class="sd">    - × ×™×”×•×œ ×©×™×—×•×ª ××•×¨×›×‘×•×ª</span>
<span class="sd">    - ××™× ×˜×’×¨×¦×™×•×ª ×¢× ×©×™×¨×•×ª×™× ×—×™×¦×•× ×™×™×</span>
<span class="sd">    - × ×™×”×•×œ ××¡×“ × ×ª×•× ×™×</span>
<span class="sd">    </span>
<span class="sd">    Attributes:</span>
<span class="sd">        application: ××•×‘×™×™×§×˜ Application ×©×œ python-telegram-bot</span>
<span class="sd">        github_handler: ×× ×”×œ ××™× ×˜×’×¨×¦×™×™×ª GitHub</span>
<span class="sd">        backup_handler: ×× ×”×œ ××¢×¨×›×ª ×”×’×™×‘×•×™×™×</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="CodeKeeperBot.__init__">
<a class="viewcode-back" href="../api/main.html#main.CodeKeeperBot.__init__">[×ª×™×¢×•×“]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># ×™×¦×™×¨×ª ×ª×™×§×™×™×” ×–×× ×™×ª ×¢× ×”×¨×©××•×ª ×›×ª×™×‘×”</span>
        <span class="n">DATA_DIR</span> <span class="o">=</span> <span class="s2">&quot;/tmp&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
        <span class="c1"># ×™×¦×™×¨×ª persistence ×œ×©××™×¨×ª × ×ª×•× ×™× ×‘×™×Ÿ ×”×¤×¢×œ×•×ª</span>
        <span class="n">persistence</span> <span class="o">=</span> <span class="n">PicklePersistence</span><span class="p">(</span><span class="n">filepath</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">DATA_DIR</span><span class="si">}</span><span class="s2">/bot_data.pickle&quot;</span><span class="p">)</span>
        
        <span class="c1"># ×‘××¦×‘ ×‘×“×™×§×•×ª/CI, ×—×œ×§ ××ª×œ×•×™×•×ª ×”×˜×œ×’×¨× (Updater ×¤× ×™××™) ×¢×œ×•×œ×•×ª ×œ×”×™×›×©×œ.</span>
        <span class="c1"># × ×©×ª××© ×‘×‘× ××™ ×”×¨×’×™×œ, ×•×× × ×›×©×œ â€“ × ×‘× ×” Application ××™× ×™××œ×™ ×¢× ×˜×•×§×Ÿ ×“××”.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">application</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">Application</span><span class="o">.</span><span class="n">builder</span><span class="p">()</span>
                <span class="o">.</span><span class="n">token</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">BOT_TOKEN</span><span class="p">)</span>
                <span class="o">.</span><span class="n">defaults</span><span class="p">(</span><span class="n">Defaults</span><span class="p">(</span><span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">))</span>
                <span class="o">.</span><span class="n">persistence</span><span class="p">(</span><span class="n">persistence</span><span class="p">)</span>
                <span class="o">.</span><span class="n">post_init</span><span class="p">(</span><span class="n">setup_bot_data</span><span class="p">)</span>
                <span class="o">.</span><span class="n">build</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">dummy_token</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DUMMY_BOT_TOKEN&quot;</span><span class="p">,</span> <span class="s2">&quot;dummy_token&quot;</span><span class="p">)</span>
            <span class="c1"># × ×¡×” ×œ×‘× ×•×ª ×œ×œ× persistence/post_init ×›×“×™ ×œ×¢×§×•×£ Updater ×¤× ×™××™</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">application</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">Application</span><span class="o">.</span><span class="n">builder</span><span class="p">()</span>
                    <span class="o">.</span><span class="n">token</span><span class="p">(</span><span class="n">dummy_token</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">defaults</span><span class="p">(</span><span class="n">Defaults</span><span class="p">(</span><span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">))</span>
                    <span class="o">.</span><span class="n">build</span><span class="p">()</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># ×‘× ××™ ×™×“× ×™ ××™× ×™××œ×™: ××•×‘×™×™×§×˜ ×¢× ×”×××©×§×™× ×”×“×¨×•×©×™× ×œ×˜×¡×˜×™×/×¡×‘×™×‘×•×ª ×—×¡×¨×•×ª</span>
                <span class="k">class</span><span class="w"> </span><span class="nc">_MiniApp</span><span class="p">:</span>
                    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">bot_data</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_error_handlers</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">class</span><span class="w"> </span><span class="nc">_JobQ</span><span class="p">:</span>
                            <span class="k">def</span><span class="w"> </span><span class="nf">run_once</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
                                <span class="k">return</span> <span class="kc">None</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">job_queue</span> <span class="o">=</span> <span class="n">_JobQ</span><span class="p">()</span>
                    <span class="k">def</span><span class="w"> </span><span class="nf">add_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
                        <span class="c1"># ×©××™×¨×” ×‘××‘× ×” ×™×¦×™×‘ ×œ×˜×¡×˜×™×: (args_tuple, kwargs_dict)</span>
                        <span class="c1"># args_tuple ××•×‘×˜×— ×‘××•×¨×š â‰¥ 2 ×›×š ×©-index [1] ×œ× ×™×§×¨×•×¡.</span>
                        <span class="n">handler_obj</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">handler_obj</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># ×§×œ×˜ ××œ×˜×¨× ×˜×™×‘×™ × ×“×™×¨: handler ×‘×§×•×•××¨×’×¡</span>
                            <span class="n">handler_obj</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;handler&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">k</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;callback&#39;</span><span class="p">)</span>
                        <span class="c1"># group ×™×›×•×œ ×œ×”×’×™×¢ ×›××¨×’×•×× ×˜ ×©× ×™ ××• ×‘×§×•×•××¨×’×¡</span>
                        <span class="n">group_val</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="k">else</span> <span class="n">k</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">)</span>
                        <span class="c1"># ×‘× ×” args ×‘××•×¨×š 2 ×œ×¤×—×•×ª â€“ ××©×›×¤×œ ××ª ×”-handler ×›×“×™ ×œ×¡×¤×§ args[1]</span>
                        <span class="n">norm_args</span> <span class="o">=</span> <span class="p">(</span><span class="n">handler_obj</span><span class="p">,</span> <span class="n">handler_obj</span><span class="p">)</span>
                        <span class="n">norm_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                        <span class="k">if</span> <span class="s1">&#39;group&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">norm_kwargs</span><span class="p">:</span>
                            <span class="n">norm_kwargs</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">group_val</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">norm_args</span><span class="p">,</span> <span class="n">norm_kwargs</span><span class="p">))</span>
                    <span class="k">def</span><span class="w"> </span><span class="nf">remove_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
                        <span class="c1"># ×”×¡×¨×” ×©×§×˜×” â€“ ×©××•×¨ ×¢×œ API, ×œ× ×”×›×¨×—×™ ×œ×˜×¡×˜×™×</span>
                        <span class="k">return</span> <span class="kc">None</span>
                    <span class="k">def</span><span class="w"> </span><span class="nf">add_error_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_error_handlers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
                    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_polling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
                        <span class="c1"># Fallback ×©×§×˜: ××™×Ÿ polling ×××™×ª×™; ×××¤×©×¨ start ×œ×œ× ×§×¨×™×¡×”</span>
                        <span class="k">return</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">application</span> <span class="o">=</span> <span class="n">_MiniApp</span><span class="p">()</span>
        <span class="c1"># ××©×ª× ×™ ×¢×–×¨ ×¢×‘×•×¨ ×©×¢×¨ ×ª×—×–×•×§×” (TTL ×™×•×¤×¢×œ ×‘×¡×•×£ setup_handlers)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_maintenance_gate_pending</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_maintenance_warmup_secs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_maintenance_clear_handlers_cb</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># ×”×ª×§× ×ª ××ª×× ×§×•×¨×œ×¦×™×” ×œ×¤× ×™ ×¨×™×©×•× ×©××¨ ×”-handlers</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_install_correlation_layer</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_install_tracing_layer</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># ×™×¦×™×¨×ª ×•×”×–×¨×§×ª Activity Reporter ×‘×–××Ÿ ×¨×™×¦×” (××•× ×¢ ×—×™×‘×•×¨×™× ××¨×•×‘×™× ×‘×–××Ÿ import)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mongodb_uri</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;REPORTER_MONGODB_URL&#39;</span><span class="p">)</span>
                <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;REPORTER_MONGODB_URI&#39;</span><span class="p">)</span>
                <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;MONGODB_URL&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">service_id</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;REPORTER_SERVICE_ID&#39;</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;BOT_LABEL&#39;</span><span class="p">,</span> <span class="s1">&#39;CodeBot&#39;</span><span class="p">))</span>
            <span class="c1"># ×ª××™×›×” ×‘× ×˜×¨×•×œ ×“×™×•×•×— ×¤×¢×™×œ×•×ª ×“×¨×š ENV</span>
            <span class="n">disable_reporter</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">int</span><span class="p">((</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;DISABLE_ACTIVITY_REPORTER&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">disable_reporter</span><span class="p">:</span>
                <span class="k">class</span><span class="w"> </span><span class="nc">_NoopReporter</span><span class="p">:</span>
                    <span class="k">def</span><span class="w"> </span><span class="nf">report_activity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
                        <span class="k">return</span> <span class="kc">None</span>
                <span class="n">created_reporter</span> <span class="o">=</span> <span class="n">_NoopReporter</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># ×™×™×‘×•× ×‘×–××Ÿ ×¨×™×¦×” ×‘×œ×‘×“ ×›×“×™ ×œ×× ×•×¢ ×™×¦×™×¨×ª ×œ×§×•×— Mongo ×‘×–××Ÿ import ×‘××•×“×•×œ×™× ××—×¨×™×</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">activity_reporter</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_reporter</span>  <span class="c1"># noqa: WPS433 (runtime import by design)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="c1"># ×× ×”××•×“×•×œ ×œ× ×–××™×Ÿ/× ×›×©×œ â€” ×¢×‘×•×¨ ×œ-noop</span>
                    <span class="k">class</span><span class="w"> </span><span class="nc">_NoopReporter</span><span class="p">:</span>
                        <span class="k">def</span><span class="w"> </span><span class="nf">report_activity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
                            <span class="k">return</span> <span class="kc">None</span>
                    <span class="n">created_reporter</span> <span class="o">=</span> <span class="n">_NoopReporter</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># ×™×¦×™×¨×” ×‘×˜×•×—×”: SimpleActivityReporter ××˜×¤×œ ×‘×—×•×¡×¨ pymongo ×‘×¡×‘×™×‘×”</span>
                    <span class="n">created_reporter</span> <span class="o">=</span> <span class="n">create_reporter</span><span class="p">(</span>
                        <span class="n">mongodb_uri</span><span class="o">=</span><span class="n">mongodb_uri</span><span class="p">,</span>
                        <span class="n">service_id</span><span class="o">=</span><span class="n">service_id</span><span class="p">,</span>
                        <span class="n">service_name</span><span class="o">=</span><span class="s2">&quot;CodeBot&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="c1"># ×¢×“×›×•×Ÿ ×’×œ×•×‘×œ×™ ×‘××•×“×•×œ ×–×”</span>
            <span class="k">global</span> <span class="n">reporter</span>
            <span class="n">reporter</span> <span class="o">=</span> <span class="n">created_reporter</span>
            <span class="c1"># ×”×–×¨×§×” ×œ××•×“×•×œ×™× ×©×ª×œ×•×™×™× ×‘-report_activity</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">set_bh_activity_reporter</span><span class="p">(</span><span class="n">created_reporter</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">set_ch_activity_reporter</span><span class="p">(</span><span class="n">created_reporter</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">refactor_handlers</span><span class="w"> </span><span class="kn">import</span> <span class="n">set_activity_reporter</span> <span class="k">as</span> <span class="n">set_rh_activity_reporter</span>
                <span class="n">set_rh_activity_reporter</span><span class="p">(</span><span class="n">created_reporter</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># ×‘×¡×‘×™×‘×•×ª CI/×˜×¡×˜×™×, ××œ × ×›×©×™×œ ××ª ×”×‘× ×™×™×”</span>
            <span class="n">reporter</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">document_handler</span> <span class="o">=</span> <span class="n">DocumentHandler</span><span class="p">(</span>
            <span class="n">notify_admins</span><span class="o">=</span><span class="n">notify_admins</span><span class="p">,</span>
            <span class="n">get_reporter</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">reporter</span><span class="p">,</span>
            <span class="n">log_user_activity</span><span class="o">=</span><span class="n">log_user_activity</span><span class="p">,</span>
            <span class="n">encodings_to_try</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">ENCODINGS_TO_TRY</span><span class="p">,</span>
            <span class="n">emit_event</span><span class="o">=</span><span class="n">emit_event</span><span class="p">,</span>
            <span class="n">errors_total</span><span class="o">=</span><span class="n">errors_total</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setup_handlers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_activate_maintenance_warmup_if_pending</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">advanced_handlers</span> <span class="o">=</span> <span class="n">AdvancedBotHandlers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="p">)</span>
        <span class="c1"># ×¨×™×©×•× ×§×˜×’×•×¨×™×™×ª &quot;â­ ××•×¢×“×¤×™×&quot; ×œ×ª×¤×¨×™×˜ &quot;ğŸ“š ×”×§×‘×¦×™×&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">conversation_handlers</span><span class="w"> </span><span class="kn">import</span> <span class="n">setup_favorites_category_handlers</span> <span class="k">as</span> <span class="n">_setup_fav</span>
            <span class="n">_setup_fav</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="c1"># Rate limiter instance (×œ××—×¨ ×‘× ×™×™×ª ×”××¤×œ×™×§×¦×™×”)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rate_limiter</span> <span class="o">=</span> <span class="n">RateLimiter</span><span class="p">(</span><span class="n">max_per_minute</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;RATE_LIMIT_PER_MINUTE&#39;</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">30</span><span class="p">))</span>
            <span class="c1"># ×”×’×“×¨×ª ×“×’×œ shadow ×›×‘×¨×™×¨×ª ××—×“×œ (×’× ×× ××™×Ÿ ××’×‘×™×œ ××ª×§×“×)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_shadow_mode</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;RATE_LIMIT_SHADOW_MODE&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
            <span class="c1"># ××ª×—×•×œ ××©×ª× ×™× ×›×“×™ ×œ×× ×•×¢ AttributeError downstream</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_advanced_limiter</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_limits_storage</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_per_user_global</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">_LIMITS_AVAILABLE</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">redis_url</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;REDIS_URL&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;REDIS_URL&#39;</span><span class="p">)</span>
                    <span class="n">storage</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">use_memory_fallback</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="k">if</span> <span class="n">redis_url</span><span class="p">:</span>
                        <span class="c1"># ×•×“× ×—×™×‘×•×¨ ××”×™×¨ ×œ-Redis; ×× × ×›×©×œ, × ×©×ª××© ×‘-MemoryStorage ×›×“×™ ×œ×× ×•×¢ TIMEOUT ×‘×˜×¡×˜×™×</span>
                        <span class="n">connect_timeout</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;REDIS_CONNECT_TIMEOUT&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">connect_timeout</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">connect_timeout</span><span class="p">)</span> <span class="k">if</span> <span class="n">connect_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mf">0.25</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="n">connect_timeout</span> <span class="o">=</span> <span class="mf">0.25</span>
                        <span class="n">connect_timeout</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">connect_timeout</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">_redis_socket_available</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">redis_url</span><span class="p">),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">connect_timeout</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">storage</span> <span class="o">=</span> <span class="n">RedisStorage</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">redis_url</span><span class="p">))</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="n">storage</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="n">use_memory_fallback</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">use_memory_fallback</span> <span class="o">=</span> <span class="kc">True</span>

                        <span class="k">if</span> <span class="n">use_memory_fallback</span> <span class="ow">and</span> <span class="n">storage</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                    <span class="s2">&quot;Redis advanced limiter ×œ× × ×’×™×© â€“ ××¢×‘×¨ ×œ-MemoryStorage&quot;</span><span class="p">,</span>
                                    <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;redis_url&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_url</span><span class="p">)},</span>
                                <span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="k">pass</span>

                    <span class="k">if</span> <span class="n">storage</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">redis_url</span> <span class="ow">and</span> <span class="n">use_memory_fallback</span> <span class="ow">and</span> <span class="n">MemoryStorage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">storage</span> <span class="o">=</span> <span class="n">MemoryStorage</span><span class="p">()</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="n">storage</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="k">if</span> <span class="n">storage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_limits_storage</span> <span class="o">=</span> <span class="n">storage</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_advanced_limiter</span> <span class="o">=</span> <span class="n">MovingWindowRateLimiter</span><span class="p">(</span><span class="n">storage</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_per_user_global</span> <span class="o">=</span> <span class="n">RateLimitItemPerMinute</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_advanced_limiter</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rate_limiter</span> <span class="o">=</span> <span class="n">RateLimiter</span><span class="p">(</span><span class="n">max_per_minute</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_shadow_mode</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># ×—×©×™×¤×” ×’×œ×•×‘×œ×™×ª ×©×œ ×”××•×‘×™×™×§×˜ ×”× ×•×›×—×™ ×¢×‘×•×¨ main()/×˜×¡×˜×™×</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">global</span> <span class="n">CURRENT_BOT</span>
            <span class="n">CURRENT_BOT</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_install_correlation_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×¨×™×©×•× Handler ××•×§×“× ×©××™×™×¦×¨ ×•××§×©×¨ request_id ×•××•×“×“ ××˜×¨×™×§×•×ª ×‘×¡×™×¡×™×•×ª.&quot;&quot;&quot;</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_pre_update</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
            <span class="c1"># request_id ×§×¦×¨ ×•× ×•×—</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">req_id</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;user_data&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">req_id</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">req_id</span><span class="p">:</span>
                <span class="n">req_id</span> <span class="o">=</span> <span class="n">generate_request_id</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;user_data&quot;</span><span class="p">):</span>
                        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;request_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">req_id</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="c1"># ×›×¨×•×š ×œ-contextvars ×›×š ×©×™×•×¤×™×¢ ×‘×›×œ ×¨×©×•××ª ×œ×•×’ ×‘×”××©×š ×”×©×¨×©×•×¨</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">bind_request_id</span><span class="p">(</span><span class="n">req_id</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s2">&quot;effective_user&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">chat</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s2">&quot;effective_chat&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">uid</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">cid</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">chat</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">bind_user_context</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">uid</span><span class="p">,</span> <span class="n">chat_id</span><span class="o">=</span><span class="n">cid</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">command_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">message</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s2">&quot;effective_message&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">message</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="n">parts</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">parts</span> <span class="ow">and</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">):</span>
                            <span class="n">command_name</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">command_name</span><span class="p">:</span>
                    <span class="n">callback</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s2">&quot;callback_query&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">callback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                            <span class="n">parts</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">parts</span><span class="p">:</span>
                                <span class="n">command_name</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">command_name</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s2">&quot;inline_query&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="n">command_name</span> <span class="o">=</span> <span class="s2">&quot;inline_query&quot;</span>
                <span class="k">if</span> <span class="n">command_name</span><span class="p">:</span>
                    <span class="n">cleaned</span> <span class="o">=</span> <span class="n">command_name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">cleaned</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">):</span>
                        <span class="n">cleaned</span> <span class="o">=</span> <span class="n">cleaned</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="k">if</span> <span class="s2">&quot;@&quot;</span> <span class="ow">in</span> <span class="n">cleaned</span><span class="p">:</span>
                        <span class="n">cleaned</span> <span class="o">=</span> <span class="n">cleaned</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">cleaned</span> <span class="o">=</span> <span class="n">cleaned</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">cleaned</span><span class="p">:</span>
                        <span class="n">bind_command</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;bot:</span><span class="si">{</span><span class="n">cleaned</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;user_data&quot;</span><span class="p">):</span>
                                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;command&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cleaned</span>
                                <span class="c1"># ×‘×™×˜×•×œ ××¦×‘ ×—×™×¤×•×© ×¢×œ ×›×œ ×¤×§×•×“×”</span>
                                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;awaiting_search_text&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;search_ctx&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="c1"># ×¢×“×›×•×Ÿ ××˜×¨×™×§×” ×›×œ×œ×™×ª ×¢×œ ×¡×•×’ ×”-update</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">upd_type</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;callback_query&quot;</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s2">&quot;callback_query&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span>
                    <span class="s2">&quot;inline_query&quot;</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s2">&quot;inline_query&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span>
                    <span class="s2">&quot;message&quot;</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span>
                    <span class="s2">&quot;other&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">telegram_updates_total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">telegram_updates_total</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">upd_type</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s2">&quot;received&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="n">handler</span> <span class="o">=</span> <span class="n">TypeHandler</span><span class="p">(</span><span class="n">Update</span><span class="p">,</span> <span class="n">_pre_update</span><span class="p">)</span>  <span class="c1"># ×›×œ ×”-Updates</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">group</span><span class="o">=-</span><span class="mi">100</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># ××œ ×ª×›×©×™×œ ××ª ×”××¤×œ×™×§×¦×™×” ×‘××§×¨×” ×©×œ ×›×©×œ</span>
            <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_install_tracing_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Wrap process_update with OTEL span for end-to-end tracing.&quot;&quot;&quot;</span>
        <span class="n">app</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">app</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">original</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="s2">&quot;process_update&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">original</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="s2">&quot;_codebot_tracing_installed&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">observability_instrumentation</span><span class="w"> </span><span class="kn">import</span> <span class="n">start_span</span><span class="p">,</span> <span class="n">set_current_span_attributes</span>  <span class="c1"># type: ignore</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">start_span</span><span class="p">):</span>  <span class="c1"># type: ignore[call-arg]</span>
            <span class="k">return</span>

        <span class="nb">setattr</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="s2">&quot;_codebot_tracing_installed&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_normalize_command</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s2">&quot;&quot;</span>
                <span class="n">cleaned</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">cleaned</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">):</span>
                    <span class="n">cleaned</span> <span class="o">=</span> <span class="n">cleaned</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">if</span> <span class="s2">&quot;@&quot;</span> <span class="ow">in</span> <span class="n">cleaned</span><span class="p">:</span>
                    <span class="n">cleaned</span> <span class="o">=</span> <span class="n">cleaned</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">cleaned</span><span class="p">[:</span><span class="mi">80</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_derive_command</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s2">&quot;effective_message&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">message</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="n">parts</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">parts</span> <span class="ow">and</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">):</span>
                            <span class="k">return</span> <span class="n">_normalize_command</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">callback</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s2">&quot;callback_query&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">callback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">data</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">_normalize_command</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">inline</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s2">&quot;inline_query&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">inline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">query</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">inline</span><span class="p">,</span> <span class="s2">&quot;query&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">query</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">_normalize_command</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;&quot;</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_collect_attrs</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
            <span class="n">attrs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="s2">&quot;telegram.bot&quot;</span><span class="p">}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ctx</span> <span class="o">=</span> <span class="n">get_observability_context</span><span class="p">()</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">ctx</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">cmd_ctx</span> <span class="o">=</span> <span class="n">_normalize_command</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;command&quot;</span><span class="p">))</span> <span class="k">if</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;command&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                <span class="k">if</span> <span class="n">cmd_ctx</span><span class="p">:</span>
                    <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;command&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd_ctx</span>
                <span class="n">req_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">req_id</span><span class="p">:</span>
                    <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;request_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">req_id</span>
                <span class="n">user_hash</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">user_hash</span><span class="p">:</span>
                    <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;user_id_hash&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_hash</span>
                <span class="n">chat_hash</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;chat_id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">chat_hash</span><span class="p">:</span>
                    <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;chat_id_hash&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chat_hash</span>
            <span class="k">if</span> <span class="n">update</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">upd_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s2">&quot;update_id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">upd_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;update.id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">upd_id</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s2">&quot;callback_query&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                        <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;update.type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;callback_query&quot;</span>
                    <span class="k">elif</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s2">&quot;inline_query&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                        <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;update.type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;inline_query&quot;</span>
                    <span class="k">elif</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                        <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;update.type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;message&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">attrs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;update.type&quot;</span><span class="p">,</span> <span class="s2">&quot;other&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;command&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
                        <span class="n">derived</span> <span class="o">=</span> <span class="n">_derive_command</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">derived</span><span class="p">:</span>
                            <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;command&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">derived</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">return</span> <span class="n">attrs</span>

        <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">original</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_process_update_with_span</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">span_attrs</span> <span class="o">=</span> <span class="n">_collect_attrs</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>
            <span class="n">span_cm</span> <span class="o">=</span> <span class="n">start_span</span><span class="p">(</span><span class="s2">&quot;bot.update&quot;</span><span class="p">,</span> <span class="n">span_attrs</span><span class="p">)</span>
            <span class="n">span</span> <span class="o">=</span> <span class="n">span_cm</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">span</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">set_current_span_attributes</span><span class="p">({</span><span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="s2">&quot;telegram.bot&quot;</span><span class="p">})</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="n">error</span><span class="p">:</span> <span class="ne">Exception</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">original</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">span</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">span</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">,</span> <span class="s2">&quot;ok&quot;</span><span class="p">)</span>  <span class="c1"># type: ignore[attr-defined]</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">return</span> <span class="n">result</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">error</span> <span class="o">=</span> <span class="n">exc</span>
                <span class="k">if</span> <span class="n">span</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">span</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span>  <span class="c1"># type: ignore[attr-defined]</span>
                        <span class="n">span</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s2">&quot;error_signature&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>  <span class="c1"># type: ignore[attr-defined]</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">raise</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">error</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">span_cm</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">span_cm</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">error</span><span class="p">),</span> <span class="n">error</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="s2">&quot;__traceback__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

        <span class="nb">setattr</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="s2">&quot;process_update&quot;</span><span class="p">,</span> <span class="n">_process_update_with_span</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_activate_maintenance_warmup_if_pending</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;××ª×–××Ÿ ××ª ×—×œ×•×Ÿ ×”-warmup ×¨×§ ××—×¨×™ ×©×›×œ ×”-handlers ×”×•×’×“×¨×•.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_maintenance_gate_pending&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">warmup_secs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_maintenance_warmup_secs</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maintenance_warmup_secs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="k">else</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;MAINTENANCE_AUTO_WARMUP_SECS&quot;</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">warmup_secs</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="n">warmup_secs</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">warmup_secs</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_maintenance_active_until_ts</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">warmup_secs</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_maintenance_active_until_ts</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="mi">30</span>

        <span class="n">cb</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_maintenance_clear_handlers_cb&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">job_queue</span><span class="o">.</span><span class="n">run_once</span><span class="p">(</span><span class="n">cb</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="n">warmup_secs</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;maintenance_clear_handlers&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_maintenance_gate_pending</span> <span class="o">=</span> <span class="kc">False</span>
    
<div class="viewcode-block" id="CodeKeeperBot.setup_handlers">
<a class="viewcode-back" href="../api/main.html#main.CodeKeeperBot.setup_handlers">[×ª×™×¢×•×“]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup_handlers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×”×’×“×¨×ª ×›×œ ×”-handlers ×©×œ ×”×‘×•×˜ ×‘×¡×“×¨ ×”× ×›×•×Ÿ&quot;&quot;&quot;</span>

        <span class="c1"># Maintenance gate: if enabled, short-circuit most interactions</span>
        <span class="c1"># ×©×™××•×© ×‘-getattr ×¢×‘×•×¨ ×ª××™××•×ª ×œ×˜×¡×˜×™× ×©××—×œ×™×¤×™× ××ª config ×‘××•×‘×™×™×§×˜ ××™× ×™××œ×™</span>
        <span class="n">maintenance_flag_raw</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;MAINTENANCE_MODE&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_coerce_flag</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">normalized</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">normalized</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">normalized</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="s2">&quot;on&quot;</span><span class="p">}:</span>
                        <span class="k">return</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">normalized</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;false&quot;</span><span class="p">,</span> <span class="s2">&quot;no&quot;</span><span class="p">,</span> <span class="s2">&quot;off&quot;</span><span class="p">}:</span>
                        <span class="k">return</span> <span class="kc">False</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
                    <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">maintenance_flag</span> <span class="o">=</span> <span class="n">_coerce_flag</span><span class="p">(</span><span class="n">maintenance_flag_raw</span><span class="p">)</span>

        <span class="n">env_override</span> <span class="o">=</span> <span class="n">_coerce_flag</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;MAINTENANCE_MODE&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">env_override</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">maintenance_flag</span> <span class="o">=</span> <span class="n">env_override</span>

        <span class="k">if</span> <span class="n">maintenance_flag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">maintenance_flag</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">DEFAULT_MAINTENANCE_WARMUP_GRACE_SECS</span> <span class="o">=</span> <span class="mf">0.75</span>

        <span class="k">if</span> <span class="n">maintenance_flag</span><span class="p">:</span>
            <span class="c1"># ×”×’×“×¨×ª ×—×œ×•×Ÿ ×–××Ÿ ×¤× ×™××™ ×©×‘×• ×”×•×“×¢×ª ×ª×—×–×•×§×” ×¤×¢×™×œ×”, ×›×š ×©×’× ×× ××—×™×§×ª ×”-handlers ×œ× ×ª×ª×‘×¦×¢</span>
            <span class="c1"># ×”×”×•×“×¢×” ×ª×™×›×‘×” ××•×˜×•××˜×™×ª ×œ××—×¨ ×”-warmup. ×”×—×™×©×•×‘ ×‘×¤×•×¢×œ × ×“×—×” ×œ×¡×•×£ setup_handlers ×›×“×™</span>
            <span class="c1"># ×œ×× ×•×¢ ×§×™×¦×•×¨ ××œ××›×•×ª×™ ×©×œ ×”×—×œ×•×Ÿ ×‘×–××Ÿ ×¨×™×©×•× ×”-handlers.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">warmup_secs</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;MAINTENANCE_AUTO_WARMUP_SECS&#39;</span><span class="p">,</span> <span class="mi">30</span><span class="p">)))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">warmup_secs</span> <span class="o">=</span> <span class="mi">30</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_maintenance_warmup_secs</span> <span class="o">=</span> <span class="n">warmup_secs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_maintenance_active_until_ts</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_maintenance_gate_pending</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">maintenance_reply</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
                <span class="c1"># ×× ×—×œ×•×Ÿ ×”-warmup ×”×¡×ª×™×™×, ××œ ×ª×©×œ×— ×”×•×“×¢×ª ×ª×—×–×•×§×”</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">raw_active_until</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_maintenance_active_until_ts&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">raw_active_until</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="c1"># ×¤×¨×©× ×•×ª:</span>
                <span class="c1"># None =&gt; ×ª×—×–×•×§×” ×¤×¢×™×œ×” (××™×Ÿ TTL)</span>
                <span class="c1"># 0 ××• ×¢×¨×š ×©×œ×™×œ×™ =&gt; ×ª×—×–×•×§×” ×× ×•×˜×¨×œ×ª</span>
                <span class="c1"># &gt; 0 =&gt; ×ª×—×–×•×§×” ×¤×¢×™×œ×” ×¢×“ timestamp ×–×”</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">active_until</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">raw_active_until</span><span class="p">)</span> <span class="k">if</span> <span class="n">raw_active_until</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">active_until</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">grace_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
                        <span class="n">config</span><span class="p">,</span> <span class="s2">&quot;MAINTENANCE_WARMUP_GRACE_SECS&quot;</span><span class="p">,</span> <span class="n">DEFAULT_MAINTENANCE_WARMUP_GRACE_SECS</span>
                    <span class="p">)</span>
                    <span class="n">grace_secs</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">grace_value</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">grace_secs</span> <span class="o">=</span> <span class="n">DEFAULT_MAINTENANCE_WARMUP_GRACE_SECS</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">is_active</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">active_until</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="n">active_until</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">now</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">active_until</span> <span class="o">+</span> <span class="n">grace_secs</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_active</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>

                <span class="n">maintenance_text</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;MAINTENANCE_MESSAGE&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
                <span class="n">sent</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="n">callback_query</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s2">&quot;callback_query&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">callback_query</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">await</span> <span class="n">callback_query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="n">cache_time</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="k">await</span> <span class="n">callback_query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">maintenance_text</span><span class="p">)</span>
                        <span class="n">sent</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">sent</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">sent</span><span class="p">:</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">message</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">message</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s2">&quot;effective_message&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">message</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">callback_query</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">message</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">callback_query</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">message</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s2">&quot;reply_text&quot;</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">maintenance_text</span><span class="p">)</span>
                            <span class="n">sent</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="n">sent</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">sent</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">bot</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;bot&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">bot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="c1"># fallback ×œ-bot ×“×¨×š application (×‘××§×¨×™× ×©×‘×”× context.bot ×œ× ×§×™×™×)</span>
                            <span class="n">bot</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;bot&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">bot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">bot</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;app&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;bot&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

                        <span class="n">chat</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s2">&quot;effective_chat&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="n">chat_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">chat</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">chat_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="c1"># × ×¡×” ×œ×”×¤×™×§ chat_id ×××©×ª××© ××• ××”×•×“×¢×” ×× ×§×™×™×</span>
                            <span class="n">message</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s2">&quot;effective_message&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                            <span class="n">chat_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s2">&quot;chat&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s2">&quot;chat_id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">chat_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">user</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s2">&quot;effective_user&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                            <span class="n">chat_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">bot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">chat_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">await</span> <span class="n">bot</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">chat_id</span><span class="o">=</span><span class="n">chat_id</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">maintenance_text</span><span class="p">)</span>
                            <span class="n">sent</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>

                <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
            <span class="c1"># Catch-all high-priority handlers during maintenance (keep references for clean removal)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_maintenance_message_handler</span> <span class="o">=</span> <span class="n">MessageHandler</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span> <span class="n">maintenance_reply</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_maintenance_callback_handler</span> <span class="o">=</span> <span class="n">CallbackQueryHandler</span><span class="p">(</span><span class="n">maintenance_reply</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_maintenance_message_handler</span><span class="p">,</span> <span class="n">group</span><span class="o">=-</span><span class="mi">100</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_maintenance_callback_handler</span><span class="p">,</span> <span class="n">group</span><span class="o">=-</span><span class="mi">100</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;MAINTENANCE_MODE is ON â€” all updates will receive maintenance message&quot;</span><span class="p">)</span>
            <span class="c1"># ××œ ×ª×—×¡×•× ×œ×’××¨×™: ×œ××—×¨ warmup ××•×˜×•××˜×™, ×”×¡×¨ ×ª×—×–×•×§×” (×œ×œ× Redeploy)</span>
            <span class="c1"># Schedule removing maintenance handlers via JobQueue instead of create_task</span>
            <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_clear_handlers_cb</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">app</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span>
                    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_maintenance_message_handler&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">app</span><span class="o">.</span><span class="n">remove_handler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_maintenance_message_handler</span><span class="p">,</span> <span class="n">group</span><span class="o">=-</span><span class="mi">100</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_maintenance_callback_handler&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">app</span><span class="o">.</span><span class="n">remove_handler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_maintenance_callback_handler</span><span class="p">,</span> <span class="n">group</span><span class="o">=-</span><span class="mi">100</span><span class="p">)</span>
                    <span class="c1"># × ×˜×¨×œ ××™×™×“×™×ª ××ª ×”×—×œ×•×Ÿ ×”×¤×¢×™×œ ×›×“×™ ×œ×× ×•×¢ ×©×œ×™×—×ª ×”×•×“×¢×•×ª ×ª×—×–×•×§×” ××™×•×ª×¨×•×ª</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_maintenance_active_until_ts</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;MAINTENANCE_MODE auto-warmup window elapsed; resuming normal operation&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_maintenance_clear_handlers_cb</span> <span class="o">=</span> <span class="n">_clear_handlers_cb</span>
            <span class="c1"># ×××©×™×›×™× ×œ×¨×©×•× ××ª ×©××¨ ×”-handlers ×›×“×™ ×©×™×§×œ×˜×• ××•×˜×•××˜×™×ª ××—×¨×™ ×”-warmup</span>

        <span class="c1"># ×¡×¤×•×¨ ××ª ×”-handlers</span>
        <span class="n">handler_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">handlers</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ğŸ” ×›××•×ª handlers ×œ×¤× ×™: </span><span class="si">{</span><span class="n">handler_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">emit_event</span><span class="p">(</span><span class="s2">&quot;handlers_count_before&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">handler_count</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># --- Rate limiting gate (×’×‘×•×” ×¢×“×™×¤×•×ª, ×œ×¤× ×™ ×©××¨ ×”-handlers) ---</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_rate_limit_gate</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s1">&#39;effective_user&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s1">&#39;callback_query&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="s1">&#39;from_user&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">user_id</span><span class="p">:</span>
                <span class="c1"># ×¢×§×™×¤×ª ××“××™×Ÿ â€“ ××“××™× ×™× ×œ× ××•×’×‘×œ×™× ×¢&quot;×™ ×”×©×¢×¨ ×”×’×œ×•×‘×œ×™</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">admins</span> <span class="o">=</span> <span class="n">get_admin_ids</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">admins</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">admins</span> <span class="ow">and</span> <span class="n">user_id</span> <span class="ow">in</span> <span class="n">admins</span><span class="p">:</span>
                    <span class="k">return</span>  <span class="c1"># ××¢×‘×¨ ×—×•×¤×©×™ ×œ××“××™×Ÿ</span>

                <span class="c1"># Fallback-counter ×¤×©×•×˜ ×¤×¨-××©×ª××© ×‘×—×œ×•×Ÿ ×©×œ 60×©×³ ×›×“×™ ×œ×›×¡×•×ª ×ª×§×œ×•×ª × ×“×™×¨×•×ª</span>
                <span class="c1"># ×‘××™××•×© ×”×¨××©×™ ×©×œ ×”××’×‘×™×œ. ×œ× ××—×œ×™×£ ××ª ×”××’×‘×™×œ, ×¨×§ ××—××™×¨ ×× ×¦×¨×™×š.</span>
                <span class="n">blocked_by_local</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">udata</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s1">&#39;user_data&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">udata</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="n">now_ts</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                        <span class="n">local</span> <span class="o">=</span> <span class="n">udata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_rl_local&#39;</span><span class="p">)</span>
                        <span class="n">limit_val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_rate_limiter&#39;</span><span class="p">,</span> <span class="nb">object</span><span class="p">()),</span> <span class="s1">&#39;max_per_minute&#39;</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">30</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">now_ts</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">local</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;start_ts&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="ow">or</span> <span class="mf">0.0</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mf">60.0</span><span class="p">:</span>
                            <span class="n">local</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;start_ts&#39;</span><span class="p">:</span> <span class="n">now_ts</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
                            <span class="c1"># ×©××•×¨ ××™×™×“×™×ª ××ª ×ª×—×™×œ×ª ×”×—×œ×•×Ÿ ×”×—×“×© ×›×“×™ ×œ× ×œ××‘×“ state ×’× ×× ×ª×ª×¨×—×© ×—×¡×™××” ×‘×‘×§×©×” ×”× ×•×›×—×™×ª</span>
                            <span class="n">udata</span><span class="p">[</span><span class="s1">&#39;_rl_local&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">local</span>
                        <span class="c1"># ×¡×¤×¨ ××ª ×”×§×¨×™××” ×”× ×•×›×—×™×ª ×‘×—×œ×•×Ÿ ×”× ×•×›×—×™</span>
                        <span class="n">next_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">local</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">next_count</span> <span class="o">&gt;</span> <span class="n">limit_val</span><span class="p">:</span>
                            <span class="n">blocked_by_local</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="c1"># ××œ ×ª×¢×“×›×Ÿ ××ª ×”××•× ×” ×›××©×¨ ×—×•×¡××™× â€“ × ×©××•×¨ ×¢×œ ×¢×§×‘×™×•×ª ××™× ×™××œ×™×ª</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">local</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_count</span>
                            <span class="n">udata</span><span class="p">[</span><span class="s1">&#39;_rl_local&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">local</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="c1"># ×× ×™×© ×©×’×™××”, ××œ ×ª×—×¡×•× â€“ × ×©×¢×Ÿ ×¢×œ ×”××’×‘×™×œ ×”×¨××©×™</span>
                    <span class="n">blocked_by_local</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="c1"># ×‘×“×™×§×” ×‘××’×‘×™×œ ×”×¨××©×™</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">allowed</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rate_limiter</span><span class="o">.</span><span class="n">check_rate_limit</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">allowed</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="c1"># Optional: advanced per-user global limit in shadow mode (logging only)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">adv</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_advanced_limiter&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">adv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_per_user_global&#39;</span><span class="p">):</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;tg:global:</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">ok</span> <span class="o">=</span> <span class="n">adv</span><span class="o">.</span><span class="n">hit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_per_user_global</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_shadow_mode&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                <span class="s2">&quot;Rate limit would block (shadow mode)&quot;</span><span class="p">,</span>
                                <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span> <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="s2">&quot;global&quot;</span><span class="p">,</span> <span class="s2">&quot;limit&quot;</span><span class="p">:</span> <span class="s2">&quot;global_user&quot;</span><span class="p">},</span>
                            <span class="p">)</span>
                        <span class="c1"># ×‘××¦×‘ shadow ××™×Ÿ ×—×¡×™××” ×¢×œ ×‘×¡×™×¡ advanced; × ×©×¢× ×™× ×¢×œ in-memory gate</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>

                <span class="n">should_block</span> <span class="o">=</span> <span class="p">(</span><span class="ow">not</span> <span class="n">allowed</span><span class="p">)</span> <span class="ow">or</span> <span class="n">blocked_by_local</span>
                <span class="k">if</span> <span class="n">should_block</span><span class="p">:</span>
                    <span class="c1"># ×—×¡×™××” ×©×§×˜×” + ×”×•×“×¢×” ×§×¦×¨×”</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">cq</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s1">&#39;callback_query&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">cq</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">await</span> <span class="n">cq</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;×™×•×ª×¨ ××“×™ ×‘×§×©×•×ª, × ×¡×” ×©×•×‘ ×¢×•×“ ×¨×’×¢&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cache_time</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">msg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="k">await</span> <span class="n">msg</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âš ï¸ ×™×•×ª×¨ ××“×™ ×‘×§×©×•×ª, × ×¡×” ×©×•×‘ ×‘×¢×•×“ ××¡×¤×¨ ×©× ×™×•×ª&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">raise</span> <span class="n">ApplicationHandlerStop</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Soft-warning ×‘-80% ××”×¡×£ â€“ ×”×•×“×¢×” ××“×™×‘×” ×œ×œ× ×—×¡×™××”</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">ratio</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rate_limiter</span><span class="p">,</span> <span class="s1">&#39;get_current_usage_ratio&#39;</span><span class="p">):</span>
                            <span class="n">ratio</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rate_limiter</span><span class="o">.</span><span class="n">get_current_usage_ratio</span><span class="p">(</span><span class="n">user_id</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">ratio</span> <span class="o">&gt;=</span> <span class="mf">0.8</span><span class="p">:</span>
                            <span class="c1"># ×× ×˜×™-×¡×¤××: ××–×”×¨×” ×œ×›×œ ×”×™×•×ª×¨ ×¤×¢× ×‘×“×§×” ×œ××©×ª××©</span>
                            <span class="n">now_ts</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                            <span class="n">udata</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s1">&#39;user_data&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                            <span class="n">last_ts</span> <span class="o">=</span> <span class="mf">0.0</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">udata</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">last_ts</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">udata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_soft_warn_ts&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="ow">or</span> <span class="mf">0.0</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                    <span class="n">last_ts</span> <span class="o">=</span> <span class="mf">0.0</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">now_ts</span> <span class="o">-</span> <span class="n">last_ts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mf">60.0</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">cq</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s1">&#39;callback_query&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">cq</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                        <span class="k">await</span> <span class="n">cq</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;Heads-up: ××ª×” ××ª×§×¨×‘ ×œ××’×‘×œ×ª ×”×§×¦×‘ (80%+)&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cache_time</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">msg</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                                        <span class="k">if</span> <span class="n">msg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                            <span class="k">await</span> <span class="n">msg</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;â„¹ï¸ ×—×™×•×•×™: ××ª×” ××ª×§×¨×‘ ×œ××’×‘×œ×ª ×”×§×¦×‘. ×× ×ª××©×™×š ×‘×§×¦×‘ ×”×–×” ×™×™×ª×›×Ÿ ×©×ª×—×¡× ×–×× ×™×ª.&quot;</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                    <span class="k">pass</span>
                                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">udata</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                                    <span class="n">udata</span><span class="p">[</span><span class="s1">&#39;_soft_warn_ts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">now_ts</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>

        <span class="c1"># ×—×©×™×¤×” ×œ×¦×¨×›×™ ×‘×“×™×§×•×ª: ×©××•×¨ ×”×¤× ×™×” ×œ×©×¢×¨ ×‘×¨××ª ×”××•×‘×™×™×§×˜</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rate_limit_gate</span> <span class="o">=</span> <span class="n">_rate_limit_gate</span>

        <span class="c1"># ×”×•×¡×£ ×›×©×›×‘×ª ×¡×™× ×•×Ÿ ××•×§×“××ª ×¢×‘×•×¨ ×”×•×“×¢×•×ª ×•×œ×—×™×¦×•×ª</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">MessageHandler</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span> <span class="n">_rate_limit_gate</span><span class="p">),</span> <span class="n">group</span><span class="o">=-</span><span class="mi">90</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CallbackQueryHandler</span><span class="p">(</span><span class="n">_rate_limit_gate</span><span class="p">),</span> <span class="n">group</span><span class="o">=-</span><span class="mi">90</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># Add conversation handler</span>
        <span class="n">conversation_handler</span> <span class="o">=</span> <span class="n">get_save_conversation_handler</span><span class="p">(</span>
            <span class="n">db</span><span class="p">,</span>
            <span class="n">callback_query_handler_cls</span><span class="o">=</span><span class="n">CallbackQueryHandler</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">conversation_handler</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;ConversationHandler × ×•×¡×£&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">emit_event</span><span class="p">(</span><span class="s2">&quot;conversation_handler_added&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># ×¡×¤×•×¨ ×©×•×‘</span>
        <span class="n">handler_count_after</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">handlers</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ğŸ” ×›××•×ª handlers ××—×¨×™: </span><span class="si">{</span><span class="n">handler_count_after</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">emit_event</span><span class="p">(</span><span class="s2">&quot;handlers_count_after&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">handler_count_after</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># --- GitHub handlers - ×—×™×™×‘×™× ×œ×”×™×•×ª ×œ×¤× ×™ ×”-handler ×”×’×œ×•×‘×œ×™! ---</span>
        <span class="c1"># ×™×¦×™×¨×ª instance ×™×—×™×“ ×©×œ GitHubMenuHandler ×•×©××™×¨×” ×‘-bot_data</span>
        <span class="n">github_handler</span> <span class="o">=</span> <span class="n">GitHubMenuHandler</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">github_handler</span><span class="o">.</span><span class="n">handle_menu_callback</span> <span class="o">=</span> <span class="n">_wrap_github_callback</span><span class="p">(</span><span class="n">github_handler</span><span class="o">.</span><span class="n">handle_menu_callback</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">github_handler</span><span class="o">.</span><span class="n">handle_text_input</span> <span class="o">=</span> <span class="n">_wrap_handler_callback</span><span class="p">(</span><span class="n">github_handler</span><span class="o">.</span><span class="n">handle_text_input</span><span class="p">,</span> <span class="s2">&quot;github:text_input&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">github_handler</span><span class="o">.</span><span class="n">handle_file_upload</span> <span class="o">=</span> <span class="n">_wrap_handler_callback</span><span class="p">(</span><span class="n">github_handler</span><span class="o">.</span><span class="n">handle_file_upload</span><span class="p">,</span> <span class="s2">&quot;github:file_upload&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">bot_data</span><span class="p">[</span><span class="s1">&#39;github_handler&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">github_handler</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;âœ… GitHubMenuHandler instance created and stored in bot_data&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">emit_event</span><span class="p">(</span><span class="s2">&quot;github_handler_ready&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="c1"># ×™×¦×™×¨×ª BackupMenuHandler ×•×©××™×¨×”</span>
        <span class="n">backup_handler</span> <span class="o">=</span> <span class="n">BackupMenuHandler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">bot_data</span><span class="p">[</span><span class="s1">&#39;backup_handler&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">backup_handler</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;âœ… BackupMenuHandler instance created and stored in bot_data&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">emit_event</span><span class="p">(</span><span class="s2">&quot;backup_handler_ready&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># ×™×¦×™×¨×ª GoogleDriveMenuHandler ×•×©××™×¨×”</span>
        <span class="n">drive_handler</span> <span class="o">=</span> <span class="n">GoogleDriveMenuHandler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">bot_data</span><span class="p">[</span><span class="s1">&#39;drive_handler&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">drive_handler</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;âœ… GoogleDriveMenuHandler instance created and stored in bot_data&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">emit_event</span><span class="p">(</span><span class="s2">&quot;drive_handler_ready&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        
        <span class="c1"># ×”×•×¡×£ ×¤×§×•×“×ª github</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;github&quot;</span><span class="p">,</span> <span class="n">github_handler</span><span class="o">.</span><span class="n">github_menu_command</span><span class="p">))</span>
        <span class="c1"># ×”×•×¡×£ ×ª×¤×¨×™×˜ ×’×™×‘×•×™/×©×—×–×•×¨</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">show_backup_menu</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">backup_handler</span><span class="o">.</span><span class="n">show_backup_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;backup&quot;</span><span class="p">,</span> <span class="n">show_backup_menu</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CallbackQueryHandler</span><span class="p">(</span><span class="n">backup_handler</span><span class="o">.</span><span class="n">handle_callback_query</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^(backup_|backup_add_note:.*)&#39;</span><span class="p">))</span>
        
        <span class="c1"># ×”×•×¡×£ ××ª ×”-callbacks ×©×œ GitHub - ×—×©×•×‘! ×œ×¤× ×™ ×”-handler ×”×’×œ×•×‘×œ×™</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span>
                        <span class="n">CallbackQueryHandler</span><span class="p">(</span><span class="n">github_handler</span><span class="o">.</span><span class="n">handle_menu_callback</span><span class="p">,</span> 
                               <span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^(select_repo|upload_file|upload_saved|show_current|set_token|set_folder|close_menu|folder_|repo_|repos_page_|upload_saved_|back_to_menu|repo_manual|noop|analyze_repo|analyze_current_repo|analyze_other_repo|show_suggestions|show_full_analysis|download_analysis_json|back_to_analysis|back_to_analysis_menu|back_to_summary|choose_my_repo|enter_repo_url|suggestion_\d+|github_menu|logout_github|delete_file_menu|delete_repo_menu|confirm_delete_repo|confirm_delete_repo_step1|confirm_delete_file|danger_delete_menu|download_file_menu|browse_repo|browse_open:.*|browse_select_download:.*|browse_select_delete:.*|browse_page:.*|download_zip:.*|multi_toggle|multi_execute|multi_clear|safe_toggle|browse_toggle_select:.*|inline_download_file:.*|view_more|view_back|browse_select_view:.*|browse_ref_menu|browse_refs_branches_page_.*|browse_refs_tags_page_.*|browse_select_ref:.*|browse_search|browse_search_page:.*|notifications_menu|notifications_toggle|notifications_toggle_pr|notifications_toggle_issues|notifications_interval_.*|notifications_check_now|share_folder_link:.*|share_selected_links|pr_menu|create_pr_menu|branches_page_.*|pr_select_head:.*|confirm_create_pr|merge_pr_menu|prs_page_.*|merge_pr:.*|confirm_merge_pr|validate_repo|git_checkpoint|git_checkpoint_doc:.*|git_checkpoint_doc_skip|restore_checkpoint_menu|restore_tags_page_.*|restore_select_tag:.*|restore_branch_from_tag:.*|restore_revert_pr_from_tag:.*|restore_commit_menu|restore_commits_page_.*|restore_select_commit:.*|restore_branch_from_commit:.*|restore_revert_pr_from_commit:.*|rcb:.*|rcpr:.*|open_pr_from_branch:.*|choose_upload_branch|upload_branches_page_.*|upload_select_branch:.*|upload_select_branch_tok:.*|choose_upload_folder|upload_select_folder:.*|upload_folder_root|upload_folder_current|upload_folder_custom|upload_folder_create|create_folder|confirm_saved_upload|refresh_saved_checks|github_backup_menu|github_backup_help|github_backup_db_list|github_restore_zip_to_repo|github_restore_zip_setpurge:.*|github_restore_zip_list|github_restore_zip_from_backup:.*|github_repo_restore_backup_setpurge:.*|gh_upload_cat:.*|gh_upload_repo:.*|gh_upload_large:.*|backup_menu|github_create_repo_from_zip|github_new_repo_name|github_set_new_repo_visibility:.*|upload_paste_code|cancel_paste_flow|gh_upload_zip_browse:.*|gh_upload_zip_page:.*|gh_upload_zip_select:.*|gh_upload_zip_select_idx:.*|backup_add_note:.*|github_import_repo|import_repo_branches_page_.*|import_repo_select_branch:.*|import_repo_start|import_repo_cancel)&#39;</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># ×”×•×¡×£ ××ª ×”-callbacks ×©×œ Google Drive</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span>
            <span class="n">CallbackQueryHandler</span><span class="p">(</span>
                <span class="n">drive_handler</span><span class="o">.</span><span class="n">handle_callback</span><span class="p">,</span>
                <span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^(drive_menu|drive_auth|drive_poll_once|drive_cancel_auth|drive_backup_now|drive_sel_zip|drive_sel_all|drive_sel_adv|drive_advanced|drive_adv_by_repo|drive_adv_large|drive_adv_other|drive_choose_folder|drive_choose_folder_adv|drive_folder_default|drive_folder_auto|drive_folder_set|drive_folder_back|drive_folder_cancel|drive_schedule|drive_set_schedule:.*|drive_status|drive_adv_multi_toggle|drive_adv_upload_selected|drive_logout|drive_logout_do|drive_simple_confirm|drive_adv_confirm|drive_make_zip_now|drive_help)$&#39;</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Inline query handler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">InlineQueryHandler</span><span class="p">(</span><span class="n">github_handler</span><span class="o">.</span><span class="n">handle_inline_query</span><span class="p">))</span>
        
        <span class="c1"># ×”×’×“×¨ conversation handler ×œ×”×¢×œ××ª ×§×‘×¦×™×</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">github_menu_handler</span><span class="w"> </span><span class="kn">import</span> <span class="n">FILE_UPLOAD</span><span class="p">,</span> <span class="n">REPO_SELECT</span><span class="p">,</span> <span class="n">FOLDER_SELECT</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_upload_cancel</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cq</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s2">&quot;callback_query&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cq</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">cq</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;×”×¢×œ××” ×‘×•×˜×œ×”&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>

        <span class="n">upload_conv_handler</span> <span class="o">=</span> <span class="n">ConversationHandler</span><span class="p">(</span>
            <span class="n">entry_points</span><span class="o">=</span><span class="p">[</span>
                <span class="n">CallbackQueryHandler</span><span class="p">(</span><span class="n">github_handler</span><span class="o">.</span><span class="n">handle_menu_callback</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s1">&#39;^upload_file$&#39;</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="n">states</span><span class="o">=</span><span class="p">{</span>
                <span class="n">FILE_UPLOAD</span><span class="p">:</span> <span class="p">[</span>
                    <span class="n">MessageHandler</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">Document</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span> <span class="n">github_handler</span><span class="o">.</span><span class="n">handle_file_upload</span><span class="p">)</span>
                <span class="p">],</span>
                <span class="n">REPO_SELECT</span><span class="p">:</span> <span class="p">[</span>
                    <span class="n">MessageHandler</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">TEXT</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">filters</span><span class="o">.</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">github_handler</span><span class="o">.</span><span class="n">handle_text_input</span><span class="p">)</span>
                <span class="p">],</span>
                <span class="n">FOLDER_SELECT</span><span class="p">:</span> <span class="p">[</span>
                    <span class="n">MessageHandler</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">TEXT</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">filters</span><span class="o">.</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">github_handler</span><span class="o">.</span><span class="n">handle_text_input</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="p">},</span>
            <span class="n">fallbacks</span><span class="o">=</span><span class="p">[</span>
                <span class="n">CommandHandler</span><span class="p">(</span><span class="s1">&#39;cancel&#39;</span><span class="p">,</span> <span class="n">_upload_cancel</span><span class="p">),</span>
                <span class="n">CallbackQueryHandler</span><span class="p">(</span><span class="n">_upload_cancel</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^cancel$&#39;</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">upload_conv_handler</span><span class="p">)</span>
        
        <span class="c1"># ×”×•×¡×£ handler ×›×œ×œ×™ ×œ×˜×™×¤×•×œ ×‘×§×œ×˜ ×˜×§×¡×˜ ×©×œ GitHub (×›×•×œ×œ URL ×œ× ×™×ª×•×—)</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_github_text</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
            <span class="c1"># ×”×¢×‘×¨ ×›×œ ×§×œ×˜ ×¨×œ×•×•× ×˜×™ ×œ×× ×”×œ GitHub ×œ×¤×™ ×“×’×œ×™× ×‘-user_data</span>
            <span class="n">text</span> <span class="o">=</span> <span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">text</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">main_menu_texts</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;â• ×”×•×¡×£ ×§×•×“ ×—×“×©&quot;</span><span class="p">,</span> <span class="s2">&quot;ğŸ“š ×”×¦×’ ××ª ×›×œ ×”×§×‘×¦×™× ×©×œ×™&quot;</span><span class="p">,</span> <span class="s2">&quot;ğŸ“‚ ×§×‘×¦×™× ×’×“×•×œ×™×&quot;</span><span class="p">,</span> <span class="s2">&quot;ğŸ”§ GitHub&quot;</span><span class="p">,</span> <span class="s2">&quot;ğŸ  ×ª×¤×¨×™×˜ ×¨××©×™&quot;</span><span class="p">,</span> <span class="s2">&quot;âš¡ ×¢×™×‘×•×“ Batch&quot;</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">main_menu_texts</span><span class="p">:</span>
                <span class="c1"># × ×§×” ×“×’×œ×™× ×›×“×™ ×œ×× ×•×¢ ×˜×¨×™×’×¨ ×©×’×•×™</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;awaiting_search_text&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># ×™×¦×™××” ××•×˜×•××˜×™×ª ×&quot;××¦×‘ ×—×™×¤×•×©&quot;</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;search_ctx&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;waiting_for_repo_url&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;waiting_for_delete_file_path&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;waiting_for_download_file_path&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;waiting_for_new_repo_name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;waiting_for_selected_folder&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;waiting_for_new_folder_path&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;waiting_for_upload_folder&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;return_to_pre_upload&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="c1"># × ×§×” ×’× ×“×’×œ×™ &quot;×”×“×‘×§ ×§×•×“&quot; ×›×“×™ ×œ×¦××ª ×™×¤×” ××”×–×¨×™××”</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;waiting_for_paste_content&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;waiting_for_paste_filename&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;paste_content&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="c1"># ×–×¨×™××ª ×”×•×¡×¤×ª ×”×¢×¨×” ×œ×’×™×‘×•×™ (××©×•×ª×¤×ª ×œ-GitHub/Backup)</span>
            <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;waiting_for_backup_note_for&#39;</span><span class="p">):</span>
                <span class="n">backup_id</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;waiting_for_backup_note_for&#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">database</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span>
                    <span class="n">ok</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">save_backup_note</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">backup_id</span><span class="p">,</span> <span class="p">(</span><span class="n">text</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)[:</span><span class="mi">1000</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                            <span class="s2">&quot;âœ… ×”×”×¢×¨×” × ×©××¨×”!&quot;</span><span class="p">,</span>
                            <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">([[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×¨×”&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;backup_details:</span><span class="si">{</span><span class="n">backup_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)]])</span>
                        <span class="p">)</span>
                        <span class="c1"># ×× ×¢ ×”×•×“×¢×ª &quot;× ×¨××” ×©×–×” ×§×˜×¢ ×§×•×“!&quot; ×¢×‘×•×¨ ×”×”×•×“×¢×” ×”×–×•</span>
                        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;suppress_code_hint_once&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;âŒ ×©××™×¨×ª ×”×”×¢×¨×” × ×›×©×œ×”&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ ×©×’×™××” ×‘×©××™×¨×ª ×”×”×¢×¨×”: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="c1"># ×§×œ×˜ × ×ª×™×‘ ×™×¢×“ ×™×“× ×™ ×œ×¡×‘×™×‘×ª ×”×¢×œ××” (upload_folder_custom)</span>
            <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;waiting_for_upload_folder&#39;</span><span class="p">):</span>
                <span class="c1"># × ×™×ª×•×‘ ×˜×§×¡×˜ ×œ××˜×¤×œ ×˜×§×¡×˜×™× ×©×œ GitHub (×¡×× ×˜×™ ×•× ×§×™)</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">github_handler</span><span class="o">.</span><span class="n">handle_text_input</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;waiting_for_repo_url&#39;</span><span class="p">)</span> <span class="ow">or</span> \
               <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;waiting_for_delete_file_path&#39;</span><span class="p">)</span> <span class="ow">or</span> \
               <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;waiting_for_download_file_path&#39;</span><span class="p">)</span> <span class="ow">or</span> \
               <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;waiting_for_new_repo_name&#39;</span><span class="p">)</span> <span class="ow">or</span> \
               <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;waiting_for_selected_folder&#39;</span><span class="p">)</span> <span class="ow">or</span> \
               <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;waiting_for_new_folder_path&#39;</span><span class="p">)</span> <span class="ow">or</span> \
               <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;waiting_for_paste_content&#39;</span><span class="p">)</span> <span class="ow">or</span> \
               <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;waiting_for_paste_filename&#39;</span><span class="p">)</span> <span class="ow">or</span> \
               <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;browse_search_mode&#39;</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ğŸ”— Routing GitHub-related text input from user </span><span class="si">{</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">github_handler</span><span class="o">.</span><span class="n">handle_text_input</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># ×”×•×¡×£ ××ª ×”-handler ×¢× ×¢×“×™×¤×•×ª ×’×‘×•×”×”</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span>
            <span class="n">MessageHandler</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">TEXT</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">filters</span><span class="o">.</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">handle_github_text</span><span class="p">),</span>
            <span class="n">group</span><span class="o">=-</span><span class="mi">1</span>  <span class="c1"># ×¢×“×™×¤×•×ª ×’×‘×•×”×” ×××•×“</span>
        <span class="p">)</span>
        <span class="c1"># ×”×•×¡×£ handler ×˜×§×¡×˜ ×œ-Drive (×§×•×“ ××™×©×•×¨)</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_drive_text</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">drive_handler</span><span class="o">.</span><span class="n">handle_text</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span>
            <span class="n">MessageHandler</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">TEXT</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">filters</span><span class="o">.</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">handle_drive_text</span><span class="p">),</span>
            <span class="n">group</span><span class="o">=-</span><span class="mi">1</span>
        <span class="p">)</span>


        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;âœ… GitHub handler × ×•×¡×£ ×‘×”×¦×œ×—×”&quot;</span><span class="p">)</span>

        <span class="c1"># Handler × ×¤×¨×“ ×œ×˜×™×¤×•×œ ×‘×˜×•×§×Ÿ GitHub</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_github_token</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">text</span>
            <span class="k">if</span> <span class="n">text</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ghp_&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">text</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;github_pat_&#39;</span><span class="p">):</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
                <span class="k">if</span> <span class="n">user_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">github_handler</span><span class="o">.</span><span class="n">user_sessions</span><span class="p">:</span>
                    <span class="n">github_handler</span><span class="o">.</span><span class="n">user_sessions</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="c1"># ×©××™×¨×” ×‘×–×™×›×¨×•×Ÿ ×‘×œ×‘×“ ×œ×©×™××•×© ×©×•×˜×£</span>
                <span class="n">github_handler</span><span class="o">.</span><span class="n">user_sessions</span><span class="p">[</span><span class="n">user_id</span><span class="p">][</span><span class="s1">&#39;github_token&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span>

                <span class="c1"># ×©××•×¨ ×’× ×‘××¡×“ × ×ª×•× ×™× (×¢× ×”×¦×¤× ×” ×× ××•×’×“×¨ ××¤×ª×—)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">save_github_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>

                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                    <span class="s2">&quot;âœ… ×˜×•×§×Ÿ × ×©××¨ ×‘×”×¦×œ×—×”!</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;×›×¢×ª ×ª×•×›×œ ×œ×’×©×ª ×œ×¨×™×¤×•×–×™×˜×•×¨×™×– ×”×¤×¨×˜×™×™× ×©×œ×š.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;×©×œ×— /github ×›×“×™ ×œ×—×–×•×¨ ×œ×ª×¤×¨×™×˜.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>

        <span class="c1"># ×”×•×¡×£ ××ª ×”-handler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span>
            <span class="n">MessageHandler</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">Regex</span><span class="p">(</span><span class="s1">&#39;^(ghp_|github_pat_)&#39;</span><span class="p">),</span> <span class="n">handle_github_token</span><span class="p">),</span>
            <span class="n">group</span><span class="o">=</span><span class="mi">0</span>  <span class="c1"># ×¢×“×™×¤×•×ª ×’×‘×•×”×”</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;âœ… GitHub token handler × ×•×¡×£ ×‘×”×¦×œ×—×”&quot;</span><span class="p">)</span>

        <span class="c1"># ×¤×§×•×“×” ×œ××—×™×§×ª ×˜×•×§×Ÿ GitHub</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_github_logout</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
            <span class="c1"># ××—×™×§×” ××”××¡×“ × ×ª×•× ×™×</span>
            <span class="n">removed</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">delete_github_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="c1"># × ×™×§×•×™ ××”×¡×©×Ÿ</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">session</span> <span class="o">=</span> <span class="n">github_handler</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                <span class="n">session</span><span class="p">[</span><span class="s2">&quot;github_token&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">session</span><span class="p">[</span><span class="s1">&#39;selected_repo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">session</span><span class="p">[</span><span class="s1">&#39;selected_folder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="c1"># × ×™×§×•×™ ×§××© ×¨×™×¤×•×–×™×˜×•×¨×™×–</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;repos&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;repos_cache_time&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">removed</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;ğŸ” ×”×˜×•×§×Ÿ × ××—×§ ×‘×”×¦×œ×—×” ××”×—×©×‘×•×Ÿ ×©×œ×š.</span><span class="se">\n</span><span class="s2">âœ… ×”×•×¡×¨×• ×’× ×”×’×“×¨×•×ª ×¨×™×¤×•/×ª×™×§×™×™×”.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;â„¹ï¸ ×œ× × ××¦× ×˜×•×§×Ÿ ×œ×©×—×–×•×¨ ××• ×©××™×¨×¢×” ×©×’×™××”.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;github_logout&quot;</span><span class="p">,</span> <span class="n">handle_github_logout</span><span class="p">))</span>

        <span class="c1"># --- Guard ×’×œ×•×‘×œ×™ ×œ×œ×—×™×¦×•×ª ×›×¤×•×œ×•×ª ×¢×œ CallbackQuery (×§×“×™××•×ª ×’×‘×•×”×” ×‘×™×•×ª×¨) ---</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_global_callback_guard</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s1">&#39;callback_query&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="c1"># ×‘×“×™×§×ª ×“×•×¤×œ×™×§×˜×™× ×§×¦×¨×” ×œ×›×œ ×”×›×¤×ª×•×¨×™×</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="kn">from</span><span class="w"> </span><span class="nn">utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">CallbackQueryGuard</span>
                        <span class="k">if</span> <span class="k">await</span> <span class="n">CallbackQueryGuard</span><span class="o">.</span><span class="n">should_block_async</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="k">pass</span>
                            <span class="c1"># ×¢×¦×•×¨ ×¢×™×‘×•×“ × ×•×¡×£ ×©×œ ×”×”×•×“×¢×” ×”× ×•×›×—×™×ª</span>
                            <span class="k">raise</span> <span class="n">ApplicationHandlerStop</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
            <span class="k">except</span> <span class="n">ApplicationHandlerStop</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># ×”×•×¡×£ ××ª ×”-guard ×‘×§×‘×•×¦×” ×‘×¢×œ×ª ×¢×“×™×¤×•×ª ×”×’×‘×•×”×” ×‘×™×•×ª×¨, ×œ×¤× ×™ ×›×œ ×”-handlers (×›×•×œ×œ batch/github/drive)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CallbackQueryHandler</span><span class="p">(</span><span class="n">_global_callback_guard</span><span class="p">),</span> <span class="n">group</span><span class="o">=-</span><span class="mi">100</span><span class="p">)</span>

        <span class="c1"># ×”×•×¡×¤×ª ×¤×§×•×“×•×ª batch (×¢×™×‘×•×“ ××¨×•×‘×” ×§×‘×¦×™×) ×œ××—×¨ ×”-guard ×›×š ×©×œ× ×™×¢×§×•×£ ××•×ª×•</span>
        <span class="n">setup_batch_handlers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="p">)</span>

        <span class="c1"># --- Community Library handlers ---</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">enabled_comm</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;COMMUNITY_LIBRARY_ENABLED&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">enabled_comm</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">enabled_comm</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">conversation_handlers</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                    <span class="n">community_submit_start</span><span class="p">,</span>
                    <span class="n">community_collect_title</span><span class="p">,</span>
                    <span class="n">community_collect_description</span><span class="p">,</span>
                    <span class="n">community_collect_url</span><span class="p">,</span>
                    <span class="n">community_collect_logo</span><span class="p">,</span>
                    <span class="n">community_inline_approve</span><span class="p">,</span>
                    <span class="n">community_reject_start</span><span class="p">,</span>
                    <span class="n">community_collect_reject_reason</span><span class="p">,</span>
                    <span class="c1"># Snippet library</span>
                    <span class="n">snippet_submit_start</span><span class="p">,</span>
                    <span class="n">snippet_mode_regular_start</span><span class="p">,</span>
                    <span class="n">snippet_mode_long_start</span><span class="p">,</span>
                    <span class="n">snippet_collect_title</span><span class="p">,</span>
                    <span class="n">snippet_collect_description</span><span class="p">,</span>
                    <span class="n">snippet_collect_code</span><span class="p">,</span>
                    <span class="n">snippet_collect_language</span><span class="p">,</span>
                    <span class="n">snippet_long_collect_receive</span><span class="p">,</span>
                    <span class="n">snippet_long_collect_done</span><span class="p">,</span>
                    <span class="n">snippet_inline_approve</span><span class="p">,</span>
                    <span class="n">snippet_reject_start</span><span class="p">,</span>
                    <span class="n">snippet_collect_reject_reason</span><span class="p">,</span>
                    <span class="n">show_community_hub</span><span class="p">,</span>
                    <span class="n">community_catalog_menu</span><span class="p">,</span>
                    <span class="n">snippets_menu</span><span class="p">,</span>
                    <span class="c1"># New helpers</span>
                    <span class="n">community_hub_callback</span><span class="p">,</span>
                    <span class="n">main_menu_callback</span><span class="p">,</span>
                    <span class="n">submit_flows_cancel</span><span class="p">,</span>
                    <span class="n">cancel</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">handlers.states</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                    <span class="n">CL_COLLECT_TITLE</span><span class="p">,</span>
                    <span class="n">CL_COLLECT_DESCRIPTION</span><span class="p">,</span>
                    <span class="n">CL_COLLECT_URL</span><span class="p">,</span>
                    <span class="n">CL_COLLECT_LOGO</span><span class="p">,</span>
                    <span class="n">CL_REJECT_REASON</span><span class="p">,</span>
                    <span class="n">SN_COLLECT_TITLE</span><span class="p">,</span>
                    <span class="n">SN_COLLECT_DESCRIPTION</span><span class="p">,</span>
                    <span class="n">SN_COLLECT_CODE</span><span class="p">,</span>
                    <span class="n">SN_COLLECT_LANGUAGE</span><span class="p">,</span>
                    <span class="n">SN_REJECT_REASON</span><span class="p">,</span>
                    <span class="n">SN_LONG_COLLECT</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="c1"># Approve via inline button (admin-only wrapper inside function)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CallbackQueryHandler</span><span class="p">(</span><span class="n">community_inline_approve</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^community_approve:&#39;</span><span class="p">))</span>
                <span class="c1"># Community inline reject (reason collection)</span>
                <span class="n">cl_reject_conv</span> <span class="o">=</span> <span class="n">ConversationHandler</span><span class="p">(</span>
                    <span class="n">entry_points</span><span class="o">=</span><span class="p">[</span><span class="n">CallbackQueryHandler</span><span class="p">(</span><span class="n">community_reject_start</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^community_reject:&#39;</span><span class="p">)],</span>
                    <span class="n">states</span><span class="o">=</span><span class="p">{</span>
                        <span class="n">CL_REJECT_REASON</span><span class="p">:</span> <span class="p">[</span><span class="n">MessageHandler</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">TEXT</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">filters</span><span class="o">.</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">community_collect_reject_reason</span><span class="p">)],</span>
                    <span class="p">},</span>
                    <span class="n">fallbacks</span><span class="o">=</span><span class="p">[</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s1">&#39;cancel&#39;</span><span class="p">,</span> <span class="n">_cancel_command_fallback</span><span class="p">)],</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">cl_reject_conv</span><span class="p">)</span>
                <span class="c1"># Snippet inline approve</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CallbackQueryHandler</span><span class="p">(</span><span class="n">snippet_inline_approve</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^snippet_approve:&#39;</span><span class="p">))</span>
                <span class="c1"># Submission flow</span>
                <span class="n">_logo_message_filter</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">TEXT</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">filters</span><span class="o">.</span><span class="n">COMMAND</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">_photo_filter</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">filters</span><span class="p">,</span> <span class="s2">&quot;PHOTO&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">_photo_filter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">_logo_message_filter</span> <span class="o">=</span> <span class="p">(</span><span class="n">_photo_filter</span> <span class="o">|</span> <span class="n">filters</span><span class="o">.</span><span class="n">TEXT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">filters</span><span class="o">.</span><span class="n">COMMAND</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="c1"># ×× ×—×™×‘×•×¨ ×”×¤×™×œ×˜×¨×™× × ×›×©×œ (×œ××©×œ ×‘×¡×‘×™×‘×ª ×˜×¡×˜×™× ×¢× ×¡×˜××‘×™× ×¤×©×•×˜×™×),</span>
                    <span class="c1"># ×ª×™×©××¨ ×¨×§ ×‘×“×™×§×” ×¢×œ ×˜×§×¡×˜. ×—×©×•×‘ ×©×”-handler ×¢×“×™×™×Ÿ ×™×™×¨×©×.</span>
                    <span class="n">_logo_message_filter</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">TEXT</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">filters</span><span class="o">.</span><span class="n">COMMAND</span>

                <span class="c1"># ×“×¤×•×¡ ×˜×§×¡×˜×™× ×©×œ ×”×ª×¤×¨×™×˜ ×”×¨××©×™ ×œ×‘×™×˜×•×œ ××•×˜×•××˜×™ ×‘××”×œ×š ×ª×”×œ×™×›×™ ×”×’×©×”</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">import</span><span class="w"> </span><span class="nn">re</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_re</span>
                    <span class="n">_flat_main_menu</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">MAIN_KEYBOARD</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">row</span><span class="p">]</span>
                    <span class="n">_main_menu_regex</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;^(&#39;</span> <span class="o">+</span> <span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">_flat_main_menu</span><span class="p">)</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;)$&#39;</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">_main_menu_regex</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;^(?:)$&#39;</span>  <span class="c1"># fallback: ×œ× ×ª×•×¤×¡ ×›×œ×•× ×‘××§×¨×” ×©×œ ×›×©×œ</span>

                <span class="n">comm_conv</span> <span class="o">=</span> <span class="n">ConversationHandler</span><span class="p">(</span>
                    <span class="n">entry_points</span><span class="o">=</span><span class="p">[</span><span class="n">CallbackQueryHandler</span><span class="p">(</span><span class="n">community_submit_start</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^community_submit$&#39;</span><span class="p">)],</span>
                    <span class="n">states</span><span class="o">=</span><span class="p">{</span>
                        <span class="n">CL_COLLECT_TITLE</span><span class="p">:</span> <span class="p">[</span><span class="n">MessageHandler</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">TEXT</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">filters</span><span class="o">.</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">community_collect_title</span><span class="p">)],</span>
                        <span class="n">CL_COLLECT_DESCRIPTION</span><span class="p">:</span> <span class="p">[</span><span class="n">MessageHandler</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">TEXT</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">filters</span><span class="o">.</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">community_collect_description</span><span class="p">)],</span>
                        <span class="n">CL_COLLECT_URL</span><span class="p">:</span> <span class="p">[</span><span class="n">MessageHandler</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">TEXT</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">filters</span><span class="o">.</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">community_collect_url</span><span class="p">)],</span>
                        <span class="n">CL_COLLECT_LOGO</span><span class="p">:</span> <span class="p">[</span><span class="n">MessageHandler</span><span class="p">(</span><span class="n">_logo_message_filter</span><span class="p">,</span> <span class="n">community_collect_logo</span><span class="p">)],</span>
                    <span class="p">},</span>
                    <span class="n">fallbacks</span><span class="o">=</span><span class="p">[</span>
                        <span class="n">CommandHandler</span><span class="p">(</span><span class="s1">&#39;cancel&#39;</span><span class="p">,</span> <span class="n">_cancel_command_fallback</span><span class="p">),</span>
                        <span class="n">CallbackQueryHandler</span><span class="p">(</span><span class="n">submit_flows_cancel</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^cancel$&#39;</span><span class="p">),</span>
                        <span class="c1"># ×‘×™×˜×•×œ ××•×˜×•××˜×™ ×›××©×¨ ×”××©×ª××© ×œ×•×—×¥ ×¢×œ ×›×¤×ª×•×¨ ××—×¨ ×‘×ª×¤×¨×™×˜ ×”×¨××©×™</span>
                        <span class="n">MessageHandler</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">Regex</span><span class="p">(</span><span class="n">_main_menu_regex</span><span class="p">),</span> <span class="n">cancel</span><span class="p">),</span>
                    <span class="p">],</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">comm_conv</span><span class="p">)</span>
                <span class="c1"># Snippet submission flow</span>
                <span class="n">sn_conv</span> <span class="o">=</span> <span class="n">ConversationHandler</span><span class="p">(</span>
                    <span class="n">entry_points</span><span class="o">=</span><span class="p">[</span>
                        <span class="n">CallbackQueryHandler</span><span class="p">(</span><span class="n">snippet_submit_start</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^snippet_submit$&#39;</span><span class="p">),</span>
                        <span class="n">CallbackQueryHandler</span><span class="p">(</span><span class="n">snippet_mode_regular_start</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^snippet_mode_regular$&#39;</span><span class="p">),</span>
                        <span class="n">CallbackQueryHandler</span><span class="p">(</span><span class="n">snippet_mode_long_start</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^snippet_mode_long$&#39;</span><span class="p">),</span>
                    <span class="p">],</span>
                    <span class="n">states</span><span class="o">=</span><span class="p">{</span>
                        <span class="n">SN_COLLECT_TITLE</span><span class="p">:</span> <span class="p">[</span><span class="n">MessageHandler</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">TEXT</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">filters</span><span class="o">.</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">snippet_collect_title</span><span class="p">)],</span>
                        <span class="n">SN_COLLECT_DESCRIPTION</span><span class="p">:</span> <span class="p">[</span><span class="n">MessageHandler</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">TEXT</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">filters</span><span class="o">.</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">snippet_collect_description</span><span class="p">)],</span>
                        <span class="n">SN_COLLECT_CODE</span><span class="p">:</span> <span class="p">[</span><span class="n">MessageHandler</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">TEXT</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">filters</span><span class="o">.</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">snippet_collect_code</span><span class="p">)],</span>
                        <span class="n">SN_COLLECT_LANGUAGE</span><span class="p">:</span> <span class="p">[</span><span class="n">MessageHandler</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">TEXT</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">filters</span><span class="o">.</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">snippet_collect_language</span><span class="p">)],</span>
                        <span class="n">SN_LONG_COLLECT</span><span class="p">:</span> <span class="p">[</span>
                            <span class="n">MessageHandler</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">TEXT</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">filters</span><span class="o">.</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">snippet_long_collect_receive</span><span class="p">),</span>
                            <span class="n">CommandHandler</span><span class="p">(</span><span class="s1">&#39;done&#39;</span><span class="p">,</span> <span class="n">snippet_long_collect_done</span><span class="p">),</span>
                        <span class="p">],</span>
                    <span class="p">},</span>
                    <span class="n">fallbacks</span><span class="o">=</span><span class="p">[</span>
                        <span class="n">CommandHandler</span><span class="p">(</span><span class="s1">&#39;cancel&#39;</span><span class="p">,</span> <span class="n">_cancel_command_fallback</span><span class="p">),</span>
                        <span class="n">CallbackQueryHandler</span><span class="p">(</span><span class="n">submit_flows_cancel</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^cancel$&#39;</span><span class="p">),</span>
                        <span class="c1"># ×‘×™×˜×•×œ ××•×˜×•××˜×™ ×›××©×¨ ×”××©×ª××© ×œ×•×—×¥ ×¢×œ ×›×¤×ª×•×¨ ××—×¨ ×‘×ª×¤×¨×™×˜ ×”×¨××©×™</span>
                        <span class="n">MessageHandler</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">Regex</span><span class="p">(</span><span class="n">_main_menu_regex</span><span class="p">),</span> <span class="n">cancel</span><span class="p">),</span>
                    <span class="p">],</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">sn_conv</span><span class="p">)</span>
                <span class="c1"># Snippet reject reason flow</span>
                <span class="n">sn_reject_conv</span> <span class="o">=</span> <span class="n">ConversationHandler</span><span class="p">(</span>
                    <span class="n">entry_points</span><span class="o">=</span><span class="p">[</span><span class="n">CallbackQueryHandler</span><span class="p">(</span><span class="n">snippet_reject_start</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^snippet_reject:&#39;</span><span class="p">)],</span>
                    <span class="n">states</span><span class="o">=</span><span class="p">{</span>
                        <span class="n">SN_REJECT_REASON</span><span class="p">:</span> <span class="p">[</span><span class="n">MessageHandler</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">TEXT</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">filters</span><span class="o">.</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">snippet_collect_reject_reason</span><span class="p">)],</span>
                    <span class="p">},</span>
                    <span class="n">fallbacks</span><span class="o">=</span><span class="p">[</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s1">&#39;cancel&#39;</span><span class="p">,</span> <span class="n">_cancel_command_fallback</span><span class="p">)],</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">sn_reject_conv</span><span class="p">)</span>
                <span class="c1"># Community hub menus</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">MessageHandler</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">Regex</span><span class="p">(</span><span class="s2">&quot;^ğŸ—ƒï¸ ××•×¡×£ ×”×§×”×™×œ×”$&quot;</span><span class="p">),</span> <span class="n">show_community_hub</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CallbackQueryHandler</span><span class="p">(</span><span class="n">community_catalog_menu</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^community_catalog_menu$&#39;</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CallbackQueryHandler</span><span class="p">(</span><span class="n">snippets_menu</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^snippets_menu$&#39;</span><span class="p">))</span>
                <span class="c1"># Back navigation helpers</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CallbackQueryHandler</span><span class="p">(</span><span class="n">community_hub_callback</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^community_hub$&#39;</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CallbackQueryHandler</span><span class="p">(</span><span class="n">main_menu_callback</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^main_menu$&#39;</span><span class="p">))</span>
                <span class="c1"># Global cancel for submission flows (works also on entry screen)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CallbackQueryHandler</span><span class="p">(</span><span class="n">submit_flows_cancel</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^cancel$&#39;</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">_e</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Community library handlers not registered: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">_e</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="c1"># ×”×•×¡×¤×ª Refactoring handlers (×× ×–××™× ×™×)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">refactor_handlers</span><span class="w"> </span><span class="kn">import</span> <span class="n">setup_refactor_handlers</span> <span class="k">as</span> <span class="n">_setup_rf</span>
            <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">_setup_rf</span><span class="p">):</span>
                <span class="n">_setup_rf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;âœ… RefactorHandlers ×”×•×’×“×¨×• (×¤×§×•×“×ª /refactor ×–××™× ×”)&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âš ï¸ ×“×™×œ×•×’ ×¢×œ RefactorHandlers: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># --- ×¨×§ ××—×¨×™ ×›×œ ×”-handlers ×”×¡×¤×¦×™×¤×™×™×, ×”×•×¡×£ ××ª ×”-handler ×”×’×œ×•×‘×œ×™ ---</span>
        <span class="c1"># ×—×©×•×‘: ×”×•×¡×¤×” ×‘×§×‘×•×¦×” ×××•×—×¨×ª ×›×“×™ ×©×œ× ×ª×ª×¤×•×¡ ×œ×¤× ×™ handlers ×™×™×¢×•×“×™×™× (×œ××©×œ ××•×¢×“×¤×™×)</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">conversation_handlers</span><span class="w"> </span><span class="kn">import</span> <span class="n">handle_callback_query</span>
        <span class="n">_register_catch_all_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="p">,</span> <span class="n">handle_callback_query</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">_instrument_command_handlers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># ×¡×¤×•×¨ ×¡×•×¤×™</span>
        <span class="n">final_handler_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">handlers</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ğŸ” ×›××•×ª handlers ×¡×•×¤×™×ª: </span><span class="si">{</span><span class="n">final_handler_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># ×”×“×¤×¡ ××ª ×›×œ ×”-handlers</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">handler</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">handlers</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Handler </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># --- ×©×œ×‘ 2: ×¨×™×©×•× ×©××¨ ×”×¤×§×•×“×•×ª ---</span>
        <span class="c1"># ×¤×§×•×“×ª ×× ×”×œ×™×: recycle_backfill</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;recycle_backfill&quot;</span><span class="p">,</span> <span class="n">recycle_backfill_command</span><span class="p">))</span>
        <span class="c1"># ×¤×§×•×“×•×ª ×× ×”×œ×™ ×¡×¤×¨×™×™×ª ×§×”×™×œ×”</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">enabled_comm</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;COMMUNITY_LIBRARY_ENABLED&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">enabled_comm</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">enabled_comm</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">conversation_handlers</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                    <span class="n">community_queue_command</span><span class="p">,</span> <span class="n">community_approve_command</span><span class="p">,</span> <span class="n">community_reject_command</span><span class="p">,</span>
                    <span class="n">snippet_queue_command</span><span class="p">,</span> <span class="n">snippet_approve_command</span><span class="p">,</span> <span class="n">snippet_reject_command</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;community_queue&quot;</span><span class="p">,</span> <span class="n">community_queue_command</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;community_approve&quot;</span><span class="p">,</span> <span class="n">community_approve_command</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;community_reject&quot;</span><span class="p">,</span> <span class="n">community_reject_command</span><span class="p">))</span>
                <span class="c1"># Snippet admin commands</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;snippet_queue&quot;</span><span class="p">,</span> <span class="n">snippet_queue_command</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;snippet_approve&quot;</span><span class="p">,</span> <span class="n">snippet_approve_command</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;snippet_reject&quot;</span><span class="p">,</span> <span class="n">snippet_reject_command</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="c1"># ×”×¤×§×•×“×” /start ×”××§×•×¨×™×ª ×”×•×¤×›×ª ×œ×”×™×•×ª ×—×œ×§ ××”-conv_handler, ××– ×”×™× ×œ× ×›××Ÿ.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;help&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">help_command</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;save&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_command</span><span class="p">))</span>
        <span class="c1"># self.application.add_handler(CommandHandler(&quot;list&quot;, self.list_command))  # ××—×•×§ - ××˜×•×¤×œ ×¢×œ ×™×“×™ ×”×›×¤×ª×•×¨ &quot;ğŸ“š ×”×¦×’ ××ª ×›×œ ×”×§×‘×¦×™× ×©×œ×™&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;search&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_command</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;stats&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats_command</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;check&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_commands</span><span class="p">))</span>
        
        <span class="c1"># ×”×•×¡×¤×ª ×¤×§×•×“×•×ª cache</span>
        <span class="n">setup_cache_handlers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="p">)</span>
        
        <span class="c1"># ×”×•×¡×¤×ª ×¤×§×•×“×•×ª ××©×•×¤×¨×•×ª (××•×˜×•-×”×©×œ××” ×•×ª×¦×•×’×” ××§×“×™××”) - disabled</span>
        <span class="c1"># setup_enhanced_handlers(self.application)</span>

        <span class="c1"># ×”×˜×¨××™× ×œ ×”×•×¡×¨ ×‘×¡×‘×™×‘×ª Render (Docker ×œ× ×–××™×Ÿ)</span>


        <span class="c1"># ×”×•×¡×¤×ª handlers ×œ×›×¤×ª×•×¨×™× ×”×—×“×©×™× ×‘××§×œ×“×ª ×”×¨××©×™×ª</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">conversation_handlers</span><span class="w"> </span><span class="kn">import</span> <span class="n">handle_batch_button</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">MessageHandler</span><span class="p">(</span>
            <span class="n">filters</span><span class="o">.</span><span class="n">Regex</span><span class="p">(</span><span class="s2">&quot;^âš¡ ×¢×™×‘×•×“ Batch$&quot;</span><span class="p">),</span> 
            <span class="n">handle_batch_button</span>
        <span class="p">))</span>
        <span class="c1"># ×›×¤×ª×•×¨ ×œ×ª×¤×¨×™×˜ Google Drive</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">show_drive_menu</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">drive_handler</span><span class="o">.</span><span class="n">menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">MessageHandler</span><span class="p">(</span>
            <span class="n">filters</span><span class="o">.</span><span class="n">Regex</span><span class="p">(</span><span class="s2">&quot;^â˜ï¸ Google Drive$&quot;</span><span class="p">),</span>
            <span class="n">show_drive_menu</span>
        <span class="p">))</span>

        <span class="c1"># ×¤×§×•×“×” /drive</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;drive&quot;</span><span class="p">,</span> <span class="n">show_drive_menu</span><span class="p">))</span>
        
        <span class="c1"># ×›×¤×ª×•×¨ Web App</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">show_webapp</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
            <span class="n">webapp_url</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;WEBAPP_URL&#39;</span><span class="p">,</span> <span class="s1">&#39;https://code-keeper-webapp.onrender.com&#39;</span><span class="p">)</span>
            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸŒ ×¤×ª×— ××ª ×”-Web App&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">webapp_url</span><span class="p">)],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ” ×”×ª×—×‘×¨ ×œ-Web App&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">webapp_url</span><span class="si">}</span><span class="s2">/login&quot;</span><span class="p">)]</span>
            <span class="p">]</span>
            <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;ğŸŒ &lt;b&gt;Web App - ×××©×§ × ×™×”×•×œ ××ª×§×“×&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;×¦×¤×” ×•× ×”×œ ××ª ×›×œ ×”×§×‘×¦×™× ×©×œ×š ×“×¨×š ×”×“×¤×“×¤×Ÿ:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;â€¢ ğŸ“Š ×“×©×‘×•×¨×“ ×¢× ×¡×˜×˜×™×¡×˜×™×§×•×ª</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;â€¢ ğŸ” ×—×™×¤×•×© ×•×¡×™× ×•×Ÿ ××ª×§×“×</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;â€¢ ğŸ‘ï¸ ×¦×¤×™×™×” ×‘×§×‘×¦×™× ×¢× ×”×“×’×©×ª syntax</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;â€¢ ğŸ“¥ ×”×•×¨×“×ª ×§×‘×¦×™×</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;â€¢ ğŸ“± ×¢×•×‘×“ ×‘×›×œ ××›×©×™×¨</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;×œ×—×¥ ×¢×œ ×”×›×¤×ª×•×¨ ×œ××˜×” ×›×“×™ ×œ×¤×ª×•×—:&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span>
            <span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">MessageHandler</span><span class="p">(</span>
            <span class="n">filters</span><span class="o">.</span><span class="n">Regex</span><span class="p">(</span><span class="s2">&quot;^ğŸŒ Web App$&quot;</span><span class="p">),</span>
            <span class="n">show_webapp</span>
        <span class="p">))</span>
        
        <span class="c1"># ×¤×§×•×“×” /webapp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;webapp&quot;</span><span class="p">,</span> <span class="n">show_webapp</span><span class="p">))</span>
        
        <span class="c1"># ×›×¤×ª×•×¨ ×—×“×© ×œ×ª×¤×¨×™×˜ ×’×™×‘×•×™/×©×—×–×•×¨</span>

        <span class="c1"># ×¤×§×•×“×” /docs â€“ ×©×œ×™×—×ª ×§×™×©×•×¨ ×œ×ª×™×¢×•×“</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">show_docs</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ğŸ“š ×ª×™×¢×•×“: </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">DOCUMENTATION_URL</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;docs&quot;</span><span class="p">,</span> <span class="n">show_docs</span><span class="p">))</span>
        <span class="c1"># ×”×•×¡×¨: ×›×¤×ª×•×¨×™ ×’×™×‘×•×™/×©×—×–×•×¨ ××”××§×œ×“×ª ×”×¨××©×™×ª. ×›×¢×ª ×ª×—×ª /github -&gt; ğŸ§° ×’×™×‘×•×™ ×•×©×—×–×•×¨</span>
        <span class="c1"># self.application.add_handler(MessageHandler(</span>
        <span class="c1">#     filters.Regex(&quot;^(ğŸ“¦ ×’×™×‘×•×™ ××œ×|â™»ï¸ ×©×—×–×•×¨ ××’×™×‘×•×™|ğŸ§° ×’×™×‘×•×™/×©×—×–×•×¨)$&quot;),</span>
        <span class="c1">#     show_backup_menu</span>
        <span class="c1"># ))</span>
        
        <span class="c1"># --- ×©×œ×‘ 3: ×¨×™×©×•× handler ×œ×§×‘×¦×™× ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span>
            <span class="n">MessageHandler</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">Document</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_document</span><span class="p">)</span>
        <span class="p">)</span>
        
        <span class="c1"># --- ×©×œ×‘ 4: ×¨×™×©×•× ×”××˜×¤×œ ×”×›×œ×œ×™ ×‘×¡×•×£ ---</span>
        <span class="c1"># ×”×•× ×™×¤×¢×œ ×¨×§ ×× ××£ ××—×“ ××”××˜×¤×œ×™× ×”×¡×¤×¦×™×¤×™×™× ×™×•×ª×¨ ×œ× ×ª×¤×¡ ××ª ×”×”×•×“×¢×”.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span>
            <span class="n">MessageHandler</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">TEXT</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">filters</span><span class="o">.</span><span class="n">COMMAND</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_text_message</span><span class="p">)</span>
        <span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_instrument_command_handlers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># --- ×©×œ×‘ 5: ×˜×™×¤×•×œ ×‘×©×’×™××•×ª ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_error_handler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="p">)</span></div>

    
    <span class="c1"># start_command ×”×•×¡×¨ - ConversationHandler ××˜×¤×œ ×‘×¤×§×•×“×ª /start</span>
    
<div class="viewcode-block" id="CodeKeeperBot.help_command">
<a class="viewcode-back" href="../api/main.html#main.CodeKeeperBot.help_command">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">help_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×¤×§×•×“×ª ×¢×–×¨×” ××¤×•×¨×˜×ª&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">reporter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">log_user_activity</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="n">ctx_app</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ctx_commands</span> <span class="o">=</span> <span class="n">_get_registered_commands</span><span class="p">(</span><span class="n">ctx_app</span><span class="p">)</span> <span class="k">if</span> <span class="n">ctx_app</span> <span class="k">else</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ctx_commands</span><span class="p">:</span>
            <span class="n">commands</span> <span class="o">=</span> <span class="n">ctx_commands</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">commands</span> <span class="o">=</span> <span class="n">_get_registered_commands</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">_build_help_message</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">,</span> <span class="n">disable_web_page_preview</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="CodeKeeperBot.save_command">
<a class="viewcode-back" href="../api/main.html#main.CodeKeeperBot.save_command">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">save_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×¤×§×•×“×ª ×©××™×¨×ª ×§×•×“&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">reporter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">log_user_activity</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;â“ ×× × ×¦×™×™×Ÿ ×©× ×§×•×‘×¥:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;×“×•×’××”: `/save script.py`</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;×¢× ×ª×’×™×•×ª: `/save script.py #python #api`&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># ×¤×¨×¡×•×¨ ×©× ×§×•×‘×¥ ×•×ª×’×™×•×ª</span>
        <span class="n">args</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># ×—×™×œ×•×¥ ×ª×’×™×•×ª</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
        <span class="n">tag_matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;#(\w+)&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tag_matches</span><span class="p">:</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="n">tag_matches</span>
            <span class="c1"># ×”×¡×¨×ª ×”×ª×’×™×•×ª ××©× ×”×§×•×‘×¥</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;#\w+&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">args</span>
        
        <span class="c1"># ×©××™×¨×ª ××™×“×¢ ×‘×”×§×©×¨ ×œ××©×š ×”×©×™×—×”</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;saving_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;file_name&#39;</span><span class="p">:</span> <span class="n">file_name</span><span class="p">,</span>
            <span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="n">tags</span><span class="p">,</span>
            <span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="n">user_id</span>
        <span class="p">}</span>
        
        <span class="n">safe_file_name</span> <span class="o">=</span> <span class="n">html_escape</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
        <span class="n">safe_tags</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">html_escape</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">)</span> <span class="k">if</span> <span class="n">tags</span> <span class="k">else</span> <span class="s1">&#39;×œ×œ×&#39;</span>
        
        <span class="c1"># ×‘×§×©×ª ×§×•×“ ×•×œ××—×¨×™×• ×”×¢×¨×” ××•×¤×¦×™×•× ×œ×™×ª</span>
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;ğŸ“ ××•×›×Ÿ ×œ×©××•×¨ ××ª &lt;code&gt;</span><span class="si">{</span><span class="n">safe_file_name</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;ğŸ·ï¸ ×ª×’×™×•×ª: </span><span class="si">{</span><span class="n">safe_tags</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;×× × ×©×œ×— ××ª ×§×˜×¢ ×”×§×•×“:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;(××—×¨×™ ×©× ×§×‘×œ ××ª ×”×§×•×“, ××©××œ ×× ×ª×¨×¦×” ×œ×”×•×¡×™×£ ×”×¢×¨×”)&quot;</span><span class="p">,</span>
            <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span>
        <span class="p">)</span></div>

    
<div class="viewcode-block" id="CodeKeeperBot.list_command">
<a class="viewcode-back" href="../api/main.html#main.CodeKeeperBot.list_command">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">list_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×”×¦×’×ª ×¨×©×™××ª ×”×§×˜×¢×™× ×©×œ ×”××©×ª××©&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">reporter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        
        <span class="n">files</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user_files</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;ğŸ“‚ ×¢×“×™×™×Ÿ ×œ× ×©××¨×ª ×§×˜×¢×™ ×§×•×“.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;×”×©×ª××© ×‘/save ×›×“×™ ×œ×”×ª×—×™×œ!&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># ×‘× ×™×™×ª ×”×¨×©×™××”</span>
        <span class="n">response</span> <span class="o">=</span> <span class="s2">&quot;ğŸ“‹ **×”×§×˜×¢×™× ×©×œ×š:**</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">file_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">tags_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="p">[]))</span> <span class="k">if</span> <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="n">description</span> <span class="o">=</span> <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            
            <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;**</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">**</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;ğŸ”¤ ×©×¤×”: </span><span class="si">{</span><span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;programming_language&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            
            <span class="k">if</span> <span class="n">description</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;ğŸ“ ×ª×™××•×¨: </span><span class="si">{</span><span class="n">description</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            
            <span class="k">if</span> <span class="n">tags_str</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;ğŸ·ï¸ ×ª×’×™×•×ª: </span><span class="si">{</span><span class="n">tags_str</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            
            <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;ğŸ“… ×¢×•×“×›×Ÿ: </span><span class="si">{</span><span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;updated_at&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/%m/%Y %H:%M&#39;</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;ğŸ”¢ ×’×¨×¡×”: </span><span class="si">{</span><span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">20</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ğŸ“„ ××•×¦×’×™× 20 ×”×§×˜×¢×™× ×”××—×¨×•× ×™×. ×”×©×ª××© ×‘×—×™×¤×•×© ×œ×¢×•×“...&quot;</span>
        
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="CodeKeeperBot.search_command">
<a class="viewcode-back" href="../api/main.html#main.CodeKeeperBot.search_command">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">search_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×—×™×¤×•×© ×§×˜×¢×™ ×§×•×“&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">reporter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">log_user_activity</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;ğŸ” **××™×š ×œ×—×¤×©:**</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;â€¢ `/search python` - ×œ×¤×™ ×©×¤×”</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;â€¢ `/search api` - ×—×™×¤×•×© ×—×•×¤×©×™</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;â€¢ `/search #automation` - ×œ×¤×™ ×ª×’×™×ª</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;â€¢ `/search script` - ×‘×©× ×§×•×‘×¥&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        
        <span class="c1"># ×–×™×”×•×™ ×× ×–×” ×—×™×¤×•×© ×œ×¤×™ ×ª×’×™×ª</span>
        <span class="n">tags</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># ×ª××™×›×” ×‘×’×¨×¡××•×ª ×™×©× ×•×ª ×©×œ ×”×§×•× ×¤×™×’ ×©×œ× ×›×•×œ×œ×•×ª SUPPORTED_LANGUAGES</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">supported_languages</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;SUPPORTED_LANGUAGES&quot;</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">supported_languages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">normalized_languages</span> <span class="o">=</span> <span class="p">{</span><span class="n">lang</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="n">lang</span> <span class="k">for</span> <span class="n">lang</span> <span class="ow">in</span> <span class="n">supported_languages</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="nb">str</span><span class="p">)}</span>

        <span class="n">language_filter</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">search_term</span> <span class="o">=</span> <span class="n">query</span>

        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">query</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
            <span class="n">search_term</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">matched_language</span> <span class="o">=</span> <span class="n">normalized_languages</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> <span class="k">if</span> <span class="n">normalized_languages</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">matched_language</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">language_filter</span> <span class="o">=</span> <span class="n">matched_language</span>
                <span class="n">search_term</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="n">language_filter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># ×—×™×¤×•×© ×œ×¤×™ ×©×¤×”</span>
            <span class="k">with</span> <span class="n">track_performance</span><span class="p">(</span><span class="s2">&quot;search_by_language&quot;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;operation&quot;</span><span class="p">:</span> <span class="s2">&quot;search_by_language&quot;</span><span class="p">}):</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">search_code</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">programming_language</span><span class="o">=</span><span class="n">language_filter</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># ×—×™×¤×•×© ×—×•×¤×©×™ ××• ×œ×¤×™ ×ª×’×™×ª</span>
            <span class="k">with</span> <span class="n">track_performance</span><span class="p">(</span><span class="s2">&quot;search_free&quot;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;operation&quot;</span><span class="p">:</span> <span class="s2">&quot;search_free&quot;</span><span class="p">}):</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">search_code</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">search_term</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">results</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ” ×œ× × ××¦××• ×ª×•×¦××•×ª ×¢×‘×•×¨: &lt;code&gt;</span><span class="si">{</span><span class="n">html_escape</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">))</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># Business metric: search performed (avoid logging raw query)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">track_search_performed</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">),</span> <span class="n">results_count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">))</span>
            <span class="n">emit_event</span><span class="p">(</span>
                <span class="s2">&quot;search_performed&quot;</span><span class="p">,</span>
                <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span>
                <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
                <span class="n">query_length</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">)),</span>
                <span class="n">results_count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># ×”×¦×’×ª ×ª×•×¦××•×ª</span>
        <span class="n">safe_query</span> <span class="o">=</span> <span class="n">html_escape</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>
        <span class="n">response</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ğŸ” **×ª×•×¦××•×ª ×—×™×¤×•×© ×¢×‘×•×¨:** &lt;code&gt;</span><span class="si">{</span><span class="n">safe_query</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">file_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">results</span><span class="p">[:</span><span class="mi">10</span><span class="p">],</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. &lt;code&gt;</span><span class="si">{</span><span class="n">html_escape</span><span class="p">(</span><span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&lt;/code&gt; â€” </span><span class="si">{</span><span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;programming_language&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ğŸ“„ ××•×¦×’×•×ª 10 ××ª×•×š </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="s2"> ×ª×•×¦××•×ª&quot;</span>
        
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="CodeKeeperBot.check_commands">
<a class="viewcode-back" href="../api/main.html#main.CodeKeeperBot.check_commands">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">check_commands</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×‘×“×™×§×ª ×”×¤×§×•×“×•×ª ×”×–××™× ×•×ª (×¨×§ ×œ×××™×¨)&quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="mi">6865105071</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="c1"># ×‘×“×•×§ ×¤×§×•×“×•×ª ×¦×™×‘×•×¨×™×•×ª</span>
        <span class="n">public_cmds</span> <span class="o">=</span> <span class="k">await</span> <span class="n">context</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">get_my_commands</span><span class="p">()</span>
        
        <span class="c1"># ×‘×“×•×§ ×¤×§×•×“×•×ª ××™×©×™×•×ª</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">telegram</span><span class="w"> </span><span class="kn">import</span> <span class="n">BotCommandScopeChat</span>
        <span class="n">personal_cmds</span> <span class="o">=</span> <span class="k">await</span> <span class="n">context</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">get_my_commands</span><span class="p">(</span>
            <span class="n">scope</span><span class="o">=</span><span class="n">BotCommandScopeChat</span><span class="p">(</span><span class="n">chat_id</span><span class="o">=</span><span class="mi">6865105071</span><span class="p">)</span>
        <span class="p">)</span>
        
        <span class="kn">from</span><span class="w"> </span><span class="nn">html</span><span class="w"> </span><span class="kn">import</span> <span class="n">escape</span> <span class="k">as</span> <span class="n">html_escape</span>

        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;ğŸ“‹ &lt;b&gt;×¡×˜×˜×•×¡ ×¤×§×•×“×•×ª&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;×¡×™×›×•×: ×¦×™×‘×•×¨×™×•×ª </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">public_cmds</span><span class="p">)</span><span class="si">}</span><span class="s2"> | ××™×©×™×•×ª </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">personal_cmds</span><span class="p">)</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">public_cmds</span><span class="p">:</span>
            <span class="n">public_list</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">cmd</span><span class="o">.</span><span class="n">command</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">public_cmds</span><span class="p">)</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;&lt;b&gt;×¦×™×‘×•×¨×™×•×ª:&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;&lt;pre&gt;</span><span class="si">{</span><span class="n">html_escape</span><span class="p">(</span><span class="n">public_list</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/pre&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">personal_cmds</span><span class="p">:</span>
            <span class="n">personal_list</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">cmd</span><span class="o">.</span><span class="n">command</span><span class="si">}</span><span class="s2"> â€” </span><span class="si">{</span><span class="n">cmd</span><span class="o">.</span><span class="n">description</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">personal_cmds</span><span class="p">)</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;&lt;b&gt;××™×©×™×•×ª:&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;&lt;pre&gt;</span><span class="si">{</span><span class="n">html_escape</span><span class="p">(</span><span class="n">personal_list</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/pre&gt;&quot;</span>
        
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">)</span></div>


<div class="viewcode-block" id="CodeKeeperBot.stats_command">
<a class="viewcode-back" href="../api/main.html#main.CodeKeeperBot.stats_command">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stats_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×”×¦×’×ª ×¡×˜×˜×™×¡×˜×™×§×•×ª ×”××©×ª××© ××• ×× ×”×œ&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">reporter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">log_user_activity</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>  <span class="c1"># ×”×•×¡×¤×ª ×¨×™×©×•× ××©×ª××© ×œ×¡×˜×˜×™×¡×˜×™×§×•×ª</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        
        <span class="c1"># ×¨×©×™××ª ×× ×”×œ×™×</span>
        <span class="n">ADMIN_IDS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">6865105071</span><span class="p">]</span>  <span class="c1"># ×”×•×¡×£ ××ª ×”-ID ×©×œ×š ×›××Ÿ!</span>
        
        <span class="c1"># ×× ×”××©×ª××© ×”×•× ×× ×”×œ, ×”×¦×’ ×¡×˜×˜×™×¡×˜×™×§×•×ª ×× ×”×œ</span>
        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">in</span> <span class="n">ADMIN_IDS</span><span class="p">:</span>
            <span class="c1"># ×§×‘×œ ×¡×˜×˜×™×¡×˜×™×§×•×ª ×›×œ×œ×™×•×ª</span>
            <span class="n">general_stats</span> <span class="o">=</span> <span class="n">user_stats</span><span class="o">.</span><span class="n">get_all_time_stats</span><span class="p">()</span>
            <span class="n">weekly_users</span> <span class="o">=</span> <span class="n">user_stats</span><span class="o">.</span><span class="n">get_weekly_stats</span><span class="p">()</span>
            
            <span class="c1"># ×‘× ×” ×”×•×“×¢×” ×‘×˜×•×—×” ×œ-HTML</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;ğŸ“Š &lt;b&gt;×¡×˜×˜×™×¡×˜×™×§×•×ª ×× ×”×œ - ×©×‘×•×¢ ××—×¨×•×Ÿ:&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;ğŸ‘¥ ×¡×”×´×› ××©×ª××©×™× ×¨×©×•××™×: </span><span class="si">{</span><span class="n">general_stats</span><span class="p">[</span><span class="s1">&#39;total_users&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;ğŸŸ¢ ×¤×¢×™×œ×™× ×”×™×•×: </span><span class="si">{</span><span class="n">general_stats</span><span class="p">[</span><span class="s1">&#39;active_today&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;ğŸ“… ×¤×¢×™×œ×™× ×”×©×‘×•×¢: </span><span class="si">{</span><span class="n">general_stats</span><span class="p">[</span><span class="s1">&#39;active_week&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            
            <span class="k">if</span> <span class="n">weekly_users</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;ğŸ“‹ &lt;b&gt;×¨×©×™××ª ××©×ª××©×™× ×¤×¢×™×œ×™×:&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">html</span><span class="w"> </span><span class="kn">import</span> <span class="n">escape</span> <span class="k">as</span> <span class="n">html_escape</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">user</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">weekly_users</span><span class="p">[:</span><span class="mi">15</span><span class="p">],</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">username</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;User&#39;</span>
                    <span class="c1"># ×”×™××œ×˜×•×ª ×‘×˜×•×—×”</span>
                    <span class="n">safe_username</span> <span class="o">=</span> <span class="n">html_escape</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">safe_username</span> <span class="ow">and</span> <span class="n">safe_username</span> <span class="o">!=</span> <span class="s1">&#39;User&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">safe_username</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;User_&#39;</span><span class="p">):</span>
                        <span class="c1"># ×”×•×¡×¤×ª @ ×× ×–×” ×©× ××©×ª××© ×˜×œ×’×¨×</span>
                        <span class="n">display_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;@</span><span class="si">{</span><span class="n">safe_username</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">safe_username</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">safe_username</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">display_name</span> <span class="o">=</span> <span class="n">safe_username</span>
                    <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">display_name</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;days&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> ×™××™× (</span><span class="si">{</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;total_actions&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> ×¤×¢×•×œ×•×ª)</span><span class="se">\n</span><span class="s2">&quot;</span>
                
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">weekly_users</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">:</span>
                    <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">... ×•×¢×•×“ </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">weekly_users</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">15</span><span class="si">}</span><span class="s2"> ××©×ª××©×™×&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;××™×Ÿ ××©×ª××©×™× ×¤×¢×™×œ×™× ×‘×©×‘×•×¢ ×”××—×¨×•×Ÿ&quot;</span>
            
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">ReplyKeyboardMarkup</span><span class="p">(</span><span class="n">MAIN_KEYBOARD</span><span class="p">,</span> <span class="n">resize_keyboard</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># ×¡×˜×˜×™×¡×˜×™×§×•×ª ×¨×’×™×œ×•×ª ×œ××©×ª××© ×¨×’×™×œ</span>
            <span class="n">stats</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user_stats</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">stats</span> <span class="ow">or</span> <span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_files&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                    <span class="s2">&quot;ğŸ“Š ×¢×“×™×™×Ÿ ××™×Ÿ ×œ×š ×§×˜×¢×™ ×§×•×“ ×©××•×¨×™×.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;×”×ª×—×œ ×¢× /save!&quot;</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">ReplyKeyboardMarkup</span><span class="p">(</span><span class="n">MAIN_KEYBOARD</span><span class="p">,</span> <span class="n">resize_keyboard</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">return</span>
            
            <span class="n">languages_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;languages&#39;</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="n">last_activity</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;latest_activity&#39;</span><span class="p">)</span>
            <span class="n">last_activity_str</span> <span class="o">=</span> <span class="n">last_activity</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/%m/%Y %H:%M&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">last_activity</span> <span class="k">else</span> <span class="s2">&quot;×œ× ×™×“×•×¢&quot;</span>
            
            <span class="n">response</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;ğŸ“Š &lt;b&gt;×”×¡×˜×˜×™×¡×˜×™×§×•×ª ×©×œ×š:&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ“ ×¡×”</span><span class="se">\&quot;</span><span class="s2">×› ×§×‘×¦×™×: &lt;b&gt;</span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;total_files&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ”¢ ×¡×”</span><span class="se">\&quot;</span><span class="s2">×› ×’×¨×¡××•×ª: &lt;b&gt;</span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;total_versions&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ’¾ ××’×‘×œ×ª ×§×‘×¦×™×: </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">MAX_FILES_PER_USER</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;ğŸ”¤ &lt;b&gt;×©×¤×•×ª ×‘×©×™××•×©:&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">languages_str</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;ğŸ“… &lt;b&gt;×¤×¢×™×œ×•×ª ××—×¨×•× ×”:&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">last_activity_str</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;ğŸ’¡ &lt;b&gt;×˜×™×¤:&lt;/b&gt; ×”×©×ª××© ×‘×ª×’×™×•×ª ×œ××¨×’×•×Ÿ ×˜×•×‘ ×™×•×ª×¨!&quot;</span>
            <span class="p">)</span>
            
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">ReplyKeyboardMarkup</span><span class="p">(</span><span class="n">MAIN_KEYBOARD</span><span class="p">,</span> <span class="n">resize_keyboard</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span></div>

    
<div class="viewcode-block" id="CodeKeeperBot.handle_document">
<a class="viewcode-back" href="../api/main.html#main.CodeKeeperBot.handle_document">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_document</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;××˜×¤×œ ×‘×§×‘×¦×™× ×‘×××¦×¢×•×ª DocumentHandler ×”×™×™×¢×•×“×™.&quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s2">&quot;effective_message&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">message</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">document</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s2">&quot;document&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">if</span> <span class="n">message</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">document</span><span class="p">:</span>
            <span class="n">size_limit_bytes</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>

            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="s2">&quot;file_size&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">document</span><span class="o">.</span><span class="n">file_size</span> <span class="o">&gt;</span> <span class="mi">20</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">:</span>
                    <span class="n">warning_text</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;â—ï¸×”×§×•×‘×¥ ×’×“×•×œ ××“×™.</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="s2">&quot;×”××’×‘×œ×” ×œ×”×¢×œ××ª ×§×‘×¦×™× ×”×™× 20MB. × ×¡×” ×œ×›×•×•×¥ ××• ×œ×—×œ×§ ××ª ×”×§×•×‘×¥.&quot;</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">message</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s2">&quot;reply_text&quot;</span><span class="p">):</span>
                        <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">warning_text</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Document rejected: size exceeds 20MB limit&quot;</span><span class="p">)</span>
                    <span class="k">return</span>

            <span class="n">file_size</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="s2">&quot;file_size&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">file_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">telegram_file</span> <span class="o">=</span> <span class="k">await</span> <span class="n">document</span><span class="o">.</span><span class="n">get_file</span><span class="p">()</span>
                    <span class="n">file_size</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">telegram_file</span><span class="p">,</span> <span class="s2">&quot;file_size&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to resolve document size: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">file_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">warning_text</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;âš ï¸ ×œ× ×”×¦×œ×—×ª×™ ×œ×‘×“×•×§ ××ª ×’×•×“×œ ×”×§×•×‘×¥.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;×”××’×‘×œ×” ×œ×”×¢×œ××ª ×§×‘×¦×™× ×”×™× 20MB. ×•×“× ×©×”×§×•×‘×¥ ×§×˜×Ÿ ××”××’×‘×œ×” ×•× ×¡×” ×©×•×‘.&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">message</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s2">&quot;reply_text&quot;</span><span class="p">):</span>
                    <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">warning_text</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Document rejected: unknown size, limit is 20MB&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="n">file_size</span> <span class="o">&gt;</span> <span class="n">size_limit_bytes</span><span class="p">:</span>
                <span class="n">warning_text</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;â—ï¸×”×§×•×‘×¥ ×’×“×•×œ ××“×™.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;×”××’×‘×œ×” ×œ×”×¢×œ××ª ×§×‘×¦×™× ×”×™× 20MB. × ×¡×” ×œ×›×•×•×¥ ××• ×œ×—×œ×§ ××ª ×”×§×•×‘×¥.&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">message</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s2">&quot;reply_text&quot;</span><span class="p">):</span>
                    <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">warning_text</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Document rejected: size exceeds 20MB limit&quot;</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_handler</span><span class="o">.</span><span class="n">handle_document</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<div class="viewcode-block" id="CodeKeeperBot.handle_text_message">
<a class="viewcode-back" href="../api/main.html#main.CodeKeeperBot.handle_text_message">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_text_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×˜×™×¤×•×œ ×‘×”×•×“×¢×•×ª ×˜×§×¡×˜ (×§×•×“ ×¤×•×˜× ×¦×™××œ×™)&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">reporter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">log_user_activity</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">text</span>

        <span class="c1"># ××¦×‘ ×—×™×¤×•×© ××™× ×˜×¨××§×˜×™×‘×™ (××•×¤×¢×œ ××”×›×¤×ª×•×¨ &quot;ğŸ” ×—×¤×© ×§×•×‘×¥&quot;)</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;awaiting_search_text&#39;</span><span class="p">):</span>
            <span class="n">query_text</span> <span class="o">=</span> <span class="p">(</span><span class="n">text</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;awaiting_search_text&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="c1"># ×¤×™×¨×•×§ ×©××™×œ×ª×: ×ª×•××š name:..., lang:..., tag:repo:...</span>
            <span class="n">name_substr</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">lang_filter</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">tag_filter</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">query_text</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
                    <span class="n">lower</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">lower</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;name:&#39;</span><span class="p">):</span>
                        <span class="n">name_substr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="n">lower</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;lang:&#39;</span><span class="p">):</span>
                        <span class="n">lang_filter</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="kc">None</span>
                    <span class="k">elif</span> <span class="n">lower</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;tag:&#39;</span><span class="p">):</span>
                        <span class="n">tag_filter</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="n">lower</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;repo:&#39;</span><span class="p">):</span>
                        <span class="n">tag_filter</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># ××•× ×—×™ ×—×™×¤×•×© ×—×•×¤×©×™×™× ×‘×©× ×”×§×•×‘×¥</span>
                        <span class="n">name_substr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                <span class="n">name_filter</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">name_substr</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">name_filter</span> <span class="o">=</span> <span class="n">query_text</span>

            <span class="c1"># ××—×–×•×¨ ×ª×•×¦××•×ª</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">database</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span>
            <span class="c1"># × ×—×¤×© ×‘×‘×¡×™×¡ (×›×•×œ×œ $text), ×•××– × ×¡× ×Ÿ ×œ×¤×™ ×©× ×§×•×‘×¥ ×× ×”×•×’×“×¨ name_filter</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">search_code</span><span class="p">(</span>
                <span class="n">user_id</span><span class="p">,</span>
                <span class="n">query</span><span class="o">=</span><span class="n">name_filter</span> <span class="k">if</span> <span class="n">name_filter</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">programming_language</span><span class="o">=</span><span class="p">(</span><span class="n">lang_filter</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                <span class="n">tags</span><span class="o">=</span><span class="p">([</span><span class="n">tag_filter</span><span class="p">]</span> <span class="k">if</span> <span class="n">tag_filter</span> <span class="k">else</span> <span class="p">[]),</span>
                <span class="n">limit</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
            <span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
            <span class="c1"># ×¡×™× ×•×Ÿ ×œ×¤×™ ×©× ×§×•×‘×¥ ×× ×™×© name_filter</span>
            <span class="k">if</span> <span class="n">name_filter</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">nf</span> <span class="o">=</span> <span class="n">name_filter</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="n">nf</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">total</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                    <span class="s2">&quot;ğŸ” ×œ× × ××¦××• ×ª×•×¦××•×ª.&quot;</span><span class="p">,</span>
                    <span class="n">reply_to_message_id</span><span class="o">=</span><span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">message_id</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="c1"># ××¤×©×¨ ×œ××¤×©×¨ ×—×™×¤×•×© × ×•×¡×£ ××™×“</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;awaiting_search_text&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">return</span>

            <span class="c1"># ×©××™×¨×ª ×¤×™×œ×˜×¨×™× ×œ×”××©×š ×“×¤×“×•×£</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;search_filters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;name_filter&#39;</span><span class="p">:</span> <span class="n">name_filter</span><span class="p">,</span>
                <span class="s1">&#39;lang&#39;</span><span class="p">:</span> <span class="n">lang_filter</span><span class="p">,</span>
                <span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="n">tag_filter</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;files_origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;search&#39;</span> <span class="p">}</span>

            <span class="c1"># ×‘× ×™×™×ª ×¢××•×“ ×¨××©×•×Ÿ</span>
            <span class="n">PAGE_SIZE</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="n">page</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;files_last_page&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span>
            <span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span>
            <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">total</span><span class="p">)</span>

            <span class="c1"># ×‘× ×™×™×ª ××§×œ×“×ª ×ª×•×¦××•×ª</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">telegram</span><span class="w"> </span><span class="kn">import</span> <span class="n">InlineKeyboardMarkup</span><span class="p">,</span> <span class="n">InlineKeyboardButton</span>
            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;files_cache&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span> <span class="s1">&#39;×§×•×‘×¥&#39;</span><span class="p">)</span>
                <span class="n">lang</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;programming_language&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">)</span>
                <span class="n">button_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ğŸ“„ </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">lang</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">button_text</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;file_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;files_cache&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">item</span>

            <span class="c1"># ×¢×™××•×“</span>
            <span class="n">total_pages</span> <span class="o">=</span> <span class="p">(</span><span class="n">total</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">PAGE_SIZE</span> <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="n">row</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">page</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;â¬…ï¸ ×”×§×•×“×&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;search_page_</span><span class="si">{</span><span class="n">page</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">page</span> <span class="o">&lt;</span> <span class="n">total_pages</span><span class="p">:</span>
                <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;â¡ï¸ ×”×‘×&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;search_page_</span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">:</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ”™ ×—×–×¨×”&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;files&quot;</span><span class="p">)])</span>

            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ” ×ª×•×¦××•×ª ×—×™×¤×•×© â€” ×¡×”×´×›: </span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ“„ ×¢××•×“ </span><span class="si">{</span><span class="n">page</span><span class="si">}</span><span class="s2"> ××ª×•×š </span><span class="si">{</span><span class="n">total_pages</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># ×‘×™×˜×•×œ ×—×“-×¤×¢××™ ×©×œ ×”×•×“×¢×ª &quot;× ×¨××” ×©×–×” ×§×˜×¢ ×§×•×“!&quot; (×œ××©×œ ××—×¨×™ ×©××™×¨×ª ×”×¢×¨×” ×œ×’×™×‘×•×™)</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;suppress_code_hint_once&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">return</span>
        
        <span class="c1"># ×‘×“×™×§×” ×× ×”××©×ª××© ×‘×ª×”×œ×™×š ×©××™×¨×”</span>
        <span class="k">if</span> <span class="s1">&#39;saving_file&#39;</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_code_snippet</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># ×–×™×”×•×™ ×× ×–×” × ×¨××” ×›××• ×§×•×“, ×œ××¢×˜ ×‘×–××Ÿ ×–×¨×™××ª &quot;×”×“×‘×§ ×§×•×“&quot; ×©×œ GitHub</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_looks_like_code</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;waiting_for_paste_content&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;waiting_for_paste_filename&#39;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;ğŸ¤” × ×¨××” ×©×–×” ×§×˜×¢ ×§×•×“!</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;×¨×•×¦×” ×œ×©××•×¨ ××•×ª×•? ×”×©×ª××© ×‘/save ××• ×©×œ×— ×©×•×‘ ×¢× ×©× ×§×•×‘×¥.&quot;</span><span class="p">,</span>
                <span class="n">reply_to_message_id</span><span class="o">=</span><span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">message_id</span>
            <span class="p">)</span>
        <span class="c1"># ×©×œ×‘ ×‘×™× ×™×™× ×œ×§×œ×™×˜×ª ×”×¢×¨×” ××—×¨×™ ×§×•×“</span>
        <span class="k">elif</span> <span class="s1">&#39;saving_file&#39;</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span> <span class="ow">and</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;saving_file&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;note_asked&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;pending_code_buffer&#39;</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">:</span>
            <span class="n">note_text</span> <span class="o">=</span> <span class="p">(</span><span class="n">text</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">note_text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;×“×œ×’&quot;</span><span class="p">,</span> <span class="s2">&quot;skip&quot;</span><span class="p">,</span> <span class="s2">&quot;×œ×œ×&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">}:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;saving_file&#39;</span><span class="p">][</span><span class="s1">&#39;note_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># ×”×’×‘×œ×ª ××•×¨×š ×”×¢×¨×”</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;saving_file&#39;</span><span class="p">][</span><span class="s1">&#39;note_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">note_text</span><span class="p">[:</span><span class="mi">280</span><span class="p">]</span>
            <span class="c1"># ×§×¨× ×©×•×‘ ×œ×©××™×¨×” ×‘×¤×•×¢×œ (×ª×“×œ×’ ×¢×œ ×”×©××œ×” ×›×™ note_asked=true)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_code_snippet</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pending_code_buffer&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span></div>

    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_save_code_snippet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×©××™×¨×” ×‘×¤×•×¢×œ ×©×œ ×§×˜×¢ ×§×•×“&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">reporter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">saving_data</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;saving_file&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">config</span><span class="o">.</span><span class="n">MAX_CODE_SIZE</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;âŒ ×”×§×•×“ ×’×“×•×œ ××“×™! ××§×¡×™××•× </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">MAX_CODE_SIZE</span><span class="si">}</span><span class="s2"> ×ª×•×•×™×.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># ×–×™×”×•×™ ×©×¤×ª ×”×ª×›× ×•×ª ×‘×××¦×¢×•×ª CodeProcessor + ×ª×™×¢×•×“ ××“×•×“</span>
        <span class="k">with</span> <span class="n">track_performance</span><span class="p">(</span><span class="s2">&quot;detect_language&quot;</span><span class="p">):</span>
            <span class="n">detected_language</span> <span class="o">=</span> <span class="n">code_processor</span><span class="o">.</span><span class="n">detect_language</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">saving_data</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">])</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;×–×•×”×ª×” ×©×¤×”: </span><span class="si">{</span><span class="n">detected_language</span><span class="si">}</span><span class="s2"> ×¢×‘×•×¨ ×”×§×•×‘×¥ </span><span class="si">{</span><span class="n">saving_data</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">emit_event</span><span class="p">(</span>
                <span class="s2">&quot;file_save_detect_language&quot;</span><span class="p">,</span>
                <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span>
                <span class="n">language</span><span class="o">=</span><span class="n">detected_language</span><span class="p">,</span>
                <span class="n">file_name</span><span class="o">=</span><span class="n">saving_data</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">],</span>
                <span class="n">size_bytes</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)),</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        
        <span class="c1"># ×× ×˜×¨× × ×©××¨×” ×”×¢×¨×”, × ×©××œ ×›×¢×ª</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">saving_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;note_asked&#39;</span><span class="p">):</span>
            <span class="n">saving_data</span><span class="p">[</span><span class="s1">&#39;note_asked&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;saving_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">saving_data</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;pending_code_buffer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">code</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;ğŸ“ ×¨×•×¦×” ×œ×”×•×¡×™×£ ×”×¢×¨×” ×§×¦×¨×” ×œ×§×•×‘×¥?</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;×›×ª×•×‘/×›×ª×‘×™ ××•×ª×” ×¢×›×©×™×• ××• ×©×œ×—/×™ &#39;×“×œ×’&#39; ×›×“×™ ×œ×©××•×¨ ×‘×œ×™ ×”×¢×¨×”.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># ×©×œ×‘ ×©× ×™: ×›×‘×¨ × ×©××œ×” ×”×¢×¨×”, ×‘×“×•×§ ×× ×”×ª×§×‘×œ×”</span>
        <span class="n">note</span> <span class="o">=</span> <span class="n">saving_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;note_value&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;pending_code_buffer&#39;</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;pending_code_buffer&#39;</span><span class="p">)</span>

        <span class="c1"># ×™×¦×™×¨×ª ××•×‘×™×™×§×˜ ×§×˜×¢ ×§×•×“ ×›×•×œ×œ ×”×¢×¨×” (description)</span>
        <span class="n">snippet</span> <span class="o">=</span> <span class="n">CodeSnippet</span><span class="p">(</span>
            <span class="n">user_id</span><span class="o">=</span><span class="n">saving_data</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">],</span>
            <span class="n">file_name</span><span class="o">=</span><span class="n">saving_data</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">],</span>
            <span class="n">code</span><span class="o">=</span><span class="n">code</span><span class="p">,</span>
            <span class="n">programming_language</span><span class="o">=</span><span class="n">detected_language</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="n">note</span><span class="p">,</span>
            <span class="n">tags</span><span class="o">=</span><span class="n">saving_data</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        
        <span class="c1"># ×©××™×¨×” ×‘××¡×“ ×”× ×ª×•× ×™×</span>
        <span class="n">saved_ok</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">with</span> <span class="n">track_performance</span><span class="p">(</span><span class="s2">&quot;db_save_code_snippet&quot;</span><span class="p">):</span>
            <span class="n">saved_ok</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">save_code_snippet</span><span class="p">(</span><span class="n">snippet</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">saved_ok</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Business metric: file saved (size in BYTES, not chars)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">size_bytes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">size_bytes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>  <span class="c1"># Fallback</span>
                <span class="n">track_file_saved</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">saving_data</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">],</span> <span class="n">language</span><span class="o">=</span><span class="n">detected_language</span><span class="p">,</span> <span class="n">size_bytes</span><span class="o">=</span><span class="n">size_bytes</span><span class="p">)</span>
                <span class="n">emit_event</span><span class="p">(</span>
                    <span class="s2">&quot;file_saved&quot;</span><span class="p">,</span>
                    <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span>
                    <span class="n">user_id</span><span class="o">=</span><span class="n">saving_data</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">],</span>
                    <span class="n">language</span><span class="o">=</span><span class="n">detected_language</span><span class="p">,</span>
                    <span class="n">size_bytes</span><span class="o">=</span><span class="n">size_bytes</span><span class="p">,</span>
                    <span class="n">file_name</span><span class="o">=</span><span class="n">saving_data</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;âœ… × ×©××¨ ×‘×”×¦×œ×—×”!</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ“ **</span><span class="si">{</span><span class="n">saving_data</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">**</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ”¤ ×©×¤×”: </span><span class="si">{</span><span class="n">detected_language</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ·ï¸ ×ª×’×™×•×ª: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">saving_data</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">])</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">saving_data</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;×œ×œ×&#39;</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ“ ×”×¢×¨×”: </span><span class="si">{</span><span class="n">note</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;â€”&#39;</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;ğŸ“Š ×’×•×“×œ: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">)</span><span class="si">}</span><span class="s2"> ×ª×•×•×™×&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;âŒ ×©×’×™××” ×‘×©××™×¨×”. × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.&quot;</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">errors_total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">errors_total</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="s2">&quot;E_SAVE_FAILED&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
                <span class="n">emit_event</span><span class="p">(</span>
                    <span class="s2">&quot;file_save_failed&quot;</span><span class="p">,</span>
                    <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span>
                    <span class="n">user_id</span><span class="o">=</span><span class="n">saving_data</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">],</span>
                    <span class="n">file_name</span><span class="o">=</span><span class="n">saving_data</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_looks_like_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×‘×“×™×§×” ×¤×©×•×˜×” ×× ×˜×§×¡×˜ × ×¨××” ×›××• ×§×•×“&quot;&quot;&quot;</span>
        <span class="n">code_indicators</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;def &#39;</span><span class="p">,</span> <span class="s1">&#39;function &#39;</span><span class="p">,</span> <span class="s1">&#39;class &#39;</span><span class="p">,</span> <span class="s1">&#39;import &#39;</span><span class="p">,</span> <span class="s1">&#39;from &#39;</span><span class="p">,</span>
            <span class="s1">&#39;){&#39;</span><span class="p">,</span> <span class="s1">&#39;};&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;?php&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;html&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;script&#39;</span><span class="p">,</span> <span class="s1">&#39;SELECT &#39;</span><span class="p">,</span> <span class="s1">&#39;CREATE TABLE&#39;</span>
        <span class="p">]</span>
        
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">indicator</span> <span class="ow">in</span> <span class="n">text</span> <span class="k">for</span> <span class="n">indicator</span> <span class="ow">in</span> <span class="n">code_indicators</span><span class="p">)</span> <span class="ow">or</span> \
               <span class="n">text</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">text</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_detect_language</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×–×™×”×•×™ ×‘×¡×™×¡×™ ×©×œ ×©×¤×ª ×ª×›× ×•×ª (×™×•×¨×—×‘ ×‘×¢×ª×™×“)&quot;&quot;&quot;</span>
        <span class="c1"># ×–×™×”×•×™ ×œ×¤×™ ×¡×™×•××ª ×§×•×‘×¥</span>
        <span class="n">extension_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;.py&#39;</span><span class="p">:</span> <span class="s1">&#39;python&#39;</span><span class="p">,</span>
            <span class="s1">&#39;.js&#39;</span><span class="p">:</span> <span class="s1">&#39;javascript&#39;</span><span class="p">,</span>
            <span class="s1">&#39;.html&#39;</span><span class="p">:</span> <span class="s1">&#39;html&#39;</span><span class="p">,</span>
            <span class="s1">&#39;.css&#39;</span><span class="p">:</span> <span class="s1">&#39;css&#39;</span><span class="p">,</span>
            <span class="s1">&#39;.java&#39;</span><span class="p">:</span> <span class="s1">&#39;java&#39;</span><span class="p">,</span>
            <span class="s1">&#39;.cpp&#39;</span><span class="p">:</span> <span class="s1">&#39;cpp&#39;</span><span class="p">,</span>
            <span class="s1">&#39;.c&#39;</span><span class="p">:</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span>
            <span class="s1">&#39;.php&#39;</span><span class="p">:</span> <span class="s1">&#39;php&#39;</span><span class="p">,</span>
            <span class="s1">&#39;.rb&#39;</span><span class="p">:</span> <span class="s1">&#39;ruby&#39;</span><span class="p">,</span>
            <span class="s1">&#39;.go&#39;</span><span class="p">:</span> <span class="s1">&#39;go&#39;</span><span class="p">,</span>
            <span class="s1">&#39;.rs&#39;</span><span class="p">:</span> <span class="s1">&#39;rust&#39;</span><span class="p">,</span>
            <span class="s1">&#39;.ts&#39;</span><span class="p">:</span> <span class="s1">&#39;typescript&#39;</span><span class="p">,</span>
            <span class="s1">&#39;.sql&#39;</span><span class="p">:</span> <span class="s1">&#39;sql&#39;</span><span class="p">,</span>
            <span class="s1">&#39;.sh&#39;</span><span class="p">:</span> <span class="s1">&#39;bash&#39;</span><span class="p">,</span>
            <span class="s1">&#39;.json&#39;</span><span class="p">:</span> <span class="s1">&#39;json&#39;</span><span class="p">,</span>
            <span class="s1">&#39;.xml&#39;</span><span class="p">:</span> <span class="s1">&#39;xml&#39;</span><span class="p">,</span>
            <span class="s1">&#39;.yml&#39;</span><span class="p">:</span> <span class="s1">&#39;yaml&#39;</span><span class="p">,</span>
            <span class="s1">&#39;.yaml&#39;</span><span class="p">:</span> <span class="s1">&#39;yaml&#39;</span>
        <span class="p">}</span>
        
        <span class="k">for</span> <span class="n">ext</span><span class="p">,</span> <span class="n">lang</span> <span class="ow">in</span> <span class="n">extension_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">ext</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">lang</span>
        
        <span class="c1"># ×–×™×”×•×™ ×‘×¡×™×¡×™ ×œ×¤×™ ×ª×•×›×Ÿ</span>
        <span class="k">if</span> <span class="s1">&#39;def &#39;</span> <span class="ow">in</span> <span class="n">code</span> <span class="ow">or</span> <span class="s1">&#39;import &#39;</span> <span class="ow">in</span> <span class="n">code</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;python&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;function &#39;</span> <span class="ow">in</span> <span class="n">code</span> <span class="ow">or</span> <span class="s1">&#39;var &#39;</span> <span class="ow">in</span> <span class="n">code</span> <span class="ow">or</span> <span class="s1">&#39;let &#39;</span> <span class="ow">in</span> <span class="n">code</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;javascript&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;&lt;?php&#39;</span> <span class="ow">in</span> <span class="n">code</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;php&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;&lt;html&#39;</span> <span class="ow">in</span> <span class="n">code</span> <span class="ow">or</span> <span class="s1">&#39;&lt;!DOCTYPE&#39;</span> <span class="ow">in</span> <span class="n">code</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;html&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;SELECT &#39;</span> <span class="ow">in</span> <span class="n">code</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;CREATE TABLE&#39;</span> <span class="ow">in</span> <span class="n">code</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
            <span class="k">return</span> <span class="s1">&#39;sql&#39;</span>
        
        <span class="k">return</span> <span class="s1">&#39;text&#39;</span>  <span class="c1"># ×‘×¨×™×¨×ª ××—×“×œ</span>
    
<div class="viewcode-block" id="CodeKeeperBot.error_handler">
<a class="viewcode-back" href="../api/main.html#main.CodeKeeperBot.error_handler">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">error_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×˜×™×¤×•×œ ×‘×©×’×™××•×ª&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;×©×’×™××”: </span><span class="si">{</span><span class="n">context</span><span class="o">.</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">error</span><span class="p">)</span>

        <span class="c1"># ×–×™×”×•×™ ×—×¨×™×’×ª ×–×™×›×¨×•×Ÿ (×’×œ×•×‘×œ×™)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">error</span>
            <span class="n">err_text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="k">if</span> <span class="n">err</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="n">is_oom</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="ne">MemoryError</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">err_text</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                    <span class="s1">&#39;Ran out of memory&#39;</span> <span class="ow">in</span> <span class="n">err_text</span> <span class="ow">or</span> <span class="s1">&#39;out of memory&#39;</span> <span class="ow">in</span> <span class="n">err_text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;MemoryError&#39;</span> <span class="ow">in</span> <span class="n">err_text</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">is_oom</span><span class="p">:</span>
                <span class="c1"># × ×¡×” ×œ×¦×¨×£ ×¡×˜×˜×•×¡ ×–×™×›×¨×•×Ÿ</span>
                <span class="n">mem_status</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_memory_usage</span>  <span class="c1"># import ××§×•××™ ×œ×× ×™×¢×ª ×ª×œ×•×ª ×‘×–××Ÿ ×‘×“×™×§×•×ª</span>
                    <span class="n">mu</span> <span class="o">=</span> <span class="n">get_memory_usage</span><span class="p">()</span>
                    <span class="n">mem_status</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; (RSS=</span><span class="si">{</span><span class="n">mu</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rss_mb&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">MB, VMS=</span><span class="si">{</span><span class="n">mu</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vms_mb&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">MB, %=</span><span class="si">{</span><span class="n">mu</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;percent&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="c1"># ×©×œ×— ×”×ª×¨××” ×œ××“××™× ×™×</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">notify_admins</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;ğŸš¨ OOM ×–×•×”×ª×” ×‘×‘×•×˜</span><span class="si">{</span><span class="n">mem_status</span><span class="si">}</span><span class="s2">. ×—×¨×™×’×”: </span><span class="si">{</span><span class="n">err_text</span><span class="p">[:</span><span class="mi">500</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="c1"># ×× ×”××©×ª××© ××“××™×Ÿ â€“ ×©×œ×— ×’× ××œ×™×• ×¤×™×¨×•×˜</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">Update</span><span class="p">)</span> <span class="ow">and</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="p">:</span>
                        <span class="n">admin_ids</span> <span class="o">=</span> <span class="n">get_admin_ids</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">admin_ids</span> <span class="ow">and</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">admin_ids</span><span class="p">:</span>
                            <span class="k">await</span> <span class="n">context</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">chat_id</span><span class="o">=</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                                           <span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;ğŸš¨ OOM ×–×•×”×ª×”</span><span class="si">{</span><span class="n">mem_status</span><span class="si">}</span><span class="s2">. ×”×ª×§×‘×œ×” ×©×’×™××”: </span><span class="si">{</span><span class="n">err_text</span><span class="p">[:</span><span class="mi">500</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">Update</span><span class="p">)</span> <span class="ow">and</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_message</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;âŒ ××™×¨×¢×” ×©×’×™××”. ×× × × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.&quot;</span>
            <span class="p">)</span></div>

    
<div class="viewcode-block" id="CodeKeeperBot.start">
<a class="viewcode-back" href="../api/main.html#main.CodeKeeperBot.start">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×”×¤×¢×œ×ª ×”×‘×•×˜&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;××ª×—×™×œ ××ª ×”×‘×•×˜...&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">updater</span><span class="o">.</span><span class="n">start_polling</span><span class="p">()</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;×”×‘×•×˜ ×¤×•×¢×œ! ×œ×—×¥ Ctrl+C ×œ×”×¤×¡×§×”.&quot;</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="CodeKeeperBot.stop">
<a class="viewcode-back" href="../api/main.html#main.CodeKeeperBot.stop">[×ª×™×¢×•×“]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;×¢×¦×™×¨×ª ×”×‘×•×˜&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;×¢×•×¦×¨ ××ª ×”×‘×•×˜...&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">updater</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        
        <span class="c1"># ×©×—×¨×•×¨ × ×¢×™×œ×” ×•×¡×’×™×¨×ª ×—×™×‘×•×¨ ×œ××¡×“ × ×ª×•× ×™× (××•×’×Ÿ ××›×¤×œ×•×ª)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">already_done</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_lock_cleanup_done&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">already_done</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">already_done</span><span class="p">:</span>
            <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">success</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">cleanup_mongo_lock</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_lock_cleanup_done&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;×”×‘×•×˜ × ×¢×¦×¨.&quot;</span><span class="p">)</span></div>
</div>


<div class="viewcode-block" id="signal_handler">
<a class="viewcode-back" href="../api/main.html#main.signal_handler">[×ª×™×¢×•×“]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">signal_handler</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;×˜×™×¤×•×œ ×‘×¡×™×’× ×œ×™ ×¢×¦×™×¨×”&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;×”×ª×§×‘×œ ×¡×™×’× ×œ </span><span class="si">{</span><span class="n">signum</span><span class="si">}</span><span class="s2">, ×¢×•×¦×¨ ××ª ×”×‘×•×˜...&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>


<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="c1"># Helper to register the basic command handlers with the Application instance.</span>
<span class="c1"># ---------------------------------------------------------------------------</span>


<div class="viewcode-block" id="setup_handlers">
<a class="viewcode-back" href="../api/main.html#main.setup_handlers">[×ª×™×¢×•×“]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">setup_handlers</span><span class="p">(</span><span class="n">application</span><span class="p">:</span> <span class="n">Application</span><span class="p">,</span> <span class="n">db_manager</span><span class="p">):</span>  <span class="c1"># noqa: D401</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Register basic command handlers required for the bot to operate.&quot;&quot;&quot;</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">start_command</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>  <span class="c1"># noqa: D401</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">username</span>
        
        <span class="c1"># ×©××•×¨ ××©×ª××© ×‘××¡×“ × ×ª×•× ×™× (INSERT OR IGNORE)</span>
        <span class="n">db_manager</span><span class="o">.</span><span class="n">save_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">reporter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">log_user_activity</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>  <span class="c1"># ×”×•×¡×¤×ª ×¨×™×©×•× ××©×ª××© ×œ×¡×˜×˜×™×¡×˜×™×§×•×ª</span>
        
        <span class="c1"># ×‘×“×™×§×” ×× ×”××©×ª××© ×”×’×™×¢ ××”-Web App ××• ×¨×•×¦×” ×œ×”×•×¡×™×£ ×§×•×‘×¥</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;add_file&quot;</span><span class="p">:</span>
                <span class="c1"># ×”××©×ª××© ×¨×•×¦×” ×œ×”×•×¡×™×£ ×§×•×‘×¥ ×—×“×©</span>
                <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">ReplyKeyboardMarkup</span><span class="p">(</span><span class="n">MAIN_KEYBOARD</span><span class="p">,</span> <span class="n">resize_keyboard</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                    <span class="s2">&quot;ğŸ“ &lt;b&gt;×”×•×¡×¤×ª ×§×•×‘×¥ ×—×“×©&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;×©×œ×— ×œ×™ ×§×•×‘×¥ ×§×•×“ ××• ×˜×§×¡×˜ ×›×“×™ ×œ×©××•×¨ ××•×ª×•.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;××¤×©×¨ ×œ×©×œ×•×—:</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;â€¢ ×§×•×‘×¥ ×‘×•×“×“ ××• ××¡×¤×¨ ×§×‘×¦×™×</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;â€¢ ×§×•×‘×¥ ZIP ×¢× ××¡×¤×¨ ×§×‘×¦×™×</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;â€¢ ×”×•×“×¢×ª ×˜×§×¡×˜ ×¢× ×§×•×“</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;ğŸ’¡ ×˜×™×¤: ××¤×©×¨ ×œ×”×•×¡×™×£ ×ª×™××•×¨ ×œ×§×•×‘×¥ ×‘×›×™×ª×•×‘ (caption)&quot;</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span><span class="p">,</span>
                    <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span>
                <span class="p">)</span>
                <span class="k">return</span>
            <span class="k">elif</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;webapp_login&quot;</span><span class="p">:</span>
                <span class="c1"># ×™×¦×™×¨×ª ×§×™×©×•×¨ ×”×ª×—×‘×¨×•×ª ××™×©×™</span>
                <span class="n">webapp_url</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;WEBAPP_URL&#39;</span><span class="p">,</span> <span class="s1">&#39;https://code-keeper-webapp.onrender.com&#39;</span><span class="p">)</span>
                
                <span class="c1"># ×™×¦×™×¨×ª ×˜×•×§×Ÿ ×–×× ×™ ×œ××™××•×ª (××¤×©×¨ ×œ×”×©×ª××© ×‘-JWT ××• hash ×¤×©×•×˜)</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
                <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
                <span class="n">secret</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;SECRET_KEY&#39;</span><span class="p">,</span> <span class="s1">&#39;dev-secret-key&#39;</span><span class="p">)</span>
                <span class="n">token_data</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">secret</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">auth_token</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">token_data</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">32</span><span class="p">]</span>
                
                <span class="c1"># ×©××™×¨×ª ×”×˜×•×§×Ÿ ×‘××¡×“ × ×ª×•× ×™× ×¢× ×ª×•×§×£ ×©×œ 5 ×“×§×•×ª</span>
                <span class="n">db</span> <span class="o">=</span> <span class="n">db_manager</span><span class="o">.</span><span class="n">get_db</span><span class="p">()</span>
                <span class="n">db</span><span class="o">.</span><span class="n">webapp_tokens</span><span class="o">.</span><span class="n">insert_one</span><span class="p">({</span>
                    <span class="s1">&#39;token&#39;</span><span class="p">:</span> <span class="n">auth_token</span><span class="p">,</span>
                    <span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
                    <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span>
                    <span class="s1">&#39;created_at&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span>
                    <span class="s1">&#39;expires_at&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
                <span class="p">})</span>
                
                <span class="c1"># ×™×¦×™×¨×ª ×§×™×©×•×¨ ×”×ª×—×‘×¨×•×ª</span>
                <span class="n">login_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">webapp_url</span><span class="si">}</span><span class="s2">/auth/token?token=</span><span class="si">{</span><span class="n">auth_token</span><span class="si">}</span><span class="s2">&amp;user_id=</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span>
                
                <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸ” ×”×ª×—×‘×¨ ×œ-Web App&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">login_url</span><span class="p">)],</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ğŸŒ ×¤×ª×— ××ª ×”-Web App&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">webapp_url</span><span class="p">)]</span>
                <span class="p">]</span>
                <span class="n">reply_markup_inline</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
                
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                    <span class="s2">&quot;ğŸ” &lt;b&gt;×§×™×©×•×¨ ×”×ª×—×‘×¨×•×ª ××™×©×™ ×œ-Web App&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;×œ×—×¥ ×¢×œ ×”×›×¤×ª×•×¨ ×œ××˜×” ×›×“×™ ×œ×”×ª×—×‘×¨:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;âš ï¸ &lt;i&gt;×”×§×™×©×•×¨ ×ª×§×£ ×œ-5 ×“×§×•×ª ×‘×œ×‘×“ ××˜×¢××™ ××‘×˜×—×”&lt;/i&gt;&quot;</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup_inline</span><span class="p">,</span>
                    <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span>
                <span class="p">)</span>
                <span class="k">return</span>
        
        <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">ReplyKeyboardMarkup</span><span class="p">(</span><span class="n">MAIN_KEYBOARD</span><span class="p">,</span> <span class="n">resize_keyboard</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
            <span class="s2">&quot;ğŸ¤– ×©×œ×•× ×•×‘×¨×•×š ×”×‘× ×œ×‘×•×˜ ×©×•××¨ ×”×§×•×“ ×”××ª×§×“×!</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;ğŸ”¹ ×©××•×¨ ×•× ×”×œ ×§×˜×¢×™ ×§×•×“ ×‘×—×›××”</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;ğŸ”¹ ×¢×¨×™×›×” ××ª×§×“××ª ×¢× ×’×¨×¡××•×ª</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;ğŸ”¹ ×—×™×¤×•×© ×•×”×¦×’×” ×—×›××”</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;ğŸ”¹ ×”×•×¨×“×” ×•× ×™×”×•×œ ××œ×</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;ğŸ”¹ ×”×¢×œ××ª ×§×‘×¦×™× ×œ-GitHub</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;âœ¨ ×—×“×© ×‘×‘×•×˜: </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;â€¢ ğŸŒ ××™× ×™-WebApp - ×›×¤×ª×•×¨ ×‘×¤×™× ×” ×”×©×××œ×™×ª ×œ××˜×”</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  ×”×›×™ × ×•×— ×œ×¦×¤×™×™×” ×•×”×¢×ª×§×” ×©×œ ×§×•×“ ××¨×•×š (×¢×“ ×¢×©×¨×•×ª ××œ×¤×™ ×©×•×¨×•×ª)</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;â€¢ ğŸ—ƒ ××•×¡×£ ×”×§×”×™×œ×” - ×’×œ×• ×›×œ×™×, ×•×‘×•×˜×™× ×©×‘× ×• ××©×ª××©×™× ××—×¨×™×</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  ×•××ª× ××•×–×× ×™× ×œ×©×ª×£ ××ª ×”×¤×¨×•×™×§×˜×™× ×©×œ×›× ×•×œ×”×¦×˜×¨×£ ×œ××•×¡×£</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;â€¢ ×œ×¨×©×™××ª ×¤×§×•×“×•×ª ×œ×œ× ×›×¤×ª×•×¨×™× - ×©×œ×—×• /help</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;ğŸ”§ ×ª×§×œ×” ×‘×‘×•×˜? ×›×ª×‘×• ×œ-@moominAmir&quot;</span><span class="p">,</span>
            <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">help_command</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>  <span class="c1"># noqa: D401</span>
        <span class="k">if</span> <span class="n">reporter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">log_user_activity</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>  <span class="c1"># ×”×•×¡×¤×ª ×¨×™×©×•× ××©×ª××© ×œ×¡×˜×˜×™×¡×˜×™×§×•×ª</span>
        <span class="n">ctx_app</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ctx_commands</span> <span class="o">=</span> <span class="n">_get_registered_commands</span><span class="p">(</span><span class="n">ctx_app</span><span class="p">)</span> <span class="k">if</span> <span class="n">ctx_app</span> <span class="k">else</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ctx_commands</span><span class="p">:</span>
            <span class="n">commands</span> <span class="o">=</span> <span class="n">ctx_commands</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">commands</span> <span class="o">=</span> <span class="n">_get_registered_commands</span><span class="p">(</span><span class="n">application</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">_build_help_message</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">,</span> <span class="n">disable_web_page_preview</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">plain_text</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;b&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;/b&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;code&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;/code&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&amp;lt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&amp;gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">plain_text</span><span class="p">,</span> <span class="n">disable_web_page_preview</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="n">start_command</span><span class="p">))</span>
    <span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;help&quot;</span><span class="p">,</span> <span class="n">help_command</span><span class="p">))</span></div>



<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="c1"># New lock-free main</span>
<span class="c1"># ---------------------------------------------------------------------------</span>
<div class="viewcode-block" id="main">
<a class="viewcode-back" href="../api/main.html#main.main">[×ª×™×¢×•×“]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initializes and runs the bot after acquiring a lock.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Initialize database first</span>
        <span class="k">global</span> <span class="n">db</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">DatabaseManager</span><span class="p">()</span>
        
        <span class="c1"># MongoDB connection and lock management</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">manage_mongo_lock</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Another bot instance is already running. Exiting gracefully.&quot;</span><span class="p">)</span>
            <span class="c1"># ×™×¦×™××” × ×§×™×™×” ×œ×œ× ×©×’×™××”</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># --- ×”××©×š ×”×§×•×“ ×”×§×™×™× ×©×œ×š ---</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Lock acquired. Initializing CodeKeeperBot...&quot;</span><span class="p">)</span>
        
        <span class="c1"># × ×©×ª××© ×‘××™× ×¡×˜× ×¡ ×§×™×™× ×× ×›×‘×¨ × ×•×¦×¨ (×œ××©×œ ×¢&quot;×™ ×˜×¡×˜), ××—×¨×ª × ×™×¦×•×¨ ×—×“×©</span>
        <span class="n">bot</span> <span class="o">=</span> <span class="n">CURRENT_BOT</span> <span class="ow">or</span> <span class="n">CodeKeeperBot</span><span class="p">()</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Bot is starting to poll...&quot;</span><span class="p">)</span>
        <span class="c1"># Cache warming: ×”×¤×¢×œ×ª ×¢×‘×•×“×” ×¨×§×¢ ×§×¦×¨×” ×œ××ª×—×•×œ ×§××© ×¢×‘×•×¨ ××©×ª××©×™×/×ª×¤×¨×™×˜×™× × ×¤×•×¦×™×</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_warm_cache</span><span class="p">(</span><span class="n">_ctx</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">database</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span> <span class="k">as</span> <span class="n">_db</span>
                    <span class="n">users</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># ×§×¨× ××–×”×™ ××©×ª××©×™× ×¤×¢×™×œ×™× ××—×¨×•× ×™× (best-effort)</span>
                        <span class="n">coll</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="s1">&#39;db&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="n">coll</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">coll</span><span class="p">,</span> <span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="n">rows_obj</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">if</span> <span class="n">coll</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">coll</span><span class="p">,</span> <span class="s1">&#39;find&#39;</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">rows_obj</span> <span class="o">=</span> <span class="n">coll</span><span class="o">.</span><span class="n">find</span><span class="p">({},</span> <span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
                                <span class="c1"># ×× ×™×© limit ×¢×œ ×”××•×‘×™×™×§×˜ (Cursor), ×”×©×ª××© ×‘×•, ××—×¨×ª × ××™×¨ ×œ×¨×©×™××” ×•× ×—×ª×•×š</span>
                                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">rows_obj</span><span class="p">,</span> <span class="s1">&#39;limit&#39;</span><span class="p">):</span>
                                    <span class="n">rows_obj</span> <span class="o">=</span> <span class="n">rows_obj</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="n">rows_obj</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">if</span> <span class="n">rows_obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">rows_obj</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">rows_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">rows_obj</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows_list</span><span class="p">[:</span><span class="mi">10</span><span class="p">]:</span>
                            <span class="n">uid</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                                <span class="n">users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">users</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="c1"># ×—×× ×¨×©×™××•×ª ×§×‘×¦×™× ×•×©××•×ª ×œ×§×•××‘×•×¡/××•×˜×•×§×•××¤×œ×™×˜</span>
                    <span class="k">for</span> <span class="n">uid</span> <span class="ow">in</span> <span class="n">users</span><span class="p">[:</span><span class="mi">10</span><span class="p">]:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">_</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">get_user_files</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">_</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">get_user_file_names</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">_</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">get_repo_tags_with_counts</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">max_tags</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">return</span>
            <span class="c1"># ×”×¨×¦×” ×œ××—×¨ ×¢×œ×™×™×” ×›×“×™ ×œ× ×œ×¢×›×‘ startup</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">bot</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">job_queue</span><span class="o">.</span><span class="n">run_once</span><span class="p">(</span><span class="n">_warm_cache</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="c1"># Start polling. In tests, run_polling may exist either on the</span>
        <span class="c1"># application or directly on the bot stub. Support both to avoid</span>
        <span class="c1"># AttributeError in minimal fakes.</span>
        <span class="n">_app</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">bot</span><span class="p">,</span> <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">_run_poll_app</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">_app</span><span class="p">,</span> <span class="s2">&quot;run_polling&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">_run_poll_app</span><span class="p">):</span>
            <span class="n">_run_poll_app</span><span class="p">(</span><span class="n">drop_pending_updates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_run_poll_bot</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">bot</span><span class="p">,</span> <span class="s2">&quot;run_polling&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">_run_poll_bot</span><span class="p">):</span>
                <span class="n">_run_poll_bot</span><span class="p">(</span><span class="n">drop_pending_updates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;run_polling not available on application or bot; skipping.&quot;</span><span class="p">)</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;×©×’×™××”: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Bot polling stopped. Releasing lock and closing database connection.&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cleanup_mongo_lock</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">if</span> <span class="s1">&#39;db&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
            <span class="n">db</span><span class="o">.</span><span class="n">close_connection</span><span class="p">()</span></div>



<span class="c1"># A minimal post_init stub to comply with the PTB builder chain</span>
<div class="viewcode-block" id="setup_bot_data">
<a class="viewcode-back" href="../api/main.html#main.setup_bot_data">[×ª×™×¢×•×“]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">setup_bot_data</span><span class="p">(</span><span class="n">application</span><span class="p">:</span> <span class="n">Application</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># noqa: D401</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A post_init function to setup application-wide data.&quot;&quot;&quot;</span>
    <span class="c1"># ××—×™×§×ª ×›×œ ×”×¤×§×•×“×•×ª ×”×¦×™×‘×•×¨×™×•×ª (××™×Ÿ ×œ×”×’×“×™×¨ /share /share_help â€” ×©×™×ª×•×£ ×“×¨×š ×”×›×¤×ª×•×¨×™×)</span>
    <span class="k">await</span> <span class="n">application</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">delete_my_commands</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;âœ… Public commands cleared (no /share, /share_help)&quot;</span><span class="p">)</span>

    <span class="c1"># ×”×’×“×¨×ª JobStore ××ª××™×“ ×œ-APScheduler (MongoDB) ×× ××¤×©×¨×™</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">jq</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="s2">&quot;job_queue&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">scheduler</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">jq</span><span class="p">,</span> <span class="s2">&quot;scheduler&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scheduler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">database</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span> <span class="k">as</span> <span class="n">_dbm</span>  <span class="c1"># ×©×™××•×© ×‘×œ×§×•×—/DB ×”×§×™×™××™×</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">_dbm</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore[assignment]</span>
            <span class="n">client</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">_dbm</span><span class="p">,</span> <span class="s2">&quot;client&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">if</span> <span class="n">_dbm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">db_obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">_dbm</span><span class="p">,</span> <span class="s2">&quot;db&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">if</span> <span class="n">_dbm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">db_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">db_obj</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">if</span> <span class="n">db_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="c1"># ××œ ×ª×’×“×™×¨ ×‘××¦×‘ NoOp ××• ×›×©××™×Ÿ ×—×™×‘×•×¨</span>
            <span class="k">if</span> <span class="n">client</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">db_name</span> <span class="ow">and</span> <span class="n">db_name</span> <span class="o">!=</span> <span class="s2">&quot;noop_db&quot;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># ×”×•×¡×£ JobStore ×‘×©× &#39;persistent&#39; ×œ×©×™××•×© ×¢&quot;×™ ××©×™××•×ª ×”×’×™×‘×•×™</span>
                    <span class="n">scheduler</span><span class="o">.</span><span class="n">add_jobstore</span><span class="p">(</span>
                        <span class="s1">&#39;mongodb&#39;</span><span class="p">,</span>
                        <span class="n">alias</span><span class="o">=</span><span class="s1">&#39;persistent&#39;</span><span class="p">,</span>
                        <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">,</span>
                        <span class="n">database</span><span class="o">=</span><span class="n">db_name</span><span class="p">,</span>
                        <span class="n">collection</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;APSCHEDULER_COLLECTION&#39;</span><span class="p">,</span> <span class="s1">&#39;scheduler_jobs&#39;</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;âœ… APScheduler persistent jobstore registered (MongoDB)&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># pragma: no cover â€” failâ€‘open ×‘×¡×‘×™×‘×•×ª ×˜×¡×˜/×œ×œ× DB</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;APS persistent jobstore not available: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="c1"># Fail-open: ××™×Ÿ ×œ×”×¤×™×œ ××ª ×”-setup ×× ×©×›×‘×ª APScheduler ××™× ×” ×–××™× ×”</span>
        <span class="k">pass</span>
    
    <span class="c1"># ×”×’×“×¨×ª ×¤×§×•×“×ª stats ×¨×§ ×œ×× ×”×œ (×××™×¨ ×‘×™×¨×•×Ÿ)</span>
    <span class="n">AMIR_ID</span> <span class="o">=</span> <span class="mi">6865105071</span>  <span class="c1"># ×”-ID ×©×œ ×××™×¨ ×‘×™×¨×•×Ÿ</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># ×”×’×“×¨ ×¨×§ ××ª ×¤×§×•×“×ª stats ×œ×××™×¨</span>
        <span class="k">await</span> <span class="n">application</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">set_my_commands</span><span class="p">(</span>
            <span class="n">commands</span><span class="o">=</span><span class="p">[</span>
                <span class="n">BotCommand</span><span class="p">(</span><span class="s2">&quot;stats&quot;</span><span class="p">,</span> <span class="s2">&quot;ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×•×ª ×©×™××•×©&quot;</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="n">scope</span><span class="o">=</span><span class="n">BotCommandScopeChat</span><span class="p">(</span><span class="n">chat_id</span><span class="o">=</span><span class="n">AMIR_ID</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âœ… Commands set for Amir (ID: </span><span class="si">{</span><span class="n">AMIR_ID</span><span class="si">}</span><span class="s2">): stats only&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âš ï¸ Error setting admin commands: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># ×¤×œ×™×˜×ª ××™×¨×•×¢ ××•×§×“××ª: × ×™×§×•×™ ×’×™×‘×•×™×™× â€” ×ª××™×›×” ×‘××¦×‘×™ ×˜×¡×˜</span>
    <span class="c1"># × ×©×ª××© ×‘×™×™×‘×•× ×“×™× ××™ ×›×“×™ ×œ×©×ª×£ ×¤×¢×•×œ×” ×¢× monkeypatch ×‘×˜×¡×˜×™×</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">enabled_env</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;BACKUPS_CLEANUP_ENABLED&quot;</span><span class="p">,</span> <span class="s2">&quot;false&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">enabled</span> <span class="o">=</span> <span class="n">enabled_env</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="s2">&quot;on&quot;</span><span class="p">}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">enabled</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">observability</span><span class="w"> </span><span class="kn">import</span> <span class="n">emit_event</span> <span class="k">as</span> <span class="n">_emit</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                <span class="n">_emit</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">_emit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">_emit</span><span class="p">(</span><span class="s2">&quot;backups_cleanup_disabled&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">emit_event</span><span class="p">(</span><span class="s2">&quot;backups_cleanup_disabled&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># ×›××©×¨ ××•×¤×¢×œ (enabled) ×•×‘×¡×‘×™×‘×ª ×˜×¡×˜×™×, × ×¤×¢×™×œ ×¤×¢× ××—×ª ××™×“×™×ª ×›×“×™ ×œ×”×‘×˜×™×— ×¤×œ×™×˜×ª ××™×¨×•×¢</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;PYTEST_CURRENT_TEST&quot;</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="kn">from</span><span class="w"> </span><span class="nn">file_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">backup_manager</span> <span class="k">as</span> <span class="n">_bm</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                        <span class="n">_bm</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">_bm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">summary</span> <span class="o">=</span> <span class="n">_bm</span><span class="o">.</span><span class="n">cleanup_expired_backups</span><span class="p">()</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="kn">from</span><span class="w"> </span><span class="nn">observability</span><span class="w"> </span><span class="kn">import</span> <span class="n">emit_event</span> <span class="k">as</span> <span class="n">_emit</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                                <span class="n">_emit</span> <span class="o">=</span> <span class="p">(</span><span class="k">lambda</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">:</span> <span class="kc">None</span><span class="p">)</span>
                            <span class="n">_emit</span><span class="p">(</span>
                                <span class="s2">&quot;backups_cleanup_done&quot;</span><span class="p">,</span>
                                <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span>
                                <span class="n">fs_scanned</span><span class="o">=</span><span class="nb">int</span><span class="p">((</span><span class="n">summary</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fs_scanned&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">),</span>
                                <span class="n">fs_deleted</span><span class="o">=</span><span class="nb">int</span><span class="p">((</span><span class="n">summary</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fs_deleted&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">),</span>
                                <span class="n">gridfs_scanned</span><span class="o">=</span><span class="nb">int</span><span class="p">((</span><span class="n">summary</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gridfs_scanned&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">),</span>
                                <span class="n">gridfs_deleted</span><span class="o">=</span><span class="nb">int</span><span class="p">((</span><span class="n">summary</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gridfs_deleted&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">),</span>
                            <span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="kn">from</span><span class="w"> </span><span class="nn">observability</span><span class="w"> </span><span class="kn">import</span> <span class="n">emit_event</span> <span class="k">as</span> <span class="n">_emit</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                                <span class="n">_emit</span> <span class="o">=</span> <span class="p">(</span><span class="k">lambda</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">:</span> <span class="kc">None</span><span class="p">)</span>
                            <span class="n">_emit</span><span class="p">(</span><span class="s2">&quot;backups_cleanup_error&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;anomaly&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="c1"># Fail-open: ××™×Ÿ ×œ×”×¤×™×œ ××ª ×”-setup ×× ×©×›×‘×ª observability ×œ× ×–××™× ×”</span>
        <span class="k">pass</span>
    
    <span class="c1"># ×”×¤×¢×œ×ª ×©×¨×ª ×§×˜×Ÿ ×œ-/health ×•-/share/&lt;id&gt; â€” ×›×‘×•×™ ×›×‘×¨×™×¨×ª ××—×“×œ</span>
    <span class="n">enable_internal_web</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;ENABLE_INTERNAL_SHARE_WEB&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span>
    <span class="k">if</span> <span class="n">enable_internal_web</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">PUBLIC_BASE_URL</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">services.webserver</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_app</span>
            <span class="n">aiohttp_app</span> <span class="o">=</span> <span class="n">create_app</span><span class="p">()</span>
            <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_start_web_job</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
                <span class="n">runner</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">AppRunner</span><span class="p">(</span><span class="n">aiohttp_app</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">runner</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
                <span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;PORT&quot;</span><span class="p">,</span> <span class="s2">&quot;10000&quot;</span><span class="p">))</span>
                <span class="n">site</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">TCPSite</span><span class="p">(</span><span class="n">runner</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">site</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ğŸŒ Internal web server started on :</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="kn">from</span><span class="w"> </span><span class="nn">observability</span><span class="w"> </span><span class="kn">import</span> <span class="n">emit_event</span> <span class="k">as</span> <span class="n">_emit</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                        <span class="n">_emit</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">:</span> <span class="kc">None</span>
                    <span class="n">_emit</span><span class="p">(</span><span class="s2">&quot;internal_web_started&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">port</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="c1"># ×œ×”×¨×™×¥ ××—×¨×™ ×©×”××¤×œ×™×§×¦×™×” ×”×ª×—×™×œ×”, ×›×“×™ ×œ×”×™×× ×¢ ×-PTBUserWarning</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">application</span><span class="o">.</span><span class="n">job_queue</span><span class="o">.</span><span class="n">run_once</span><span class="p">(</span><span class="n">_start_web_job</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1"># ×‘×¡×‘×™×‘×ª ×˜×¡×˜×™×, ×”-run_once ×¢×©×•×™ ×œ×”×—×–×™×¨ create_task; × ××ª×™×Ÿ ×œ×• ×›×“×™ ×œ×”×‘×˜×™×— ×©×”××™×¨×•×¢ ×™×•×¤×§</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_asyncio</span>
                <span class="k">if</span> <span class="n">_asyncio</span><span class="o">.</span><span class="n">isfuture</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_asyncio</span><span class="o">.</span><span class="n">iscoroutine</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
                    <span class="k">await</span> <span class="n">result</span>
                    <span class="c1"># Double-emit defensively for tests that expect the event synchronously</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="kn">from</span><span class="w"> </span><span class="nn">observability</span><span class="w"> </span><span class="kn">import</span> <span class="n">emit_event</span> <span class="k">as</span> <span class="n">_emit</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                            <span class="n">_emit</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">:</span> <span class="kc">None</span>
                        <span class="n">_emit</span><span class="p">(</span><span class="s2">&quot;internal_web_started&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;PORT&quot;</span><span class="p">,</span> <span class="s2">&quot;10000&quot;</span><span class="p">)))</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># ×× ××™×Ÿ Future ×œ×—×›×•×ª ×œ×•, ×”×¤×§ ××™×¨×•×¢ &quot;start&quot; ×‘××•×¤×Ÿ ××™×˜×‘×™ ×›×“×™ ×œ× ×œ×¤×¡×¤×¡ ×‘×˜×¡×˜×™×</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">port_guess</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;PORT&quot;</span><span class="p">,</span> <span class="s2">&quot;10000&quot;</span><span class="p">))</span>
                        <span class="n">emit_event</span><span class="p">(</span><span class="s2">&quot;internal_web_started&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port_guess</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âš ï¸ Failed to start internal web server: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">emit_event</span><span class="p">(</span><span class="s2">&quot;internal_web_start_failed&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;â„¹ï¸ Skipping internal web server (disabled or missing PUBLIC_BASE_URL)&quot;</span><span class="p">)</span>

    <span class="c1"># Register reminders feature (handlers + scheduler)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">reminders.handlers</span><span class="w"> </span><span class="kn">import</span> <span class="n">setup_reminder_handlers</span>  <span class="c1"># type: ignore</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">reminders.scheduler</span><span class="w"> </span><span class="kn">import</span> <span class="n">setup_reminder_scheduler</span>  <span class="c1"># type: ignore</span>
        <span class="c1"># ×©××•×¨ db_manager ×‘-bot_data ×›×“×™ ×©-reminders ×™×©×ª××© ×‘××•×ª×• ×—×™×‘×•×¨ DB</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;db&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
                <span class="n">application</span><span class="o">.</span><span class="n">bot_data</span><span class="p">[</span><span class="s1">&#39;db_manager&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">db</span>  <span class="c1"># type: ignore[name-defined]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">setup_reminder_handlers</span><span class="p">(</span><span class="n">application</span><span class="p">)</span>
        <span class="n">setup_reminder_scheduler</span><span class="p">(</span><span class="n">application</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;âœ… Reminders registered&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reminders init skipped: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Reschedule Google Drive backup jobs for all users with an active schedule</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_reschedule_drive_jobs</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">drive_handler</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">bot_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;drive_handler&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">drive_handler</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="c1"># Access users collection directly to find users with drive schedules</span>
                <span class="n">users_coll</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">users</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;db&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">users_coll</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="n">sched_keys</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;daily&quot;</span><span class="p">,</span> <span class="s2">&quot;every3&quot;</span><span class="p">,</span> <span class="s2">&quot;weekly&quot;</span><span class="p">,</span> <span class="s2">&quot;biweekly&quot;</span><span class="p">,</span> <span class="s2">&quot;monthly&quot;</span><span class="p">}</span>
                <span class="n">cursor</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">cursor</span> <span class="o">=</span> <span class="n">users_coll</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s2">&quot;drive_prefs.schedule&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">sched_keys</span><span class="p">)}})</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">cursor</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">uid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">uid</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">prefs</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;drive_prefs&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;schedule&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">sched_keys</span><span class="p">:</span>
                            <span class="c1"># Ensure a repeating job exists and is aligned to the next planned time</span>
                            <span class="c1"># _ensure_schedule_job ××™×•×¢×“ ×‘-drive_handler; ×× ×œ× ×§×™×™×, × ×ª×¢×œ× ×‘×©×§×˜</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">await</span> <span class="n">drive_handler</span><span class="o">.</span><span class="n">_ensure_schedule_job</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                                <span class="k">pass</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">continue</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="c1"># Run once shortly after startup ×›×“×™ ×œ××¤×©×¨ ×œ-JobQueue ×œ×”×ª×™×™×¦×‘ ×‘×œ×™ ××–×”×¨×•×ª misfire</span>
        <span class="n">application</span><span class="o">.</span><span class="n">job_queue</span><span class="o">.</span><span class="n">run_once</span><span class="p">(</span>
            <span class="n">_reschedule_drive_jobs</span><span class="p">,</span>
            <span class="n">when</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>  <span class="c1"># ×”×©×™×”×™×” ×§×˜× ×” ×›×“×™ ×œ× ×œ×¢×§×•×£ ××ª ×–××Ÿ ×”×¡×˜××¨×˜××¤ ×©×œ APScheduler</span>
            <span class="n">job_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;misfire_grace_time&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">},</span>  <span class="c1"># ××©××™×¨ ××¨×•×•×— × ×©×™××” ×›×š ×©××™×—×•×¨ ×§×˜×Ÿ ×œ× ×™×“×•×•×—</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to schedule Drive jobs rescan on startup&quot;</span><span class="p">)</span>

    <span class="c1"># Weekly admin report (usage summary) â€” scheduled with JobQueue</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_weekly_admin_report</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># ××¤×©×¨ ×œ×›×‘×•×ª ×‘×“×•×—×•×ª ×©×‘×•×¢×™×™× ×œ×—×œ×•×˜×™×Ÿ ×“×¨×š ENV</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DISABLE_WEEKLY_REPORTS&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">}:</span>
                    <span class="k">return</span>

                <span class="c1"># ×× ×’× ×•×Ÿ ×”×©×ª×§×” ×©×‘×•×¢×™ (idempotent): ×©×œ×— ×¤×¢× ××—×ª ×œ×›×œ ×©×‘×•×¢ ×§×œ× ×“×¨×™</span>
                <span class="n">should_send</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timezone</span> <span class="k">as</span> <span class="n">_tz</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">database</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span> <span class="k">as</span> <span class="n">_dbm</span>
                    <span class="n">db_obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">_dbm</span><span class="p">,</span> <span class="s1">&#39;db&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">is_noop_db</span> <span class="o">=</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">db_obj</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;noop_db&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">db_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_noop_db</span> <span class="ow">and</span> <span class="n">db_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">admin_reports</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">db_obj</span><span class="p">,</span> <span class="s1">&#39;admin_reports&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">admin_reports</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">_tz</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
                            <span class="n">iso</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">isocalendar</span><span class="p">()</span>
                            <span class="n">week_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">iso</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">iso</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="n">res</span> <span class="o">=</span> <span class="n">admin_reports</span><span class="o">.</span><span class="n">update_one</span><span class="p">(</span>
                                <span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;weekly_admin_report&quot;</span><span class="p">,</span> <span class="s2">&quot;week_key&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$ne&quot;</span><span class="p">:</span> <span class="n">week_key</span><span class="p">}},</span>
                                <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;week_key&quot;</span><span class="p">:</span> <span class="n">week_key</span><span class="p">,</span> <span class="s2">&quot;last_sent_at&quot;</span><span class="p">:</span> <span class="n">now</span><span class="p">}},</span>
                                <span class="n">upsert</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="p">)</span>
                            <span class="n">modified</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="s1">&#39;modified_count&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
                            <span class="n">upserted</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="s1">&#39;upserted_id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                            <span class="n">should_send</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">modified</span> <span class="ow">or</span> <span class="n">upserted</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="c1"># ×‘××§×¨×” ×©×œ ×›×©×œ ×‘×’×™×™×˜×™× ×’, × ××©×™×š ×œ×©×œ×•×— (×¢×“×™×£ ×“×™×•×•×— ×¢×œ ×›×¤×™×œ×•×ª ×××©×¨ ××™×‘×•×“ ×“×™×•×•×—)</span>
                    <span class="n">should_send</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">should_send</span><span class="p">:</span>
                    <span class="k">return</span>

                <span class="n">total_users</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">active_week</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">general</span> <span class="o">=</span> <span class="n">user_stats</span><span class="o">.</span><span class="n">get_all_time_stats</span><span class="p">()</span>
                    <span class="n">weekly</span> <span class="o">=</span> <span class="n">user_stats</span><span class="o">.</span><span class="n">get_weekly_stats</span><span class="p">()</span> <span class="ow">or</span> <span class="p">[]</span>
                    <span class="n">active_week</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">weekly</span><span class="p">))</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">general</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="n">total_users</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">general</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;total_users&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;ğŸ“Š ×“×•&quot;&quot;×— ×©×‘×•×¢×™ â€” CodeBot</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;ğŸ‘¥ ××©×ª××©×™× ×¨×©×•××™×: </span><span class="si">{</span><span class="n">total_users</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;ğŸ—“ï¸ ×¤×¢×™×œ×™× ×‘×©×‘×•×¢ ×”××—×¨×•×Ÿ: </span><span class="si">{</span><span class="n">active_week</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">await</span> <span class="n">notify_admins</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
                <span class="c1"># Emit via a dynamic import to cooperate with test monkeypatching</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="kn">from</span><span class="w"> </span><span class="nn">observability</span><span class="w"> </span><span class="kn">import</span> <span class="n">emit_event</span> <span class="k">as</span> <span class="n">_emit</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                        <span class="n">_emit</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">:</span> <span class="kc">None</span>
                    <span class="n">_emit</span><span class="p">(</span><span class="s2">&quot;weekly_report_sent&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="n">total_users</span><span class="o">=</span><span class="n">total_users</span><span class="p">,</span> <span class="n">active_week</span><span class="o">=</span><span class="n">active_week</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="kn">from</span><span class="w"> </span><span class="nn">observability</span><span class="w"> </span><span class="kn">import</span> <span class="n">emit_event</span> <span class="k">as</span> <span class="n">_emit</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                        <span class="n">_emit</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">:</span> <span class="kc">None</span>
                    <span class="n">_emit</span><span class="p">(</span><span class="s2">&quot;weekly_report_error&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="c1"># Run weekly; first run after a short delay to avoid startup contention</span>
        <span class="n">when_seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;WEEKLY_REPORT_DELAY_SECS&quot;</span><span class="p">,</span> <span class="s2">&quot;3600&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">3600</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">application</span><span class="o">.</span><span class="n">job_queue</span><span class="o">.</span><span class="n">run_repeating</span><span class="p">(</span>
                <span class="n">_weekly_admin_report</span><span class="p">,</span>
                <span class="n">interval</span><span class="o">=</span><span class="mi">7</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">,</span>
                <span class="n">first</span><span class="o">=</span><span class="n">when_seconds</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;weekly_admin_report&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># In restricted test environments, schedule may fail due to event loop state.</span>
            <span class="c1"># Fallback: run once immediately with a minimal context stub to avoid attribute errors.</span>
            <span class="k">class</span><span class="w"> </span><span class="nc">_Ctx</span><span class="p">:</span>
                <span class="n">bot</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># notify_admins will no-op safely if bot is missing</span>
            <span class="k">await</span> <span class="n">_weekly_admin_report</span><span class="p">(</span><span class="n">_Ctx</span><span class="p">())</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="c1"># Background cleanup jobs (Phase 2): cache maintenance and backups retention</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_cache_maintenance_job</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># ×›×™×‘×•×™ ×’×œ×•×‘×œ×™ ×“×¨×š ENV</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DISABLE_BACKGROUND_CLEANUP&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">}:</span>
                    <span class="k">return</span>
                <span class="c1"># × ×™×§×•×™ ×¢×“×™×Ÿ ×©×œ ×§××© (respect SAFE_MODE/DISABLE_CACHE_MAINTENANCE internally)</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">cache_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">cache</span>  <span class="c1"># lazy import</span>
                <span class="c1"># × ×™×ª×Ÿ ×œ×©×œ×•×˜ ×‘×¤×¨××˜×¨×™× ×“×¨×š ENV</span>
                <span class="n">max_scan</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;CACHE_MAINT_MAX_SCAN&quot;</span><span class="p">,</span> <span class="s2">&quot;1000&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">1000</span><span class="p">)</span>
                <span class="n">ttl_thr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;CACHE_MAINT_TTL_THRESHOLD&quot;</span><span class="p">,</span> <span class="s2">&quot;60&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">60</span><span class="p">)</span>
                <span class="n">deleted</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cache</span><span class="o">.</span><span class="n">clear_stale</span><span class="p">(</span><span class="n">max_scan</span><span class="o">=</span><span class="n">max_scan</span><span class="p">,</span> <span class="n">ttl_seconds_threshold</span><span class="o">=</span><span class="n">ttl_thr</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">deleted</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="kn">from</span><span class="w"> </span><span class="nn">observability</span><span class="w"> </span><span class="kn">import</span> <span class="n">emit_event</span> <span class="k">as</span> <span class="n">_emit</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                        <span class="n">_emit</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">:</span> <span class="kc">None</span>
                    <span class="n">_emit</span><span class="p">(</span><span class="s2">&quot;cache_maintenance_done&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="n">deleted</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">deleted</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">observability</span><span class="w"> </span><span class="kn">import</span> <span class="n">emit_event</span> <span class="k">as</span> <span class="n">_emit</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                    <span class="n">_emit</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">:</span> <span class="kc">None</span>
                <span class="n">_emit</span><span class="p">(</span><span class="s2">&quot;cache_maintenance_error&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;anomaly&quot;</span><span class="p">)</span>

        <span class="c1"># ×ª×–××•×Ÿ ×ª×—×–×•×§×ª ×§××© â€“ ×›×œ 10 ×“×§×•×ª, ×”×ª×—×œ×” ××—×¨×™ 30 ×©× ×™×•×ª</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">interval_secs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;CACHE_MAINT_INTERVAL_SECS&quot;</span><span class="p">,</span> <span class="s2">&quot;600&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">600</span><span class="p">)</span>
            <span class="n">first_secs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;CACHE_MAINT_FIRST_SECS&quot;</span><span class="p">,</span> <span class="s2">&quot;30&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">30</span><span class="p">)</span>
            <span class="n">application</span><span class="o">.</span><span class="n">job_queue</span><span class="o">.</span><span class="n">run_repeating</span><span class="p">(</span>
                <span class="n">_cache_maintenance_job</span><span class="p">,</span>
                <span class="n">interval</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="n">interval_secs</span><span class="p">),</span>
                <span class="n">first</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">first_secs</span><span class="p">),</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cache_maintenance&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># ×‘×¡×‘×™×‘×•×ª ××•×’×‘×œ×•×ª (×›××• ×˜×¡×˜×™×) ×”×ª×–××•×Ÿ ×¢×©×•×™ ×œ×”×›×©×œ â€” × ×¨×™×¥ ×¤×¢× ××—×ª ××™×“×™×ª</span>
            <span class="k">class</span><span class="w"> </span><span class="nc">_CtxMaint</span><span class="p">:</span>
                <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">application</span> <span class="o">=</span> <span class="n">app</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">_cache_maintenance_job</span><span class="p">(</span><span class="n">_CtxMaint</span><span class="p">(</span><span class="n">application</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="c1"># ×”×¢×¨×”: ×œ× × ×¤×¢×™×œ ×”×¨×¦×” ×›×¤×•×œ×” ×›××©×¨ ×”×ª×–××•×Ÿ ××¦×œ×™×—</span>
        <span class="c1"># ×›×“×™ ×œ×× ×•×¢ ×¤×œ×™×§×•×ª ×‘×˜×¡×˜×™×/×¡×™×™×“-××¤×§×˜×™× ×›×¤×•×œ×™×. ×”×¨×¦×” ×—×“-×¤×¢××™×ª</span>
        <span class="c1"># ××ª×‘×¦×¢×ª ×¨×§ ×‘-fallback ×›××©×¨ ×”×ª×–××•×Ÿ × ×›×©×œ.</span>

        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_backups_cleanup_job</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># ×›×™×‘×•×™ ×’×œ×•×‘×œ×™ ×“×¨×š ENV</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DISABLE_BACKGROUND_CLEANUP&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">}:</span>
                    <span class="k">return</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">file_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">backup_manager</span>  <span class="c1"># lazy import</span>
                <span class="n">summary</span> <span class="o">=</span> <span class="n">backup_manager</span><span class="o">.</span><span class="n">cleanup_expired_backups</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">observability</span><span class="w"> </span><span class="kn">import</span> <span class="n">emit_event</span> <span class="k">as</span> <span class="n">_emit</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                    <span class="n">_emit</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">:</span> <span class="kc">None</span>
                <span class="n">_emit</span><span class="p">(</span>
                    <span class="s2">&quot;backups_cleanup_done&quot;</span><span class="p">,</span>
                    <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span>
                    <span class="n">fs_scanned</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">summary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fs_scanned&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="n">fs_deleted</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">summary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fs_deleted&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="n">gridfs_scanned</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">summary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gridfs_scanned&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="n">gridfs_deleted</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">summary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gridfs_deleted&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">observability</span><span class="w"> </span><span class="kn">import</span> <span class="n">emit_event</span> <span class="k">as</span> <span class="n">_emit</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                    <span class="n">_emit</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">:</span> <span class="kc">None</span>
                <span class="n">_emit</span><span class="p">(</span><span class="s2">&quot;backups_cleanup_error&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;anomaly&quot;</span><span class="p">)</span>

        <span class="c1"># ×ª×–××•×Ÿ × ×™×§×•×™ ×’×™×‘×•×™×™× â€“ ×›×‘×•×™ ×›×‘×¨×™×¨×ª ××—×“×œ; ×™×•×¤×¢×œ ×¨×§ ×× BACKUPS_CLEANUP_ENABLED=true</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">enabled</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;BACKUPS_CLEANUP_ENABLED&quot;</span><span class="p">,</span> <span class="s2">&quot;false&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="s2">&quot;on&quot;</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">enabled</span><span class="p">:</span>
                <span class="c1"># ×‘×¡×‘×™×‘×ª ×˜×¡×˜×™×: ×”×¤×¢×œ × ×™×§×•×™ ×¤×¢× ××—×ª ××™×“×™×ª ×›×“×™ ×œ×”×‘×˜×™×— ×¤×œ×™×˜×ª ××™×¨×•×¢,</span>
                <span class="c1"># ×œ×œ× ×ª×œ×•×ª ×‘××•×–×¨×•×™×•×ª ×©×œ ×œ×•×œ××•×ª asyncio ×‘×¡×™××•×œ×¦×™×” ×©×œ ×”-JobQueue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;PYTEST_CURRENT_TEST&quot;</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="kn">from</span><span class="w"> </span><span class="nn">file_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">backup_manager</span> <span class="k">as</span> <span class="n">_bm</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                            <span class="n">_bm</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">if</span> <span class="n">_bm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">summary</span> <span class="o">=</span> <span class="n">_bm</span><span class="o">.</span><span class="n">cleanup_expired_backups</span><span class="p">()</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="kn">from</span><span class="w"> </span><span class="nn">observability</span><span class="w"> </span><span class="kn">import</span> <span class="n">emit_event</span> <span class="k">as</span> <span class="n">_emit</span>
                                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                                    <span class="n">_emit</span> <span class="o">=</span> <span class="p">(</span><span class="k">lambda</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">:</span> <span class="kc">None</span><span class="p">)</span>
                                <span class="n">_emit</span><span class="p">(</span>
                                    <span class="s2">&quot;backups_cleanup_done&quot;</span><span class="p">,</span>
                                    <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span>
                                    <span class="n">fs_scanned</span><span class="o">=</span><span class="nb">int</span><span class="p">((</span><span class="n">summary</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fs_scanned&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">),</span>
                                    <span class="n">fs_deleted</span><span class="o">=</span><span class="nb">int</span><span class="p">((</span><span class="n">summary</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fs_deleted&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">),</span>
                                    <span class="n">gridfs_scanned</span><span class="o">=</span><span class="nb">int</span><span class="p">((</span><span class="n">summary</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gridfs_scanned&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">),</span>
                                    <span class="n">gridfs_deleted</span><span class="o">=</span><span class="nb">int</span><span class="p">((</span><span class="n">summary</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gridfs_deleted&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">),</span>
                                <span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="kn">from</span><span class="w"> </span><span class="nn">observability</span><span class="w"> </span><span class="kn">import</span> <span class="n">emit_event</span> <span class="k">as</span> <span class="n">_emit</span>
                                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                                    <span class="n">_emit</span> <span class="o">=</span> <span class="p">(</span><span class="k">lambda</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">:</span> <span class="kc">None</span><span class="p">)</span>
                                <span class="n">_emit</span><span class="p">(</span><span class="s2">&quot;backups_cleanup_error&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;anomaly&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="c1"># ×œ× × ×™×ª×Ÿ/×œ× × ×“×¨×© ×‘×¡×‘×™×‘×” ×–×• â€” × ××©×™×š ×œ×ª×–××•×Ÿ ×”×¨×’×™×œ</span>
                    <span class="k">pass</span>
                <span class="n">interval_secs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;BACKUPS_CLEANUP_INTERVAL_SECS&quot;</span><span class="p">,</span> <span class="s2">&quot;86400&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">86400</span><span class="p">)</span>
                <span class="n">first_secs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;BACKUPS_CLEANUP_FIRST_SECS&quot;</span><span class="p">,</span> <span class="s2">&quot;180&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">180</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">application</span><span class="o">.</span><span class="n">job_queue</span><span class="o">.</span><span class="n">run_repeating</span><span class="p">(</span>
                        <span class="n">_backups_cleanup_job</span><span class="p">,</span>
                        <span class="n">interval</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mi">3600</span><span class="p">,</span> <span class="n">interval_secs</span><span class="p">),</span>
                        <span class="n">first</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">first_secs</span><span class="p">),</span>
                        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;backups_cleanup&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="c1"># ×‘×¡×‘×™×‘×•×ª ××•×’×‘×œ×•×ª (×›××• ×˜×¡×˜×™×) ×”×ª×–××•×Ÿ ×¢×©×•×™ ×œ×”×›×©×œ â€” × ×¨×™×¥ ×¤×¢× ××—×ª ××™×“×™×ª</span>
                    <span class="k">class</span><span class="w"> </span><span class="nc">_CtxBkp</span><span class="p">:</span>
                        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">application</span> <span class="o">=</span> <span class="n">app</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">_backups_cleanup_job</span><span class="p">(</span><span class="n">_CtxBkp</span><span class="p">(</span><span class="n">application</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># ×‘×¡×‘×™×‘×•×ª ×˜×¡×˜×™×, ×”×‘×˜×—×ª ×××™×ª×•×ª: ×”×¤×¢×œ ×”×¨×¦×” ×—×“-×¤×¢××™×ª ×›×“×™ ×œ×¤×œ×•×˜ ××™×¨×•×¢</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;PYTEST_CURRENT_TEST&quot;</span><span class="p">):</span>
                            <span class="k">class</span><span class="w"> </span><span class="nc">_Ctx2</span><span class="p">:</span>
                                <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">):</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">application</span> <span class="o">=</span> <span class="n">app</span>
                            <span class="k">await</span> <span class="n">_backups_cleanup_job</span><span class="p">(</span><span class="n">_Ctx2</span><span class="p">(</span><span class="n">application</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Emit the disabled event reliably and in a test-friendly way:</span>
                <span class="c1"># 1) Prefer a late dynamic import (cooperates with tests that patch sys.modules at runtime)</span>
                <span class="c1"># 2) Fallback to the already-imported emit_event when dynamic import is unavailable</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="kn">from</span><span class="w"> </span><span class="nn">observability</span><span class="w"> </span><span class="kn">import</span> <span class="n">emit_event</span> <span class="k">as</span> <span class="n">_emit</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                        <span class="n">_emit</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">_emit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">_emit</span><span class="p">(</span><span class="s2">&quot;backups_cleanup_disabled&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">emit_event</span><span class="p">(</span><span class="s2">&quot;backups_cleanup_disabled&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="c1"># Fail-open: do not raise if observability layer is unavailable</span>
                    <span class="k">pass</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># Fail-open: ××œ ×ª×›×©×™×œ ××ª ×¢×œ×™×™×ª ×”×‘×•×˜</span>
            <span class="k">pass</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="c1"># Fail-open: ××œ ×ª×›×©×™×œ ××ª ×¢×œ×™×™×ª ×”×‘×•×˜ ×× ×”×ª×–××•×Ÿ × ×›×©×œ</span>
        <span class="k">pass</span>

    <span class="c1"># Predictive Health sampler: scrape webapp /metrics and feed predictive engine</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_predictive_sampler_job</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>  <span class="c1"># noqa: ARG001</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;PYTEST_CURRENT_TEST&quot;</span><span class="p">):</span>
                    <span class="n">allow_in_tests</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;PREDICTIVE_SAMPLER_RUN_IN_TESTS&quot;</span><span class="p">,</span> <span class="s2">&quot;false&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">allow_in_tests</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="s2">&quot;on&quot;</span><span class="p">}:</span>
                        <span class="k">return</span>
                <span class="c1"># Feature flag: allow disabling explicitly</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;PREDICTIVE_SAMPLER_ENABLED&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="s2">&quot;on&quot;</span><span class="p">}:</span>
                    <span class="k">return</span>
                <span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;PREDICTIVE_SAMPLER_METRICS_URL&quot;</span><span class="p">)</span>
                        <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;WEBAPP_URL&quot;</span><span class="p">)</span>
                        <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;PUBLIC_BASE_URL&quot;</span><span class="p">)</span>
                        <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">base</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="c1"># Normalize URL and build metrics path</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/metrics&quot;</span>
                <span class="n">text</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">http_async</span><span class="w"> </span><span class="kn">import</span> <span class="n">request</span> <span class="k">as</span> <span class="n">async_request</span>  <span class="c1"># type: ignore</span>
                    <span class="k">async</span> <span class="k">with</span> <span class="n">async_request</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">service</span><span class="o">=</span><span class="s2">&quot;webapp&quot;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="s2">&quot;/metrics&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                            <span class="c1"># aiohttp response supports .text() coroutine</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">text</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>  <span class="c1"># type: ignore[attr-defined]</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">text</span> <span class="o">=</span> <span class="p">(</span><span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">read</span><span class="p">())</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="s2">&quot;ignore&quot;</span><span class="p">)</span>  <span class="c1"># type: ignore[attr-defined]</span>
                                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                    <span class="n">text</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="n">cur_lat</span> <span class="o">=</span> <span class="n">cur_err</span> <span class="o">=</span> <span class="n">thr_lat</span> <span class="o">=</span> <span class="n">thr_err</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">text</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
                            <span class="n">s</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span> <span class="ow">or</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">):</span>
                                <span class="k">continue</span>
                            <span class="c1"># Very simple Prometheus exposition parsing: &quot;name value&quot;</span>
                            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;adaptive_current_latency_avg_seconds &quot;</span><span class="p">):</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">cur_lat</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                    <span class="k">pass</span>
                            <span class="k">elif</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;adaptive_current_error_rate_percent &quot;</span><span class="p">):</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">cur_err</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                    <span class="k">pass</span>
                            <span class="k">elif</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;adaptive_latency_threshold_seconds &quot;</span><span class="p">):</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">thr_lat</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                    <span class="k">pass</span>
                            <span class="k">elif</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;adaptive_error_rate_threshold_percent &quot;</span><span class="p">):</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">thr_err</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                    <span class="k">pass</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">cur_lat</span> <span class="o">=</span> <span class="n">cur_err</span> <span class="o">=</span> <span class="n">thr_lat</span> <span class="o">=</span> <span class="n">thr_err</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="c1"># Feed predictive engine with the best available snapshot</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">predictive_engine</span><span class="w"> </span><span class="kn">import</span> <span class="n">note_observation</span><span class="p">,</span> <span class="n">maybe_recompute_and_preempt</span>  <span class="c1"># type: ignore</span>
                    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">if</span> <span class="n">cur_err</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;error_rate_percent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cur_err</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">cur_lat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;latency_seconds&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cur_lat</span><span class="p">)</span>
                    <span class="c1"># memory is handled inside note_observation when omitted</span>
                    <span class="n">note_observation</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># type: ignore[arg-type]</span>
                    <span class="n">maybe_recompute_and_preempt</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="c1"># Soft-fail, but report once per run</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="kn">from</span><span class="w"> </span><span class="nn">observability</span><span class="w"> </span><span class="kn">import</span> <span class="n">emit_event</span> <span class="k">as</span> <span class="n">_emit</span>  <span class="c1"># type: ignore</span>
                        <span class="n">_emit</span><span class="p">(</span><span class="s2">&quot;predictive_sampler_error&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;anomaly&quot;</span><span class="p">,</span> <span class="n">handled</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># Fail-open</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">observability</span><span class="w"> </span><span class="kn">import</span> <span class="n">emit_event</span> <span class="k">as</span> <span class="n">_emit</span>  <span class="c1"># type: ignore</span>
                    <span class="n">_emit</span><span class="p">(</span><span class="s2">&quot;predictive_sampler_exception&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;anomaly&quot;</span><span class="p">,</span> <span class="n">handled</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">interval_secs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;PREDICTIVE_SAMPLER_INTERVAL_SECS&quot;</span><span class="p">,</span> <span class="s2">&quot;60&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">60</span><span class="p">)</span>
            <span class="n">first_secs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;PREDICTIVE_SAMPLER_FIRST_SECS&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">10</span><span class="p">)</span>
            <span class="n">application</span><span class="o">.</span><span class="n">job_queue</span><span class="o">.</span><span class="n">run_repeating</span><span class="p">(</span>
                <span class="n">_predictive_sampler_job</span><span class="p">,</span>
                <span class="n">interval</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="n">interval_secs</span><span class="p">),</span>
                <span class="n">first</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">first_secs</span><span class="p">),</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;predictive_sampler&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># ×‘×¡×‘×™×‘×•×ª ×©×‘×”×Ÿ ×”-JobQueue ×œ× ×–××™×Ÿ (×œ××©×œ ×—×œ×§ ××”×˜×¡×˜×™×), ×”×¨×¥ ×¤×¢× ××—×ª ××™×“×™×ª</span>
            <span class="k">class</span><span class="w"> </span><span class="nc">_Ctx</span><span class="p">:</span>
                <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">application</span> <span class="o">=</span> <span class="n">app</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">_predictive_sampler_job</span><span class="p">(</span><span class="n">_Ctx</span><span class="p">(</span><span class="n">application</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>

<span class="c1"># --- Background job: Cache warming based on recent usage (lightweight) ---</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_cache_warming_job</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>  <span class="c1"># noqa: ARG001</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Feature flag</span>
                <span class="n">enabled</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;CACHE_WARMING_ENABLED&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="s2">&quot;on&quot;</span><span class="p">}</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">enabled</span><span class="p">:</span>
                    <span class="k">return</span>

                <span class="c1"># Time budget to avoid load</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_t</span>
                <span class="n">budget</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;CACHE_WARMING_BUDGET_SECONDS&quot;</span><span class="p">,</span> <span class="s2">&quot;1.0&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="mf">1.0</span><span class="p">)</span>
                <span class="n">t0</span> <span class="o">=</span> <span class="n">_t</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

                <span class="c1"># Lazy imports to avoid hard deps</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">cache_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">cache</span> <span class="k">as</span> <span class="n">_cache</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                    <span class="n">_cache</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">webapp.app</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_db</span> <span class="k">as</span> <span class="n">_get_db</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                    <span class="n">_get_db</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">webapp.app</span><span class="w"> </span><span class="kn">import</span> <span class="n">search_engine</span> <span class="k">as</span> <span class="n">_search_engine</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                    <span class="n">_search_engine</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">if</span> <span class="n">_cache</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">_cache</span><span class="p">,</span> <span class="s1">&#39;is_enabled&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_get_db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span>

                <span class="n">db</span> <span class="o">=</span> <span class="n">_get_db</span><span class="p">()</span>
                <span class="n">now</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="s1">&#39;datetime&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="nb">__import__</span><span class="p">(</span><span class="s1">&#39;datetime&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
                <span class="n">week_ago</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="nb">__import__</span><span class="p">(</span><span class="s1">&#39;datetime&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>

                <span class="c1"># Top active users in last 7 days (at most 3)</span>
                <span class="n">top_users</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">pipeline</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="p">{</span><span class="s2">&quot;$match&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;updated_at&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$gte&quot;</span><span class="p">:</span> <span class="n">week_ago</span><span class="p">}}},</span>
                        <span class="p">{</span><span class="s2">&quot;$group&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;$user_id&quot;</span><span class="p">,</span> <span class="s2">&quot;cnt&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$sum&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}}},</span>
                        <span class="p">{</span><span class="s2">&quot;$sort&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cnt&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">}},</span>
                        <span class="p">{</span><span class="s2">&quot;$limit&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span>
                    <span class="p">]</span>
                    <span class="n">agg</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">code_snippets</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">pipeline</span><span class="p">))</span>
                    <span class="n">top_users</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_id&quot;</span><span class="p">))</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">agg</span> <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_id&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>

                <span class="c1"># Seeds: common keywords + top tags (last 7d)</span>
                <span class="n">seeds</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;def&quot;</span><span class="p">,</span> <span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;import&quot;</span><span class="p">,</span> <span class="s2">&quot;fix&quot;</span><span class="p">,</span> <span class="s2">&quot;refactor&quot;</span><span class="p">,</span> <span class="s2">&quot;todo&quot;</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">tag_pipe</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="p">{</span><span class="s2">&quot;$match&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;updated_at&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$gte&quot;</span><span class="p">:</span> <span class="n">week_ago</span><span class="p">},</span> <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$exists&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;$ne&quot;</span><span class="p">:</span> <span class="p">[]}}},</span>
                        <span class="p">{</span><span class="s2">&quot;$unwind&quot;</span><span class="p">:</span> <span class="s2">&quot;$tags&quot;</span><span class="p">},</span>
                        <span class="p">{</span><span class="s2">&quot;$group&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;$tags&quot;</span><span class="p">,</span> <span class="s2">&quot;cnt&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$sum&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}}},</span>
                        <span class="p">{</span><span class="s2">&quot;$sort&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;cnt&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">}},</span>
                        <span class="p">{</span><span class="s2">&quot;$limit&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span>
                    <span class="p">]</span>
                    <span class="n">tag_rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">code_snippets</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">tag_pipe</span><span class="p">))</span>
                    <span class="n">seeds</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_id&quot;</span><span class="p">))</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">tag_rows</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_id&quot;</span><span class="p">)]</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="c1"># Dedup and sanitize seeds</span>
                <span class="n">uniq_seeds</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">seeds</span><span class="p">:</span>
                    <span class="n">s2</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">s2</span> <span class="ow">and</span> <span class="n">s2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">uniq_seeds</span><span class="p">:</span>
                        <span class="n">uniq_seeds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s2</span><span class="p">)</span>

                <span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span><span class="o">,</span><span class="w"> </span><span class="nn">json</span>

                <span class="c1"># Warm per user: stats and suggestions</span>
                <span class="k">for</span> <span class="n">uid</span> <span class="ow">in</span> <span class="n">top_users</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">_t</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">budget</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="c1"># Stats (like /api/stats)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">active_q</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">uid</span><span class="p">,</span> <span class="s2">&quot;$or&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;is_active&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;is_active&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$exists&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}}]}</span>
                        <span class="n">stats</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s2">&quot;total_files&quot;</span><span class="p">:</span> <span class="n">db</span><span class="o">.</span><span class="n">code_snippets</span><span class="o">.</span><span class="n">count_documents</span><span class="p">(</span><span class="n">active_q</span><span class="p">),</span>
                            <span class="s2">&quot;languages&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">code_snippets</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="s2">&quot;programming_language&quot;</span><span class="p">,</span> <span class="n">active_q</span><span class="p">)),</span>
                            <span class="s2">&quot;recent_activity&quot;</span><span class="p">:</span> <span class="p">[],</span>
                        <span class="p">}</span>
                        <span class="n">recent</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">code_snippets</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">active_q</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;file_name&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;created_at&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">recent</span><span class="p">:</span>
                            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;recent_activity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                                <span class="s2">&quot;file_name&quot;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file_name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                                <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;created_at&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">now</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                            <span class="p">})</span>
                        <span class="n">raw</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({},</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="n">h</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">raw</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">16</span><span class="p">]</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;api:stats:user:</span><span class="si">{</span><span class="n">uid</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">_cache</span><span class="o">.</span><span class="n">set_dynamic</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="s2">&quot;user_stats&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">uid</span><span class="p">,</span> <span class="s2">&quot;endpoint&quot;</span><span class="p">:</span> <span class="s2">&quot;api_stats&quot;</span><span class="p">,</span> <span class="s2">&quot;access_frequency&quot;</span><span class="p">:</span> <span class="s2">&quot;high&quot;</span><span class="p">})</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>

                    <span class="c1"># Suggestions (if engine available)</span>
                    <span class="k">if</span> <span class="n">_search_engine</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">uniq_seeds</span><span class="p">:</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">_t</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">budget</span><span class="p">:</span>
                                <span class="k">break</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                                    <span class="k">continue</span>
                                <span class="n">sugg</span> <span class="o">=</span> <span class="n">_search_engine</span><span class="o">.</span><span class="n">suggest_completions</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
                                <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;q&quot;</span><span class="p">:</span> <span class="n">q</span><span class="p">},</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                                <span class="n">h</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">payload</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">16</span><span class="p">]</span>
                                <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;api:search_suggest:</span><span class="si">{</span><span class="n">uid</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="n">_cache</span><span class="o">.</span><span class="n">set_dynamic</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;suggestions&quot;</span><span class="p">:</span> <span class="n">sugg</span><span class="p">},</span> <span class="s2">&quot;search_results&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">uid</span><span class="p">,</span> <span class="s2">&quot;endpoint&quot;</span><span class="p">:</span> <span class="s2">&quot;api_search_suggestions&quot;</span><span class="p">})</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="k">continue</span>

                <span class="c1"># Emit</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="kn">from</span><span class="w"> </span><span class="nn">observability</span><span class="w"> </span><span class="kn">import</span> <span class="n">emit_event</span> <span class="k">as</span> <span class="n">_emit</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                        <span class="n">_emit</span> <span class="o">=</span> <span class="p">(</span><span class="k">lambda</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">:</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">_emit</span><span class="p">(</span><span class="s2">&quot;cache_warming_done&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">observability</span><span class="w"> </span><span class="kn">import</span> <span class="n">emit_event</span> <span class="k">as</span> <span class="n">_emit</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">_emit</span> <span class="o">=</span> <span class="p">(</span><span class="k">lambda</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">:</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">_emit</span><span class="p">(</span><span class="s2">&quot;cache_warming_error&quot;</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;anomaly&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">interval_secs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;CACHE_WARMING_INTERVAL_SECS&quot;</span><span class="p">,</span> <span class="s2">&quot;900&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">900</span><span class="p">)</span>
            <span class="n">first_secs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;CACHE_WARMING_FIRST_SECS&quot;</span><span class="p">,</span> <span class="s2">&quot;45&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">45</span><span class="p">)</span>
            <span class="n">application</span><span class="o">.</span><span class="n">job_queue</span><span class="o">.</span><span class="n">run_repeating</span><span class="p">(</span>
                <span class="n">_cache_warming_job</span><span class="p">,</span>
                <span class="n">interval</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mi">120</span><span class="p">,</span> <span class="n">interval_secs</span><span class="p">),</span>
                <span class="n">first</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">first_secs</span><span class="p">),</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cache_warming&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># ×‘×¡×‘×™×‘×•×ª ××•×’×‘×œ×•×ª (×›××• ×˜×¡×˜×™×) ×”×ª×–××•×Ÿ ×¢×©×•×™ ×œ×”×›×©×œ â€” × ×¨×™×¥ ×¤×¢× ××—×ª ××™×“×™×ª</span>
            <span class="k">class</span><span class="w"> </span><span class="nc">_CtxWarm</span><span class="p">:</span>
                <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">application</span> <span class="o">=</span> <span class="n">app</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">_cache_warming_job</span><span class="p">(</span><span class="n">_CtxWarm</span><span class="p">(</span><span class="n">application</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Development Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>