

<!DOCTYPE html>
<html class="writer-html5" lang="he" data-content_root="../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>main &mdash; תיעוד Code Keeper Bot 1.0.0</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=2d7a82d5" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=0062297a"></script>
      <script src="../_static/doctools.js?v=9a2dae69"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/translations.js?v=714bf7a6"></script>
      <script src="https://unpkg.com/mermaid@10.2.0/dist/mermaid.min.js"></script>
      <script>mermaid.initialize({startOnLoad:true});</script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="אינדקס" href="../genindex.html" />
    <link rel="search" title="חיפוש" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Code Keeper Bot
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">למפתחים ולסוכני AI:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quickstart-ai.html">התחלה מהירה - סוכני AI</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#id1">מטרה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#id2">מה אסור</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#id3">מה מותר ומומלץ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#id4">פורמטי ציטוט קוד</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#tmp">מחיקה בטוחה (רק ב-/tmp)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#pr">קומיטים ו-PR</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#id5">קישורים מהירים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">התחלה מהירה - מפתחים</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#id2">מטרה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#id3">שלב 1: התקנה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#env">שלב 2: הגדרת .env</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#id4">שלב 3: הרצה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#id5">מה הלאה?</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ai-guidelines.html">הנחיות מלאות לסוכני AI</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../ai-guidelines.html#id1">מגבלות קריטיות</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../ai-guidelines.html#id2">הרצת פקודות</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../ai-guidelines.html#id3">כלי קבצים מאושרים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ai-guidelines.html#id4">עקרונות עריכת קוד</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ai-guidelines.html#pull-requests">קומיטים ו-Pull Requests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ai-guidelines.html#id5">עבודה עם טסטים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ai-guidelines.html#id6">קישורים מהירים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../doc-authoring.html">Doc Authoring Guide (Sphinx/RTD)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../doc-authoring.html#id1">מטרות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../doc-authoring.html#id2">מדיניות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../doc-authoring.html#id3">טיפים מהירים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../doc-authoring.html#id4">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../style-glossary.html">Style &amp; Naming Glossary</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../style-glossary.html#id1">מטרות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../style-glossary.html#id2">מיפוי מונחים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../style-glossary.html#id3">כללים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../style-glossary.html#id4">עוגני תיעוד</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../versioning-stable-anchors.html">Versioning &amp; Stable Anchors</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../versioning-stable-anchors.html#id1">מדיניות עוגנים יציבים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../versioning-stable-anchors.html#whats-new">What’s New</a></li>
<li class="toctree-l2"><a class="reference internal" href="../versioning-stable-anchors.html#anchors">דוגמת Anchors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../versioning-stable-anchors.html#id2">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../whats-new.html">What’s New</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../whats-new.html#id1">2025-10-15</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../architecture.html">ארכיטקטורה</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#id2">סקירה כללית</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#id3">תרשים רכיבים (תמציתי)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#id4">מבנה תיקיות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#id5">זרימות מרכזיות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#id6">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">מדריך תרומה</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../contributing.html#id2">מטרה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributing.html#id3">כללים כלליים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributing.html#workflow">Workflow בסיסי</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributing.html#id4">דוגמאות שימושיות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributing.html#id5">קישורים</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">מדריכים בסיסיים:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">התקנה והגדרה</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#id2">דרישות מערכת</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#id3">התקנה מהירה</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#id4">1. שכפל את הריפוזיטורי</a></li>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#id5">2. התקן תלויות</a></li>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#id6">3. הגדר משתני סביבה</a></li>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#id7">4. הפעל את הבוט</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#docker">התקנה עם Docker</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#image">1. בנה את ה-Image</a></li>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#docker-compose">2. הפעל עם Docker Compose</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#mongodb">הגדרת MongoDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#telegram-bot">הגדרת Telegram Bot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#id8">הגדרות מתקדמות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#id9">בדיקת התקנה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#id10">פתרון בעיות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#id11">תמיכה</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../configuration.html">הגדרות תצורה</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#id2">קובץ התצורה הראשי</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#id3">משתני סביבה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#id4">הגדרות מתקדמות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#mongodb">הגדרת MongoDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#redis-cache">הגדרת Redis Cache</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#id5">הגדרות אבטחה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#id6">תצורה לסביבות שונות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#env">דוגמת קובץ .env מלא</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#id7">טיפים וטריקים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../environment-variables.html">משתני סביבה - רפרנס</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../environment-variables.html#id2">טבלה מרכזית</a></li>
<li class="toctree-l2"><a class="reference internal" href="../environment-variables.html#id3">דוגמאות קונפיגורציה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../environment-variables.html#id4">קישורים</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../api/main.html">main module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.get_admin_ids"><code class="docutils literal notranslate"><span class="pre">get_admin_ids()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.notify_admins"><code class="docutils literal notranslate"><span class="pre">notify_admins()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.recycle_backfill_command"><code class="docutils literal notranslate"><span class="pre">recycle_backfill_command()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.log_user_activity"><code class="docutils literal notranslate"><span class="pre">log_user_activity()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.get_lock_collection"><code class="docutils literal notranslate"><span class="pre">get_lock_collection()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.ensure_lock_indexes"><code class="docutils literal notranslate"><span class="pre">ensure_lock_indexes()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.cleanup_mongo_lock"><code class="docutils literal notranslate"><span class="pre">cleanup_mongo_lock()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.manage_mongo_lock"><code class="docutils literal notranslate"><span class="pre">manage_mongo_lock()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.application"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.application</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.github_handler"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.github_handler</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.backup_handler"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.backup_handler</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.__init__"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.setup_handlers"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.setup_handlers()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.help_command"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.help_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.save_command"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.save_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.list_command"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.list_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.search_command"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.search_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.check_commands"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.check_commands()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.stats_command"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.stats_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.handle_document"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.handle_document()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.handle_text_message"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.handle_text_message()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.error_handler"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.error_handler()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.start"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.start()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot.stop"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.stop()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.signal_handler"><code class="docutils literal notranslate"><span class="pre">signal_handler()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.setup_handlers"><code class="docutils literal notranslate"><span class="pre">setup_handlers()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.main"><code class="docutils literal notranslate"><span class="pre">main()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html#main.setup_bot_data"><code class="docutils literal notranslate"><span class="pre">setup_bot_data()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/config.html">config module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/config.html#config.BotConfig"><code class="docutils literal notranslate"><span class="pre">BotConfig</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.BOT_TOKEN"><code class="docutils literal notranslate"><span class="pre">BotConfig.BOT_TOKEN</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MONGODB_URL"><code class="docutils literal notranslate"><span class="pre">BotConfig.MONGODB_URL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.DATABASE_NAME"><code class="docutils literal notranslate"><span class="pre">BotConfig.DATABASE_NAME</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.REDIS_URL"><code class="docutils literal notranslate"><span class="pre">BotConfig.REDIS_URL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.CACHE_ENABLED"><code class="docutils literal notranslate"><span class="pre">BotConfig.CACHE_ENABLED</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.GITHUB_TOKEN"><code class="docutils literal notranslate"><span class="pre">BotConfig.GITHUB_TOKEN</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.PASTEBIN_API_KEY"><code class="docutils literal notranslate"><span class="pre">BotConfig.PASTEBIN_API_KEY</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MAX_CODE_SIZE"><code class="docutils literal notranslate"><span class="pre">BotConfig.MAX_CODE_SIZE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MAX_FILES_PER_USER"><code class="docutils literal notranslate"><span class="pre">BotConfig.MAX_FILES_PER_USER</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.SUPPORTED_LANGUAGES"><code class="docutils literal notranslate"><span class="pre">BotConfig.SUPPORTED_LANGUAGES</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.RECYCLE_TTL_DAYS"><code class="docutils literal notranslate"><span class="pre">BotConfig.RECYCLE_TTL_DAYS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.PUBLIC_BASE_URL"><code class="docutils literal notranslate"><span class="pre">BotConfig.PUBLIC_BASE_URL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.WEBAPP_URL"><code class="docutils literal notranslate"><span class="pre">BotConfig.WEBAPP_URL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MAINTENANCE_MODE"><code class="docutils literal notranslate"><span class="pre">BotConfig.MAINTENANCE_MODE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MAINTENANCE_MESSAGE"><code class="docutils literal notranslate"><span class="pre">BotConfig.MAINTENANCE_MESSAGE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MAINTENANCE_AUTO_WARMUP_SECS"><code class="docutils literal notranslate"><span class="pre">BotConfig.MAINTENANCE_AUTO_WARMUP_SECS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.RATE_LIMIT_PER_MINUTE"><code class="docutils literal notranslate"><span class="pre">BotConfig.RATE_LIMIT_PER_MINUTE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.HIGHLIGHT_THEME"><code class="docutils literal notranslate"><span class="pre">BotConfig.HIGHLIGHT_THEME</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.GIT_CHECKPOINT_PREFIX"><code class="docutils literal notranslate"><span class="pre">BotConfig.GIT_CHECKPOINT_PREFIX</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.GOOGLE_CLIENT_ID"><code class="docutils literal notranslate"><span class="pre">BotConfig.GOOGLE_CLIENT_ID</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.GOOGLE_CLIENT_SECRET"><code class="docutils literal notranslate"><span class="pre">BotConfig.GOOGLE_CLIENT_SECRET</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.GOOGLE_OAUTH_SCOPES"><code class="docutils literal notranslate"><span class="pre">BotConfig.GOOGLE_OAUTH_SCOPES</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.GOOGLE_TOKEN_REFRESH_MARGIN_SECS"><code class="docutils literal notranslate"><span class="pre">BotConfig.GOOGLE_TOKEN_REFRESH_MARGIN_SECS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.DRIVE_MENU_V2"><code class="docutils literal notranslate"><span class="pre">BotConfig.DRIVE_MENU_V2</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.DOCUMENTATION_URL"><code class="docutils literal notranslate"><span class="pre">BotConfig.DOCUMENTATION_URL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.BOT_LABEL"><code class="docutils literal notranslate"><span class="pre">BotConfig.BOT_LABEL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.DRIVE_ADD_HASH"><code class="docutils literal notranslate"><span class="pre">BotConfig.DRIVE_ADD_HASH</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.NORMALIZE_CODE_ON_SAVE"><code class="docutils literal notranslate"><span class="pre">BotConfig.NORMALIZE_CODE_ON_SAVE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.__init__"><code class="docutils literal notranslate"><span class="pre">BotConfig.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/config.html#config.load_config"><code class="docutils literal notranslate"><span class="pre">load_config()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/bot_handlers.html">bot_handlers module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/conversation_handlers.html">conversation_handlers module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/database.html">database package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/database.html#submodules">Submodules</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/database.manager.html">database.manager module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/database.models.html">database.models module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/database.repository.html">database.repository module</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/services.html">services package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/services.html#submodules">Submodules</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/services.backup_service.html">services.backup_service module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/services.code_service.html">services.code_service module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/services.github_service.html">services.github_service module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/services.google_drive_service.html">services.google_drive_service module</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/handlers.html">handlers package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/handlers.html#subpackages">Subpackages</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.github.html">handlers.github package</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/handlers.html#submodules">Submodules</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.file_view.html">handlers.file_view module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.pagination.html">handlers.pagination module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.save_flow.html">handlers.save_flow module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.states.html">handlers.states module</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/utils.html">utils module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.CodeErrorLogger"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CodeErrorLogger.__init__"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CodeErrorLogger.log_code_processing_error"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger.log_code_processing_error()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CodeErrorLogger.log_code_activity"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger.log_code_activity()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CodeErrorLogger.log_validation_failure"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger.log_validation_failure()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CodeErrorLogger.log_sanitization_success"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger.log_sanitization_success()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.TimeUtils"><code class="docutils literal notranslate"><span class="pre">TimeUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TimeUtils.format_relative_time"><code class="docutils literal notranslate"><span class="pre">TimeUtils.format_relative_time()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TimeUtils.parse_date_string"><code class="docutils literal notranslate"><span class="pre">TimeUtils.parse_date_string()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TimeUtils.get_time_ranges"><code class="docutils literal notranslate"><span class="pre">TimeUtils.get_time_ranges()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.TextUtils"><code class="docutils literal notranslate"><span class="pre">TextUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils.truncate_text"><code class="docutils literal notranslate"><span class="pre">TextUtils.truncate_text()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils.escape_markdown"><code class="docutils literal notranslate"><span class="pre">TextUtils.escape_markdown()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils.clean_filename"><code class="docutils literal notranslate"><span class="pre">TextUtils.clean_filename()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils.extract_hashtags"><code class="docutils literal notranslate"><span class="pre">TextUtils.extract_hashtags()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils.highlight_text"><code class="docutils literal notranslate"><span class="pre">TextUtils.highlight_text()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils.format_file_size"><code class="docutils literal notranslate"><span class="pre">TextUtils.format_file_size()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils.pluralize_hebrew"><code class="docutils literal notranslate"><span class="pre">TextUtils.pluralize_hebrew()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.SecurityUtils"><code class="docutils literal notranslate"><span class="pre">SecurityUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.SecurityUtils.generate_secure_token"><code class="docutils literal notranslate"><span class="pre">SecurityUtils.generate_secure_token()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.SecurityUtils.hash_content"><code class="docutils literal notranslate"><span class="pre">SecurityUtils.hash_content()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.SecurityUtils.validate_user_input"><code class="docutils literal notranslate"><span class="pre">SecurityUtils.validate_user_input()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.SecurityUtils.sanitize_code"><code class="docutils literal notranslate"><span class="pre">SecurityUtils.sanitize_code()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils"><code class="docutils literal notranslate"><span class="pre">TelegramUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.send_typing_action"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.send_typing_action()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.send_document_action"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.send_document_action()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.safe_answer"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.safe_answer()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.get_user_mention"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.get_user_mention()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.split_long_message"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.split_long_message()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.safe_edit_message_text"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.safe_edit_message_text()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.safe_edit_message_reply_markup"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.safe_edit_message_reply_markup()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.extract_message_text_preserve_markdown"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.extract_message_text_preserve_markdown()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.CallbackQueryGuard"><code class="docutils literal notranslate"><span class="pre">CallbackQueryGuard</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CallbackQueryGuard.DEFAULT_WINDOW_SECONDS"><code class="docutils literal notranslate"><span class="pre">CallbackQueryGuard.DEFAULT_WINDOW_SECONDS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CallbackQueryGuard.should_block"><code class="docutils literal notranslate"><span class="pre">CallbackQueryGuard.should_block()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CallbackQueryGuard.should_block_async"><code class="docutils literal notranslate"><span class="pre">CallbackQueryGuard.should_block_async()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.AsyncUtils"><code class="docutils literal notranslate"><span class="pre">AsyncUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.AsyncUtils.run_with_timeout"><code class="docutils literal notranslate"><span class="pre">AsyncUtils.run_with_timeout()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.AsyncUtils.batch_process"><code class="docutils literal notranslate"><span class="pre">AsyncUtils.batch_process()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.PerformanceUtils"><code class="docutils literal notranslate"><span class="pre">PerformanceUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.PerformanceUtils.timing_decorator"><code class="docutils literal notranslate"><span class="pre">PerformanceUtils.timing_decorator()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.PerformanceUtils.measure_time"><code class="docutils literal notranslate"><span class="pre">PerformanceUtils.measure_time()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.ValidationUtils"><code class="docutils literal notranslate"><span class="pre">ValidationUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.ValidationUtils.is_valid_filename"><code class="docutils literal notranslate"><span class="pre">ValidationUtils.is_valid_filename()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.ValidationUtils.is_safe_code"><code class="docutils literal notranslate"><span class="pre">ValidationUtils.is_safe_code()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.FileUtils"><code class="docutils literal notranslate"><span class="pre">FileUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.FileUtils.download_file"><code class="docutils literal notranslate"><span class="pre">FileUtils.download_file()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.FileUtils.get_file_extension"><code class="docutils literal notranslate"><span class="pre">FileUtils.get_file_extension()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.FileUtils.get_mime_type"><code class="docutils literal notranslate"><span class="pre">FileUtils.get_mime_type()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.FileUtils.create_temp_file"><code class="docutils literal notranslate"><span class="pre">FileUtils.create_temp_file()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.ConfigUtils"><code class="docutils literal notranslate"><span class="pre">ConfigUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.ConfigUtils.load_json_config"><code class="docutils literal notranslate"><span class="pre">ConfigUtils.load_json_config()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.ConfigUtils.save_json_config"><code class="docutils literal notranslate"><span class="pre">ConfigUtils.save_json_config()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.CacheUtils"><code class="docutils literal notranslate"><span class="pre">CacheUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CacheUtils.set"><code class="docutils literal notranslate"><span class="pre">CacheUtils.set()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CacheUtils.get"><code class="docutils literal notranslate"><span class="pre">CacheUtils.get()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CacheUtils.delete"><code class="docutils literal notranslate"><span class="pre">CacheUtils.delete()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CacheUtils.clear"><code class="docutils literal notranslate"><span class="pre">CacheUtils.clear()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.get_memory_usage"><code class="docutils literal notranslate"><span class="pre">get_memory_usage()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.setup_logging"><code class="docutils literal notranslate"><span class="pre">setup_logging()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.generate_summary_stats"><code class="docutils literal notranslate"><span class="pre">generate_summary_stats()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.detect_language_from_filename"><code class="docutils literal notranslate"><span class="pre">detect_language_from_filename()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.get_language_emoji"><code class="docutils literal notranslate"><span class="pre">get_language_emoji()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.SensitiveDataFilter"><code class="docutils literal notranslate"><span class="pre">SensitiveDataFilter</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.SensitiveDataFilter.filter"><code class="docutils literal notranslate"><span class="pre">SensitiveDataFilter.filter()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.install_sensitive_filter"><code class="docutils literal notranslate"><span class="pre">install_sensitive_filter()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.normalize_code"><code class="docutils literal notranslate"><span class="pre">normalize_code()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/modules.html">workspace</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/activity_reporter.html">activity_reporter module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/activity_reporter.html#activity_reporter.SimpleActivityReporter"><code class="docutils literal notranslate"><span class="pre">SimpleActivityReporter</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/activity_reporter.html#activity_reporter.create_reporter"><code class="docutils literal notranslate"><span class="pre">create_reporter()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/autocomplete_manager.html">autocomplete_manager module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/autocomplete_manager.html#autocomplete_manager.AutocompleteManager"><code class="docutils literal notranslate"><span class="pre">AutocompleteManager</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/backup_menu_handler.html">backup_menu_handler module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/backup_menu_handler.html#backup_menu_handler.BackupMenuHandler"><code class="docutils literal notranslate"><span class="pre">BackupMenuHandler</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/batch_commands.html">batch_commands module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_commands.html#batch_commands.batch_analyze_command"><code class="docutils literal notranslate"><span class="pre">batch_analyze_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_commands.html#batch_commands.batch_validate_command"><code class="docutils literal notranslate"><span class="pre">batch_validate_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_commands.html#batch_commands.job_status_command"><code class="docutils literal notranslate"><span class="pre">job_status_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_commands.html#batch_commands.large_file_command"><code class="docutils literal notranslate"><span class="pre">large_file_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_commands.html#batch_commands.handle_batch_callbacks"><code class="docutils literal notranslate"><span class="pre">handle_batch_callbacks()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_commands.html#batch_commands.setup_batch_handlers"><code class="docutils literal notranslate"><span class="pre">setup_batch_handlers()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/batch_processor.html">batch_processor module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_processor.html#batch_processor.BatchJob"><code class="docutils literal notranslate"><span class="pre">BatchJob</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_processor.html#batch_processor.BatchProcessor"><code class="docutils literal notranslate"><span class="pre">BatchProcessor</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/bot_handlers.html">bot_handlers module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/cache_commands.html">cache_commands module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_commands.html#cache_commands.cache_stats_command"><code class="docutils literal notranslate"><span class="pre">cache_stats_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_commands.html#cache_commands.clear_cache_command"><code class="docutils literal notranslate"><span class="pre">clear_cache_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_commands.html#cache_commands.setup_cache_handlers"><code class="docutils literal notranslate"><span class="pre">setup_cache_handlers()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/cache_manager.html">cache_manager module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_manager.html#cache_manager.CacheManager"><code class="docutils literal notranslate"><span class="pre">CacheManager</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_manager.html#cache_manager.cached"><code class="docutils literal notranslate"><span class="pre">cached()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_manager.html#cache_manager.async_cached"><code class="docutils literal notranslate"><span class="pre">async_cached()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/code_preview.html">code_preview module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/code_preview.html#code_preview.CodePreviewManager"><code class="docutils literal notranslate"><span class="pre">CodePreviewManager</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/code_processor.html">code_processor module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/config.html">config module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig"><code class="docutils literal notranslate"><span class="pre">BotConfig</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.load_config"><code class="docutils literal notranslate"><span class="pre">load_config()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/conftest.html">conftest module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html">conversation_handlers module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/database.html">database package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/database.html#submodules">Submodules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/file_manager.html">file_manager module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/file_manager.html#file_manager.BackupInfo"><code class="docutils literal notranslate"><span class="pre">BackupInfo</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/file_manager.html#file_manager.BackupManager"><code class="docutils literal notranslate"><span class="pre">BackupManager</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/fix_telegram_parse_error.html">fix_telegram_parse_error module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/fix_telegram_parse_error.html#fix_telegram_parse_error.clean_for_telegram"><code class="docutils literal notranslate"><span class="pre">clean_for_telegram()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/fix_telegram_parse_error.html#fix_telegram_parse_error.apply_fix"><code class="docutils literal notranslate"><span class="pre">apply_fix()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/fix_telegram_parse_error.html#fix_telegram_parse_error.wrap_edit_message_calls"><code class="docutils literal notranslate"><span class="pre">wrap_edit_message_calls()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/github_menu_handler.html">github_menu_handler module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/github_menu_handler.html#github_menu_handler.safe_html_escape"><code class="docutils literal notranslate"><span class="pre">safe_html_escape()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_menu_handler.html#github_menu_handler.format_bytes"><code class="docutils literal notranslate"><span class="pre">format_bytes()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_menu_handler.html#github_menu_handler.GitHubMenuHandler"><code class="docutils literal notranslate"><span class="pre">GitHubMenuHandler</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/github_upload_fix.html">github_upload_fix module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/github_upload_fix.html#github_upload_fix.github_upload_new_file"><code class="docutils literal notranslate"><span class="pre">github_upload_new_file()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_upload_fix.html#github_upload_fix.handle_document_fixed"><code class="docutils literal notranslate"><span class="pre">handle_document_fixed()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_upload_fix.html#github_upload_fix.upload_to_github_fixed"><code class="docutils literal notranslate"><span class="pre">upload_to_github_fixed()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_upload_fix.html#github_upload_fix.setup_minimal_commands"><code class="docutils literal notranslate"><span class="pre">setup_minimal_commands()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_upload_fix.html#github_upload_fix.stats_command_secured"><code class="docutils literal notranslate"><span class="pre">stats_command_secured()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_upload_fix.html#github_upload_fix.check_commands"><code class="docutils literal notranslate"><span class="pre">check_commands()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/handlers.html">handlers package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.html#subpackages">Subpackages</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.html#submodules">Submodules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/i18n.html">i18n package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/i18n.html#submodules">Submodules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/integrations.html">integrations module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/large_files_handler.html">large_files_handler module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/large_files_handler.html#large_files_handler.LargeFilesHandler"><code class="docutils literal notranslate"><span class="pre">LargeFilesHandler</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/lazy_loader.html">lazy_loader module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/lazy_loader.html#lazy_loader.FileChunk"><code class="docutils literal notranslate"><span class="pre">FileChunk</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/lazy_loader.html#lazy_loader.LazyLoader"><code class="docutils literal notranslate"><span class="pre">LazyLoader</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html">main module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.get_admin_ids"><code class="docutils literal notranslate"><span class="pre">get_admin_ids()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.notify_admins"><code class="docutils literal notranslate"><span class="pre">notify_admins()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.recycle_backfill_command"><code class="docutils literal notranslate"><span class="pre">recycle_backfill_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.log_user_activity"><code class="docutils literal notranslate"><span class="pre">log_user_activity()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.get_lock_collection"><code class="docutils literal notranslate"><span class="pre">get_lock_collection()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.ensure_lock_indexes"><code class="docutils literal notranslate"><span class="pre">ensure_lock_indexes()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.cleanup_mongo_lock"><code class="docutils literal notranslate"><span class="pre">cleanup_mongo_lock()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.manage_mongo_lock"><code class="docutils literal notranslate"><span class="pre">manage_mongo_lock()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.CodeKeeperBot"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.signal_handler"><code class="docutils literal notranslate"><span class="pre">signal_handler()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.setup_handlers"><code class="docutils literal notranslate"><span class="pre">setup_handlers()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.main"><code class="docutils literal notranslate"><span class="pre">main()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/main.html#main.setup_bot_data"><code class="docutils literal notranslate"><span class="pre">setup_bot_data()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/repo_analyzer.html">repo_analyzer module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/repo_analyzer.html#repo_analyzer.RepoAnalyzer"><code class="docutils literal notranslate"><span class="pre">RepoAnalyzer</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/search_engine.html">search_engine module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/secret_manager.html">secret_manager module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/secret_manager.html#secret_manager.encrypt_secret"><code class="docutils literal notranslate"><span class="pre">encrypt_secret()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/secret_manager.html#secret_manager.decrypt_secret"><code class="docutils literal notranslate"><span class="pre">decrypt_secret()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/services.html">services package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/services.html#submodules">Submodules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/terminal_commands.html">terminal_commands module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/terminal_commands.html#terminal_commands.run_in_sandbox"><code class="docutils literal notranslate"><span class="pre">run_in_sandbox()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/terminal_commands.html#terminal_commands.terminal_enter"><code class="docutils literal notranslate"><span class="pre">terminal_enter()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/terminal_commands.html#terminal_commands.terminal_exit"><code class="docutils literal notranslate"><span class="pre">terminal_exit()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/terminal_commands.html#terminal_commands.terminal_run_command"><code class="docutils literal notranslate"><span class="pre">terminal_run_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/terminal_commands.html#terminal_commands.terminal_command"><code class="docutils literal notranslate"><span class="pre">terminal_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/terminal_commands.html#terminal_commands.setup_terminal_handlers"><code class="docutils literal notranslate"><span class="pre">setup_terminal_handlers()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/test_basic.html">test_basic module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/test_basic.html#test_basic.test_python_version"><code class="docutils literal notranslate"><span class="pre">test_python_version()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/test_basic.html#test_basic.test_import_main"><code class="docutils literal notranslate"><span class="pre">test_import_main()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/test_basic.html#test_basic.test_environment"><code class="docutils literal notranslate"><span class="pre">test_environment()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/test_basic.html#test_basic.test_basic_calculation"><code class="docutils literal notranslate"><span class="pre">test_basic_calculation()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/test_basic.html#test_basic.TestRequirements"><code class="docutils literal notranslate"><span class="pre">TestRequirements</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/user_stats.html">user_stats module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/user_stats.html#user_stats.UserStats"><code class="docutils literal notranslate"><span class="pre">UserStats</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html">utils module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CodeErrorLogger"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TimeUtils"><code class="docutils literal notranslate"><span class="pre">TimeUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils"><code class="docutils literal notranslate"><span class="pre">TextUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.SecurityUtils"><code class="docutils literal notranslate"><span class="pre">SecurityUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils"><code class="docutils literal notranslate"><span class="pre">TelegramUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CallbackQueryGuard"><code class="docutils literal notranslate"><span class="pre">CallbackQueryGuard</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.AsyncUtils"><code class="docutils literal notranslate"><span class="pre">AsyncUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.PerformanceUtils"><code class="docutils literal notranslate"><span class="pre">PerformanceUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.ValidationUtils"><code class="docutils literal notranslate"><span class="pre">ValidationUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.FileUtils"><code class="docutils literal notranslate"><span class="pre">FileUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.ConfigUtils"><code class="docutils literal notranslate"><span class="pre">ConfigUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CacheUtils"><code class="docutils literal notranslate"><span class="pre">CacheUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.get_memory_usage"><code class="docutils literal notranslate"><span class="pre">get_memory_usage()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.setup_logging"><code class="docutils literal notranslate"><span class="pre">setup_logging()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.generate_summary_stats"><code class="docutils literal notranslate"><span class="pre">generate_summary_stats()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.detect_language_from_filename"><code class="docutils literal notranslate"><span class="pre">detect_language_from_filename()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.get_language_emoji"><code class="docutils literal notranslate"><span class="pre">get_language_emoji()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.SensitiveDataFilter"><code class="docutils literal notranslate"><span class="pre">SensitiveDataFilter</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.install_sensitive_filter"><code class="docutils literal notranslate"><span class="pre">install_sensitive_filter()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.normalize_code"><code class="docutils literal notranslate"><span class="pre">normalize_code()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../modules/index.html">מודולים ראשיים</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#file-management">File Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#github-integration">GitHub Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#backup-system">Backup System</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#code-processing">Code Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#search-engine">Search Engine</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#repository-analysis">Repository Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#batch-processing">Batch Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#large-files-handling">Large Files Handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#cache-management">Cache Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#user-statistics">User Statistics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#activity-reporting">Activity Reporting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#utilities">Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#lazy-loading">Lazy Loading</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#integrations">Integrations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#terminal-commands">Terminal Commands</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#autocomplete-manager">Autocomplete Manager</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../handlers/index.html">Handlers</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#drive-menu">Drive Menu</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../handlers/drive_menu.html">Drive Menu V2</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../handlers/drive_menu.html#id1">סקירה</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/drive_menu.html#id2">דגל פיצ’ר</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/drive_menu.html#id3">זרימות עיקריות</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/drive_menu.html#device-flow">התחברות (Device Flow)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/drive_menu.html#id4">טיפול שגיאות</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/drive_menu.html#id5">ניטור</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/drive_menu.html#module-handlers.drive.menu">API (autodoc)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#file-view-handler">File View Handler</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../handlers/index.html#file-view-handler-module">File View Handler Module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#pagination-handler">Pagination Handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#save-flow-handler">Save Flow Handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#states-handler">States Handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#github-handlers">GitHub Handlers</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../services/index.html">Services</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../services/index.html#code-service">Code Service</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../services/index.html#code-service-module">Code Service Module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../services/index.html#github-service">GitHub Service</a></li>
<li class="toctree-l2"><a class="reference internal" href="../services/index.html#backup-service">Backup Service</a></li>
<li class="toctree-l2"><a class="reference internal" href="../services/index.html#google-drive-service">Google Drive Service</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../services/google_drive_service.html">Google Drive Service</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../services/google_drive_service.html#id1">סקירה</a></li>
<li class="toctree-l4"><a class="reference internal" href="../services/google_drive_service.html#oauth">הערות OAuth</a></li>
<li class="toctree-l4"><a class="reference internal" href="../services/google_drive_service.html#id2">מבני קבצים</a></li>
<li class="toctree-l4"><a class="reference internal" href="../services/google_drive_service.html#api-autodoc">API (autodoc)</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../database/index.html">Database</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../database/index.html#database-manager">Database Manager</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/index.html#models">Models</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../database/index.html#codesnippet-model">CodeSnippet Model</a></li>
<li class="toctree-l3"><a class="reference internal" href="../database/index.html#databasemanager-class">DatabaseManager Class</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../database/index.html#database-operations">Database Operations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../database/index.html#save-operations">Save Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../database/index.html#search-operations">Search Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../database/index.html#delete-operations">Delete Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../database/index.html#statistics-operations">Statistics Operations</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../database/indexing.html">MongoDB Indexing Cookbook</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#id1">למה?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#id2">אינדקסים מומלצים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#python-pymongo">מתכונים (Python / PyMongo)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#explain-mongo-shell">בדיקות explain (Mongo Shell)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#explain">מה לחפש ב-explain?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#id3">בדיקת קיום אינדקסים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#id4">שיטות עבודה מומלצות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#id5">דוגמאות נוספות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#gotchas">Gotchas נפוצים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../database/cursor-pagination.html">Cursor-based Pagination (created_at / _id)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#id1">למה?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#id2">עקרונות מיון יציב</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#python">קידוד/פענוח קורסור (Python)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#id3">תבנית שאילתה (חדש → ישן)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#pymongo">PyMongo – דוגמה מלאה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#id4">דפדוף לאחור (ישן → חדש)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#copypaste">בדיקות ידניות (Copy‑Paste)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#id5">שיטות עבודה מומלצות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#gotchas">Gotchas נפוצים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#id6">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../database-schema.html">Database Schema</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../database-schema.html#collections">Collections</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../database-schema.html#code-snippets"><code class="docutils literal notranslate"><span class="pre">code_snippets</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../database-schema.html#users"><code class="docutils literal notranslate"><span class="pre">users</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../database-schema.html#bookmarks"><code class="docutils literal notranslate"><span class="pre">bookmarks</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../database-schema.html#sessions-webapp"><code class="docutils literal notranslate"><span class="pre">sessions</span></code> (WebApp)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../database-schema.html#indexes">Indexes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database-schema.html#relationships">Relationships</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database-schema.html#id1">קישורים</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">עזרה ודוגמאות:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../examples.html">דוגמאות שימוש</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#id2">שימוש בסיסי</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id3">יצירת אפליקציית בוט</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id4">שמירת קוד חדש</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id5">חיפוש קוד</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#handlers">שימוש ב-Handlers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#command-handler">יצירת Command Handler</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#conversation-handler">יצירת Conversation Handler</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#services">שימוש ב-Services</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id6">זיהוי שפת תכנות</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id7">ניתוח קוד</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#github">אינטגרציה עם GitHub</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#gist">העלאת קוד ל-Gist</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#gists">שליפת Gists של משתמש</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#id8">עבודה עם מסד הנתונים</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id9">ביצוע שאילתות מורכבות</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id10">עדכון קבצים</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id11">סטטיסטיקות</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#id12">טיפול בשגיאות</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id13">טיפול בשגיאות בסיסי</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#retry-logic">Retry Logic</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#id14">בדיקות</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id15">בדיקת יחידה</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id16">בדיקת אינטגרציה</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#id17">דוגמאות מתקדמות</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id18">עיבוד באצווה</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id19">קאשינג</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../testing.html">Testing Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#id1">עקרונות קריטיים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#tmp-path">דוגמת שימוש ב‑tmp_path</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#id2">מחיקה בטוחה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#mocking-telegram">Mocking ל‑Telegram</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#id3">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ci-cd.html">CI/CD Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../ci-cd.html#id1">חוקים קשיחים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ci-cd.html#id2">סטטוסים נדרשים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ci-cd.html#id3">בדיקות מומלצות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ci-cd.html#id4">בנייה של התיעוד</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ci-cd.html#id5">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../conversation-handlers.html">Conversation Handlers &amp; States</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#id1">סקירה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#states">רשימת States (מבחר בפועל)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#save-flow">Save Flow (תרשים מצבים)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#github-flow">GitHub Flow (תרשים מצבים)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#handler">דוגמת Handler תמציתית</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#id2">טבלת זרימות מלאה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#id3">קישורים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#id4">דוגמאות קוד תמציתיות (ממשיות)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#save">Save – שלבים עיקריים</a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#github">GitHub – תפריט ושיחת העלאה</a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#backup">Backup – תפריט</a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#drive">Drive – תפריט</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#id5">מוקשים נפוצים ופתרונות</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#query-answer"><code class="docutils literal notranslate"><span class="pre">query.answer()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#message-is-not-modified">עריכת הודעות בבטחה – ”Message is not modified“</a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#filters">Filters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#persistent-data-context-user-data">Persistent data (<code class="docutils literal notranslate"><span class="pre">context.user_data</span></code>)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#id6">דוגמאות טסטים קצרות</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#id7">Save – התחלה וזרימה בסיסית</a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#github-upload-conv-handler">GitHub – upload_conv_handler</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting.html">Troubleshooting Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#id1">שגיאות נפוצות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#id2">דיבוג מהיר</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#mongodb">בדיקת חיבור MongoDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#id3">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../development.html">Development Workflow</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../development.html#handler">הוספת Handler חדש</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development.html#endpoint-webapp">הוספת Endpoint ל‑WebApp</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development.html#schema">עדכון Schema במסד הנתונים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development.html#id1">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../integrations.html">Integrations</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../integrations.html#github-api">GitHub API</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../integrations.html#gist">יצירת Gist (דוגמה)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../integrations.html#google-drive-oauth-flow">Google Drive (OAuth Flow)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integrations.html#telegram-webhooks-vs-polling">Telegram Webhooks vs Polling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integrations.html#id1">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../security.html">Security Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../security.html#id1">סודות ופרטיות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security.html#id2">הצפנת טוקנים (דוגמה)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security.html#csrf-webapp">CSRF ב‑WebApp</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security.html#rate-limiting">Rate Limiting (דוגמה)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security.html#id3">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../user/share_code.html">שיתוף קוד (חשוב)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#id2">מה זה עושה?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#id3">איפה הכפתור מופיע?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#id4">איך זה עובד (זרימה)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#env">דרישות סביבתיות (ENV)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#id5">מגבלות והתנהגות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#id6">הודעות הצלחה/שגיאה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#troubleshooting">Troubleshooting קצר</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#id7">דוגמאות (טקסטואליות)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../user/github_browse.html">עיון בקוד GitHub (כולל חיפוש בשם קובץ)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../user/github_browse.html#id1">שורת כלים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/github_browse.html#id2">תוצאות חיפוש</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/github_browse.html#id3">ניווט ריפו</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../user/download_repo.html">הורדת ריפו</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../user/download_repo.html#id2">מה בדיוק מוריד</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/download_repo.html#id3">מגבלות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/download_repo.html#id4">הודעות נפוצות</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">WebApp:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../webapp/overview.html">המיני Web App (סקירה)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/overview.html#id1">מה נותן?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/overview.html#id2">כתובת והרשאות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/overview.html#env">הגדרות ENV</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/overview.html#id3">קישורים ותמונות מסך</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/caching.html">Caching &amp; HTTP Validators (ETag / Last-Modified / 304)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#id1">למה זה חשוב?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#id2">עקרונות בסיס</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#flask-werkzeug">מתכון: Flask + werkzeug</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#copypaste">בדיקות ידניות (Copy‑Paste)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#checklist">Checklist למימוש נכון</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#gotchas">Gotchas נפוצים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#cache-control">שילוב עם Cache-Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#id3">קישורים נוספים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/static-checklist.html">Static Performance &amp; Security Checklist (gzip/br, Cache, SRI)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/static-checklist.html#id1">מטרה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/static-checklist.html#br-gzip">דחיסה (br/gzip)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/static-checklist.html#cache-control">כותרות Cache-Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/static-checklist.html#subresource-integrity-sri">Subresource Integrity (SRI)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/static-checklist.html#copypaste">בדיקות ידניות (Copy‑Paste)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/static-checklist.html#best-practices">Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/static-checklist.html#gotchas">Gotchas</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/api-reference.html">WebApp API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/api-reference.html#endpoints">Endpoints</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/api-reference.html#authentication-flow">Authentication Flow</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/api-reference.html#response-schema-example">Response Schema Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/api-reference.html#errors">Errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/api-reference.html#id1">קישורים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/api-reference.html#files">מסנן ושדות קלט ל-<code class="docutils literal notranslate"><span class="pre">/files</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../webapp/api-reference.html#id2">טבלת פרמטרים</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/api-reference.html#id3">דוגמאות בקשה</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/api-reference.html#id4">דוגמאות תגובה</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Code Keeper Bot</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">main</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>הראה קוד מקור ל main</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">בוט שומר קבצי קוד - Code Keeper Bot</span>
<span class="sd">נקודת הכניסה הראשית לבוט</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="c1"># הגדרות מתקדמות</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>

<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pymongo</span>
    <span class="n">_HAS_PYMONGO</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="n">pymongo</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># fallback ללא type: ignore</span>
    <span class="n">_HAS_PYMONGO</span> <span class="o">=</span> <span class="kc">False</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timezone</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">import</span> <span class="nn">atexit</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pymongo.errors</span>
    <span class="kn">from</span> <span class="nn">pymongo.errors</span> <span class="kn">import</span> <span class="n">DuplicateKeyError</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="k">class</span> <span class="nc">_DummyErr</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">class</span> <span class="nc">_DummyErrors</span><span class="p">:</span>
        <span class="n">InvalidOperation</span> <span class="o">=</span> <span class="n">_DummyErr</span>
        <span class="n">OperationFailure</span> <span class="o">=</span> <span class="n">_DummyErr</span>
    <span class="n">DuplicateKeyError</span> <span class="o">=</span> <span class="n">_DummyErr</span>
    <span class="n">pymongo</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="s2">&quot;_PM&quot;</span><span class="p">,</span> <span class="p">(),</span> <span class="p">{</span><span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="n">_DummyErrors</span><span class="p">})()</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">telegram</span> <span class="kn">import</span> <span class="n">Update</span><span class="p">,</span> <span class="n">ReplyKeyboardMarkup</span><span class="p">,</span> <span class="n">InlineKeyboardButton</span><span class="p">,</span> <span class="n">InlineKeyboardMarkup</span><span class="p">,</span> <span class="n">BotCommand</span><span class="p">,</span> <span class="n">BotCommandScopeChat</span>
<span class="kn">from</span> <span class="nn">telegram.constants</span> <span class="kn">import</span> <span class="n">ParseMode</span>
<span class="kn">from</span> <span class="nn">telegram.ext</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Application</span><span class="p">,</span> <span class="n">CommandHandler</span><span class="p">,</span> <span class="n">ContextTypes</span><span class="p">,</span>
                          <span class="n">MessageHandler</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span> <span class="n">Defaults</span><span class="p">,</span> <span class="n">ConversationHandler</span><span class="p">,</span> <span class="n">CallbackQueryHandler</span><span class="p">,</span>
                          <span class="n">PicklePersistence</span><span class="p">,</span> <span class="n">InlineQueryHandler</span><span class="p">,</span> <span class="n">ApplicationHandlerStop</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">config</span> <span class="kn">import</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">rate_limiter</span> <span class="kn">import</span> <span class="n">RateLimiter</span>
<span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">CodeSnippet</span><span class="p">,</span> <span class="n">DatabaseManager</span><span class="p">,</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">services</span> <span class="kn">import</span> <span class="n">code_service</span> <span class="k">as</span> <span class="n">code_processor</span>
<span class="kn">from</span> <span class="nn">bot_handlers</span> <span class="kn">import</span> <span class="n">AdvancedBotHandlers</span>  <span class="c1"># still used by legacy code</span>
<span class="kn">from</span> <span class="nn">conversation_handlers</span> <span class="kn">import</span> <span class="n">MAIN_KEYBOARD</span><span class="p">,</span> <span class="n">get_save_conversation_handler</span>
<span class="kn">from</span> <span class="nn">activity_reporter</span> <span class="kn">import</span> <span class="n">create_reporter</span>
<span class="kn">from</span> <span class="nn">github_menu_handler</span> <span class="kn">import</span> <span class="n">GitHubMenuHandler</span>
<span class="kn">from</span> <span class="nn">backup_menu_handler</span> <span class="kn">import</span> <span class="n">BackupMenuHandler</span>
<span class="kn">from</span> <span class="nn">handlers.drive.menu</span> <span class="kn">import</span> <span class="n">GoogleDriveMenuHandler</span>
<span class="kn">from</span> <span class="nn">file_manager</span> <span class="kn">import</span> <span class="n">backup_manager</span>
<span class="kn">from</span> <span class="nn">large_files_handler</span> <span class="kn">import</span> <span class="n">large_files_handler</span>
<span class="kn">from</span> <span class="nn">user_stats</span> <span class="kn">import</span> <span class="n">user_stats</span>
<span class="kn">from</span> <span class="nn">cache_commands</span> <span class="kn">import</span> <span class="n">setup_cache_handlers</span>  <span class="c1"># enabled</span>
<span class="c1"># from enhanced_commands import setup_enhanced_handlers  # disabled</span>
<span class="kn">from</span> <span class="nn">batch_commands</span> <span class="kn">import</span> <span class="n">setup_batch_handlers</span>
<span class="kn">from</span> <span class="nn">html</span> <span class="kn">import</span> <span class="n">escape</span> <span class="k">as</span> <span class="n">html_escape</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">aiohttp</span> <span class="kn">import</span> <span class="n">web</span>  <span class="c1"># for internal web server</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="k">class</span> <span class="nc">_DummyWeb</span><span class="p">:</span>
        <span class="k">class</span> <span class="nc">Application</span><span class="p">:</span>
            <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span> <span class="k">pass</span>
        <span class="k">class</span> <span class="nc">AppRunner</span><span class="p">:</span>
            <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span> <span class="k">pass</span>
            <span class="k">async</span> <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">pass</span>
        <span class="k">class</span> <span class="nc">TCPSite</span><span class="p">:</span>
            <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span> <span class="k">pass</span>
            <span class="k">async</span> <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">pass</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">json_response</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
    <span class="n">web</span> <span class="o">=</span> <span class="n">_DummyWeb</span><span class="p">()</span>

<span class="c1"># (Lock mechanism constants removed)</span>

<span class="c1"># הגדרת לוגר מתקדם</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
    <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(name)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
    <span class="n">handlers</span><span class="o">=</span><span class="p">[</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="c1"># התקנת מסנן טשטוש נתונים רגישים</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">install_sensitive_filter</span>
    <span class="n">install_sensitive_filter</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_register_catch_all_callback</span><span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="n">callback_fn</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;רישום CallbackQueryHandler כללי בקבוצה מאוחרת, עם fallback כשה-API לא תומך ב-group.</span>

<span class="sd">    נועד להימנע מכשלי טסטים/סטאבים (TypeError על group), ובו בזמן לשמר קדימויות בפרודקשן.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">handler</span> <span class="o">=</span> <span class="n">CallbackQueryHandler</span><span class="p">(</span><span class="n">callback_fn</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="c1"># סביבת טסט/סטאב ללא תמיכה בפרמטר group</span>
        <span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># דווח חריגה כדי שלא נבלע שגיאות רישום שקטות</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to register catch-all CallbackQueryHandler: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># הודעת התחלה מרשימה</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;🚀 מפעיל בוט קוד מתקדם - גרסה פרו!&quot;</span><span class="p">)</span>

<span class="c1"># הפחתת רעש בלוגים</span>
<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;httpx&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>  <span class="c1"># רק שגיאות קריטיות</span>
<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;telegram.ext.Updater&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;telegram.ext.Application&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>

<span class="c1"># יצירת אובייקט reporter גלובלי</span>
<span class="n">reporter</span> <span class="o">=</span> <span class="n">create_reporter</span><span class="p">(</span>
    <span class="n">mongodb_uri</span><span class="o">=</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;REPORTER_MONGODB_URL&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;REPORTER_MONGODB_URI&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">config</span><span class="o">.</span><span class="n">MONGODB_URL</span><span class="p">),</span>
    <span class="n">service_id</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;REPORTER_SERVICE_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;srv-d29d72adbo4c73bcuep0&#39;</span><span class="p">),</span>
    <span class="n">service_name</span><span class="o">=</span><span class="s2">&quot;CodeBot&quot;</span>
<span class="p">)</span>

<span class="c1"># ===== עזר: שליחת הודעת אדמין =====</span>
<div class="viewcode-block" id="get_admin_ids">
<a class="viewcode-back" href="../api/main.html#main.get_admin_ids">[תיעוד]</a>
<span class="k">def</span> <span class="nf">get_admin_ids</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;ADMIN_USER_IDS&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">raw</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">raw</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()]</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="notify_admins">
<a class="viewcode-back" href="../api/main.html#main.notify_admins">[תיעוד]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">notify_admins</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">admin_ids</span> <span class="o">=</span> <span class="n">get_admin_ids</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">admin_ids</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">admin_id</span> <span class="ow">in</span> <span class="n">admin_ids</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">context</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">chat_id</span><span class="o">=</span><span class="n">admin_id</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span></div>


<span class="c1"># ===== Admin: /recycle_backfill =====</span>
<div class="viewcode-block" id="recycle_backfill_command">
<a class="viewcode-back" href="../api/main.html#main.recycle_backfill_command">[תיעוד]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">recycle_backfill_command</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ממלא deleted_at ו-deleted_expires_at לרשומות מחוקות רכות וחושב TTL.</span>

<span class="sd">    שימוש: /recycle_backfill [X]</span>
<span class="sd">    X = ימים לתוקף סל (ברירת מחדל מהקונפיג RECYCLE_TTL_DAYS)</span>
<span class="sd">    הפקודה זמינה למנהלים בלבד.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span> <span class="k">if</span> <span class="n">update</span> <span class="ow">and</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">admin_ids</span> <span class="o">=</span> <span class="n">get_admin_ids</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">admin_ids</span> <span class="ow">or</span> <span class="n">user_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">admin_ids</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;❌ פקודה זמינה למנהלים בלבד&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">return</span>

        <span class="c1"># קביעת TTL בימים</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ttl_days</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;RECYCLE_TTL_DAYS&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">7</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">ttl_days</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;RECYCLE_TTL_DAYS&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">7</span><span class="p">)</span>
        <span class="n">ttl_days</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ttl_days</span><span class="p">)</span>

        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
        <span class="n">expires</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">ttl_days</span><span class="p">)</span>

        <span class="c1"># ודא אינדקסי TTL ואח&quot;כ Backfill בשתי הקולקציות</span>
        <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span> <span class="k">as</span> <span class="n">_db</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">coll_name</span><span class="p">,</span> <span class="n">friendly</span> <span class="ow">in</span> <span class="p">((</span><span class="s2">&quot;collection&quot;</span><span class="p">,</span> <span class="s2">&quot;קבצים רגילים&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;large_files_collection&quot;</span><span class="p">,</span> <span class="s2">&quot;קבצים גדולים&quot;</span><span class="p">)):</span>
            <span class="n">coll</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">coll_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="c1"># חשוב: אל תשתמשו ב-truthiness על קולקציה של PyMongo</span>
            <span class="k">if</span> <span class="n">coll</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">friendly</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;collection-missing&quot;</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="c1"># ensure TTL index idempotently</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">coll</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span><span class="s2">&quot;deleted_expires_at&quot;</span><span class="p">,</span> <span class="n">expireAfterSeconds</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;deleted_ttl&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># לא קריטי; נמשיך</span>
                <span class="k">pass</span>

            <span class="n">modified_deleted_at</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">modified_deleted_exp</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># backfill deleted_at where missing</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">coll</span><span class="p">,</span> <span class="s1">&#39;update_many&#39;</span><span class="p">):</span>
                    <span class="n">r1</span> <span class="o">=</span> <span class="n">coll</span><span class="o">.</span><span class="n">update_many</span><span class="p">({</span><span class="s2">&quot;is_active&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;deleted_at&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$exists&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}},</span> <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;deleted_at&quot;</span><span class="p">:</span> <span class="n">now</span><span class="p">}})</span>
                    <span class="n">modified_deleted_at</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="s1">&#39;modified_count&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="c1"># backfill deleted_expires_at where missing</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">coll</span><span class="p">,</span> <span class="s1">&#39;update_many&#39;</span><span class="p">):</span>
                    <span class="n">r2</span> <span class="o">=</span> <span class="n">coll</span><span class="o">.</span><span class="n">update_many</span><span class="p">({</span><span class="s2">&quot;is_active&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;deleted_expires_at&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$exists&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}},</span> <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;deleted_expires_at&quot;</span><span class="p">:</span> <span class="n">expires</span><span class="p">}})</span>
                    <span class="n">modified_deleted_exp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="s1">&#39;modified_count&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">friendly</span><span class="p">,</span> <span class="n">modified_deleted_at</span><span class="p">,</span> <span class="n">modified_deleted_exp</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>

        <span class="c1"># דו&quot;ח</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;🧹 Backfill סל מיחזור (TTL=</span><span class="si">{</span><span class="n">ttl_days</span><span class="si">}</span><span class="s2"> ימים)&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">friendly</span><span class="p">,</span> <span class="n">c_at</span><span class="p">,</span> <span class="n">c_exp</span><span class="p">,</span> <span class="n">err</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;• </span><span class="si">{</span><span class="n">friendly</span><span class="si">}</span><span class="s2">: דילוג (</span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;• </span><span class="si">{</span><span class="n">friendly</span><span class="si">}</span><span class="s2">: deleted_at=</span><span class="si">{</span><span class="n">c_at</span><span class="si">}</span><span class="s2">, deleted_expires_at=</span><span class="si">{</span><span class="n">c_exp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה ב-backfill: </span><span class="si">{</span><span class="n">html_escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span></div>


<div class="viewcode-block" id="log_user_activity">
<a class="viewcode-back" href="../api/main.html#main.log_user_activity">[תיעוד]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">log_user_activity</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    רישום פעילות משתמש במערכת.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        update: אובייקט Update מטלגרם</span>
<span class="sd">        context: הקונטקסט של השיחה</span>
<span class="sd">    </span>
<span class="sd">    Note:</span>
<span class="sd">        פונקציה זו נקראת אוטומטית עבור כל פעולה של משתמש</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># דגימה להפחתת עומס: רק ~25% מהאירועים יעדכנו מיידית את ה-DB</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">random</span> <span class="k">as</span> <span class="nn">_rnd</span>
        <span class="n">sampled</span> <span class="o">=</span> <span class="p">(</span><span class="n">_rnd</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.25</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">sampled</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># רישום בסיסי לגמרי מחוץ ל-try כדי לא לחסום את הפלואו</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># כדי לשמר ספי milestones, אם דוגמים — נכפיל את המשקל בהתאם להסתברות הדגימה</span>
        <span class="k">if</span> <span class="n">sampled</span><span class="p">:</span>
            <span class="c1"># p=0.25 -&gt; weight=4; אם משתנה — נשאב מהקונפיג בעתיד</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user_stats</span><span class="o">.</span><span class="n">log_user</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">weight</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="c1"># תאימות לאחור לטסטים/סביבה ישנה ללא פרמטר weight</span>
                <span class="n">user_stats</span><span class="o">.</span><span class="n">log_user</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="c1"># milestones — להרצה אסינכרונית כך שלא תחסום את ההודעה למשתמש</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">_milestones_job</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># טעינה דינמית של מודול ה-DB כדי לעבוד היטב עם monkeypatch בטסטים</span>
            <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span> <span class="k">as</span> <span class="n">_db</span>
            <span class="n">users_collection</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">users</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="s1">&#39;db&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">users_collection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="n">users_collection</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;total_actions&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;milestones_sent&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="n">total_actions</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;total_actions&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">already_sent</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;milestones_sent&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[])</span>
            <span class="n">milestones</span> <span class="o">=</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">1000</span><span class="p">]</span>
            <span class="n">pending</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">milestones</span> <span class="k">if</span> <span class="n">m</span> <span class="o">&lt;=</span> <span class="n">total_actions</span> <span class="ow">and</span> <span class="n">m</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">already_sent</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pending</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">milestone</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">pending</span><span class="p">)</span>
            <span class="c1"># התראת אדמין מוקדמת (לצורך ניטור), בנוסף להתראה אחרי עדכון DB</span>
            <span class="k">if</span> <span class="n">milestone</span> <span class="o">&gt;=</span> <span class="mi">500</span><span class="p">:</span>
                <span class="n">uname</span> <span class="o">=</span> <span class="p">(</span><span class="n">username</span> <span class="ow">or</span> <span class="sa">f</span><span class="s2">&quot;User_</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">display</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;@</span><span class="si">{</span><span class="n">uname</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">uname</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">str</span><span class="p">(</span><span class="n">uname</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">uname</span><span class="p">)</span>
                <span class="c1"># קריאה ישירה ללא עטיפת try כדי שלא נבלע בשוגג; ה-wrapper החיצוני יתפוס חריגות</span>
                <span class="k">await</span> <span class="n">notify_admins</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;📢 משתמש </span><span class="si">{</span><span class="n">display</span><span class="si">}</span><span class="s2"> הגיע ל־</span><span class="si">{</span><span class="n">milestone</span><span class="si">}</span><span class="s2"> פעולות בבוט&quot;</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">users_collection</span><span class="o">.</span><span class="n">update_one</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span> <span class="s2">&quot;milestones_sent&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$ne&quot;</span><span class="p">:</span> <span class="n">milestone</span><span class="p">}},</span>
                <span class="p">{</span><span class="s2">&quot;$addToSet&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;milestones_sent&quot;</span><span class="p">:</span> <span class="n">milestone</span><span class="p">},</span> <span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;updated_at&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)}}</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="s1">&#39;modified_count&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">messages</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="mi">50</span><span class="p">:</span> <span class="p">(</span>
                        <span class="s2">&quot;וואו! אתה בין המשתמשים המובילים בבוט 🔥</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="s2">&quot;הנוכחות שלך עושה לנו שמח 😊</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="s2">&quot;יש לך רעיונות או דברים שהיית רוצה לראות כאן?</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="s2">&quot;מוזמן לכתוב ל־@moominAmir&quot;</span>
                    <span class="p">),</span>
                    <span class="mi">100</span><span class="p">:</span> <span class="p">(</span>
                        <span class="s2">&quot;💯 פעולות!</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="s2">&quot;כנראה שאתה כבר יודע את הבוט יותר טוב ממני 😂</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="s2">&quot;יאללה, אולי נעשה לך תעודת משתמש ותיק? 🏆&quot;</span>
                    <span class="p">),</span>
                    <span class="mi">200</span><span class="p">:</span> <span class="p">(</span>
                        <span class="s2">&quot;וואו! 200 פעולות! 🚀</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="s2">&quot;אתה לגמרי בין המשתמשים הכי פעילים.</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="s2">&quot;יש פיצ&#39;ר שהיית רוצה לראות בהמשך?</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="s2">&quot;ספר לנו ב־@moominAmir&quot;</span>
                    <span class="p">),</span>
                    <span class="mi">500</span><span class="p">:</span> <span class="p">(</span>
                        <span class="s2">&quot;500 פעולות! 🔥</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="s2">&quot;מגיע לך תודה ענקית על התמיכה! 🩵&quot;</span>
                    <span class="p">),</span>
                    <span class="mi">1000</span><span class="p">:</span> <span class="p">(</span>
                        <span class="s2">&quot;הגעת ל־1000 פעולות! 🎉</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="s2">&quot;אתה אגדה חיה של הבוט הזה 🙌</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="s2">&quot;תודה שאתה איתנו לאורך הדרך 💙</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="s2">&quot;הצעות לשיפור יתקבלו בברכה ❣️</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="s2">&quot;@moominAmir&quot;</span>
                    <span class="p">),</span>
                <span class="p">}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">context</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">chat_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">messages</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">milestone</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="c1"># התראה לאדמין למילסטונים משמעותיים (500+) — גם אם כבר סומן, לא מסוכן לשלוח פעם נוספת</span>
            <span class="k">if</span> <span class="n">milestone</span> <span class="o">&gt;=</span> <span class="mi">500</span><span class="p">:</span>
                <span class="n">uname</span> <span class="o">=</span> <span class="p">(</span><span class="n">username</span> <span class="ow">or</span> <span class="sa">f</span><span class="s2">&quot;User_</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">display</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;@</span><span class="si">{</span><span class="n">uname</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">uname</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">str</span><span class="p">(</span><span class="n">uname</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">uname</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">notify_admins</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;📢 משתמש </span><span class="si">{</span><span class="n">display</span><span class="si">}</span><span class="s2"> הגיע ל־</span><span class="si">{</span><span class="n">milestone</span><span class="si">}</span><span class="s2"> פעולות בבוט&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">jq</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;job_queue&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">application</span><span class="p">,</span> <span class="s2">&quot;job_queue&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">jq</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># הרצה מיידית ברקע ללא חסימה</span>
            <span class="n">jq</span><span class="o">.</span><span class="n">run_once</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_ctx</span><span class="p">:</span> <span class="n">context</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">_milestones_job</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">username</span><span class="p">)),</span> <span class="n">when</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># fallback: יצירת משימה אסינכרונית ישירות</span>
            <span class="kn">import</span> <span class="nn">asyncio</span> <span class="k">as</span> <span class="nn">_aio</span>
            <span class="n">_aio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">_milestones_job</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">username</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># MONGODB LOCK MANAGEMENT (FINAL, NO-GUESSING VERSION)</span>
<span class="c1"># =============================================================================</span>

<span class="n">LOCK_ID</span> <span class="o">=</span> <span class="s2">&quot;code_keeper_bot_lock&quot;</span>
<span class="n">LOCK_COLLECTION</span> <span class="o">=</span> <span class="s2">&quot;locks&quot;</span>
<span class="n">LOCK_TIMEOUT_MINUTES</span> <span class="o">=</span> <span class="mi">5</span>

<div class="viewcode-block" id="get_lock_collection">
<a class="viewcode-back" href="../api/main.html#main.get_lock_collection">[תיעוד]</a>
<span class="k">def</span> <span class="nf">get_lock_collection</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    מחזיר את קולקציית הנעילות ממסד הנתונים.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        pymongo.collection.Collection: קולקציית הנעילות</span>
<span class="sd">    </span>
<span class="sd">    Raises:</span>
<span class="sd">        SystemExit: אם מסד הנתונים לא אותחל כראוי</span>
<span class="sd">    </span>
<span class="sd">    Note:</span>
<span class="sd">        משתמש במסד הנתונים שכבר נבחר ב-DatabaseManager</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Use the already-selected database from DatabaseManager</span>
        <span class="n">selected_db</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">db</span>
        <span class="k">if</span> <span class="n">selected_db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;DatabaseManager.db is not initialized!&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Optional: small debug to help diagnose DB mismatches</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using DB for locks: </span><span class="si">{</span><span class="n">selected_db</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">selected_db</span><span class="p">[</span><span class="n">LOCK_COLLECTION</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to get lock collection from DatabaseManager: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>


<span class="c1"># New: ensure TTL index on expires_at so stale locks get auto-removed</span>

<div class="viewcode-block" id="ensure_lock_indexes">
<a class="viewcode-back" href="../api/main.html#main.ensure_lock_indexes">[תיעוד]</a>
<span class="k">def</span> <span class="nf">ensure_lock_indexes</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    יוצר אינדקס TTL על שדה expires_at לניקוי אוטומטי של נעילות ישנות.</span>
<span class="sd">    </span>
<span class="sd">    Note:</span>
<span class="sd">        אם יצירת האינדקס נכשלת, המערכת תמשיך לעבוד ללא TTL אוטומטי</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">lock_collection</span> <span class="o">=</span> <span class="n">get_lock_collection</span><span class="p">()</span>
        <span class="c1"># TTL based on the absolute expiration time in the document</span>
        <span class="n">lock_collection</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span><span class="s2">&quot;expires_at&quot;</span><span class="p">,</span> <span class="n">expireAfterSeconds</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;lock_expires_ttl&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Non-fatal; continue without TTL if index creation fails</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not ensure TTL index for lock collection: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="cleanup_mongo_lock">
<a class="viewcode-back" href="../api/main.html#main.cleanup_mongo_lock">[תיעוד]</a>
<span class="k">def</span> <span class="nf">cleanup_mongo_lock</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    מנקה את נעילת MongoDB בעת יציאה מהתוכנית.</span>
<span class="sd">    </span>
<span class="sd">    Note:</span>
<span class="sd">        פונקציה זו נרשמת עם atexit ורצה אוטומטית בסיום התוכנית</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># If DB client is not available, skip quietly</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;db&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s2">&quot;client&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Mongo client not available during lock cleanup; skipping.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">lock_collection</span> <span class="o">=</span> <span class="n">get_lock_collection</span><span class="p">()</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">lock_collection</span><span class="o">.</span><span class="n">delete_one</span><span class="p">({</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">LOCK_ID</span><span class="p">,</span> <span class="s2">&quot;pid&quot;</span><span class="p">:</span> <span class="n">pid</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">deleted_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Lock &#39;</span><span class="si">{</span><span class="n">LOCK_ID</span><span class="si">}</span><span class="s2">&#39; released successfully by PID: </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">pymongo</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidOperation</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Mongo client already closed; skipping lock cleanup.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error while releasing MongoDB lock: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="manage_mongo_lock">
<a class="viewcode-back" href="../api/main.html#main.manage_mongo_lock">[תיעוד]</a>
<span class="k">def</span> <span class="nf">manage_mongo_lock</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    רוכש נעילה מבוזרת ב-MongoDB כדי להבטיח שרק מופע אחד של הבוט רץ.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        bool: True אם הנעילה נרכשה בהצלחה, False אחרת</span>
<span class="sd">    </span>
<span class="sd">    Note:</span>
<span class="sd">        תומך בהמתנה לשחרור נעילה קיימת עבור blue/green deployments</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ensure_lock_indexes</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;could not ensure lock indexes; continuing&quot;</span><span class="p">)</span>
        <span class="n">lock_collection</span> <span class="o">=</span> <span class="n">get_lock_collection</span><span class="p">()</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
        <span class="n">expires_at</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">LOCK_TIMEOUT_MINUTES</span><span class="p">)</span>

        <span class="c1"># Try to create the lock document</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lock_collection</span><span class="o">.</span><span class="n">insert_one</span><span class="p">({</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">LOCK_ID</span><span class="p">,</span> <span class="s2">&quot;pid&quot;</span><span class="p">:</span> <span class="n">pid</span><span class="p">,</span> <span class="s2">&quot;expires_at&quot;</span><span class="p">:</span> <span class="n">expires_at</span><span class="p">})</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ MongoDB lock acquired by PID </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">DuplicateKeyError</span><span class="p">:</span>
            <span class="c1"># A lock already exists</span>
            <span class="c1"># First, attempt immediate takeover if the lock is expired</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
                <span class="n">expires_at</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">LOCK_TIMEOUT_MINUTES</span><span class="p">)</span>

                <span class="n">doc</span> <span class="o">=</span> <span class="n">lock_collection</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">LOCK_ID</span><span class="p">})</span>
                <span class="k">if</span> <span class="n">doc</span> <span class="ow">and</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;expires_at&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;expires_at&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">now</span><span class="p">:</span>
                    <span class="c1"># Attempt to take over an expired lock</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">lock_collection</span><span class="o">.</span><span class="n">find_one_and_update</span><span class="p">(</span>
                        <span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">LOCK_ID</span><span class="p">,</span> <span class="s2">&quot;expires_at&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$lt&quot;</span><span class="p">:</span> <span class="n">now</span><span class="p">}},</span>
                        <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;pid&quot;</span><span class="p">:</span> <span class="n">pid</span><span class="p">,</span> <span class="s2">&quot;expires_at&quot;</span><span class="p">:</span> <span class="n">expires_at</span><span class="p">}},</span>
                        <span class="n">return_document</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ MongoDB lock re-acquired by PID </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2"> (expired lock)&quot;</span><span class="p">)</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Not expired: wait and retry instead of exiting to support blue/green deploys</span>
                    <span class="n">max_wait_seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LOCK_MAX_WAIT_SECONDS&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">))</span>  <span class="c1"># 0 = wait indefinitely</span>
                    <span class="n">retry_interval_seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LOCK_RETRY_INTERVAL_SECONDS&quot;</span><span class="p">,</span> <span class="s2">&quot;5&quot;</span><span class="p">))</span>

                    <span class="k">if</span> <span class="n">max_wait_seconds</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">deadline</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">max_wait_seconds</span>
                        <span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">deadline</span><span class="p">:</span>
                            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">retry_interval_seconds</span><span class="p">)</span>
                            <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
                            <span class="n">doc</span> <span class="o">=</span> <span class="n">lock_collection</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">LOCK_ID</span><span class="p">})</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">doc</span> <span class="ow">or</span> <span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;expires_at&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;expires_at&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">now</span><span class="p">):</span>
                                <span class="k">break</span>
                        <span class="c1"># loop will re-check and attempt takeover at the top</span>
                        <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">deadline</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Timeout waiting for existing lock to release. Exiting gracefully.&quot;</span><span class="p">)</span>
                            <span class="k">return</span> <span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Infinite wait with periodic log</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Another bot instance is already running (lock present). Waiting for lock release…&quot;</span><span class="p">)</span>
                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">retry_interval_seconds</span><span class="p">)</span>
                        <span class="k">continue</span>
                <span class="c1"># If we reach here without breaking, loop will retry</span>
            
        <span class="c1"># Ensure lock is released on exit</span>
        <span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">cleanup_mongo_lock</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to acquire MongoDB lock: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Fail-open to not crash the app, but log loudly</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="CodeKeeperBot">
<a class="viewcode-back" href="../api/main.html#main.CodeKeeperBot">[תיעוד]</a>
<span class="k">class</span> <span class="nc">CodeKeeperBot</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    המחלקה הראשית של Code Keeper Bot.</span>
<span class="sd">    </span>
<span class="sd">    מחלקה זו מנהלת את כל הפונקציונליות של הבוט, כולל:</span>
<span class="sd">    - הגדרת handlers לפקודות ומסרים</span>
<span class="sd">    - ניהול שיחות מורכבות</span>
<span class="sd">    - אינטגרציות עם שירותים חיצוניים</span>
<span class="sd">    - ניהול מסד נתונים</span>
<span class="sd">    </span>
<span class="sd">    Attributes:</span>
<span class="sd">        application: אובייקט Application של python-telegram-bot</span>
<span class="sd">        github_handler: מנהל אינטגרציית GitHub</span>
<span class="sd">        backup_handler: מנהל מערכת הגיבויים</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="CodeKeeperBot.__init__">
<a class="viewcode-back" href="../api/main.html#main.CodeKeeperBot.__init__">[תיעוד]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># יצירת תיקייה זמנית עם הרשאות כתיבה</span>
        <span class="n">DATA_DIR</span> <span class="o">=</span> <span class="s2">&quot;/tmp&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
        <span class="c1"># יצירת persistence לשמירת נתונים בין הפעלות</span>
        <span class="n">persistence</span> <span class="o">=</span> <span class="n">PicklePersistence</span><span class="p">(</span><span class="n">filepath</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">DATA_DIR</span><span class="si">}</span><span class="s2">/bot_data.pickle&quot;</span><span class="p">)</span>
        
        <span class="c1"># במצב בדיקות/CI, חלק מתלויות הטלגרם (Updater פנימי) עלולות להיכשל.</span>
        <span class="c1"># נשתמש בבנאי הרגיל, ואם נכשל – נבנה Application מינימלי עם טוקן דמה.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">application</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">Application</span><span class="o">.</span><span class="n">builder</span><span class="p">()</span>
                <span class="o">.</span><span class="n">token</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">BOT_TOKEN</span><span class="p">)</span>
                <span class="o">.</span><span class="n">defaults</span><span class="p">(</span><span class="n">Defaults</span><span class="p">(</span><span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">))</span>
                <span class="o">.</span><span class="n">persistence</span><span class="p">(</span><span class="n">persistence</span><span class="p">)</span>
                <span class="o">.</span><span class="n">post_init</span><span class="p">(</span><span class="n">setup_bot_data</span><span class="p">)</span>
                <span class="o">.</span><span class="n">build</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">dummy_token</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DUMMY_BOT_TOKEN&quot;</span><span class="p">,</span> <span class="s2">&quot;dummy_token&quot;</span><span class="p">)</span>
            <span class="c1"># נסה לבנות ללא persistence/post_init כדי לעקוף Updater פנימי</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">application</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">Application</span><span class="o">.</span><span class="n">builder</span><span class="p">()</span>
                    <span class="o">.</span><span class="n">token</span><span class="p">(</span><span class="n">dummy_token</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">defaults</span><span class="p">(</span><span class="n">Defaults</span><span class="p">(</span><span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">))</span>
                    <span class="o">.</span><span class="n">build</span><span class="p">()</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># בנאי ידני מינימלי: אובייקט עם הממשקים הדרושים לטסטים/סביבות חסרות</span>
                <span class="k">class</span> <span class="nc">_MiniApp</span><span class="p">:</span>
                    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">bot_data</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_error_handlers</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">class</span> <span class="nc">_JobQ</span><span class="p">:</span>
                            <span class="k">def</span> <span class="nf">run_once</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
                                <span class="k">return</span> <span class="kc">None</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">job_queue</span> <span class="o">=</span> <span class="n">_JobQ</span><span class="p">()</span>
                    <span class="k">def</span> <span class="nf">add_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
                    <span class="k">def</span> <span class="nf">remove_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
                        <span class="k">return</span> <span class="kc">None</span>
                    <span class="k">def</span> <span class="nf">add_error_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_error_handlers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
                    <span class="k">async</span> <span class="k">def</span> <span class="nf">run_polling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
                        <span class="c1"># Fallback שקט: אין polling אמיתי; מאפשר start ללא קריסה</span>
                        <span class="k">return</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">application</span> <span class="o">=</span> <span class="n">_MiniApp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_handlers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">advanced_handlers</span> <span class="o">=</span> <span class="n">AdvancedBotHandlers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="p">)</span>
        <span class="c1"># רישום קטגוריית &quot;⭐ מועדפים&quot; לתפריט &quot;📚 הקבצים&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">conversation_handlers</span> <span class="kn">import</span> <span class="n">setup_favorites_category_handlers</span> <span class="k">as</span> <span class="n">_setup_fav</span>
            <span class="n">_setup_fav</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="c1"># Rate limiter instance (לאחר בניית האפליקציה)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rate_limiter</span> <span class="o">=</span> <span class="n">RateLimiter</span><span class="p">(</span><span class="n">max_per_minute</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;RATE_LIMIT_PER_MINUTE&#39;</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">30</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rate_limiter</span> <span class="o">=</span> <span class="n">RateLimiter</span><span class="p">(</span><span class="n">max_per_minute</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="CodeKeeperBot.setup_handlers">
<a class="viewcode-back" href="../api/main.html#main.CodeKeeperBot.setup_handlers">[תיעוד]</a>
    <span class="k">def</span> <span class="nf">setup_handlers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;הגדרת כל ה-handlers של הבוט בסדר הנכון&quot;&quot;&quot;</span>

        <span class="c1"># Maintenance gate: if enabled, short-circuit most interactions</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">MAINTENANCE_MODE</span><span class="p">:</span>
            <span class="c1"># הגדרת חלון זמן פנימי שבו הודעת תחזוקה פעילה, כך שגם אם מחיקת ה-handlers לא תתבצע</span>
            <span class="c1"># ההודעה תיכבה אוטומטית לאחר ה-warmup.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_maintenance_active_until_ts</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;MAINTENANCE_AUTO_WARMUP_SECS&#39;</span><span class="p">,</span> <span class="mi">30</span><span class="p">)))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_maintenance_active_until_ts</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="mi">30</span>

            <span class="k">async</span> <span class="k">def</span> <span class="nf">maintenance_reply</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
                <span class="c1"># אם חלון ה-warmup הסתיים, אל תשלח הודעת תחזוקה</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">raw_active_until</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_maintenance_active_until_ts&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">raw_active_until</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="c1"># פרשנות:</span>
                <span class="c1"># None =&gt; תחזוקה פעילה (אין TTL)</span>
                <span class="c1"># 0 או ערך שלילי =&gt; תחזוקה מנוטרלת</span>
                <span class="c1"># &gt; 0 =&gt; תחזוקה פעילה עד timestamp זה</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">active_until</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">raw_active_until</span><span class="p">)</span> <span class="k">if</span> <span class="n">raw_active_until</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">active_until</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">is_active</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">active_until</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="n">active_until</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">now</span> <span class="o">&lt;</span> <span class="n">active_until</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_active</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">callback_query</span><span class="o">.</span><span class="n">edit_message_text</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s1">&#39;callback_query&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">)(</span>
                        <span class="n">config</span><span class="o">.</span><span class="n">MAINTENANCE_MESSAGE</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
            <span class="c1"># Catch-all high-priority handlers during maintenance (keep references for clean removal)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_maintenance_message_handler</span> <span class="o">=</span> <span class="n">MessageHandler</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span> <span class="n">maintenance_reply</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_maintenance_callback_handler</span> <span class="o">=</span> <span class="n">CallbackQueryHandler</span><span class="p">(</span><span class="n">maintenance_reply</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_maintenance_message_handler</span><span class="p">,</span> <span class="n">group</span><span class="o">=-</span><span class="mi">100</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_maintenance_callback_handler</span><span class="p">,</span> <span class="n">group</span><span class="o">=-</span><span class="mi">100</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;MAINTENANCE_MODE is ON — all updates will receive maintenance message&quot;</span><span class="p">)</span>
            <span class="c1"># אל תחסום לגמרי: לאחר warmup אוטומטי, הסר תחזוקה (ללא Redeploy)</span>
            <span class="c1"># Schedule removing maintenance handlers via JobQueue instead of create_task</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">warmup_secs</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">MAINTENANCE_AUTO_WARMUP_SECS</span><span class="p">))</span>
                <span class="k">async</span> <span class="k">def</span> <span class="nf">_clear_handlers_cb</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">app</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span>
                        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_maintenance_message_handler&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">app</span><span class="o">.</span><span class="n">remove_handler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_maintenance_message_handler</span><span class="p">,</span> <span class="n">group</span><span class="o">=-</span><span class="mi">100</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_maintenance_callback_handler&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">app</span><span class="o">.</span><span class="n">remove_handler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_maintenance_callback_handler</span><span class="p">,</span> <span class="n">group</span><span class="o">=-</span><span class="mi">100</span><span class="p">)</span>
                        <span class="c1"># נטרל מיידית את החלון הפעיל כדי למנוע שליחת הודעות תחזוקה מיותרות</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_maintenance_active_until_ts</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;MAINTENANCE_MODE auto-warmup window elapsed; resuming normal operation&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">job_queue</span><span class="o">.</span><span class="n">run_once</span><span class="p">(</span><span class="n">_clear_handlers_cb</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="n">warmup_secs</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;maintenance_clear_handlers&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="c1"># ממשיכים לרשום את שאר ה-handlers כדי שיקלטו אוטומטית אחרי ה-warmup</span>

        <span class="c1"># ספור את ה-handlers</span>
        <span class="n">handler_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">handlers</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🔍 כמות handlers לפני: </span><span class="si">{</span><span class="n">handler_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># --- Rate limiting gate (גבוה עדיפות, לפני שאר ה-handlers) ---</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">_rate_limit_gate</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user</span> <span class="o">=</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s1">&#39;effective_user&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s1">&#39;callback_query&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="s1">&#39;from_user&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">user_id</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">allowed</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rate_limiter</span><span class="o">.</span><span class="n">check_rate_limit</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">allowed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed</span><span class="p">:</span>
                    <span class="c1"># חסימה שקטה+הודעה קצרה</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">cq</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s1">&#39;callback_query&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">cq</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">await</span> <span class="n">cq</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;יותר מדי בקשות, נסה שוב עוד רגע&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cache_time</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">msg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="k">await</span> <span class="n">msg</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;⚠️ יותר מדי בקשות, נסה שוב בעוד מספר שניות&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">raise</span> <span class="n">ApplicationHandlerStop</span>

        <span class="c1"># הוסף כשכבת סינון מוקדמת עבור הודעות ולחיצות</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">MessageHandler</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span> <span class="n">_rate_limit_gate</span><span class="p">),</span> <span class="n">group</span><span class="o">=-</span><span class="mi">90</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CallbackQueryHandler</span><span class="p">(</span><span class="n">_rate_limit_gate</span><span class="p">),</span> <span class="n">group</span><span class="o">=-</span><span class="mi">90</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># Add conversation handler</span>
        <span class="n">conversation_handler</span> <span class="o">=</span> <span class="n">get_save_conversation_handler</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">conversation_handler</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;ConversationHandler נוסף&quot;</span><span class="p">)</span>

        <span class="c1"># ספור שוב</span>
        <span class="n">handler_count_after</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">handlers</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🔍 כמות handlers אחרי: </span><span class="si">{</span><span class="n">handler_count_after</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># --- GitHub handlers - חייבים להיות לפני ה-handler הגלובלי! ---</span>
        <span class="c1"># יצירת instance יחיד של GitHubMenuHandler ושמירה ב-bot_data</span>
        <span class="n">github_handler</span> <span class="o">=</span> <span class="n">GitHubMenuHandler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">bot_data</span><span class="p">[</span><span class="s1">&#39;github_handler&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">github_handler</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;✅ GitHubMenuHandler instance created and stored in bot_data&quot;</span><span class="p">)</span>
        <span class="c1"># יצירת BackupMenuHandler ושמירה</span>
        <span class="n">backup_handler</span> <span class="o">=</span> <span class="n">BackupMenuHandler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">bot_data</span><span class="p">[</span><span class="s1">&#39;backup_handler&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">backup_handler</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;✅ BackupMenuHandler instance created and stored in bot_data&quot;</span><span class="p">)</span>

        <span class="c1"># יצירת GoogleDriveMenuHandler ושמירה</span>
        <span class="n">drive_handler</span> <span class="o">=</span> <span class="n">GoogleDriveMenuHandler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">bot_data</span><span class="p">[</span><span class="s1">&#39;drive_handler&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">drive_handler</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;✅ GoogleDriveMenuHandler instance created and stored in bot_data&quot;</span><span class="p">)</span>
        
        <span class="c1"># הוסף פקודת github</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;github&quot;</span><span class="p">,</span> <span class="n">github_handler</span><span class="o">.</span><span class="n">github_menu_command</span><span class="p">))</span>
        <span class="c1"># הוסף תפריט גיבוי/שחזור</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">show_backup_menu</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">backup_handler</span><span class="o">.</span><span class="n">show_backup_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;backup&quot;</span><span class="p">,</span> <span class="n">show_backup_menu</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CallbackQueryHandler</span><span class="p">(</span><span class="n">backup_handler</span><span class="o">.</span><span class="n">handle_callback_query</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^(backup_|backup_add_note:.*)&#39;</span><span class="p">))</span>
        
        <span class="c1"># הוסף את ה-callbacks של GitHub - חשוב! לפני ה-handler הגלובלי</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span>
                        <span class="n">CallbackQueryHandler</span><span class="p">(</span><span class="n">github_handler</span><span class="o">.</span><span class="n">handle_menu_callback</span><span class="p">,</span> 
                               <span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^(select_repo|upload_file|upload_saved|show_current|set_token|set_folder|close_menu|folder_|repo_|repos_page_|upload_saved_|back_to_menu|repo_manual|noop|analyze_repo|analyze_current_repo|analyze_other_repo|show_suggestions|show_full_analysis|download_analysis_json|back_to_analysis|back_to_analysis_menu|back_to_summary|choose_my_repo|enter_repo_url|suggestion_\d+|github_menu|logout_github|delete_file_menu|delete_repo_menu|confirm_delete_repo|confirm_delete_repo_step1|confirm_delete_file|danger_delete_menu|download_file_menu|browse_repo|browse_open:.*|browse_select_download:.*|browse_select_delete:.*|browse_page:.*|download_zip:.*|multi_toggle|multi_execute|multi_clear|safe_toggle|browse_toggle_select:.*|inline_download_file:.*|view_more|view_back|browse_select_view:.*|browse_ref_menu|browse_refs_branches_page_.*|browse_refs_tags_page_.*|browse_select_ref:.*|browse_search|browse_search_page:.*|notifications_menu|notifications_toggle|notifications_toggle_pr|notifications_toggle_issues|notifications_interval_.*|notifications_check_now|share_folder_link:.*|share_selected_links|pr_menu|create_pr_menu|branches_page_.*|pr_select_head:.*|confirm_create_pr|merge_pr_menu|prs_page_.*|merge_pr:.*|confirm_merge_pr|validate_repo|git_checkpoint|git_checkpoint_doc:.*|git_checkpoint_doc_skip|restore_checkpoint_menu|restore_tags_page_.*|restore_select_tag:.*|restore_branch_from_tag:.*|restore_revert_pr_from_tag:.*|open_pr_from_branch:.*|choose_upload_branch|upload_branches_page_.*|upload_select_branch:.*|upload_select_branch_tok:.*|choose_upload_folder|upload_select_folder:.*|upload_folder_root|upload_folder_current|upload_folder_custom|upload_folder_create|create_folder|confirm_saved_upload|refresh_saved_checks|github_backup_menu|github_backup_help|github_backup_db_list|github_restore_zip_to_repo|github_restore_zip_setpurge:.*|github_restore_zip_list|github_restore_zip_from_backup:.*|github_repo_restore_backup_setpurge:.*|gh_upload_cat:.*|gh_upload_repo:.*|gh_upload_large:.*|backup_menu|github_create_repo_from_zip|github_new_repo_name|github_set_new_repo_visibility:.*|upload_paste_code|cancel_paste_flow|gh_upload_zip_browse:.*|gh_upload_zip_page:.*|gh_upload_zip_select:.*|gh_upload_zip_select_idx:.*|backup_add_note:.*|github_import_repo|import_repo_branches_page_.*|import_repo_select_branch:.*|import_repo_start|import_repo_cancel)&#39;</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># הוסף את ה-callbacks של Google Drive</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span>
            <span class="n">CallbackQueryHandler</span><span class="p">(</span>
                <span class="n">drive_handler</span><span class="o">.</span><span class="n">handle_callback</span><span class="p">,</span>
                <span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^(drive_menu|drive_auth|drive_poll_once|drive_cancel_auth|drive_backup_now|drive_sel_zip|drive_sel_all|drive_sel_adv|drive_advanced|drive_adv_by_repo|drive_adv_large|drive_adv_other|drive_choose_folder|drive_choose_folder_adv|drive_folder_default|drive_folder_auto|drive_folder_set|drive_folder_back|drive_folder_cancel|drive_schedule|drive_set_schedule:.*|drive_status|drive_adv_multi_toggle|drive_adv_upload_selected|drive_logout|drive_logout_do|drive_simple_confirm|drive_adv_confirm|drive_make_zip_now|drive_help)$&#39;</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Inline query handler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">InlineQueryHandler</span><span class="p">(</span><span class="n">github_handler</span><span class="o">.</span><span class="n">handle_inline_query</span><span class="p">))</span>
        
        <span class="c1"># הגדר conversation handler להעלאת קבצים</span>
        <span class="kn">from</span> <span class="nn">github_menu_handler</span> <span class="kn">import</span> <span class="n">FILE_UPLOAD</span><span class="p">,</span> <span class="n">REPO_SELECT</span><span class="p">,</span> <span class="n">FOLDER_SELECT</span>
        <span class="n">upload_conv_handler</span> <span class="o">=</span> <span class="n">ConversationHandler</span><span class="p">(</span>
            <span class="n">entry_points</span><span class="o">=</span><span class="p">[</span>
                <span class="n">CallbackQueryHandler</span><span class="p">(</span><span class="n">github_handler</span><span class="o">.</span><span class="n">handle_menu_callback</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s1">&#39;^upload_file$&#39;</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="n">states</span><span class="o">=</span><span class="p">{</span>
                <span class="n">FILE_UPLOAD</span><span class="p">:</span> <span class="p">[</span>
                    <span class="n">MessageHandler</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">Document</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span> <span class="n">github_handler</span><span class="o">.</span><span class="n">handle_file_upload</span><span class="p">)</span>
                <span class="p">],</span>
                <span class="n">REPO_SELECT</span><span class="p">:</span> <span class="p">[</span>
                    <span class="n">MessageHandler</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">TEXT</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">filters</span><span class="o">.</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">github_handler</span><span class="o">.</span><span class="n">handle_text_input</span><span class="p">)</span>
                <span class="p">],</span>
                <span class="n">FOLDER_SELECT</span><span class="p">:</span> <span class="p">[</span>
                    <span class="n">MessageHandler</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">TEXT</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">filters</span><span class="o">.</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">github_handler</span><span class="o">.</span><span class="n">handle_text_input</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="p">},</span>
            <span class="n">fallbacks</span><span class="o">=</span><span class="p">[</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s1">&#39;cancel&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">u</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span><span class="p">)]</span>
        <span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">upload_conv_handler</span><span class="p">)</span>
        
        <span class="c1"># הוסף handler כללי לטיפול בקלט טקסט של GitHub (כולל URL לניתוח)</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">handle_github_text</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
            <span class="c1"># העבר כל קלט רלוונטי למנהל GitHub לפי דגלים ב-user_data</span>
            <span class="n">text</span> <span class="o">=</span> <span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">text</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">main_menu_texts</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;➕ הוסף קוד חדש&quot;</span><span class="p">,</span> <span class="s2">&quot;📚 הצג את כל הקבצים שלי&quot;</span><span class="p">,</span> <span class="s2">&quot;📂 קבצים גדולים&quot;</span><span class="p">,</span> <span class="s2">&quot;🔧 GitHub&quot;</span><span class="p">,</span> <span class="s2">&quot;🏠 תפריט ראשי&quot;</span><span class="p">,</span> <span class="s2">&quot;⚡ עיבוד Batch&quot;</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">main_menu_texts</span><span class="p">:</span>
                <span class="c1"># נקה דגלים כדי למנוע טריגר שגוי</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;waiting_for_repo_url&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;waiting_for_delete_file_path&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;waiting_for_download_file_path&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;waiting_for_new_repo_name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;waiting_for_selected_folder&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;waiting_for_new_folder_path&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;waiting_for_upload_folder&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;return_to_pre_upload&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="c1"># נקה גם דגלי &quot;הדבק קוד&quot; כדי לצאת יפה מהזרימה</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;waiting_for_paste_content&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;waiting_for_paste_filename&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;paste_content&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="c1"># זרימת הוספת הערה לגיבוי (משותפת ל-GitHub/Backup)</span>
            <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;waiting_for_backup_note_for&#39;</span><span class="p">):</span>
                <span class="n">backup_id</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;waiting_for_backup_note_for&#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>
                    <span class="n">ok</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">save_backup_note</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">backup_id</span><span class="p">,</span> <span class="p">(</span><span class="n">text</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)[:</span><span class="mi">1000</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                            <span class="s2">&quot;✅ ההערה נשמרה!&quot;</span><span class="p">,</span>
                            <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">([[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזרה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;backup_details:</span><span class="si">{</span><span class="n">backup_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)]])</span>
                        <span class="p">)</span>
                        <span class="c1"># מנע הודעת &quot;נראה שזה קטע קוד!&quot; עבור ההודעה הזו</span>
                        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;suppress_code_hint_once&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;❌ שמירת ההערה נכשלה&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה בשמירת ההערה: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="c1"># קלט נתיב יעד ידני לסביבת העלאה (upload_folder_custom)</span>
            <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;waiting_for_upload_folder&#39;</span><span class="p">):</span>
                <span class="c1"># ניתוב טקסט למטפל טקסטים של GitHub (סמנטי ונקי)</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">github_handler</span><span class="o">.</span><span class="n">handle_text_input</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;waiting_for_repo_url&#39;</span><span class="p">)</span> <span class="ow">or</span> \
               <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;waiting_for_delete_file_path&#39;</span><span class="p">)</span> <span class="ow">or</span> \
               <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;waiting_for_download_file_path&#39;</span><span class="p">)</span> <span class="ow">or</span> \
               <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;waiting_for_new_repo_name&#39;</span><span class="p">)</span> <span class="ow">or</span> \
               <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;waiting_for_selected_folder&#39;</span><span class="p">)</span> <span class="ow">or</span> \
               <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;waiting_for_new_folder_path&#39;</span><span class="p">)</span> <span class="ow">or</span> \
               <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;waiting_for_paste_content&#39;</span><span class="p">)</span> <span class="ow">or</span> \
               <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;waiting_for_paste_filename&#39;</span><span class="p">)</span> <span class="ow">or</span> \
               <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;browse_search_mode&#39;</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🔗 Routing GitHub-related text input from user </span><span class="si">{</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">github_handler</span><span class="o">.</span><span class="n">handle_text_input</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        
        <span class="c1"># הוסף את ה-handler עם עדיפות גבוהה</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span>
            <span class="n">MessageHandler</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">TEXT</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">filters</span><span class="o">.</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">handle_github_text</span><span class="p">),</span>
            <span class="n">group</span><span class="o">=-</span><span class="mi">1</span>  <span class="c1"># עדיפות גבוהה מאוד</span>
        <span class="p">)</span>
        <span class="c1"># הוסף handler טקסט ל-Drive (קוד אישור)</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">handle_drive_text</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">drive_handler</span><span class="o">.</span><span class="n">handle_text</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span>
            <span class="n">MessageHandler</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">TEXT</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">filters</span><span class="o">.</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">handle_drive_text</span><span class="p">),</span>
            <span class="n">group</span><span class="o">=-</span><span class="mi">1</span>
        <span class="p">)</span>

        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;✅ GitHub handler נוסף בהצלחה&quot;</span><span class="p">)</span>
        
        <span class="c1"># Handler נפרד לטיפול בטוקן GitHub</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">handle_github_token</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">text</span>
            <span class="k">if</span> <span class="n">text</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ghp_&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">text</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;github_pat_&#39;</span><span class="p">):</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
                <span class="k">if</span> <span class="n">user_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">github_handler</span><span class="o">.</span><span class="n">user_sessions</span><span class="p">:</span>
                    <span class="n">github_handler</span><span class="o">.</span><span class="n">user_sessions</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="c1"># שמירה בזיכרון בלבד לשימוש שוטף</span>
                <span class="n">github_handler</span><span class="o">.</span><span class="n">user_sessions</span><span class="p">[</span><span class="n">user_id</span><span class="p">][</span><span class="s1">&#39;github_token&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span>
                
                <span class="c1"># שמור גם במסד נתונים (עם הצפנה אם מוגדר מפתח)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">save_github_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
                
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                    <span class="s2">&quot;✅ טוקן נשמר בהצלחה!</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;כעת תוכל לגשת לריפוזיטוריז הפרטיים שלך.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;שלח /github כדי לחזור לתפריט.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>
        
        <span class="c1"># הוסף את ה-handler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span>
            <span class="n">MessageHandler</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">Regex</span><span class="p">(</span><span class="s1">&#39;^(ghp_|github_pat_)&#39;</span><span class="p">),</span> <span class="n">handle_github_token</span><span class="p">),</span>
            <span class="n">group</span><span class="o">=</span><span class="mi">0</span>  <span class="c1"># עדיפות גבוהה</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;✅ GitHub token handler נוסף בהצלחה&quot;</span><span class="p">)</span>

        <span class="c1"># פקודה למחיקת טוקן GitHub</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">handle_github_logout</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
            <span class="c1"># מחיקה מהמסד נתונים</span>
            <span class="n">removed</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">delete_github_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="c1"># ניקוי מהסשן</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">session</span> <span class="o">=</span> <span class="n">github_handler</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                <span class="n">session</span><span class="p">[</span><span class="s2">&quot;github_token&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">session</span><span class="p">[</span><span class="s1">&#39;selected_repo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">session</span><span class="p">[</span><span class="s1">&#39;selected_folder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="c1"># ניקוי קאש ריפוזיטוריז</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;repos&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;repos_cache_time&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">removed</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;🔐 הטוקן נמחק בהצלחה מהחשבון שלך.</span><span class="se">\n</span><span class="s2">✅ הוסרו גם הגדרות ריפו/תיקייה.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;ℹ️ לא נמצא טוקן לשחזור או שאירעה שגיאה.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;github_logout&quot;</span><span class="p">,</span> <span class="n">handle_github_logout</span><span class="p">))</span>

        <span class="c1"># --- Guard גלובלי ללחיצות כפולות על CallbackQuery (קדימות גבוהה ביותר) ---</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">_global_callback_guard</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s1">&#39;callback_query&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="c1"># בדיקת דופליקטים קצרה לכל הכפתורים</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">CallbackQueryGuard</span>
                        <span class="k">if</span> <span class="k">await</span> <span class="n">CallbackQueryGuard</span><span class="o">.</span><span class="n">should_block_async</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="k">pass</span>
                            <span class="c1"># עצור עיבוד נוסף של ההודעה הנוכחית</span>
                            <span class="k">raise</span> <span class="n">ApplicationHandlerStop</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
            <span class="k">except</span> <span class="n">ApplicationHandlerStop</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># הוסף את ה-guard בקבוצה בעלת עדיפות הגבוהה ביותר, לפני כל ה-handlers (כולל batch/github/drive)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CallbackQueryHandler</span><span class="p">(</span><span class="n">_global_callback_guard</span><span class="p">),</span> <span class="n">group</span><span class="o">=-</span><span class="mi">100</span><span class="p">)</span>

        <span class="c1"># הוספת פקודות batch (עיבוד מרובה קבצים) לאחר ה-guard כך שלא יעקוף אותו</span>
        <span class="n">setup_batch_handlers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="p">)</span>

        <span class="c1"># הוספת Refactoring handlers (אם זמינים)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">refactor_handlers</span> <span class="kn">import</span> <span class="n">setup_refactor_handlers</span> <span class="k">as</span> <span class="n">_setup_rf</span>
            <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">_setup_rf</span><span class="p">):</span>
                <span class="n">_setup_rf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;✅ RefactorHandlers הוגדרו (פקודת /refactor זמינה)&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ דילוג על RefactorHandlers: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># --- רק אחרי כל ה-handlers הספציפיים, הוסף את ה-handler הגלובלי ---</span>
        <span class="c1"># חשוב: הוספה בקבוצה מאוחרת כדי שלא תתפוס לפני handlers ייעודיים (למשל מועדפים)</span>
        <span class="kn">from</span> <span class="nn">conversation_handlers</span> <span class="kn">import</span> <span class="n">handle_callback_query</span>
        <span class="n">_register_catch_all_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="p">,</span> <span class="n">handle_callback_query</span><span class="p">)</span>

        <span class="c1"># ספור סופי</span>
        <span class="n">final_handler_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">handlers</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🔍 כמות handlers סופית: </span><span class="si">{</span><span class="n">final_handler_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># הדפס את כל ה-handlers</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">handler</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">handlers</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Handler </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># --- שלב 2: רישום שאר הפקודות ---</span>
        <span class="c1"># פקודת מנהלים: recycle_backfill</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;recycle_backfill&quot;</span><span class="p">,</span> <span class="n">recycle_backfill_command</span><span class="p">))</span>
        <span class="c1"># הפקודה /start המקורית הופכת להיות חלק מה-conv_handler, אז היא לא כאן.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;help&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">help_command</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;save&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_command</span><span class="p">))</span>
        <span class="c1"># self.application.add_handler(CommandHandler(&quot;list&quot;, self.list_command))  # מחוק - מטופל על ידי הכפתור &quot;📚 הצג את כל הקבצים שלי&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;search&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_command</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;stats&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats_command</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;check&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_commands</span><span class="p">))</span>
        
        <span class="c1"># הוספת פקודות cache</span>
        <span class="n">setup_cache_handlers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="p">)</span>
        
        <span class="c1"># הוספת פקודות משופרות (אוטו-השלמה ותצוגה מקדימה) - disabled</span>
        <span class="c1"># setup_enhanced_handlers(self.application)</span>

        <span class="c1"># הטרמינל הוסר בסביבת Render (Docker לא זמין)</span>


        <span class="c1"># הוספת handlers לכפתורים החדשים במקלדת הראשית</span>
        <span class="kn">from</span> <span class="nn">conversation_handlers</span> <span class="kn">import</span> <span class="n">handle_batch_button</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">MessageHandler</span><span class="p">(</span>
            <span class="n">filters</span><span class="o">.</span><span class="n">Regex</span><span class="p">(</span><span class="s2">&quot;^⚡ עיבוד Batch$&quot;</span><span class="p">),</span> 
            <span class="n">handle_batch_button</span>
        <span class="p">))</span>
        <span class="c1"># כפתור לתפריט Google Drive</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">show_drive_menu</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">drive_handler</span><span class="o">.</span><span class="n">menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">MessageHandler</span><span class="p">(</span>
            <span class="n">filters</span><span class="o">.</span><span class="n">Regex</span><span class="p">(</span><span class="s2">&quot;^☁️ Google Drive$&quot;</span><span class="p">),</span>
            <span class="n">show_drive_menu</span>
        <span class="p">))</span>

        <span class="c1"># פקודה /drive</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;drive&quot;</span><span class="p">,</span> <span class="n">show_drive_menu</span><span class="p">))</span>
        
        <span class="c1"># כפתור Web App</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">show_webapp</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
            <span class="n">webapp_url</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;WEBAPP_URL&#39;</span><span class="p">,</span> <span class="s1">&#39;https://code-keeper-webapp.onrender.com&#39;</span><span class="p">)</span>
            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🌐 פתח את ה-Web App&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">webapp_url</span><span class="p">)],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔐 התחבר ל-Web App&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">webapp_url</span><span class="si">}</span><span class="s2">/login&quot;</span><span class="p">)]</span>
            <span class="p">]</span>
            <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;🌐 &lt;b&gt;Web App - ממשק ניהול מתקדם&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;צפה ונהל את כל הקבצים שלך דרך הדפדפן:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;• 📊 דשבורד עם סטטיסטיקות</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;• 🔍 חיפוש וסינון מתקדם</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;• 👁️ צפייה בקבצים עם הדגשת syntax</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;• 📥 הורדת קבצים</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;• 📱 עובד בכל מכשיר</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;לחץ על הכפתור למטה כדי לפתוח:&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span>
            <span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">MessageHandler</span><span class="p">(</span>
            <span class="n">filters</span><span class="o">.</span><span class="n">Regex</span><span class="p">(</span><span class="s2">&quot;^🌐 Web App$&quot;</span><span class="p">),</span>
            <span class="n">show_webapp</span>
        <span class="p">))</span>
        
        <span class="c1"># פקודה /webapp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;webapp&quot;</span><span class="p">,</span> <span class="n">show_webapp</span><span class="p">))</span>
        
        <span class="c1"># כפתור חדש לתפריט גיבוי/שחזור</span>

        <span class="c1"># פקודה /docs – שליחת קישור לתיעוד</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">show_docs</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📚 תיעוד: </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">DOCUMENTATION_URL</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;docs&quot;</span><span class="p">,</span> <span class="n">show_docs</span><span class="p">))</span>
        <span class="c1"># הוסר: כפתורי גיבוי/שחזור מהמקלדת הראשית. כעת תחת /github -&gt; 🧰 גיבוי ושחזור</span>
        <span class="c1"># self.application.add_handler(MessageHandler(</span>
        <span class="c1">#     filters.Regex(&quot;^(📦 גיבוי מלא|♻️ שחזור מגיבוי|🧰 גיבוי/שחזור)$&quot;),</span>
        <span class="c1">#     show_backup_menu</span>
        <span class="c1"># ))</span>
        
        <span class="c1"># --- שלב 3: רישום handler לקבצים ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span>
            <span class="n">MessageHandler</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">Document</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_document</span><span class="p">)</span>
        <span class="p">)</span>
        
        <span class="c1"># --- שלב 4: רישום המטפל הכללי בסוף ---</span>
        <span class="c1"># הוא יפעל רק אם אף אחד מהמטפלים הספציפיים יותר לא תפס את ההודעה.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span>
            <span class="n">MessageHandler</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">TEXT</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">filters</span><span class="o">.</span><span class="n">COMMAND</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_text_message</span><span class="p">)</span>
        <span class="p">)</span>
        
        <span class="c1"># --- שלב 5: טיפול בשגיאות ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">add_error_handler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="p">)</span></div>

    
    <span class="c1"># start_command הוסר - ConversationHandler מטפל בפקודת /start</span>
    
<div class="viewcode-block" id="CodeKeeperBot.help_command">
<a class="viewcode-back" href="../api/main.html#main.CodeKeeperBot.help_command">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">help_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;פקודת עזרה מפורטת&quot;&quot;&quot;</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">log_user_activity</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">📚 &lt;b&gt;רשימת הפקודות המלאה:&lt;/b&gt;</span>

<span class="s2">&lt;b&gt;שמירה וניהול:&lt;/b&gt;</span>
<span class="s2">• &lt;code&gt;/save &amp;lt;filename&amp;gt;&lt;/code&gt; - התחלת שמירה של קובץ חדש.</span>
<span class="s2">• &lt;code&gt;/list&lt;/code&gt; - הצגת כל הקבצים שלך.</span>
<span class="s2">• &lt;code&gt;/show &amp;lt;filename&amp;gt;&lt;/code&gt; - הצגת קובץ עם הדגשת תחביר וכפתורי פעולה.</span>
<span class="s2">• &lt;code&gt;/edit &amp;lt;filename&amp;gt;&lt;/code&gt; - עריכת קוד של קובץ קיים.</span>
<span class="s2">• &lt;code&gt;/delete &amp;lt;filename&amp;gt;&lt;/code&gt; - מחיקת קובץ.</span>
<span class="s2">• &lt;code&gt;/rename &amp;lt;old&amp;gt; &amp;lt;new&amp;gt;&lt;/code&gt; - שינוי שם קובץ.</span>
<span class="s2">• &lt;code&gt;/download &amp;lt;filename&amp;gt;&lt;/code&gt; - הורדת קובץ כמסמך.</span>
<span class="s2">• &lt;code&gt;/github&lt;/code&gt; - תפריט העלאה ל-GitHub.</span>
<span class="s2">    </span>
<span class="s2">&lt;b&gt;חיפוש וסינון:&lt;/b&gt;</span>
<span class="s2">• &lt;code&gt;/recent&lt;/code&gt; - הצגת קבצים שעודכנו לאחרונה.</span>
<span class="s2">• &lt;code&gt;/stats&lt;/code&gt; - סטטיסטיקות אישיות.</span>
<span class="s2">• &lt;code&gt;/tags &amp;lt;filename&amp;gt; &amp;lt;tag1&amp;gt;,&amp;lt;tag2&amp;gt;&lt;/code&gt; - הוספת תגיות לקובץ.</span>
<span class="s2">• &lt;code&gt;/search &amp;lt;query&amp;gt;&lt;/code&gt; - חיפוש טקסטואלי בקוד שלך.</span>
<span class="s2">    </span>
<span class="s2">&lt;b&gt;פיצ&#39;רים חדשים:&lt;/b&gt;</span>
<span class="s2">• &lt;code&gt;/autocomplete &amp;lt;חלק_משם&amp;gt;&lt;/code&gt; - אוטו-השלמה לשמות קבצים.</span>
<span class="s2">• &lt;code&gt;/preview &amp;lt;filename&amp;gt;&lt;/code&gt; - תצוגה מקדימה של קוד (15 שורות ראשונות).</span>
<span class="s2">• &lt;code&gt;/info &amp;lt;filename&amp;gt;&lt;/code&gt; - מידע מהיר על קובץ ללא פתיחה.</span>
<span class="s2">• &lt;code&gt;/large &amp;lt;filename&amp;gt;&lt;/code&gt; - הצגת קובץ גדול עם ניווט בחלקים.</span>

<span class="s2">&lt;b&gt;עיבוד Batch (מרובה קבצים):&lt;/b&gt;</span>
<span class="s2">• &lt;code&gt;/batch_analyze all&lt;/code&gt; - ניתוח כל הקבצים בו-זמנית.</span>
<span class="s2">• &lt;code&gt;/batch_analyze python&lt;/code&gt; - ניתוח קבצי שפה ספציפית.</span>
<span class="s2">• &lt;code&gt;/batch_validate all&lt;/code&gt; - בדיקת תקינות מרובה קבצים.</span>
<span class="s2">• &lt;code&gt;/job_status&lt;/code&gt; - בדיקת סטטוס עבודות ברקע.</span>

<span class="s2">&lt;b&gt;ביצועים ותחזוקה:&lt;/b&gt;</span>
<span class="s2">• &lt;code&gt;/cache_stats&lt;/code&gt; - סטטיסטיקות ביצועי cache.</span>
<span class="s2">• &lt;code&gt;/clear_cache&lt;/code&gt; - ניקוי cache אישי לשיפור ביצועים.</span>

<span class="s2">&lt;b&gt;מידע כללי:&lt;/b&gt;</span>
<span class="s2">• &lt;code&gt;/recent&lt;/code&gt; - הצגת קבצים שעודכנו לאחרונה.</span>
<span class="s2">• &lt;code&gt;/help&lt;/code&gt; - הצגת הודעה זו.</span>

<span class="s2">🔧 &lt;b&gt;לכל תקלה בבוט נא לשלוח הודעה ל-@moominAmir&lt;/b&gt;</span>
<span class="s2">&quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="CodeKeeperBot.save_command">
<a class="viewcode-back" href="../api/main.html#main.CodeKeeperBot.save_command">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">save_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;פקודת שמירת קוד&quot;&quot;&quot;</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">log_user_activity</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;❓ אנא ציין שם קובץ:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;דוגמה: `/save script.py`</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;עם תגיות: `/save script.py #python #api`&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># פרסור שם קובץ ותגיות</span>
        <span class="n">args</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># חילוץ תגיות</span>
        <span class="kn">import</span> <span class="nn">re</span>
        <span class="n">tag_matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;#(\w+)&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tag_matches</span><span class="p">:</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="n">tag_matches</span>
            <span class="c1"># הסרת התגיות משם הקובץ</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;#\w+&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">args</span>
        
        <span class="c1"># שמירת מידע בהקשר למשך השיחה</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;saving_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;file_name&#39;</span><span class="p">:</span> <span class="n">file_name</span><span class="p">,</span>
            <span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="n">tags</span><span class="p">,</span>
            <span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="n">user_id</span>
        <span class="p">}</span>
        
        <span class="n">safe_file_name</span> <span class="o">=</span> <span class="n">html_escape</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
        <span class="n">safe_tags</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">html_escape</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">)</span> <span class="k">if</span> <span class="n">tags</span> <span class="k">else</span> <span class="s1">&#39;ללא&#39;</span>
        
        <span class="c1"># בקשת קוד ולאחריו הערה אופציונלית</span>
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;📝 מוכן לשמור את &lt;code&gt;</span><span class="si">{</span><span class="n">safe_file_name</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;🏷️ תגיות: </span><span class="si">{</span><span class="n">safe_tags</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;אנא שלח את קטע הקוד:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;(אחרי שנקבל את הקוד, אשאל אם תרצה להוסיף הערה)&quot;</span><span class="p">,</span>
            <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span>
        <span class="p">)</span></div>

    
<div class="viewcode-block" id="CodeKeeperBot.list_command">
<a class="viewcode-back" href="../api/main.html#main.CodeKeeperBot.list_command">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">list_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;הצגת רשימת הקטעים של המשתמש&quot;&quot;&quot;</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        
        <span class="n">files</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user_files</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;📂 עדיין לא שמרת קטעי קוד.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;השתמש ב/save כדי להתחיל!&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># בניית הרשימה</span>
        <span class="n">response</span> <span class="o">=</span> <span class="s2">&quot;📋 **הקטעים שלך:**</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">file_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">tags_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="p">[]))</span> <span class="k">if</span> <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="n">description</span> <span class="o">=</span> <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            
            <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;**</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">**</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;🔤 שפה: </span><span class="si">{</span><span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;programming_language&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            
            <span class="k">if</span> <span class="n">description</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;📝 תיאור: </span><span class="si">{</span><span class="n">description</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            
            <span class="k">if</span> <span class="n">tags_str</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;🏷️ תגיות: </span><span class="si">{</span><span class="n">tags_str</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            
            <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;📅 עודכן: </span><span class="si">{</span><span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;updated_at&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/%m/%Y %H:%M&#39;</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;🔢 גרסה: </span><span class="si">{</span><span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">20</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">📄 מוצגים 20 הקטעים האחרונים. השתמש בחיפוש לעוד...&quot;</span>
        
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="CodeKeeperBot.search_command">
<a class="viewcode-back" href="../api/main.html#main.CodeKeeperBot.search_command">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">search_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;חיפוש קטעי קוד&quot;&quot;&quot;</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">log_user_activity</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;🔍 **איך לחפש:**</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;• `/search python` - לפי שפה</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;• `/search api` - חיפוש חופשי</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;• `/search #automation` - לפי תגית</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;• `/search script` - בשם קובץ&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        
        <span class="c1"># זיהוי אם זה חיפוש לפי תגית</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">query</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">elif</span> <span class="n">query</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">SUPPORTED_LANGUAGES</span><span class="p">:</span>
            <span class="c1"># חיפוש לפי שפה</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">search_code</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">programming_language</span><span class="o">=</span><span class="n">query</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># חיפוש חופשי</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">search_code</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">results</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;🔍 לא נמצאו תוצאות עבור: &lt;code&gt;</span><span class="si">{</span><span class="n">html_escape</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">))</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># הצגת תוצאות</span>
        <span class="n">safe_query</span> <span class="o">=</span> <span class="n">html_escape</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>
        <span class="n">response</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;🔍 **תוצאות חיפוש עבור:** &lt;code&gt;</span><span class="si">{</span><span class="n">safe_query</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">file_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">results</span><span class="p">[:</span><span class="mi">10</span><span class="p">],</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. &lt;code&gt;</span><span class="si">{</span><span class="n">html_escape</span><span class="p">(</span><span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&lt;/code&gt; — </span><span class="si">{</span><span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;programming_language&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">📄 מוצגות 10 מתוך </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="s2"> תוצאות&quot;</span>
        
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="CodeKeeperBot.check_commands">
<a class="viewcode-back" href="../api/main.html#main.CodeKeeperBot.check_commands">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">check_commands</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;בדיקת הפקודות הזמינות (רק לאמיר)&quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="mi">6865105071</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="c1"># בדוק פקודות ציבוריות</span>
        <span class="n">public_cmds</span> <span class="o">=</span> <span class="k">await</span> <span class="n">context</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">get_my_commands</span><span class="p">()</span>
        
        <span class="c1"># בדוק פקודות אישיות</span>
        <span class="kn">from</span> <span class="nn">telegram</span> <span class="kn">import</span> <span class="n">BotCommandScopeChat</span>
        <span class="n">personal_cmds</span> <span class="o">=</span> <span class="k">await</span> <span class="n">context</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">get_my_commands</span><span class="p">(</span>
            <span class="n">scope</span><span class="o">=</span><span class="n">BotCommandScopeChat</span><span class="p">(</span><span class="n">chat_id</span><span class="o">=</span><span class="mi">6865105071</span><span class="p">)</span>
        <span class="p">)</span>
        
        <span class="kn">from</span> <span class="nn">html</span> <span class="kn">import</span> <span class="n">escape</span> <span class="k">as</span> <span class="n">html_escape</span>

        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;📋 &lt;b&gt;סטטוס פקודות&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;סיכום: ציבוריות </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">public_cmds</span><span class="p">)</span><span class="si">}</span><span class="s2"> | אישיות </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">personal_cmds</span><span class="p">)</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">public_cmds</span><span class="p">:</span>
            <span class="n">public_list</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">cmd</span><span class="o">.</span><span class="n">command</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">public_cmds</span><span class="p">)</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;&lt;b&gt;ציבוריות:&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;&lt;pre&gt;</span><span class="si">{</span><span class="n">html_escape</span><span class="p">(</span><span class="n">public_list</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/pre&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">personal_cmds</span><span class="p">:</span>
            <span class="n">personal_list</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">cmd</span><span class="o">.</span><span class="n">command</span><span class="si">}</span><span class="s2"> — </span><span class="si">{</span><span class="n">cmd</span><span class="o">.</span><span class="n">description</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">personal_cmds</span><span class="p">)</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;&lt;b&gt;אישיות:&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;&lt;pre&gt;</span><span class="si">{</span><span class="n">html_escape</span><span class="p">(</span><span class="n">personal_list</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/pre&gt;&quot;</span>
        
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">)</span></div>


<div class="viewcode-block" id="CodeKeeperBot.stats_command">
<a class="viewcode-back" href="../api/main.html#main.CodeKeeperBot.stats_command">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">stats_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;הצגת סטטיסטיקות המשתמש או מנהל&quot;&quot;&quot;</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">log_user_activity</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>  <span class="c1"># הוספת רישום משתמש לסטטיסטיקות</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        
        <span class="c1"># רשימת מנהלים</span>
        <span class="n">ADMIN_IDS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">6865105071</span><span class="p">]</span>  <span class="c1"># הוסף את ה-ID שלך כאן!</span>
        
        <span class="c1"># אם המשתמש הוא מנהל, הצג סטטיסטיקות מנהל</span>
        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">in</span> <span class="n">ADMIN_IDS</span><span class="p">:</span>
            <span class="c1"># קבל סטטיסטיקות כלליות</span>
            <span class="n">general_stats</span> <span class="o">=</span> <span class="n">user_stats</span><span class="o">.</span><span class="n">get_all_time_stats</span><span class="p">()</span>
            <span class="n">weekly_users</span> <span class="o">=</span> <span class="n">user_stats</span><span class="o">.</span><span class="n">get_weekly_stats</span><span class="p">()</span>
            
            <span class="c1"># בנה הודעה בטוחה ל-HTML</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;📊 &lt;b&gt;סטטיסטיקות מנהל - שבוע אחרון:&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;👥 סה״כ משתמשים רשומים: </span><span class="si">{</span><span class="n">general_stats</span><span class="p">[</span><span class="s1">&#39;total_users&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;🟢 פעילים היום: </span><span class="si">{</span><span class="n">general_stats</span><span class="p">[</span><span class="s1">&#39;active_today&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;📅 פעילים השבוע: </span><span class="si">{</span><span class="n">general_stats</span><span class="p">[</span><span class="s1">&#39;active_week&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            
            <span class="k">if</span> <span class="n">weekly_users</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;📋 &lt;b&gt;רשימת משתמשים פעילים:&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="kn">from</span> <span class="nn">html</span> <span class="kn">import</span> <span class="n">escape</span> <span class="k">as</span> <span class="n">html_escape</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">user</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">weekly_users</span><span class="p">[:</span><span class="mi">15</span><span class="p">],</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">username</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;User&#39;</span>
                    <span class="c1"># הימלטות בטוחה</span>
                    <span class="n">safe_username</span> <span class="o">=</span> <span class="n">html_escape</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">safe_username</span> <span class="ow">and</span> <span class="n">safe_username</span> <span class="o">!=</span> <span class="s1">&#39;User&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">safe_username</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;User_&#39;</span><span class="p">):</span>
                        <span class="c1"># הוספת @ אם זה שם משתמש טלגרם</span>
                        <span class="n">display_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;@</span><span class="si">{</span><span class="n">safe_username</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">safe_username</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">safe_username</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">display_name</span> <span class="o">=</span> <span class="n">safe_username</span>
                    <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">display_name</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;days&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> ימים (</span><span class="si">{</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;total_actions&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> פעולות)</span><span class="se">\n</span><span class="s2">&quot;</span>
                
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">weekly_users</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">:</span>
                    <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">... ועוד </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">weekly_users</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">15</span><span class="si">}</span><span class="s2"> משתמשים&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;אין משתמשים פעילים בשבוע האחרון&quot;</span>
            
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">ReplyKeyboardMarkup</span><span class="p">(</span><span class="n">MAIN_KEYBOARD</span><span class="p">,</span> <span class="n">resize_keyboard</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># סטטיסטיקות רגילות למשתמש רגיל</span>
            <span class="n">stats</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user_stats</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">stats</span> <span class="ow">or</span> <span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_files&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                    <span class="s2">&quot;📊 עדיין אין לך קטעי קוד שמורים.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;התחל עם /save!&quot;</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">ReplyKeyboardMarkup</span><span class="p">(</span><span class="n">MAIN_KEYBOARD</span><span class="p">,</span> <span class="n">resize_keyboard</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">return</span>
            
            <span class="n">languages_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;languages&#39;</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="n">last_activity</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;latest_activity&#39;</span><span class="p">)</span>
            <span class="n">last_activity_str</span> <span class="o">=</span> <span class="n">last_activity</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/%m/%Y %H:%M&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">last_activity</span> <span class="k">else</span> <span class="s2">&quot;לא ידוע&quot;</span>
            
            <span class="n">response</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;📊 &lt;b&gt;הסטטיסטיקות שלך:&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;📁 סה</span><span class="se">\&quot;</span><span class="s2">כ קבצים: &lt;b&gt;</span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;total_files&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;🔢 סה</span><span class="se">\&quot;</span><span class="s2">כ גרסאות: &lt;b&gt;</span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;total_versions&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;💾 מגבלת קבצים: </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">MAX_FILES_PER_USER</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;🔤 &lt;b&gt;שפות בשימוש:&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">languages_str</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;📅 &lt;b&gt;פעילות אחרונה:&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">last_activity_str</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;💡 &lt;b&gt;טיפ:&lt;/b&gt; השתמש בתגיות לארגון טוב יותר!&quot;</span>
            <span class="p">)</span>
            
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">ReplyKeyboardMarkup</span><span class="p">(</span><span class="n">MAIN_KEYBOARD</span><span class="p">,</span> <span class="n">resize_keyboard</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span></div>

    
<div class="viewcode-block" id="CodeKeeperBot.handle_document">
<a class="viewcode-back" href="../api/main.html#main.CodeKeeperBot.handle_document">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">handle_document</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;טיפול בקבצים שנשלחים לבוט&quot;&quot;&quot;</span>
        
        <span class="c1"># דיבאג</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DEBUG: upload_mode = </span><span class="si">{</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;upload_mode&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DEBUG: waiting_for_github_upload = </span><span class="si">{</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;waiting_for_github_upload&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># שחזור ZIP ישירות לריפו בגיטהאב (פריסה והחלפה)</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;upload_mode&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;github_restore_zip_to_repo&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">document</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">document</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;GitHub restore-to-repo ZIP received: file_name=</span><span class="si">{</span><span class="n">document</span><span class="o">.</span><span class="n">file_name</span><span class="si">}</span><span class="s2">, size=</span><span class="si">{</span><span class="n">document</span><span class="o">.</span><span class="n">file_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;⏳ מוריד קובץ ZIP...&quot;</span><span class="p">)</span>
                <span class="n">file</span> <span class="o">=</span> <span class="k">await</span> <span class="n">context</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="n">document</span><span class="o">.</span><span class="n">file_id</span><span class="p">)</span>
                <span class="n">buf</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
                <span class="k">await</span> <span class="n">file</span><span class="o">.</span><span class="n">download_to_memory</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
                <span class="n">buf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="kn">import</span> <span class="nn">zipfile</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">is_zipfile</span><span class="p">(</span><span class="n">buf</span><span class="p">):</span>
                    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;❌ הקובץ שהועלה אינו ZIP תקין.&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="c1"># חלץ את ה-ZIP לזיכרון לרשימת קבצים</span>
                <span class="n">zf</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
                <span class="c1"># סינון ערכי מערכת של macOS וכד&#39;. נשמור רק קבצים אמיתיים</span>
                <span class="n">all_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">zf</span><span class="o">.</span><span class="n">namelist</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)]</span>
                <span class="n">members</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">all_names</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;__MACOSX/&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">n</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;._&#39;</span><span class="p">))]</span>
                <span class="c1"># זיהוי תיקיית-שורש משותפת (אם כל הקבצים חולקים את אותו הסגמנט העליון)</span>
                <span class="n">top_levels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">zf</span><span class="o">.</span><span class="n">namelist</span><span class="p">():</span>
                    <span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">n</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;__MACOSX/&#39;</span><span class="p">):</span>
                        <span class="n">top_levels</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">common_root</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">top_levels</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">top_levels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[restore_zip] Detected common_root=</span><span class="si">{</span><span class="n">common_root</span><span class="si">!r}</span><span class="s2">, files_in_zip=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">members</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># נקה תיקיית root של GitHub zip רק אם זוהתה תיקיית-שורש משותפת אחת</span>
                <span class="k">def</span> <span class="nf">strip_root</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">common_root</span> <span class="ow">and</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">common_root</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">):</span>
                        <span class="k">return</span> <span class="n">path</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">common_root</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
                    <span class="k">return</span> <span class="n">path</span>
                <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">members</span><span class="p">:</span>
                    <span class="n">raw</span> <span class="o">=</span> <span class="n">zf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">clean</span> <span class="o">=</span> <span class="n">strip_root</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">clean</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">clean</span><span class="p">,</span> <span class="n">raw</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;❌ לא נמצאו קבצים בתוך ה-ZIP&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="c1"># העלאה לגיטהאב באמצעות Trees API לעדכון מרובה קבצים</span>
                <span class="kn">from</span> <span class="nn">github</span> <span class="kn">import</span> <span class="n">Github</span>
                <span class="kn">from</span> <span class="nn">github.InputGitTreeElement</span> <span class="kn">import</span> <span class="n">InputGitTreeElement</span>
                <span class="n">github_handler</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">bot_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;github_handler&#39;</span><span class="p">)</span>
                <span class="n">session</span> <span class="o">=</span> <span class="n">github_handler</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                <span class="n">token</span> <span class="o">=</span> <span class="n">github_handler</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                <span class="n">repo_full</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;selected_repo&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">token</span> <span class="ow">and</span> <span class="n">repo_full</span><span class="p">):</span>
                    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;❌ אין טוקן או ריפו נבחר&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="c1"># יעד נעול לבטיחות: אם נקבע בתחילת הזרימה, תמיד נעדיף אותו</span>
                <span class="n">expected_repo_full</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;zip_restore_expected_repo_full&#39;</span><span class="p">)</span>
                <span class="n">repo_full_effective</span> <span class="o">=</span> <span class="n">expected_repo_full</span> <span class="ow">or</span> <span class="n">repo_full</span>
                <span class="k">if</span> <span class="n">expected_repo_full</span> <span class="ow">and</span> <span class="n">expected_repo_full</span> <span class="o">!=</span> <span class="n">repo_full</span><span class="p">:</span>
                    <span class="c1"># דווח על סטייה אבל המשך בבטחה עם היעד הנעול</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[restore_zip] Target mismatch: expected=</span><span class="si">{</span><span class="n">expected_repo_full</span><span class="si">}</span><span class="s2">, got=</span><span class="si">{</span><span class="n">repo_full</span><span class="si">}</span><span class="s2">. Proceeding with expected (locked) target.&quot;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;⚠️ נמצא פער בין היעד הנוכחי (</span><span class="si">{</span><span class="n">repo_full</span><span class="si">}</span><span class="s2">) ליעד הנעול. נשתמש ביעד הנעול: </span><span class="si">{</span><span class="n">expected_repo_full</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="c1"># אם לא נשמר יעד צפוי (גרסה ישנה), קבע אותו כעת</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">expected_repo_full</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;zip_restore_expected_repo_full&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">repo_full</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                <span class="c1"># נסיון גישה ליעד הנעול/האפקטיבי עם נפילה בטוחה</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_full_effective</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[restore_zip] Locked target not accessible: </span><span class="si">{</span><span class="n">repo_full_effective</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="c1"># נפילה בטוחה: אם אותו בעלים והריפו הנוכחי שונה – נסה את הריפו הנוכחי</span>
                    <span class="n">fallback_used</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">repo_full</span> <span class="ow">and</span> <span class="n">repo_full</span> <span class="o">!=</span> <span class="n">repo_full_effective</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">expected_owner</span> <span class="o">=</span> <span class="p">(</span><span class="n">expected_repo_full</span> <span class="ow">or</span> <span class="n">repo_full_effective</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">current_owner</span> <span class="o">=</span> <span class="n">repo_full</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="n">expected_owner</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">current_owner</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">if</span> <span class="n">expected_owner</span> <span class="ow">and</span> <span class="n">current_owner</span> <span class="ow">and</span> <span class="n">current_owner</span> <span class="o">==</span> <span class="n">expected_owner</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;⚠️ היעד הנעול </span><span class="si">{</span><span class="n">repo_full_effective</span><span class="si">}</span><span class="s2"> לא נגיש. מנסה להשתמש ביעד הנוכחי </span><span class="si">{</span><span class="n">repo_full</span><span class="si">}</span><span class="s2"> (אותו בעלים).&quot;</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="k">pass</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">repo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_repo</span><span class="p">(</span><span class="n">repo_full</span><span class="p">)</span>
                                <span class="n">repo_full_effective</span> <span class="o">=</span> <span class="n">repo_full</span>
                                <span class="n">fallback_used</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e2</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[restore_zip] Fallback to current repo failed: </span><span class="si">{</span><span class="n">e2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s1">&#39;repo&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
                        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;❌ היעד </span><span class="si">{</span><span class="n">repo_full_effective</span><span class="si">}</span><span class="s2"> לא נגיש ואין נפילה בטוחה. עצירה. אנא בחרו ריפו מחדש.&quot;</span><span class="p">)</span>
                        <span class="k">raise</span>
                <span class="n">target_branch</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">default_branch</span> <span class="ow">or</span> <span class="s1">&#39;main&#39;</span>
                <span class="n">purge_first</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;github_restore_zip_purge&#39;</span><span class="p">))</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                    <span class="p">(</span><span class="s2">&quot;🧹 מנקה קבצים קיימים...</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">purge_first</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span>
                    <span class="sa">f</span><span class="s2">&quot;📤 מעלה </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span><span class="si">}</span><span class="s2"> קבצים לריפו </span><span class="si">{</span><span class="n">repo_full_effective</span><span class="si">}</span><span class="s2"> (branch: </span><span class="si">{</span><span class="n">target_branch</span><span class="si">}</span><span class="s2">)...&quot;</span>
                <span class="p">)</span>
                <span class="c1"># בסיס לעץ</span>
                <span class="n">base_ref</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_git_ref</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;heads/</span><span class="si">{</span><span class="n">target_branch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">base_commit</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_git_commit</span><span class="p">(</span><span class="n">base_ref</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">sha</span><span class="p">)</span>
                <span class="n">base_tree</span> <span class="o">=</span> <span class="n">base_commit</span><span class="o">.</span><span class="n">tree</span>
                <span class="n">new_tree_elements</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1"># בנה עצי קלט</span>
                <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">raw</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                    <span class="c1"># שמור על קידוד נכון: טקסט כ-utf-8, בינארי כ-base64</span>
                    <span class="kn">import</span> <span class="nn">base64</span>
                    <span class="n">text_exts</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;.md&#39;</span><span class="p">,</span> <span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;.json&#39;</span><span class="p">,</span> <span class="s1">&#39;.yml&#39;</span><span class="p">,</span> <span class="s1">&#39;.yaml&#39;</span><span class="p">,</span> <span class="s1">&#39;.xml&#39;</span><span class="p">,</span> <span class="s1">&#39;.py&#39;</span><span class="p">,</span> <span class="s1">&#39;.js&#39;</span><span class="p">,</span> <span class="s1">&#39;.ts&#39;</span><span class="p">,</span> <span class="s1">&#39;.tsx&#39;</span><span class="p">,</span> <span class="s1">&#39;.css&#39;</span><span class="p">,</span> <span class="s1">&#39;.scss&#39;</span><span class="p">,</span> <span class="s1">&#39;.html&#39;</span><span class="p">,</span> <span class="s1">&#39;.sh&#39;</span><span class="p">,</span> <span class="s1">&#39;.gitignore&#39;</span><span class="p">)</span>
                    <span class="n">is_text</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">text_exts</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">is_text</span><span class="p">:</span>
                            <span class="n">text</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                            <span class="n">blob</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">create_git_blob</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">b64</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
                            <span class="n">blob</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">create_git_blob</span><span class="p">(</span><span class="n">b64</span><span class="p">,</span> <span class="s1">&#39;base64&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="c1"># נפילה לבינארי אם כשל פענוח</span>
                        <span class="n">b64</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
                        <span class="n">blob</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">create_git_blob</span><span class="p">(</span><span class="n">b64</span><span class="p">,</span> <span class="s1">&#39;base64&#39;</span><span class="p">)</span>
                    <span class="n">elem</span> <span class="o">=</span> <span class="n">InputGitTreeElement</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;100644&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;blob&#39;</span><span class="p">,</span> <span class="n">sha</span><span class="o">=</span><span class="n">blob</span><span class="o">.</span><span class="n">sha</span><span class="p">)</span>
                    <span class="n">new_tree_elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">purge_first</span><span class="p">:</span>
                    <span class="c1"># Soft purge: יצירת עץ חדש ללא בסיס (מוחק קבצים שאינם ב-ZIP)</span>
                    <span class="n">new_tree</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">create_git_tree</span><span class="p">(</span><span class="n">new_tree_elements</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_tree</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">create_git_tree</span><span class="p">(</span><span class="n">new_tree_elements</span><span class="p">,</span> <span class="n">base_tree</span><span class="p">)</span>
                <span class="n">commit_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Restore from ZIP via bot: replace </span><span class="si">{</span><span class="s1">&#39;with purge&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">purge_first</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;update only&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">new_commit</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">create_git_commit</span><span class="p">(</span><span class="n">commit_message</span><span class="p">,</span> <span class="n">new_tree</span><span class="p">,</span> <span class="p">[</span><span class="n">base_commit</span><span class="p">])</span>
                <span class="n">base_ref</span><span class="o">.</span><span class="n">edit</span><span class="p">(</span><span class="n">new_commit</span><span class="o">.</span><span class="n">sha</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[restore_zip] Restore commit created: </span><span class="si">{</span><span class="n">new_commit</span><span class="o">.</span><span class="n">sha</span><span class="si">}</span><span class="s2">, files_added=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">new_tree_elements</span><span class="p">)</span><span class="si">}</span><span class="s2">, purge=</span><span class="si">{</span><span class="n">purge_first</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;✅ השחזור הועלה לריפו בהצלחה&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;GitHub restore-to-repo failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה בשחזור לריפו: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># התראת OOM לאדמין אם מזוהה חריגת זיכרון</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="ne">MemoryError</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;Ran out of memory&#39;</span> <span class="ow">in</span> <span class="n">msg</span> <span class="ow">or</span> <span class="s1">&#39;out of memory&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                        <span class="k">await</span> <span class="n">notify_admins</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;🚨 OOM בשחזור ZIP לריפו: </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;upload_mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;github_restore_zip_purge&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;zip_restore_expected_repo_full&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">return</span>
        
        <span class="c1"># יצירת ריפו חדש מ‑ZIP (פריסה לתוך ריפו חדש)</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;upload_mode&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;github_create_repo_from_zip&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">document</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">document</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;GitHub create-repo-from-zip received: file_name=</span><span class="si">{</span><span class="n">document</span><span class="o">.</span><span class="n">file_name</span><span class="si">}</span><span class="s2">, size=</span><span class="si">{</span><span class="n">document</span><span class="o">.</span><span class="n">file_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;⏳ מוריד קובץ ZIP...&quot;</span><span class="p">)</span>
                <span class="n">tg_file</span> <span class="o">=</span> <span class="k">await</span> <span class="n">context</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="n">document</span><span class="o">.</span><span class="n">file_id</span><span class="p">)</span>
                <span class="n">buf</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
                <span class="k">await</span> <span class="n">tg_file</span><span class="o">.</span><span class="n">download_to_memory</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
                <span class="n">buf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="kn">import</span> <span class="nn">zipfile</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">os</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">is_zipfile</span><span class="p">(</span><span class="n">buf</span><span class="p">):</span>
                    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;❌ הקובץ שהועלה אינו ZIP תקין.&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="c1"># חלץ שמות ובחר שם בסיס לריפו אם לא הוזן מראש</span>
                <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zf</span><span class="p">:</span>
                    <span class="n">names_all</span> <span class="o">=</span> <span class="n">zf</span><span class="o">.</span><span class="n">namelist</span><span class="p">()</span>
                    <span class="n">file_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names_all</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">n</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;__MACOSX/&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">n</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;._&#39;</span><span class="p">)]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">file_names</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;❌ ה‑ZIP ריק.&quot;</span> <span class="p">)</span>
                        <span class="k">return</span>
                    <span class="c1"># גלה root משותף אם קיים</span>
                    <span class="n">top_levels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names_all</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">n</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;__MACOSX/&#39;</span><span class="p">):</span>
                            <span class="n">top_levels</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">common_root</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">top_levels</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">top_levels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="c1"># קבע שם ריפו</span>
                <span class="n">repo_name</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;new_repo_name&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">repo_name</span><span class="p">:</span>
                    <span class="n">base_guess</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">common_root</span><span class="p">:</span>
                        <span class="n">base_guess</span> <span class="o">=</span> <span class="n">common_root</span>
                    <span class="k">elif</span> <span class="n">document</span><span class="o">.</span><span class="n">file_name</span><span class="p">:</span>
                        <span class="n">base_guess</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">document</span><span class="o">.</span><span class="n">file_name</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">base_guess</span><span class="p">:</span>
                        <span class="n">base_guess</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;repo-</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="c1"># sanitize</span>
                    <span class="n">repo_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">base_guess</span><span class="p">)</span>
                    <span class="n">repo_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^A-Za-z0-9._-]&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">repo_name</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;.-_&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="sa">f</span><span class="s2">&quot;repo-</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="c1"># התחבר ל‑GitHub וצור ריפו</span>
                <span class="n">github_handler</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">bot_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;github_handler&#39;</span><span class="p">)</span>
                <span class="n">token</span> <span class="o">=</span> <span class="n">github_handler</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span> <span class="k">if</span> <span class="n">github_handler</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;❌ אין טוקן GitHub. שלח /github כדי להתחבר.&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📦 יוצר ריפו חדש: &lt;code&gt;</span><span class="si">{</span><span class="n">repo_name</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">)</span>
                <span class="kn">from</span> <span class="nn">github</span> <span class="kn">import</span> <span class="n">Github</span>
                <span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_user</span><span class="p">()</span>
                <span class="n">repo</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">create_repo</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">repo_name</span><span class="p">,</span>
                    <span class="n">private</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;new_repo_private&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)),</span>
                    <span class="n">auto_init</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>
                <span class="n">repo_full</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">full_name</span>
                <span class="c1"># שמור כריפו נבחר במסד ובסשן</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">save_selected_repo</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">repo_full</span><span class="p">)</span>
                    <span class="n">sess</span> <span class="o">=</span> <span class="n">github_handler</span><span class="o">.</span><span class="n">get_user_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                    <span class="n">sess</span><span class="p">[</span><span class="s1">&#39;selected_repo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">repo_full</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed saving selected repo: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># כעת פרוס את ה‑ZIP לריפו החדש ב‑commit אחד</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;📤 מעלה את קבצי ה‑ZIP לריפו החדש...&quot;</span><span class="p">)</span>
                <span class="c1"># קרא שוב את ה‑ZIP (ה‑buf הוזז קדימה)</span>
                <span class="n">buf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zf</span><span class="p">:</span>
                    <span class="n">names_all</span> <span class="o">=</span> <span class="n">zf</span><span class="o">.</span><span class="n">namelist</span><span class="p">()</span>
                    <span class="n">members</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names_all</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">n</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;__MACOSX/&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">n</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;._&#39;</span><span class="p">)]</span>
                    <span class="n">top_levels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names_all</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">n</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;__MACOSX/&#39;</span><span class="p">):</span>
                            <span class="n">top_levels</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">common_root</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">top_levels</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">top_levels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="k">def</span> <span class="nf">strip_root</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">common_root</span> <span class="ow">and</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">common_root</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">):</span> <span class="k">return</span> <span class="n">path</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">common_root</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
                        <span class="k">return</span> <span class="n">path</span>
                    <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">members</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">zf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                        <span class="n">clean</span> <span class="o">=</span> <span class="n">strip_root</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">clean</span><span class="p">:</span>
                            <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">clean</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
                <span class="c1"># העלאה: אם הריפו ריק לחלוטין, Git Data API עלול להחזיר 409. במקרה כזה נשתמש ב‑Contents API להעלאה קובץ‑קובץ.</span>
                <span class="kn">from</span> <span class="nn">github.GithubException</span> <span class="kn">import</span> <span class="n">GithubException</span>
                <span class="n">target_branch</span> <span class="o">=</span> <span class="p">(</span><span class="n">repo</span><span class="o">.</span><span class="n">default_branch</span> <span class="ow">or</span> <span class="s1">&#39;main&#39;</span><span class="p">)</span>
                <span class="n">base_ref</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">base_commit</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">base_tree</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">base_ref</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_git_ref</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;heads/</span><span class="si">{</span><span class="n">target_branch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">base_commit</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_git_commit</span><span class="p">(</span><span class="n">base_ref</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">sha</span><span class="p">)</span>
                    <span class="n">base_tree</span> <span class="o">=</span> <span class="n">base_commit</span><span class="o">.</span><span class="n">tree</span>
                <span class="k">except</span> <span class="n">GithubException</span> <span class="k">as</span> <span class="n">_e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No base ref found for new repo (expected for empty repo): </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">_e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">base_commit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># ריפו ריק: נעלה קבצים באמצעות Contents API (commit לכל קובץ)</span>
                    <span class="n">created_count</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">raw</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">text</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                                <span class="n">repo</span><span class="o">.</span><span class="n">create_file</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Initial import from ZIP via bot&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">text</span><span class="p">,</span> <span class="n">branch</span><span class="o">=</span><span class="n">target_branch</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
                                <span class="c1"># תוכן בינארי – שלח כ-bytes; PyGithub ידאג לקידוד Base64</span>
                                <span class="n">repo</span><span class="o">.</span><span class="n">create_file</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Initial import from ZIP via bot (binary)&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">raw</span><span class="p">,</span> <span class="n">branch</span><span class="o">=</span><span class="n">target_branch</span><span class="p">)</span>
                            <span class="n">created_count</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e_file</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;[create_repo_from_zip] Failed to create file </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e_file</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;✅ נוצר ריפו חדש והוזנו </span><span class="si">{</span><span class="n">created_count</span><span class="si">}</span><span class="s2"> קבצים</span><span class="se">\n</span><span class="s2">🔗 &lt;a href=</span><span class="se">\&quot;</span><span class="s2">https://github.com/</span><span class="si">{</span><span class="n">repo_full</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&gt;</span><span class="si">{</span><span class="n">repo_full</span><span class="si">}</span><span class="s2">&lt;/a&gt;&quot;</span><span class="p">,</span>
                        <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span>
                    <span class="p">)</span>
                    <span class="k">return</span>

                <span class="c1"># אחרת: יש commit בסיס – נשתמש ב‑Git Trees API לביצוע commit מרוכז אחד</span>
                <span class="kn">from</span> <span class="nn">github.InputGitTreeElement</span> <span class="kn">import</span> <span class="n">InputGitTreeElement</span>
                <span class="kn">import</span> <span class="nn">base64</span>
                <span class="n">text_exts</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;.md&#39;</span><span class="p">,</span> <span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;.json&#39;</span><span class="p">,</span> <span class="s1">&#39;.yml&#39;</span><span class="p">,</span> <span class="s1">&#39;.yaml&#39;</span><span class="p">,</span> <span class="s1">&#39;.xml&#39;</span><span class="p">,</span> <span class="s1">&#39;.py&#39;</span><span class="p">,</span> <span class="s1">&#39;.js&#39;</span><span class="p">,</span> <span class="s1">&#39;.ts&#39;</span><span class="p">,</span> <span class="s1">&#39;.tsx&#39;</span><span class="p">,</span> <span class="s1">&#39;.css&#39;</span><span class="p">,</span> <span class="s1">&#39;.scss&#39;</span><span class="p">,</span> <span class="s1">&#39;.html&#39;</span><span class="p">,</span> <span class="s1">&#39;.sh&#39;</span><span class="p">,</span> <span class="s1">&#39;.gitignore&#39;</span><span class="p">)</span>
                <span class="n">new_tree_elems</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">raw</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">text_exts</span><span class="p">):</span>
                            <span class="n">blob</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">create_git_blob</span><span class="p">(</span><span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">blob</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">create_git_blob</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">),</span> <span class="s1">&#39;base64&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">blob</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">create_git_blob</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">),</span> <span class="s1">&#39;base64&#39;</span><span class="p">)</span>
                    <span class="n">new_tree_elems</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InputGitTreeElement</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;100644&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;blob&#39;</span><span class="p">,</span> <span class="n">sha</span><span class="o">=</span><span class="n">blob</span><span class="o">.</span><span class="n">sha</span><span class="p">))</span>
                <span class="n">new_tree</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">create_git_tree</span><span class="p">(</span><span class="n">new_tree_elems</span><span class="p">,</span> <span class="n">base_tree</span><span class="p">)</span>
                <span class="n">commit_message</span> <span class="o">=</span> <span class="s2">&quot;Initial import from ZIP via bot&quot;</span>
                <span class="n">parents</span> <span class="o">=</span> <span class="p">[</span><span class="n">base_commit</span><span class="p">]</span>
                <span class="n">new_commit</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">create_git_commit</span><span class="p">(</span><span class="n">commit_message</span><span class="p">,</span> <span class="n">new_tree</span><span class="p">,</span> <span class="n">parents</span><span class="p">)</span>
                <span class="n">base_ref</span><span class="o">.</span><span class="n">edit</span><span class="p">(</span><span class="n">new_commit</span><span class="o">.</span><span class="n">sha</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;✅ נוצר ריפו חדש והוזנו </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">new_tree_elems</span><span class="p">)</span><span class="si">}</span><span class="s2"> קבצים</span><span class="se">\n</span><span class="s2">🔗 &lt;a href=</span><span class="se">\&quot;</span><span class="s2">https://github.com/</span><span class="si">{</span><span class="n">repo_full</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&gt;</span><span class="si">{</span><span class="n">repo_full</span><span class="si">}</span><span class="s2">&lt;/a&gt;&quot;</span><span class="p">,</span>
                    <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Create new repo from ZIP failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה ביצירת ריפו מ‑ZIP: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># התראת OOM לאדמין אם מזוהה חריגת זיכרון</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="ne">MemoryError</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;Ran out of memory&#39;</span> <span class="ow">in</span> <span class="n">msg</span> <span class="ow">or</span> <span class="s1">&#39;out of memory&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                        <span class="k">await</span> <span class="n">notify_admins</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;🚨 OOM ביצירת ריפו מ‑ZIP: </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="c1"># נקה דגלי זרימה</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;upload_mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;new_repo_name&#39;</span><span class="p">,</span> <span class="s1">&#39;new_repo_private&#39;</span><span class="p">):</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># בדוק אם אנחנו במצב העלאה לגיטהאב (תמיכה בשני המשתנים)</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;waiting_for_github_upload&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;upload_mode&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;github&#39;</span><span class="p">:</span>
            <span class="c1"># נהל את ההעלאה ישירות דרך מנהל GitHub כדי לא לאבד את האירוע</span>
            <span class="n">github_handler</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">bot_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;github_handler&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">github_handler</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">github_handler</span><span class="o">.</span><span class="n">handle_file_upload</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># ייבוא ZIP ראשוני (ללא מחיקה): קבלת ZIP ושמירה כקבצים עם תגית ריפו אם קיימת</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;upload_mode&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;zip_import&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">document</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">document</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ZIP import received: file_name=</span><span class="si">{</span><span class="n">document</span><span class="o">.</span><span class="n">file_name</span><span class="si">}</span><span class="s2">, mime_type=</span><span class="si">{</span><span class="n">document</span><span class="o">.</span><span class="n">mime_type</span><span class="si">}</span><span class="s2">, size=</span><span class="si">{</span><span class="n">document</span><span class="o">.</span><span class="n">file_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;⏳ מוריד קובץ ZIP...&quot;</span><span class="p">)</span>
                <span class="n">file</span> <span class="o">=</span> <span class="k">await</span> <span class="n">context</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="n">document</span><span class="o">.</span><span class="n">file_id</span><span class="p">)</span>
                <span class="n">buf</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
                <span class="k">await</span> <span class="n">file</span><span class="o">.</span><span class="n">download_to_memory</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
                <span class="n">buf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="c1"># שמור זמנית לדיסק</span>
                <span class="kn">import</span> <span class="nn">tempfile</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">zipfile</span>
                <span class="n">tmp_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">gettempdir</span><span class="p">()</span>
                <span class="n">safe_name</span> <span class="o">=</span> <span class="p">(</span><span class="n">document</span><span class="o">.</span><span class="n">file_name</span> <span class="ow">or</span> <span class="s1">&#39;repo.zip&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">safe_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.zip&#39;</span><span class="p">):</span>
                    <span class="n">safe_name</span> <span class="o">+=</span> <span class="s1">&#39;.zip&#39;</span>
                <span class="n">tmp_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">safe_name</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buf</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
                <span class="c1"># בדיקת ZIP תקין</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">is_zipfile</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Uploaded file is not a valid ZIP: </span><span class="si">{</span><span class="n">tmp_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;❌ הקובץ שהועלה אינו ZIP תקין.&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="c1"># נסה לקרוא metadata כדי לצרף תגית repo</span>
                <span class="kn">import</span> <span class="nn">json</span><span class="o">,</span> <span class="nn">re</span>
                <span class="n">repo_tag</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1"># 1) נסה metadata.json כפי שמיוצר ע&quot;י זרימות הבוט</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zf</span><span class="p">:</span>
                        <span class="n">md</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">zf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;metadata.json&#39;</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">md</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;repo&#39;</span><span class="p">):</span>
                            <span class="n">repo_tag</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;repo:</span><span class="si">{</span><span class="n">md</span><span class="p">[</span><span class="s1">&#39;repo&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">repo_tag</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1"># 2) אם אין מטאדטה: נסה לגלות owner/name מתוך תיקיית השורש של GitHub ZIP או שם הקובץ</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">repo_tag</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">def</span> <span class="nf">_parse_repo_full_from_label</span><span class="p">(</span><span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">label</span><span class="p">:</span>
                                <span class="k">return</span> <span class="s2">&quot;&quot;</span>
                            <span class="c1"># נקה סיומות ונתיבים</span>
                            <span class="n">base</span> <span class="o">=</span> <span class="n">label</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="n">base</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\.zip$&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
                            <span class="c1"># פענוח תבנית GitHub: owner-repo-&lt;branch|sha&gt;</span>
                            <span class="n">parts</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">base</span> <span class="k">else</span> <span class="p">[</span><span class="n">base</span><span class="p">]</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                                <span class="k">return</span> <span class="s2">&quot;&quot;</span>
                            <span class="n">owner</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="c1"># הסר סיומות נפוצות של branch/sha</span>
                            <span class="n">tail</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                            <span class="k">while</span> <span class="n">tail</span><span class="p">:</span>
                                <span class="n">last</span> <span class="o">=</span> <span class="n">tail</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                                <span class="n">is_sha</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">fullmatch</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[0-9a-fA-F]{7,40}&quot;</span><span class="p">,</span> <span class="n">last</span><span class="p">))</span>
                                <span class="n">is_branch_hint</span> <span class="o">=</span> <span class="n">last</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;master&quot;</span><span class="p">,</span> <span class="s2">&quot;develop&quot;</span><span class="p">,</span> <span class="s2">&quot;dev&quot;</span><span class="p">,</span> <span class="s2">&quot;release&quot;</span><span class="p">}</span>
                                <span class="k">if</span> <span class="n">is_sha</span> <span class="ow">or</span> <span class="n">is_branch_hint</span><span class="p">:</span>
                                    <span class="n">tail</span> <span class="o">=</span> <span class="n">tail</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">break</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">tail</span><span class="p">:</span>
                                <span class="k">return</span> <span class="s2">&quot;&quot;</span>
                            <span class="n">repo_name</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tail</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">owner</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">repo_name</span><span class="p">:</span>
                                <span class="k">return</span> <span class="s2">&quot;&quot;</span>
                            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">owner</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">repo_name</span><span class="si">}</span><span class="s2">&quot;</span>

                        <span class="n">guessed_full</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                        <span class="c1"># מתוך תיקיית השורש של ה‑ZIP (GitHub שם שם יחיד לרוב)</span>
                        <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zf</span><span class="p">:</span>
                            <span class="n">all_names</span> <span class="o">=</span> <span class="n">zf</span><span class="o">.</span><span class="n">namelist</span><span class="p">()</span>
                            <span class="n">top_levels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">all_names</span><span class="p">:</span>
                                <span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">n</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;__MACOSX/&#39;</span><span class="p">):</span>
                                    <span class="n">top_levels</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="n">common_root</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">top_levels</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">top_levels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="kc">None</span>
                        <span class="k">if</span> <span class="n">common_root</span><span class="p">:</span>
                            <span class="n">guessed_full</span> <span class="o">=</span> <span class="n">_parse_repo_full_from_label</span><span class="p">(</span><span class="n">common_root</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">guessed_full</span> <span class="ow">and</span> <span class="n">safe_name</span><span class="p">:</span>
                            <span class="n">name_wo_ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">safe_name</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">guessed_full</span> <span class="o">=</span> <span class="n">_parse_repo_full_from_label</span><span class="p">(</span><span class="n">name_wo_ext</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">guessed_full</span><span class="p">:</span>
                            <span class="n">repo_tag</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;repo:</span><span class="si">{</span><span class="n">guessed_full</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">repo_tag</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1"># בצע ייבוא ללא מחיקה, עם תגיות אם קיימות</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">backup_manager</span><span class="o">.</span><span class="n">restore_from_backup</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">backup_path</span><span class="o">=</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">purge</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">extra_tags</span><span class="o">=</span><span class="n">repo_tag</span><span class="p">)</span>
                <span class="n">restored</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;restored_files&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">errors</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;errors&#39;</span><span class="p">,</span> <span class="p">[])</span>
                <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
                    <span class="c1"># הצג תקציר שגיאות כדי לעזור באבחון</span>
                    <span class="n">preview</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">[:</span><span class="mi">3</span><span class="p">]])</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;⚠️ הייבוא הושלם חלקית: </span><span class="si">{</span><span class="n">restored</span><span class="si">}</span><span class="s2"> קבצים נשמרו</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;שגיאות: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;דוגמאות:</span><span class="se">\n</span><span class="si">{</span><span class="n">preview</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;✅ יובאו </span><span class="si">{</span><span class="n">restored</span><span class="si">}</span><span class="s2"> קבצים בהצלחה&quot;</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ZIP import failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה בייבוא ZIP: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;upload_mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span>

        <span class="c1"># מצב איסוף קבצים ליצירת ZIP מקומי</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;upload_mode&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;zip_create&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">document</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">document</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ZIP create mode: received file for bundle: </span><span class="si">{</span><span class="n">document</span><span class="o">.</span><span class="n">file_name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">document</span><span class="o">.</span><span class="n">file_size</span><span class="si">}</span><span class="s2"> bytes)&quot;</span><span class="p">)</span>
                <span class="c1"># הורדה לזיכרון</span>
                <span class="n">file</span> <span class="o">=</span> <span class="k">await</span> <span class="n">context</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="n">document</span><span class="o">.</span><span class="n">file_id</span><span class="p">)</span>
                <span class="n">buf</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
                <span class="k">await</span> <span class="n">file</span><span class="o">.</span><span class="n">download_to_memory</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
                <span class="n">raw</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
                <span class="c1"># שמירה לרשימת הפריטים בסשן</span>
                <span class="n">items</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;zip_create_items&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">items</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;zip_create_items&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">items</span>
                <span class="c1"># קביעת שם בטוח</span>
                <span class="n">safe_name</span> <span class="o">=</span> <span class="p">(</span><span class="n">document</span><span class="o">.</span><span class="n">file_name</span> <span class="ow">or</span> <span class="sa">f</span><span class="s2">&quot;file_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="sa">f</span><span class="s2">&quot;file_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="n">safe_name</span><span class="p">,</span>
                    <span class="s1">&#39;bytes&#39;</span><span class="p">:</span> <span class="n">raw</span><span class="p">,</span>
                <span class="p">})</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ נוסף: &lt;code&gt;</span><span class="si">{</span><span class="n">html_escape</span><span class="p">(</span><span class="n">safe_name</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/code&gt; (סה&quot;&quot;כ {len(items)} קבצים)&quot;</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;zip_create collect failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה בהוספת הקובץ ל‑ZIP: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="k">await</span> <span class="n">log_user_activity</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">document</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">document</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
            
            <span class="c1"># בדיקת גודל הקובץ (עד 20MB)</span>
            <span class="k">if</span> <span class="n">document</span><span class="o">.</span><span class="n">file_size</span> <span class="o">&gt;</span> <span class="mi">20</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                    <span class="s2">&quot;❌ הקובץ גדול מדי!</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;📏 הגודל המקסימלי המותר הוא 20MB&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>
            
            <span class="c1"># הורדת הקובץ</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;⏳ מוריד את הקובץ...&quot;</span><span class="p">)</span>
            <span class="n">file</span> <span class="o">=</span> <span class="k">await</span> <span class="n">context</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="n">document</span><span class="o">.</span><span class="n">file_id</span><span class="p">)</span>
            
            <span class="c1"># קריאת התוכן</span>
            <span class="n">file_bytes</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
            <span class="k">await</span> <span class="n">file</span><span class="o">.</span><span class="n">download_to_memory</span><span class="p">(</span><span class="n">file_bytes</span><span class="p">)</span>
            <span class="n">file_bytes</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            
            <span class="c1"># ניסיון לקרוא את הקובץ בקידודים שונים</span>
            <span class="n">content</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">detected_encoding</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">encodings_to_try</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="s1">&#39;windows-1255&#39;</span><span class="p">,</span> <span class="s1">&#39;iso-8859-8&#39;</span><span class="p">,</span> <span class="s1">&#39;cp1255&#39;</span><span class="p">,</span> <span class="s1">&#39;utf-16&#39;</span><span class="p">,</span> <span class="s1">&#39;latin-1&#39;</span><span class="p">]</span>
            
            <span class="c1"># לוג פרטי הקובץ</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📄 קובץ נשלח: </span><span class="si">{</span><span class="n">document</span><span class="o">.</span><span class="n">file_name</span><span class="si">}</span><span class="s2">, גודל: </span><span class="si">{</span><span class="n">document</span><span class="o">.</span><span class="n">file_size</span><span class="si">}</span><span class="s2"> bytes&quot;</span><span class="p">)</span>
            
            <span class="c1"># קרא את הבייטים</span>
            <span class="n">raw_bytes</span> <span class="o">=</span> <span class="n">file_bytes</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">file_size_bytes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw_bytes</span><span class="p">)</span>
            
            <span class="c1"># אם הקובץ הוא ZIP (גם אם הועלה &quot;סתם&quot; במסלול קבצים), נשמור עותק לתיקיית ה-ZIP השמורים</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">zipfile</span> <span class="k">as</span> <span class="nn">_zip</span>
                <span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span> <span class="k">as</span> <span class="n">_BytesIO</span>
                <span class="n">is_zip_hint</span> <span class="o">=</span> <span class="p">((</span><span class="n">document</span><span class="o">.</span><span class="n">mime_type</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;application/zip&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">((</span><span class="n">document</span><span class="o">.</span><span class="n">file_name</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.zip&#39;</span><span class="p">))</span>
                <span class="n">is_zip_actual</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">is_zip_actual</span> <span class="o">=</span> <span class="n">_zip</span><span class="o">.</span><span class="n">is_zipfile</span><span class="p">(</span><span class="n">_BytesIO</span><span class="p">(</span><span class="n">raw_bytes</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">is_zip_actual</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">is_zip_hint</span> <span class="ow">and</span> <span class="n">is_zip_actual</span><span class="p">:</span>
                    <span class="n">backup_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;upload_</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">target_path</span> <span class="o">=</span> <span class="n">backup_manager</span><span class="o">.</span><span class="n">backup_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">backup_id</span><span class="si">}</span><span class="s2">.zip&quot;</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># הוסף metadata.json בסיסי (אם חסר) ושמור בהתאם לאחסון (Mongo/FS)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># נסה לפתוח את ה-ZIP המקורי כדי לבדוק מטאדטה</span>
                            <span class="n">ztest</span> <span class="o">=</span> <span class="n">_zip</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">_BytesIO</span><span class="p">(</span><span class="n">raw_bytes</span><span class="p">))</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">ztest</span><span class="o">.</span><span class="n">getinfo</span><span class="p">(</span><span class="s1">&#39;metadata.json&#39;</span><span class="p">)</span>
                                <span class="c1"># כבר קיים metadata.json – נשמור כמו שהוא</span>
                                <span class="n">md_bytes</span> <span class="o">=</span> <span class="n">raw_bytes</span>
                            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                <span class="c1"># הזרקת מטאדטה</span>
                                <span class="n">md</span> <span class="o">=</span> <span class="p">{</span>
                                    <span class="s2">&quot;backup_id&quot;</span><span class="p">:</span> <span class="n">backup_id</span><span class="p">,</span>
                                    <span class="s2">&quot;backup_type&quot;</span><span class="p">:</span> <span class="s2">&quot;generic_zip&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
                                    <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                                    <span class="s2">&quot;original_filename&quot;</span><span class="p">:</span> <span class="n">document</span><span class="o">.</span><span class="n">file_name</span><span class="p">,</span>
                                    <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;uploaded_document&quot;</span>
                                <span class="p">}</span>
                                <span class="n">out_buf</span> <span class="o">=</span> <span class="n">_BytesIO</span><span class="p">()</span>
                                <span class="k">with</span> <span class="n">_zip</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">out_buf</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="n">_zip</span><span class="o">.</span><span class="n">ZIP_DEFLATED</span><span class="p">)</span> <span class="k">as</span> <span class="n">zout</span><span class="p">:</span>
                                    <span class="c1"># העתק את התוכן</span>
                                    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">ztest</span><span class="o">.</span><span class="n">namelist</span><span class="p">():</span>
                                        <span class="n">zout</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ztest</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
                                    <span class="n">zout</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="s1">&#39;metadata.json&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
                                <span class="n">md_bytes</span> <span class="o">=</span> <span class="n">out_buf</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="c1"># אם לא מצליחים לקרוא כ-ZIP, נשמור את הבייטים המקוריים</span>
                            <span class="n">md_bytes</span> <span class="o">=</span> <span class="n">raw_bytes</span>

                        <span class="c1"># שמירה לפי מצב האחסון</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">backup_manager</span><span class="o">.</span><span class="n">save_backup_bytes</span><span class="p">(</span><span class="n">md_bytes</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;backup_id&quot;</span><span class="p">:</span> <span class="n">backup_id</span><span class="p">,</span> <span class="s2">&quot;backup_type&quot;</span><span class="p">:</span> <span class="s2">&quot;generic_zip&quot;</span><span class="p">,</span> <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span> <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span> <span class="s2">&quot;original_filename&quot;</span><span class="p">:</span> <span class="n">document</span><span class="o">.</span><span class="n">file_name</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;uploaded_document&quot;</span><span class="p">})</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="c1"># נפילה לשמירה לדיסק כניסיון אחרון</span>
                            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">target_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fzip</span><span class="p">:</span>
                                <span class="n">fzip</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">md_bytes</span><span class="p">)</span>
                        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                            <span class="s2">&quot;✅ קובץ ZIP נשמר בהצלחה לרשימת ה‑ZIP השמורים.</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="s2">&quot;📦 ניתן למצוא אותו תחת: &#39;📚&#39; &gt; &#39;📦 קבצי ZIP&#39; או ב‑Batch/GitHub.&quot;</span><span class="p">)</span>
                        <span class="k">return</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to persist uploaded ZIP: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="c1"># המשך לזרימת קריאת טקסט הרגילה</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="c1"># נסה קידודים שונים</span>
            <span class="k">for</span> <span class="n">encoding</span> <span class="ow">in</span> <span class="n">encodings_to_try</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="n">raw_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
                    <span class="n">detected_encoding</span> <span class="o">=</span> <span class="n">encoding</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ הקובץ נקרא בהצלחה בקידוד: </span><span class="si">{</span><span class="n">encoding</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
                    <span class="k">continue</span>
            
            <span class="k">if</span> <span class="n">content</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ לא ניתן לקרוא את הקובץ באף קידוד: </span><span class="si">{</span><span class="n">encodings_to_try</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                    <span class="s2">&quot;❌ לא ניתן לקרוא את הקובץ!</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;📝 ניסיתי את הקידודים: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">encodings_to_try</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;💡 אנא ודא שזהו קובץ טקסט/קוד ולא קובץ בינארי&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>
            
            <span class="c1"># זיהוי שפת תכנות</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">file_name</span> <span class="ow">or</span> <span class="s2">&quot;untitled.txt&quot;</span>
            <span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">detect_language_from_filename</span>
            <span class="n">language</span> <span class="o">=</span> <span class="n">detect_language_from_filename</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
            
            <span class="c1"># בדיקה אם הקובץ גדול (מעל 4096 תווים)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4096</span><span class="p">:</span>
                <span class="c1"># שמירה כקובץ גדול</span>
                <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">LargeFile</span>
                <span class="n">large_file</span> <span class="o">=</span> <span class="n">LargeFile</span><span class="p">(</span>
                    <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
                    <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span>
                    <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>
                    <span class="n">programming_language</span><span class="o">=</span><span class="n">language</span><span class="p">,</span>
                    <span class="n">file_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)),</span>
                    <span class="n">lines_count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
                <span class="p">)</span>
                
                <span class="n">success</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">save_large_file</span><span class="p">(</span><span class="n">large_file</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                    <span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">get_language_emoji</span>
                    <span class="n">emoji</span> <span class="o">=</span> <span class="n">get_language_emoji</span><span class="p">(</span><span class="n">language</span><span class="p">)</span>
                    
                    <span class="c1"># שלוף את ה-ObjectId האחרון של הקובץ הגדול כדי לאפשר שיתוף</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="kn">from</span> <span class="nn">bson</span> <span class="kn">import</span> <span class="n">ObjectId</span>
                        <span class="c1"># נסה לאחזר לפי שם — הפונקציה של ה-repo לקבצים גדולים קיימת</span>
                        <span class="n">saved_large</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_large_file</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
                        <span class="n">fid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">saved_large</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">fid</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;👁️ הצג קוד&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;view_direct_id:</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">fid</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;view_direct_</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📚 הצג קבצים גדולים&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;show_large_files&quot;</span><span class="p">)],</span>
                        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔗 שתף קוד&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;share_menu_id:</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">fid</span> <span class="k">else</span> <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔗 שתף קוד&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;share_menu_id:&quot;</span><span class="p">)],</span>
                        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🏠 תפריט ראשי&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;main&quot;</span><span class="p">)]</span>
                    <span class="p">]</span>
                    <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
                    
                    <span class="n">lines_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
                    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;✅ **הקובץ נשמר בהצלחה!**</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;📄 **שם:** `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">`</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">emoji</span><span class="si">}</span><span class="s2"> **שפה:** </span><span class="si">{</span><span class="n">language</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;🔤 **קידוד:** </span><span class="si">{</span><span class="n">detected_encoding</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;💾 **גודל:** </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> תווים</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;📏 **שורות:** </span><span class="si">{</span><span class="n">lines_count</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;🎮 בחר פעולה מהכפתורים החכמים:&quot;</span><span class="p">,</span>
                        <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span><span class="p">,</span>
                        <span class="n">parse_mode</span><span class="o">=</span><span class="s1">&#39;Markdown&#39;</span>
                    <span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;last_save_success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s1">&#39;file_name&#39;</span><span class="p">:</span> <span class="n">file_name</span><span class="p">,</span>
                            <span class="s1">&#39;language&#39;</span><span class="p">:</span> <span class="n">language</span><span class="p">,</span>
                            <span class="s1">&#39;note&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;file_id&#39;</span><span class="p">:</span> <span class="n">fid</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;❌ שגיאה בשמירת הקובץ&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># שמירה כקובץ רגיל</span>
                <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">CodeSnippet</span>
                <span class="n">snippet</span> <span class="o">=</span> <span class="n">CodeSnippet</span><span class="p">(</span>
                    <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
                    <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span>
                    <span class="n">code</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>
                    <span class="n">programming_language</span><span class="o">=</span><span class="n">language</span>
                <span class="p">)</span>
                
                <span class="n">success</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">save_code_snippet</span><span class="p">(</span><span class="n">snippet</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                    <span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">get_language_emoji</span>
                    <span class="n">emoji</span> <span class="o">=</span> <span class="n">get_language_emoji</span><span class="p">(</span><span class="n">language</span><span class="p">)</span>
                    
                    <span class="c1"># שלוף את ה-ObjectId האחרון כדי לאפשר שיתוף</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">saved_doc</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
                        <span class="n">fid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">saved_doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">fid</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;👁️ הצג קוד&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;view_direct_id:</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">fid</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;view_direct_</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;✏️ ערוך&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;edit_code_direct_</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)],</span>
                        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📥 הורד&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;download_direct_</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📚 היסטוריה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;versions_file_</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)],</span>
                        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔗 שתף קוד&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;share_menu_id:</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">fid</span> <span class="k">else</span> <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔗 שתף קוד&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;share_menu_id:&quot;</span><span class="p">)],</span>
                        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📚 הצג את כל הקבצים&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;files&quot;</span><span class="p">)],</span>
                        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🏠 תפריט ראשי&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;main&quot;</span><span class="p">)]</span>
                    <span class="p">]</span>
                    <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
                    
                    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;✅ **הקובץ נשמר בהצלחה!**</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;📄 **שם:** `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">`</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">emoji</span><span class="si">}</span><span class="s2"> **שפה:** </span><span class="si">{</span><span class="n">language</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;🔤 **קידוד:** </span><span class="si">{</span><span class="n">detected_encoding</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;💾 **גודל:** </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="si">}</span><span class="s2"> תווים</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;🎮 בחר פעולה מהכפתורים החכמים:&quot;</span><span class="p">,</span>
                        <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span><span class="p">,</span>
                        <span class="n">parse_mode</span><span class="o">=</span><span class="s1">&#39;Markdown&#39;</span>
                    <span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;last_save_success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s1">&#39;file_name&#39;</span><span class="p">:</span> <span class="n">file_name</span><span class="p">,</span>
                            <span class="s1">&#39;language&#39;</span><span class="p">:</span> <span class="n">language</span><span class="p">,</span>
                            <span class="s1">&#39;note&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;file_id&#39;</span><span class="p">:</span> <span class="n">fid</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;❌ שגיאה בשמירת הקובץ&quot;</span><span class="p">)</span>
            
            <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;שגיאה בטיפול בקובץ: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;❌ שגיאה בעיבוד הקובץ&quot;</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="CodeKeeperBot.handle_text_message">
<a class="viewcode-back" href="../api/main.html#main.CodeKeeperBot.handle_text_message">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">handle_text_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;טיפול בהודעות טקסט (קוד פוטנציאלי)&quot;&quot;&quot;</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">log_user_activity</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">text</span>

        <span class="c1"># מצב חיפוש אינטראקטיבי (מופעל מהכפתור &quot;🔎 חפש קובץ&quot;)</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;awaiting_search_text&#39;</span><span class="p">):</span>
            <span class="n">query_text</span> <span class="o">=</span> <span class="p">(</span><span class="n">text</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;awaiting_search_text&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="c1"># פירוק שאילתא: תומך name:..., lang:..., tag:repo:...</span>
            <span class="n">name_substr</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">lang_filter</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">tag_filter</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">query_text</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
                    <span class="n">lower</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">lower</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;name:&#39;</span><span class="p">):</span>
                        <span class="n">name_substr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="n">lower</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;lang:&#39;</span><span class="p">):</span>
                        <span class="n">lang_filter</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="kc">None</span>
                    <span class="k">elif</span> <span class="n">lower</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;tag:&#39;</span><span class="p">):</span>
                        <span class="n">tag_filter</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="n">lower</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;repo:&#39;</span><span class="p">):</span>
                        <span class="n">tag_filter</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># מונחי חיפוש חופשיים בשם הקובץ</span>
                        <span class="n">name_substr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                <span class="n">name_filter</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">name_substr</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">name_filter</span> <span class="o">=</span> <span class="n">query_text</span>

            <span class="c1"># אחזור תוצאות</span>
            <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>
            <span class="c1"># נחפש בבסיס (כולל $text), ואז נסנן לפי שם קובץ אם הוגדר name_filter</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">search_code</span><span class="p">(</span>
                <span class="n">user_id</span><span class="p">,</span>
                <span class="n">query</span><span class="o">=</span><span class="n">name_filter</span> <span class="k">if</span> <span class="n">name_filter</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">programming_language</span><span class="o">=</span><span class="p">(</span><span class="n">lang_filter</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                <span class="n">tags</span><span class="o">=</span><span class="p">([</span><span class="n">tag_filter</span><span class="p">]</span> <span class="k">if</span> <span class="n">tag_filter</span> <span class="k">else</span> <span class="p">[]),</span>
                <span class="n">limit</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
            <span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
            <span class="c1"># סינון לפי שם קובץ אם יש name_filter</span>
            <span class="k">if</span> <span class="n">name_filter</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">nf</span> <span class="o">=</span> <span class="n">name_filter</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="n">nf</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">total</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                    <span class="s2">&quot;🔎 לא נמצאו תוצאות.&quot;</span><span class="p">,</span>
                    <span class="n">reply_to_message_id</span><span class="o">=</span><span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">message_id</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="c1"># אפשר לאפשר חיפוש נוסף מיד</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;awaiting_search_text&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">return</span>

            <span class="c1"># שמירת פילטרים להמשך דפדוף</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;search_filters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;name_filter&#39;</span><span class="p">:</span> <span class="n">name_filter</span><span class="p">,</span>
                <span class="s1">&#39;lang&#39;</span><span class="p">:</span> <span class="n">lang_filter</span><span class="p">,</span>
                <span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="n">tag_filter</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;files_origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;search&#39;</span> <span class="p">}</span>

            <span class="c1"># בניית עמוד ראשון</span>
            <span class="n">PAGE_SIZE</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="n">page</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;files_last_page&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span>
            <span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span>
            <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">total</span><span class="p">)</span>

            <span class="c1"># בניית מקלדת תוצאות</span>
            <span class="kn">from</span> <span class="nn">telegram</span> <span class="kn">import</span> <span class="n">InlineKeyboardMarkup</span><span class="p">,</span> <span class="n">InlineKeyboardButton</span>
            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;files_cache&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span> <span class="s1">&#39;קובץ&#39;</span><span class="p">)</span>
                <span class="n">lang</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;programming_language&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">)</span>
                <span class="n">button_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;📄 </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">lang</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">button_text</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;file_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;files_cache&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">item</span>

            <span class="c1"># עימוד</span>
            <span class="n">total_pages</span> <span class="o">=</span> <span class="p">(</span><span class="n">total</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">PAGE_SIZE</span> <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="n">row</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">page</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;⬅️ הקודם&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;search_page_</span><span class="si">{</span><span class="n">page</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">page</span> <span class="o">&lt;</span> <span class="n">total_pages</span><span class="p">:</span>
                <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;➡️ הבא&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;search_page_</span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">:</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזרה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;files&quot;</span><span class="p">)])</span>

            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;🔎 תוצאות חיפוש — סה״כ: </span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                <span class="sa">f</span><span class="s2">&quot;📄 עמוד </span><span class="si">{</span><span class="n">page</span><span class="si">}</span><span class="s2"> מתוך </span><span class="si">{</span><span class="n">total_pages</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># ביטול חד-פעמי של הודעת &quot;נראה שזה קטע קוד!&quot; (למשל אחרי שמירת הערה לגיבוי)</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;suppress_code_hint_once&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">return</span>
        
        <span class="c1"># בדיקה אם המשתמש בתהליך שמירה</span>
        <span class="k">if</span> <span class="s1">&#39;saving_file&#39;</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_code_snippet</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># זיהוי אם זה נראה כמו קוד, למעט בזמן זרימת &quot;הדבק קוד&quot; של GitHub</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_looks_like_code</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;waiting_for_paste_content&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;waiting_for_paste_filename&#39;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;🤔 נראה שזה קטע קוד!</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;רוצה לשמור אותו? השתמש ב/save או שלח שוב עם שם קובץ.&quot;</span><span class="p">,</span>
                <span class="n">reply_to_message_id</span><span class="o">=</span><span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">message_id</span>
            <span class="p">)</span>
        <span class="c1"># שלב ביניים לקליטת הערה אחרי קוד</span>
        <span class="k">elif</span> <span class="s1">&#39;saving_file&#39;</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span> <span class="ow">and</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;saving_file&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;note_asked&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;pending_code_buffer&#39;</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">:</span>
            <span class="n">note_text</span> <span class="o">=</span> <span class="p">(</span><span class="n">text</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">note_text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;דלג&quot;</span><span class="p">,</span> <span class="s2">&quot;skip&quot;</span><span class="p">,</span> <span class="s2">&quot;ללא&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">}:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;saving_file&#39;</span><span class="p">][</span><span class="s1">&#39;note_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># הגבלת אורך הערה</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;saving_file&#39;</span><span class="p">][</span><span class="s1">&#39;note_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">note_text</span><span class="p">[:</span><span class="mi">280</span><span class="p">]</span>
            <span class="c1"># קרא שוב לשמירה בפועל (תדלג על השאלה כי note_asked=true)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_code_snippet</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pending_code_buffer&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span></div>

    
    <span class="k">async</span> <span class="k">def</span> <span class="nf">_save_code_snippet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;שמירה בפועל של קטע קוד&quot;&quot;&quot;</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">saving_data</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;saving_file&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">config</span><span class="o">.</span><span class="n">MAX_CODE_SIZE</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;❌ הקוד גדול מדי! מקסימום </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">MAX_CODE_SIZE</span><span class="si">}</span><span class="s2"> תווים.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># זיהוי שפת התכנות באמצעות CodeProcessor</span>
        <span class="n">detected_language</span> <span class="o">=</span> <span class="n">code_processor</span><span class="o">.</span><span class="n">detect_language</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">saving_data</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">])</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;זוהתה שפה: </span><span class="si">{</span><span class="n">detected_language</span><span class="si">}</span><span class="s2"> עבור הקובץ </span><span class="si">{</span><span class="n">saving_data</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># אם טרם נשמרה הערה, נשאל כעת</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">saving_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;note_asked&#39;</span><span class="p">):</span>
            <span class="n">saving_data</span><span class="p">[</span><span class="s1">&#39;note_asked&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;saving_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">saving_data</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;pending_code_buffer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">code</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;📝 רוצה להוסיף הערה קצרה לקובץ?</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;כתוב/כתבי אותה עכשיו או שלח/י &#39;דלג&#39; כדי לשמור בלי הערה.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># שלב שני: כבר נשאלה הערה, בדוק אם התקבלה</span>
        <span class="n">note</span> <span class="o">=</span> <span class="n">saving_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;note_value&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;pending_code_buffer&#39;</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;pending_code_buffer&#39;</span><span class="p">)</span>

        <span class="c1"># יצירת אובייקט קטע קוד כולל הערה (description)</span>
        <span class="n">snippet</span> <span class="o">=</span> <span class="n">CodeSnippet</span><span class="p">(</span>
            <span class="n">user_id</span><span class="o">=</span><span class="n">saving_data</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">],</span>
            <span class="n">file_name</span><span class="o">=</span><span class="n">saving_data</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">],</span>
            <span class="n">code</span><span class="o">=</span><span class="n">code</span><span class="p">,</span>
            <span class="n">programming_language</span><span class="o">=</span><span class="n">detected_language</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="n">note</span><span class="p">,</span>
            <span class="n">tags</span><span class="o">=</span><span class="n">saving_data</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        
        <span class="c1"># שמירה במסד הנתונים</span>
        <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">save_code_snippet</span><span class="p">(</span><span class="n">snippet</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;✅ נשמר בהצלחה!</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;📁 **</span><span class="si">{</span><span class="n">saving_data</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">**</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;🔤 שפה: </span><span class="si">{</span><span class="n">detected_language</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;🏷️ תגיות: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">saving_data</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">])</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">saving_data</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;ללא&#39;</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;📝 הערה: </span><span class="si">{</span><span class="n">note</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;—&#39;</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;📊 גודל: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">)</span><span class="si">}</span><span class="s2"> תווים&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;❌ שגיאה בשמירה. נסה שוב מאוחר יותר.&quot;</span>
            <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_looks_like_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;בדיקה פשוטה אם טקסט נראה כמו קוד&quot;&quot;&quot;</span>
        <span class="n">code_indicators</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;def &#39;</span><span class="p">,</span> <span class="s1">&#39;function &#39;</span><span class="p">,</span> <span class="s1">&#39;class &#39;</span><span class="p">,</span> <span class="s1">&#39;import &#39;</span><span class="p">,</span> <span class="s1">&#39;from &#39;</span><span class="p">,</span>
            <span class="s1">&#39;){&#39;</span><span class="p">,</span> <span class="s1">&#39;};&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;?php&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;html&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;script&#39;</span><span class="p">,</span> <span class="s1">&#39;SELECT &#39;</span><span class="p">,</span> <span class="s1">&#39;CREATE TABLE&#39;</span>
        <span class="p">]</span>
        
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">indicator</span> <span class="ow">in</span> <span class="n">text</span> <span class="k">for</span> <span class="n">indicator</span> <span class="ow">in</span> <span class="n">code_indicators</span><span class="p">)</span> <span class="ow">or</span> \
               <span class="n">text</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">text</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
    
    <span class="k">def</span> <span class="nf">_detect_language</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;זיהוי בסיסי של שפת תכנות (יורחב בעתיד)&quot;&quot;&quot;</span>
        <span class="c1"># זיהוי לפי סיומת קובץ</span>
        <span class="n">extension_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;.py&#39;</span><span class="p">:</span> <span class="s1">&#39;python&#39;</span><span class="p">,</span>
            <span class="s1">&#39;.js&#39;</span><span class="p">:</span> <span class="s1">&#39;javascript&#39;</span><span class="p">,</span>
            <span class="s1">&#39;.html&#39;</span><span class="p">:</span> <span class="s1">&#39;html&#39;</span><span class="p">,</span>
            <span class="s1">&#39;.css&#39;</span><span class="p">:</span> <span class="s1">&#39;css&#39;</span><span class="p">,</span>
            <span class="s1">&#39;.java&#39;</span><span class="p">:</span> <span class="s1">&#39;java&#39;</span><span class="p">,</span>
            <span class="s1">&#39;.cpp&#39;</span><span class="p">:</span> <span class="s1">&#39;cpp&#39;</span><span class="p">,</span>
            <span class="s1">&#39;.c&#39;</span><span class="p">:</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span>
            <span class="s1">&#39;.php&#39;</span><span class="p">:</span> <span class="s1">&#39;php&#39;</span><span class="p">,</span>
            <span class="s1">&#39;.rb&#39;</span><span class="p">:</span> <span class="s1">&#39;ruby&#39;</span><span class="p">,</span>
            <span class="s1">&#39;.go&#39;</span><span class="p">:</span> <span class="s1">&#39;go&#39;</span><span class="p">,</span>
            <span class="s1">&#39;.rs&#39;</span><span class="p">:</span> <span class="s1">&#39;rust&#39;</span><span class="p">,</span>
            <span class="s1">&#39;.ts&#39;</span><span class="p">:</span> <span class="s1">&#39;typescript&#39;</span><span class="p">,</span>
            <span class="s1">&#39;.sql&#39;</span><span class="p">:</span> <span class="s1">&#39;sql&#39;</span><span class="p">,</span>
            <span class="s1">&#39;.sh&#39;</span><span class="p">:</span> <span class="s1">&#39;bash&#39;</span><span class="p">,</span>
            <span class="s1">&#39;.json&#39;</span><span class="p">:</span> <span class="s1">&#39;json&#39;</span><span class="p">,</span>
            <span class="s1">&#39;.xml&#39;</span><span class="p">:</span> <span class="s1">&#39;xml&#39;</span><span class="p">,</span>
            <span class="s1">&#39;.yml&#39;</span><span class="p">:</span> <span class="s1">&#39;yaml&#39;</span><span class="p">,</span>
            <span class="s1">&#39;.yaml&#39;</span><span class="p">:</span> <span class="s1">&#39;yaml&#39;</span>
        <span class="p">}</span>
        
        <span class="k">for</span> <span class="n">ext</span><span class="p">,</span> <span class="n">lang</span> <span class="ow">in</span> <span class="n">extension_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">ext</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">lang</span>
        
        <span class="c1"># זיהוי בסיסי לפי תוכן</span>
        <span class="k">if</span> <span class="s1">&#39;def &#39;</span> <span class="ow">in</span> <span class="n">code</span> <span class="ow">or</span> <span class="s1">&#39;import &#39;</span> <span class="ow">in</span> <span class="n">code</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;python&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;function &#39;</span> <span class="ow">in</span> <span class="n">code</span> <span class="ow">or</span> <span class="s1">&#39;var &#39;</span> <span class="ow">in</span> <span class="n">code</span> <span class="ow">or</span> <span class="s1">&#39;let &#39;</span> <span class="ow">in</span> <span class="n">code</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;javascript&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;&lt;?php&#39;</span> <span class="ow">in</span> <span class="n">code</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;php&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;&lt;html&#39;</span> <span class="ow">in</span> <span class="n">code</span> <span class="ow">or</span> <span class="s1">&#39;&lt;!DOCTYPE&#39;</span> <span class="ow">in</span> <span class="n">code</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;html&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;SELECT &#39;</span> <span class="ow">in</span> <span class="n">code</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;CREATE TABLE&#39;</span> <span class="ow">in</span> <span class="n">code</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
            <span class="k">return</span> <span class="s1">&#39;sql&#39;</span>
        
        <span class="k">return</span> <span class="s1">&#39;text&#39;</span>  <span class="c1"># ברירת מחדל</span>
    
<div class="viewcode-block" id="CodeKeeperBot.error_handler">
<a class="viewcode-back" href="../api/main.html#main.CodeKeeperBot.error_handler">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">error_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;טיפול בשגיאות&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;שגיאה: </span><span class="si">{</span><span class="n">context</span><span class="o">.</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">error</span><span class="p">)</span>

        <span class="c1"># זיהוי חריגת זיכרון (גלובלי)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">error</span>
            <span class="n">err_text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="k">if</span> <span class="n">err</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="n">is_oom</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="ne">MemoryError</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">err_text</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                    <span class="s1">&#39;Ran out of memory&#39;</span> <span class="ow">in</span> <span class="n">err_text</span> <span class="ow">or</span> <span class="s1">&#39;out of memory&#39;</span> <span class="ow">in</span> <span class="n">err_text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;MemoryError&#39;</span> <span class="ow">in</span> <span class="n">err_text</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">is_oom</span><span class="p">:</span>
                <span class="c1"># נסה לצרף סטטוס זיכרון</span>
                <span class="n">mem_status</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">get_memory_usage</span>  <span class="c1"># import מקומי למניעת תלות בזמן בדיקות</span>
                    <span class="n">mu</span> <span class="o">=</span> <span class="n">get_memory_usage</span><span class="p">()</span>
                    <span class="n">mem_status</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; (RSS=</span><span class="si">{</span><span class="n">mu</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rss_mb&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">MB, VMS=</span><span class="si">{</span><span class="n">mu</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vms_mb&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">MB, %=</span><span class="si">{</span><span class="n">mu</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;percent&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="c1"># שלח התראה לאדמינים</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">notify_admins</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;🚨 OOM זוהתה בבוט</span><span class="si">{</span><span class="n">mem_status</span><span class="si">}</span><span class="s2">. חריגה: </span><span class="si">{</span><span class="n">err_text</span><span class="p">[:</span><span class="mi">500</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="c1"># אם המשתמש אדמין – שלח גם אליו פירוט</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">Update</span><span class="p">)</span> <span class="ow">and</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="p">:</span>
                        <span class="n">admin_ids</span> <span class="o">=</span> <span class="n">get_admin_ids</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">admin_ids</span> <span class="ow">and</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">admin_ids</span><span class="p">:</span>
                            <span class="k">await</span> <span class="n">context</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">chat_id</span><span class="o">=</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                                           <span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;🚨 OOM זוהתה</span><span class="si">{</span><span class="n">mem_status</span><span class="si">}</span><span class="s2">. התקבלה שגיאה: </span><span class="si">{</span><span class="n">err_text</span><span class="p">[:</span><span class="mi">500</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">Update</span><span class="p">)</span> <span class="ow">and</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_message</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;❌ אירעה שגיאה. אנא נסה שוב מאוחר יותר.&quot;</span>
            <span class="p">)</span></div>

    
<div class="viewcode-block" id="CodeKeeperBot.start">
<a class="viewcode-back" href="../api/main.html#main.CodeKeeperBot.start">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;הפעלת הבוט&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;מתחיל את הבוט...&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">updater</span><span class="o">.</span><span class="n">start_polling</span><span class="p">()</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;הבוט פועל! לחץ Ctrl+C להפסקה.&quot;</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="CodeKeeperBot.stop">
<a class="viewcode-back" href="../api/main.html#main.CodeKeeperBot.stop">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;עצירת הבוט&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;עוצר את הבוט...&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">updater</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        
        <span class="c1"># שחרור נעילה וסגירת חיבור למסד נתונים</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cleanup_mongo_lock</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;הבוט נעצר.&quot;</span><span class="p">)</span></div>
</div>


<div class="viewcode-block" id="signal_handler">
<a class="viewcode-back" href="../api/main.html#main.signal_handler">[תיעוד]</a>
<span class="k">def</span> <span class="nf">signal_handler</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;טיפול בסיגנלי עצירה&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;התקבל סיגנל </span><span class="si">{</span><span class="n">signum</span><span class="si">}</span><span class="s2">, עוצר את הבוט...&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>


<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="c1"># Helper to register the basic command handlers with the Application instance.</span>
<span class="c1"># ---------------------------------------------------------------------------</span>


<div class="viewcode-block" id="setup_handlers">
<a class="viewcode-back" href="../api/main.html#main.setup_handlers">[תיעוד]</a>
<span class="k">def</span> <span class="nf">setup_handlers</span><span class="p">(</span><span class="n">application</span><span class="p">:</span> <span class="n">Application</span><span class="p">,</span> <span class="n">db_manager</span><span class="p">):</span>  <span class="c1"># noqa: D401</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Register basic command handlers required for the bot to operate.&quot;&quot;&quot;</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">start_command</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>  <span class="c1"># noqa: D401</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">username</span>
        
        <span class="c1"># שמור משתמש במסד נתונים (INSERT OR IGNORE)</span>
        <span class="n">db_manager</span><span class="o">.</span><span class="n">save_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
        
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">log_user_activity</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>  <span class="c1"># הוספת רישום משתמש לסטטיסטיקות</span>
        
        <span class="c1"># בדיקה אם המשתמש הגיע מה-Web App או רוצה להוסיף קובץ</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;add_file&quot;</span><span class="p">:</span>
                <span class="c1"># המשתמש רוצה להוסיף קובץ חדש</span>
                <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">ReplyKeyboardMarkup</span><span class="p">(</span><span class="n">MAIN_KEYBOARD</span><span class="p">,</span> <span class="n">resize_keyboard</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                    <span class="s2">&quot;📁 &lt;b&gt;הוספת קובץ חדש&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;שלח לי קובץ קוד או טקסט כדי לשמור אותו.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;אפשר לשלוח:</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;• קובץ בודד או מספר קבצים</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;• קובץ ZIP עם מספר קבצים</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;• הודעת טקסט עם קוד</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;💡 טיפ: אפשר להוסיף תיאור לקובץ בכיתוב (caption)&quot;</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span><span class="p">,</span>
                    <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span>
                <span class="p">)</span>
                <span class="k">return</span>
            <span class="k">elif</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;webapp_login&quot;</span><span class="p">:</span>
                <span class="c1"># יצירת קישור התחברות אישי</span>
                <span class="n">webapp_url</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;WEBAPP_URL&#39;</span><span class="p">,</span> <span class="s1">&#39;https://code-keeper-webapp.onrender.com&#39;</span><span class="p">)</span>
                
                <span class="c1"># יצירת טוקן זמני לאימות (אפשר להשתמש ב-JWT או hash פשוט)</span>
                <span class="kn">import</span> <span class="nn">hashlib</span>
                <span class="kn">import</span> <span class="nn">time</span>
                <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
                <span class="n">secret</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;SECRET_KEY&#39;</span><span class="p">,</span> <span class="s1">&#39;dev-secret-key&#39;</span><span class="p">)</span>
                <span class="n">token_data</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">secret</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">auth_token</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">token_data</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">32</span><span class="p">]</span>
                
                <span class="c1"># שמירת הטוקן במסד נתונים עם תוקף של 5 דקות</span>
                <span class="n">db</span> <span class="o">=</span> <span class="n">db_manager</span><span class="o">.</span><span class="n">get_db</span><span class="p">()</span>
                <span class="n">db</span><span class="o">.</span><span class="n">webapp_tokens</span><span class="o">.</span><span class="n">insert_one</span><span class="p">({</span>
                    <span class="s1">&#39;token&#39;</span><span class="p">:</span> <span class="n">auth_token</span><span class="p">,</span>
                    <span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
                    <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span>
                    <span class="s1">&#39;created_at&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span>
                    <span class="s1">&#39;expires_at&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
                <span class="p">})</span>
                
                <span class="c1"># יצירת קישור התחברות</span>
                <span class="n">login_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">webapp_url</span><span class="si">}</span><span class="s2">/auth/token?token=</span><span class="si">{</span><span class="n">auth_token</span><span class="si">}</span><span class="s2">&amp;user_id=</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span>
                
                <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔐 התחבר ל-Web App&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">login_url</span><span class="p">)],</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🌐 פתח את ה-Web App&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">webapp_url</span><span class="p">)]</span>
                <span class="p">]</span>
                <span class="n">reply_markup_inline</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
                
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                    <span class="s2">&quot;🔐 &lt;b&gt;קישור התחברות אישי ל-Web App&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;לחץ על הכפתור למטה כדי להתחבר:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;⚠️ &lt;i&gt;הקישור תקף ל-5 דקות בלבד מטעמי אבטחה&lt;/i&gt;&quot;</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup_inline</span><span class="p">,</span>
                    <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span>
                <span class="p">)</span>
                <span class="k">return</span>
        
        <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">ReplyKeyboardMarkup</span><span class="p">(</span><span class="n">MAIN_KEYBOARD</span><span class="p">,</span> <span class="n">resize_keyboard</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
            <span class="s2">&quot;👋 שלום! הבוט מוכן לשימוש.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;🔧 לכל תקלה בבוט נא לשלוח הודעה ל-@moominAmir&quot;</span><span class="p">,</span> 
            <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">help_command</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>  <span class="c1"># noqa: D401</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">log_user_activity</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>  <span class="c1"># הוספת רישום משתמש לסטטיסטיקות</span>
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
            <span class="s2">&quot;ℹ️ השתמש ב/start כדי להתחיל.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;🔧 לכל תקלה בבוט נא לשלוח הודעה ל-@moominAmir&quot;</span>
        <span class="p">)</span>

    <span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="n">start_command</span><span class="p">))</span>
    <span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;help&quot;</span><span class="p">,</span> <span class="n">help_command</span><span class="p">))</span></div>



<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="c1"># New lock-free main</span>
<span class="c1"># ---------------------------------------------------------------------------</span>
<div class="viewcode-block" id="main">
<a class="viewcode-back" href="../api/main.html#main.main">[תיעוד]</a>
<span class="k">def</span> <span class="nf">main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initializes and runs the bot after acquiring a lock.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Initialize database first</span>
        <span class="k">global</span> <span class="n">db</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">DatabaseManager</span><span class="p">()</span>
        
        <span class="c1"># MongoDB connection and lock management</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">manage_mongo_lock</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Another bot instance is already running. Exiting gracefully.&quot;</span><span class="p">)</span>
            <span class="c1"># יציאה נקייה ללא שגיאה</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># --- המשך הקוד הקיים שלך ---</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Lock acquired. Initializing CodeKeeperBot...&quot;</span><span class="p">)</span>
        
        <span class="n">bot</span> <span class="o">=</span> <span class="n">CodeKeeperBot</span><span class="p">()</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Bot is starting to poll...&quot;</span><span class="p">)</span>
        <span class="n">bot</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">run_polling</span><span class="p">(</span><span class="n">drop_pending_updates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;שגיאה: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Bot polling stopped. Releasing lock and closing database connection.&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cleanup_mongo_lock</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">if</span> <span class="s1">&#39;db&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
            <span class="n">db</span><span class="o">.</span><span class="n">close_connection</span><span class="p">()</span></div>



<span class="c1"># A minimal post_init stub to comply with the PTB builder chain</span>
<div class="viewcode-block" id="setup_bot_data">
<a class="viewcode-back" href="../api/main.html#main.setup_bot_data">[תיעוד]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">setup_bot_data</span><span class="p">(</span><span class="n">application</span><span class="p">:</span> <span class="n">Application</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># noqa: D401</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A post_init function to setup application-wide data.&quot;&quot;&quot;</span>
    <span class="c1"># מחיקת כל הפקודות הציבוריות (אין להגדיר /share /share_help — שיתוף דרך הכפתורים)</span>
    <span class="k">await</span> <span class="n">application</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">delete_my_commands</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;✅ Public commands cleared (no /share, /share_help)&quot;</span><span class="p">)</span>
    
    <span class="c1"># הגדרת פקודת stats רק למנהל (אמיר בירון)</span>
    <span class="n">AMIR_ID</span> <span class="o">=</span> <span class="mi">6865105071</span>  <span class="c1"># ה-ID של אמיר בירון</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># הגדר רק את פקודת stats לאמיר</span>
        <span class="k">await</span> <span class="n">application</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">set_my_commands</span><span class="p">(</span>
            <span class="n">commands</span><span class="o">=</span><span class="p">[</span>
                <span class="n">BotCommand</span><span class="p">(</span><span class="s2">&quot;stats&quot;</span><span class="p">,</span> <span class="s2">&quot;📊 סטטיסטיקות שימוש&quot;</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="n">scope</span><span class="o">=</span><span class="n">BotCommandScopeChat</span><span class="p">(</span><span class="n">chat_id</span><span class="o">=</span><span class="n">AMIR_ID</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Commands set for Amir (ID: </span><span class="si">{</span><span class="n">AMIR_ID</span><span class="si">}</span><span class="s2">): stats only&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ Error setting admin commands: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># הפעלת שרת קטן ל-/health ו-/share/&lt;id&gt; — כבוי כברירת מחדל</span>
    <span class="n">enable_internal_web</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;ENABLE_INTERNAL_SHARE_WEB&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span>
    <span class="k">if</span> <span class="n">enable_internal_web</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">PUBLIC_BASE_URL</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">services.webserver</span> <span class="kn">import</span> <span class="n">create_app</span>
            <span class="n">aiohttp_app</span> <span class="o">=</span> <span class="n">create_app</span><span class="p">()</span>
            <span class="k">async</span> <span class="k">def</span> <span class="nf">_start_web_job</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
                <span class="n">runner</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">AppRunner</span><span class="p">(</span><span class="n">aiohttp_app</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">runner</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
                <span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;PORT&quot;</span><span class="p">,</span> <span class="s2">&quot;10000&quot;</span><span class="p">))</span>
                <span class="n">site</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">TCPSite</span><span class="p">(</span><span class="n">runner</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">site</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🌐 Internal web server started on :</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># להריץ אחרי שהאפליקציה התחילה, כדי להימנע מ-PTBUserWarning</span>
            <span class="n">application</span><span class="o">.</span><span class="n">job_queue</span><span class="o">.</span><span class="n">run_once</span><span class="p">(</span><span class="n">_start_web_job</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ Failed to start internal web server: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;ℹ️ Skipping internal web server (disabled or missing PUBLIC_BASE_URL)&quot;</span><span class="p">)</span>

    <span class="c1"># Reschedule Google Drive backup jobs for all users with an active schedule</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">_reschedule_drive_jobs</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">drive_handler</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">bot_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;drive_handler&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">drive_handler</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="c1"># Access users collection directly to find users with drive schedules</span>
                <span class="n">users_coll</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">users</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;db&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">users_coll</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="n">sched_keys</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;daily&quot;</span><span class="p">,</span> <span class="s2">&quot;every3&quot;</span><span class="p">,</span> <span class="s2">&quot;weekly&quot;</span><span class="p">,</span> <span class="s2">&quot;biweekly&quot;</span><span class="p">,</span> <span class="s2">&quot;monthly&quot;</span><span class="p">}</span>
                <span class="n">cursor</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">cursor</span> <span class="o">=</span> <span class="n">users_coll</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s2">&quot;drive_prefs.schedule&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">sched_keys</span><span class="p">)}})</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">cursor</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">uid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">uid</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">prefs</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;drive_prefs&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;schedule&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">sched_keys</span><span class="p">:</span>
                            <span class="c1"># Ensure a repeating job exists and is aligned to the next planned time</span>
                            <span class="c1"># _ensure_schedule_job מיועד ב-drive_handler; אם לא קיים, נתעלם בשקט</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">await</span> <span class="n">drive_handler</span><span class="o">.</span><span class="n">_ensure_schedule_job</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                                <span class="k">pass</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">continue</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="c1"># Run once shortly after startup to restore jobs after restarts/deploys</span>
        <span class="n">application</span><span class="o">.</span><span class="n">job_queue</span><span class="o">.</span><span class="n">run_once</span><span class="p">(</span><span class="n">_reschedule_drive_jobs</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to schedule Drive jobs rescan on startup&quot;</span><span class="p">)</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Development Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>