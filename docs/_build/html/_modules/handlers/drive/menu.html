

<!DOCTYPE html>
<html class="writer-html5" lang="he" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>handlers.drive.menu &mdash; תיעוד Code Keeper Bot 1.0.0</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=2d7a82d5" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=0062297a"></script>
      <script src="../../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../_static/translations.js?v=714bf7a6"></script>
      <script src="https://unpkg.com/mermaid@10.2.0/dist/mermaid.min.js"></script>
      <script>mermaid.initialize({startOnLoad:true});</script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="אינדקס" href="../../../genindex.html" />
    <link rel="search" title="חיפוש" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Code Keeper Bot
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">למפתחים ולסוכני AI:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart-ai.html">התחלה מהירה - סוכני AI</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart-ai.html#id1">מטרה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart-ai.html#id2">מה אסור</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart-ai.html#id3">מה מותר ומומלץ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart-ai.html#id4">פורמטי ציטוט קוד</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart-ai.html#tmp">מחיקה בטוחה (רק ב-/tmp)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart-ai.html#pr">קומיטים ו-PR</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart-ai.html#id5">קישורים מהירים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart.html">התחלה מהירה - מפתחים</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart.html#id2">מטרה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart.html#id3">שלב 1: התקנה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart.html#env">שלב 2: הגדרת .env</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart.html#id4">שלב 3: הרצה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart.html#id5">מה הלאה?</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../ai-guidelines.html">הנחיות מלאות לסוכני AI</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../ai-guidelines.html#id1">מגבלות קריטיות</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../ai-guidelines.html#id2">הרצת פקודות</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../ai-guidelines.html#id3">כלי קבצים מאושרים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ai-guidelines.html#id4">עקרונות עריכת קוד</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ai-guidelines.html#pull-requests">קומיטים ו-Pull Requests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ai-guidelines.html#id5">עבודה עם טסטים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ai-guidelines.html#id6">קישורים מהירים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../doc-authoring.html">Doc Authoring Guide (Sphinx/RTD)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../doc-authoring.html#id1">מטרות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../doc-authoring.html#id2">מדיניות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../doc-authoring.html#id3">טיפים מהירים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../doc-authoring.html#id4">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../style-glossary.html">Style &amp; Naming Glossary</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../style-glossary.html#id1">מטרות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../style-glossary.html#id2">מיפוי מונחים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../style-glossary.html#id3">כללים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../style-glossary.html#id4">עוגני תיעוד</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../versioning-stable-anchors.html">Versioning &amp; Stable Anchors</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../versioning-stable-anchors.html#id1">מדיניות עוגנים יציבים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../versioning-stable-anchors.html#whats-new">What’s New</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../versioning-stable-anchors.html#anchors">דוגמת Anchors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../versioning-stable-anchors.html#id2">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../whats-new.html">What’s New</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../whats-new.html#id1">2025-10-15</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../architecture.html">ארכיטקטורה</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../architecture.html#id2">סקירה כללית</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../architecture.html#id3">תרשים רכיבים (תמציתי)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../architecture.html#id4">מבנה תיקיות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../architecture.html#id5">זרימות מרכזיות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../architecture.html#id6">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">מדריך תרומה</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../contributing.html#id2">מטרה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../contributing.html#id3">כללים כלליים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../contributing.html#workflow">Workflow בסיסי</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../contributing.html#id4">דוגמאות שימושיות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../contributing.html#id5">קישורים</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">מדריכים בסיסיים:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">התקנה והגדרה</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../installation.html#id2">דרישות מערכת</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../installation.html#id3">התקנה מהירה</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../installation.html#id4">1. שכפל את הריפוזיטורי</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../installation.html#id5">2. התקן תלויות</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../installation.html#id6">3. הגדר משתני סביבה</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../installation.html#id7">4. הפעל את הבוט</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../installation.html#docker">התקנה עם Docker</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../installation.html#image">1. בנה את ה-Image</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../installation.html#docker-compose">2. הפעל עם Docker Compose</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../installation.html#mongodb">הגדרת MongoDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../installation.html#telegram-bot">הגדרת Telegram Bot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../installation.html#id8">הגדרות מתקדמות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../installation.html#id9">בדיקת התקנה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../installation.html#id10">פתרון בעיות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../installation.html#id11">תמיכה</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../configuration.html">הגדרות תצורה</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../configuration.html#id2">קובץ התצורה הראשי</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../configuration.html#id3">משתני סביבה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../configuration.html#id4">הגדרות מתקדמות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../configuration.html#mongodb">הגדרת MongoDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../configuration.html#redis-cache">הגדרת Redis Cache</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../configuration.html#id5">הגדרות אבטחה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../configuration.html#id6">תצורה לסביבות שונות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../configuration.html#env">דוגמת קובץ .env מלא</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../configuration.html#id7">טיפים וטריקים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../environment-variables.html">משתני סביבה - רפרנס</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../environment-variables.html#id2">טבלה מרכזית</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../environment-variables.html#id3">דוגמאות קונפיגורציה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../environment-variables.html#id4">קישורים</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api/main.html">main module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/main.html#main.get_admin_ids"><code class="docutils literal notranslate"><span class="pre">get_admin_ids()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/main.html#main.notify_admins"><code class="docutils literal notranslate"><span class="pre">notify_admins()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/main.html#main.recycle_backfill_command"><code class="docutils literal notranslate"><span class="pre">recycle_backfill_command()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/main.html#main.log_user_activity"><code class="docutils literal notranslate"><span class="pre">log_user_activity()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/main.html#main.get_lock_collection"><code class="docutils literal notranslate"><span class="pre">get_lock_collection()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/main.html#main.ensure_lock_indexes"><code class="docutils literal notranslate"><span class="pre">ensure_lock_indexes()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/main.html#main.cleanup_mongo_lock"><code class="docutils literal notranslate"><span class="pre">cleanup_mongo_lock()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/main.html#main.manage_mongo_lock"><code class="docutils literal notranslate"><span class="pre">manage_mongo_lock()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/main.html#main.CodeKeeperBot"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/main.html#main.CodeKeeperBot.application"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.application</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/main.html#main.CodeKeeperBot.github_handler"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.github_handler</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/main.html#main.CodeKeeperBot.backup_handler"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.backup_handler</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/main.html#main.CodeKeeperBot.__init__"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/main.html#main.CodeKeeperBot.setup_handlers"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.setup_handlers()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/main.html#main.CodeKeeperBot.help_command"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.help_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/main.html#main.CodeKeeperBot.save_command"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.save_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/main.html#main.CodeKeeperBot.list_command"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.list_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/main.html#main.CodeKeeperBot.search_command"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.search_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/main.html#main.CodeKeeperBot.check_commands"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.check_commands()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/main.html#main.CodeKeeperBot.stats_command"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.stats_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/main.html#main.CodeKeeperBot.handle_document"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.handle_document()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/main.html#main.CodeKeeperBot.handle_text_message"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.handle_text_message()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/main.html#main.CodeKeeperBot.error_handler"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.error_handler()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/main.html#main.CodeKeeperBot.start"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.start()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/main.html#main.CodeKeeperBot.stop"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot.stop()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/main.html#main.signal_handler"><code class="docutils literal notranslate"><span class="pre">signal_handler()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/main.html#main.setup_handlers"><code class="docutils literal notranslate"><span class="pre">setup_handlers()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/main.html#main.main"><code class="docutils literal notranslate"><span class="pre">main()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/main.html#main.setup_bot_data"><code class="docutils literal notranslate"><span class="pre">setup_bot_data()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/config.html">config module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/config.html#config.BotConfig"><code class="docutils literal notranslate"><span class="pre">BotConfig</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/config.html#config.BotConfig.BOT_TOKEN"><code class="docutils literal notranslate"><span class="pre">BotConfig.BOT_TOKEN</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/config.html#config.BotConfig.MONGODB_URL"><code class="docutils literal notranslate"><span class="pre">BotConfig.MONGODB_URL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/config.html#config.BotConfig.DATABASE_NAME"><code class="docutils literal notranslate"><span class="pre">BotConfig.DATABASE_NAME</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/config.html#config.BotConfig.REDIS_URL"><code class="docutils literal notranslate"><span class="pre">BotConfig.REDIS_URL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/config.html#config.BotConfig.CACHE_ENABLED"><code class="docutils literal notranslate"><span class="pre">BotConfig.CACHE_ENABLED</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/config.html#config.BotConfig.GITHUB_TOKEN"><code class="docutils literal notranslate"><span class="pre">BotConfig.GITHUB_TOKEN</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/config.html#config.BotConfig.PASTEBIN_API_KEY"><code class="docutils literal notranslate"><span class="pre">BotConfig.PASTEBIN_API_KEY</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/config.html#config.BotConfig.MAX_CODE_SIZE"><code class="docutils literal notranslate"><span class="pre">BotConfig.MAX_CODE_SIZE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/config.html#config.BotConfig.MAX_FILES_PER_USER"><code class="docutils literal notranslate"><span class="pre">BotConfig.MAX_FILES_PER_USER</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/config.html#config.BotConfig.SUPPORTED_LANGUAGES"><code class="docutils literal notranslate"><span class="pre">BotConfig.SUPPORTED_LANGUAGES</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/config.html#config.BotConfig.RECYCLE_TTL_DAYS"><code class="docutils literal notranslate"><span class="pre">BotConfig.RECYCLE_TTL_DAYS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/config.html#config.BotConfig.PUBLIC_BASE_URL"><code class="docutils literal notranslate"><span class="pre">BotConfig.PUBLIC_BASE_URL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/config.html#config.BotConfig.WEBAPP_URL"><code class="docutils literal notranslate"><span class="pre">BotConfig.WEBAPP_URL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/config.html#config.BotConfig.MAINTENANCE_MODE"><code class="docutils literal notranslate"><span class="pre">BotConfig.MAINTENANCE_MODE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/config.html#config.BotConfig.MAINTENANCE_MESSAGE"><code class="docutils literal notranslate"><span class="pre">BotConfig.MAINTENANCE_MESSAGE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/config.html#config.BotConfig.MAINTENANCE_AUTO_WARMUP_SECS"><code class="docutils literal notranslate"><span class="pre">BotConfig.MAINTENANCE_AUTO_WARMUP_SECS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/config.html#config.BotConfig.RATE_LIMIT_PER_MINUTE"><code class="docutils literal notranslate"><span class="pre">BotConfig.RATE_LIMIT_PER_MINUTE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/config.html#config.BotConfig.HIGHLIGHT_THEME"><code class="docutils literal notranslate"><span class="pre">BotConfig.HIGHLIGHT_THEME</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/config.html#config.BotConfig.GIT_CHECKPOINT_PREFIX"><code class="docutils literal notranslate"><span class="pre">BotConfig.GIT_CHECKPOINT_PREFIX</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/config.html#config.BotConfig.GOOGLE_CLIENT_ID"><code class="docutils literal notranslate"><span class="pre">BotConfig.GOOGLE_CLIENT_ID</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/config.html#config.BotConfig.GOOGLE_CLIENT_SECRET"><code class="docutils literal notranslate"><span class="pre">BotConfig.GOOGLE_CLIENT_SECRET</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/config.html#config.BotConfig.GOOGLE_OAUTH_SCOPES"><code class="docutils literal notranslate"><span class="pre">BotConfig.GOOGLE_OAUTH_SCOPES</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/config.html#config.BotConfig.GOOGLE_TOKEN_REFRESH_MARGIN_SECS"><code class="docutils literal notranslate"><span class="pre">BotConfig.GOOGLE_TOKEN_REFRESH_MARGIN_SECS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/config.html#config.BotConfig.DRIVE_MENU_V2"><code class="docutils literal notranslate"><span class="pre">BotConfig.DRIVE_MENU_V2</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/config.html#config.BotConfig.DOCUMENTATION_URL"><code class="docutils literal notranslate"><span class="pre">BotConfig.DOCUMENTATION_URL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/config.html#config.BotConfig.BOT_LABEL"><code class="docutils literal notranslate"><span class="pre">BotConfig.BOT_LABEL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/config.html#config.BotConfig.DRIVE_ADD_HASH"><code class="docutils literal notranslate"><span class="pre">BotConfig.DRIVE_ADD_HASH</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/config.html#config.BotConfig.NORMALIZE_CODE_ON_SAVE"><code class="docutils literal notranslate"><span class="pre">BotConfig.NORMALIZE_CODE_ON_SAVE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/config.html#config.BotConfig.__init__"><code class="docutils literal notranslate"><span class="pre">BotConfig.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/config.html#config.load_config"><code class="docutils literal notranslate"><span class="pre">load_config()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/bot_handlers.html">bot_handlers module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/conversation_handlers.html">conversation_handlers module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/database.html">database package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/database.html#submodules">Submodules</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/database.manager.html">database.manager module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/database.models.html">database.models module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/database.repository.html">database.repository module</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/services.html">services package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/services.html#submodules">Submodules</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/services.backup_service.html">services.backup_service module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/services.code_service.html">services.code_service module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/services.github_service.html">services.github_service module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/services.google_drive_service.html">services.google_drive_service module</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/handlers.html">handlers package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/handlers.html#subpackages">Subpackages</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/handlers.github.html">handlers.github package</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/handlers.html#submodules">Submodules</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/handlers.file_view.html">handlers.file_view module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/handlers.pagination.html">handlers.pagination module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/handlers.save_flow.html">handlers.save_flow module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/handlers.states.html">handlers.states module</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/utils.html">utils module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/utils.html#utils.CodeErrorLogger"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.CodeErrorLogger.__init__"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.CodeErrorLogger.log_code_processing_error"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger.log_code_processing_error()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.CodeErrorLogger.log_code_activity"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger.log_code_activity()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.CodeErrorLogger.log_validation_failure"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger.log_validation_failure()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.CodeErrorLogger.log_sanitization_success"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger.log_sanitization_success()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/utils.html#utils.TimeUtils"><code class="docutils literal notranslate"><span class="pre">TimeUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.TimeUtils.format_relative_time"><code class="docutils literal notranslate"><span class="pre">TimeUtils.format_relative_time()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.TimeUtils.parse_date_string"><code class="docutils literal notranslate"><span class="pre">TimeUtils.parse_date_string()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.TimeUtils.get_time_ranges"><code class="docutils literal notranslate"><span class="pre">TimeUtils.get_time_ranges()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/utils.html#utils.TextUtils"><code class="docutils literal notranslate"><span class="pre">TextUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.TextUtils.truncate_text"><code class="docutils literal notranslate"><span class="pre">TextUtils.truncate_text()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.TextUtils.escape_markdown"><code class="docutils literal notranslate"><span class="pre">TextUtils.escape_markdown()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.TextUtils.clean_filename"><code class="docutils literal notranslate"><span class="pre">TextUtils.clean_filename()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.TextUtils.extract_hashtags"><code class="docutils literal notranslate"><span class="pre">TextUtils.extract_hashtags()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.TextUtils.highlight_text"><code class="docutils literal notranslate"><span class="pre">TextUtils.highlight_text()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.TextUtils.format_file_size"><code class="docutils literal notranslate"><span class="pre">TextUtils.format_file_size()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.TextUtils.pluralize_hebrew"><code class="docutils literal notranslate"><span class="pre">TextUtils.pluralize_hebrew()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/utils.html#utils.SecurityUtils"><code class="docutils literal notranslate"><span class="pre">SecurityUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.SecurityUtils.generate_secure_token"><code class="docutils literal notranslate"><span class="pre">SecurityUtils.generate_secure_token()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.SecurityUtils.hash_content"><code class="docutils literal notranslate"><span class="pre">SecurityUtils.hash_content()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.SecurityUtils.validate_user_input"><code class="docutils literal notranslate"><span class="pre">SecurityUtils.validate_user_input()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.SecurityUtils.sanitize_code"><code class="docutils literal notranslate"><span class="pre">SecurityUtils.sanitize_code()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/utils.html#utils.TelegramUtils"><code class="docutils literal notranslate"><span class="pre">TelegramUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.TelegramUtils.send_typing_action"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.send_typing_action()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.TelegramUtils.send_document_action"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.send_document_action()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.TelegramUtils.safe_answer"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.safe_answer()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.TelegramUtils.get_user_mention"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.get_user_mention()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.TelegramUtils.split_long_message"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.split_long_message()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.TelegramUtils.safe_edit_message_text"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.safe_edit_message_text()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.TelegramUtils.safe_edit_message_reply_markup"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.safe_edit_message_reply_markup()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.TelegramUtils.extract_message_text_preserve_markdown"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.extract_message_text_preserve_markdown()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/utils.html#utils.CallbackQueryGuard"><code class="docutils literal notranslate"><span class="pre">CallbackQueryGuard</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.CallbackQueryGuard.DEFAULT_WINDOW_SECONDS"><code class="docutils literal notranslate"><span class="pre">CallbackQueryGuard.DEFAULT_WINDOW_SECONDS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.CallbackQueryGuard.should_block"><code class="docutils literal notranslate"><span class="pre">CallbackQueryGuard.should_block()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.CallbackQueryGuard.should_block_async"><code class="docutils literal notranslate"><span class="pre">CallbackQueryGuard.should_block_async()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/utils.html#utils.AsyncUtils"><code class="docutils literal notranslate"><span class="pre">AsyncUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.AsyncUtils.run_with_timeout"><code class="docutils literal notranslate"><span class="pre">AsyncUtils.run_with_timeout()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.AsyncUtils.batch_process"><code class="docutils literal notranslate"><span class="pre">AsyncUtils.batch_process()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/utils.html#utils.PerformanceUtils"><code class="docutils literal notranslate"><span class="pre">PerformanceUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.PerformanceUtils.timing_decorator"><code class="docutils literal notranslate"><span class="pre">PerformanceUtils.timing_decorator()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.PerformanceUtils.measure_time"><code class="docutils literal notranslate"><span class="pre">PerformanceUtils.measure_time()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/utils.html#utils.ValidationUtils"><code class="docutils literal notranslate"><span class="pre">ValidationUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.ValidationUtils.is_valid_filename"><code class="docutils literal notranslate"><span class="pre">ValidationUtils.is_valid_filename()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.ValidationUtils.is_safe_code"><code class="docutils literal notranslate"><span class="pre">ValidationUtils.is_safe_code()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/utils.html#utils.FileUtils"><code class="docutils literal notranslate"><span class="pre">FileUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.FileUtils.download_file"><code class="docutils literal notranslate"><span class="pre">FileUtils.download_file()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.FileUtils.get_file_extension"><code class="docutils literal notranslate"><span class="pre">FileUtils.get_file_extension()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.FileUtils.get_mime_type"><code class="docutils literal notranslate"><span class="pre">FileUtils.get_mime_type()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.FileUtils.create_temp_file"><code class="docutils literal notranslate"><span class="pre">FileUtils.create_temp_file()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/utils.html#utils.ConfigUtils"><code class="docutils literal notranslate"><span class="pre">ConfigUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.ConfigUtils.load_json_config"><code class="docutils literal notranslate"><span class="pre">ConfigUtils.load_json_config()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.ConfigUtils.save_json_config"><code class="docutils literal notranslate"><span class="pre">ConfigUtils.save_json_config()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/utils.html#utils.CacheUtils"><code class="docutils literal notranslate"><span class="pre">CacheUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.CacheUtils.set"><code class="docutils literal notranslate"><span class="pre">CacheUtils.set()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.CacheUtils.get"><code class="docutils literal notranslate"><span class="pre">CacheUtils.get()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.CacheUtils.delete"><code class="docutils literal notranslate"><span class="pre">CacheUtils.delete()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.CacheUtils.clear"><code class="docutils literal notranslate"><span class="pre">CacheUtils.clear()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/utils.html#utils.get_memory_usage"><code class="docutils literal notranslate"><span class="pre">get_memory_usage()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/utils.html#utils.setup_logging"><code class="docutils literal notranslate"><span class="pre">setup_logging()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/utils.html#utils.generate_summary_stats"><code class="docutils literal notranslate"><span class="pre">generate_summary_stats()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/utils.html#utils.detect_language_from_filename"><code class="docutils literal notranslate"><span class="pre">detect_language_from_filename()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/utils.html#utils.get_language_emoji"><code class="docutils literal notranslate"><span class="pre">get_language_emoji()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/utils.html#utils.SensitiveDataFilter"><code class="docutils literal notranslate"><span class="pre">SensitiveDataFilter</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.SensitiveDataFilter.filter"><code class="docutils literal notranslate"><span class="pre">SensitiveDataFilter.filter()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/utils.html#utils.install_sensitive_filter"><code class="docutils literal notranslate"><span class="pre">install_sensitive_filter()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/utils.html#utils.normalize_code"><code class="docutils literal notranslate"><span class="pre">normalize_code()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/modules.html">workspace</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/activity_reporter.html">activity_reporter module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/activity_reporter.html#activity_reporter.SimpleActivityReporter"><code class="docutils literal notranslate"><span class="pre">SimpleActivityReporter</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/activity_reporter.html#activity_reporter.create_reporter"><code class="docutils literal notranslate"><span class="pre">create_reporter()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/autocomplete_manager.html">autocomplete_manager module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/autocomplete_manager.html#autocomplete_manager.AutocompleteManager"><code class="docutils literal notranslate"><span class="pre">AutocompleteManager</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/backup_menu_handler.html">backup_menu_handler module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/backup_menu_handler.html#backup_menu_handler.BackupMenuHandler"><code class="docutils literal notranslate"><span class="pre">BackupMenuHandler</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/batch_commands.html">batch_commands module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/batch_commands.html#batch_commands.batch_analyze_command"><code class="docutils literal notranslate"><span class="pre">batch_analyze_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/batch_commands.html#batch_commands.batch_validate_command"><code class="docutils literal notranslate"><span class="pre">batch_validate_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/batch_commands.html#batch_commands.job_status_command"><code class="docutils literal notranslate"><span class="pre">job_status_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/batch_commands.html#batch_commands.large_file_command"><code class="docutils literal notranslate"><span class="pre">large_file_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/batch_commands.html#batch_commands.handle_batch_callbacks"><code class="docutils literal notranslate"><span class="pre">handle_batch_callbacks()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/batch_commands.html#batch_commands.setup_batch_handlers"><code class="docutils literal notranslate"><span class="pre">setup_batch_handlers()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/batch_processor.html">batch_processor module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/batch_processor.html#batch_processor.BatchJob"><code class="docutils literal notranslate"><span class="pre">BatchJob</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/batch_processor.html#batch_processor.BatchProcessor"><code class="docutils literal notranslate"><span class="pre">BatchProcessor</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/bot_handlers.html">bot_handlers module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/cache_commands.html">cache_commands module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/cache_commands.html#cache_commands.cache_stats_command"><code class="docutils literal notranslate"><span class="pre">cache_stats_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/cache_commands.html#cache_commands.clear_cache_command"><code class="docutils literal notranslate"><span class="pre">clear_cache_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/cache_commands.html#cache_commands.setup_cache_handlers"><code class="docutils literal notranslate"><span class="pre">setup_cache_handlers()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/cache_manager.html">cache_manager module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/cache_manager.html#cache_manager.CacheManager"><code class="docutils literal notranslate"><span class="pre">CacheManager</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/cache_manager.html#cache_manager.cached"><code class="docutils literal notranslate"><span class="pre">cached()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/cache_manager.html#cache_manager.async_cached"><code class="docutils literal notranslate"><span class="pre">async_cached()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/code_preview.html">code_preview module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/code_preview.html#code_preview.CodePreviewManager"><code class="docutils literal notranslate"><span class="pre">CodePreviewManager</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/code_processor.html">code_processor module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/config.html">config module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/config.html#config.BotConfig"><code class="docutils literal notranslate"><span class="pre">BotConfig</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/config.html#config.load_config"><code class="docutils literal notranslate"><span class="pre">load_config()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/conftest.html">conftest module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/conversation_handlers.html">conversation_handlers module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/database.html">database package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/database.html#submodules">Submodules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/file_manager.html">file_manager module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/file_manager.html#file_manager.BackupInfo"><code class="docutils literal notranslate"><span class="pre">BackupInfo</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/file_manager.html#file_manager.BackupManager"><code class="docutils literal notranslate"><span class="pre">BackupManager</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/fix_telegram_parse_error.html">fix_telegram_parse_error module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/fix_telegram_parse_error.html#fix_telegram_parse_error.clean_for_telegram"><code class="docutils literal notranslate"><span class="pre">clean_for_telegram()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/fix_telegram_parse_error.html#fix_telegram_parse_error.apply_fix"><code class="docutils literal notranslate"><span class="pre">apply_fix()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/fix_telegram_parse_error.html#fix_telegram_parse_error.wrap_edit_message_calls"><code class="docutils literal notranslate"><span class="pre">wrap_edit_message_calls()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/github_menu_handler.html">github_menu_handler module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/github_menu_handler.html#github_menu_handler.safe_html_escape"><code class="docutils literal notranslate"><span class="pre">safe_html_escape()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/github_menu_handler.html#github_menu_handler.format_bytes"><code class="docutils literal notranslate"><span class="pre">format_bytes()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/github_menu_handler.html#github_menu_handler.GitHubMenuHandler"><code class="docutils literal notranslate"><span class="pre">GitHubMenuHandler</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/github_upload_fix.html">github_upload_fix module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/github_upload_fix.html#github_upload_fix.github_upload_new_file"><code class="docutils literal notranslate"><span class="pre">github_upload_new_file()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/github_upload_fix.html#github_upload_fix.handle_document_fixed"><code class="docutils literal notranslate"><span class="pre">handle_document_fixed()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/github_upload_fix.html#github_upload_fix.upload_to_github_fixed"><code class="docutils literal notranslate"><span class="pre">upload_to_github_fixed()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/github_upload_fix.html#github_upload_fix.setup_minimal_commands"><code class="docutils literal notranslate"><span class="pre">setup_minimal_commands()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/github_upload_fix.html#github_upload_fix.stats_command_secured"><code class="docutils literal notranslate"><span class="pre">stats_command_secured()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/github_upload_fix.html#github_upload_fix.check_commands"><code class="docutils literal notranslate"><span class="pre">check_commands()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/handlers.html">handlers package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/handlers.html#subpackages">Subpackages</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/handlers.html#submodules">Submodules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/i18n.html">i18n package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/i18n.html#submodules">Submodules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/integrations.html">integrations module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/large_files_handler.html">large_files_handler module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/large_files_handler.html#large_files_handler.LargeFilesHandler"><code class="docutils literal notranslate"><span class="pre">LargeFilesHandler</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/lazy_loader.html">lazy_loader module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/lazy_loader.html#lazy_loader.FileChunk"><code class="docutils literal notranslate"><span class="pre">FileChunk</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/lazy_loader.html#lazy_loader.LazyLoader"><code class="docutils literal notranslate"><span class="pre">LazyLoader</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/main.html">main module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/main.html#main.get_admin_ids"><code class="docutils literal notranslate"><span class="pre">get_admin_ids()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/main.html#main.notify_admins"><code class="docutils literal notranslate"><span class="pre">notify_admins()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/main.html#main.recycle_backfill_command"><code class="docutils literal notranslate"><span class="pre">recycle_backfill_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/main.html#main.log_user_activity"><code class="docutils literal notranslate"><span class="pre">log_user_activity()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/main.html#main.get_lock_collection"><code class="docutils literal notranslate"><span class="pre">get_lock_collection()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/main.html#main.ensure_lock_indexes"><code class="docutils literal notranslate"><span class="pre">ensure_lock_indexes()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/main.html#main.cleanup_mongo_lock"><code class="docutils literal notranslate"><span class="pre">cleanup_mongo_lock()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/main.html#main.manage_mongo_lock"><code class="docutils literal notranslate"><span class="pre">manage_mongo_lock()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/main.html#main.CodeKeeperBot"><code class="docutils literal notranslate"><span class="pre">CodeKeeperBot</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/main.html#main.signal_handler"><code class="docutils literal notranslate"><span class="pre">signal_handler()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/main.html#main.setup_handlers"><code class="docutils literal notranslate"><span class="pre">setup_handlers()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/main.html#main.main"><code class="docutils literal notranslate"><span class="pre">main()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/main.html#main.setup_bot_data"><code class="docutils literal notranslate"><span class="pre">setup_bot_data()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/repo_analyzer.html">repo_analyzer module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/repo_analyzer.html#repo_analyzer.RepoAnalyzer"><code class="docutils literal notranslate"><span class="pre">RepoAnalyzer</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/search_engine.html">search_engine module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/secret_manager.html">secret_manager module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/secret_manager.html#secret_manager.encrypt_secret"><code class="docutils literal notranslate"><span class="pre">encrypt_secret()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/secret_manager.html#secret_manager.decrypt_secret"><code class="docutils literal notranslate"><span class="pre">decrypt_secret()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/services.html">services package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/services.html#submodules">Submodules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/terminal_commands.html">terminal_commands module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/terminal_commands.html#terminal_commands.run_in_sandbox"><code class="docutils literal notranslate"><span class="pre">run_in_sandbox()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/terminal_commands.html#terminal_commands.terminal_enter"><code class="docutils literal notranslate"><span class="pre">terminal_enter()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/terminal_commands.html#terminal_commands.terminal_exit"><code class="docutils literal notranslate"><span class="pre">terminal_exit()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/terminal_commands.html#terminal_commands.terminal_run_command"><code class="docutils literal notranslate"><span class="pre">terminal_run_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/terminal_commands.html#terminal_commands.terminal_command"><code class="docutils literal notranslate"><span class="pre">terminal_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/terminal_commands.html#terminal_commands.setup_terminal_handlers"><code class="docutils literal notranslate"><span class="pre">setup_terminal_handlers()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/test_basic.html">test_basic module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/test_basic.html#test_basic.test_python_version"><code class="docutils literal notranslate"><span class="pre">test_python_version()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/test_basic.html#test_basic.test_import_main"><code class="docutils literal notranslate"><span class="pre">test_import_main()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/test_basic.html#test_basic.test_environment"><code class="docutils literal notranslate"><span class="pre">test_environment()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/test_basic.html#test_basic.test_basic_calculation"><code class="docutils literal notranslate"><span class="pre">test_basic_calculation()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/test_basic.html#test_basic.TestRequirements"><code class="docutils literal notranslate"><span class="pre">TestRequirements</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/user_stats.html">user_stats module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/user_stats.html#user_stats.UserStats"><code class="docutils literal notranslate"><span class="pre">UserStats</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/utils.html">utils module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.CodeErrorLogger"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.TimeUtils"><code class="docutils literal notranslate"><span class="pre">TimeUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.TextUtils"><code class="docutils literal notranslate"><span class="pre">TextUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.SecurityUtils"><code class="docutils literal notranslate"><span class="pre">SecurityUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.TelegramUtils"><code class="docutils literal notranslate"><span class="pre">TelegramUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.CallbackQueryGuard"><code class="docutils literal notranslate"><span class="pre">CallbackQueryGuard</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.AsyncUtils"><code class="docutils literal notranslate"><span class="pre">AsyncUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.PerformanceUtils"><code class="docutils literal notranslate"><span class="pre">PerformanceUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.ValidationUtils"><code class="docutils literal notranslate"><span class="pre">ValidationUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.FileUtils"><code class="docutils literal notranslate"><span class="pre">FileUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.ConfigUtils"><code class="docutils literal notranslate"><span class="pre">ConfigUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.CacheUtils"><code class="docutils literal notranslate"><span class="pre">CacheUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.get_memory_usage"><code class="docutils literal notranslate"><span class="pre">get_memory_usage()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.setup_logging"><code class="docutils literal notranslate"><span class="pre">setup_logging()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.generate_summary_stats"><code class="docutils literal notranslate"><span class="pre">generate_summary_stats()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.detect_language_from_filename"><code class="docutils literal notranslate"><span class="pre">detect_language_from_filename()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.get_language_emoji"><code class="docutils literal notranslate"><span class="pre">get_language_emoji()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.SensitiveDataFilter"><code class="docutils literal notranslate"><span class="pre">SensitiveDataFilter</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.install_sensitive_filter"><code class="docutils literal notranslate"><span class="pre">install_sensitive_filter()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utils.html#utils.normalize_code"><code class="docutils literal notranslate"><span class="pre">normalize_code()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/index.html">מודולים ראשיים</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../modules/index.html#file-management">File Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../modules/index.html#github-integration">GitHub Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../modules/index.html#backup-system">Backup System</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../modules/index.html#code-processing">Code Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../modules/index.html#search-engine">Search Engine</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../modules/index.html#repository-analysis">Repository Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../modules/index.html#batch-processing">Batch Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../modules/index.html#large-files-handling">Large Files Handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../modules/index.html#cache-management">Cache Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../modules/index.html#user-statistics">User Statistics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../modules/index.html#activity-reporting">Activity Reporting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../modules/index.html#utilities">Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../modules/index.html#lazy-loading">Lazy Loading</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../modules/index.html#integrations">Integrations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../modules/index.html#terminal-commands">Terminal Commands</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../modules/index.html#autocomplete-manager">Autocomplete Manager</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../handlers/index.html">Handlers</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../handlers/index.html#drive-menu">Drive Menu</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../handlers/drive_menu.html">Drive Menu V2</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../handlers/drive_menu.html#id1">סקירה</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../handlers/drive_menu.html#id2">דגל פיצ’ר</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../handlers/drive_menu.html#id3">זרימות עיקריות</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../handlers/drive_menu.html#device-flow">התחברות (Device Flow)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../handlers/drive_menu.html#id4">טיפול שגיאות</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../handlers/drive_menu.html#id5">ניטור</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../handlers/drive_menu.html#module-handlers.drive.menu">API (autodoc)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../handlers/index.html#file-view-handler">File View Handler</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../handlers/index.html#file-view-handler-module">File View Handler Module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../handlers/index.html#pagination-handler">Pagination Handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../handlers/index.html#save-flow-handler">Save Flow Handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../handlers/index.html#states-handler">States Handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../handlers/index.html#github-handlers">GitHub Handlers</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../services/index.html">Services</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../services/index.html#code-service">Code Service</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../services/index.html#code-service-module">Code Service Module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../services/index.html#github-service">GitHub Service</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../services/index.html#backup-service">Backup Service</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../services/index.html#google-drive-service">Google Drive Service</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../services/google_drive_service.html">Google Drive Service</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../services/google_drive_service.html#id1">סקירה</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../services/google_drive_service.html#oauth">הערות OAuth</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../services/google_drive_service.html#id2">מבני קבצים</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../services/google_drive_service.html#api-autodoc">API (autodoc)</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../database/index.html">Database</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../database/index.html#database-manager">Database Manager</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../database/index.html#models">Models</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../database/index.html#codesnippet-model">CodeSnippet Model</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../database/index.html#databasemanager-class">DatabaseManager Class</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../database/index.html#database-operations">Database Operations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../database/index.html#save-operations">Save Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../database/index.html#search-operations">Search Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../database/index.html#delete-operations">Delete Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../database/index.html#statistics-operations">Statistics Operations</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../database/indexing.html">MongoDB Indexing Cookbook</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../database/indexing.html#id1">למה?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../database/indexing.html#id2">אינדקסים מומלצים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../database/indexing.html#python-pymongo">מתכונים (Python / PyMongo)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../database/indexing.html#explain-mongo-shell">בדיקות explain (Mongo Shell)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../database/indexing.html#explain">מה לחפש ב-explain?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../database/indexing.html#id3">בדיקת קיום אינדקסים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../database/indexing.html#id4">שיטות עבודה מומלצות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../database/indexing.html#id5">דוגמאות נוספות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../database/indexing.html#gotchas">Gotchas נפוצים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../database/cursor-pagination.html">Cursor-based Pagination (created_at / _id)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../database/cursor-pagination.html#id1">למה?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../database/cursor-pagination.html#id2">עקרונות מיון יציב</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../database/cursor-pagination.html#python">קידוד/פענוח קורסור (Python)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../database/cursor-pagination.html#id3">תבנית שאילתה (חדש → ישן)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../database/cursor-pagination.html#pymongo">PyMongo – דוגמה מלאה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../database/cursor-pagination.html#id4">דפדוף לאחור (ישן → חדש)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../database/cursor-pagination.html#copypaste">בדיקות ידניות (Copy‑Paste)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../database/cursor-pagination.html#id5">שיטות עבודה מומלצות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../database/cursor-pagination.html#gotchas">Gotchas נפוצים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../database/cursor-pagination.html#id6">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../database-schema.html">Database Schema</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../database-schema.html#collections">Collections</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../database-schema.html#code-snippets"><code class="docutils literal notranslate"><span class="pre">code_snippets</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../database-schema.html#users"><code class="docutils literal notranslate"><span class="pre">users</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../database-schema.html#bookmarks"><code class="docutils literal notranslate"><span class="pre">bookmarks</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../database-schema.html#sessions-webapp"><code class="docutils literal notranslate"><span class="pre">sessions</span></code> (WebApp)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../database-schema.html#indexes">Indexes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../database-schema.html#relationships">Relationships</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../database-schema.html#id1">קישורים</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">עזרה ודוגמאות:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">דוגמאות שימוש</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../examples.html#id2">שימוש בסיסי</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples.html#id3">יצירת אפליקציית בוט</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples.html#id4">שמירת קוד חדש</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples.html#id5">חיפוש קוד</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples.html#handlers">שימוש ב-Handlers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples.html#command-handler">יצירת Command Handler</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples.html#conversation-handler">יצירת Conversation Handler</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples.html#services">שימוש ב-Services</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples.html#id6">זיהוי שפת תכנות</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples.html#id7">ניתוח קוד</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples.html#github">אינטגרציה עם GitHub</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples.html#gist">העלאת קוד ל-Gist</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples.html#gists">שליפת Gists של משתמש</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples.html#id8">עבודה עם מסד הנתונים</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples.html#id9">ביצוע שאילתות מורכבות</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples.html#id10">עדכון קבצים</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples.html#id11">סטטיסטיקות</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples.html#id12">טיפול בשגיאות</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples.html#id13">טיפול בשגיאות בסיסי</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples.html#retry-logic">Retry Logic</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples.html#id14">בדיקות</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples.html#id15">בדיקת יחידה</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples.html#id16">בדיקת אינטגרציה</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples.html#id17">דוגמאות מתקדמות</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples.html#id18">עיבוד באצווה</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples.html#id19">קאשינג</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../testing.html">Testing Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../testing.html#id1">עקרונות קריטיים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../testing.html#tmp-path">דוגמת שימוש ב‑tmp_path</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../testing.html#id2">מחיקה בטוחה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../testing.html#mocking-telegram">Mocking ל‑Telegram</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../testing.html#id3">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../ci-cd.html">CI/CD Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../ci-cd.html#id1">חוקים קשיחים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ci-cd.html#id2">סטטוסים נדרשים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ci-cd.html#id3">בדיקות מומלצות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ci-cd.html#id4">בנייה של התיעוד</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ci-cd.html#id5">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../conversation-handlers.html">Conversation Handlers &amp; States</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../conversation-handlers.html#id1">סקירה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../conversation-handlers.html#states">רשימת States (מבחר בפועל)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../conversation-handlers.html#save-flow">Save Flow (תרשים מצבים)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../conversation-handlers.html#github-flow">GitHub Flow (תרשים מצבים)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../conversation-handlers.html#handler">דוגמת Handler תמציתית</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../conversation-handlers.html#id2">טבלת זרימות מלאה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../conversation-handlers.html#id3">קישורים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../conversation-handlers.html#id4">דוגמאות קוד תמציתיות (ממשיות)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../conversation-handlers.html#save">Save – שלבים עיקריים</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../conversation-handlers.html#github">GitHub – תפריט ושיחת העלאה</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../conversation-handlers.html#backup">Backup – תפריט</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../conversation-handlers.html#drive">Drive – תפריט</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../conversation-handlers.html#id5">מוקשים נפוצים ופתרונות</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../conversation-handlers.html#query-answer"><code class="docutils literal notranslate"><span class="pre">query.answer()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../conversation-handlers.html#message-is-not-modified">עריכת הודעות בבטחה – ”Message is not modified“</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../conversation-handlers.html#filters">Filters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../conversation-handlers.html#persistent-data-context-user-data">Persistent data (<code class="docutils literal notranslate"><span class="pre">context.user_data</span></code>)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../conversation-handlers.html#id6">דוגמאות טסטים קצרות</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../conversation-handlers.html#id7">Save – התחלה וזרימה בסיסית</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../conversation-handlers.html#github-upload-conv-handler">GitHub – upload_conv_handler</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../troubleshooting.html">Troubleshooting Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../troubleshooting.html#id1">שגיאות נפוצות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../troubleshooting.html#id2">דיבוג מהיר</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../troubleshooting.html#mongodb">בדיקת חיבור MongoDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../troubleshooting.html#id3">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../development.html">Development Workflow</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../development.html#handler">הוספת Handler חדש</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../development.html#endpoint-webapp">הוספת Endpoint ל‑WebApp</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../development.html#schema">עדכון Schema במסד הנתונים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../development.html#id1">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../integrations.html">Integrations</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../integrations.html#github-api">GitHub API</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../integrations.html#gist">יצירת Gist (דוגמה)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../integrations.html#google-drive-oauth-flow">Google Drive (OAuth Flow)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../integrations.html#telegram-webhooks-vs-polling">Telegram Webhooks vs Polling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../integrations.html#id1">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../security.html">Security Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../security.html#id1">סודות ופרטיות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../security.html#id2">הצפנת טוקנים (דוגמה)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../security.html#csrf-webapp">CSRF ב‑WebApp</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../security.html#rate-limiting">Rate Limiting (דוגמה)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../security.html#id3">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/share_code.html">שיתוף קוד (חשוב)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../user/share_code.html#id2">מה זה עושה?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user/share_code.html#id3">איפה הכפתור מופיע?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user/share_code.html#id4">איך זה עובד (זרימה)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user/share_code.html#env">דרישות סביבתיות (ENV)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user/share_code.html#id5">מגבלות והתנהגות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user/share_code.html#id6">הודעות הצלחה/שגיאה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user/share_code.html#troubleshooting">Troubleshooting קצר</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user/share_code.html#id7">דוגמאות (טקסטואליות)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/github_browse.html">עיון בקוד GitHub (כולל חיפוש בשם קובץ)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../user/github_browse.html#id1">שורת כלים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user/github_browse.html#id2">תוצאות חיפוש</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user/github_browse.html#id3">ניווט ריפו</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/download_repo.html">הורדת ריפו</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../user/download_repo.html#id2">מה בדיוק מוריד</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user/download_repo.html#id3">מגבלות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user/download_repo.html#id4">הודעות נפוצות</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">WebApp:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../webapp/overview.html">המיני Web App (סקירה)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../webapp/overview.html#id1">מה נותן?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../webapp/overview.html#id2">כתובת והרשאות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../webapp/overview.html#env">הגדרות ENV</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../webapp/overview.html#id3">קישורים ותמונות מסך</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../webapp/caching.html">Caching &amp; HTTP Validators (ETag / Last-Modified / 304)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../webapp/caching.html#id1">למה זה חשוב?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../webapp/caching.html#id2">עקרונות בסיס</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../webapp/caching.html#flask-werkzeug">מתכון: Flask + werkzeug</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../webapp/caching.html#copypaste">בדיקות ידניות (Copy‑Paste)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../webapp/caching.html#checklist">Checklist למימוש נכון</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../webapp/caching.html#gotchas">Gotchas נפוצים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../webapp/caching.html#cache-control">שילוב עם Cache-Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../webapp/caching.html#id3">קישורים נוספים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../webapp/static-checklist.html">Static Performance &amp; Security Checklist (gzip/br, Cache, SRI)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../webapp/static-checklist.html#id1">מטרה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../webapp/static-checklist.html#br-gzip">דחיסה (br/gzip)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../webapp/static-checklist.html#cache-control">כותרות Cache-Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../webapp/static-checklist.html#subresource-integrity-sri">Subresource Integrity (SRI)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../webapp/static-checklist.html#copypaste">בדיקות ידניות (Copy‑Paste)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../webapp/static-checklist.html#best-practices">Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../webapp/static-checklist.html#gotchas">Gotchas</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../webapp/api-reference.html">WebApp API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../webapp/api-reference.html#endpoints">Endpoints</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../webapp/api-reference.html#authentication-flow">Authentication Flow</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../webapp/api-reference.html#response-schema-example">Response Schema Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../webapp/api-reference.html#errors">Errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../webapp/api-reference.html#id1">קישורים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../webapp/api-reference.html#files">מסנן ושדות קלט ל-<code class="docutils literal notranslate"><span class="pre">/files</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../webapp/api-reference.html#id2">טבלת פרמטרים</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../webapp/api-reference.html#id3">דוגמאות בקשה</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../webapp/api-reference.html#id4">דוגמאות תגובה</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Code Keeper Bot</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">handlers.drive.menu</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>הראה קוד מקור ל handlers.drive.menu</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timezone</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">zoneinfo</span> <span class="kn">import</span> <span class="n">ZoneInfo</span>  <span class="c1"># Python 3.9+</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
    <span class="n">ZoneInfo</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore[assignment]</span>

<span class="kn">from</span> <span class="nn">telegram</span> <span class="kn">import</span> <span class="n">InlineKeyboardButton</span><span class="p">,</span> <span class="n">InlineKeyboardMarkup</span><span class="p">,</span> <span class="n">Update</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">telegram.error</span> <span class="kn">import</span> <span class="n">BadRequest</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
    <span class="n">BadRequest</span> <span class="o">=</span> <span class="ne">Exception</span>  <span class="c1"># type: ignore[assignment]</span>
<span class="kn">from</span> <span class="nn">telegram.ext</span> <span class="kn">import</span> <span class="n">ContextTypes</span>

<span class="kn">from</span> <span class="nn">services</span> <span class="kn">import</span> <span class="n">google_drive_service</span> <span class="k">as</span> <span class="n">gdrive</span>
<span class="kn">from</span> <span class="nn">config</span> <span class="kn">import</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">file_manager</span> <span class="kn">import</span> <span class="n">backup_manager</span>
<span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>


<div class="viewcode-block" id="GoogleDriveMenuHandler">
<a class="viewcode-back" href="../../../handlers/drive_menu.html#handlers.drive.menu.GoogleDriveMenuHandler">[תיעוד]</a>
<span class="k">class</span> <span class="nc">GoogleDriveMenuHandler</span><span class="p">:</span>
<div class="viewcode-block" id="GoogleDriveMenuHandler.__init__">
<a class="viewcode-back" href="../../../handlers/drive_menu.html#handlers.drive.menu.GoogleDriveMenuHandler.__init__">[תיעוד]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span></div>


    <span class="k">def</span> <span class="nf">_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_is_uploading</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;uploading&quot;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_begin_upload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">sess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sess</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;uploading&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">sess</span><span class="p">[</span><span class="s2">&quot;uploading&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_end_upload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)[</span><span class="s2">&quot;uploading&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_ensure_schedule_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">sched_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">seconds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interval_seconds</span><span class="p">(</span><span class="n">sched_key</span><span class="p">)</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">_scheduled_backup_cb</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">uid</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">]</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="n">gdrive</span><span class="o">.</span><span class="n">perform_scheduled_backup</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">chat_id</span><span class="o">=</span><span class="n">uid</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;☁️ גיבוי אוטומטי ל‑Drive הושלם בהצלחה&quot;</span><span class="p">)</span>
                <span class="c1"># עדכן זמן הבא בהעדפות</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">now_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
                    <span class="n">next_dt</span> <span class="o">=</span> <span class="n">now_dt</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">seconds</span><span class="p">)</span>
                    <span class="n">update_prefs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;last_backup_at&quot;</span><span class="p">:</span> <span class="n">now_dt</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span> <span class="s2">&quot;schedule_next_at&quot;</span><span class="p">:</span> <span class="n">next_dt</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()}</span>
                    <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                        <span class="n">update_prefs</span><span class="p">[</span><span class="s2">&quot;last_full_backup_at&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">now_dt</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">save_drive_prefs</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">update_prefs</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">jobs</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">bot_data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;drive_schedule_jobs&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="c1"># cancel existing</span>
            <span class="n">old</span> <span class="o">=</span> <span class="n">jobs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">old</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">old</span><span class="o">.</span><span class="n">schedule_removal</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="c1"># קבע first להרצה הבאה: העדף schedule_next_at קיים, אחרת last_full_backup_at/last_backup_at כשהוא מגולגל קדימה עד לעתיד, אחרת now</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">prefs</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_drive_prefs</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">prefs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">now_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
            <span class="c1"># parse existing next</span>
            <span class="n">nxt_iso</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;schedule_next_at&quot;</span><span class="p">)</span>
            <span class="n">nxt_dt</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nxt_iso</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">nxt_iso</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">nxt_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">nxt_iso</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">nxt_dt</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># parse last full backup (prefer), fallback to generic last_backup_at</span>
            <span class="n">last_full_iso</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;last_full_backup_at&quot;</span><span class="p">)</span>
            <span class="n">last_full_dt</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">last_full_iso</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">last_full_iso</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">last_full_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">last_full_iso</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">last_full_dt</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">last_iso</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;last_backup_at&quot;</span><span class="p">)</span>
            <span class="n">last_dt</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">last_full_dt</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">last_iso</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">last_iso</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">last_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">last_iso</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">last_dt</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># choose planned_next</span>
            <span class="n">planned_next</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">nxt_dt</span> <span class="ow">and</span> <span class="n">nxt_dt</span> <span class="o">&gt;</span> <span class="n">now_dt</span><span class="p">:</span>
                <span class="n">planned_next</span> <span class="o">=</span> <span class="n">nxt_dt</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">base_last</span> <span class="o">=</span> <span class="n">last_full_dt</span> <span class="ow">or</span> <span class="n">last_dt</span>
                <span class="k">if</span> <span class="n">base_last</span><span class="p">:</span>
                    <span class="n">candidate</span> <span class="o">=</span> <span class="n">base_last</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">seconds</span><span class="p">)</span>
                    <span class="c1"># Roll forward in fixed intervals until in the future</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">520</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">candidate</span> <span class="o">&gt;</span> <span class="n">now_dt</span><span class="p">:</span>
                                <span class="k">break</span>
                            <span class="n">candidate</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">seconds</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="n">planned_next</span> <span class="o">=</span> <span class="n">candidate</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">planned_next</span> <span class="o">=</span> <span class="n">now_dt</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">seconds</span><span class="p">)</span>
            <span class="n">delta_secs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">planned_next</span> <span class="o">-</span> <span class="n">now_dt</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>
            <span class="n">first_seconds</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">delta_secs</span><span class="p">)</span>
            <span class="n">job</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">job_queue</span><span class="o">.</span><span class="n">run_repeating</span><span class="p">(</span>
                <span class="n">_scheduled_backup_cb</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="n">seconds</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="n">first_seconds</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;drive_</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">}</span>
            <span class="p">)</span>
            <span class="n">jobs</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span>
            <span class="c1"># אל תדרוס schedule_next_at קיים ותקין; עדכן רק אם חסר/עבר</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">nxt_dt</span> <span class="ow">or</span> <span class="n">nxt_dt</span> <span class="o">&lt;=</span> <span class="n">now_dt</span><span class="p">:</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">save_drive_prefs</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;schedule_next_at&quot;</span><span class="p">:</span> <span class="n">planned_next</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()})</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

<div class="viewcode-block" id="GoogleDriveMenuHandler.menu">
<a class="viewcode-back" href="../../../handlers/drive_menu.html#handlers.drive.menu.GoogleDriveMenuHandler.menu">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
        <span class="c1"># Feature flag: allow fallback to old behavior if disabled</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">DRIVE_MENU_V2</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span> <span class="k">if</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;התכונה כבויה כרגע (DRIVE_MENU_V2=false)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;התכונה כבויה כרגע (DRIVE_MENU_V2=false)&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span> <span class="k">if</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>
            <span class="n">send</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">send</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span>

        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_drive_tokens</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

        <span class="c1"># נחשיב &quot;מחובר&quot; אם יש טוקנים שמורים; בדיקת שירות בפועל תעשה לפני העלאה</span>
        <span class="c1"># זה מונע מצב מבלבל שבו מוצג &quot;לא מחובר&quot; מיד אחרי התחברות מוצלחת</span>
        <span class="n">service_ready</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">service_ready</span><span class="p">:</span>
            <span class="n">kb</span> <span class="o">=</span> <span class="p">[[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔐 התחבר ל‑Drive&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_auth&quot;</span><span class="p">)]]</span>
            <span class="k">await</span> <span class="n">send</span><span class="p">(</span><span class="s2">&quot;Google Drive</span><span class="se">\n\n</span><span class="s2">לא מחובר. התחבר כדי לגבות לקבצי Drive.&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="c1"># Ensure schedule job exists if a schedule is configured (after restart/deploy)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">prefs</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_drive_prefs</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="n">sched_key</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;schedule&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sched_key</span><span class="p">:</span>
                <span class="n">jobs</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">bot_data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;drive_schedule_jobs&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">jobs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_schedule_job</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">sched_key</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="c1"># Hydrate session with persisted preferences so selections survive deploys</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_hydrate_session_from_prefs</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="c1"># Connected -&gt; show main backup selection directly per requested flow</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_render_simple_selection</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">header_prefix</span><span class="o">=</span><span class="s2">&quot;Google Drive — מחובר</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="GoogleDriveMenuHandler.handle_callback">
<a class="viewcode-back" href="../../../handlers/drive_menu.html#handlers.drive.menu.GoogleDriveMenuHandler.handle_callback">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">handle_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;drive_menu&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># Backward compatibility: map old callback to new one</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;drive_advanced&quot;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="s2">&quot;drive_sel_adv&quot;</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;drive_auth&quot;</span><span class="p">:</span>
            <span class="nb">__import__</span><span class="p">(</span><span class="s1">&#39;logging&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Drive: start auth by user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">flow</span> <span class="o">=</span> <span class="n">gdrive</span><span class="o">.</span><span class="n">start_device_authorization</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># הצג שגיאה ידידותית כאשר קונפיגורציית OAuth חסרה/שגויה או כשיש בעיית רשת</span>
                <span class="n">kb</span> <span class="o">=</span> <span class="p">[[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזרה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_menu&quot;</span><span class="p">)]]</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;❌ לא ניתן להתחבר ל‑Drive.</span><span class="se">\n</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">בדוק שהוגדר GOOGLE_CLIENT_ID (ו‑GOOGLE_CLIENT_SECRET אם נדרש) ושההרשאות תקינות.&quot;</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">return</span>
            <span class="n">sess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">sess</span><span class="p">[</span><span class="s2">&quot;device_code&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;device_code&quot;</span><span class="p">)</span>
            <span class="n">sess</span><span class="p">[</span><span class="s2">&quot;interval&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">flow</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;interval&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)))</span>
            <span class="n">sess</span><span class="p">[</span><span class="s2">&quot;auth_expires_at&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">__import__</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">time</span><span class="p">())</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">flow</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;expires_in&quot;</span><span class="p">,</span> <span class="mi">1800</span><span class="p">))</span>
            <span class="c1"># schedule polling job</span>
            <span class="n">jobs</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">bot_data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;drive_auth_jobs&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="c1"># cancel old if exists</span>
            <span class="n">old</span> <span class="o">=</span> <span class="n">jobs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">old</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">old</span><span class="o">.</span><span class="n">schedule_removal</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">async</span> <span class="k">def</span> <span class="nf">_poll_once</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">uid</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">)</span>
                    <span class="n">chat_id</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;chat_id&quot;</span><span class="p">)</span>
                    <span class="n">message_id</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message_id&quot;</span><span class="p">)</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
                    <span class="n">dc</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;device_code&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">dc</span><span class="p">:</span>
                        <span class="k">return</span>
                    <span class="c1"># Expiry guard: stop polling and notify</span>
                    <span class="kn">import</span> <span class="nn">time</span> <span class="k">as</span> <span class="nn">_t</span>
                    <span class="n">exp</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;auth_expires_at&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="n">exp</span> <span class="ow">and</span> <span class="n">_t</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">exp</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">ctx</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">schedule_removal</span><span class="p">()</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="n">ctx</span><span class="o">.</span><span class="n">bot_data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;drive_auth_jobs&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="n">s</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;device_code&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                                <span class="n">chat_id</span><span class="o">=</span><span class="n">chat_id</span><span class="p">,</span>
                                <span class="n">message_id</span><span class="o">=</span><span class="n">message_id</span><span class="p">,</span>
                                <span class="n">text</span><span class="o">=</span><span class="s2">&quot;⌛ פג תוקף בקשת ההתחברות. לחץ שוב על </span><span class="se">\&quot;</span><span class="s2">התחבר ל‑Drive</span><span class="se">\&quot;</span><span class="s2">.&quot;</span><span class="p">,</span>
                                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">([[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔐 התחבר ל‑Drive&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_auth&quot;</span><span class="p">)]])</span>
                            <span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="k">return</span>
                    <span class="n">tokens</span> <span class="o">=</span> <span class="n">gdrive</span><span class="o">.</span><span class="n">poll_device_token</span><span class="p">(</span><span class="n">dc</span><span class="p">)</span>
                    <span class="c1"># None =&gt; עדיין ממתינים; dict עם error =&gt; לא לשמור, להמתין</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">tokens</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">tokens</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">)):</span>
                        <span class="k">return</span>
                    <span class="c1"># הצלחה: שמירה והודעה</span>
                    <span class="n">gdrive</span><span class="o">.</span><span class="n">save_tokens</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">tokens</span><span class="p">)</span>  <span class="c1"># type: ignore[arg-type]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">ctx</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">schedule_removal</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="n">jobs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;device_code&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                            <span class="n">chat_id</span><span class="o">=</span><span class="n">chat_id</span><span class="p">,</span>
                            <span class="n">message_id</span><span class="o">=</span><span class="n">message_id</span><span class="p">,</span>
                            <span class="n">text</span><span class="o">=</span><span class="s2">&quot;✅ חיבור ל‑Drive הושלם!&quot;</span>
                        <span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">job</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">job_queue</span><span class="o">.</span><span class="n">run_repeating</span><span class="p">(</span>
                    <span class="n">_poll_once</span><span class="p">,</span>
                    <span class="n">interval</span><span class="o">=</span><span class="n">sess</span><span class="p">[</span><span class="s2">&quot;interval&quot;</span><span class="p">],</span>
                    <span class="n">first</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;drive_auth_</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span> <span class="s2">&quot;chat_id&quot;</span><span class="p">:</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">chat_id</span><span class="p">,</span> <span class="s2">&quot;message_id&quot;</span><span class="p">:</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">message_id</span><span class="p">}</span>
                <span class="p">)</span>
                <span class="n">jobs</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="c1"># show instruction with buttons</span>
            <span class="c1"># enable manual code paste fallback</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_drive_code&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;🔐 התחברות ל‑Google Drive</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;גש לכתובת: </span><span class="si">{</span><span class="n">flow</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;verification_url&#39;</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;קוד: &lt;code&gt;</span><span class="si">{</span><span class="n">flow</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_code&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;ℹ️ טיפ: לחצו על הקוד כדי להעתיק אותו ללוח, ואז לחצו על הקישור והדביקו את הקוד בדפדפן.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;לאחר האישור, לחץ על ׳🔄 בדוק חיבור׳ או המתן לאימות אוטומטי.&quot;</span>
            <span class="p">)</span>
            <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔄 בדוק חיבור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_poll_once&quot;</span><span class="p">)],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;❌ בטל&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_cancel_auth&quot;</span><span class="p">)],</span>
            <span class="p">]</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;drive_poll_once&quot;</span><span class="p">:</span>
            <span class="nb">__import__</span><span class="p">(</span><span class="s1">&#39;logging&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Drive: manual poll token by user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">sess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">dc</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;device_code&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dc</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;אין בקשת התחברות פעילה&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tokens</span> <span class="o">=</span> <span class="n">gdrive</span><span class="o">.</span><span class="n">poll_device_token</span><span class="p">(</span><span class="n">dc</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">tokens</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">tokens</span><span class="p">:</span>
                <span class="c1"># Visible feedback in message</span>
                <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;🔐 התחברות ל‑Google Drive</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;⌛ עדיין ממתינים לאישור בדפדפן…</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;ℹ️ טיפ: לחצו על הקוד שהוצג בהודעה הקודמת כדי להעתיק, פתחו את הקישור והדביקו את הקוד בדפדפן.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;לאחר האישור, לחץ על ׳🔄 בדוק חיבור׳ או המתן לאימות אוטומטי.&quot;</span>
                <span class="p">)</span>
                <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔄 בדוק חיבור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_poll_once&quot;</span><span class="p">)],</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;❌ בטל&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_cancel_auth&quot;</span><span class="p">)],</span>
                <span class="p">]</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">tokens</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">):</span>
                <span class="n">err</span> <span class="o">=</span> <span class="n">tokens</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
                <span class="n">desc</span> <span class="o">=</span> <span class="n">tokens</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error_description&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;בקשה נדחתה. נא לאשר בדפדפן ולנסות שוב.&quot;</span>
                <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔄 בדוק חיבור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_poll_once&quot;</span><span class="p">)],</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;❌ בטל&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_cancel_auth&quot;</span><span class="p">)],</span>
                <span class="p">]</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">desc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>
                <span class="k">return</span>
            <span class="n">gdrive</span><span class="o">.</span><span class="n">save_tokens</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">tokens</span><span class="p">)</span>
            <span class="c1"># cancel background job if exists</span>
            <span class="n">jobs</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">bot_data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;drive_auth_jobs&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">job</span> <span class="o">=</span> <span class="n">jobs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">job</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">job</span><span class="o">.</span><span class="n">schedule_removal</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="nb">__import__</span><span class="p">(</span><span class="s1">&#39;logging&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Drive: auth completed for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;✅ חיבור ל‑Drive הושלם!&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;drive_cancel_auth&quot;</span><span class="p">:</span>
            <span class="n">sess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">sess</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;device_code&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">jobs</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">bot_data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;drive_auth_jobs&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">job</span> <span class="o">=</span> <span class="n">jobs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">job</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">job</span><span class="o">.</span><span class="n">schedule_removal</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;ביטלת את ההתחברות ל‑Drive.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;drive_backup_now&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_render_simple_selection</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;drive_sel_zip&quot;</span><span class="p">:</span>
            <span class="c1"># בחר קטגוריית ZIP בלבד (ללא העלאה מיידית); ההעלאה תתבצע רק בלחיצה על &quot;אישור&quot;</span>
            <span class="c1"># הצג הודעה אם אין ZIPים שמורים כדי שהמשתמש ידע מה יקרה באישור</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">existing</span> <span class="o">=</span> <span class="n">backup_manager</span><span class="o">.</span><span class="n">list_backups</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
                <span class="n">saved_zips</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">existing</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s1">&#39;file_path&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.zip&#39;</span><span class="p">)]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">saved_zips</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">sess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sess</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_category&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;zip&quot;</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;כבר נבחר &#39;קבצי ZIP&#39;&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">sess</span><span class="p">[</span><span class="s2">&quot;selected_category&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;zip&quot;</span>
            <span class="c1"># שמירת בחירה אחרונה בפרפרנסים כדי שתשרוד דיפלוי</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">db</span><span class="o">.</span><span class="n">save_drive_prefs</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;last_selected_category&quot;</span><span class="p">:</span> <span class="s2">&quot;zip&quot;</span><span class="p">})</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;ℹ️ לא נמצאו קבצי ZIP שמורים בבוט. באישור לא יועלה דבר.</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">saved_zips</span> <span class="k">else</span> <span class="s2">&quot;✅ נבחר: קבצי ZIP</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_render_simple_selection</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">header_prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;drive_sel_all&quot;</span><span class="p">:</span>
            <span class="c1"># בחר קטגוריית &quot;הכל&quot; (ללא העלאה מיידית); ההעלאה תתבצע רק בלחיצה על &quot;אישור&quot;</span>
            <span class="n">sess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sess</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_category&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;כבר נבחר &#39;הכל&#39;&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">sess</span><span class="p">[</span><span class="s2">&quot;selected_category&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">db</span><span class="o">.</span><span class="n">save_drive_prefs</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;last_selected_category&quot;</span><span class="p">:</span> <span class="s2">&quot;all&quot;</span><span class="p">})</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_render_simple_selection</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">header_prefix</span><span class="o">=</span><span class="s2">&quot;✅ נבחר: הכל</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;drive_sel_adv&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_render_advanced_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;drive_adv_by_repo&quot;</span><span class="p">,</span> <span class="s2">&quot;drive_adv_large&quot;</span><span class="p">,</span> <span class="s2">&quot;drive_adv_other&quot;</span><span class="p">}:</span>
            <span class="c1"># Ensure Drive service ready</span>
            <span class="k">if</span> <span class="n">gdrive</span><span class="o">.</span><span class="n">get_drive_service</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔐 התחבר ל‑Drive&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_auth&quot;</span><span class="p">)],</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזרה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_sel_adv&quot;</span><span class="p">)],</span>
                <span class="p">]</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ לא ניתן לגשת ל‑Drive כרגע. נסה להתחבר מחדש או לבדוק הרשאות.&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>
                <span class="k">return</span>
            <span class="n">category</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;drive_adv_by_repo&quot;</span><span class="p">:</span> <span class="s2">&quot;by_repo&quot;</span><span class="p">,</span>
                <span class="s2">&quot;drive_adv_large&quot;</span><span class="p">:</span> <span class="s2">&quot;large&quot;</span><span class="p">,</span>
                <span class="s2">&quot;drive_adv_other&quot;</span><span class="p">:</span> <span class="s2">&quot;other&quot;</span><span class="p">,</span>
            <span class="p">}[</span><span class="n">data</span><span class="p">]</span>
            <span class="n">sess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sess</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;adv_multi&quot;</span><span class="p">):</span>
                <span class="n">selected</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;adv_selected&quot;</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>
                <span class="n">selected</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">category</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_render_advanced_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">header_prefix</span><span class="o">=</span><span class="s2">&quot;✅ נוסף לבחירה. ניתן לבחור עוד אפשרויות או להעלות.</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Immediate upload per category with better empty-state handling</span>
                <span class="k">if</span> <span class="n">category</span> <span class="o">==</span> <span class="s2">&quot;by_repo&quot;</span><span class="p">:</span>
                    <span class="n">grouped</span> <span class="o">=</span> <span class="n">gdrive</span><span class="o">.</span><span class="n">create_repo_grouped_zip_bytes</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">grouped</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;ℹ️ לא נמצאו קבצים מקוטלגים לפי ריפו להעלאה.&quot;</span><span class="p">)</span>
                        <span class="k">return</span>
                    <span class="n">ok_any</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">for</span> <span class="n">repo_name</span><span class="p">,</span> <span class="n">suggested</span><span class="p">,</span> <span class="n">data_bytes</span> <span class="ow">in</span> <span class="n">grouped</span><span class="p">:</span>
                        <span class="n">friendly</span> <span class="o">=</span> <span class="n">gdrive</span><span class="o">.</span><span class="n">compute_friendly_name</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="s2">&quot;by_repo&quot;</span><span class="p">,</span> <span class="n">repo_name</span><span class="p">,</span> <span class="n">content_sample</span><span class="o">=</span><span class="n">data_bytes</span><span class="p">[:</span><span class="mi">1024</span><span class="p">])</span>
                        <span class="n">sub_path</span> <span class="o">=</span> <span class="n">gdrive</span><span class="o">.</span><span class="n">compute_subpath</span><span class="p">(</span><span class="s2">&quot;by_repo&quot;</span><span class="p">,</span> <span class="n">repo_name</span><span class="p">)</span>
                        <span class="n">fid</span> <span class="o">=</span> <span class="n">gdrive</span><span class="o">.</span><span class="n">upload_bytes</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">friendly</span><span class="p">,</span> <span class="n">data_bytes</span><span class="p">,</span> <span class="n">sub_path</span><span class="o">=</span><span class="n">sub_path</span><span class="p">)</span>
                        <span class="n">ok_any</span> <span class="o">=</span> <span class="n">ok_any</span> <span class="ow">or</span> <span class="nb">bool</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ok_any</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;✅ הועלו גיבויי ריפו לפי תיקיות&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔐 התחבר ל‑Drive&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_auth&quot;</span><span class="p">)],</span>
                            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזרה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_sel_adv&quot;</span><span class="p">)],</span>
                        <span class="p">]</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ כשל בהעלאה. נסה להתחבר מחדש או לבדוק הרשאות.&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Pre-check category has files</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span> <span class="k">as</span> <span class="n">_db</span>
                        <span class="n">has_any</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">if</span> <span class="n">category</span> <span class="o">==</span> <span class="s2">&quot;large&quot;</span><span class="p">:</span>
                            <span class="n">large_files</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">get_user_large_files</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">per_page</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                            <span class="n">has_any</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">large_files</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">category</span> <span class="o">==</span> <span class="s2">&quot;other&quot;</span><span class="p">:</span>
                            <span class="n">files</span> <span class="o">=</span> <span class="n">_db</span><span class="o">.</span><span class="n">get_user_files</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
                            <span class="c1"># other = not repo tagged</span>
                            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                                <span class="n">tags</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">((</span><span class="n">t</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;repo:&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">):</span>
                                    <span class="n">has_any</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="k">break</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">has_any</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">has_any</span><span class="p">:</span>
                        <span class="n">label_map</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;large&quot;</span><span class="p">:</span> <span class="s2">&quot;קבצים גדולים&quot;</span><span class="p">,</span> <span class="s2">&quot;other&quot;</span><span class="p">:</span> <span class="s2">&quot;שאר קבצים&quot;</span><span class="p">}</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ℹ️ אין פריטים זמינים בקטגוריה: </span><span class="si">{</span><span class="n">label_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">category</span><span class="p">,</span><span class="w"> </span><span class="n">category</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                        <span class="k">return</span>
                    <span class="n">fn</span><span class="p">,</span> <span class="n">data_bytes</span> <span class="o">=</span> <span class="n">gdrive</span><span class="o">.</span><span class="n">create_full_backup_zip_bytes</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">category</span><span class="p">)</span>
                    <span class="kn">from</span> <span class="nn">config</span> <span class="kn">import</span> <span class="n">config</span> <span class="k">as</span> <span class="n">_cfg</span>
                    <span class="n">friendly</span> <span class="o">=</span> <span class="n">gdrive</span><span class="o">.</span><span class="n">compute_friendly_name</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">_cfg</span><span class="p">,</span> <span class="s1">&#39;BOT_LABEL&#39;</span><span class="p">,</span> <span class="s1">&#39;CodeBot&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;CodeBot&#39;</span><span class="p">,</span> <span class="n">content_sample</span><span class="o">=</span><span class="n">data_bytes</span><span class="p">[:</span><span class="mi">1024</span><span class="p">])</span>
                    <span class="n">sub_path</span> <span class="o">=</span> <span class="n">gdrive</span><span class="o">.</span><span class="n">compute_subpath</span><span class="p">(</span><span class="n">category</span><span class="p">)</span>
                    <span class="n">fid</span> <span class="o">=</span> <span class="n">gdrive</span><span class="o">.</span><span class="n">upload_bytes</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">friendly</span><span class="p">,</span> <span class="n">data_bytes</span><span class="p">,</span> <span class="n">sub_path</span><span class="o">=</span><span class="n">sub_path</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">fid</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;✅ גיבוי הועלה ל‑Drive&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔐 התחבר ל‑Drive&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_auth&quot;</span><span class="p">)],</span>
                            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזרה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_sel_adv&quot;</span><span class="p">)],</span>
                        <span class="p">]</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ כשל בהעלאה. נסה להתחבר מחדש או לבדוק הרשאות.&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;drive_adv_multi_toggle&quot;</span><span class="p">:</span>
            <span class="n">sess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">sess</span><span class="p">[</span><span class="s2">&quot;adv_multi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="n">sess</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;adv_multi&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
            <span class="n">multi_on</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">sess</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;adv_multi&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
            <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;לפי ריפו&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_adv_by_repo&quot;</span><span class="p">)],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;קבצים גדולים&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_adv_large&quot;</span><span class="p">)],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;שאר קבצים&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_adv_other&quot;</span><span class="p">)],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">((</span><span class="s2">&quot;✅ אפשרות מרובה&quot;</span> <span class="k">if</span> <span class="n">multi_on</span> <span class="k">else</span> <span class="s2">&quot;⬜ אפשרות מרובה&quot;</span><span class="p">),</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_adv_multi_toggle&quot;</span><span class="p">)],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;⬆️ העלה נבחרים&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_adv_upload_selected&quot;</span><span class="p">)],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזרה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_backup_now&quot;</span><span class="p">)],</span>
            <span class="p">]</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;בחר קטגוריה מתקדמת:&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;drive_adv_upload_selected&quot;</span><span class="p">:</span>
            <span class="n">sess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">cats</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sess</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;adv_selected&quot;</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span> <span class="ow">or</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">cats</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;לא נבחרו אפשרויות&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">uploaded_any</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cats</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;by_repo&quot;</span><span class="p">:</span>
                    <span class="n">grouped</span> <span class="o">=</span> <span class="n">gdrive</span><span class="o">.</span><span class="n">create_repo_grouped_zip_bytes</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">repo_name</span><span class="p">,</span> <span class="n">suggested</span><span class="p">,</span> <span class="n">data_bytes</span> <span class="ow">in</span> <span class="n">grouped</span><span class="p">:</span>
                        <span class="n">friendly</span> <span class="o">=</span> <span class="n">gdrive</span><span class="o">.</span><span class="n">compute_friendly_name</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="s2">&quot;by_repo&quot;</span><span class="p">,</span> <span class="n">repo_name</span><span class="p">,</span> <span class="n">content_sample</span><span class="o">=</span><span class="n">data_bytes</span><span class="p">[:</span><span class="mi">1024</span><span class="p">])</span>
                        <span class="n">sub_path</span> <span class="o">=</span> <span class="n">gdrive</span><span class="o">.</span><span class="n">compute_subpath</span><span class="p">(</span><span class="s2">&quot;by_repo&quot;</span><span class="p">,</span> <span class="n">repo_name</span><span class="p">)</span>
                        <span class="n">fid</span> <span class="o">=</span> <span class="n">gdrive</span><span class="o">.</span><span class="n">upload_bytes</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">friendly</span><span class="p">,</span> <span class="n">data_bytes</span><span class="p">,</span> <span class="n">sub_path</span><span class="o">=</span><span class="n">sub_path</span><span class="p">)</span>
                        <span class="n">uploaded_any</span> <span class="o">=</span> <span class="n">uploaded_any</span> <span class="ow">or</span> <span class="nb">bool</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fn</span><span class="p">,</span> <span class="n">data_bytes</span> <span class="o">=</span> <span class="n">gdrive</span><span class="o">.</span><span class="n">create_full_backup_zip_bytes</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
                    <span class="kn">from</span> <span class="nn">config</span> <span class="kn">import</span> <span class="n">config</span> <span class="k">as</span> <span class="n">_cfg</span>
                    <span class="n">friendly</span> <span class="o">=</span> <span class="n">gdrive</span><span class="o">.</span><span class="n">compute_friendly_name</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">_cfg</span><span class="p">,</span> <span class="s1">&#39;BOT_LABEL&#39;</span><span class="p">,</span> <span class="s1">&#39;CodeBot&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;CodeBot&#39;</span><span class="p">,</span> <span class="n">content_sample</span><span class="o">=</span><span class="n">data_bytes</span><span class="p">[:</span><span class="mi">1024</span><span class="p">])</span>
                    <span class="n">sub_path</span> <span class="o">=</span> <span class="n">gdrive</span><span class="o">.</span><span class="n">compute_subpath</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                    <span class="n">fid</span> <span class="o">=</span> <span class="n">gdrive</span><span class="o">.</span><span class="n">upload_bytes</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">friendly</span><span class="p">,</span> <span class="n">data_bytes</span><span class="p">,</span> <span class="n">sub_path</span><span class="o">=</span><span class="n">sub_path</span><span class="p">)</span>
                    <span class="n">uploaded_any</span> <span class="o">=</span> <span class="n">uploaded_any</span> <span class="ow">or</span> <span class="nb">bool</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
            <span class="n">sess</span><span class="p">[</span><span class="s2">&quot;adv_selected&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">uploaded_any</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;✅ הועלו הגיבויים שנבחרו&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔐 התחבר ל‑Drive&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_auth&quot;</span><span class="p">)],</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזרה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_sel_adv&quot;</span><span class="p">)],</span>
                <span class="p">]</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ כשל בהעלאה. נסה להתחבר מחדש או לבדוק הרשאות.&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;drive_choose_folder&quot;</span><span class="p">:</span>
            <span class="c1"># Remember current simple menu context</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)[</span><span class="s2">&quot;last_menu&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;simple&quot;</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_render_choose_folder_simple</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;drive_choose_folder_adv&quot;</span><span class="p">:</span>
            <span class="c1"># Advanced folder selection includes automatic arrangement explanation</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)[</span><span class="s2">&quot;last_menu&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;adv&quot;</span>
            <span class="n">explain</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;סידור תיקיות אוטומטי: הבוט יסדר בתוך &#39;גיבויי_קודלי&#39; לפי קטגוריות ותאריכים,</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;וב&#39;לפי ריפו&#39; גם תת‑תיקיות לפי שם הריפו.&quot;</span>
            <span class="p">)</span>
            <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🤖 סידור תיקיות אוטומטי (כמו בבוט)&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_folder_auto&quot;</span><span class="p">)],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📂 גיבויי_קודלי (ברירת מחדל)&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_folder_default&quot;</span><span class="p">)],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;✏️ הגדר נתיב מותאם (שלח טקסט)&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_folder_set&quot;</span><span class="p">)],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזרה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_sel_adv&quot;</span><span class="p">)],</span>
            <span class="p">]</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;בחר תיקיית יעד:</span><span class="se">\n\n</span><span class="si">{</span><span class="n">explain</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;drive_folder_default&quot;</span><span class="p">:</span>
            <span class="n">fid</span> <span class="o">=</span> <span class="n">gdrive</span><span class="o">.</span><span class="n">get_or_create_default_folder</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="c1"># Update session label</span>
            <span class="n">sess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">sess</span><span class="p">[</span><span class="s2">&quot;target_folder_label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;גיבויי_קודלי&quot;</span>
            <span class="n">sess</span><span class="p">[</span><span class="s2">&quot;target_folder_auto&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">db</span><span class="o">.</span><span class="n">save_drive_prefs</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;target_folder_label&quot;</span><span class="p">:</span> <span class="s2">&quot;גיבויי_קודלי&quot;</span><span class="p">,</span> <span class="s2">&quot;target_folder_auto&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;target_folder_path&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="c1"># Return to proper menu depending on origin (אל תציג כשל גם אם לא הצלחנו ליצור בפועל כרגע)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_render_after_folder_selection</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;drive_folder_auto&quot;</span><span class="p">:</span>
            <span class="c1"># Auto-arrangement: keep default folder but mark label as automatic</span>
            <span class="n">fid</span> <span class="o">=</span> <span class="n">gdrive</span><span class="o">.</span><span class="n">get_or_create_default_folder</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">sess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">sess</span><span class="p">[</span><span class="s2">&quot;target_folder_label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;אוטומטי&quot;</span>
            <span class="n">sess</span><span class="p">[</span><span class="s2">&quot;target_folder_auto&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">db</span><span class="o">.</span><span class="n">save_drive_prefs</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;target_folder_label&quot;</span><span class="p">:</span> <span class="s2">&quot;אוטומטי&quot;</span><span class="p">,</span> <span class="s2">&quot;target_folder_auto&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_render_after_folder_selection</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">success</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">fid</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;drive_folder_set&quot;</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_drive_folder_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזרה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_folder_back&quot;</span><span class="p">)],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;❌ ביטול&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_folder_cancel&quot;</span><span class="p">)],</span>
            <span class="p">]</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="s2">&quot;שלח נתיב תיקייה (למשל: Project/Backups/Code) — ניצור אם לא קיים&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;drive_folder_back&quot;</span><span class="p">:</span>
            <span class="c1"># חזרה למסך בחירת תיקיית יעד לפי הקשר אחרון</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;waiting_for_drive_folder_path&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;last_menu&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">last</span> <span class="o">==</span> <span class="s2">&quot;adv&quot;</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_render_choose_folder_adv</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_render_choose_folder_simple</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;drive_folder_cancel&quot;</span><span class="p">:</span>
            <span class="c1"># ביטול מצב הזנת נתיב וחזרה לתפריט לפי הקשר</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;waiting_for_drive_folder_path&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;last_menu&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">last</span> <span class="o">==</span> <span class="s2">&quot;adv&quot;</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_render_advanced_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_render_simple_selection</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;drive_schedule&quot;</span><span class="p">:</span>
            <span class="n">current</span> <span class="o">=</span> <span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">get_drive_prefs</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;schedule&quot;</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">label</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;✅ &quot;</span> <span class="o">+</span> <span class="n">text</span><span class="p">)</span> <span class="k">if</span> <span class="n">current</span> <span class="o">==</span> <span class="n">key</span> <span class="k">else</span> <span class="n">text</span>
            <span class="n">back_cb</span> <span class="o">=</span> <span class="s2">&quot;drive_sel_adv&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;last_menu&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;adv&quot;</span> <span class="k">else</span> <span class="s2">&quot;drive_backup_now&quot;</span>
            <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;daily&quot;</span><span class="p">,</span> <span class="s2">&quot;כל יום&quot;</span><span class="p">),</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_set_schedule:daily&quot;</span><span class="p">)],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;every3&quot;</span><span class="p">,</span> <span class="s2">&quot;כל 3 ימים&quot;</span><span class="p">),</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_set_schedule:every3&quot;</span><span class="p">)],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;weekly&quot;</span><span class="p">,</span> <span class="s2">&quot;כל שבוע&quot;</span><span class="p">),</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_set_schedule:weekly&quot;</span><span class="p">)],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;biweekly&quot;</span><span class="p">,</span> <span class="s2">&quot;פעם בשבועיים&quot;</span><span class="p">),</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_set_schedule:biweekly&quot;</span><span class="p">)],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;monthly&quot;</span><span class="p">,</span> <span class="s2">&quot;פעם בחודש&quot;</span><span class="p">),</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_set_schedule:monthly&quot;</span><span class="p">)],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;⛔ בטל תזמון&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_set_schedule:off&quot;</span><span class="p">)],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזרה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="n">back_cb</span><span class="p">)],</span>
            <span class="p">]</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;בחר תדירות גיבוי אוטומטי:&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;drive_status&quot;</span><span class="p">:</span>
            <span class="c1"># מסך מצב גיבוי: סוג נבחר/אחרון, תיקייה, תזמון, מועד ריצה הבא (אם קיים)</span>
            <span class="c1"># ודא שקיימת עבודה מתוזמנת אם יש תזמון בהעדפות</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">prefs</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_drive_prefs</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
                <span class="n">sched_key</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;schedule&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sched_key</span><span class="p">:</span>
                    <span class="n">jobs</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">bot_data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;drive_schedule_jobs&quot;</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">jobs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_schedule_job</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">sched_key</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">prefs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># Hydrate session to reflect persisted selections in the header</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_hydrate_session_from_prefs</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="c1"># פרטי תצוגה</span>
            <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compose_selection_header</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="c1"># חישוב מועד הבא</span>
            <span class="n">next_run_text</span> <span class="o">=</span> <span class="s2">&quot;—&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">prefs</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_drive_prefs</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
                <span class="n">sched_key</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;schedule&quot;</span><span class="p">)</span>
                <span class="n">last_full_iso</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;last_full_backup_at&quot;</span><span class="p">)</span>
                <span class="n">last_iso</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;last_backup_at&quot;</span><span class="p">)</span>
                <span class="n">nxt_iso</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;schedule_next_at&quot;</span><span class="p">)</span>
                <span class="n">tz</span> <span class="o">=</span> <span class="n">ZoneInfo</span><span class="p">(</span><span class="s2">&quot;Asia/Jerusalem&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">ZoneInfo</span> <span class="k">else</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span>
                <span class="n">next_dt</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">sched_key</span><span class="p">:</span>
                    <span class="n">secs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interval_seconds</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">sched_key</span><span class="p">))</span>
                    <span class="n">base_last_dt</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">last_full_iso</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">last_full_iso</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">base_last_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">last_full_iso</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="n">base_last_dt</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">base_last_dt</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">last_iso</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">last_iso</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">base_last_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">last_iso</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="n">base_last_dt</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">base_last_dt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">candidate</span> <span class="o">=</span> <span class="n">base_last_dt</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">secs</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">now_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">520</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">candidate</span> <span class="o">&gt;</span> <span class="n">now_dt</span><span class="p">:</span>
                                    <span class="k">break</span>
                                <span class="n">candidate</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">secs</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="n">next_dt</span> <span class="o">=</span> <span class="n">candidate</span>
                <span class="k">if</span> <span class="n">next_dt</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nxt_iso</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">nxt_iso</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">next_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">nxt_iso</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">next_dt</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">next_dt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># נסה מה-Job אם קיים</span>
                    <span class="n">jobs</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">bot_data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;drive_schedule_jobs&quot;</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="n">job</span> <span class="o">=</span> <span class="n">jobs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">job</span><span class="p">:</span>
                        <span class="n">next_dt</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="s2">&quot;next_t&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">next_dt</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">next_run_text</span> <span class="o">=</span> <span class="n">next_dt</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">tz</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/%m/%Y %H:%M&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">next_run_text</span> <span class="o">=</span> <span class="n">next_dt</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/%m/%Y %H:%M UTC&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;📊 מצב גיבוי</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                <span class="n">header</span> <span class="o">+</span>
                <span class="sa">f</span><span class="s2">&quot;מועד גיבוי הבא: </span><span class="si">{</span><span class="n">next_run_text</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">kb</span> <span class="o">=</span> <span class="p">[[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזרה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_backup_now&quot;</span><span class="p">)]]</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;drive_help&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_render_help</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;drive_set_schedule:&quot;</span><span class="p">):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># Save preference (time interval only)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;off&quot;</span><span class="p">:</span>
                <span class="n">db</span><span class="o">.</span><span class="n">save_drive_prefs</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;schedule&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>
                <span class="c1"># cancel job if exists</span>
                <span class="n">jobs</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">bot_data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;drive_schedule_jobs&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">job</span> <span class="o">=</span> <span class="n">jobs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">job</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">job</span><span class="o">.</span><span class="n">schedule_removal</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;⛔ תזמון בוטל&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="c1"># Persist schedule key and also persist the category to be used by scheduler</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">selected</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_category&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">selected</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="c1"># Map invalid/empty to &#39;all&#39; by default</span>
            <span class="k">if</span> <span class="n">selected</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;zip&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="s2">&quot;by_repo&quot;</span><span class="p">,</span> <span class="s2">&quot;large&quot;</span><span class="p">,</span> <span class="s2">&quot;other&quot;</span><span class="p">}:</span>
                <span class="n">selected</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span>
            <span class="n">db</span><span class="o">.</span><span class="n">save_drive_prefs</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;schedule&quot;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span> <span class="s2">&quot;schedule_category&quot;</span><span class="p">:</span> <span class="n">selected</span><span class="p">})</span>
            <span class="c1"># schedule/update job and persist next run time</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_schedule_job</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="c1"># Re-render menu to reflect updated schedule label</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;last_menu&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;adv&quot;</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_render_advanced_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">header_prefix</span><span class="o">=</span><span class="s2">&quot;✅ תזמון נשמר</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_render_simple_selection</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">header_prefix</span><span class="o">=</span><span class="s2">&quot;✅ תזמון נשמר</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;drive_logout&quot;</span><span class="p">:</span>
            <span class="c1"># Ask for confirmation before logging out</span>
            <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;✅ התנתק&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_logout_do&quot;</span><span class="p">)],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;❌ בטל&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_backup_now&quot;</span><span class="p">)],</span>
            <span class="p">]</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;האם להתנתק מ‑Google Drive?&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;drive_logout_do&quot;</span><span class="p">:</span>
            <span class="nb">__import__</span><span class="p">(</span><span class="s1">&#39;logging&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Drive: logout by user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">delete_drive_tokens</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;🚪נותקת מ‑Google Drive&quot;</span> <span class="k">if</span> <span class="n">ok</span> <span class="k">else</span> <span class="s2">&quot;❌ לא בוצעה התנתקות&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;drive_simple_confirm&quot;</span><span class="p">:</span>
            <span class="c1"># בצע את הפעולה שנבחרה רק עכשיו</span>
            <span class="n">sess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">selected</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_category&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">selected</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;לא נבחר מה לגבות&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="c1"># בדיקת שירות רק בשלב ביצוע</span>
            <span class="k">if</span> <span class="n">gdrive</span><span class="o">.</span><span class="n">get_drive_service</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔐 התחבר ל‑Drive&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_auth&quot;</span><span class="p">)],</span>
                    <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזרה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_backup_now&quot;</span><span class="p">)],</span>
                <span class="p">]</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ לא ניתן לגשת ל‑Drive כרגע. נסה להתחבר מחדש או לבדוק הרשאות.&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">selected</span> <span class="o">==</span> <span class="s2">&quot;zip&quot;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">existing</span> <span class="o">=</span> <span class="n">backup_manager</span><span class="o">.</span><span class="n">list_backups</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
                    <span class="n">saved_zips</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">existing</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s1">&#39;file_path&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.zip&#39;</span><span class="p">)]</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">saved_zips</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">saved_zips</span><span class="p">:</span>
                    <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📦 צור ZIP שמור בבוט&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_make_zip_now&quot;</span><span class="p">)],</span>
                        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזרה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_backup_now&quot;</span><span class="p">)],</span>
                    <span class="p">]</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;ℹ️ לא נמצאו קבצי ZIP שמורים בבוט. אפשר ליצור עכשיו ZIP שמור בבוט או לבחור 🧰 הכל.&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>
                    <span class="k">return</span>
                <span class="c1"># פידבק מיידי לפני פעולת העלאה שעלולה לקחת זמן</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;⏳ מעלה קבצי ZIP ל‑Drive…</span><span class="se">\n</span><span class="s2">זה עשוי לקחת כמה דקות.</span><span class="se">\n</span><span class="s2">🔔 תתקבל הודעה בסיום.&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="c1"># הרצת ההעלאה בת׳רד נפרד כדי לא לחסום את הלולאה האסינכרונית</span>
                <span class="n">count</span><span class="p">,</span> <span class="n">ids</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">to_thread</span><span class="p">(</span><span class="n">gdrive</span><span class="o">.</span><span class="n">upload_all_saved_zip_backups</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">kb</span> <span class="o">=</span> <span class="p">[[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזרה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_backup_now&quot;</span><span class="p">)]]</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;✅ אין מה להעלות — כל הגיבויים כבר בדרייב.&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>
                    <span class="k">return</span>
                <span class="n">sess</span><span class="p">[</span><span class="s2">&quot;zip_done&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">sess</span><span class="p">[</span><span class="s2">&quot;last_upload&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;zip&quot;</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_render_simple_selection</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">header_prefix</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;✅ הועלו </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2"> גיבויי ZIP ל‑Drive</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">selected</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
                <span class="c1"># פידבק מיידי לפני יצירת ZIP מלא והעלאה</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;⏳ מכין גיבוי מלא ומעלה ל‑Drive…</span><span class="se">\n</span><span class="s2">זה עשוי לקחת כמה דקות.</span><span class="se">\n</span><span class="s2">🔔 תתקבל הודעה בסיום.&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="kn">from</span> <span class="nn">config</span> <span class="kn">import</span> <span class="n">config</span> <span class="k">as</span> <span class="n">_cfg</span>
                <span class="c1"># יצירת ZIP והרצה בת׳רד נפרד</span>
                <span class="n">fn</span><span class="p">,</span> <span class="n">data_bytes</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">to_thread</span><span class="p">(</span><span class="n">gdrive</span><span class="o">.</span><span class="n">create_full_backup_zip_bytes</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">)</span>
                <span class="n">friendly</span> <span class="o">=</span> <span class="n">gdrive</span><span class="o">.</span><span class="n">compute_friendly_name</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">_cfg</span><span class="p">,</span> <span class="s1">&#39;BOT_LABEL&#39;</span><span class="p">,</span> <span class="s1">&#39;CodeBot&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;CodeBot&#39;</span><span class="p">,</span> <span class="n">content_sample</span><span class="o">=</span><span class="n">data_bytes</span><span class="p">[:</span><span class="mi">1024</span><span class="p">])</span>
                <span class="n">sub_path</span> <span class="o">=</span> <span class="n">gdrive</span><span class="o">.</span><span class="n">compute_subpath</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
                <span class="c1"># העלאה בת׳רד נפרד</span>
                <span class="n">fid</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">to_thread</span><span class="p">(</span><span class="n">gdrive</span><span class="o">.</span><span class="n">upload_bytes</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">friendly</span><span class="p">,</span> <span class="n">data_bytes</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sub_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">fid</span><span class="p">:</span>
                    <span class="c1"># עדכן את זמן הגיבוי האחרון לצורך חישוב מועד הבא</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">now_iso</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
                        <span class="n">db</span><span class="o">.</span><span class="n">save_drive_prefs</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;last_backup_at&quot;</span><span class="p">:</span> <span class="n">now_iso</span><span class="p">,</span> <span class="s2">&quot;last_full_backup_at&quot;</span><span class="p">:</span> <span class="n">now_iso</span><span class="p">})</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="n">sess</span><span class="p">[</span><span class="s2">&quot;all_done&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">sess</span><span class="p">[</span><span class="s2">&quot;last_upload&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_render_simple_selection</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">header_prefix</span><span class="o">=</span><span class="s2">&quot;✅ גיבוי מלא הועלה ל‑Drive</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔐 התחבר ל‑Drive&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_auth&quot;</span><span class="p">)],</span>
                        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזרה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_backup_now&quot;</span><span class="p">)],</span>
                    <span class="p">]</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ כשל בהעלאה. נסה להתחבר מחדש או לבדוק הרשאות.&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>
                <span class="k">return</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;drive_adv_confirm&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_render_adv_summary</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;drive_make_zip_now&quot;</span><span class="p">:</span>
            <span class="c1"># צור גיבוי מלא ושמור אותו בבוט (לא בדרייב), כדי שיהיו ZIPים זמינים להעלאה</span>
            <span class="kn">from</span> <span class="nn">services</span> <span class="kn">import</span> <span class="n">backup_service</span> <span class="k">as</span> <span class="n">_backup_service</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;⏳ יוצר ZIP שמור בבוט…</span><span class="se">\n</span><span class="s2">זה עשוי לקחת כמה דקות.</span><span class="se">\n</span><span class="s2">🔔 תתקבל הודעה בסיום.&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># נשתמש בשירות הגיבוי המקומי ליצירת ZIP ושמירה</span>
                <span class="n">fn</span><span class="p">,</span> <span class="n">data_bytes</span> <span class="o">=</span> <span class="n">gdrive</span><span class="o">.</span><span class="n">create_full_backup_zip_bytes</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="n">_backup_service</span><span class="o">.</span><span class="n">save_backup_bytes</span><span class="p">(</span><span class="n">data_bytes</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;backup_id&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fn</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span> <span class="s2">&quot;backup_type&quot;</span><span class="p">:</span> <span class="s2">&quot;manual&quot;</span><span class="p">})</span>
                <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;✅ נוצר ZIP שמור בבוט. עכשיו ניתן לבחור שוב &#39;📦 קבצי ZIP&#39; להעלאה ל‑Drive.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ יצירת ה‑ZIP נכשלה. נסה שוב מאוחר יותר.&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ יצירת ה‑ZIP נכשלה. נסה שוב מאוחר יותר.&quot;</span><span class="p">)</span>
            <span class="k">return</span></div>


<div class="viewcode-block" id="GoogleDriveMenuHandler.handle_text">
<a class="viewcode-back" href="../../../handlers/drive_menu.html#handlers.drive.menu.GoogleDriveMenuHandler.handle_text">[תיעוד]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">handle_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">text</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;waiting_for_drive_code&quot;</span><span class="p">):</span>
            <span class="c1"># User pasted one-time code; exchange by polling device flow once</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_drive_code&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">sess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="n">device_code</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;device_code&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">device_code</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;❌ פג תוקף הבקשה. נסה שוב.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="n">tokens</span> <span class="o">=</span> <span class="n">gdrive</span><span class="o">.</span><span class="n">poll_device_token</span><span class="p">(</span><span class="n">device_code</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">tokens</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;⌛ עדיין ממתינים לאישור. אשר בדפדפן ונסה שוב לשלוח את הקוד.&quot;</span><span class="p">)</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_drive_code&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="n">saved</span> <span class="o">=</span> <span class="n">gdrive</span><span class="o">.</span><span class="n">save_tokens</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">tokens</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">saved</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;✅ חיבור ל‑Drive הושלם! שלח /drive כדי להתחיל לגבות.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;❌ לא ניתן לשמור את החיבור.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;waiting_for_drive_folder_path&quot;</span><span class="p">):</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;waiting_for_drive_folder_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">text</span>
            <span class="n">fid</span> <span class="o">=</span> <span class="n">gdrive</span><span class="o">.</span><span class="n">ensure_path</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fid</span><span class="p">:</span>
                <span class="c1"># Save label for buttons</span>
                <span class="n">sess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="n">sess</span><span class="p">[</span><span class="s2">&quot;target_folder_label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
                <span class="n">sess</span><span class="p">[</span><span class="s2">&quot;target_folder_auto&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">save_drive_prefs</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;target_folder_label&quot;</span><span class="p">:</span> <span class="n">path</span><span class="p">,</span> <span class="s2">&quot;target_folder_auto&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;target_folder_path&quot;</span><span class="p">:</span> <span class="n">path</span><span class="p">})</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;✅ תיקייה יעד עודכנה בהצלחה&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;❌ לא ניתן להגדיר את התיקייה. ודא בהרשאות Drive.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>



    <span class="c1"># ===== Helpers =====</span>
    <span class="k">def</span> <span class="nf">_interval_seconds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sched_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">interval_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;daily&quot;</span><span class="p">:</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">,</span>
            <span class="s2">&quot;every3&quot;</span><span class="p">:</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">,</span>
            <span class="s2">&quot;weekly&quot;</span><span class="p">:</span> <span class="mi">7</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">,</span>
            <span class="s2">&quot;biweekly&quot;</span><span class="p">:</span> <span class="mi">14</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">,</span>
            <span class="s2">&quot;monthly&quot;</span><span class="p">:</span> <span class="mi">30</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">interval_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sched_key</span><span class="p">,</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">_hydrate_session_from_prefs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load persisted Drive preferences into the in-memory session if missing.</span>

<span class="sd">        Ensures selections survive restarts/deploys and are reflected in menus.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">prefs</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_drive_prefs</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">prefs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">sess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="c1"># Selected category</span>
        <span class="k">if</span> <span class="s2">&quot;selected_category&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sess</span><span class="p">:</span>
            <span class="n">cat</span> <span class="o">=</span> <span class="p">(</span><span class="n">prefs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;last_selected_category&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">cat</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;zip&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="s2">&quot;by_repo&quot;</span><span class="p">,</span> <span class="s2">&quot;large&quot;</span><span class="p">,</span> <span class="s2">&quot;other&quot;</span><span class="p">}:</span>
                <span class="n">sess</span><span class="p">[</span><span class="s2">&quot;selected_category&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cat</span>
        <span class="c1"># Target folder label</span>
        <span class="k">if</span> <span class="s2">&quot;target_folder_label&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sess</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target_folder_label&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">label</span><span class="p">:</span>
                <span class="n">sess</span><span class="p">[</span><span class="s2">&quot;target_folder_label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">label</span>
                <span class="n">sess</span><span class="p">[</span><span class="s2">&quot;target_folder_auto&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">prefs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target_folder_auto&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target_folder_path&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">path</span><span class="p">:</span>
                    <span class="n">sess</span><span class="p">[</span><span class="s2">&quot;target_folder_label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># If we have a target_folder_id only, assume default label</span>
                    <span class="k">if</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target_folder_id&quot;</span><span class="p">):</span>
                        <span class="n">sess</span><span class="p">[</span><span class="s2">&quot;target_folder_label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;גיבויי_קודלי&quot;</span>
    <span class="k">def</span> <span class="nf">_schedule_button_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">prefs</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_drive_prefs</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;schedule&quot;</span><span class="p">)</span>
        <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;daily&quot;</span><span class="p">:</span> <span class="s2">&quot;🕑 כל יום&quot;</span><span class="p">,</span>
            <span class="s2">&quot;every3&quot;</span><span class="p">:</span> <span class="s2">&quot;🕑 כל 3 ימים&quot;</span><span class="p">,</span>
            <span class="s2">&quot;weekly&quot;</span><span class="p">:</span> <span class="s2">&quot;🕑 פעם בשבוע&quot;</span><span class="p">,</span>
            <span class="s2">&quot;biweekly&quot;</span><span class="p">:</span> <span class="s2">&quot;🕑 פעם בשבועיים&quot;</span><span class="p">,</span>
            <span class="s2">&quot;monthly&quot;</span><span class="p">:</span> <span class="s2">&quot;🕑 פעם בחודש&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;🗓 זמני גיבוי&quot;</span>

    <span class="k">def</span> <span class="nf">_compose_selection_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">sess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="c1"># Prefer showing current selection (UI state) over last executed upload</span>
        <span class="n">selected</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_category&quot;</span><span class="p">)</span>
        <span class="n">last_upload</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;last_upload&quot;</span><span class="p">)</span>
        <span class="n">category</span> <span class="o">=</span> <span class="n">selected</span> <span class="ow">or</span> <span class="n">last_upload</span>
        <span class="c1"># סוג + אימוג&#39;י לפי הכפתורים בתצוגה הפשוטה</span>
        <span class="n">type_emoji</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">category</span> <span class="o">==</span> <span class="s2">&quot;zip&quot;</span><span class="p">:</span>
            <span class="n">type_emoji</span> <span class="o">=</span> <span class="s2">&quot;📦&quot;</span>
            <span class="n">typ</span> <span class="o">=</span> <span class="s2">&quot;קבצי ZIP&quot;</span>
        <span class="k">elif</span> <span class="n">category</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="n">type_emoji</span> <span class="o">=</span> <span class="s2">&quot;🧰&quot;</span>
            <span class="n">typ</span> <span class="o">=</span> <span class="s2">&quot;הכל&quot;</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">category</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">category</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;by_repo&quot;</span><span class="p">,</span> <span class="s2">&quot;large&quot;</span><span class="p">,</span> <span class="s2">&quot;other&quot;</span><span class="p">}:</span>
            <span class="c1"># ללא אימוג&#39;י ייעודי כי בכפתורי המתקדם אין אימוג&#39;ים לקטגוריות אלו</span>
            <span class="n">typ</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;by_repo&quot;</span><span class="p">:</span> <span class="s2">&quot;לפי ריפו&quot;</span><span class="p">,</span> <span class="s2">&quot;large&quot;</span><span class="p">:</span> <span class="s2">&quot;קבצים גדולים&quot;</span><span class="p">,</span> <span class="s2">&quot;other&quot;</span><span class="p">:</span> <span class="s2">&quot;שאר קבצים&quot;</span><span class="p">}[</span><span class="n">category</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">typ</span> <span class="o">=</span> <span class="s2">&quot;—&quot;</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target_folder_label&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;ברירת מחדל (גיבויי_קודלי)&quot;</span>
        <span class="n">sched</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_button_label</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="c1"># הוצא את הטקסט ללא האימוג&#39;י המובנה ונוסיף ידנית</span>
        <span class="n">sched_text</span> <span class="o">=</span> <span class="n">sched</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;🕑 &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">sched</span> <span class="o">!=</span> <span class="s2">&quot;🗓 זמני גיבוי&quot;</span> <span class="k">else</span> <span class="s2">&quot;לא נקבע&quot;</span>
        <span class="n">sched_emoji</span> <span class="o">=</span> <span class="s2">&quot;🕑&quot;</span> <span class="k">if</span> <span class="n">sched</span> <span class="o">!=</span> <span class="s2">&quot;🗓 זמני גיבוי&quot;</span> <span class="k">else</span> <span class="s2">&quot;🗓&quot;</span>
        <span class="c1"># פורמט סופי עם אימוג&#39;ים</span>
        <span class="n">type_line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;סוג: </span><span class="si">{</span><span class="n">type_emoji</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">type_emoji</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}{</span><span class="n">typ</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">folder_line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;תיקייה: 📂 </span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">sched_line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;תזמון: </span><span class="si">{</span><span class="n">sched_emoji</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sched_text</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">type_line</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">folder_line</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">sched_line</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="nf">_folder_button_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">sess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target_folder_label&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">label</span><span class="p">:</span>
            <span class="c1"># Fallback to persisted prefs if session missing (e.g., after deploy)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">prefs</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_drive_prefs</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target_folder_label&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target_folder_path&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">label</span> <span class="ow">and</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target_folder_id&quot;</span><span class="p">):</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;גיבויי_קודלי&quot;</span>
                <span class="k">if</span> <span class="n">label</span><span class="p">:</span>
                    <span class="n">sess</span><span class="p">[</span><span class="s2">&quot;target_folder_label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">label</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">label</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;📂 תיקיית יעד: </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;📂 בחר תיקיית יעד&quot;</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_render_simple_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">header_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span> <span class="k">if</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        <span class="c1"># Ensure session reflects persisted prefs</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_hydrate_session_from_prefs</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="c1"># אם הופעל דגל &#39;force_new_simple&#39; נשלח הודעה חדשה במקום עריכת הקיימת כדי לשמור על פריסה מלאה</span>
        <span class="n">force_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_send_new_message</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">sess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="c1"># הצג וי רק אחרי &quot;אישור&quot; מוצלח. ננקה וי אם המשתמש החליף בחירה לפני אישור מחדש</span>
        <span class="n">selected</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_category&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">selected</span> <span class="ow">and</span> <span class="n">selected</span> <span class="o">!=</span> <span class="n">sess</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;last_upload&quot;</span><span class="p">):</span>
            <span class="n">sess</span><span class="p">[</span><span class="s2">&quot;zip_done&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">sess</span><span class="p">[</span><span class="s2">&quot;all_done&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># הצג וי ירוק על הבחירה הפעילה (מוצג גם בכותרת למעלה)</span>
        <span class="n">active</span> <span class="o">=</span> <span class="n">selected</span> <span class="ow">or</span> <span class="n">sess</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;last_upload&quot;</span><span class="p">)</span>
        <span class="n">zip_label</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;✅ &quot;</span> <span class="k">if</span> <span class="n">active</span> <span class="o">==</span> <span class="s2">&quot;zip&quot;</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;📦 קבצי ZIP&quot;</span>
        <span class="n">all_label</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;✅ &quot;</span> <span class="k">if</span> <span class="n">active</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;🧰 הכל&quot;</span>
        <span class="n">folder_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_folder_button_label</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">schedule_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_button_label</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">sess</span><span class="p">[</span><span class="s2">&quot;last_menu&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;simple&quot;</span>
        <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">zip_label</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_sel_zip&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">all_label</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_sel_all&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">folder_label</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_choose_folder&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">schedule_label</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_schedule&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📊 מצב גיבוי&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_status&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;✅ אישור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_simple_confirm&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🚪 התנתק&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_logout&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ℹ️ הסבר&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_help&quot;</span><span class="p">)],</span>
        <span class="p">]</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">header_prefix</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compose_selection_header</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="c1"># שלח טקסט בהתאם להקשר: עריכת הודעה קיימת או שליחת חדשה בבטחה</span>
        <span class="k">if</span> <span class="n">query</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_new</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">query</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">chat</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_chat</span>
                <span class="k">if</span> <span class="n">chat</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">context</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">chat_id</span><span class="o">=</span><span class="n">chat</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_render_after_folder_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">success</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="c1"># Determine where to go back based on last context (advanced vs simple)</span>
        <span class="n">last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;last_menu&quot;</span><span class="p">)</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;✅ תיקייה יעד עודכנה</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">success</span> <span class="k">else</span> <span class="s2">&quot;❌ כשל בקביעת תיקייה</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">last</span> <span class="o">==</span> <span class="s2">&quot;adv&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_render_advanced_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">header_prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_render_simple_selection</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">header_prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_render_advanced_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">header_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="c1"># Ensure session reflects persisted prefs</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_hydrate_session_from_prefs</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">sess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">sess</span><span class="p">[</span><span class="s2">&quot;last_menu&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;adv&quot;</span>
        <span class="n">multi_on</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">sess</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;adv_multi&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
        <span class="n">folder_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_folder_button_label</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">schedule_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_button_label</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;לפי ריפו&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_adv_by_repo&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;קבצים גדולים&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_adv_large&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;שאר קבצים&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_adv_other&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">((</span><span class="s2">&quot;✅ בחירה מרובה&quot;</span> <span class="k">if</span> <span class="n">multi_on</span> <span class="k">else</span> <span class="s2">&quot;⬜ בחירה מרובה&quot;</span><span class="p">),</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_adv_multi_toggle&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📂 בחר תיקיית יעד&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_choose_folder_adv&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">schedule_label</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_schedule&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;✅ אישור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_adv_confirm&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזרה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_backup_now&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🚪 התנתק&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_logout&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;ℹ️ הסבר&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_help&quot;</span><span class="p">)],</span>
        <span class="p">]</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">header_prefix</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compose_selection_header</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">header</span> <span class="o">+</span> <span class="s2">&quot;בחר קטגוריה מתקדמת:&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_render_help</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">sess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">last</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;last_menu&quot;</span><span class="p">)</span>
        <span class="n">back_cb</span> <span class="o">=</span> <span class="s2">&quot;drive_sel_adv&quot;</span> <span class="k">if</span> <span class="n">last</span> <span class="o">==</span> <span class="s2">&quot;adv&quot;</span> <span class="k">else</span> <span class="s2">&quot;drive_backup_now&quot;</span>
        <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;📚 מדריך גיבוי ל‑Google Drive</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;━━━━━━━━━━━━━━━━━━━</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;🎯 סוגי גיבוי:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;• 📦 קבצי ZIP - מעלה קבצי ZIP שכבר שמורים בבוט</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;   └ אם אין ZIP שמורים, ניתן ליצור באמצעות &#39;צור ZIP שמור בבוט&#39;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;• 🧰 הכל - יוצר גיבוי מלא חדש של כל הקבצים ומעלה ל‑Drive</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;   └ הגיבוי נשמר בתיקיית &#39;הכל&#39; עם תאריך ושעה</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;⚙️ הגדרות:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;• 📂 תיקיית יעד - בחירת מיקום השמירה ב‑Drive</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;   └ ברירת מחדל: &#39;גיבויי_קודלי&#39;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;   └ אפשרות לסידור אוטומטי או נתיב מותאם אישית</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;• 🗓 זמני גיבוי - הגדרת גיבוי אוטומטי</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;   └ אפשרויות: יומי, כל 3 ימים, שבועי, דו-שבועי, חודשי</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;🔧 תכונות נוספות:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;• 📊 מצב גיבוי - צפייה בסטטוס הנוכחי ומועד הגיבוי הבא</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;• מתקדם - אפשרויות גיבוי מתקדמות:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;   └ לפי ריפו - מסדר קבצים לפי פרויקטים</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;   └ קבצים גדולים - גיבוי קבצים מעל 10MB</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;   └ שאר קבצים - כל הקבצים שאינם משויכים לריפו</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;   └ בחירה מרובה - בחירת מספר קטגוריות בו-זמנית</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;💡 טיפים:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;• לחצו על ✅ אישור רק אחרי בחירת סוג הגיבוי הרצוי</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;• גיבויים אוטומטיים יופעלו לפי התזמון שהגדרתם</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;• ניתן להתנתק בכל עת באמצעות 🚪 התנתק</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">kb</span> <span class="o">=</span> <span class="p">[[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזרה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="n">back_cb</span><span class="p">)]]</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_should_send_new_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;force_new_simple&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_render_simple_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">sess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">last_upload</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;last_upload&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;—&quot;</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target_folder_label&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;ברירת מחדל (גיבויי_קודלי)&quot;</span>
        <span class="n">schedule</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_button_label</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;🕑 &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;סיכום הגדרות:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;• סוג גיבוי אחרון: </span><span class="si">{</span><span class="p">(</span><span class="s1">&#39;קבצי ZIP&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">last_upload</span><span class="o">==</span><span class="s1">&#39;zip&#39;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;הכל&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">last_upload</span><span class="o">==</span><span class="s1">&#39;all&#39;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;—&#39;</span><span class="p">))</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;• תיקיית יעד: </span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;• תזמון: </span><span class="si">{</span><span class="n">schedule</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">schedule</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;🗓 זמני גיבוי&#39;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;לא נקבע&#39;</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">kb</span> <span class="o">=</span> <span class="p">[[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזרה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_backup_now&quot;</span><span class="p">)]]</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_render_choose_folder_simple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">explain</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;סידור תיקיות אוטומטי: הבוט יסדר בתוך &#39;גיבויי_קודלי&#39; לפי קטגוריות ותאריכים,</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;וב&#39;לפי ריפו&#39; גם תת‑תיקיות לפי שם הריפו.&quot;</span>
        <span class="p">)</span>
        <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🤖 סידור תיקיות אוטומטי (כמו בבוט)&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_folder_auto&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📂 גיבויי_קודלי (ברירת מחדל)&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_folder_default&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;✏️ הגדר נתיב מותאם (שלח טקסט)&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_folder_set&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזרה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_backup_now&quot;</span><span class="p">)],</span>
        <span class="p">]</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;בחר תיקיית יעד:</span><span class="se">\n\n</span><span class="si">{</span><span class="n">explain</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_render_choose_folder_adv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">explain</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;סידור תיקיות אוטומטי: הבוט יסדר בתוך &#39;גיבויי_קודלי&#39; לפי קטגוריות ותאריכים,</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;וב&#39;לפי ריפו&#39; גם תת‑תיקיות לפי שם הריפו.&quot;</span>
        <span class="p">)</span>
        <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🤖 סידור תיקיות אוטומטי (כמו בבוט)&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_folder_auto&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📂 גיבויי_קודלי (ברירת מחדל)&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_folder_default&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;✏️ הגדר נתיב מותאם (שלח טקסט)&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_folder_set&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזרה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_sel_adv&quot;</span><span class="p">)],</span>
        <span class="p">]</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;בחר תיקיית יעד:</span><span class="se">\n\n</span><span class="si">{</span><span class="n">explain</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_render_adv_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">sess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">cats</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sess</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;adv_selected&quot;</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span> <span class="ow">or</span> <span class="p">[])</span>
        <span class="n">cats_map</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;by_repo&quot;</span><span class="p">:</span> <span class="s2">&quot;לפי ריפו&quot;</span><span class="p">,</span> <span class="s2">&quot;large&quot;</span><span class="p">:</span> <span class="s2">&quot;קבצים גדולים&quot;</span><span class="p">,</span> <span class="s2">&quot;other&quot;</span><span class="p">:</span> <span class="s2">&quot;שאר קבצים&quot;</span><span class="p">}</span>
        <span class="n">cats_txt</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cats_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cats</span><span class="p">)</span> <span class="k">if</span> <span class="n">cats</span> <span class="k">else</span> <span class="s2">&quot;—&quot;</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target_folder_label&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;ברירת מחדל (גיבויי_קודלי)&quot;</span>
        <span class="n">schedule</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_button_label</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;🕑 &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;סיכום מתקדם:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;• קטגוריות: </span><span class="si">{</span><span class="n">cats_txt</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;• תיקיית יעד: </span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;• תזמון: </span><span class="si">{</span><span class="n">schedule</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">schedule</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;🗓 זמני גיבוי&#39;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;לא נקבע&#39;</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">kb</span> <span class="o">=</span> <span class="p">[[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזרה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;drive_sel_adv&quot;</span><span class="p">)]]</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Development Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>