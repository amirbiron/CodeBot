

<!DOCTYPE html>
<html class="writer-html5" lang="he" data-content_root="../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>conversation_handlers &mdash; תיעוד Code Keeper Bot 1.0.0</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=2d7a82d5" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=0062297a"></script>
      <script src="../_static/doctools.js?v=9a2dae69"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/translations.js?v=714bf7a6"></script>
      <script src="https://unpkg.com/mermaid@10.2.0/dist/mermaid.min.js"></script>
      <script>mermaid.initialize({startOnLoad:true});</script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="אינדקס" href="../genindex.html" />
    <link rel="search" title="חיפוש" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Code Keeper Bot
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">למפתחים ולסוכני AI:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quickstart-ai.html">התחלה מהירה - סוכני AI</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#id1">מטרה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#id2">מה אסור</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#id3">מה מותר ומומלץ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#id4">פורמטי ציטוט קוד</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#tmp">מחיקה בטוחה (רק ב-/tmp)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#pr">קומיטים ו-PR</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-ai.html#id5">קישורים מהירים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">התחלה מהירה - מפתחים</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#id2">מטרה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#id3">שלב 1: התקנה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#env">שלב 2: הגדרת .env</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#id4">שלב 3: הרצה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#id5">מה הלאה?</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart-contrib.html">Quickstart לתרומה</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-contrib.html#id1">מטרה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-contrib.html#id2">צעדי הכנה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-contrib.html#id3">סביבת פיתוח</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-contrib.html#id4">הרצת טסטים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-contrib.html#stubs">על ה‑Stubs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart-contrib.html#id5">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ai-guidelines.html">הנחיות מלאות לסוכני AI</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../ai-guidelines.html#id1">מגבלות קריטיות</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../ai-guidelines.html#id2">הרצת פקודות</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../ai-guidelines.html#id3">כלי קבצים מאושרים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ai-guidelines.html#id4">עקרונות עריכת קוד</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ai-guidelines.html#pull-requests">קומיטים ו-Pull Requests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ai-guidelines.html#id5">עבודה עם טסטים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ai-guidelines.html#id6">קישורים מהירים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../doc-authoring.html">Doc Authoring Guide (Sphinx/RTD)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../doc-authoring.html#id1">מטרות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../doc-authoring.html#id2">מדיניות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../doc-authoring.html#id3">טיפים מהירים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../doc-authoring.html#id4">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../style-glossary.html">Style &amp; Naming Glossary</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../style-glossary.html#id1">מטרות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../style-glossary.html#id2">מיפוי מונחים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../style-glossary.html#id3">כללים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../style-glossary.html#id4">עוגני תיעוד</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../versioning-stable-anchors.html">Versioning &amp; Stable Anchors</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../versioning-stable-anchors.html#id1">מדיניות עוגנים יציבים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../versioning-stable-anchors.html#whats-new">What’s New</a></li>
<li class="toctree-l2"><a class="reference internal" href="../versioning-stable-anchors.html#anchors">דוגמת Anchors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../versioning-stable-anchors.html#id2">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../whats-new.html">What’s New</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../whats-new.html#id1">2025-10-15</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../architecture.html">ארכיטקטורה</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#id2">סקירה כללית</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#id3">תרשים רכיבים (תמציתי)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#id4">מבנה תיקיות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#id5">זרימות מרכזיות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#id6">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">מדריך תרומה</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../contributing.html#id2">מטרה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributing.html#id3">כללים כלליים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributing.html#workflow">Workflow בסיסי</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributing.html#id4">דוגמאות שימושיות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributing.html#id5">קישורים</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">מדריכים בסיסיים:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">התקנה והגדרה</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#id2">דרישות מערכת</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#id3">התקנה מהירה</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#id4">1. שכפל את הריפוזיטורי</a></li>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#id5">2. התקן תלויות</a></li>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#id6">3. הגדר משתני סביבה</a></li>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#id7">4. הפעל את הבוט</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#docker">התקנה עם Docker</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#image">1. בנה את ה-Image</a></li>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#docker-compose">2. הפעל עם Docker Compose</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#mongodb">הגדרת MongoDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#telegram-bot">הגדרת Telegram Bot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#id8">הגדרות מתקדמות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#id9">בדיקת התקנה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#id10">פתרון בעיות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#id11">תמיכה</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../configuration.html">הגדרות תצורה</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#id2">קובץ התצורה הראשי</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#id3">משתני סביבה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#id4">הגדרות מתקדמות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#mongodb">הגדרת MongoDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#redis-cache">הגדרת Redis Cache</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#id5">הגדרות אבטחה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#id6">תצורה לסביבות שונות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#env">דוגמת קובץ .env מלא</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#id7">טיפים וטריקים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../environment-variables.html">משתני סביבה - רפרנס</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../environment-variables.html#id2">טבלה מרכזית</a></li>
<li class="toctree-l2"><a class="reference internal" href="../environment-variables.html#id3">דוגמאות קונפיגורציה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../environment-variables.html#id4">קישורים</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../api/main.html">main module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/config.html">config module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/config.html#config.BotConfig"><code class="docutils literal notranslate"><span class="pre">BotConfig</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.BOT_TOKEN"><code class="docutils literal notranslate"><span class="pre">BotConfig.BOT_TOKEN</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MONGODB_URL"><code class="docutils literal notranslate"><span class="pre">BotConfig.MONGODB_URL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.DATABASE_NAME"><code class="docutils literal notranslate"><span class="pre">BotConfig.DATABASE_NAME</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.REDIS_URL"><code class="docutils literal notranslate"><span class="pre">BotConfig.REDIS_URL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.CACHE_ENABLED"><code class="docutils literal notranslate"><span class="pre">BotConfig.CACHE_ENABLED</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.GITHUB_TOKEN"><code class="docutils literal notranslate"><span class="pre">BotConfig.GITHUB_TOKEN</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.PASTEBIN_API_KEY"><code class="docutils literal notranslate"><span class="pre">BotConfig.PASTEBIN_API_KEY</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MAX_CODE_SIZE"><code class="docutils literal notranslate"><span class="pre">BotConfig.MAX_CODE_SIZE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MAX_FILES_PER_USER"><code class="docutils literal notranslate"><span class="pre">BotConfig.MAX_FILES_PER_USER</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.SUPPORTED_LANGUAGES"><code class="docutils literal notranslate"><span class="pre">BotConfig.SUPPORTED_LANGUAGES</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.RECYCLE_TTL_DAYS"><code class="docutils literal notranslate"><span class="pre">BotConfig.RECYCLE_TTL_DAYS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.PUBLIC_BASE_URL"><code class="docutils literal notranslate"><span class="pre">BotConfig.PUBLIC_BASE_URL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.WEBAPP_URL"><code class="docutils literal notranslate"><span class="pre">BotConfig.WEBAPP_URL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MAINTENANCE_MODE"><code class="docutils literal notranslate"><span class="pre">BotConfig.MAINTENANCE_MODE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MAINTENANCE_MESSAGE"><code class="docutils literal notranslate"><span class="pre">BotConfig.MAINTENANCE_MESSAGE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.MAINTENANCE_AUTO_WARMUP_SECS"><code class="docutils literal notranslate"><span class="pre">BotConfig.MAINTENANCE_AUTO_WARMUP_SECS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.RATE_LIMIT_PER_MINUTE"><code class="docutils literal notranslate"><span class="pre">BotConfig.RATE_LIMIT_PER_MINUTE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.HIGHLIGHT_THEME"><code class="docutils literal notranslate"><span class="pre">BotConfig.HIGHLIGHT_THEME</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.GIT_CHECKPOINT_PREFIX"><code class="docutils literal notranslate"><span class="pre">BotConfig.GIT_CHECKPOINT_PREFIX</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.GOOGLE_CLIENT_ID"><code class="docutils literal notranslate"><span class="pre">BotConfig.GOOGLE_CLIENT_ID</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.GOOGLE_CLIENT_SECRET"><code class="docutils literal notranslate"><span class="pre">BotConfig.GOOGLE_CLIENT_SECRET</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.GOOGLE_OAUTH_SCOPES"><code class="docutils literal notranslate"><span class="pre">BotConfig.GOOGLE_OAUTH_SCOPES</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.GOOGLE_TOKEN_REFRESH_MARGIN_SECS"><code class="docutils literal notranslate"><span class="pre">BotConfig.GOOGLE_TOKEN_REFRESH_MARGIN_SECS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.DRIVE_MENU_V2"><code class="docutils literal notranslate"><span class="pre">BotConfig.DRIVE_MENU_V2</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.DOCUMENTATION_URL"><code class="docutils literal notranslate"><span class="pre">BotConfig.DOCUMENTATION_URL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.BOT_LABEL"><code class="docutils literal notranslate"><span class="pre">BotConfig.BOT_LABEL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.DRIVE_ADD_HASH"><code class="docutils literal notranslate"><span class="pre">BotConfig.DRIVE_ADD_HASH</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.NORMALIZE_CODE_ON_SAVE"><code class="docutils literal notranslate"><span class="pre">BotConfig.NORMALIZE_CODE_ON_SAVE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.METRICS_DB_ENABLED"><code class="docutils literal notranslate"><span class="pre">BotConfig.METRICS_DB_ENABLED</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.METRICS_COLLECTION"><code class="docutils literal notranslate"><span class="pre">BotConfig.METRICS_COLLECTION</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.METRICS_BATCH_SIZE"><code class="docutils literal notranslate"><span class="pre">BotConfig.METRICS_BATCH_SIZE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.METRICS_FLUSH_INTERVAL_SEC"><code class="docutils literal notranslate"><span class="pre">BotConfig.METRICS_FLUSH_INTERVAL_SEC</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig.__init__"><code class="docutils literal notranslate"><span class="pre">BotConfig.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/config.html#config.load_config"><code class="docutils literal notranslate"><span class="pre">load_config()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/bot_handlers.html">bot_handlers module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/conversation_handlers.html">conversation_handlers module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/database.html">database package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/database.html#submodules">Submodules</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/database.manager.html">database.manager module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/database.models.html">database.models module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/database.repository.html">database.repository module</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/services.html">services package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/services.html#submodules">Submodules</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/services.backup_service.html">services.backup_service module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/services.code_service.html">services.code_service module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/services.github_service.html">services.github_service module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/services.google_drive_service.html">services.google_drive_service module</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/handlers.html">handlers package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/handlers.html#subpackages">Subpackages</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.github.html">handlers.github package</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/handlers.html#submodules">Submodules</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.file_view.html">handlers.file_view module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.pagination.html">handlers.pagination module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.save_flow.html">handlers.save_flow module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.states.html">handlers.states module</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/utils.html">utils module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.CodeErrorLogger"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CodeErrorLogger.__init__"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CodeErrorLogger.log_code_processing_error"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger.log_code_processing_error()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CodeErrorLogger.log_code_activity"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger.log_code_activity()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CodeErrorLogger.log_validation_failure"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger.log_validation_failure()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CodeErrorLogger.log_sanitization_success"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger.log_sanitization_success()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.TimeUtils"><code class="docutils literal notranslate"><span class="pre">TimeUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TimeUtils.format_relative_time"><code class="docutils literal notranslate"><span class="pre">TimeUtils.format_relative_time()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TimeUtils.parse_date_string"><code class="docutils literal notranslate"><span class="pre">TimeUtils.parse_date_string()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TimeUtils.get_time_ranges"><code class="docutils literal notranslate"><span class="pre">TimeUtils.get_time_ranges()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.TextUtils"><code class="docutils literal notranslate"><span class="pre">TextUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils.truncate_text"><code class="docutils literal notranslate"><span class="pre">TextUtils.truncate_text()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils.escape_markdown"><code class="docutils literal notranslate"><span class="pre">TextUtils.escape_markdown()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils.clean_filename"><code class="docutils literal notranslate"><span class="pre">TextUtils.clean_filename()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils.extract_hashtags"><code class="docutils literal notranslate"><span class="pre">TextUtils.extract_hashtags()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils.highlight_text"><code class="docutils literal notranslate"><span class="pre">TextUtils.highlight_text()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils.format_file_size"><code class="docutils literal notranslate"><span class="pre">TextUtils.format_file_size()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils.pluralize_hebrew"><code class="docutils literal notranslate"><span class="pre">TextUtils.pluralize_hebrew()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.SecurityUtils"><code class="docutils literal notranslate"><span class="pre">SecurityUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.SecurityUtils.generate_secure_token"><code class="docutils literal notranslate"><span class="pre">SecurityUtils.generate_secure_token()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.SecurityUtils.hash_content"><code class="docutils literal notranslate"><span class="pre">SecurityUtils.hash_content()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.SecurityUtils.validate_user_input"><code class="docutils literal notranslate"><span class="pre">SecurityUtils.validate_user_input()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.SecurityUtils.sanitize_code"><code class="docutils literal notranslate"><span class="pre">SecurityUtils.sanitize_code()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils"><code class="docutils literal notranslate"><span class="pre">TelegramUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.send_typing_action"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.send_typing_action()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.send_document_action"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.send_document_action()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.safe_answer"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.safe_answer()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.get_user_mention"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.get_user_mention()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.split_long_message"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.split_long_message()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.safe_edit_message_text"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.safe_edit_message_text()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.safe_edit_message_reply_markup"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.safe_edit_message_reply_markup()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils.extract_message_text_preserve_markdown"><code class="docutils literal notranslate"><span class="pre">TelegramUtils.extract_message_text_preserve_markdown()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.CallbackQueryGuard"><code class="docutils literal notranslate"><span class="pre">CallbackQueryGuard</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CallbackQueryGuard.DEFAULT_WINDOW_SECONDS"><code class="docutils literal notranslate"><span class="pre">CallbackQueryGuard.DEFAULT_WINDOW_SECONDS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CallbackQueryGuard.should_block"><code class="docutils literal notranslate"><span class="pre">CallbackQueryGuard.should_block()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CallbackQueryGuard.should_block_async"><code class="docutils literal notranslate"><span class="pre">CallbackQueryGuard.should_block_async()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.AsyncUtils"><code class="docutils literal notranslate"><span class="pre">AsyncUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.AsyncUtils.run_with_timeout"><code class="docutils literal notranslate"><span class="pre">AsyncUtils.run_with_timeout()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.AsyncUtils.batch_process"><code class="docutils literal notranslate"><span class="pre">AsyncUtils.batch_process()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.PerformanceUtils"><code class="docutils literal notranslate"><span class="pre">PerformanceUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.PerformanceUtils.timing_decorator"><code class="docutils literal notranslate"><span class="pre">PerformanceUtils.timing_decorator()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.PerformanceUtils.measure_time"><code class="docutils literal notranslate"><span class="pre">PerformanceUtils.measure_time()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.ValidationUtils"><code class="docutils literal notranslate"><span class="pre">ValidationUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.ValidationUtils.is_valid_filename"><code class="docutils literal notranslate"><span class="pre">ValidationUtils.is_valid_filename()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.ValidationUtils.is_safe_code"><code class="docutils literal notranslate"><span class="pre">ValidationUtils.is_safe_code()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.FileUtils"><code class="docutils literal notranslate"><span class="pre">FileUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.FileUtils.download_file"><code class="docutils literal notranslate"><span class="pre">FileUtils.download_file()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.FileUtils.get_file_extension"><code class="docutils literal notranslate"><span class="pre">FileUtils.get_file_extension()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.FileUtils.get_mime_type"><code class="docutils literal notranslate"><span class="pre">FileUtils.get_mime_type()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.FileUtils.create_temp_file"><code class="docutils literal notranslate"><span class="pre">FileUtils.create_temp_file()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.ConfigUtils"><code class="docutils literal notranslate"><span class="pre">ConfigUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.ConfigUtils.load_json_config"><code class="docutils literal notranslate"><span class="pre">ConfigUtils.load_json_config()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.ConfigUtils.save_json_config"><code class="docutils literal notranslate"><span class="pre">ConfigUtils.save_json_config()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.CacheUtils"><code class="docutils literal notranslate"><span class="pre">CacheUtils</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CacheUtils.set"><code class="docutils literal notranslate"><span class="pre">CacheUtils.set()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CacheUtils.get"><code class="docutils literal notranslate"><span class="pre">CacheUtils.get()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CacheUtils.delete"><code class="docutils literal notranslate"><span class="pre">CacheUtils.delete()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CacheUtils.clear"><code class="docutils literal notranslate"><span class="pre">CacheUtils.clear()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.get_memory_usage"><code class="docutils literal notranslate"><span class="pre">get_memory_usage()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.setup_logging"><code class="docutils literal notranslate"><span class="pre">setup_logging()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.generate_summary_stats"><code class="docutils literal notranslate"><span class="pre">generate_summary_stats()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.detect_language_from_filename"><code class="docutils literal notranslate"><span class="pre">detect_language_from_filename()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.get_language_emoji"><code class="docutils literal notranslate"><span class="pre">get_language_emoji()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.SensitiveDataFilter"><code class="docutils literal notranslate"><span class="pre">SensitiveDataFilter</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.SensitiveDataFilter.filter"><code class="docutils literal notranslate"><span class="pre">SensitiveDataFilter.filter()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.install_sensitive_filter"><code class="docutils literal notranslate"><span class="pre">install_sensitive_filter()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html#utils.normalize_code"><code class="docutils literal notranslate"><span class="pre">normalize_code()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/modules.html">workspace</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/activity_reporter.html">activity_reporter module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/activity_reporter.html#activity_reporter.get_mongo_client"><code class="docutils literal notranslate"><span class="pre">get_mongo_client()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/activity_reporter.html#activity_reporter.close_mongo_client"><code class="docutils literal notranslate"><span class="pre">close_mongo_client()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/activity_reporter.html#activity_reporter.SimpleActivityReporter"><code class="docutils literal notranslate"><span class="pre">SimpleActivityReporter</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/activity_reporter.html#activity_reporter.create_reporter"><code class="docutils literal notranslate"><span class="pre">create_reporter()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/autocomplete_manager.html">autocomplete_manager module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/autocomplete_manager.html#autocomplete_manager.AutocompleteManager"><code class="docutils literal notranslate"><span class="pre">AutocompleteManager</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/backup_menu_handler.html">backup_menu_handler module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/backup_menu_handler.html#backup_menu_handler.emit_event"><code class="docutils literal notranslate"><span class="pre">emit_event()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/backup_menu_handler.html#backup_menu_handler.BackupMenuHandler"><code class="docutils literal notranslate"><span class="pre">BackupMenuHandler</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/batch_commands.html">batch_commands module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_commands.html#batch_commands.batch_analyze_command"><code class="docutils literal notranslate"><span class="pre">batch_analyze_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_commands.html#batch_commands.batch_validate_command"><code class="docutils literal notranslate"><span class="pre">batch_validate_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_commands.html#batch_commands.job_status_command"><code class="docutils literal notranslate"><span class="pre">job_status_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_commands.html#batch_commands.large_file_command"><code class="docutils literal notranslate"><span class="pre">large_file_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_commands.html#batch_commands.handle_batch_callbacks"><code class="docutils literal notranslate"><span class="pre">handle_batch_callbacks()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_commands.html#batch_commands.setup_batch_handlers"><code class="docutils literal notranslate"><span class="pre">setup_batch_handlers()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/batch_processor.html">batch_processor module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_processor.html#batch_processor.BatchJob"><code class="docutils literal notranslate"><span class="pre">BatchJob</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/batch_processor.html#batch_processor.BatchProcessor"><code class="docutils literal notranslate"><span class="pre">BatchProcessor</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/bot_handlers.html">bot_handlers module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/cache_commands.html">cache_commands module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_commands.html#cache_commands.cache_stats_command"><code class="docutils literal notranslate"><span class="pre">cache_stats_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_commands.html#cache_commands.clear_cache_command"><code class="docutils literal notranslate"><span class="pre">clear_cache_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_commands.html#cache_commands.setup_cache_handlers"><code class="docutils literal notranslate"><span class="pre">setup_cache_handlers()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/cache_manager.html">cache_manager module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_manager.html#cache_manager.CacheManager"><code class="docutils literal notranslate"><span class="pre">CacheManager</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_manager.html#cache_manager.cached"><code class="docutils literal notranslate"><span class="pre">cached()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/cache_manager.html#cache_manager.async_cached"><code class="docutils literal notranslate"><span class="pre">async_cached()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/code_preview.html">code_preview module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/code_preview.html#code_preview.CodePreviewManager"><code class="docutils literal notranslate"><span class="pre">CodePreviewManager</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/code_processor.html">code_processor module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/config.html">config module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.BotConfig"><code class="docutils literal notranslate"><span class="pre">BotConfig</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/config.html#config.load_config"><code class="docutils literal notranslate"><span class="pre">load_config()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/conftest.html">conftest module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/conftest.html#conftest.pytest_addoption"><code class="docutils literal notranslate"><span class="pre">pytest_addoption()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conftest.html#conftest.pytest_configure"><code class="docutils literal notranslate"><span class="pre">pytest_configure()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conftest.html#conftest.pytest_collection_modifyitems"><code class="docutils literal notranslate"><span class="pre">pytest_collection_modifyitems()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conftest.html#conftest.pytest_runtest_makereport"><code class="docutils literal notranslate"><span class="pre">pytest_runtest_makereport()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/conftest.html#conftest.pytest_sessionfinish"><code class="docutils literal notranslate"><span class="pre">pytest_sessionfinish()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/conversation_handlers.html">conversation_handlers module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/database.html">database package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/database.html#submodules">Submodules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/file_manager.html">file_manager module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/file_manager.html#file_manager.BackupInfo"><code class="docutils literal notranslate"><span class="pre">BackupInfo</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/file_manager.html#file_manager.BackupManager"><code class="docutils literal notranslate"><span class="pre">BackupManager</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/fix_telegram_parse_error.html">fix_telegram_parse_error module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/fix_telegram_parse_error.html#fix_telegram_parse_error.clean_for_telegram"><code class="docutils literal notranslate"><span class="pre">clean_for_telegram()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/fix_telegram_parse_error.html#fix_telegram_parse_error.apply_fix"><code class="docutils literal notranslate"><span class="pre">apply_fix()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/fix_telegram_parse_error.html#fix_telegram_parse_error.wrap_edit_message_calls"><code class="docutils literal notranslate"><span class="pre">wrap_edit_message_calls()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/github_menu_handler.html">github_menu_handler module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/github_menu_handler.html#github_menu_handler.emit_event"><code class="docutils literal notranslate"><span class="pre">emit_event()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_menu_handler.html#github_menu_handler.safe_html_escape"><code class="docutils literal notranslate"><span class="pre">safe_html_escape()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_menu_handler.html#github_menu_handler.format_bytes"><code class="docutils literal notranslate"><span class="pre">format_bytes()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_menu_handler.html#github_menu_handler.GitHubMenuHandler"><code class="docutils literal notranslate"><span class="pre">GitHubMenuHandler</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/github_upload_fix.html">github_upload_fix module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/github_upload_fix.html#github_upload_fix.github_upload_new_file"><code class="docutils literal notranslate"><span class="pre">github_upload_new_file()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_upload_fix.html#github_upload_fix.handle_document_fixed"><code class="docutils literal notranslate"><span class="pre">handle_document_fixed()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_upload_fix.html#github_upload_fix.upload_to_github_fixed"><code class="docutils literal notranslate"><span class="pre">upload_to_github_fixed()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_upload_fix.html#github_upload_fix.setup_minimal_commands"><code class="docutils literal notranslate"><span class="pre">setup_minimal_commands()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_upload_fix.html#github_upload_fix.stats_command_secured"><code class="docutils literal notranslate"><span class="pre">stats_command_secured()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/github_upload_fix.html#github_upload_fix.check_commands"><code class="docutils literal notranslate"><span class="pre">check_commands()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/handlers.html">handlers package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.html#subpackages">Subpackages</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/handlers.html#submodules">Submodules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/i18n.html">i18n package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/i18n.html#submodules">Submodules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/integrations.html">integrations module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/large_files_handler.html">large_files_handler module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/large_files_handler.html#large_files_handler.LargeFilesHandler"><code class="docutils literal notranslate"><span class="pre">LargeFilesHandler</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/lazy_loader.html">lazy_loader module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/lazy_loader.html#lazy_loader.FileChunk"><code class="docutils literal notranslate"><span class="pre">FileChunk</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/lazy_loader.html#lazy_loader.LazyLoader"><code class="docutils literal notranslate"><span class="pre">LazyLoader</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/main.html">main module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/repo_analyzer.html">repo_analyzer module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/repo_analyzer.html#repo_analyzer.emit_event"><code class="docutils literal notranslate"><span class="pre">emit_event()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/repo_analyzer.html#repo_analyzer.RepoAnalyzer"><code class="docutils literal notranslate"><span class="pre">RepoAnalyzer</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/search_engine.html">search_engine module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/secret_manager.html">secret_manager module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/secret_manager.html#secret_manager.encrypt_secret"><code class="docutils literal notranslate"><span class="pre">encrypt_secret()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/secret_manager.html#secret_manager.decrypt_secret"><code class="docutils literal notranslate"><span class="pre">decrypt_secret()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/services.html">services package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/services.html#submodules">Submodules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/terminal_commands.html">terminal_commands module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/terminal_commands.html#terminal_commands.emit_event"><code class="docutils literal notranslate"><span class="pre">emit_event()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/terminal_commands.html#terminal_commands.run_in_sandbox"><code class="docutils literal notranslate"><span class="pre">run_in_sandbox()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/terminal_commands.html#terminal_commands.terminal_enter"><code class="docutils literal notranslate"><span class="pre">terminal_enter()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/terminal_commands.html#terminal_commands.terminal_exit"><code class="docutils literal notranslate"><span class="pre">terminal_exit()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/terminal_commands.html#terminal_commands.terminal_run_command"><code class="docutils literal notranslate"><span class="pre">terminal_run_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/terminal_commands.html#terminal_commands.terminal_command"><code class="docutils literal notranslate"><span class="pre">terminal_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/terminal_commands.html#terminal_commands.setup_terminal_handlers"><code class="docutils literal notranslate"><span class="pre">setup_terminal_handlers()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/test_basic.html">test_basic module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/test_basic.html#test_basic.test_python_version"><code class="docutils literal notranslate"><span class="pre">test_python_version()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/test_basic.html#test_basic.test_import_main"><code class="docutils literal notranslate"><span class="pre">test_import_main()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/test_basic.html#test_basic.test_environment"><code class="docutils literal notranslate"><span class="pre">test_environment()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/test_basic.html#test_basic.test_basic_calculation"><code class="docutils literal notranslate"><span class="pre">test_basic_calculation()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/test_basic.html#test_basic.TestRequirements"><code class="docutils literal notranslate"><span class="pre">TestRequirements</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/user_stats.html">user_stats module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/user_stats.html#user_stats.UserStats"><code class="docutils literal notranslate"><span class="pre">UserStats</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/utils.html">utils module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CodeErrorLogger"><code class="docutils literal notranslate"><span class="pre">CodeErrorLogger</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TimeUtils"><code class="docutils literal notranslate"><span class="pre">TimeUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TextUtils"><code class="docutils literal notranslate"><span class="pre">TextUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.SecurityUtils"><code class="docutils literal notranslate"><span class="pre">SecurityUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.TelegramUtils"><code class="docutils literal notranslate"><span class="pre">TelegramUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CallbackQueryGuard"><code class="docutils literal notranslate"><span class="pre">CallbackQueryGuard</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.AsyncUtils"><code class="docutils literal notranslate"><span class="pre">AsyncUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.PerformanceUtils"><code class="docutils literal notranslate"><span class="pre">PerformanceUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.ValidationUtils"><code class="docutils literal notranslate"><span class="pre">ValidationUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.FileUtils"><code class="docutils literal notranslate"><span class="pre">FileUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.ConfigUtils"><code class="docutils literal notranslate"><span class="pre">ConfigUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.CacheUtils"><code class="docutils literal notranslate"><span class="pre">CacheUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.get_memory_usage"><code class="docutils literal notranslate"><span class="pre">get_memory_usage()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.setup_logging"><code class="docutils literal notranslate"><span class="pre">setup_logging()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.generate_summary_stats"><code class="docutils literal notranslate"><span class="pre">generate_summary_stats()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.detect_language_from_filename"><code class="docutils literal notranslate"><span class="pre">detect_language_from_filename()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.get_language_emoji"><code class="docutils literal notranslate"><span class="pre">get_language_emoji()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.SensitiveDataFilter"><code class="docutils literal notranslate"><span class="pre">SensitiveDataFilter</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.install_sensitive_filter"><code class="docutils literal notranslate"><span class="pre">install_sensitive_filter()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/utils.html#utils.normalize_code"><code class="docutils literal notranslate"><span class="pre">normalize_code()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../modules/index.html">מודולים ראשיים</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#file-management">File Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#github-integration">GitHub Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#backup-system">Backup System</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#code-processing">Code Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#search-engine">Search Engine</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#repository-analysis">Repository Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#batch-processing">Batch Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#large-files-handling">Large Files Handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#cache-management">Cache Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#user-statistics">User Statistics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#activity-reporting">Activity Reporting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#utilities">Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#lazy-loading">Lazy Loading</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#integrations">Integrations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#terminal-commands">Terminal Commands</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/index.html#autocomplete-manager">Autocomplete Manager</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../handlers/index.html">Handlers</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#show-command">Show Command</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../handlers/show.html">Show Command</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../handlers/show.html#show">מפרט פקודת <cite>/show</cite></a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/show.html#html">דוגמת תגובת HTML</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/show.html#id1">הערות יישום</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/show.html#id2">קישורים</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#drive-menu">Drive Menu</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../handlers/drive_menu.html">Drive Menu V2</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../handlers/drive_menu.html#id1">סקירה</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/drive_menu.html#id2">דגל פיצ’ר</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/drive_menu.html#id3">זרימות עיקריות</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/drive_menu.html#device-flow">התחברות (Device Flow)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/drive_menu.html#id4">טיפול שגיאות</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/drive_menu.html#id5">ניטור</a></li>
<li class="toctree-l4"><a class="reference internal" href="../handlers/drive_menu.html#module-handlers.drive.menu">API (autodoc)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#file-view-handler">File View Handler</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../handlers/index.html#file-view-handler-module">File View Handler Module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#pagination-handler">Pagination Handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#save-flow-handler">Save Flow Handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#states-handler">States Handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../handlers/index.html#github-handlers">GitHub Handlers</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../services/index.html">Services</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../services/index.html#code-service">Code Service</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../services/index.html#code-service-module">Code Service Module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../services/index.html#github-service">GitHub Service</a></li>
<li class="toctree-l2"><a class="reference internal" href="../services/index.html#backup-service">Backup Service</a></li>
<li class="toctree-l2"><a class="reference internal" href="../services/index.html#google-drive-service">Google Drive Service</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../services/google_drive_service.html">Google Drive Service</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../services/google_drive_service.html#id1">סקירה</a></li>
<li class="toctree-l4"><a class="reference internal" href="../services/google_drive_service.html#oauth">הערות OAuth</a></li>
<li class="toctree-l4"><a class="reference internal" href="../services/google_drive_service.html#id2">מבני קבצים</a></li>
<li class="toctree-l4"><a class="reference internal" href="../services/google_drive_service.html#api-autodoc">API (autodoc)</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../database/index.html">Database</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../database/index.html#database-manager">Database Manager</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/index.html#models">Models</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../database/index.html#codesnippet-model">CodeSnippet Model</a></li>
<li class="toctree-l3"><a class="reference internal" href="../database/index.html#databasemanager-class">DatabaseManager Class</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../database/index.html#database-operations">Database Operations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../database/index.html#save-operations">Save Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../database/index.html#search-operations">Search Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../database/index.html#delete-operations">Delete Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../database/index.html#statistics-operations">Statistics Operations</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../database/indexing.html">MongoDB Indexing Cookbook</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#id1">למה?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#id2">אינדקסים מומלצים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#python-pymongo">מתכונים (Python / PyMongo)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#explain-mongo-shell">בדיקות explain (Mongo Shell)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#explain">מה לחפש ב-explain?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#id3">בדיקת קיום אינדקסים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#id4">שיטות עבודה מומלצות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#id5">דוגמאות נוספות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/indexing.html#gotchas">Gotchas נפוצים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../database/cursor-pagination.html">Cursor-based Pagination (created_at / _id)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#id1">למה?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#id2">עקרונות מיון יציב</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#python">קידוד/פענוח קורסור (Python)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#id3">תבנית שאילתה (חדש → ישן)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#pymongo">PyMongo – דוגמה מלאה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#id4">דפדוף לאחור (ישן → חדש)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#copypaste">בדיקות ידניות (Copy‑Paste)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#id5">שיטות עבודה מומלצות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#gotchas">Gotchas נפוצים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/cursor-pagination.html#id6">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../database-schema.html">Database Schema</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../database-schema.html#collections">Collections</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../database-schema.html#code-snippets"><code class="docutils literal notranslate"><span class="pre">code_snippets</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../database-schema.html#users"><code class="docutils literal notranslate"><span class="pre">users</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../database-schema.html#bookmarks"><code class="docutils literal notranslate"><span class="pre">bookmarks</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../database-schema.html#sessions-webapp"><code class="docutils literal notranslate"><span class="pre">sessions</span></code> (WebApp)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../database-schema.html#indexes">Indexes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database-schema.html#relationships">Relationships</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database-schema.html#id1">קישורים</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">עזרה ודוגמאות:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../examples.html">דוגמאות שימוש</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#id2">שימוש בסיסי</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id3">יצירת אפליקציית בוט</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id4">שמירת קוד חדש</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id5">חיפוש קוד</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#handlers">שימוש ב-Handlers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#command-handler">יצירת Command Handler</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#conversation-handler">יצירת Conversation Handler</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#services">שימוש ב-Services</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id6">זיהוי שפת תכנות</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id7">ניתוח קוד</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#github">אינטגרציה עם GitHub</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#gist">העלאת קוד ל-Gist</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#gists">שליפת Gists של משתמש</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#id8">עבודה עם מסד הנתונים</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id9">ביצוע שאילתות מורכבות</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id10">עדכון קבצים</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id11">סטטיסטיקות</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#id12">טיפול בשגיאות</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id13">טיפול בשגיאות בסיסי</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#retry-logic">Retry Logic</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#id14">בדיקות</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id15">בדיקת יחידה</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id16">בדיקת אינטגרציה</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#id17">דוגמאות מתקדמות</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id18">עיבוד באצווה</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#id19">קאשינג</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../testing.html">Testing Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#quickstart">🚀 Quickstart לטסטים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#id1">הנחיות קריטיות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#stubs">טעינת Stubs לטלגרם</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#tmp-path">דוגמת שימוש ב‑tmp_path</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#id2">מחיקה בטוחה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#pytest-cov">כיסוי בדיקות (pytest-cov)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#ci">CI נתמך</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#performance">בדיקות ביצועים (Performance)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#id3">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../performance-tests.html">בדיקות ביצועים (Performance Tests)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../performance-tests.html#id1">מטרה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance-tests.html#id2">סימון טסטים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance-tests.html#id3">הרצה מקומית</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance-tests.html#ci-github-actions">CI / GitHub Actions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance-tests.html#id4">דוחות וזמני ריצה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance-tests.html#id5">טיפים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ci-cd.html">CI/CD Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../ci-cd.html#id1">חוקים קשיחים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ci-cd.html#id2">סטטוסים נדרשים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ci-cd.html#ci-overview">ריכוז CI (Overview)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ci-cd.html#id3">בדיקות מומלצות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ci-cd.html#id4">בנייה של התיעוד</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ci-cd.html#id5">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../conversation-handlers.html">Conversation Handlers &amp; States</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#id1">סקירה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#states">רשימת States (מבחר בפועל)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#save-flow">Save Flow (תרשים מצבים)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#github-flow">GitHub Flow (תרשים מצבים)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#handler">דוגמת Handler תמציתית</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#id2">טבלת זרימות מלאה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#id3">קישורים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#id4">דוגמאות קוד תמציתיות (ממשיות)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#save">Save – שלבים עיקריים</a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#github">GitHub – תפריט ושיחת העלאה</a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#backup">Backup – תפריט</a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#drive">Drive – תפריט</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#id5">מוקשים נפוצים ופתרונות</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#query-answer"><code class="docutils literal notranslate"><span class="pre">query.answer()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#message-is-not-modified">עריכת הודעות בבטחה – ”Message is not modified“</a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#filters">Filters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#persistent-data-context-user-data">Persistent data (<code class="docutils literal notranslate"><span class="pre">context.user_data</span></code>)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../conversation-handlers.html#id6">דוגמאות טסטים קצרות</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#id7">Save – התחלה וזרימה בסיסית</a></li>
<li class="toctree-l3"><a class="reference internal" href="../conversation-handlers.html#github-upload-conv-handler">GitHub – upload_conv_handler</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting.html">Troubleshooting Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#id1">שגיאות נפוצות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#importerror-telegram-conversationhandler-filters">ImportError בזמן טסטים (telegram / ConversationHandler / filters)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#parse-mode">שגיאות parse_mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#id2">דיבוג מהיר</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#mongodb">בדיקת חיבור MongoDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#id3">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../development.html">Development Workflow</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../development.html#handler">הוספת Handler חדש</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development.html#endpoint-webapp">הוספת Endpoint ל‑WebApp</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development.html#schema">עדכון Schema במסד הנתונים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development.html#id1">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../integrations.html">Integrations</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../integrations.html#github-api">GitHub API</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../integrations.html#gist">יצירת Gist (דוגמה)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../integrations.html#google-drive-oauth-flow">Google Drive (OAuth Flow)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integrations.html#telegram-webhooks-vs-polling">Telegram Webhooks vs Polling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integrations.html#id1">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../security.html">Security Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../security.html#id1">סודות ופרטיות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security.html#id2">הצפנת טוקנים (דוגמה)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security.html#csrf-webapp">CSRF ב‑WebApp</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security.html#rate-limiting">Rate Limiting (דוגמה)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security.html#id3">קישורים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security.html#id4">אבטחת הודעות בטלגרם</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../user/bookmarks.html">סימניות (Bookmarks)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../user/bookmarks.html#id1">מהן סימניות?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/bookmarks.html#id2">איך להוסיף סימנייה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/bookmarks.html#id3">פאנל הסימניות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/bookmarks.html#anchor">Anchor יציב</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/bookmarks.html#id4">מגבלות, אבטחה ופרטיות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/bookmarks.html#api">API קצר (למפתחים)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/bookmarks.html#id5">הערות שימושיות</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../user/share_code.html">שיתוף קוד (חשוב)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#id2">מה זה עושה?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#id3">איפה הכפתור מופיע?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#id4">איך זה עובד (זרימה)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#env">דרישות סביבתיות (ENV)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#id5">מגבלות והתנהגות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#id6">הודעות הצלחה/שגיאה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#troubleshooting">Troubleshooting קצר</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/share_code.html#id7">דוגמאות (טקסטואליות)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../user/github_browse.html">עיון בקוד GitHub (כולל חיפוש בשם קובץ)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../user/github_browse.html#id1">שורת כלים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/github_browse.html#id2">תוצאות חיפוש</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/github_browse.html#id3">ניווט ריפו</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../user/download_repo.html">הורדת ריפו</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../user/download_repo.html#id2">מה בדיוק מוריד</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/download_repo.html#id3">מגבלות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/download_repo.html#id4">הודעות נפוצות</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">WebApp:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../webapp/overview.html">המיני Web App (סקירה)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/overview.html#id1">מה נותן?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/overview.html#id2">כתובת והרשאות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/overview.html#env">הגדרות ENV</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/overview.html#id3">קישורים ותמונות מסך</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/caching.html">Caching &amp; HTTP Validators (ETag / Last-Modified / 304)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#id1">למה זה חשוב?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#id2">עקרונות בסיס</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#flask-werkzeug">מתכון: Flask + werkzeug</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#copypaste">בדיקות ידניות (Copy‑Paste)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#checklist">Checklist למימוש נכון</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#gotchas">Gotchas נפוצים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#cache-control">שילוב עם Cache-Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/caching.html#id3">קישורים נוספים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/static-checklist.html">Static Performance &amp; Security Checklist (gzip/br, Cache, SRI)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/static-checklist.html#id1">מטרה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/static-checklist.html#br-gzip">דחיסה (br/gzip)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/static-checklist.html#cache-control">כותרות Cache-Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/static-checklist.html#subresource-integrity-sri">Subresource Integrity (SRI)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/static-checklist.html#copypaste">בדיקות ידניות (Copy‑Paste)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/static-checklist.html#best-practices">Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/static-checklist.html#gotchas">Gotchas</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/api-reference.html">WebApp API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/api-reference.html#endpoints">Endpoints</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/api-reference.html#authentication-flow">Authentication Flow</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/api-reference.html#response-schema-example">Response Schema Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/api-reference.html#errors">Errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/api-reference.html#id1">קישורים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/api-reference.html#files">מסנן ושדות קלט ל-<code class="docutils literal notranslate"><span class="pre">/files</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../webapp/api-reference.html#id2">טבלת פרמטרים</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/api-reference.html#id3">דוגמאות בקשה</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/api-reference.html#id4">דוגמאות תגובה</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../webapp/bulk-actions.html">Bulk actions (בחירה מרובה)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapp/bulk-actions.html#id1">סקירה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/bulk-actions.html#endpoints">Endpoints</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../webapp/bulk-actions.html#post-api-files-bulk-favorite"><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/api/files/bulk-favorite</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/bulk-actions.html#post-api-files-bulk-unfavorite"><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/api/files/bulk-unfavorite</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/bulk-actions.html#post-api-files-bulk-tag"><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/api/files/bulk-tag</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/bulk-actions.html#post-api-files-create-zip"><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/api/files/create-zip</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/bulk-actions.html#post-api-files-bulk-delete-soft-delete"><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/api/files/bulk-delete</span></code> (Soft Delete)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webapp/bulk-actions.html#post-api-files-create-share-link"><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/api/files/create-share-link</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/bulk-actions.html#id2">שגיאות נפוצות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapp/bulk-actions.html#id3">הערות למפתחים</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Observability</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../observability.html">אובזרווביליות (Observability)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../observability.html#id1">מטרות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability.html#id2">קהלי יעד</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability.html#id3">תצורה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability.html#id4">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../logging_schema.html">סכמת לוגים ואירועים (Observability)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../logging_schema.html#id1">שדות חובה בכל אירוע</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logging_schema.html#id2">שדות מומלצים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logging_schema.html#id3">אירועים מרכזיים</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logging_schema.html#sampling">דגימה (Sampling)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logging_schema.html#id4">פרטיות</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../metrics.html">מדדים (Metrics)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../metrics.html#id1">נקודת קצה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metrics.html#id2">מטריקות קיימות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metrics.html#promql">דוגמאות PromQL</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../alerts.html">התראות (Alerts)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../alerts.html#id1">חוקי התראה לדוגמה</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../sentry.html">Sentry</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../sentry.html#id1">הפעלה (משתני סביבה)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sentry.html#id2">עקרונות</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../runbooks/logging-levels.html">שינוי רמות לוגים</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/logging-levels.html#debug">מתי להעלות ל-DEBUG</a></li>
<li class="toctree-l2"><a class="reference internal" href="../runbooks/logging-levels.html#id2">טיפ</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ChatOps</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../chatops/overview.html">ChatOps – סקירה כללית</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../chatops/overview.html#id1">עקרונות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/overview.html#id2">קישורים</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../chatops/commands.html">פקודות ChatOps</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#status">/status</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#errors">/errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#triage">/triage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#predict">/predict</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/commands.html#rate-limit">/rate_limit</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../chatops/playbooks.html">Playbooks – תרחישים נפוצים</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../chatops/playbooks.html#p95-latency">p95 Latency עלה מעל הסף</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/playbooks.html#error-rate-1">Error Rate &gt; 1%</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/playbooks.html#memory-usage">Memory Usage מטפס</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/playbooks.html#id1">שירות חיצוני איטי</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chatops/playbooks.html#repeated-incident-15">Repeated Incident תחת 15 דק«</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../chatops/permissions.html">הרשאות ו-Rate Limit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chatops/troubleshooting.html">פתרון תקלות (FAQ)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chatops/faq.html">שאלות נפוצות</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Observability – Advanced</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../observability/events_catalog.html">קטלוג אירועים קנוניים</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../observability/events_catalog.html#github">GitHub</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/events_catalog.html#db">DB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/events_catalog.html#web-share">Web/Share</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/events_catalog.html#alerts">Alerts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/events_catalog.html#repo-analyzer">Repo Analyzer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/events_catalog.html#business">Business</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../observability/error_codes.html">מילון קודי שגיאה (Error Codes)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../observability/error_codes.html#id1">דוגמאות מיפוי</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/error_codes.html#id2">הנחיות</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../observability/metrics_promql.html">שאילתות PromQL שימושיות</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../observability/metrics_promql.html#latency">זמן תגובה (Latency)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/metrics_promql.html#id1">שיעור שגיאות</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/metrics_promql.html#id2">אירועי ביזנס</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../observability/alerts_playbook.html">Playbook קצר להתראות</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../observability/alerts_playbook.html#id1">זרימה</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/alerts_playbook.html#id2">קישורים בקוד</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/alerts_playbook.html#id3">דגשים</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Code Keeper Bot</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">conversation_handlers</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>הראה קוד מקור ל conversation_handlers</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timezone</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">telegram</span> <span class="kn">import</span> <span class="n">Update</span><span class="p">,</span> <span class="n">ReplyKeyboardMarkup</span><span class="p">,</span> <span class="n">ReplyKeyboardRemove</span><span class="p">,</span> <span class="n">InlineKeyboardButton</span><span class="p">,</span> <span class="n">InlineKeyboardMarkup</span>
<span class="kn">from</span> <span class="nn">telegram.constants</span> <span class="kn">import</span> <span class="n">ParseMode</span>
<span class="kn">import</span> <span class="nn">telegram.error</span>
<span class="kn">from</span> <span class="nn">telegram.ext</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ContextTypes</span><span class="p">,</span>
    <span class="n">ConversationHandler</span><span class="p">,</span>
    <span class="n">CommandHandler</span><span class="p">,</span>
    <span class="n">MessageHandler</span><span class="p">,</span>
    <span class="n">CallbackQueryHandler</span><span class="p">,</span>
    <span class="n">filters</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">DatabaseManager</span>
<span class="kn">from</span> <span class="nn">file_manager</span> <span class="kn">import</span> <span class="n">backup_manager</span>
<span class="c1"># Reporter מוזרק בזמן ריצה כדי להימנע מפתיחת חיבור בעת import</span>
<span class="k">class</span> <span class="nc">_NoopReporter</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">report_activity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>

<span class="n">reporter</span> <span class="o">=</span> <span class="n">_NoopReporter</span><span class="p">()</span>

<div class="viewcode-block" id="set_activity_reporter">
<a class="viewcode-back" href="../api/conversation_handlers.html#conversation_handlers.set_activity_reporter">[תיעוד]</a>
<span class="k">def</span> <span class="nf">set_activity_reporter</span><span class="p">(</span><span class="n">new_reporter</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">reporter</span>
    <span class="n">reporter</span> <span class="o">=</span> <span class="n">new_reporter</span> <span class="ow">or</span> <span class="n">_NoopReporter</span><span class="p">()</span></div>

<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">get_language_emoji</span> <span class="k">as</span> <span class="n">get_file_emoji</span>
<span class="kn">from</span> <span class="nn">user_stats</span> <span class="kn">import</span> <span class="n">user_stats</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">cast</span>
<span class="kn">from</span> <span class="nn">html</span> <span class="kn">import</span> <span class="n">escape</span> <span class="k">as</span> <span class="n">html_escape</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">TelegramUtils</span><span class="p">,</span> <span class="n">TextUtils</span>
<span class="kn">from</span> <span class="nn">services</span> <span class="kn">import</span> <span class="n">code_service</span>
<span class="kn">from</span> <span class="nn">i18n.strings_he</span> <span class="kn">import</span> <span class="n">MAIN_MENU</span> <span class="k">as</span> <span class="n">MAIN_KEYBOARD</span>
<span class="kn">from</span> <span class="nn">handlers.pagination</span> <span class="kn">import</span> <span class="n">build_pagination_row</span>
<span class="kn">from</span> <span class="nn">config</span> <span class="kn">import</span> <span class="n">config</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">_safe_edit_message_text</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;עורך הודעה בבטיחות: מתעלם משגיאת &#39;Message is not modified&#39;.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">parse_mode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">parse_mode</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">telegram</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">BadRequest</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="k">raise</span>

<span class="k">def</span> <span class="nf">_truncate_middle</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_len</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;מקצר מחרוזת באמצע עם אליפסיס אם חורגת מאורך נתון.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">max_len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">max_len</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">text</span>
    <span class="k">if</span> <span class="n">max_len</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">text</span><span class="p">[:</span><span class="n">max_len</span><span class="p">]</span>
    <span class="n">keep</span> <span class="o">=</span> <span class="n">max_len</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">front</span> <span class="o">=</span> <span class="n">keep</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">back</span> <span class="o">=</span> <span class="n">keep</span> <span class="o">-</span> <span class="n">front</span>
    <span class="k">return</span> <span class="n">text</span><span class="p">[:</span><span class="n">front</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;…&#39;</span> <span class="o">+</span> <span class="n">text</span><span class="p">[</span><span class="o">-</span><span class="n">back</span><span class="p">:]</span>

<span class="k">def</span> <span class="nf">_repo_label_from_tag</span><span class="p">(</span><span class="n">tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;מחלץ שם ריפו מתגית בסגנון repo:owner/name&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tag</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">tag</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;repo:&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">tag</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tag</span>

<span class="k">def</span> <span class="nf">_repo_only_from_tag</span><span class="p">(</span><span class="n">tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;מחזיר רק את שם ה-repo ללא owner מתוך תגית repo:owner/name&quot;&quot;&quot;</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">_repo_label_from_tag</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">label</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">label</span> <span class="k">else</span> <span class="n">label</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">label</span>

<span class="k">def</span> <span class="nf">_build_repo_button_text</span><span class="p">(</span><span class="n">tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">count</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;בונה תווית כפתור קומפקטית לריפו, מציג רק את שם ה-repo בלי owner.&quot;&quot;&quot;</span>
    <span class="n">MAX_LEN</span> <span class="o">=</span> <span class="mi">64</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">_repo_only_from_tag</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
    <span class="n">label_short</span> <span class="o">=</span> <span class="n">_truncate_middle</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">MAX_LEN</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">label_short</span>

<span class="k">def</span> <span class="nf">_format_bytes</span><span class="p">(</span><span class="n">num</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;פורמט נוח לקריאת גדלים&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;KB&quot;</span><span class="p">,</span> <span class="s2">&quot;MB&quot;</span><span class="p">,</span> <span class="s2">&quot;GB&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">num</span> <span class="o">&lt;</span> <span class="mf">1024.0</span> <span class="ow">or</span> <span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;GB&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">num</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">unit</span> <span class="o">!=</span> <span class="s2">&quot;B&quot;</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">num</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">num</span> <span class="o">/=</span> <span class="mf">1024.0</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>

<span class="c1"># הגדרת לוגר</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># הגדרת שלבי השיחה (מועברים למודול משותף)</span>
<span class="kn">from</span> <span class="nn">handlers.states</span> <span class="kn">import</span> <span class="n">GET_CODE</span><span class="p">,</span> <span class="n">GET_FILENAME</span><span class="p">,</span> <span class="n">GET_NOTE</span><span class="p">,</span> <span class="n">EDIT_CODE</span><span class="p">,</span> <span class="n">EDIT_NAME</span><span class="p">,</span> <span class="n">WAIT_ADD_CODE_MODE</span><span class="p">,</span> <span class="n">LONG_COLLECT</span>

<span class="c1"># קבועי עימוד</span>
<span class="n">FILES_PAGE_SIZE</span> <span class="o">=</span> <span class="mi">10</span>

<span class="c1"># כפתורי המקלדת הראשית</span>
<span class="n">MAIN_KEYBOARD</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="s2">&quot;🗜️ יצירת ZIP&quot;</span><span class="p">,</span> <span class="s2">&quot;➕ הוסף קוד חדש&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;📚 הצג את כל הקבצים שלי&quot;</span><span class="p">,</span> <span class="s2">&quot;🔧 GitHub&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;⚡ עיבוד Batch&quot;</span><span class="p">,</span> <span class="s2">&quot;📥 ייבוא ZIP מריפו&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;☁️ Google Drive&quot;</span><span class="p">,</span> <span class="s2">&quot;ℹ️ הסבר על הבוט&quot;</span><span class="p">]</span>
<span class="p">]</span>

<span class="c1"># ה-reporters יוגדרו ב-main בזמן ריצה</span>

<div class="viewcode-block" id="start_command">
<a class="viewcode-back" href="../api/conversation_handlers.html#conversation_handlers.start_command">[תיעוד]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">start_command</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle /start and show the main menu.&quot;&quot;&quot;</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
    <span class="n">user_name</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">first_name</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">username</span>
    <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>
    <span class="n">db</span><span class="o">.</span><span class="n">save_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
    <span class="n">user_stats</span><span class="o">.</span><span class="n">log_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
    <span class="c1"># אם המשתמש הגיע עם פרמטר webapp_login — צור ושלח קישור התחברות אישי ל-Web App</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">args</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;webapp_login&quot;</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">hashlib</span><span class="o">,</span> <span class="nn">time</span>
            <span class="n">webapp_url</span> <span class="o">=</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">WEBAPP_URL</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;WEBAPP_URL&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;https://code-keeper-webapp.onrender.com&#39;</span><span class="p">)</span>
            <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
            <span class="n">secret</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;SECRET_KEY&#39;</span><span class="p">,</span> <span class="s1">&#39;dev-secret-key&#39;</span><span class="p">)</span>
            <span class="n">token_data</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">secret</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">auth_token</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">token_data</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">32</span><span class="p">]</span>
            <span class="c1"># שמירת הטוקן ב-DB (תוקף 5 דקות)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mongo_db</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;db&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">mongo_db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">mongo_db</span><span class="o">.</span><span class="n">webapp_tokens</span><span class="o">.</span><span class="n">insert_one</span><span class="p">({</span>
                        <span class="s1">&#39;token&#39;</span><span class="p">:</span> <span class="n">auth_token</span><span class="p">,</span>
                        <span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
                        <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span>
                        <span class="s1">&#39;created_at&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span>
                        <span class="s1">&#39;expires_at&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span>
                    <span class="p">})</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">login_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">webapp_url</span><span class="si">}</span><span class="s2">/auth/token?token=</span><span class="si">{</span><span class="n">auth_token</span><span class="si">}</span><span class="s2">&amp;user_id=</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="c1"># יבוא מקומי כדי לאפשר לסטאבים של הטלגרם להיטען גם אם המודול נטען מוקדם יותר בטסטים</span>
            <span class="kn">from</span> <span class="nn">telegram</span> <span class="kn">import</span> <span class="n">InlineKeyboardButton</span> <span class="k">as</span> <span class="n">_IKB</span><span class="p">,</span> <span class="n">InlineKeyboardMarkup</span> <span class="k">as</span> <span class="n">_IKM</span>
            <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">_IKM</span><span class="p">([</span>
                <span class="p">[</span><span class="n">_IKB</span><span class="p">(</span><span class="s2">&quot;🔐 התחבר ל-Web App&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">login_url</span><span class="p">)],</span>
                <span class="p">[</span><span class="n">_IKB</span><span class="p">(</span><span class="s2">&quot;🌐 פתח את ה-Web App&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">webapp_url</span><span class="p">)],</span>
            <span class="p">])</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;🔐 &lt;b&gt;קישור התחברות אישי ל-Web App&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;לחץ על הכפתור למטה כדי להתחבר:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;⚠️ &lt;i&gt;הקישור תקף ל-5 דקות בלבד מטעמי אבטחה&lt;/i&gt;&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="c1"># אם משהו נכשל ביצירת קישור — נמשיך לזרימת ברירת המחדל</span>
        <span class="k">pass</span>
    <span class="n">safe_user_name</span> <span class="o">=</span> <span class="n">html_escape</span><span class="p">(</span><span class="n">user_name</span><span class="p">)</span> <span class="k">if</span> <span class="n">user_name</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">i18n.strings_he</span> <span class="kn">import</span> <span class="n">MESSAGES</span>
    <span class="n">welcome_text</span> <span class="o">=</span> <span class="n">MESSAGES</span><span class="p">[</span><span class="s2">&quot;welcome&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">safe_user_name</span><span class="p">)</span>
    <span class="n">keyboard</span> <span class="o">=</span> <span class="n">ReplyKeyboardMarkup</span><span class="p">(</span><span class="n">MAIN_KEYBOARD</span><span class="p">,</span> <span class="n">resize_keyboard</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">welcome_text</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">keyboard</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span></div>


<span class="n">HELP_PAGES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span>
        <span class="s2">&quot;🤖 &lt;b&gt;ברוכים הבאים לבוט ניהול קוד!&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;בוט חכם לניהול, גיבוי וארגון קבצי קוד.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;עובד מצוין עם GitHub ותומך בכל שפות התכנות.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;➕ &lt;b&gt;הוסף קוד&lt;/b&gt; - פשוט שלחו קוד והבוט ישמור</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;📚 &lt;b&gt;הצג קבצים&lt;/b&gt; - כל הקבצים שלכם מאורגנים</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;⚡ &lt;b&gt;עיבוד Batch&lt;/b&gt; - ניתוח אוטומטי של פרויקטים</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;🔧 &lt;b&gt;GitHub&lt;/b&gt; - סנכרון וגיבוי אוטומטי</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;🌐 &lt;b&gt;Web App&lt;/b&gt; - ממשק דפדפן מתקדם</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;דפדפו לעמודים הבאים להסבר מפורט ⬅️&quot;</span>
    <span class="p">),</span>
    <span class="p">(</span>
        <span class="s2">&quot;⚡ &lt;b&gt;עיבוד Batch - הכי חשוב להבין!&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;מאפשר לבצע פעולות על &lt;u&gt;עשרות קבצים בבת אחת&lt;/u&gt;.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;&lt;b&gt;איך זה עובד?&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;1️⃣ בוחרים קבוצת קבצים (לפי ריפו/ZIP/גדולים/אחר)</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;2️⃣ בוחרים פעולה:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;📊 &lt;b&gt;ניתוח (Analyze)&lt;/b&gt; - מה מקבלים?</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• בדיקת איכות קוד (ציון 0-100)</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• זיהוי בעיות אבטחה</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• מציאת קוד כפול</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• המלצות לשיפור</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• סטטיסטיקות: שורות, פונקציות, מורכבות</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;✅ &lt;b&gt;בדיקת תקינות (Validate)&lt;/b&gt; - מה בודק?</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• שגיאות תחביר</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• ייבואים חסרים</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• משתנים לא מוגדרים</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• בעיות לוגיות</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;&lt;b&gt;דוגמה:&lt;/b&gt; יש לכם פרויקט React? הפעילו ניתוח על כל הקבצים ותקבלו דוח מלא!&quot;</span>
    <span class="p">),</span>
    <span class="p">(</span>
        <span class="s2">&quot;🔧 &lt;b&gt;אינטגרציית GitHub - מדריך מלא&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;&lt;b&gt;התחלה מהירה:&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;1️⃣ לחצו על 🔧 GitHub</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;2️⃣ הגדירו טוקן (מסבירים איך)</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;3️⃣ בחרו ריפו</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;4️⃣ מוכנים!</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;&lt;b&gt;מה אפשר לעשות?&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;📤 &lt;b&gt;העלאת קבצים&lt;/b&gt; - 2 דרכים:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• קובץ חדש - שלחו קוד והוא יעלה ישר לריפו</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• מהשמורים - בחרו קבצים שכבר יש בבוט</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;🧰 &lt;b&gt;גיבוי ושחזור&lt;/b&gt; - החכם ביותר!</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• יוצר ZIP של כל הריפו</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• שומר בבוט עם תאריך</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• אפשר לשחזר בכל רגע</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• מושלם לפני שינויים גדולים!</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;🔔 &lt;b&gt;התראות חכמות&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• מקבלים הודעה על כל commit חדש</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• מעקב אחר pull requests</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• התראות על issues&quot;</span>
    <span class="p">),</span>
    <span class="p">(</span>
        <span class="s2">&quot;📥 &lt;b&gt;ייבוא ZIP מריפו - למה זה טוב?&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;תכונה מיוחדת לייבוא פרויקטים שלמים!</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;&lt;b&gt;איך משתמשים?&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;1. הורידו ZIP מגיטהאב (Code → Download ZIP)</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;2. לחצו על 📥 ייבוא ZIP</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;3. שלחו את הקובץ</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;&lt;b&gt;מה קורה?&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• הבוט פורס את כל הקבצים</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• מתייג אוטומטית עם שם הריפו</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• שומר מבנה תיקיות</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• מאפשר עיבוד Batch על כולם!</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;🗂 &lt;b&gt;לפי ריפו - ארגון חכם&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• כל הקבצים מתויגים repo:owner/name</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• קל למצוא קבצים לפי פרויקט</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• אפשר לייצא חזרה כ-ZIP</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;&lt;b&gt;טיפ:&lt;/b&gt; יש לכם כמה פרויקטים? ייבאו אותם כ-ZIP והבוט יארגן הכל!&quot;</span>
    <span class="p">),</span>
    <span class="p">(</span>
        <span class="s2">&quot;📂 &lt;b&gt;קבצים גדולים - טיפול מיוחד&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;קבצים מעל 500 שורות מקבלים טיפול VIP:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• &lt;b&gt;טעינה חכמה&lt;/b&gt; - לא טוען הכל לזיכרון</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• &lt;b&gt;צפייה בחלקים&lt;/b&gt; - 100 שורות בכל פעם</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• &lt;b&gt;חיפוש מהיר&lt;/b&gt; - מוצא מה שצריך בלי לטעון הכל</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• &lt;b&gt;הורדה ישירה&lt;/b&gt; - מקבלים כקובץ מיד</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;&lt;b&gt;מתי זה שימושי?&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• קבצי JSON גדולים</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• לוגים ארוכים</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• קבצי נתונים</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• קוד שנוצר אוטומטית&quot;</span>
    <span class="p">),</span>
    <span class="p">(</span>
        <span class="s2">&quot;📚 &lt;b&gt;תפריט הקבצים - מה יש שם?&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;לחיצה על 📚 פותחת אפשרויות ניהול:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;🔎 &lt;b&gt;חפש קובץ&lt;/b&gt; — חיפוש לפי שם/שפה/תגית:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• שם: הקלד/י חלק משם הקובץ (למשל: &lt;code&gt;main&lt;/code&gt; או &lt;code&gt;utils.py&lt;/code&gt;)</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• שפה: הוסף/י &lt;code&gt;lang:python&lt;/code&gt; / &lt;code&gt;lang:js&lt;/code&gt; / ...</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• תגית: הוסף/י &lt;code&gt;tag:repo:owner/name&lt;/code&gt; (לפי פרויקט)</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• שילוב: לדוגמה &lt;code&gt;name:util lang:python&lt;/code&gt; או &lt;code&gt;lang:ts tag:repo:org/proj&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;🗂 &lt;b&gt;לפי ריפו&lt;/b&gt; — קבצים מאורגנים לפי פרויקט</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;📂 &lt;b&gt;קבצים גדולים&lt;/b&gt; — תצוגה מדורגת לקבצים ארוכים</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;📁 &lt;b&gt;שאר הקבצים&lt;/b&gt; — כל השאר</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;📦 &lt;b&gt;קבצי ZIP&lt;/b&gt; — גיבויים/ארכיונים</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;&lt;b&gt;לכל קובץ יש תפריט עם:&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;👁️ הצג | ✏️ ערוך | 📝 שנה שם</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;📚 היסטוריה | 📥 הורד | 🗑️ העבר לסל</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;&lt;b&gt;טיפ:&lt;/b&gt; יש עימוד (10 לעמוד) וגם &#39;הצג עוד/פחות&#39; בתצוגת קוד&quot;</span>
    <span class="p">),</span>
    <span class="p">(</span>
        <span class="s2">&quot;🔍 &lt;b&gt;ניתוח ובדיקת ריפו&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;שתי פעולות חזקות בתפריט GitHub:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;🔍 &lt;b&gt;נתח ריפו - מקבלים דוח מלא:&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• כמה קבצים מכל סוג</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• סה״כ שורות קוד</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• גודל הריפו</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• קבצים בעייתיים</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• המלצות לשיפור</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;✅ &lt;b&gt;בדוק תקינות - בדיקה עמוקה:&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• סורק את כל הקבצים</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• מוצא שגיאות תחביר</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• בודק תלויות</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• מזהה קבצים שבורים</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• נותן ציון כללי לריפו</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;&lt;b&gt;מתי להשתמש?&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• לפני מיזוג branch</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• אחרי שינויים גדולים</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• בדיקה תקופתית לפרויקט&quot;</span>
    <span class="p">),</span>
    <span class="p">(</span>
        <span class="s2">&quot;💡 &lt;b&gt;טיפים מתקדמים למשתמשי פרו&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;🏷️ &lt;b&gt;תגיות חכמות:&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• הוסיפו #frontend #backend לארגון</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• תגית repo: נוספת אוטומטית</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• חיפוש לפי תגיות בעתיד</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;🔄 &lt;b&gt;וורקפלואו מומלץ:&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;1. ייבאו פרויקט כ-ZIP</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;2. הפעילו ניתוח Batch</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;3. תקנו בעיות</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;4. העלו חזרה לגיטהאב</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;⚠️ &lt;b&gt;מגבלות:&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• קבצים עד 50MB</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• 1000 קבצים למשתמש</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• עיבוד Batch: עד 100 קבצים</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;&lt;b&gt;יש שאלות?&lt;/b&gt; הבוט די אינטואיטיבי,</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;פשוט נסו את הכפתורים! 🚀&quot;</span>
    <span class="p">),</span>
    <span class="p">(</span>
        <span class="s2">&quot;🌐 &lt;b&gt;Web App - ממשק ניהול מתקדם!&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;גישה לכל הקבצים שלכם דרך הדפדפן!</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;&lt;b&gt;מה יש ב-Web App?&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;📊 &lt;b&gt;דשבורד אישי&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• סטטיסטיקות מלאות על הקבצים</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• גרפים ותרשימים</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• פעילות אחרונה</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• שפות פופולריות</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;🔍 &lt;b&gt;חיפוש מתקדם&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• חיפוש לפי שם, תיאור או תגית</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• סינון לפי שפת תכנות</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• מיון לפי תאריך, גודל או שם</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;👁️ &lt;b&gt;צפייה בקבצים&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• הדגשת syntax צבעונית</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• מספרי שורות</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• העתקה בלחיצה</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• הורדה ישירה</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;&lt;b&gt;איך מתחברים?&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;1. לחצו על 🌐 Web App בתפריט</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;2. התחברו עם Telegram</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;3. זהו! כל הקבצים שלכם זמינים</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;🔗 כתובת: code-keeper-webapp.onrender.com&quot;</span>
    <span class="p">),</span>
    <span class="p">(</span>
        <span class="s2">&quot;🚀 &lt;b&gt;חדש ב-WebApp: מערכת סימניות חכמות&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;🏷 סימון שורות בקוד + הוספת הערות אישיות.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;&lt;b&gt;איך זה עובד?&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• לחיצה על מספר שורה → מוסיפה סימנייה אדומה קטנה</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• לחיצה חוזרת → מסירה אותה</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• לחיצה על אייקון 🔖 בצד ימין → מציגה את כל הסימניות + ההערות שלך</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;&lt;b&gt;קיצורי מקלדת&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• Ctrl / Cmd + B – הוסף/הסר סימנייה</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• Ctrl / Cmd + Shift + B – פתח/סגור פאנל סימניות</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• Escape – סגור את הפאנל</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;&lt;b&gt;פעולות עכבר&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• לחיצה על מספר שורה – הוסף/הסר סימנייה</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• Shift + Click – הוסף או ערוך הערה</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• Ctrl / Cmd + Click – מחק סימנייה</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;&lt;b&gt;מגבלות&lt;/b&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• עד 50 סימניות לקובץ</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• עד 500 למשתמש</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• עד 500 תווים לכל הערה</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;🌐 מופיע אוטומטית בעמוד צפייה בקובץ (view_file.html) ודורש משתמש מחובר.&quot;</span>
    <span class="p">),</span>
<span class="p">]</span>

<div class="viewcode-block" id="show_help_page">
<a class="viewcode-back" href="../api/conversation_handlers.html#conversation_handlers.show_help_page">[תיעוד]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">show_help_page</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">page</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;מציג עמוד עזרה עם כפתורי ניווט&quot;&quot;&quot;</span>
    <span class="n">total_pages</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">HELP_PAGES</span><span class="p">)</span>
    <span class="n">page</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">total_pages</span><span class="p">))</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">HELP_PAGES</span><span class="p">[</span><span class="n">page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">nav</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">page</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;⬅️ הקודם&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;help_page:</span><span class="si">{</span><span class="n">page</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
    <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;עמוד </span><span class="si">{</span><span class="n">page</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total_pages</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;noop&quot;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">page</span> <span class="o">&lt;</span> <span class="n">total_pages</span><span class="p">:</span>
        <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;➡️ הבא&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;help_page:</span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
    <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span><span class="n">nav</span><span class="p">,</span> <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🏠 חזרה לתפריט&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;main&quot;</span><span class="p">)]]</span>
    <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s1">&#39;callback_query&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span></div>


<span class="c1"># --- רישום handlers לקטגוריית מועדפים ---</span>
<div class="viewcode-block" id="setup_favorites_category_handlers">
<a class="viewcode-back" href="../api/conversation_handlers.html#conversation_handlers.setup_favorites_category_handlers">[תיעוד]</a>
<span class="k">def</span> <span class="nf">setup_favorites_category_handlers</span><span class="p">(</span><span class="n">application</span><span class="p">):</span>
    <span class="c1"># הוספה בקבוצת עדיפות גבוהה לפני ה-catch-all הכללי, עם fallback כאשר group לא נתמך</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CallbackQueryHandler</span><span class="p">(</span><span class="n">show_favorites_callback</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^show_favorites$&#39;</span><span class="p">),</span> <span class="n">group</span><span class="o">=-</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CallbackQueryHandler</span><span class="p">(</span><span class="n">show_favorites_callback</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^show_favorites$&#39;</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CallbackQueryHandler</span><span class="p">(</span><span class="n">show_favorites_page_callback</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^favorites_page_\d+$&#39;</span><span class="p">),</span> <span class="n">group</span><span class="o">=-</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="n">application</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">CallbackQueryHandler</span><span class="p">(</span><span class="n">show_favorites_page_callback</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^favorites_page_\d+$&#39;</span><span class="p">))</span></div>


<span class="c1"># --- Redirect file view/edit handlers to split module implementations ---</span>
<span class="kn">from</span> <span class="nn">handlers.file_view</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">handle_file_menu</span> <span class="k">as</span> <span class="n">handle_file_menu</span><span class="p">,</span>
    <span class="n">handle_view_file</span> <span class="k">as</span> <span class="n">handle_view_file</span><span class="p">,</span>
    <span class="n">handle_edit_code</span> <span class="k">as</span> <span class="n">handle_edit_code</span><span class="p">,</span>
    <span class="n">receive_new_code</span> <span class="k">as</span> <span class="n">receive_new_code</span><span class="p">,</span>
    <span class="n">handle_edit_name</span> <span class="k">as</span> <span class="n">handle_edit_name</span><span class="p">,</span>
    <span class="n">handle_edit_note</span> <span class="k">as</span> <span class="n">handle_edit_note</span><span class="p">,</span>
    <span class="n">receive_new_name</span> <span class="k">as</span> <span class="n">receive_new_name</span><span class="p">,</span>
    <span class="n">handle_versions_history</span> <span class="k">as</span> <span class="n">handle_versions_history</span><span class="p">,</span>
    <span class="n">handle_download_file</span> <span class="k">as</span> <span class="n">handle_download_file</span><span class="p">,</span>
    <span class="n">handle_delete_confirmation</span> <span class="k">as</span> <span class="n">handle_delete_confirmation</span><span class="p">,</span>
    <span class="n">handle_delete_file</span> <span class="k">as</span> <span class="n">handle_delete_file</span><span class="p">,</span>
    <span class="n">handle_file_info</span> <span class="k">as</span> <span class="n">handle_file_info</span><span class="p">,</span>
    <span class="n">handle_view_direct_file</span> <span class="k">as</span> <span class="n">handle_view_direct_file</span><span class="p">,</span>
    <span class="n">handle_edit_code_direct</span> <span class="k">as</span> <span class="n">handle_edit_code_direct</span><span class="p">,</span>
    <span class="n">handle_edit_name_direct</span> <span class="k">as</span> <span class="n">handle_edit_name_direct</span><span class="p">,</span>
    <span class="n">handle_edit_note_direct</span> <span class="k">as</span> <span class="n">handle_edit_note_direct</span><span class="p">,</span>
    <span class="n">handle_clone</span> <span class="k">as</span> <span class="n">handle_clone</span><span class="p">,</span>
    <span class="n">handle_clone_direct</span> <span class="k">as</span> <span class="n">handle_clone_direct</span><span class="p">,</span>
<span class="p">)</span>

<div class="viewcode-block" id="start_repo_zip_import">
<a class="viewcode-back" href="../api/conversation_handlers.html#conversation_handlers.start_repo_zip_import">[תיעוד]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">start_repo_zip_import</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;מצב ייבוא ZIP של ריפו: מבקש לשלוח ZIP ומכין את ה-upload_mode.&quot;&quot;&quot;</span>
    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;waiting_for_github_upload&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;upload_mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;zip_import&#39;</span>
    <span class="n">cancel_markup</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">([[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;❌ ביטול&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;cancel&quot;</span><span class="p">)]])</span>
    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
        <span class="s2">&quot;📥 שלח/י עכשיו קובץ ZIP של הריפו (העלאה ראשונית).</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;🔖 אצמיד תגית repo:owner/name (אם קיימת ב-metadata). לא מתבצעת מחיקה.&quot;</span><span class="p">,</span>
        <span class="n">reply_markup</span><span class="o">=</span><span class="n">cancel_markup</span>
    <span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span></div>


<div class="viewcode-block" id="start_zip_create_flow">
<a class="viewcode-back" href="../api/conversation_handlers.html#conversation_handlers.start_zip_create_flow">[תיעוד]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">start_zip_create_flow</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;מתחיל מצב יצירת ZIP: המשתמש שולח כמה קבצים ואז לוחץ &#39;סיום&#39;.&quot;&quot;&quot;</span>
    <span class="c1"># אתחול מצב האיסוף</span>
    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;upload_mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;zip_create&#39;</span>
    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;zip_create_items&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># כפתורי פעולה</span>
    <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;✅ סיום&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;zip_create_finish&quot;</span><span class="p">)],</span>
        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;❌ ביטול&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;zip_create_cancel&quot;</span><span class="p">)]</span>
    <span class="p">]</span>
    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
        <span class="s2">&quot;🗜️ מצב יצירת ZIP הופעל.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;שלח/י עכשיו את כל הקבצים שברצונך לכלול.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;כשתסיים/י, לחצ/י &#39;סיום&#39; וניצור עבורך ZIP מוכן.&quot;</span><span class="p">,</span>
        <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span></div>


<div class="viewcode-block" id="show_by_repo_menu">
<a class="viewcode-back" href="../api/conversation_handlers.html#conversation_handlers.show_by_repo_menu">[תיעוד]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">show_by_repo_menu</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;מציג תפריט קבוצות לפי תגיות ריפו ומאפשר בחירה.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
    <span class="c1"># שימוש באגרגציה מהירה ב-DB כדי לקבל תגיות ריפו עם ספירה</span>
    <span class="n">tags_with_counts</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_repo_tags_with_counts</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">max_tags</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">tags_with_counts</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;ℹ️ אין קבצים עם תגית ריפו.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
    <span class="c1"># בניית מקלדת</span>
    <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">tags_with_counts</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tag&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">cnt</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">tag</span><span class="p">,</span> <span class="n">cnt</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tag</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">cnt</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;by_repo:</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
    <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;files&quot;</span><span class="p">)])</span>
    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
        <span class="s2">&quot;בחר/י ריפו להצגת קבצים:&quot;</span><span class="p">,</span>
        <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span></div>


<div class="viewcode-block" id="show_by_repo_menu_callback">
<a class="viewcode-back" href="../api/conversation_handlers.html#conversation_handlers.show_by_repo_menu_callback">[תיעוד]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">show_by_repo_menu_callback</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;גרסת callback להצגת תפריט ריפו (עריכת ההודעה הנוכחית).&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
    <span class="c1"># שימוש באגרגציה מהירה ב-DB כדי לקבל תגיות ריפו עם ספירה</span>
    <span class="n">tags_with_counts</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_repo_tags_with_counts</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">max_tags</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">tags_with_counts</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">TelegramUtils</span><span class="o">.</span><span class="n">safe_edit_message_text</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s2">&quot;ℹ️ אין קבצים עם תגית ריפו.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
    <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">tags_with_counts</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tag&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">cnt</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">tag</span><span class="p">,</span> <span class="n">cnt</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tag</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">cnt</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;by_repo:</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
    <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;files&quot;</span><span class="p">)])</span>
    <span class="k">await</span> <span class="n">TelegramUtils</span><span class="o">.</span><span class="n">safe_edit_message_text</span><span class="p">(</span>
        <span class="n">query</span><span class="p">,</span>
        <span class="s2">&quot;בחר/י ריפו להצגת קבצים:&quot;</span><span class="p">,</span>
        <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span></div>

<div class="viewcode-block" id="show_all_files">
<a class="viewcode-back" href="../api/conversation_handlers.html#conversation_handlers.show_all_files">[תיעוד]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">show_all_files</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;מציג את כל הקבצים השמורים עם ממשק אינטראקטיבי מתקדם&quot;&quot;&quot;</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
    <span class="c1"># רישום פעילות למעקב סטטיסטיקות ב-MongoDB</span>
    <span class="n">user_stats</span><span class="o">.</span><span class="n">log_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>
    <span class="c1"># הקשר: חזרה מתצוגת ZIP תחזור ל&quot;📚&quot; ותבטל סינון לפי ריפו</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;zip_back_to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;files&#39;</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;github_backup_context_repo&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># מסך בחירה: כפתורי ניווט ראשיים</span>
        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔎 חפש קובץ&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;search_files&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🗂 לפי ריפו&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;by_repo_menu&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📦 קבצי ZIP&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;backup_list&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📂 קבצים גדולים&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;show_large_files&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📁 שאר הקבצים&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;show_regular_files&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;⭐ מועדפים&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;show_favorites&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🗑️ סל מיחזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;recycle_bin&quot;</span><span class="p">)],</span>
        <span class="p">]</span>
        <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
            <span class="s2">&quot;בחר/י דרך להצגת הקבצים:&quot;</span><span class="p">,</span>
            <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;שגיאה בהצגת כל הקבצים: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
            <span class="s2">&quot;❌ אירעה שגיאה בעת ניסיון לשלוף את הקבצים שלך. נסה שוב מאוחר יותר.&quot;</span><span class="p">,</span>
            <span class="n">reply_markup</span><span class="o">=</span><span class="n">ReplyKeyboardMarkup</span><span class="p">(</span><span class="n">MAIN_KEYBOARD</span><span class="p">,</span> <span class="n">resize_keyboard</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span></div>


<div class="viewcode-block" id="show_large_files_direct">
<a class="viewcode-back" href="../api/conversation_handlers.html#conversation_handlers.show_large_files_direct">[תיעוד]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">show_large_files_direct</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;הצגת קבצים גדולים ישירות מהתפריט הראשי&quot;&quot;&quot;</span>
    <span class="c1"># נקה דגלים ישנים של GitHub כדי למנוע בלבול בקלט</span>
    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;waiting_for_delete_file_path&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;waiting_for_download_file_path&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="c1"># רישום פעילות למעקב סטטיסטיקות ב-MongoDB</span>
    <span class="n">user_stats</span><span class="o">.</span><span class="n">log_user</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">large_files_handler</span> <span class="kn">import</span> <span class="n">large_files_handler</span>
    <span class="k">await</span> <span class="n">large_files_handler</span><span class="o">.</span><span class="n">show_large_files_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span></div>


<div class="viewcode-block" id="show_github_menu">
<a class="viewcode-back" href="../api/conversation_handlers.html#conversation_handlers.show_github_menu">[תיעוד]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">show_github_menu</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;הצגת תפריט GitHub&quot;&quot;&quot;</span>
    <span class="c1"># שימוש ב-instance הגלובלי במקום ליצור חדש</span>
    <span class="k">if</span> <span class="s1">&#39;github_handler&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">bot_data</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">handlers.github.menu</span> <span class="kn">import</span> <span class="n">GitHubMenuHandler</span>
        <span class="n">context</span><span class="o">.</span><span class="n">bot_data</span><span class="p">[</span><span class="s1">&#39;github_handler&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GitHubMenuHandler</span><span class="p">()</span>
    
    <span class="c1"># רישום פעילות למעקב סטטיסטיקות ב-MongoDB</span>
    <span class="n">user_stats</span><span class="o">.</span><span class="n">log_user</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
    
    <span class="n">github_handler</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">bot_data</span><span class="p">[</span><span class="s1">&#39;github_handler&#39;</span><span class="p">]</span>
    <span class="k">await</span> <span class="n">github_handler</span><span class="o">.</span><span class="n">github_menu_command</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span></div>



<div class="viewcode-block" id="show_all_files_callback">
<a class="viewcode-back" href="../api/conversation_handlers.html#conversation_handlers.show_all_files_callback">[תיעוד]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">show_all_files_callback</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;גרסת callback של show_all_files - מציגה תפריט בחירה בין סוגי קבצים&quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># הקשר: חזרה מתצוגת ZIP תחזור ל&quot;📚&quot; ותבטל סינון לפי ריפו</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;zip_back_to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;files&#39;</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;github_backup_context_repo&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🗂 לפי ריפו&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;by_repo_menu&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📦 קבצי ZIP&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;backup_list&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📂 קבצים גדולים&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;show_large_files&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📁 שאר הקבצים&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;show_regular_files&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;⭐ מועדפים&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;show_favorites&quot;</span><span class="p">)],</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🗑️ סל מיחזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;recycle_bin&quot;</span><span class="p">)],</span>
        <span class="p">]</span>
        <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">TelegramUtils</span><span class="o">.</span><span class="n">safe_edit_message_text</span><span class="p">(</span>
            <span class="n">query</span><span class="p">,</span>
            <span class="s2">&quot;בחר/י דרך להצגת הקבצים:&quot;</span><span class="p">,</span>
            <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># אל תרשום ERROR אם זו רק הודעה שלא השתנתה</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in show_all_files_callback: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">TelegramUtils</span><span class="o">.</span><span class="n">safe_edit_message_text</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s2">&quot;❌ שגיאה בטעינת התפריט&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span></div>


<div class="viewcode-block" id="show_regular_files_callback">
<a class="viewcode-back" href="../api/conversation_handlers.html#conversation_handlers.show_regular_files_callback">[תיעוד]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">show_regular_files_callback</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;הצגת קבצים רגילים בלבד&quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>
    
    <span class="c1"># Instead of creating a fake update, adapt show_all_files logic for callback queries</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
    <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># עימוד אמיתי בצד ה-DB + ללא החזרת תוכן קוד</span>
        <span class="n">files</span><span class="p">,</span> <span class="n">total_files</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_regular_files_paginated</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">per_page</span><span class="o">=</span><span class="n">FILES_PAGE_SIZE</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="s2">&quot;📂 אין לך קבצים שמורים עדיין.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;✨ לחץ על &#39;➕ הוסף קוד חדש&#39; כדי להתחיל יצירה!&quot;</span>
            <span class="p">)</span>
            <span class="c1"># כפתור חזרה לתת־התפריט של הקבצים</span>
            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;files&quot;</span><span class="p">)]]</span>
            <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;🎮 בחר פעולה:&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># עימוד והצגת דף ראשון</span>
            <span class="n">total_pages</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_files</span> <span class="o">+</span> <span class="n">FILES_PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">FILES_PAGE_SIZE</span> <span class="k">if</span> <span class="n">total_files</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="n">page</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;files_last_page&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;files_origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;regular&#39;</span> <span class="p">}</span>
            <span class="c1"># אתחול מצב מחיקה מרובה</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;rf_multi_delete&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;rf_selected_ids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;files_cache&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">start_index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">offset</span><span class="p">,</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">start_index</span> <span class="o">+</span> <span class="n">offset</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span> <span class="s1">&#39;קובץ ללא שם&#39;</span><span class="p">)</span>
                <span class="n">language</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;programming_language&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">)</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;files_cache&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">file</span>
                <span class="n">emoji</span> <span class="o">=</span> <span class="n">get_file_emoji</span><span class="p">(</span><span class="n">language</span><span class="p">)</span>
                <span class="c1"># ⭐ חיווי מועדף — רק אם השם לא ארוך מדי כדי לא לפגוע בקריאות</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span> <span class="k">as</span> <span class="n">_db</span>
                    <span class="n">is_fav</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">_db</span><span class="o">.</span><span class="n">is_favorite</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">is_fav</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">star</span> <span class="o">=</span> <span class="s2">&quot;⭐ &quot;</span> <span class="k">if</span> <span class="n">is_fav</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">35</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                <span class="n">button_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">star</span><span class="si">}{</span><span class="n">emoji</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="c1"># כפתור כניסה בלבד (ללא כפתור מועדפים ברשימה)</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">button_text</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;file_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>

            <span class="n">pagination_row</span> <span class="o">=</span> <span class="n">build_pagination_row</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">total_files</span><span class="p">,</span> <span class="n">FILES_PAGE_SIZE</span><span class="p">,</span> <span class="s2">&quot;files_page_&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pagination_row</span><span class="p">:</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pagination_row</span><span class="p">)</span>

            <span class="c1"># כפתור העברה מרובה לסל</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🗑️ העברה מרובה לסל&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;rf_multi_start&quot;</span><span class="p">)])</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;files&quot;</span><span class="p">)])</span>
            <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>

            <span class="n">header_text</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;📚 &lt;b&gt;הקבצים השמורים שלך&lt;/b&gt; — סה״כ: </span><span class="si">{</span><span class="n">total_files</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;📄 עמוד </span><span class="si">{</span><span class="n">page</span><span class="si">}</span><span class="s2"> מתוך </span><span class="si">{</span><span class="n">total_pages</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;✨ לחץ על קובץ לחוויה מלאה של עריכה וניהול:&quot;</span>
            <span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                    <span class="n">header_text</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span><span class="p">,</span>
                    <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">telegram</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="k">raise</span>
            
        <span class="k">try</span><span class="p">:</span>
            <span class="n">reporter</span><span class="o">.</span><span class="n">report_activity</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in show_regular_files_callback: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ שגיאה בטעינת הקבצים&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span></div>


<div class="viewcode-block" id="show_favorites_callback">
<a class="viewcode-back" href="../api/conversation_handlers.html#conversation_handlers.show_favorites_callback">[תיעוד]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">show_favorites_callback</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;הצגת מועדפים (רשימת קבצים מסומנים is_favorite=True) עם עימוד קל בצד הבוט.</span>
<span class="sd">    משתמש ב-db.get_favorites ומחלק לעמודים בגודל FILES_PAGE_SIZE.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;טוען מועדפים…&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
    <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">favs</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_favorites</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">favs</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="s2">&quot;💭 אין לך מועדפים כרגע.</span><span class="se">\n</span><span class="s2">הוסף בעזרת /favorite &amp;lt;שם&amp;gt; או דרך כפתור ⭐ במסכי הקובץ&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span>
            <span class="p">)</span>
            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;files&quot;</span><span class="p">)]]</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;🎮 בחר פעולה:&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
        <span class="c1"># עמוד ראשון</span>
        <span class="n">page</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">total_files</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">favs</span><span class="p">)</span>
        <span class="n">total_pages</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_files</span> <span class="o">+</span> <span class="n">FILES_PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">FILES_PAGE_SIZE</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;files_last_page&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;files_origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;favorites&#39;</span> <span class="p">}</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;files_cache&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">FILES_PAGE_SIZE</span><span class="p">,</span> <span class="n">total_files</span><span class="p">)</span>
        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">favs</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">],</span> <span class="n">start</span><span class="p">):</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;files_cache&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">file</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span> <span class="s1">&#39;file&#39;</span><span class="p">)</span>
            <span class="n">lang</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;programming_language&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">)</span>
            <span class="n">emoji</span> <span class="o">=</span> <span class="n">get_file_emoji</span><span class="p">(</span><span class="n">lang</span><span class="p">)</span>
            <span class="c1"># כפתור כניסה + כפתור מועדפים ישיר</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">fid</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="n">fid</span><span class="p">:</span>
                <span class="n">fav_cb</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;fav_toggle_id:</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fav_cb</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;fav_toggle_tok:</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">tokens_map</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fav_tokens&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
                <span class="n">tokens_map</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">name</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;fav_tokens&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tokens_map</span>
            <span class="c1"># קבע תווית מדויקת לפי המסד (בטוח יותר מהשדה במסמך שמוחזר מהרשימה)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span> <span class="k">as</span> <span class="n">_db</span>
                <span class="n">is_fav</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">_db</span><span class="o">.</span><span class="n">is_favorite</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">is_fav</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># בהקשר &#39;מועדפים&#39; נניח שזה מועדף</span>
            <span class="n">fav_label</span> <span class="o">=</span> <span class="s2">&quot;💔 הסר ממועדפים&quot;</span> <span class="k">if</span> <span class="n">is_fav</span> <span class="k">else</span> <span class="s2">&quot;⭐ הוסף למועדפים&quot;</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">emoji</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;file_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">fav_label</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="n">fav_cb</span><span class="p">)</span>
            <span class="p">])</span>
        <span class="kn">from</span> <span class="nn">handlers.pagination</span> <span class="kn">import</span> <span class="n">build_pagination_row</span>
        <span class="n">pagination_row</span> <span class="o">=</span> <span class="n">build_pagination_row</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">total_files</span><span class="p">,</span> <span class="n">FILES_PAGE_SIZE</span><span class="p">,</span> <span class="s2">&quot;favorites_page_&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pagination_row</span><span class="p">:</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pagination_row</span><span class="p">)</span>
        <span class="c1"># כפתור חזרה לתת־תפריט הקבצים</span>
        <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;files&quot;</span><span class="p">)])</span>
        <span class="n">header</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;⭐ &lt;b&gt;המועדפים שלך&lt;/b&gt; — סה״כ: </span><span class="si">{</span><span class="n">total_files</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;📄 עמוד </span><span class="si">{</span><span class="n">page</span><span class="si">}</span><span class="s2"> מתוך </span><span class="si">{</span><span class="n">total_pages</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;✨ לחץ על קובץ להצגה מלאה:&quot;</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">telegram</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">TelegramUtils</span> <span class="k">as</span> <span class="n">_TU</span>
                    <span class="k">await</span> <span class="n">_TU</span><span class="o">.</span><span class="n">safe_edit_message_reply_markup</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in show_favorites_callback: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ שגיאה בטעינת מועדפים&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span></div>


<div class="viewcode-block" id="show_favorites_page_callback">
<a class="viewcode-back" href="../api/conversation_handlers.html#conversation_handlers.show_favorites_page_callback">[תיעוד]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">show_favorites_page_callback</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
    <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">favs</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_favorites</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">total_files</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">favs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">total_files</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;💭 אין מועדפים להצגה&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;🎮 בחר פעולה:&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">([[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;files&quot;</span><span class="p">)]]))</span>
            <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;files_last_page&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">page</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span>
        <span class="n">total_pages</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_files</span> <span class="o">+</span> <span class="n">FILES_PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">FILES_PAGE_SIZE</span>
        <span class="n">page</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">total_pages</span><span class="p">)</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;files_last_page&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;files_origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;favorites&#39;</span> <span class="p">}</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;files_cache&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">FILES_PAGE_SIZE</span>
        <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">FILES_PAGE_SIZE</span><span class="p">,</span> <span class="n">total_files</span><span class="p">)</span>
        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">favs</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">],</span> <span class="n">start</span><span class="p">):</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;files_cache&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">file</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span> <span class="s1">&#39;file&#39;</span><span class="p">)</span>
            <span class="n">lang</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;programming_language&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">)</span>
            <span class="n">emoji</span> <span class="o">=</span> <span class="n">get_file_emoji</span><span class="p">(</span><span class="n">lang</span><span class="p">)</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">emoji</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;file_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
        <span class="kn">from</span> <span class="nn">handlers.pagination</span> <span class="kn">import</span> <span class="n">build_pagination_row</span>
        <span class="n">pagination_row</span> <span class="o">=</span> <span class="n">build_pagination_row</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">total_files</span><span class="p">,</span> <span class="n">FILES_PAGE_SIZE</span><span class="p">,</span> <span class="s2">&quot;favorites_page_&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pagination_row</span><span class="p">:</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pagination_row</span><span class="p">)</span>
        <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;files&quot;</span><span class="p">)])</span>
        <span class="n">header</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;⭐ &lt;b&gt;המועדפים שלך&lt;/b&gt; — סה״כ: </span><span class="si">{</span><span class="n">total_files</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;📄 עמוד </span><span class="si">{</span><span class="n">page</span><span class="si">}</span><span class="s2"> מתוך </span><span class="si">{</span><span class="n">total_pages</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;✨ לחץ על קובץ להצגה מלאה:&quot;</span>
        <span class="p">)</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in show_favorites_page_callback: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ שגיאה בטעינת עמוד מועדפים&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span></div>


<div class="viewcode-block" id="show_regular_files_page_callback">
<a class="viewcode-back" href="../api/conversation_handlers.html#conversation_handlers.show_regular_files_page_callback">[תיעוד]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">show_regular_files_page_callback</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;מעבר בין עמודים בתצוגת &#39;הקבצים השמורים שלך&#39;&quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
    <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># שלוף דף ספציפי מה-DB ללא תוכן קוד (ה-DB כבר מהדק עמוד חוקי במידת הצורך)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">requested_page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">requested_page</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;files_last_page&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">1</span>
        <span class="n">requested_page</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">requested_page</span><span class="p">)</span>
        <span class="n">files</span><span class="p">,</span> <span class="n">total_files</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_regular_files_paginated</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="n">requested_page</span><span class="p">,</span> <span class="n">per_page</span><span class="o">=</span><span class="n">FILES_PAGE_SIZE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">total_files</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># אם אין קבצים, הצג הודעה וכפתור חזרה לתת־התפריט של הקבצים</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="s2">&quot;📂 אין לך קבצים שמורים עדיין.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;✨ לחץ על &#39;➕ הוסף קוד חדש&#39; כדי להתחיל יצירה!&quot;</span>
            <span class="p">)</span>
            <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">([[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;files&quot;</span><span class="p">)]])</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;🎮 בחר פעולה:&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>

        <span class="c1"># חישוב מספר העמודים והידוק &#39;page_used&#39; לעמוד חוקי, תואם לפריטים שחזרו מה-DB</span>
        <span class="n">total_pages</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_files</span> <span class="o">+</span> <span class="n">FILES_PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">FILES_PAGE_SIZE</span> <span class="k">if</span> <span class="n">total_files</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="n">page_used</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">requested_page</span><span class="p">),</span> <span class="n">total_pages</span><span class="p">)</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;files_last_page&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">page_used</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;files_origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;regular&#39;</span> <span class="p">}</span>

        <span class="c1"># בנה מקלדת לדף המבוקש</span>
        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">multi_on</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rf_multi_delete&#39;</span><span class="p">))</span>
        <span class="n">selected_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rf_selected_ids&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[])</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;files_cache&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">start_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">page_used</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">FILES_PAGE_SIZE</span>
        <span class="k">for</span> <span class="n">offset</span><span class="p">,</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">start_index</span> <span class="o">+</span> <span class="n">offset</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span> <span class="s1">&#39;קובץ ללא שם&#39;</span><span class="p">)</span>
            <span class="n">language</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;programming_language&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">)</span>
            <span class="n">emoji</span> <span class="o">=</span> <span class="n">get_file_emoji</span><span class="p">(</span><span class="n">language</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">multi_on</span><span class="p">:</span>
                <span class="n">file_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">checked</span> <span class="o">=</span> <span class="s2">&quot;☑️&quot;</span> <span class="k">if</span> <span class="n">file_id</span> <span class="ow">in</span> <span class="n">selected_ids</span> <span class="k">else</span> <span class="s2">&quot;⬜️&quot;</span>
                <span class="n">button_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">checked</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">button_text</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;rf_toggle:</span><span class="si">{</span><span class="n">page_used</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">file_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;files_cache&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">file</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span> <span class="k">as</span> <span class="n">_db</span>
                    <span class="n">is_fav</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">_db</span><span class="o">.</span><span class="n">is_favorite</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">is_fav</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">star</span> <span class="o">=</span> <span class="s2">&quot;⭐ &quot;</span> <span class="k">if</span> <span class="n">is_fav</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">35</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                <span class="n">button_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">star</span><span class="si">}{</span><span class="n">emoji</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">button_text</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;file_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>

        <span class="n">pagination_row</span> <span class="o">=</span> <span class="n">build_pagination_row</span><span class="p">(</span><span class="n">page_used</span><span class="p">,</span> <span class="n">total_files</span><span class="p">,</span> <span class="n">FILES_PAGE_SIZE</span><span class="p">,</span> <span class="s2">&quot;files_page_&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pagination_row</span><span class="p">:</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pagination_row</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">multi_on</span><span class="p">:</span>
            <span class="n">count_sel</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_ids</span><span class="p">)</span>
            <span class="c1"># כפתורי העברה/ביטול במצב מחיקה מרובה</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🗑️ העבר נבחרים לסל (</span><span class="si">{</span><span class="n">count_sel</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;rf_delete_confirm&quot;</span><span class="p">)])</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;❌ בטל העברה מרובה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;rf_multi_cancel&quot;</span><span class="p">)])</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;files&quot;</span><span class="p">)])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># כפתור העברה מרובה לסל במצב רגיל</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🗑️ העברה מרובה לסל&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;rf_multi_start&quot;</span><span class="p">)])</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;files&quot;</span><span class="p">)])</span>
        <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>

        <span class="n">header_text</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;📚 &lt;b&gt;הקבצים השמורים שלך&lt;/b&gt; — סה״כ: </span><span class="si">{</span><span class="n">total_files</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;📄 עמוד </span><span class="si">{</span><span class="n">page_used</span><span class="si">}</span><span class="s2"> מתוך </span><span class="si">{</span><span class="n">total_pages</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;✨ לחץ על קובץ לחוויה מלאה של עריכה וניהול:&quot;</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="n">header_text</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">telegram</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">raise</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in show_regular_files_page_callback: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ שגיאה בטעינת עמוד הקבצים&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span></div>


<span class="kn">from</span> <span class="nn">handlers.save_flow</span> <span class="kn">import</span> <span class="n">start_save_flow</span> <span class="k">as</span> <span class="n">start_save_flow</span>
<span class="kn">from</span> <span class="nn">handlers.save_flow</span> <span class="kn">import</span> <span class="n">start_add_code_menu</span> <span class="k">as</span> <span class="n">start_add_code_menu</span>
<span class="kn">from</span> <span class="nn">handlers.save_flow</span> <span class="kn">import</span> <span class="n">start_long_collect</span> <span class="k">as</span> <span class="n">start_long_collect</span>
<span class="kn">from</span> <span class="nn">handlers.save_flow</span> <span class="kn">import</span> <span class="n">long_collect_receive</span> <span class="k">as</span> <span class="n">long_collect_receive</span>
<span class="kn">from</span> <span class="nn">handlers.save_flow</span> <span class="kn">import</span> <span class="n">long_collect_done</span> <span class="k">as</span> <span class="n">long_collect_done</span>

<span class="kn">from</span> <span class="nn">handlers.save_flow</span> <span class="kn">import</span> <span class="n">get_code</span> <span class="k">as</span> <span class="n">get_code</span>

<span class="kn">from</span> <span class="nn">handlers.save_flow</span> <span class="kn">import</span> <span class="n">get_filename</span> <span class="k">as</span> <span class="n">get_filename</span>

<span class="kn">from</span> <span class="nn">handlers.save_flow</span> <span class="kn">import</span> <span class="n">get_note</span> <span class="k">as</span> <span class="n">get_note</span>

<span class="kn">from</span> <span class="nn">handlers.save_flow</span> <span class="kn">import</span> <span class="n">save_file_final</span> <span class="k">as</span> <span class="n">save_file_final</span>

<span class="c1"># --- Recycle bin paging constants ---</span>
<span class="n">RECYCLE_PAGE_SIZE</span> <span class="o">=</span> <span class="mi">10</span>

<div class="viewcode-block" id="show_recycle_bin">
<a class="viewcode-back" href="../api/conversation_handlers.html#conversation_handlers.show_recycle_bin">[תיעוד]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">show_recycle_bin</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">TelegramUtils</span><span class="o">.</span><span class="n">safe_answer</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="ow">or</span> <span class="s2">&quot;recycle_page_1&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;recycle_page_&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">page</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>
        <span class="n">page</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span>
        <span class="n">items</span><span class="p">,</span> <span class="n">total</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">_get_repo</span><span class="p">()</span><span class="o">.</span><span class="n">list_deleted_files</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="n">page</span><span class="p">,</span> <span class="n">per_page</span><span class="o">=</span><span class="n">RECYCLE_PAGE_SIZE</span><span class="p">)</span>
        <span class="n">total_pages</span> <span class="o">=</span> <span class="p">(</span><span class="n">total</span> <span class="o">+</span> <span class="n">RECYCLE_PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">RECYCLE_PAGE_SIZE</span> <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="n">fid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span> <span class="s1">&#39;file&#39;</span><span class="p">)</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;♻️ שחזר: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;recycle_restore:</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🧨 מחיקה סופית&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;recycle_purge:</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="p">])</span>
        <span class="n">nav</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">page</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;⬅️ הקודם&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;recycle_page_</span><span class="si">{</span><span class="n">page</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">page</span> <span class="o">&lt;</span> <span class="n">total_pages</span><span class="p">:</span>
            <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;➡️ הבא&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;recycle_page_</span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">nav</span><span class="p">:</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nav</span><span class="p">)</span>
        <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;files&quot;</span><span class="p">)])</span>
        <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
        <span class="n">header</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;🗑️ &lt;b&gt;סל מיחזור&lt;/b&gt; — </span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s2"> פריטים</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;📄 עמוד </span><span class="si">{</span><span class="n">page</span><span class="si">}</span><span class="s2"> מתוך </span><span class="si">{</span><span class="n">total_pages</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">await</span> <span class="n">TelegramUtils</span><span class="o">.</span><span class="n">safe_edit_message_text</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;show_recycle_bin failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">TelegramUtils</span><span class="o">.</span><span class="n">safe_edit_message_text</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s2">&quot;❌ שגיאה בטעינת סל המיחזור&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span></div>


<div class="viewcode-block" id="recycle_restore">
<a class="viewcode-back" href="../api/conversation_handlers.html#conversation_handlers.recycle_restore">[תיעוד]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">recycle_restore</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">TelegramUtils</span><span class="o">.</span><span class="n">safe_answer</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">fid</span> <span class="o">=</span> <span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fid</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">TelegramUtils</span><span class="o">.</span><span class="n">safe_answer</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s2">&quot;בקשה לא תקפה&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
        <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">_get_repo</span><span class="p">()</span><span class="o">.</span><span class="n">restore_file_by_id</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">fid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">TelegramUtils</span><span class="o">.</span><span class="n">safe_answer</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s2">&quot;♻️ שוחזר&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">TelegramUtils</span><span class="o">.</span><span class="n">safe_answer</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s2">&quot;❌ שגיאת שחזור&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">show_recycle_bin</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;recycle_restore failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">TelegramUtils</span><span class="o">.</span><span class="n">safe_edit_message_text</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s2">&quot;❌ שגיאה בשחזור&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span></div>


<div class="viewcode-block" id="recycle_purge">
<a class="viewcode-back" href="../api/conversation_handlers.html#conversation_handlers.recycle_purge">[תיעוד]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">recycle_purge</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">TelegramUtils</span><span class="o">.</span><span class="n">safe_answer</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">fid</span> <span class="o">=</span> <span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">data</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fid</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">TelegramUtils</span><span class="o">.</span><span class="n">safe_answer</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s2">&quot;בקשה לא תקפה&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
        <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">_get_repo</span><span class="p">()</span><span class="o">.</span><span class="n">purge_file_by_id</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">fid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">TelegramUtils</span><span class="o">.</span><span class="n">safe_answer</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s2">&quot;🧨 נמחק לצמיתות&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">TelegramUtils</span><span class="o">.</span><span class="n">safe_answer</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s2">&quot;❌ שגיאת מחיקה סופית&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">show_recycle_bin</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;recycle_purge failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">TelegramUtils</span><span class="o">.</span><span class="n">safe_edit_message_text</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s2">&quot;❌ שגיאה במחיקה סופית&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span></div>

<div class="viewcode-block" id="share_single_by_id">
<a class="viewcode-back" href="../api/conversation_handlers.html#conversation_handlers.share_single_by_id">[תיעוד]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">share_single_by_id</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">service</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">file_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;שיתוף קובץ יחיד לפי ObjectId בשירות מבוקש (gist/pastebin).&quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>
        <span class="kn">from</span> <span class="nn">bson</span> <span class="kn">import</span> <span class="n">ObjectId</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        <span class="c1"># ודא שהקובץ שייך למשתמש</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="n">file_id</span><span class="p">),</span> <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">})</span>
        <span class="c1"># אם לא נמצא בקולקשן הרגיל, נסה בקבצים גדולים</span>
        <span class="n">is_large</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">doc</span><span class="p">:</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">large_files_collection</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="n">file_id</span><span class="p">),</span> <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">doc</span><span class="p">:</span>
                <span class="n">is_large</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">doc</span><span class="p">:</span>
            <span class="c1"># במקום להציג שגיאה שגויה ואז הצלחה, נציג התראה קצרה בלבד ונפסיק</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;קובץ לא נמצא&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;file.txt&#39;</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
        <span class="n">language</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;programming_language&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;text&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">code</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ תוכן הקובץ ריק או חסר&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
        <span class="kn">from</span> <span class="nn">integrations</span> <span class="kn">import</span> <span class="n">code_sharing</span>
        <span class="k">if</span> <span class="n">service</span> <span class="o">==</span> <span class="s1">&#39;gist&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">GITHUB_TOKEN</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ Gist לא זמין (חסר GITHUB_TOKEN)&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">code_sharing</span><span class="o">.</span><span class="n">share_code</span><span class="p">(</span><span class="s1">&#39;gist&#39;</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">language</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;שיתוף דרך CodeBot — </span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ יצירת Gist נכשלה&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;🐙 **שותף ב-GitHub Gist!**</span><span class="se">\n\n</span><span class="s2">📄 `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">`</span><span class="se">\n</span><span class="s2">🔗 </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">service</span> <span class="o">==</span> <span class="s1">&#39;pastebin&#39;</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">code_sharing</span><span class="o">.</span><span class="n">share_code</span><span class="p">(</span><span class="s1">&#39;pastebin&#39;</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">language</span><span class="p">,</span> <span class="n">private</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">expire</span><span class="o">=</span><span class="s1">&#39;1M&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ יצירת Pastebin נכשלה&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;📋 **שותף ב-Pastebin!**</span><span class="se">\n\n</span><span class="s2">📄 `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">`</span><span class="se">\n</span><span class="s2">🔗 </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
            <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in share_single_by_id: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ שגיאה בשיתוף הקובץ&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span></div>

<div class="viewcode-block" id="handle_duplicate_callback">
<a class="viewcode-back" href="../api/conversation_handlers.html#conversation_handlers.handle_duplicate_callback">[תיעוד]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">handle_duplicate_callback</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;טיפול בכפתורי הכפילות&quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>
    
    <span class="n">data</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span>
    
    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;replace_&quot;</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;replace_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">save_file_final</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;rename_file&quot;</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
            <span class="s2">&quot;✏️ *שנה שם קובץ*</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;📝 שלח שם קובץ חדש:&quot;</span><span class="p">,</span>
            <span class="n">parse_mode</span><span class="o">=</span><span class="s1">&#39;Markdown&#39;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">GET_FILENAME</span>
    <span class="k">elif</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;cancel_save&quot;</span><span class="p">:</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;🚫 השמירה בוטלה!&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
            <span class="s2">&quot;🏠 חוזרים לתפריט הראשי:&quot;</span><span class="p">,</span>
            <span class="n">reply_markup</span><span class="o">=</span><span class="n">ReplyKeyboardMarkup</span><span class="p">(</span><span class="n">MAIN_KEYBOARD</span><span class="p">,</span> <span class="n">resize_keyboard</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
    
    <span class="k">return</span> <span class="n">GET_FILENAME</span></div>


<div class="viewcode-block" id="handle_file_menu">
<a class="viewcode-back" href="../api/conversation_handlers.html#conversation_handlers.handle_file_menu">[תיעוד]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">handle_file_menu</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;תפריט קובץ מתקדם עם אפשרויות רבות&quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">file_index</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">files_cache</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;files_cache&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">file_data</span> <span class="o">=</span> <span class="n">files_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">file_index</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_data</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ שגיאה בזיהוי הקובץ החכם&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
        
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span> <span class="s1">&#39;קובץ מיסתורי&#39;</span><span class="p">)</span>
        <span class="n">language</span> <span class="o">=</span> <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;programming_language&#39;</span><span class="p">,</span> <span class="s1">&#39;לא ידועה&#39;</span><span class="p">)</span>
        
        <span class="c1"># כפתורים מתקדמים מלאים</span>
        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;👁️ הצג קוד&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;view_</span><span class="si">{</span><span class="n">file_index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;✏️ ערוך&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;edit_code_</span><span class="si">{</span><span class="n">file_index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="p">[</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📝 שנה שם&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;edit_name_</span><span class="si">{</span><span class="n">file_index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📝 ערוך הערה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;edit_note_</span><span class="si">{</span><span class="n">file_index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="p">[</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📚 היסטוריה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;versions_</span><span class="si">{</span><span class="n">file_index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📥 הורד&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;dl_</span><span class="si">{</span><span class="n">file_index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="p">[</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔗 שתף קוד&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;share_menu_idx:</span><span class="si">{</span><span class="n">file_index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="p">[</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔄 שכפול&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;clone_</span><span class="si">{</span><span class="n">file_index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🗑️ מחק&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;del_</span><span class="si">{</span><span class="n">file_index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">]</span>

        <span class="c1"># כפתור חזרה בהתאם למקור הרשימה (שאר הקבצים/לפי ריפו)</span>
        <span class="n">last_page</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;files_last_page&#39;</span><span class="p">)</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;files_origin&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">origin</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;by_repo&#39;</span> <span class="ow">and</span> <span class="n">origin</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tag&#39;</span><span class="p">):</span>
            <span class="n">back_cb</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;by_repo:</span><span class="si">{</span><span class="n">origin</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tag&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">elif</span> <span class="n">origin</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;regular&#39;</span><span class="p">:</span>
            <span class="n">back_cb</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;files_page_</span><span class="si">{</span><span class="n">last_page</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">last_page</span> <span class="k">else</span> <span class="s2">&quot;show_regular_files&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">back_cb</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;files_page_</span><span class="si">{</span><span class="n">last_page</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">last_page</span> <span class="k">else</span> <span class="s2">&quot;files&quot;</span>
        <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזרה לרשימה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="n">back_cb</span><span class="p">)])</span>
        
        <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
        
        <span class="c1"># הוסף הצגת הערה אם קיימת</span>
        <span class="n">note</span> <span class="o">=</span> <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">note</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">safe_note_md</span> <span class="o">=</span> <span class="n">TextUtils</span><span class="o">.</span><span class="n">escape_markdown</span><span class="p">(</span><span class="n">note</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">safe_note_md</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">note</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;`&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">`&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">*&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">_&#39;</span><span class="p">)</span>
            <span class="n">note_line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">📝 הערה: </span><span class="si">{</span><span class="n">safe_note_md</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">note_line</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">📝 הערה: —</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="k">await</span> <span class="n">TelegramUtils</span><span class="o">.</span><span class="n">safe_edit_message_text</span><span class="p">(</span>
            <span class="n">query</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;🎯 *מרכז בקרה מתקדם*</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;📄 **קובץ:** `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">`</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;🧠 **שפה:** </span><span class="si">{</span><span class="n">language</span><span class="si">}{</span><span class="n">note_line</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;🎮 בחר פעולה מתקדמת:&quot;</span><span class="p">,</span>
            <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span><span class="p">,</span>
            <span class="n">parse_mode</span><span class="o">=</span><span class="s1">&#39;Markdown&#39;</span>
        <span class="p">)</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in handle_file_menu: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;💥 שגיאה במרכז הבקרה המתקדם&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span></div>


<div class="viewcode-block" id="handle_view_file">
<a class="viewcode-back" href="../api/conversation_handlers.html#conversation_handlers.handle_view_file">[תיעוד]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">handle_view_file</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;מפנה למימוש המרכזי ב-handlers.file_view כדי לאפשר &#39;הצג עוד/פחות&#39;.&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">handlers.file_view</span> <span class="k">as</span> <span class="nn">file_view_handlers</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">file_view_handlers</span><span class="o">.</span><span class="n">handle_view_file</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<div class="viewcode-block" id="handle_edit_code">
<a class="viewcode-back" href="../api/conversation_handlers.html#conversation_handlers.handle_edit_code">[תיעוד]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">handle_edit_code</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;התחלת עריכת קוד&quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">file_index</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">files_cache</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;files_cache&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">file_data</span> <span class="o">=</span> <span class="n">files_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">file_index</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_data</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ שגיאה בזיהוי הקובץ&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
        
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;editing_file_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_index</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;editing_file_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_data</span>
        
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span> <span class="s1">&#39;קובץ&#39;</span><span class="p">)</span>
        
        <span class="k">await</span> <span class="n">TelegramUtils</span><span class="o">.</span><span class="n">safe_edit_message_text</span><span class="p">(</span>
            <span class="n">query</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;✏️ *עריכת קוד מתקדמת*</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;📄 **קובץ:** `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">`</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;📝 שלח את הקוד החדש והמעודכן:&quot;</span><span class="p">,</span>
            <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">([[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזרה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;file_</span><span class="si">{</span><span class="n">file_index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)]]),</span>
            <span class="n">parse_mode</span><span class="o">=</span><span class="s1">&#39;Markdown&#39;</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">EDIT_CODE</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># לוגים מפורטים לשגיאות עריכה</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in handle_edit_code: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User ID: </span><span class="si">{</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Query data: </span><span class="si">{</span><span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;No query&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># רישום בלוגר הייעודי</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">code_processor</span> <span class="kn">import</span> <span class="n">code_processor</span>
            <span class="n">code_processor</span><span class="o">.</span><span class="n">code_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;שגיאה בהתחלת עריכת קוד עבור משתמש </span><span class="si">{</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
            <span class="s2">&quot;❌ שגיאה בהתחלת עריכה</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;🔄 אנא נסה שוב או חזור לתפריט הראשי</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;📞 אם הבעיה נמשכת, פנה לתמיכה&quot;</span>
        <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span></div>


<div class="viewcode-block" id="receive_new_code">
<a class="viewcode-back" href="../api/conversation_handlers.html#conversation_handlers.receive_new_code">[תיעוד]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">receive_new_code</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;קבלת הקוד החדש לעריכה&quot;&quot;&quot;</span>
    <span class="c1"># אם אנו במצב עריכת הערה (description), ננתב לפונקציה יעודית</span>
    <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;editing_note_file&#39;</span><span class="p">):</span>
        <span class="n">note_text</span> <span class="o">=</span> <span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">text</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;editing_note_file&#39;</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>
            <span class="c1"># שלוף את המסמך האחרון ועדכן תיאור</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">doc</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;❌ הקובץ לא נמצא לעדכון הערה&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
            <span class="c1"># צור גרסה חדשה עם אותו קוד ושם, עדכון שדה description</span>
            <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">CodeSnippet</span>
            <span class="n">snippet</span> <span class="o">=</span> <span class="n">CodeSnippet</span><span class="p">(</span>
                <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
                <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span>
                <span class="n">code</span><span class="o">=</span><span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                <span class="n">programming_language</span><span class="o">=</span><span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;programming_language&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">),</span>
                <span class="n">description</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">note_text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;מחק&#39;</span> <span class="k">else</span> <span class="n">note_text</span><span class="p">)[:</span><span class="mi">280</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">save_code_snippet</span><span class="p">(</span><span class="n">snippet</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                    <span class="s2">&quot;✅ הערה עודכנה בהצלחה!&quot;</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">([[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזרה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;view_direct_</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)]])</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;❌ שגיאה בעדכון ההערה&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error updating note: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;❌ שגיאה בעדכון ההערה&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>

    <span class="c1"># שחזור טקסט עם סימוני Markdown שנבלעו (אם יש), בהתאם למדיניות השימור</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">new_code</span> <span class="o">=</span> <span class="n">TelegramUtils</span><span class="o">.</span><span class="n">extract_message_text_preserve_markdown</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">new_code</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">text</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
    
    <span class="c1"># בדיקה אם מדובר בעריכת קובץ גדול</span>
    <span class="n">editing_large_file</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;editing_large_file&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">editing_large_file</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="n">editing_large_file</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">]</span>
            <span class="n">file_data</span> <span class="o">=</span> <span class="n">editing_large_file</span><span class="p">[</span><span class="s1">&#39;file_data&#39;</span><span class="p">]</span>
            
            <span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">detect_language_from_filename</span>
            <span class="n">language</span> <span class="o">=</span> <span class="n">detect_language_from_filename</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
            
            <span class="c1"># יצירת קובץ גדול חדש עם התוכן המעודכן</span>
            <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">LargeFile</span>
            <span class="n">updated_file</span> <span class="o">=</span> <span class="n">LargeFile</span><span class="p">(</span>
                <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
                <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span>
                <span class="n">content</span><span class="o">=</span><span class="n">new_code</span><span class="p">,</span>
                <span class="n">programming_language</span><span class="o">=</span><span class="n">language</span><span class="p">,</span>
                <span class="n">file_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">new_code</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)),</span>
                <span class="n">lines_count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">new_code</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
            <span class="p">)</span>
            
            <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>
            <span class="n">success</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">save_large_file</span><span class="p">(</span><span class="n">updated_file</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">get_language_emoji</span>
                <span class="n">emoji</span> <span class="o">=</span> <span class="n">get_language_emoji</span><span class="p">(</span><span class="n">language</span><span class="p">)</span>
                
                <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📚 חזרה לקבצים גדולים&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;show_large_files&quot;</span><span class="p">)]]</span>
                <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
                
                <span class="n">lines_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_code</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;✅ **הקובץ הגדול עודכן בהצלחה!**</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;📄 **קובץ:** `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">`</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">emoji</span><span class="si">}</span><span class="s2"> **שפה:** </span><span class="si">{</span><span class="n">language</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;💾 **גודל חדש:** </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">new_code</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> תווים</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;📏 **שורות:** </span><span class="si">{</span><span class="n">lines_count</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span><span class="p">,</span>
                    <span class="n">parse_mode</span><span class="o">=</span><span class="s1">&#39;Markdown&#39;</span>
                <span class="p">)</span>
                
                <span class="c1"># ניקוי נתוני העריכה</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;editing_large_file&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;❌ שגיאה בעדכון הקובץ הגדול&quot;</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error updating large file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;❌ שגיאה בעדכון הקובץ&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
    
    <span class="c1"># המשך הטיפול הרגיל בקבצים רגילים</span>
    <span class="n">file_data</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;editing_file_data&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">file_data</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;❌ שגיאה בנתוני הקובץ&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        <span class="c1"># תמיכה במקרים ישירים ומקרי cache</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;editing_file_name&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">)</span>
        <span class="n">editing_file_index</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;editing_file_index&#39;</span><span class="p">)</span>
        <span class="n">files_cache</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;files_cache&#39;</span><span class="p">)</span>
        
        <span class="kn">from</span> <span class="nn">code_processor</span> <span class="kn">import</span> <span class="n">code_processor</span>
        
        <span class="c1"># אימות וסניטציה של הקוד הנכנס</span>
        <span class="n">is_valid</span><span class="p">,</span> <span class="n">cleaned_code</span><span class="p">,</span> <span class="n">error_message</span> <span class="o">=</span> <span class="n">code_processor</span><span class="o">.</span><span class="n">validate_code_input</span><span class="p">(</span><span class="n">new_code</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;❌ שגיאה בקלט הקוד:</span><span class="se">\n</span><span class="si">{</span><span class="n">error_message</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;💡 אנא וודא שהקוד תקין ונסה שוב.&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">ReplyKeyboardMarkup</span><span class="p">(</span><span class="n">MAIN_KEYBOARD</span><span class="p">,</span> <span class="n">resize_keyboard</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">EDIT_CODE</span>  <span class="c1"># חזרה למצב עריכה</span>
        
        <span class="c1"># זיהוי שפה עם הקוד המנוקה</span>
        <span class="n">detected_language</span> <span class="o">=</span> <span class="n">code_processor</span><span class="o">.</span><span class="n">detect_language</span><span class="p">(</span><span class="n">cleaned_code</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        
        <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>
        <span class="n">success</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">save_file</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">cleaned_code</span><span class="p">,</span> <span class="n">detected_language</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;👁️ הצג קוד מעודכן&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;view_direct_</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📚 היסטוריה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;versions_file_</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="p">],</span>
                <span class="p">[</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📥 הורד&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;download_direct_</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 לרשימה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;files&quot;</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="p">]</span>
            <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
            
            <span class="c1"># Get the new version number to display</span>
            <span class="n">last_version</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
            <span class="n">version_num</span> <span class="o">=</span> <span class="n">last_version</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">last_version</span> <span class="k">else</span> <span class="mi">1</span>
            
            <span class="c1"># רענון קאש של הקבצים אם קיים אינדקס רלוונטי</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">files_cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">editing_file_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">editing_file_index</span><span class="p">)</span> <span class="ow">in</span> <span class="n">files_cache</span><span class="p">:</span>
                    <span class="n">entry</span> <span class="o">=</span> <span class="n">files_cache</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">editing_file_index</span><span class="p">)]</span>
                    <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cleaned_code</span>
                    <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;programming_language&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">detected_language</span>
                    <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">version_num</span>
                    <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;updated_at&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to refresh files_cache after edit: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;✅ *הקובץ עודכן בהצלחה!*</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;📄 **קובץ:** `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">`</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;🧠 **שפה:** </span><span class="si">{</span><span class="n">detected_language</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;📝 **גרסה:** </span><span class="si">{</span><span class="n">version_num</span><span class="si">}</span><span class="s2"> (עודכן מהגרסה הקודמת)</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;💾 **הקובץ הקיים עודכן עם השינויים החדשים!**&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="s1">&#39;Markdown&#39;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;❌ שגיאה בעדכון הקוד&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">ReplyKeyboardMarkup</span><span class="p">(</span><span class="n">MAIN_KEYBOARD</span><span class="p">,</span> <span class="n">resize_keyboard</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="p">)</span>
    
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># לוגים מפורטים לאיתור בעיות</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error updating code: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User ID: </span><span class="si">{</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Original code length: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">new_code</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">new_code</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="mi">0</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File name: </span><span class="si">{</span><span class="n">file_name</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="s1">&#39;file_name&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nb">locals</span><span class="p">()</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;Unknown&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># רישום בלוגר הייעודי לקוד</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">code_processor</span> <span class="kn">import</span> <span class="n">code_processor</span>
            <span class="n">code_processor</span><span class="o">.</span><span class="n">code_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;שגיאה בעדכון קוד עבור משתמש </span><span class="si">{</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        
        <span class="c1"># הודעת שגיאה מפורטת למשתמש</span>
        <span class="n">error_details</span> <span class="o">=</span> <span class="s2">&quot;פרטי השגיאה לא זמינים&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;validation&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">error_details</span> <span class="o">=</span> <span class="s2">&quot;שגיאה באימות הקוד&quot;</span>
        <span class="k">elif</span> <span class="s2">&quot;database&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">error_details</span> <span class="o">=</span> <span class="s2">&quot;שגיאה בשמירת הקוד במסד הנתונים&quot;</span>
        <span class="k">elif</span> <span class="s2">&quot;language&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">error_details</span> <span class="o">=</span> <span class="s2">&quot;שגיאה בזיהוי שפת התכנות&quot;</span>
        
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;❌ שגיאה בעדכון הקוד</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;📝 **פרטים:** </span><span class="si">{</span><span class="n">error_details</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;🔄 אנא נסה שוב או פנה לתמיכה</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;🏠 חזרה לתפריט הראשי&quot;</span><span class="p">,</span>
            <span class="n">reply_markup</span><span class="o">=</span><span class="n">ReplyKeyboardMarkup</span><span class="p">(</span><span class="n">MAIN_KEYBOARD</span><span class="p">,</span> <span class="n">resize_keyboard</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">parse_mode</span><span class="o">=</span><span class="s1">&#39;Markdown&#39;</span>
        <span class="p">)</span>
    
    <span class="c1"># נקה את מצב העריכה אך שמור קאש של קבצים אם קיים</span>
    <span class="n">preserved_cache</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;files_cache&#39;</span><span class="p">)</span>
    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">preserved_cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;files_cache&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">preserved_cache</span>
    <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span></div>


<div class="viewcode-block" id="handle_edit_name">
<a class="viewcode-back" href="../api/conversation_handlers.html#conversation_handlers.handle_edit_name">[תיעוד]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">handle_edit_name</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;התחלת עריכת שם קובץ&quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">file_index</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">files_cache</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;files_cache&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">file_data</span> <span class="o">=</span> <span class="n">files_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">file_index</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_data</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ שגיאה בזיהוי הקובץ&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
        
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;editing_file_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_index</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;editing_file_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_data</span>
        
        <span class="n">current_name</span> <span class="o">=</span> <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span> <span class="s1">&#39;קובץ&#39;</span><span class="p">)</span>
        
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;📝 *עריכת שם קובץ*</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;📄 **שם נוכחי:** `</span><span class="si">{</span><span class="n">current_name</span><span class="si">}</span><span class="s2">`</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;✏️ שלח שם חדש לקובץ:&quot;</span><span class="p">,</span>
            <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">([[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזרה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;file_</span><span class="si">{</span><span class="n">file_index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)]]),</span>
            <span class="n">parse_mode</span><span class="o">=</span><span class="s1">&#39;Markdown&#39;</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">EDIT_NAME</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in handle_edit_name: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ שגיאה בהתחלת עריכת שם&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span></div>


<div class="viewcode-block" id="handle_edit_note">
<a class="viewcode-back" href="../api/conversation_handlers.html#conversation_handlers.handle_edit_note">[תיעוד]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">handle_edit_note</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;התחלת עריכת הערה (description) מתצוגת רשימה עם אינדקס&quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">file_index</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">files_cache</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;files_cache&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">file_data</span> <span class="o">=</span> <span class="n">files_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">file_index</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_data</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ שגיאה בזיהוי הקובץ&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span> <span class="s1">&#39;קובץ&#39;</span><span class="p">)</span>
        <span class="n">current_note</span> <span class="o">=</span> <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;—&#39;</span>
        <span class="c1"># הגדר דגל כדי ש-receive_new_code יעדכן הערה</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;editing_note_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_name</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">safe_current_note</span> <span class="o">=</span> <span class="n">TextUtils</span><span class="o">.</span><span class="n">escape_markdown</span><span class="p">(</span><span class="n">current_note</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">safe_current_note</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_note</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;`&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">`&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">*&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">_&#39;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;📝 *עריכת הערה לקובץ*</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;📄 **שם:** `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">`</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;🔎 **הערה נוכחית:** </span><span class="si">{</span><span class="n">safe_current_note</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;✏️ שלח/י הערה חדשה (או &#39;מחק&#39; כדי להסיר)&quot;</span><span class="p">,</span>
            <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">([[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזרה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;file_</span><span class="si">{</span><span class="n">file_index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)]]),</span>
            <span class="n">parse_mode</span><span class="o">=</span><span class="s1">&#39;Markdown&#39;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">EDIT_CODE</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in handle_edit_note: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ שגיאה בהתחלת עריכת הערה&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span></div>


<div class="viewcode-block" id="receive_new_name">
<a class="viewcode-back" href="../api/conversation_handlers.html#conversation_handlers.receive_new_name">[תיעוד]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">receive_new_name</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;קבלת השם החדש לקובץ&quot;&quot;&quot;</span>
    <span class="n">new_name</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">file_data</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;editing_file_data&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">file_data</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span><span class="s2">&quot;❌ שגיאה בנתוני הקובץ&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
    
    <span class="c1"># בדיקת תקינות שם</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^[\w\.\-\_]+\.[a-zA-Z0-9]+$&#39;</span><span class="p">,</span> <span class="n">new_name</span><span class="p">):</span>
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
            <span class="s2">&quot;🤔 השם נראה קצת מוזר...</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;💡 נסה שם כמו: `script.py` או `index.html`</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;✅ אותיות, מספרים, נקודות וקווים מותרים!&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">EDIT_NAME</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        <span class="c1"># תמיכה במקרים ישירים ומקרי cache</span>
        <span class="n">old_name</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;editing_file_name&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">)</span>
        
        <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>
        <span class="n">success</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">rename_file</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">old_name</span><span class="p">,</span> <span class="n">new_name</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;👁️ הצג קוד&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;view_direct_</span><span class="si">{</span><span class="n">new_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📚 היסטוריה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;versions_file_</span><span class="si">{</span><span class="n">new_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="p">],</span>
                <span class="p">[</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📥 הורד&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;download_direct_</span><span class="si">{</span><span class="n">new_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 לרשימה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;files&quot;</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="p">]</span>
            <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
            
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;✅ *שם הקובץ שונה בהצלחה!*</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;📄 **שם ישן:** `</span><span class="si">{</span><span class="n">old_name</span><span class="si">}</span><span class="s2">`</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;📄 **שם חדש:** `</span><span class="si">{</span><span class="n">new_name</span><span class="si">}</span><span class="s2">`</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;🎉 **הכל מעודכן במערכת!**&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="s1">&#39;Markdown&#39;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;❌ שגיאה בשינוי השם&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">ReplyKeyboardMarkup</span><span class="p">(</span><span class="n">MAIN_KEYBOARD</span><span class="p">,</span> <span class="n">resize_keyboard</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="p">)</span>
    
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error renaming file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
            <span class="s2">&quot;❌ שגיאה בשינוי השם&quot;</span><span class="p">,</span>
            <span class="n">reply_markup</span><span class="o">=</span><span class="n">ReplyKeyboardMarkup</span><span class="p">(</span><span class="n">MAIN_KEYBOARD</span><span class="p">,</span> <span class="n">resize_keyboard</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>
    
    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span></div>


<div class="viewcode-block" id="handle_versions_history">
<a class="viewcode-back" href="../api/conversation_handlers.html#conversation_handlers.handle_versions_history">[תיעוד]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">handle_versions_history</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;הצגת היסטוריית גרסאות&quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span>
        <span class="n">file_index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">files_cache</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;files_cache&#39;</span><span class="p">,</span> <span class="p">{})</span>
        
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;versions_file_&quot;</span><span class="p">):</span>
            <span class="c1"># מצב של שם קובץ ישיר</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;versions_file_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># מצב של אינדקס מרשימת הקבצים</span>
            <span class="n">file_index</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">file_data</span> <span class="o">=</span> <span class="n">files_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">file_index</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">file_data</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ שגיאה בזיהוי הקובץ&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
            
            <span class="n">file_name</span> <span class="o">=</span> <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">)</span>
        
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>
        <span class="n">versions</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_all_versions</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">versions</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;📚 אין היסטוריית גרסאות לקובץ זה&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
        
        <span class="c1"># הנח שהרשימה ממוינת כך שהגרסה העדכנית ראשונה</span>
        <span class="n">latest_version_num</span> <span class="o">=</span> <span class="n">versions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">versions</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">versions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        
        <span class="n">history_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;📚 *היסטוריית גרסאות - </span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">*</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        
        <span class="n">keyboard</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">version</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">versions</span><span class="p">[:</span><span class="mi">5</span><span class="p">]):</span>  <span class="c1"># מציג עד 5 גרסאות</span>
            <span class="n">created_at</span> <span class="o">=</span> <span class="n">version</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;created_at&#39;</span><span class="p">,</span> <span class="s1">&#39;לא ידוע&#39;</span><span class="p">)</span>
            <span class="n">version_num</span> <span class="o">=</span> <span class="n">version</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">code_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">version</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
            
            <span class="n">history_text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;🔹 **גרסה </span><span class="si">{</span><span class="n">version_num</span><span class="si">}</span><span class="s2">**</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">history_text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   📅 </span><span class="si">{</span><span class="n">created_at</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">history_text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   📏 </span><span class="si">{</span><span class="n">code_length</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> תווים</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            
            <span class="c1"># כפתורים לפעולות על כל גרסה</span>
            <span class="k">if</span> <span class="n">latest_version_num</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">version_num</span> <span class="o">==</span> <span class="n">latest_version_num</span><span class="p">:</span>
                <span class="c1"># אל תציג כפתור שחזור עבור הגרסה הנוכחית</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;👁 הצג גרסה </span><span class="si">{</span><span class="n">version_num</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;view_version_</span><span class="si">{</span><span class="n">version_num</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;👁 הצג גרסה </span><span class="si">{</span><span class="n">version_num</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;view_version_</span><span class="si">{</span><span class="n">version_num</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">),</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;↩️ שחזר לגרסה </span><span class="si">{</span><span class="n">version_num</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;revert_version_</span><span class="si">{</span><span class="n">version_num</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="p">])</span>
        
        <span class="c1"># כפתור חזרה מתאים לפי מקור הקריאה</span>
        <span class="k">if</span> <span class="n">file_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזרה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;file_</span><span class="si">{</span><span class="n">file_index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזרה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;view_direct_</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
        
        <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
        
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
            <span class="n">history_text</span><span class="p">,</span>
            <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span><span class="p">,</span>
            <span class="n">parse_mode</span><span class="o">=</span><span class="s1">&#39;Markdown&#39;</span>
        <span class="p">)</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in handle_versions_history: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ שגיאה בהצגת היסטוריה&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span></div>


<div class="viewcode-block" id="handle_download_file">
<a class="viewcode-back" href="../api/conversation_handlers.html#conversation_handlers.handle_download_file">[תיעוד]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">handle_download_file</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;הורדת קובץ&quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span>
        <span class="n">files_cache</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;files_cache&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">file_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">code</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;dl_&#39;</span><span class="p">):</span>
            <span class="c1"># מצב אינדקס</span>
            <span class="n">file_index</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">file_data</span> <span class="o">=</span> <span class="n">files_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">file_index</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">file_data</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ שגיאה בזיהוי הקובץ&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
            
            <span class="n">file_name</span> <span class="o">=</span> <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span> <span class="s1">&#39;file.txt&#39;</span><span class="p">)</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;download_direct_&#39;</span><span class="p">):</span>
            <span class="c1"># מצב שם ישיר</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;download_direct_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
            <span class="n">latest</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">latest</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ לא נמצאה גרסה אחרונה לקובץ&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">latest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ בקשת הורדה לא חוקית&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
        
        <span class="c1"># יצירת קובץ להורדה</span>
        <span class="n">file_bytes</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
        <span class="n">file_bytes</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
        <span class="n">file_bytes</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_document</span><span class="p">(</span>
            <span class="n">document</span><span class="o">=</span><span class="n">file_bytes</span><span class="p">,</span>
            <span class="n">filename</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span>
            <span class="n">caption</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;📥 *הורדת קובץ*</span><span class="se">\n\n</span><span class="s2">📄 **שם:** `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">`</span><span class="se">\n</span><span class="s2">📏 **גודל:** </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> תווים&quot;</span>
        <span class="p">)</span>
        
        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;dl_&#39;</span><span class="p">):</span>
            <span class="n">file_index</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזרה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;file_</span><span class="si">{</span><span class="n">file_index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזרה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;view_direct_</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
        <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
        
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;✅ *הקובץ הורד בהצלחה!*</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;📄 **שם:** `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">`&quot;</span><span class="p">,</span>
            <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span><span class="p">,</span>
            <span class="n">parse_mode</span><span class="o">=</span><span class="s1">&#39;Markdown&#39;</span>
        <span class="p">)</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in handle_download_file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ שגיאה בהורדת הקובץ&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span></div>


<div class="viewcode-block" id="handle_delete_confirmation">
<a class="viewcode-back" href="../api/conversation_handlers.html#conversation_handlers.handle_delete_confirmation">[תיעוד]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">handle_delete_confirmation</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;אישור מחיקת קובץ&quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">file_index</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">files_cache</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;files_cache&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">file_data</span> <span class="o">=</span> <span class="n">files_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">file_index</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_data</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ שגיאה בזיהוי הקובץ&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
        
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span> <span class="s1">&#39;קובץ&#39;</span><span class="p">)</span>
        
        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;✅ כן, העבר לסל&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;confirm_del_</span><span class="si">{</span><span class="n">file_index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;❌ לא, בטל&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;file_</span><span class="si">{</span><span class="n">file_index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">]</span>
        <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_ttl_raw</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;RECYCLE_TTL_DAYS&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
            <span class="n">_ttl_days</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">_ttl_raw</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">_ttl_days</span> <span class="o">=</span> <span class="mi">7</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;⚠️ *אישור העברה לסל*</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;📄 **קובץ:** `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">`</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;🗑️ הקובץ יועבר לסל המיחזור. ניתן לשחזר עד </span><span class="si">{</span><span class="n">_ttl_days</span><span class="si">}</span><span class="s2"> ימים לפני מחיקה אוטומטית.&quot;</span><span class="p">,</span>
            <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span><span class="p">,</span>
            <span class="n">parse_mode</span><span class="o">=</span><span class="s1">&#39;Markdown&#39;</span>
        <span class="p">)</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in handle_delete_confirmation: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ שגיאה באישור מחיקה&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span></div>


<div class="viewcode-block" id="handle_delete_file">
<a class="viewcode-back" href="../api/conversation_handlers.html#conversation_handlers.handle_delete_file">[תיעוד]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">handle_delete_file</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;מחיקת קובץ סופית&quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">file_index</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">files_cache</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;files_cache&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">file_data</span> <span class="o">=</span> <span class="n">files_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">file_index</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_data</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ שגיאה בזיהוי הקובץ&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
        
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">)</span>
        
        <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>
        <span class="n">success</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">delete_file</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 לרשימת קבצים&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;files&quot;</span><span class="p">)]</span>
            <span class="p">]</span>
            <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_ttl_raw</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;RECYCLE_TTL_DAYS&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
                <span class="n">_ttl_days</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">_ttl_raw</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">_ttl_days</span> <span class="o">=</span> <span class="mi">7</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;✅ *הקובץ הועבר לסל המיחזור!*</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;📄 **קובץ:** `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">`</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;♻️ ניתן לשחזר מסל המיחזור עד </span><span class="si">{</span><span class="n">_ttl_days</span><span class="si">}</span><span class="s2"> ימים.&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="s1">&#39;Markdown&#39;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;❌ שגיאה במחיקת הקובץ `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">`&quot;</span>
            <span class="p">)</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in handle_delete_file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ שגיאה במחיקת הקובץ&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span></div>


<div class="viewcode-block" id="handle_file_info">
<a class="viewcode-back" href="../api/conversation_handlers.html#conversation_handlers.handle_file_info">[תיעוד]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">handle_file_info</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;הצגת מידע מפורט על קובץ&quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">file_index</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">files_cache</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;files_cache&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">file_data</span> <span class="o">=</span> <span class="n">files_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">file_index</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_data</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ שגיאה בזיהוי הקובץ&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
        
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span> <span class="s1">&#39;קובץ&#39;</span><span class="p">)</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">language</span> <span class="o">=</span> <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;programming_language&#39;</span><span class="p">,</span> <span class="s1">&#39;לא ידועה&#39;</span><span class="p">)</span>
        <span class="n">created_at</span> <span class="o">=</span> <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;created_at&#39;</span><span class="p">,</span> <span class="s1">&#39;לא ידוע&#39;</span><span class="p">)</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># חישוב סטטיסטיקות</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
        <span class="n">chars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="n">words</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
        
        <span class="n">info_text</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;📊 *מידע מפורט על הקובץ*</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;📄 **שם:** `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">`</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;🧠 **שפת תכנות:** </span><span class="si">{</span><span class="n">language</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;📅 **נוצר:** </span><span class="si">{</span><span class="n">created_at</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;🔢 **גרסה:** </span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;📊 **סטטיסטיקות:**</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;• 📏 שורות: </span><span class="si">{</span><span class="n">lines</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;• 🔤 תווים: </span><span class="si">{</span><span class="n">chars</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;• 📝 מילים: </span><span class="si">{</span><span class="n">words</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        
        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזרה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;file_</span><span class="si">{</span><span class="n">file_index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)]</span>
        <span class="p">]</span>
        <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
        
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
            <span class="n">info_text</span><span class="p">,</span>
            <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span><span class="p">,</span>
            <span class="n">parse_mode</span><span class="o">=</span><span class="s1">&#39;Markdown&#39;</span>
        <span class="p">)</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in handle_file_info: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ שגיאה בהצגת מידע&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span></div>


    

    

    

    

<div class="viewcode-block" id="handle_callback_query">
<a class="viewcode-back" href="../api/conversation_handlers.html#conversation_handlers.handle_callback_query">[תיעוד]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">handle_callback_query</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;מרכז בקרה מתקדם לכל הכפתורים&quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
    <span class="c1"># ה-guard הגלובלי מטופל ב-main.py; אין צורך בבקרת busy כאן</span>

    <span class="c1"># מנגנון מונע-כפל ברמת update אחד: אותו callback יכול להיתפס גם ע&quot;י ה-ConversationHandler</span>
    <span class="c1"># וגם ע&quot;י ה-catch-all הגלובלי (בקבוצה מאוחרת). כדי למנוע שליחה כפולה של הודעות,</span>
    <span class="c1"># נסמן את מזהה ה-update כטופל כבר, ונצא מיד אם הוא נתקל שוב.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">uid</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="s1">&#39;update_id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># החל מנגנון הכפילות רק כאשר יש update_id תקין (לא None)</span>
        <span class="k">if</span> <span class="n">uid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">last_handled_uid</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_last_callback_update_id&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">last_handled_uid</span> <span class="o">==</span> <span class="n">uid</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;_last_callback_update_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">uid</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="c1"># לא לחסום את הזרימה במקרה של חוסר מפתח/טסטים</span>
        <span class="k">pass</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span>
        
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;file_&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;files&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">handle_file_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;view_&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;view_direct_&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">handle_view_direct_file</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;view_version_&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">handle_view_version</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">handle_view_file</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;edit_code_&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;edit_code_direct_&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">handle_edit_code_direct</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">handle_edit_code</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;edit_name_&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;edit_name_direct_&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">handle_edit_name_direct</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">handle_edit_name</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;edit_note_&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;edit_note_direct_&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">handle_edit_note_direct</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">handle_edit_note</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;revert_version_&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">handle_revert_version</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;versions_&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">handle_versions_history</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;dl_&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;download_&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">handle_download_file</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;fv_more:&quot;</span><span class="p">):</span>
            <span class="c1"># טעינת עוד טקסט לתצוגת קוד (lazy-load) — תומך גם ב-index וגם ב-direct</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
            <span class="c1"># פורמטים נתמכים: fv_more:idx:{index}:{offset} | fv_more:direct:{file_name}:{offset}</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">chunk_offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">chunk_offset</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">max_length</span> <span class="o">=</span> <span class="mi">3500</span>
            <span class="n">header_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">code_to_show</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">language</span> <span class="o">=</span> <span class="s2">&quot;text&quot;</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot;קובץ&quot;</span>
            <span class="n">reply_markup</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;idx&quot;</span><span class="p">:</span>
                <span class="n">file_index</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">files_cache</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;files_cache&#39;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">file_data</span> <span class="o">=</span> <span class="n">files_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">file_index</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
                <span class="n">code</span> <span class="o">=</span> <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span> <span class="s1">&#39;קובץ&#39;</span><span class="p">)</span>
                <span class="n">language</span> <span class="o">=</span> <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;programming_language&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">)</span>
                <span class="c1"># חישוב קטע הבא</span>
                <span class="n">next_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">),</span> <span class="n">chunk_offset</span> <span class="o">+</span> <span class="n">max_length</span><span class="p">)</span>
                <span class="c1"># הגבלת אורך הודעה ל-4096 תווים כולל כותרת ותגיות HTML בסיסיות</span>
                <span class="n">header_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📄 &lt;b&gt;</span><span class="si">{</span><span class="n">html_escape</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/b&gt; (</span><span class="si">{</span><span class="n">html_escape</span><span class="p">(</span><span class="n">language</span><span class="p">)</span><span class="si">}</span><span class="s2">)</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">tags_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="s2">&quot;&lt;pre&gt;&lt;code&gt;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="s2">&quot;&lt;/code&gt;&lt;/pre&gt;&quot;</span><span class="p">)</span>
                <span class="n">safe_code_limit</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">4096</span> <span class="o">-</span> <span class="n">header_len</span> <span class="o">-</span> <span class="n">tags_len</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">next_end</span> <span class="o">&lt;=</span> <span class="n">safe_code_limit</span><span class="p">:</span>
                    <span class="n">code_to_show</span> <span class="o">=</span> <span class="n">code</span><span class="p">[:</span><span class="n">next_end</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># הצג חלון הזזה שמסתיים ב-next_end, עם קידומת אליפסיס</span>
                    <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;…</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="n">available</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">safe_code_limit</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">))</span>
                    <span class="n">start_index</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">next_end</span> <span class="o">-</span> <span class="n">available</span><span class="p">)</span>
                    <span class="n">code_to_show</span> <span class="o">=</span> <span class="p">(</span><span class="n">prefix</span> <span class="k">if</span> <span class="n">start_index</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">code</span><span class="p">[</span><span class="n">start_index</span><span class="p">:</span><span class="n">next_end</span><span class="p">]</span>
                <span class="c1"># בניית מקלדת עם כפתור &quot;הצג עוד&quot; הבא אם יש</span>
                <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1"># שחזור כפתורי פעולה עיקריים</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;✏️ ערוך קוד&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;edit_code_</span><span class="si">{</span><span class="n">file_index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📝 ערוך שם&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;edit_name_</span><span class="si">{</span><span class="n">file_index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📝 ערוך הערה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;edit_note_</span><span class="si">{</span><span class="n">file_index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📚 היסטוריה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;versions_</span><span class="si">{</span><span class="n">file_index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📥 הורד&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;dl_</span><span class="si">{</span><span class="n">file_index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔄 שכפול&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;clone_</span><span class="si">{</span><span class="n">file_index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
                <span class="n">last_page</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;files_last_page&#39;</span><span class="p">)</span>
                <span class="n">origin</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;files_origin&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="n">origin</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;by_repo&#39;</span> <span class="ow">and</span> <span class="n">origin</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tag&#39;</span><span class="p">):</span>
                    <span class="n">back_cb</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;by_repo:</span><span class="si">{</span><span class="n">origin</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tag&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">elif</span> <span class="n">origin</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;regular&#39;</span><span class="p">:</span>
                    <span class="n">back_cb</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;files_page_</span><span class="si">{</span><span class="n">last_page</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">last_page</span> <span class="k">else</span> <span class="s2">&quot;show_regular_files&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">back_cb</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;files_page_</span><span class="si">{</span><span class="n">last_page</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">last_page</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;file_</span><span class="si">{</span><span class="n">file_index</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">next_end</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
                    <span class="n">next_chunk</span> <span class="o">=</span> <span class="n">code</span><span class="p">[</span><span class="n">next_end</span><span class="p">:</span><span class="n">next_end</span> <span class="o">+</span> <span class="n">max_length</span><span class="p">]</span>
                    <span class="n">next_lines</span> <span class="o">=</span> <span class="n">next_chunk</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">next_chunk</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">keyboard</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;הצג עוד </span><span class="si">{</span><span class="n">next_lines</span><span class="si">}</span><span class="s2"> שורות ⤵️&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;fv_more:idx:</span><span class="si">{</span><span class="n">file_index</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">next_end</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
                <span class="k">if</span> <span class="n">next_end</span> <span class="o">&gt;</span> <span class="n">max_length</span><span class="p">:</span>
                    <span class="n">prev_chunk</span> <span class="o">=</span> <span class="n">code</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">max_length</span><span class="p">,</span> <span class="n">next_end</span> <span class="o">-</span> <span class="n">max_length</span><span class="p">):</span><span class="n">next_end</span><span class="p">]</span>
                    <span class="n">prev_lines</span> <span class="o">=</span> <span class="n">prev_chunk</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">prev_chunk</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">keyboard</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;הצג פחות </span><span class="si">{</span><span class="n">prev_lines</span><span class="si">}</span><span class="s2"> שורות ⤴️&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;fv_less:idx:</span><span class="si">{</span><span class="n">file_index</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">next_end</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזרה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="n">back_cb</span><span class="p">)])</span>
                <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;direct&quot;</span><span class="p">:</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
                <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>
                <span class="n">doc</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
                <span class="n">is_large_file</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">doc</span><span class="p">:</span>
                    <span class="c1"># נסה large_file</span>
                    <span class="n">doc</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_large_file</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
                    <span class="n">is_large_file</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
                    <span class="n">code</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">code</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">language</span> <span class="o">=</span> <span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;programming_language&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;text&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;text&#39;</span>
                <span class="n">next_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">),</span> <span class="n">chunk_offset</span> <span class="o">+</span> <span class="n">max_length</span><span class="p">)</span>
                <span class="c1"># הגבלת אורך הודעה ל-4096 תווים כולל כותרת ותגיות HTML</span>
                <span class="n">header_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📄 &lt;b&gt;</span><span class="si">{</span><span class="n">html_escape</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/b&gt; (</span><span class="si">{</span><span class="n">html_escape</span><span class="p">(</span><span class="n">language</span><span class="p">)</span><span class="si">}</span><span class="s2">)</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">tags_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="s2">&quot;&lt;pre&gt;&lt;code&gt;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="s2">&quot;&lt;/code&gt;&lt;/pre&gt;&quot;</span><span class="p">)</span>
                <span class="n">safe_code_limit</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">4096</span> <span class="o">-</span> <span class="n">header_len</span> <span class="o">-</span> <span class="n">tags_len</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">next_end</span> <span class="o">&lt;=</span> <span class="n">safe_code_limit</span><span class="p">:</span>
                    <span class="n">code_to_show</span> <span class="o">=</span> <span class="n">code</span><span class="p">[:</span><span class="n">next_end</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;…</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="n">available</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">safe_code_limit</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">))</span>
                    <span class="n">start_index</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">next_end</span> <span class="o">-</span> <span class="n">available</span><span class="p">)</span>
                    <span class="n">code_to_show</span> <span class="o">=</span> <span class="p">(</span><span class="n">prefix</span> <span class="k">if</span> <span class="n">start_index</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">code</span><span class="p">[</span><span class="n">start_index</span><span class="p">:</span><span class="n">next_end</span><span class="p">]</span>
                <span class="c1"># כפתורים לתצוגה ישירה</span>
                <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;✏️ ערוך קוד&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;edit_code_direct_</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📝 ערוך שם&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;edit_name_direct_</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📝 ערוך הערה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;edit_note_direct_</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📚 היסטוריה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;versions_file_</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📥 הורד&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;download_direct_</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔄 שכפול&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;clone_direct_</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">fid</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔗 שתף קוד&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;share_menu_id:</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">fid</span> <span class="k">else</span> <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔗 שתף קוד&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;share_menu_id:&quot;</span><span class="p">)])</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזרה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;back_after_view:</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
                <span class="k">if</span> <span class="n">next_end</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
                    <span class="n">next_chunk</span> <span class="o">=</span> <span class="n">code</span><span class="p">[</span><span class="n">next_end</span><span class="p">:</span><span class="n">next_end</span> <span class="o">+</span> <span class="n">max_length</span><span class="p">]</span>
                    <span class="n">next_lines</span> <span class="o">=</span> <span class="n">next_chunk</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">next_chunk</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">keyboard</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;הצג עוד </span><span class="si">{</span><span class="n">next_lines</span><span class="si">}</span><span class="s2"> שורות ⤵️&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;fv_more:direct:</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">next_end</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
                <span class="k">if</span> <span class="n">next_end</span> <span class="o">&gt;</span> <span class="n">max_length</span><span class="p">:</span>
                    <span class="n">prev_chunk</span> <span class="o">=</span> <span class="n">code</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">max_length</span><span class="p">,</span> <span class="n">next_end</span> <span class="o">-</span> <span class="n">max_length</span><span class="p">):</span><span class="n">next_end</span><span class="p">]</span>
                    <span class="n">prev_lines</span> <span class="o">=</span> <span class="n">prev_chunk</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">prev_chunk</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">keyboard</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;הצג פחות </span><span class="si">{</span><span class="n">prev_lines</span><span class="si">}</span><span class="s2"> שורות ⤴️&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;fv_less:direct:</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">next_end</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
                <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
            <span class="c1"># רינדור מחדש עם קטע ארוך יותר — HTML אחיד, ואינדיקציה לקובץ גדול במצב direct</span>
            <span class="n">note</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">large_note_html</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;idx&#39;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">note</span> <span class="o">=</span> <span class="p">(</span><span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">note</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">note</span> <span class="o">=</span> <span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">note</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;is_large_file&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="ow">and</span> <span class="n">is_large_file</span><span class="p">:</span>
                        <span class="n">large_note_html</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&lt;i&gt;זה קובץ גדול&lt;/i&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="n">note_line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">📝 הערה: </span><span class="si">{</span><span class="n">html_escape</span><span class="p">(</span><span class="n">note</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">note</span> <span class="k">else</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">safe_code_html</span> <span class="o">=</span> <span class="n">html_escape</span><span class="p">(</span><span class="n">code_to_show</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;📄 &lt;b&gt;</span><span class="si">{</span><span class="n">html_escape</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/b&gt; (</span><span class="si">{</span><span class="n">html_escape</span><span class="p">(</span><span class="n">language</span><span class="p">)</span><span class="si">}</span><span class="s2">)</span><span class="si">{</span><span class="n">note_line</span><span class="si">}{</span><span class="n">large_note_html</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                    <span class="sa">f</span><span class="s2">&quot;&lt;pre&gt;&lt;code&gt;</span><span class="si">{</span><span class="n">safe_code_html</span><span class="si">}</span><span class="s2">&lt;/code&gt;&lt;/pre&gt;&quot;</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span><span class="p">,</span>
                    <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">telegram</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="k">raise</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;fv_less:&quot;</span><span class="p">):</span>
            <span class="c1"># צמצום התצוגה לאחור — מציג פחות שורות</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">current_end</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">current_end</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">max_length</span> <span class="o">=</span> <span class="mi">3500</span>
            <span class="n">prev_end</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_length</span><span class="p">,</span> <span class="n">current_end</span> <span class="o">-</span> <span class="n">max_length</span><span class="p">)</span>
            <span class="n">code_to_show</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">language</span> <span class="o">=</span> <span class="s2">&quot;text&quot;</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot;קובץ&quot;</span>
            <span class="n">reply_markup</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;idx&quot;</span><span class="p">:</span>
                <span class="n">file_index</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">files_cache</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;files_cache&#39;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">file_data</span> <span class="o">=</span> <span class="n">files_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">file_index</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
                <span class="n">code</span> <span class="o">=</span> <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span> <span class="s1">&#39;קובץ&#39;</span><span class="p">)</span>
                <span class="n">language</span> <span class="o">=</span> <span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;programming_language&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">)</span>
                <span class="c1"># הגבלת אורך הודעה ל-4096 תווים כולל כותרת ותגיות HTML</span>
                <span class="n">header_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📄 &lt;b&gt;</span><span class="si">{</span><span class="n">html_escape</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/b&gt; (</span><span class="si">{</span><span class="n">html_escape</span><span class="p">(</span><span class="n">language</span><span class="p">)</span><span class="si">}</span><span class="s2">)</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">tags_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="s2">&quot;&lt;pre&gt;&lt;code&gt;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="s2">&quot;&lt;/code&gt;&lt;/pre&gt;&quot;</span><span class="p">)</span>
                <span class="n">safe_code_limit</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">4096</span> <span class="o">-</span> <span class="n">header_len</span> <span class="o">-</span> <span class="n">tags_len</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">prev_end</span> <span class="o">&lt;=</span> <span class="n">safe_code_limit</span><span class="p">:</span>
                    <span class="n">code_to_show</span> <span class="o">=</span> <span class="n">code</span><span class="p">[:</span><span class="n">prev_end</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;…</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="n">available</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">safe_code_limit</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">))</span>
                    <span class="n">start_index</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">prev_end</span> <span class="o">-</span> <span class="n">available</span><span class="p">)</span>
                    <span class="n">code_to_show</span> <span class="o">=</span> <span class="p">(</span><span class="n">prefix</span> <span class="k">if</span> <span class="n">start_index</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">code</span><span class="p">[</span><span class="n">start_index</span><span class="p">:</span><span class="n">prev_end</span><span class="p">]</span>
                <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;✏️ ערוך קוד&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;edit_code_</span><span class="si">{</span><span class="n">file_index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📝 ערוך שם&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;edit_name_</span><span class="si">{</span><span class="n">file_index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📝 ערוך הערה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;edit_note_</span><span class="si">{</span><span class="n">file_index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📚 היסטוריה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;versions_</span><span class="si">{</span><span class="n">file_index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📥 הורד&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;dl_</span><span class="si">{</span><span class="n">file_index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔄 שכפול&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;clone_</span><span class="si">{</span><span class="n">file_index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
                <span class="n">last_page</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;files_last_page&#39;</span><span class="p">)</span>
                <span class="n">origin</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;files_origin&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="n">origin</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;by_repo&#39;</span> <span class="ow">and</span> <span class="n">origin</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tag&#39;</span><span class="p">):</span>
                    <span class="n">back_cb</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;by_repo:</span><span class="si">{</span><span class="n">origin</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tag&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">elif</span> <span class="n">origin</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;regular&#39;</span><span class="p">:</span>
                    <span class="n">back_cb</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;files_page_</span><span class="si">{</span><span class="n">last_page</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">last_page</span> <span class="k">else</span> <span class="s2">&quot;show_regular_files&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">back_cb</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;files_page_</span><span class="si">{</span><span class="n">last_page</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">last_page</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;file_</span><span class="si">{</span><span class="n">file_index</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="c1"># כפתורי עוד/פחות בהתאם לשוליים</span>
                <span class="k">if</span> <span class="n">prev_end</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
                    <span class="n">next_chunk</span> <span class="o">=</span> <span class="n">code</span><span class="p">[</span><span class="n">prev_end</span><span class="p">:</span><span class="n">prev_end</span> <span class="o">+</span> <span class="n">max_length</span><span class="p">]</span>
                    <span class="n">next_lines</span> <span class="o">=</span> <span class="n">next_chunk</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">next_chunk</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">keyboard</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;הצג עוד </span><span class="si">{</span><span class="n">next_lines</span><span class="si">}</span><span class="s2"> שורות ⤵️&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;fv_more:idx:</span><span class="si">{</span><span class="n">file_index</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">prev_end</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
                <span class="k">if</span> <span class="n">prev_end</span> <span class="o">&gt;</span> <span class="n">max_length</span><span class="p">:</span>
                    <span class="n">prev_chunk2</span> <span class="o">=</span> <span class="n">code</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">max_length</span><span class="p">,</span> <span class="n">prev_end</span> <span class="o">-</span> <span class="n">max_length</span><span class="p">):</span><span class="n">prev_end</span><span class="p">]</span>
                    <span class="n">prev_lines2</span> <span class="o">=</span> <span class="n">prev_chunk2</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">prev_chunk2</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">keyboard</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;הצג פחות </span><span class="si">{</span><span class="n">prev_lines2</span><span class="si">}</span><span class="s2"> שורות ⤴️&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;fv_less:idx:</span><span class="si">{</span><span class="n">file_index</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">prev_end</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזרה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="n">back_cb</span><span class="p">)])</span>
                <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;direct&quot;</span><span class="p">:</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
                <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>
                <span class="n">doc</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
                <span class="n">is_large_file</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">doc</span><span class="p">:</span>
                    <span class="n">doc</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_large_file</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
                    <span class="n">is_large_file</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
                    <span class="n">code</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">code</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">language</span> <span class="o">=</span> <span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;programming_language&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;text&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;text&#39;</span>
                <span class="c1"># הגבלת אורך הודעה ל-4096 תווים כולל כותרת ותגיות HTML</span>
                <span class="n">header_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📄 &lt;b&gt;</span><span class="si">{</span><span class="n">html_escape</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/b&gt; (</span><span class="si">{</span><span class="n">html_escape</span><span class="p">(</span><span class="n">language</span><span class="p">)</span><span class="si">}</span><span class="s2">)</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">tags_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="s2">&quot;&lt;pre&gt;&lt;code&gt;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="s2">&quot;&lt;/code&gt;&lt;/pre&gt;&quot;</span><span class="p">)</span>
                <span class="n">safe_code_limit</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">4096</span> <span class="o">-</span> <span class="n">header_len</span> <span class="o">-</span> <span class="n">tags_len</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">prev_end</span> <span class="o">&lt;=</span> <span class="n">safe_code_limit</span><span class="p">:</span>
                    <span class="n">code_to_show</span> <span class="o">=</span> <span class="n">code</span><span class="p">[:</span><span class="n">prev_end</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;…</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="n">available</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">safe_code_limit</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">))</span>
                    <span class="n">start_index</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">prev_end</span> <span class="o">-</span> <span class="n">available</span><span class="p">)</span>
                    <span class="n">code_to_show</span> <span class="o">=</span> <span class="p">(</span><span class="n">prefix</span> <span class="k">if</span> <span class="n">start_index</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">code</span><span class="p">[</span><span class="n">start_index</span><span class="p">:</span><span class="n">prev_end</span><span class="p">]</span>
                <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;✏️ ערוך קוד&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;edit_code_direct_</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📝 ערוך שם&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;edit_name_direct_</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📝 ערוך הערה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;edit_note_direct_</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📚 היסטוריה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;versions_file_</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📥 הורד&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;download_direct_</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔄 שכפול&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;clone_direct_</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">fid</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔗 שתף קוד&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;share_menu_id:</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">fid</span> <span class="k">else</span> <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔗 שתף קוד&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;share_menu_id:&quot;</span><span class="p">)])</span>
                <span class="k">if</span> <span class="n">prev_end</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
                    <span class="n">next_chunk</span> <span class="o">=</span> <span class="n">code</span><span class="p">[</span><span class="n">prev_end</span><span class="p">:</span><span class="n">prev_end</span> <span class="o">+</span> <span class="n">max_length</span><span class="p">]</span>
                    <span class="n">next_lines</span> <span class="o">=</span> <span class="n">next_chunk</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">next_chunk</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">keyboard</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;הצג עוד </span><span class="si">{</span><span class="n">next_lines</span><span class="si">}</span><span class="s2"> שורות ⤵️&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;fv_more:direct:</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">prev_end</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
                <span class="k">if</span> <span class="n">prev_end</span> <span class="o">&gt;</span> <span class="n">max_length</span><span class="p">:</span>
                    <span class="n">prev_chunk2</span> <span class="o">=</span> <span class="n">code</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">max_length</span><span class="p">,</span> <span class="n">prev_end</span> <span class="o">-</span> <span class="n">max_length</span><span class="p">):</span><span class="n">prev_end</span><span class="p">]</span>
                    <span class="n">prev_lines2</span> <span class="o">=</span> <span class="n">prev_chunk2</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">prev_chunk2</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">keyboard</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;הצג פחות </span><span class="si">{</span><span class="n">prev_lines2</span><span class="si">}</span><span class="s2"> שורות ⤴️&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;fv_less:direct:</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">prev_end</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזרה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;back_after_view:</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
                <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
            <span class="c1"># רינדור מחדש עם קטע קצר יותר — HTML אחיד, ואינדיקציה לקובץ גדול במצב direct</span>
            <span class="n">note</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">large_note_html</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;idx&#39;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">note</span> <span class="o">=</span> <span class="p">(</span><span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">note</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">note</span> <span class="o">=</span> <span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">note</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;is_large_file&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="ow">and</span> <span class="n">is_large_file</span><span class="p">:</span>
                        <span class="n">large_note_html</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&lt;i&gt;זה קובץ גדול&lt;/i&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="n">note_line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">📝 הערה: </span><span class="si">{</span><span class="n">html_escape</span><span class="p">(</span><span class="n">note</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">note</span> <span class="k">else</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">safe_code_html</span> <span class="o">=</span> <span class="n">html_escape</span><span class="p">(</span><span class="n">code_to_show</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;📄 &lt;b&gt;</span><span class="si">{</span><span class="n">html_escape</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/b&gt; (</span><span class="si">{</span><span class="n">html_escape</span><span class="p">(</span><span class="n">language</span><span class="p">)</span><span class="si">}</span><span class="s2">)</span><span class="si">{</span><span class="n">note_line</span><span class="si">}{</span><span class="n">large_note_html</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                    <span class="sa">f</span><span class="s2">&quot;&lt;pre&gt;&lt;code&gt;</span><span class="si">{</span><span class="n">safe_code_html</span><span class="si">}</span><span class="s2">&lt;/code&gt;&lt;/pre&gt;&quot;</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span><span class="p">,</span>
                    <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">telegram</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="k">raise</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;clone_&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;clone_direct_&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">handle_clone_direct</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">handle_clone</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;back_after_view:&quot;</span><span class="p">):</span>
            <span class="c1"># חזרה למסך ההצלחה לאחר צפייה בקוד שנשמר זה עתה</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">saved</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;last_save_success&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="c1"># ננסה לעדכן מהמסד אם חסר</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">saved</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>
                    <span class="n">doc</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
                    <span class="n">saved</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;file_name&#39;</span><span class="p">:</span> <span class="n">file_name</span> <span class="ow">or</span> <span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">doc</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                        <span class="s1">&#39;language&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;programming_language&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">doc</span> <span class="k">else</span> <span class="s1">&#39;text&#39;</span><span class="p">),</span>
                        <span class="s1">&#39;note&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">doc</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                        <span class="s1">&#39;file_id&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">doc</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                    <span class="p">}</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">saved</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;file_name&#39;</span><span class="p">:</span> <span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;language&#39;</span><span class="p">:</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;note&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;file_id&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">}</span>
            <span class="c1"># בנה מקלדת כמו בהודעת ההצלחה לאחר שמירה</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">saved</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">file_name</span> <span class="ow">or</span> <span class="s1">&#39;file.txt&#39;</span>
            <span class="n">lang</span> <span class="o">=</span> <span class="n">saved</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;language&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;text&#39;</span>
            <span class="n">note</span> <span class="o">=</span> <span class="n">saved</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;note&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
            <span class="n">fid</span> <span class="o">=</span> <span class="n">saved</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_id&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
            <span class="n">note_btn_text</span> <span class="o">=</span> <span class="s2">&quot;📝 ערוך הערה&quot;</span> <span class="k">if</span> <span class="n">note</span> <span class="k">else</span> <span class="s2">&quot;📝 הוסף הערה&quot;</span>
            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;👁️ הצג קוד&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;view_direct_</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;✏️ ערוך&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;edit_code_direct_</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="p">],</span>
                <span class="p">[</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📝 שנה שם&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;edit_name_direct_</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">note_btn_text</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;edit_note_direct_</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="p">],</span>
                <span class="p">[</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📚 היסטוריה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;versions_file_</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📥 הורד&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;download_direct_</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="p">],</span>
                <span class="p">[</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🗑️ מחק&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;delete_direct_</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="p">],</span>
                <span class="p">[</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔗 שתף קוד&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;share_menu_id:</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">fid</span> <span class="k">else</span> <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔗 שתף קוד&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;share_menu_id:&quot;</span><span class="p">)</span>
                <span class="p">],</span>
                <span class="p">[</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 לרשימה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;files&quot;</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="p">]</span>
            <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
            <span class="n">note_display</span> <span class="o">=</span> <span class="n">note</span> <span class="k">if</span> <span class="n">note</span> <span class="k">else</span> <span class="s1">&#39;—&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;🎉 *קובץ נשמר בהצלחה!*</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;📄 **שם:** `</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">`</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;🧠 **שפה זוהתה:** </span><span class="si">{</span><span class="n">lang</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;📝 **הערה:** </span><span class="si">{</span><span class="n">note_display</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;🎮 בחר פעולה מהכפתורים החכמים:&quot;</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span><span class="p">,</span>
                    <span class="n">parse_mode</span><span class="o">=</span><span class="s1">&#39;Markdown&#39;</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;🎉 קובץ נשמר בהצלחה!&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;share_menu_id:&quot;</span><span class="p">):</span>
            <span class="c1"># תפריט שיתוף לפי ObjectId</span>
            <span class="n">fid</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🐙 GitHub Gist&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;share_gist_id:</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📋 Pastebin&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;share_pastebin_id:</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="p">],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;❌ ביטול&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;cancel_share&quot;</span><span class="p">)]</span>
            <span class="p">]</span>
            <span class="k">await</span> <span class="n">TelegramUtils</span><span class="o">.</span><span class="n">safe_edit_message_reply_markup</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;share_gist_id:&quot;</span><span class="p">):</span>
            <span class="n">fid</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">share_single_by_id</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">service</span><span class="o">=</span><span class="s2">&quot;gist&quot;</span><span class="p">,</span> <span class="n">file_id</span><span class="o">=</span><span class="n">fid</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;share_pastebin_id:&quot;</span><span class="p">):</span>
            <span class="n">fid</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">share_single_by_id</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">service</span><span class="o">=</span><span class="s2">&quot;pastebin&quot;</span><span class="p">,</span> <span class="n">file_id</span><span class="o">=</span><span class="n">fid</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;share_menu_idx:&quot;</span><span class="p">):</span>
            <span class="c1"># תפריט שתף לפי אינדקס קובץ מה-cache</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">files_cache</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;files_cache&#39;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">file_data</span> <span class="o">=</span> <span class="n">files_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">file_data</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;קובץ לא נמצא&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
            <span class="n">fid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">file_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fid</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;קובץ לא תקין&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
            <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🐙 GitHub Gist&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;share_gist_id:</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📋 Pastebin&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;share_pastebin_id:</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="p">],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;❌ ביטול&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;cancel_share&quot;</span><span class="p">)]</span>
            <span class="p">]</span>
            <span class="k">await</span> <span class="n">TelegramUtils</span><span class="o">.</span><span class="n">safe_edit_message_reply_markup</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;del_&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;delete_&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">handle_delete_confirmation</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;confirm_del_&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">handle_delete_file</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;info_&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">handle_file_info</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;files&quot;</span> <span class="ow">or</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;refresh_files&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">show_all_files_callback</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;recycle_bin&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">show_recycle_bin</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;recycle_page_&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">show_recycle_bin</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;recycle_restore:&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">recycle_restore</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;recycle_purge:&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">recycle_purge</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;by_repo_menu&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">show_by_repo_menu_callback</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;add_code_regular&quot;</span><span class="p">:</span>
            <span class="c1"># מעבר לזרימת &quot;קוד רגיל&quot; הקיימת - נשלח הודעה חדשה כמו start_save_flow</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>
            <span class="c1"># הסתרת תת-התפריט כדי למנוע בלבול</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;✨ מצב הוספת קוד רגיל&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">start_save_flow</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;add_code_long&quot;</span><span class="p">:</span>
            <span class="c1"># כניסה למצב איסוף קוד ארוך</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">start_long_collect</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;files_page_&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">show_regular_files_page_callback</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;rf_multi_start&quot;</span><span class="p">:</span>
            <span class="c1"># כניסה למצב מחיקה מרובה</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;rf_multi_delete&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;rf_selected_ids&#39;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">show_regular_files_page_callback</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;rf_multi_cancel&quot;</span><span class="p">:</span>
            <span class="c1"># יציאה ממצב מחיקה מרובה</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;rf_multi_delete&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;rf_selected_ids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">show_regular_files_page_callback</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;rf_toggle:&quot;</span><span class="p">):</span>
            <span class="c1"># פורמט: rf_toggle:&lt;page&gt;:&lt;file_id&gt;</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">page</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;files_last_page&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">1</span>
            <span class="n">file_id</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="n">selected</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rf_selected_ids&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="n">file_id</span> <span class="ow">in</span> <span class="n">selected</span><span class="p">:</span>
                <span class="n">selected</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file_id</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">file_id</span><span class="p">:</span>
                    <span class="n">selected</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">file_id</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;rf_selected_ids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">selected</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;rf_multi_delete&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;files_last_page&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">show_regular_files_page_callback</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;rf_delete_confirm&quot;</span><span class="p">:</span>
            <span class="c1"># הודעת אימות ראשונה למחיקה מרובה</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
            <span class="n">selected_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rf_selected_ids&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[])</span>
            <span class="n">count_sel</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_ids</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">count_sel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;לא נבחרו קבצים&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
            <span class="n">last_page</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;files_last_page&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">1</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_ttl_raw</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;RECYCLE_TTL_DAYS&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
                <span class="n">_ttl_days</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">_ttl_raw</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">_ttl_days</span> <span class="o">=</span> <span class="mi">7</span>
            <span class="n">warn</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;⚠️ עומד/ת להעביר &lt;b&gt;</span><span class="si">{</span><span class="n">count_sel</span><span class="si">}</span><span class="s2">&lt;/b&gt; קבצים לסל המיחזור.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;הקבצים יהיו ניתנים לשחזור עד </span><span class="si">{</span><span class="n">_ttl_days</span><span class="si">}</span><span class="s2"> ימים, ולאחר מכן יימחקו אוטומטית.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;אין שום פעולה מול GitHub, ולא נמחקים קבצי ZIP/גדולים.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;אם זה בטעות, חזור/י אחורה.&quot;</span>
            <span class="p">)</span>
            <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;✅ אני מאשר/ת&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;rf_delete_double_confirm&quot;</span><span class="p">)],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזרה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;files_page_</span><span class="si">{</span><span class="n">last_page</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)],</span>
            <span class="p">]</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">warn</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;rf_delete_double_confirm&quot;</span><span class="p">:</span>
            <span class="c1"># אישור שני</span>
            <span class="n">last_page</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;files_last_page&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">1</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_ttl_raw</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;RECYCLE_TTL_DAYS&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
                <span class="n">_ttl_days</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">_ttl_raw</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">_ttl_days</span> <span class="o">=</span> <span class="mi">7</span>
            <span class="n">text2</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;🧨 אישור סופי להעברה לסל</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;הקבצים יועברו לסל המיחזור ויישארו לשחזור עד </span><span class="si">{</span><span class="n">_ttl_days</span><span class="si">}</span><span class="s2"> ימים.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;אין שום פעולה מול GitHub, ולא נמחקים קבצי ZIP/גדולים.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🧨 כן, העבר לסל&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;rf_delete_do&quot;</span><span class="p">)],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 בטל&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;files_page_</span><span class="si">{</span><span class="n">last_page</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)],</span>
            <span class="p">]</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">text2</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;rf_delete_do&quot;</span><span class="p">:</span>
            <span class="c1"># מחיקה בפועל לפי מזהי קבצים</span>
            <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
            <span class="n">selected_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rf_selected_ids&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[])</span>
            <span class="n">deleted</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">fid</span> <span class="ow">in</span> <span class="n">selected_ids</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">delete_file_by_id</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">res</span><span class="p">:</span>
                        <span class="n">deleted</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="c1"># רענון רשימת הקבצים ושחזור מצב רגיל (דף עדכני) ישירות מה-DB</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">last_page</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;files_last_page&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">1</span>
                <span class="n">files</span><span class="p">,</span> <span class="n">total_files</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_regular_files_paginated</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="n">last_page</span><span class="p">,</span> <span class="n">per_page</span><span class="o">=</span><span class="n">FILES_PAGE_SIZE</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">files</span><span class="p">,</span> <span class="n">total_files</span> <span class="o">=</span> <span class="p">[],</span> <span class="mi">0</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;rf_selected_ids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;rf_multi_delete&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># עדכן עמוד אחרון בהתאם לסה&quot;כ אחרי מחיקה</span>
            <span class="n">total_pages</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_files</span> <span class="o">+</span> <span class="n">FILES_PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">FILES_PAGE_SIZE</span> <span class="k">if</span> <span class="n">total_files</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="n">last_page</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;files_last_page&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">last_page</span> <span class="o">&gt;</span> <span class="n">total_pages</span><span class="p">:</span>
                <span class="n">last_page</span> <span class="o">=</span> <span class="n">total_pages</span> <span class="ow">or</span> <span class="mi">1</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;files_last_page&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_page</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_ttl_raw</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;RECYCLE_TTL_DAYS&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
                <span class="n">_ttl_days</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">_ttl_raw</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">_ttl_days</span> <span class="o">=</span> <span class="mi">7</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;✅ הועברו לסל </span><span class="si">{</span><span class="n">deleted</span><span class="si">}</span><span class="s2"> קבצים.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;♻️ ניתן לשחזר מסל המיחזור עד </span><span class="si">{</span><span class="n">_ttl_days</span><span class="si">}</span><span class="s2"> ימים.&quot;</span>
            <span class="p">)</span>
            <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור לשאר הקבצים&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;files_page_</span><span class="si">{</span><span class="n">last_page</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🏠 תפריט ראשי&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;main&quot;</span><span class="p">)],</span>
            <span class="p">]</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
        <span class="k">elif</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;main&quot;</span> <span class="ow">or</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;main_menu&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;🏠 חוזר לבית החכם:&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;🎮 בחר פעולה מתקדמת:&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">ReplyKeyboardMarkup</span><span class="p">(</span><span class="n">MAIN_KEYBOARD</span><span class="p">,</span> <span class="n">resize_keyboard</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
        <span class="k">elif</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;cancel&quot;</span><span class="p">:</span>
            <span class="c1"># ביטול כללי דרך כפתור</span>
            <span class="c1"># ביטול טיימאאוט אם קיים</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">job</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;long_collect_job&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">job</span><span class="p">:</span>
                    <span class="n">job</span><span class="o">.</span><span class="n">schedule_removal</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;🚫 התהליך בוטל בהצלחה!&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;🎮 בחר פעולה מתקדמת:&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">ReplyKeyboardMarkup</span><span class="p">(</span><span class="n">MAIN_KEYBOARD</span><span class="p">,</span> <span class="n">resize_keyboard</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
        <span class="k">elif</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;zip_create_cancel&quot;</span><span class="p">:</span>
            <span class="c1"># ביטול מצב יצירת ZIP בלבד</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;upload_mode&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;zip_create_items&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;🚫 יצירת ה‑ZIP בוטלה.&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="s2">&quot;🎮 בחר פעולה מתקדמת:&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">ReplyKeyboardMarkup</span><span class="p">(</span><span class="n">MAIN_KEYBOARD</span><span class="p">,</span> <span class="n">resize_keyboard</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
        <span class="k">elif</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;zip_create_finish&quot;</span><span class="p">:</span>
            <span class="c1"># בניית ZIP מהקבצים שנאספו ושליחה למשתמש</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">items</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;zip_create_items&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">items</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;ℹ️ לא נאספו קבצים. שלח/י קבצים ואז נסה שוב.&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
                <span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span> <span class="k">as</span> <span class="n">_BytesIO</span>
                <span class="kn">import</span> <span class="nn">zipfile</span> <span class="k">as</span> <span class="nn">_zip</span>
                <span class="n">buf</span> <span class="o">=</span> <span class="n">_BytesIO</span><span class="p">()</span>
                <span class="k">with</span> <span class="n">_zip</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="n">_zip</span><span class="o">.</span><span class="n">ZIP_DEFLATED</span><span class="p">)</span> <span class="k">as</span> <span class="n">z</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                        <span class="c1"># it: {&quot;filename&quot;: str, &quot;bytes&quot;: bytes}</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">z</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;filename&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="n">it</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bytes&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                <span class="n">buf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">safe_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;my-files-</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">-%H%M%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.zip&quot;</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_document</span><span class="p">(</span><span class="n">document</span><span class="o">=</span><span class="n">buf</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">safe_name</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ נוצר ZIP עם </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span><span class="si">}</span><span class="s2"> קבצים ונשלח אליך.&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;zip_create_finish failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ שגיאה ביצירת ה‑ZIP: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;upload_mode&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;zip_create_items&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;replace_&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;rename_file&quot;</span> <span class="ow">or</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;cancel_save&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">handle_duplicate_callback</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        
        <span class="c1"># טיפול בקבצים גדולים</span>
        <span class="k">elif</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;show_regular_files&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">show_regular_files_callback</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;show_large_files&quot;</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">large_files_handler</span> <span class="kn">import</span> <span class="n">large_files_handler</span>
            <span class="k">await</span> <span class="n">large_files_handler</span><span class="o">.</span><span class="n">show_large_files_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;lf_page_&quot;</span><span class="p">):</span>
            <span class="kn">from</span> <span class="nn">large_files_handler</span> <span class="kn">import</span> <span class="n">large_files_handler</span>
            <span class="n">page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;lf_page_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
            <span class="k">await</span> <span class="n">large_files_handler</span><span class="o">.</span><span class="n">show_large_files_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;large_file_&quot;</span><span class="p">):</span>
            <span class="kn">from</span> <span class="nn">large_files_handler</span> <span class="kn">import</span> <span class="n">large_files_handler</span>
            <span class="k">await</span> <span class="n">large_files_handler</span><span class="o">.</span><span class="n">handle_file_selection</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;lf_view_&quot;</span><span class="p">):</span>
            <span class="kn">from</span> <span class="nn">large_files_handler</span> <span class="kn">import</span> <span class="n">large_files_handler</span>
            <span class="k">await</span> <span class="n">large_files_handler</span><span class="o">.</span><span class="n">view_large_file</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;lf_download_&quot;</span><span class="p">):</span>
            <span class="kn">from</span> <span class="nn">large_files_handler</span> <span class="kn">import</span> <span class="n">large_files_handler</span>
            <span class="k">await</span> <span class="n">large_files_handler</span><span class="o">.</span><span class="n">download_large_file</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;lf_edit_&quot;</span><span class="p">):</span>
            <span class="kn">from</span> <span class="nn">large_files_handler</span> <span class="kn">import</span> <span class="n">large_files_handler</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">large_files_handler</span><span class="o">.</span><span class="n">edit_large_file</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;lf_delete_&quot;</span><span class="p">):</span>
            <span class="kn">from</span> <span class="nn">large_files_handler</span> <span class="kn">import</span> <span class="n">large_files_handler</span>
            <span class="k">await</span> <span class="n">large_files_handler</span><span class="o">.</span><span class="n">delete_large_file_confirm</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;lf_confirm_delete_&quot;</span><span class="p">):</span>
            <span class="kn">from</span> <span class="nn">large_files_handler</span> <span class="kn">import</span> <span class="n">large_files_handler</span>
            <span class="k">await</span> <span class="n">large_files_handler</span><span class="o">.</span><span class="n">delete_large_file</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;lf_info_&quot;</span><span class="p">):</span>
            <span class="kn">from</span> <span class="nn">large_files_handler</span> <span class="kn">import</span> <span class="n">large_files_handler</span>
            <span class="k">await</span> <span class="n">large_files_handler</span><span class="o">.</span><span class="n">show_file_info</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;batch_analyze_all&quot;</span><span class="p">,</span> <span class="s2">&quot;batch_analyze_python&quot;</span><span class="p">,</span> <span class="s2">&quot;batch_analyze_javascript&quot;</span><span class="p">,</span> <span class="s2">&quot;batch_analyze_java&quot;</span><span class="p">,</span> <span class="s2">&quot;batch_analyze_cpp&quot;</span><span class="p">):</span>
            <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>
            <span class="kn">from</span> <span class="nn">batch_processor</span> <span class="kn">import</span> <span class="n">batch_processor</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
            <span class="n">language_map</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;batch_analyze_python&quot;</span><span class="p">:</span> <span class="s2">&quot;python&quot;</span><span class="p">,</span>
                <span class="s2">&quot;batch_analyze_javascript&quot;</span><span class="p">:</span> <span class="s2">&quot;javascript&quot;</span><span class="p">,</span>
                <span class="s2">&quot;batch_analyze_java&quot;</span><span class="p">:</span> <span class="s2">&quot;java&quot;</span><span class="p">,</span>
                <span class="s2">&quot;batch_analyze_cpp&quot;</span><span class="p">:</span> <span class="s2">&quot;cpp&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;batch_analyze_all&quot;</span><span class="p">:</span>
                <span class="n">all_files</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user_files</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
                <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">all_files</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">language</span> <span class="o">=</span> <span class="n">language_map</span><span class="p">[</span><span class="n">data</span><span class="p">]</span>
                <span class="n">all_files</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user_files</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
                <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">all_files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;programming_language&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">language</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;❌ לא נמצאו קבצים&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
            <span class="n">job_id</span> <span class="o">=</span> <span class="k">await</span> <span class="n">batch_processor</span><span class="o">.</span><span class="n">analyze_files_batch</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">files</span><span class="p">)</span>
            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📊 בדוק סטטוס&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;job_status:</span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)]]</span>
            <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
            <span class="n">sent</span> <span class="o">=</span> <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;⚡ &lt;b&gt;ניתוח Batch התחיל!&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">📁 מנתח </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span><span class="si">}</span><span class="s2"> קבצים</span><span class="se">\n</span><span class="s2">🆔 Job ID: &lt;code&gt;</span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span>
            <span class="p">)</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">_auto_update_batch_status</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">application</span><span class="p">,</span> <span class="n">sent</span><span class="o">.</span><span class="n">chat_id</span><span class="p">,</span> <span class="n">sent</span><span class="o">.</span><span class="n">message_id</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;batch_validate_all&quot;</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>
            <span class="kn">from</span> <span class="nn">batch_processor</span> <span class="kn">import</span> <span class="n">batch_processor</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
            <span class="n">all_files</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user_files</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
            <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">all_files</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;❌ לא נמצאו קבצים&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
            <span class="n">job_id</span> <span class="o">=</span> <span class="k">await</span> <span class="n">batch_processor</span><span class="o">.</span><span class="n">validate_files_batch</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">files</span><span class="p">)</span>
            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📊 בדוק סטטוס&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;job_status:</span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)]]</span>
            <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
            <span class="n">sent</span> <span class="o">=</span> <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;✅ &lt;b&gt;בדיקת תקינות Batch התחילה!&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">📁 בודק </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span><span class="si">}</span><span class="s2"> קבצים</span><span class="se">\n</span><span class="s2">🆔 Job ID: &lt;code&gt;</span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span>
            <span class="p">)</span>
            <span class="c1"># Auto refresh</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">_auto_update_batch_status</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">application</span><span class="p">,</span> <span class="n">sent</span><span class="o">.</span><span class="n">chat_id</span><span class="p">,</span> <span class="n">sent</span><span class="o">.</span><span class="n">message_id</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;show_jobs&quot;</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">batch_processor</span> <span class="kn">import</span> <span class="n">batch_processor</span>
            <span class="n">active_jobs</span> <span class="o">=</span> <span class="p">[</span><span class="n">job</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">batch_processor</span><span class="o">.</span><span class="n">active_jobs</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">active_jobs</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;אין עבודות פעילות&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">active_jobs</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]:</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">operation</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;job_status:</span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
            <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;📋 &lt;b&gt;עבודות Batch פעילות (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">active_jobs</span><span class="p">)</span><span class="si">}</span><span class="s2">):&lt;/b&gt;&quot;</span><span class="p">,</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;noop&quot;</span><span class="p">:</span>
            <span class="c1"># כפתור שלא עושה כלום (לתצוגה בלבד)</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;back_to_repo_menu&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">show_by_repo_menu_callback</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;help_page:&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">show_help_page</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
        <span class="c1"># --- Batch category routing ---</span>
        <span class="k">elif</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;batch_menu&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">show_batch_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;batch_cat:repos&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">show_batch_repos_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;batch_cat:zips&quot;</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;batch_target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;zips&#39;</span> <span class="p">}</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">show_batch_zips_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;batch_cat:large&quot;</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;batch_target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;large&#39;</span> <span class="p">}</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">show_batch_files_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;batch_cat:other&quot;</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;batch_target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;other&#39;</span> <span class="p">}</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">show_batch_files_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;batch_repo:&quot;</span><span class="p">):</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;batch_target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;repo&#39;</span><span class="p">,</span> <span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="n">tag</span> <span class="p">}</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">show_batch_files_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;batch_files_page_&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">show_batch_files_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;batch_zip_page_&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">show_batch_zips_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;batch_zip_download_id:&quot;</span><span class="p">):</span>
            <span class="n">backup_id</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">info_list</span> <span class="o">=</span> <span class="n">backup_manager</span><span class="o">.</span><span class="n">list_backups</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="n">match</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">info_list</span> <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">backup_id</span> <span class="o">==</span> <span class="n">backup_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">match</span><span class="o">.</span><span class="n">file_path</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">file_path</span><span class="p">):</span>
                    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;❌ הגיבוי לא נמצא בדיסק&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_document</span><span class="p">(</span>
                            <span class="n">document</span><span class="o">=</span><span class="n">fh</span><span class="p">,</span>
                            <span class="n">filename</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">file_path</span><span class="p">),</span>
                            <span class="n">caption</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;📦 </span><span class="si">{</span><span class="n">backup_id</span><span class="si">}</span><span class="s2"> — </span><span class="si">{</span><span class="n">_format_bytes</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">file_path</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;❌ שגיאה בהורדה&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;batch_file:&quot;</span><span class="p">):</span>
            <span class="c1"># בחירת קובץ יחיד</span>
            <span class="n">gi</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;batch_items&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">gi</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;batch_selected_files&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">items</span><span class="p">[</span><span class="n">gi</span><span class="p">]]</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">show_batch_actions_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;קובץ לא קיים&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
        <span class="k">elif</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;batch_select_all&quot;</span><span class="p">:</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;batch_items&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">items</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;אין קבצים לבחור&quot;</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;batch_selected_files&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">show_batch_actions_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;batch_back_to_files&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">show_batch_files_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;batch_action:&quot;</span><span class="p">):</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">execute_batch_on_current_selection</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;by_repo:&quot;</span><span class="p">):</span>
            <span class="c1"># הצגת קבצים לפי תגית ריפו + אפשרות מחיקה מרוכזת, עם עימוד</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;files_origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;by_repo&#39;</span><span class="p">,</span> <span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="n">tag</span> <span class="p">}</span>
            <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
            <span class="n">files</span><span class="p">,</span> <span class="n">total</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user_files_by_repo</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">per_page</span><span class="o">=</span><span class="n">FILES_PAGE_SIZE</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;ℹ️ אין קבצים עבור התגית הזו.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
            <span class="c1"># נשמור את מספר העמוד הנוכחי עבור ניווט חזרה</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;files_last_page&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;files_cache&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">start_index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">offset</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">start_index</span> <span class="o">+</span> <span class="n">offset</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span> <span class="s1">&#39;ללא שם&#39;</span><span class="p">)</span>
                <span class="n">language</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;programming_language&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">)</span>
                <span class="n">emoji</span> <span class="o">=</span> <span class="n">get_file_emoji</span><span class="p">(</span><span class="n">language</span><span class="p">)</span>
                <span class="n">button_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">emoji</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">button_text</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;file_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;files_cache&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">f</span>
            <span class="c1"># שורת עימוד</span>
            <span class="n">pagination_row</span> <span class="o">=</span> <span class="n">build_pagination_row</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">total</span><span class="p">,</span> <span class="n">FILES_PAGE_SIZE</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;by_repo_page:</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pagination_row</span><span class="p">:</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pagination_row</span><span class="p">)</span>
            <span class="c1"># פעולת העברה לריפו הנוכחי לסל המיחזור</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🗑️ העבר את כל הריפו לסל&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;byrepo_delete_confirm:</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;back_to_repo_menu&quot;</span><span class="p">)])</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🏠 תפריט ראשי&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;main&quot;</span><span class="p">)])</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;📂 קבצים עם </span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;search_files&quot;</span><span class="p">:</span>
            <span class="c1"># מעבר למצב חיפוש: בקשת שאילתא מהמשתמש</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;search_ctx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="s1">&#39;all_files&#39;</span><span class="p">}</span>
            <span class="n">kb</span> <span class="o">=</span> <span class="p">[[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזרה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;files&quot;</span><span class="p">)]]</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="s2">&quot;🔎 *חיפוש קבצים*</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;הקלד/י אחת מהאפשרויות:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;• שם קובץ או חלק ממנו (לדוגמה: main.py או main)</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;• תגית עם קידומת repo:owner/name</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;• שפה (לדוגמה: python, js)</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;או שילוב: name:util lang:python tag:repo:me/project&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span>
                <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">MARKDOWN</span>
            <span class="p">)</span>
            <span class="c1"># סמן שמחכים לטקסט חיפוש</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;awaiting_search_text&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;byrepo_delete_confirm:&quot;</span><span class="p">):</span>
            <span class="c1"># שלב אישור ראשון למחיקת כל הקבצים תחת תגית ריפו</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">search_code</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="k">if</span> <span class="n">tag</span> <span class="k">else</span> <span class="p">[],</span> <span class="n">limit</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
            <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_ttl_raw</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;RECYCLE_TTL_DAYS&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
                <span class="n">_ttl_days</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">_ttl_raw</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">_ttl_days</span> <span class="o">=</span> <span class="mi">7</span>
            <span class="n">warn_text</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;⚠️ עומד/ת להעביר &lt;b&gt;</span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s2">&lt;/b&gt; קבצים של &lt;code&gt;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">&lt;/code&gt; לסל המיחזור.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;הקבצים יהיו ניתנים לשחזור עד </span><span class="si">{</span><span class="n">_ttl_days</span><span class="si">}</span><span class="s2"> ימים, ולאחר מכן יימחקו אוטומטית.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;אין שום פעולה מול GitHub, ולא נמחקים קבצי ZIP/גדולים.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;אם זה בטעות, חזור/י אחורה.&quot;</span>
            <span class="p">)</span>
            <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;✅ אני מאשר/ת&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;byrepo_delete_double_confirm:</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזרה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;by_repo:</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)],</span>
            <span class="p">]</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">warn_text</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;byrepo_delete_double_confirm:&quot;</span><span class="p">):</span>
            <span class="c1"># שלב אישור שני</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_ttl_raw</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;RECYCLE_TTL_DAYS&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
                <span class="n">_ttl_days</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">_ttl_raw</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">_ttl_days</span> <span class="o">=</span> <span class="mi">7</span>
            <span class="n">text2</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;🧨 אישור סופי להעברה לסל</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;כל הקבצים תחת &lt;code&gt;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">&lt;/code&gt; יועברו לסל המיחזור ויישארו לשחזור עד </span><span class="si">{</span><span class="n">_ttl_days</span><span class="si">}</span><span class="s2"> ימים.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;אין שום פעולה מול GitHub, ולא נמחקים קבצי ZIP/גדולים.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🧨 כן, העבר לסל&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;byrepo_delete_do:</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 בטל&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;by_repo:</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)],</span>
            <span class="p">]</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">text2</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;by_repo_page:&quot;</span><span class="p">):</span>
            <span class="c1"># עימוד קבצים לפי תגית ריפו: תבנית callback &quot;by_repo_page:{tag}:{page}&quot;</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
            <span class="c1"># צורה אפשרית: [&quot;by_repo_page&quot;, &quot;repo&quot;, &quot;me/app&quot;, &quot;2&quot;] או [&quot;by_repo_page&quot;,&quot;repo:me/app&quot;,&quot;2&quot;]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">page</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="c1"># התגית היא כל מה שבין prefix לבין העמוד האחרון</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="s2">&quot;:&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">page</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">page</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;files_origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;by_repo&#39;</span><span class="p">,</span> <span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="n">tag</span> <span class="p">}</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;files_last_page&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span>
            <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
            <span class="n">files</span><span class="p">,</span> <span class="n">total</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user_files_by_repo</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="n">page</span><span class="p">,</span> <span class="n">per_page</span><span class="o">=</span><span class="n">FILES_PAGE_SIZE</span><span class="p">)</span>
            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;files_cache&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">start_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">FILES_PAGE_SIZE</span>
            <span class="k">for</span> <span class="n">offset</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">start_index</span> <span class="o">+</span> <span class="n">offset</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span> <span class="s1">&#39;ללא שם&#39;</span><span class="p">)</span>
                <span class="n">language</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;programming_language&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">)</span>
                <span class="n">emoji</span> <span class="o">=</span> <span class="n">get_file_emoji</span><span class="p">(</span><span class="n">language</span><span class="p">)</span>
                <span class="n">button_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">emoji</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">button_text</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;file_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;files_cache&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">f</span>
            <span class="n">pagination_row</span> <span class="o">=</span> <span class="n">build_pagination_row</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">total</span><span class="p">,</span> <span class="n">FILES_PAGE_SIZE</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;by_repo_page:</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pagination_row</span><span class="p">:</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pagination_row</span><span class="p">)</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🗑️ העבר את כל הריפו לסל&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;byrepo_delete_confirm:</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;back_to_repo_menu&quot;</span><span class="p">)])</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🏠 תפריט ראשי&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;main&quot;</span><span class="p">)])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;📂 קבצים עם </span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">telegram</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">BadRequest</span> <span class="k">as</span> <span class="n">br</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;message is not modified&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="k">raise</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;search_page_&quot;</span><span class="p">):</span>
            <span class="c1"># עימוד תוצאות חיפוש שהוזנו בטקסט</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">page</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">PAGE_SIZE</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="n">filters</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;search_filters&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="n">name_filter</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name_filter&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
            <span class="n">lang</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lang&#39;</span><span class="p">)</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tag&#39;</span><span class="p">)</span>
            <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">search_code</span><span class="p">(</span>
                <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">query</span><span class="o">=</span><span class="n">name_filter</span><span class="p">,</span>
                <span class="n">programming_language</span><span class="o">=</span><span class="p">(</span><span class="n">lang</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                <span class="n">tags</span><span class="o">=</span><span class="p">([</span><span class="n">tag</span><span class="p">]</span> <span class="k">if</span> <span class="n">tag</span> <span class="k">else</span> <span class="p">[]),</span>
                <span class="n">limit</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
            <span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
            <span class="c1"># סינון נוסף לפי שם אם צריך</span>
            <span class="k">if</span> <span class="n">name_filter</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">nf</span> <span class="o">=</span> <span class="n">name_filter</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="n">nf</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
            <span class="n">total_pages</span> <span class="o">=</span> <span class="p">(</span><span class="n">total</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">PAGE_SIZE</span> <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">page</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">page</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">page</span> <span class="o">&gt;</span> <span class="n">total_pages</span><span class="p">:</span>
                <span class="n">page</span> <span class="o">=</span> <span class="n">total_pages</span>
            <span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span>
            <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">total</span><span class="p">)</span>
            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;files_cache&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span> <span class="s1">&#39;קובץ&#39;</span><span class="p">)</span>
                <span class="n">lang_v</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;programming_language&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">)</span>
                <span class="n">button_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;📄 </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">lang_v</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">button_text</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;file_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;files_cache&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">item</span>
            <span class="n">row</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">page</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;⬅️ הקודם&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;search_page_</span><span class="si">{</span><span class="n">page</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">page</span> <span class="o">&lt;</span> <span class="n">total_pages</span><span class="p">:</span>
                <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;➡️ הבא&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;search_page_</span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">:</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזרה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;files&quot;</span><span class="p">)])</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;🔎 תוצאות חיפוש — סה״כ: </span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                <span class="sa">f</span><span class="s2">&quot;📄 עמוד </span><span class="si">{</span><span class="n">page</span><span class="si">}</span><span class="s2"> מתוך </span><span class="si">{</span><span class="n">total_pages</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;byrepo_delete_do:&quot;</span><span class="p">):</span>
            <span class="c1"># ביצוע מחיקה בפועל: מחיקה לפי שם קובץ של כל הקבצים תחת התג הנבחר</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">search_code</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="k">if</span> <span class="n">tag</span> <span class="k">else</span> <span class="p">[],</span> <span class="n">limit</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
            <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
            <span class="n">deleted</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># הודעת התקדמות ראשונית + אימוג׳י קבוע</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">spinner_emoji</span> <span class="o">=</span> <span class="s2">&quot;⏳&quot;</span>
                <span class="n">percent</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">progress_text</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">spinner_emoji</span><span class="si">}</span><span class="s2"> מוחק קבצים… 0/</span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s2"> (0%)</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;זה עלול להימשך עד דקה.&quot;</span>
                <span class="p">)</span>
                <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">progress_text</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="c1"># מחיקה עם עדכוני התקדמות מתונים (Rate-limit ידידותי)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">time</span> <span class="k">as</span> <span class="nn">_time</span>
                <span class="n">last_edit_ts</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">last_edit_ts</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">delete_file</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
                        <span class="n">deleted</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="c1"># עדכון התקדמות כל ~0.8 שניות או כל 25 קבצים</span>
                <span class="n">now_ts</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">now_ts</span> <span class="o">=</span> <span class="n">_time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="n">should_update</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">idx</span> <span class="o">%</span> <span class="mi">25</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">should_update</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">last_edit_ts</span> <span class="o">==</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="p">(</span><span class="n">now_ts</span> <span class="ow">and</span> <span class="p">(</span><span class="n">now_ts</span> <span class="o">-</span> <span class="n">last_edit_ts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mf">0.8</span><span class="p">):</span>
                    <span class="n">should_update</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">should_update</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">percent</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">deleted</span> <span class="o">/</span> <span class="n">total</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">100</span>
                        <span class="n">progress_text</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">spinner_emoji</span><span class="si">}</span><span class="s2"> מוחק קבצים… </span><span class="si">{</span><span class="n">deleted</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">percent</span><span class="si">}</span><span class="s2">%)</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="s2">&quot;זה עלול להימשך עד דקה.&quot;</span>
                        <span class="p">)</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">progress_text</span><span class="p">)</span>
                        <span class="n">last_edit_ts</span> <span class="o">=</span> <span class="n">now_ts</span> <span class="ow">or</span> <span class="n">last_edit_ts</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_ttl_raw</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;RECYCLE_TTL_DAYS&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
                <span class="n">_ttl_days</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">_ttl_raw</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">_ttl_days</span> <span class="o">=</span> <span class="mi">7</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;✅ הועברו לסל </span><span class="si">{</span><span class="n">deleted</span><span class="si">}</span><span class="s2"> קבצים תחת &lt;code&gt;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">&lt;/code&gt;.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;♻️ ניתן לשחזר מסל המיחזור עד </span><span class="si">{</span><span class="n">_ttl_days</span><span class="si">}</span><span class="s2"> ימים.&quot;</span>
            <span class="p">)</span>
            <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור לתפריט ריפו&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;by_repo_menu&quot;</span><span class="p">)],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🏠 תפריט ראשי&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;main&quot;</span><span class="p">)],</span>
            <span class="p">]</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;batch_zip_page_&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">show_batch_zips_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;batch_zip_use_for_batch:&quot;</span><span class="p">):</span>
            <span class="c1"># בחירה ב-ZIP לצורך עיבוד Batch: מעבר לבחירת קבצים/&quot;בחר הכל&quot;</span>
            <span class="n">zid</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;batch_selected_zip_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zid</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;batch_target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;zips&#39;</span> <span class="p">}</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">show_batch_files_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
    <span class="k">except</span> <span class="n">telegram</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">BadRequest</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;Message is not modified&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
            <span class="k">raise</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in smart callback handler: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># שחרור ה-guard בזמן יציאה</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_cb_busy_until&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
    
    <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span></div>


<div class="viewcode-block" id="cancel">
<a class="viewcode-back" href="../api/conversation_handlers.html#conversation_handlers.cancel">[תיעוד]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">cancel</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ביטול מתקדם&quot;&quot;&quot;</span>
    <span class="c1"># ביטול טיימאאוט אם קיים וניקוי מצב איסוף</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">job</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;long_collect_job&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">job</span><span class="p">:</span>
            <span class="n">job</span><span class="o">.</span><span class="n">schedule_removal</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    
    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
        <span class="s2">&quot;🚫 התהליך בוטל בהצלחה!</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;🏠 חוזרים לבית החכם שלנו.&quot;</span><span class="p">,</span>
        <span class="n">reply_markup</span><span class="o">=</span><span class="n">ReplyKeyboardMarkup</span><span class="p">(</span><span class="n">MAIN_KEYBOARD</span><span class="p">,</span> <span class="n">resize_keyboard</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span></div>


<div class="viewcode-block" id="get_save_conversation_handler">
<a class="viewcode-back" href="../api/conversation_handlers.html#conversation_handlers.get_save_conversation_handler">[תיעוד]</a>
<span class="k">def</span> <span class="nf">get_save_conversation_handler</span><span class="p">(</span><span class="n">db</span><span class="p">:</span> <span class="n">DatabaseManager</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConversationHandler</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;יוצר ConversationHandler מתקדם וחכם&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;יוצר מערכת שיחה מתקדמת...&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">ConversationHandler</span><span class="p">(</span>
        <span class="n">entry_points</span><span class="o">=</span><span class="p">[</span>
            <span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="n">start_command</span><span class="p">),</span>
            <span class="n">MessageHandler</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">Regex</span><span class="p">(</span><span class="s2">&quot;^➕ הוסף קוד חדש$&quot;</span><span class="p">),</span> <span class="n">start_add_code_menu</span><span class="p">),</span>
            <span class="n">MessageHandler</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">Regex</span><span class="p">(</span><span class="s2">&quot;^📚 הצג את כל הקבצים שלי$&quot;</span><span class="p">),</span> <span class="n">show_all_files</span><span class="p">),</span>
            <span class="n">MessageHandler</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">Regex</span><span class="p">(</span><span class="s2">&quot;^📂 קבצים גדולים$&quot;</span><span class="p">),</span> <span class="n">show_large_files_direct</span><span class="p">),</span>
            <span class="n">MessageHandler</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">Regex</span><span class="p">(</span><span class="s2">&quot;^🔧 GitHub$&quot;</span><span class="p">),</span> <span class="n">show_github_menu</span><span class="p">),</span>
            <span class="n">MessageHandler</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">Regex</span><span class="p">(</span><span class="s2">&quot;^📥 ייבוא ZIP מריפו$&quot;</span><span class="p">),</span> <span class="n">start_repo_zip_import</span><span class="p">),</span>
            <span class="n">MessageHandler</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">Regex</span><span class="p">(</span><span class="s2">&quot;^🗜️ יצירת ZIP$&quot;</span><span class="p">),</span> <span class="n">start_zip_create_flow</span><span class="p">),</span>
            <span class="n">MessageHandler</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">Regex</span><span class="p">(</span><span class="s2">&quot;^🗂 לפי ריפו$&quot;</span><span class="p">),</span> <span class="n">show_by_repo_menu</span><span class="p">),</span>
            <span class="n">MessageHandler</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">Regex</span><span class="p">(</span><span class="s2">&quot;^ℹ️ הסבר על הבוט$&quot;</span><span class="p">),</span> <span class="k">lambda</span> <span class="n">u</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="n">show_help_page</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span>
            
            <span class="c1"># כניסה לעריכת קוד/שם/הערה גם דרך כפתורי callback כדי שמצב השיחה ייקבע כראוי</span>
            <span class="n">CallbackQueryHandler</span><span class="p">(</span><span class="n">handle_callback_query</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^(edit_code_|edit_name_|edit_note_|edit_note_direct_|lf_edit_)&#39;</span><span class="p">)</span>
        <span class="p">],</span>
        <span class="n">states</span><span class="o">=</span><span class="p">{</span>
            <span class="n">WAIT_ADD_CODE_MODE</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">CallbackQueryHandler</span><span class="p">(</span><span class="n">handle_callback_query</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="n">GET_CODE</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">MessageHandler</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">TEXT</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">filters</span><span class="o">.</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">get_code</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="n">GET_FILENAME</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">MessageHandler</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">TEXT</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">filters</span><span class="o">.</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">get_filename</span><span class="p">),</span>
                <span class="n">CallbackQueryHandler</span><span class="p">(</span><span class="n">handle_duplicate_callback</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="n">GET_NOTE</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">MessageHandler</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">TEXT</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">filters</span><span class="o">.</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">get_note</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="n">LONG_COLLECT</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">MessageHandler</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">TEXT</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">filters</span><span class="o">.</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">long_collect_receive</span><span class="p">),</span>
                <span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;done&quot;</span><span class="p">,</span> <span class="n">long_collect_done</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="n">EDIT_CODE</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">MessageHandler</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">TEXT</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">filters</span><span class="o">.</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">receive_new_code</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="n">EDIT_NAME</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">MessageHandler</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">TEXT</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">filters</span><span class="o">.</span><span class="n">COMMAND</span><span class="p">,</span> <span class="n">receive_new_name</span><span class="p">)</span>
            <span class="p">],</span>
        <span class="p">},</span>
        <span class="n">fallbacks</span><span class="o">=</span><span class="p">[</span>
            <span class="n">CommandHandler</span><span class="p">(</span><span class="s2">&quot;cancel&quot;</span><span class="p">,</span> <span class="n">cancel</span><span class="p">),</span>
            <span class="n">CallbackQueryHandler</span><span class="p">(</span><span class="n">handle_callback_query</span><span class="p">)</span>
        <span class="p">],</span>
        <span class="n">allow_reentry</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">per_message</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="handle_view_version">
<a class="viewcode-back" href="../api/conversation_handlers.html#conversation_handlers.handle_view_version">[תיעוד]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">handle_view_version</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;הצגת קוד של גרסה מסוימת&quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># פורמט צפוי: view_version_{version}_{file_name}</span>
        <span class="n">remainder</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;view_version_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">sep_index</span> <span class="o">=</span> <span class="n">remainder</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sep_index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ נתוני גרסה שגויים&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
        <span class="n">version_str</span> <span class="o">=</span> <span class="n">remainder</span><span class="p">[:</span><span class="n">sep_index</span><span class="p">]</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">remainder</span><span class="p">[</span><span class="n">sep_index</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">version_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">version_str</span><span class="p">)</span>
        
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>
        <span class="n">version_doc</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">version_num</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">version_doc</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ הגרסה המבוקשת לא נמצאה&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
        
        <span class="c1"># בדיקה אם זו הגרסה הנוכחית</span>
        <span class="n">latest_doc</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        <span class="n">latest_version_num</span> <span class="o">=</span> <span class="n">latest_doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">latest_doc</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">is_current</span> <span class="o">=</span> <span class="n">latest_version_num</span> <span class="o">==</span> <span class="n">version_num</span>
        
        <span class="n">code</span> <span class="o">=</span> <span class="n">version_doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">language</span> <span class="o">=</span> <span class="n">version_doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;programming_language&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">)</span>
        
        <span class="c1"># קיצור תצוגה אם ארוך מדי — נכבד מגבלת 4096 לאחר escape ל-HTML</span>
        <span class="n">max_length</span> <span class="o">=</span> <span class="mi">3500</span>
        <span class="n">code_preview</span> <span class="o">=</span> <span class="n">code</span><span class="p">[:</span><span class="n">max_length</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">is_current</span><span class="p">:</span>
            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📚 היסטוריה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;versions_file_</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="p">],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזרה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;view_direct_</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)]</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;↩️ שחזר לגרסה זו&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;revert_version_</span><span class="si">{</span><span class="n">version_num</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📚 היסטוריה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;versions_file_</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="p">],</span>
                <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזרה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;view_direct_</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)]</span>
            <span class="p">]</span>
        <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
        
        <span class="n">header_html</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;📄 &lt;b&gt;</span><span class="si">{</span><span class="n">html_escape</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/b&gt; (</span><span class="si">{</span><span class="n">html_escape</span><span class="p">(</span><span class="n">language</span><span class="p">)</span><span class="si">}</span><span class="s2">) - גרסה </span><span class="si">{</span><span class="n">version_num</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">html_wrapper_overhead</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="s2">&quot;&lt;pre&gt;&lt;code&gt;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="s2">&quot;&lt;/code&gt;&lt;/pre&gt;&quot;</span><span class="p">)</span>
        <span class="n">fudge</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">available_for_code</span> <span class="o">=</span> <span class="mi">4096</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">header_html</span><span class="p">)</span> <span class="o">-</span> <span class="n">html_wrapper_overhead</span> <span class="o">-</span> <span class="n">fudge</span>
        <span class="k">if</span> <span class="n">available_for_code</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="n">available_for_code</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="n">preview_raw_limit</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_length</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">))</span>
        <span class="n">safe_code</span> <span class="o">=</span> <span class="n">html_escape</span><span class="p">(</span><span class="n">code</span><span class="p">[:</span><span class="n">preview_raw_limit</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">safe_code</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">available_for_code</span> <span class="ow">and</span> <span class="n">preview_raw_limit</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">factor</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">safe_code</span><span class="p">)</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">preview_raw_limit</span><span class="p">))</span>
                <span class="n">preview_raw_limit</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">available_for_code</span> <span class="o">/</span> <span class="n">factor</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">preview_raw_limit</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">preview_raw_limit</span> <span class="o">-</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">safe_code</span><span class="p">)</span> <span class="o">-</span> <span class="n">available_for_code</span><span class="p">))</span>
            <span class="n">safe_code</span> <span class="o">=</span> <span class="n">html_escape</span><span class="p">(</span><span class="n">code</span><span class="p">[:</span><span class="n">preview_raw_limit</span><span class="p">])</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">safe_code</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">available_for_code</span> <span class="ow">and</span> <span class="n">preview_raw_limit</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">step</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">safe_code</span><span class="p">)</span> <span class="o">-</span> <span class="n">available_for_code</span><span class="p">)</span>
                <span class="n">preview_raw_limit</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">preview_raw_limit</span> <span class="o">-</span> <span class="n">step</span><span class="p">)</span>
                <span class="n">safe_code</span> <span class="o">=</span> <span class="n">html_escape</span><span class="p">(</span><span class="n">code</span><span class="p">[:</span><span class="n">preview_raw_limit</span><span class="p">])</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">header_html</span><span class="si">}</span><span class="s2">&lt;pre&gt;&lt;code&gt;</span><span class="si">{</span><span class="n">safe_code</span><span class="si">}</span><span class="s2">&lt;/code&gt;&lt;/pre&gt;&quot;</span><span class="p">,</span>
            <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span><span class="p">,</span>
            <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span>
        <span class="p">)</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in handle_view_version: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ שגיאה בהצגת גרסה&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span></div>


<div class="viewcode-block" id="handle_revert_version">
<a class="viewcode-back" href="../api/conversation_handlers.html#conversation_handlers.handle_revert_version">[תיעוד]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">handle_revert_version</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;שחזור הקובץ לגרסה מסוימת על ידי יצירת גרסה חדשה עם תוכן ישן&quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># פורמט צפוי: revert_version_{version}_{file_name}</span>
        <span class="n">remainder</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;revert_version_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">sep_index</span> <span class="o">=</span> <span class="n">remainder</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sep_index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ נתוני שחזור שגויים&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
        <span class="n">version_str</span> <span class="o">=</span> <span class="n">remainder</span><span class="p">[:</span><span class="n">sep_index</span><span class="p">]</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">remainder</span><span class="p">[</span><span class="n">sep_index</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">version_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">version_str</span><span class="p">)</span>
        
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
        <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>
        <span class="n">version_doc</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">version_num</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">version_doc</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ הגרסה לשחזור לא נמצאה&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
        
        <span class="n">code</span> <span class="o">=</span> <span class="n">version_doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">language</span> <span class="o">=</span> <span class="n">version_doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;programming_language&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">)</span>
        
        <span class="n">success</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">save_file</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">language</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ שגיאה בשחזור הגרסה&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
        
        <span class="n">latest</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        <span class="n">latest_ver</span> <span class="o">=</span> <span class="n">latest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="n">version_num</span><span class="p">)</span> <span class="k">if</span> <span class="n">latest</span> <span class="k">else</span> <span class="n">version_num</span>
        
        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;👁️ הצג קוד מעודכן&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;view_direct_</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📚 היסטוריה&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;versions_file_</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">]</span>
        <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
        
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;✅ *שוחזר בהצלחה לגרסה </span><span class="si">{</span><span class="n">version_num</span><span class="si">}</span><span class="s2">!*</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;📄 **קובץ:** `</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">`</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;📝 **גרסה נוכחית:** </span><span class="si">{</span><span class="n">latest_ver</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span><span class="p">,</span>
            <span class="n">parse_mode</span><span class="o">=</span><span class="s1">&#39;Markdown&#39;</span>
        <span class="p">)</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in handle_revert_version: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ שגיאה בשחזור גרסה&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span></div>


<div class="viewcode-block" id="handle_preview_button">
<a class="viewcode-back" href="../api/conversation_handlers.html#conversation_handlers.handle_preview_button">[תיעוד]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">handle_preview_button</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;טיפול בכפתור &#39;תצוגה מקדימה&#39;&quot;&quot;&quot;</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
    
    <span class="c1"># הצגת קבצים אחרונים לתצוגה מקדימה</span>
    <span class="kn">from</span> <span class="nn">autocomplete_manager</span> <span class="kn">import</span> <span class="n">autocomplete</span>
    <span class="n">recent_files</span> <span class="o">=</span> <span class="n">autocomplete</span><span class="o">.</span><span class="n">get_recent_files</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">recent_files</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
            <span class="s2">&quot;📂 אין קבצים זמינים לתצוגה מקדימה</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;💡 צור קבצים חדשים כדי להשתמש בפיצ&#39;ר זה&quot;</span><span class="p">,</span>
            <span class="n">reply_markup</span><span class="o">=</span><span class="n">ReplyKeyboardMarkup</span><span class="p">(</span><span class="n">MAIN_KEYBOARD</span><span class="p">,</span> <span class="n">resize_keyboard</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span>
    
    <span class="c1"># יצירת כפתורים לקבצים אחרונים</span>
    <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">recent_files</span><span class="p">:</span>
        <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
            <span class="n">InlineKeyboardButton</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;👁️ </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;preview_file:</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="p">])</span>
    
    <span class="c1"># כפתור חזרה</span>
    <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
        <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🏠 תפריט ראשי&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;main_menu&quot;</span><span class="p">)</span>
    <span class="p">])</span>
    
    <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
    
    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
        <span class="s2">&quot;👁️ &lt;b&gt;תצוגה מקדימה מהירה&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;בחר קובץ לתצוגה מקדימה (15 שורות ראשונות):&quot;</span><span class="p">,</span>
        <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">,</span>
        <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="handle_autocomplete_button">
<a class="viewcode-back" href="../api/conversation_handlers.html#conversation_handlers.handle_autocomplete_button">[תיעוד]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">handle_autocomplete_button</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;טיפול בכפתור &#39;אוטו-השלמה&#39;&quot;&quot;&quot;</span>
    <span class="k">await</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span><span class="p">(</span>
        <span class="s2">&quot;🔍 &lt;b&gt;אוטו-השלמה חכמה&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;השתמש בפקודה: &lt;code&gt;/autocomplete &amp;lt;תחילת_שם&amp;gt;&lt;/code&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;דוגמאות:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• &lt;code&gt;/autocomplete scr&lt;/code&gt; - יציע script.py, scraper.js</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• &lt;code&gt;/autocomplete api&lt;/code&gt; - יציע api.py, api_client.js</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;• &lt;code&gt;/autocomplete test&lt;/code&gt; - יציע test_utils.py, testing.js</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;💡 &lt;b&gt;טיפ:&lt;/b&gt; ככל שתכתוב יותר תווים, ההצעות יהיו מדויקות יותר!&quot;</span><span class="p">,</span>
        <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">,</span>
        <span class="n">reply_markup</span><span class="o">=</span><span class="n">ReplyKeyboardMarkup</span><span class="p">(</span><span class="n">MAIN_KEYBOARD</span><span class="p">,</span> <span class="n">resize_keyboard</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="handle_batch_button">
<a class="viewcode-back" href="../api/conversation_handlers.html#conversation_handlers.handle_batch_button">[תיעוד]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">handle_batch_button</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;טיפול בכפתור &#39;עיבוד Batch&#39; - מציג תפריט בחירת קטגוריה&quot;&quot;&quot;</span>
    <span class="k">await</span> <span class="n">show_batch_menu</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<div class="viewcode-block" id="show_batch_menu">
<a class="viewcode-back" href="../api/conversation_handlers.html#conversation_handlers.show_batch_menu">[תיעוד]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">show_batch_menu</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;תפריט בחירת קטגוריה עבור עיבוד Batch&quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span> <span class="k">if</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>
        <span class="n">send</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">send</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_text</span>
    <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🗂 לפי ריפו&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;batch_cat:repos&quot;</span><span class="p">)],</span>
        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📦 קבצי ZIP&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;batch_cat:zips&quot;</span><span class="p">)],</span>
        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📂 קבצים גדולים&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;batch_cat:large&quot;</span><span class="p">)],</span>
        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📁 שאר הקבצים&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;batch_cat:other&quot;</span><span class="p">)],</span>
        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📋 סטטוס עבודות&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;show_jobs&quot;</span><span class="p">)],</span>
        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;main&quot;</span><span class="p">)],</span>
    <span class="p">]</span>
    <span class="k">await</span> <span class="n">send</span><span class="p">(</span>
        <span class="s2">&quot;⚡ &lt;b&gt;עיבוד Batch&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">בחר/י קבוצת קבצים לעיבוד:&quot;</span><span class="p">,</span>
        <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span>
        <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span></div>


<div class="viewcode-block" id="show_batch_repos_menu">
<a class="viewcode-back" href="../api/conversation_handlers.html#conversation_handlers.show_batch_repos_menu">[תיעוד]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">show_batch_repos_menu</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;תפריט בחירת ריפו לעיבוד Batch&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user_files</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
    <span class="n">repo_to_count</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;repo:&#39;</span><span class="p">):</span>
                <span class="n">repo_to_count</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">repo_to_count</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">repo_to_count</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;ℹ️ אין קבצים עם תגיות ריפו.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>
    <span class="c1"># מיין לפי תווית מוצגת (repo בלבד) לשיפור קריאות</span>
    <span class="n">sorted_items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">repo_to_count</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">_repo_only_from_tag</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">lower</span><span class="p">())[:</span><span class="mi">50</span><span class="p">]</span>
    <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;🗂 בחר/י ריפו לעיבוד:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">cnt</span> <span class="ow">in</span> <span class="n">sorted_items</span><span class="p">:</span>
        <span class="c1"># תווית מלאה לרשימה</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;• </span><span class="si">{</span><span class="n">_repo_label_from_tag</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">cnt</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="c1"># כפתור עם שם מקוצר בלבד</span>
        <span class="n">btn_text</span> <span class="o">=</span> <span class="n">_build_repo_button_text</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">cnt</span><span class="p">)</span>
        <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">btn_text</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;batch_repo:</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
    <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;batch_menu&quot;</span><span class="p">)])</span>
    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span>
        <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span></div>


<div class="viewcode-block" id="show_batch_files_menu">
<a class="viewcode-back" href="../api/conversation_handlers.html#conversation_handlers.show_batch_files_menu">[תיעוד]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">show_batch_files_menu</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">page</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;מציג רשימת קבצים בהתאם לקטגוריה שנבחרה לבחירה (הכל או בודד)&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;batch_target&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span>
    <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="s1">&#39;repo&#39;</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tag&#39;</span><span class="p">)</span>
            <span class="n">files_docs</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">search_code</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="k">if</span> <span class="n">tag</span> <span class="k">else</span> <span class="p">[],</span> <span class="n">limit</span><span class="o">=</span><span class="mi">2000</span><span class="p">)</span>
            <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files_docs</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="n">t</span> <span class="o">==</span> <span class="s1">&#39;zips&#39;</span><span class="p">:</span>
            <span class="c1"># הצג את כל הקבצים הרגילים</span>
            <span class="n">files_docs</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user_files</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
            <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files_docs</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="n">t</span> <span class="o">==</span> <span class="s1">&#39;large&#39;</span><span class="p">:</span>
            <span class="n">large_files</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user_large_files</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">per_page</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
            <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">large_files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="n">t</span> <span class="o">==</span> <span class="s1">&#39;other&#39;</span><span class="p">:</span>
            <span class="n">files_docs</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user_files</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
            <span class="n">files_docs</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files_docs</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">((</span><span class="n">tg</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;repo:&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">tg</span> <span class="ow">in</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]))]</span>
            <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files_docs</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">files_docs</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user_files</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
            <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files_docs</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">)]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">items</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ לא נמצאו קבצים לקטגוריה שנבחרה&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>

        <span class="c1"># שמור רשימה בזיכרון זמני כדי לאפשר בחירה זריזה</span>
        <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;batch_items&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">items</span>

        <span class="c1"># עימוד</span>
        <span class="n">PAGE_SIZE</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
        <span class="n">total_pages</span> <span class="o">=</span> <span class="p">(</span><span class="n">total</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">PAGE_SIZE</span>
        <span class="k">if</span> <span class="n">page</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">page</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">page</span> <span class="o">&gt;</span> <span class="n">total_pages</span><span class="p">:</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">total_pages</span>
        <span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span>
        <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">total</span><span class="p">)</span>

        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">],</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">):</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📄 </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;batch_file:</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>

        <span class="c1"># ניווט</span>
        <span class="n">nav</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">build_pagination_row</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">total</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s2">&quot;batch_files_page_&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">:</span>
            <span class="n">nav</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nav</span><span class="p">:</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nav</span><span class="p">)</span>

        <span class="c1"># פעולות</span>
        <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;✅ בחר הכל&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;batch_select_all&quot;</span><span class="p">)])</span>
        <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;batch_menu&quot;</span><span class="p">)])</span>

        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;בחר/י קובץ לניתוח/בדיקה, או לחץ על &#39;בחר הכל&#39; כדי לעבד את כל הקבצים (</span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">,</span>
            <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in show_batch_files_menu: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ שגיאה בטעינת רשימת קבצים ל-Batch&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span></div>


<div class="viewcode-block" id="show_batch_zips_menu">
<a class="viewcode-back" href="../api/conversation_handlers.html#conversation_handlers.show_batch_zips_menu">[תיעוד]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">show_batch_zips_menu</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">page</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;מציג רשימת קבצי ZIP שמורים (גיבויים/ארכיונים) עבור Batch&quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">backups</span> <span class="o">=</span> <span class="n">backup_manager</span><span class="o">.</span><span class="n">list_backups</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="c1"># מציג את כל קבצי ה‑ZIP השמורים בבוט</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">backups</span><span class="p">:</span>
            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;batch_menu&quot;</span><span class="p">)]]</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                <span class="s2">&quot;ℹ️ לא נמצאו קבצי ZIP שמורים.&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>

        <span class="n">PAGE_SIZE</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">backups</span><span class="p">)</span>
        <span class="n">total_pages</span> <span class="o">=</span> <span class="p">(</span><span class="n">total</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">PAGE_SIZE</span>
        <span class="k">if</span> <span class="n">page</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">page</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">page</span> <span class="o">&gt;</span> <span class="n">total_pages</span><span class="p">:</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">total_pages</span>
        <span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span>
        <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">total</span><span class="p">)</span>
        <span class="n">items</span> <span class="o">=</span> <span class="n">backups</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;📦 קבצי ZIP שמורים — סה&quot;&quot;כ: </span><span class="si">{total}</span><span class="se">\n</span><span class="s2">📄 עמוד </span><span class="si">{page}</span><span class="s2"> מתוך </span><span class="si">{total_pages}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># חישוב גרסאות vN לפי ריפו</span>
        <span class="n">repo_to_sorted</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">id_to_version</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span> <span class="k">as</span> <span class="n">_dt</span>
            <span class="k">def</span> <span class="nf">_key</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s1">&#39;created_at&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">dt</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="mf">0.0</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">backups</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s1">&#39;repo&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">repo_to_sorted</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">repo_to_sorted</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">arr</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">_key</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">id_to_version</span><span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s1">&#39;backup_id&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">idx</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">id_to_version</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="n">when</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">created_at</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/%m/%Y %H:%M&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s1">&#39;created_at&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="c1"># קבע primary: שם ריפו ללא owner עבור github_repo_zip אחרת backup_id</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s1">&#39;backup_type&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;github_repo_zip&#39;</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s1">&#39;repo&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">primary</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">repo</span> <span class="k">else</span> <span class="n">info</span><span class="o">.</span><span class="n">repo</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">primary</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s1">&#39;repo&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">primary</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s1">&#39;backup_id&#39;</span><span class="p">,</span> <span class="s1">&#39;full&#39;</span><span class="p">)</span>
            <span class="n">vnum</span> <span class="o">=</span> <span class="n">id_to_version</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s1">&#39;backup_id&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">vtxt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; v</span><span class="si">{</span><span class="n">vnum</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">vnum</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="c1"># שלוף דירוג אם קיים</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>
                <span class="n">rating</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_backup_rating</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">backup_id</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">rating</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">emoji</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="s2">&quot;🏆&quot;</span> <span class="ow">in</span> <span class="n">rating</span><span class="p">:</span>
                <span class="n">emoji</span> <span class="o">=</span> <span class="s2">&quot; 🏆&quot;</span>
            <span class="k">elif</span> <span class="s2">&quot;👍&quot;</span> <span class="ow">in</span> <span class="n">rating</span><span class="p">:</span>
                <span class="n">emoji</span> <span class="o">=</span> <span class="s2">&quot; 👍&quot;</span>
            <span class="k">elif</span> <span class="s2">&quot;🤷&quot;</span> <span class="ow">in</span> <span class="n">rating</span><span class="p">:</span>
                <span class="n">emoji</span> <span class="o">=</span> <span class="s2">&quot; 🤷&quot;</span>
            <span class="n">btn_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;BKP zip </span><span class="si">{</span><span class="n">primary</span><span class="si">}{</span><span class="n">vtxt</span><span class="si">}{</span><span class="n">emoji</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">when</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="c1"># שורת מידע</span>
            <span class="n">size_text</span> <span class="o">=</span> <span class="n">_format_bytes</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s1">&#39;total_size&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">count_text</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s1">&#39;file_count&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;• </span><span class="si">{</span><span class="n">btn_text</span><span class="si">}</span><span class="s2"> — </span><span class="si">{</span><span class="n">size_text</span><span class="si">}</span><span class="s2"> — </span><span class="si">{</span><span class="n">count_text</span><span class="si">}</span><span class="s2"> קבצים&quot;</span><span class="p">)</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
                <span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">btn_text</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">btn_text</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">64</span> <span class="k">else</span> <span class="n">btn_text</span><span class="p">[:</span><span class="mi">60</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;…&#39;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;batch_zip_use_for_batch:</span><span class="si">{</span><span class="n">info</span><span class="o">.</span><span class="n">backup_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="p">])</span>

        <span class="n">nav</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">page</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;⬅️ הקודם&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;batch_zip_page_</span><span class="si">{</span><span class="n">page</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">page</span> <span class="o">&lt;</span> <span class="n">total_pages</span><span class="p">:</span>
            <span class="n">nav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;➡️ הבא&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;batch_zip_page_</span><span class="si">{</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">nav</span><span class="p">:</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nav</span><span class="p">)</span>

        <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;batch_menu&quot;</span><span class="p">)])</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ שגיאה בטעינת רשימת ZIPs&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span></div>


<div class="viewcode-block" id="show_batch_actions_menu">
<a class="viewcode-back" href="../api/conversation_handlers.html#conversation_handlers.show_batch_actions_menu">[תיעוד]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">show_batch_actions_menu</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;תפריט פעולות לאחר בחירת קטגוריה/ריפו&quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>
    <span class="n">selected</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;batch_selected_files&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected</span><span class="p">)</span>
    <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📊 ניתוח (Analyze)&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;batch_action:analyze&quot;</span><span class="p">)],</span>
        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;✅ בדיקת תקינות (Validate)&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;batch_action:validate&quot;</span><span class="p">)],</span>
        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔙 חזור לבחירת קבצים&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;batch_back_to_files&quot;</span><span class="p">)],</span>
        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🏁 חזרה לתפריט Batch&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;batch_menu&quot;</span><span class="p">)],</span>
    <span class="p">]</span>
    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;בחר/י פעולה שתתבצע על הקבצים הנבחרים:</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;נבחרו: &lt;b&gt;</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2">&lt;/b&gt; קבצים&quot;</span> <span class="k">if</span> <span class="n">count</span> <span class="k">else</span> <span class="s2">&quot;לא נבחרו קבצים — ניתן לבחור הכל או קובץ בודד&quot;</span><span class="p">),</span>
        <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">),</span>
        <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span></div>


<div class="viewcode-block" id="execute_batch_on_current_selection">
<a class="viewcode-back" href="../api/conversation_handlers.html#conversation_handlers.execute_batch_on_current_selection">[תיעוד]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">execute_batch_on_current_selection</span><span class="p">(</span><span class="n">update</span><span class="p">:</span> <span class="n">Update</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ContextTypes</span><span class="o">.</span><span class="n">DEFAULT_TYPE</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;מבצע את פעולת ה-Batch על קבוצת היעד שנבחרה&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span>
    <span class="kn">from</span> <span class="nn">batch_processor</span> <span class="kn">import</span> <span class="n">batch_processor</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">callback_query</span>
    <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">effective_user</span><span class="o">.</span><span class="n">id</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;batch_target&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="n">files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># אם יש בחירה מפורשת של קבצים, השתמש בה</span>
        <span class="n">explicit</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;batch_selected_files&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">explicit</span><span class="p">:</span>
            <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">explicit</span> <span class="k">if</span> <span class="n">f</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="s1">&#39;repo&#39;</span><span class="p">:</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tag&#39;</span><span class="p">)</span>
                <span class="n">items</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">search_code</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="k">if</span> <span class="n">tag</span> <span class="k">else</span> <span class="p">[],</span> <span class="n">limit</span><span class="o">=</span><span class="mi">2000</span><span class="p">)</span>
                <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">items</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">)]</span>
            <span class="k">elif</span> <span class="n">t</span> <span class="o">==</span> <span class="s1">&#39;zips&#39;</span><span class="p">:</span>
                <span class="c1"># ZIPs אינם קבצי קוד; כבר בשלב הבחירה הוצגו הקבצים הרגילים</span>
                <span class="n">items</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user_files</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">items</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">)]</span>
            <span class="k">elif</span> <span class="n">t</span> <span class="o">==</span> <span class="s1">&#39;large&#39;</span><span class="p">:</span>
                <span class="c1"># שלוף רק קבצים גדולים</span>
                <span class="n">large_files</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user_large_files</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">per_page</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
                <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">large_files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">)]</span>
            <span class="k">elif</span> <span class="n">t</span> <span class="o">==</span> <span class="s1">&#39;other&#39;</span><span class="p">:</span>
                <span class="c1"># קבצים רגילים שאין להם תגית repo:</span>
                <span class="n">items</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user_files</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">items</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">((</span><span class="n">t</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;repo:&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]))]</span>
                <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">items</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># ברירת מחדל: כל הקבצים רגילים</span>
                <span class="n">items</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user_files</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">items</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">)]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ לא נמצאו קבצים בקבוצה שנבחרה&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span>

        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;analyze&#39;</span><span class="p">:</span>
            <span class="n">job_id</span> <span class="o">=</span> <span class="k">await</span> <span class="n">batch_processor</span><span class="o">.</span><span class="n">analyze_files_batch</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">files</span><span class="p">)</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;⚡ ניתוח Batch התחיל!&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">job_id</span> <span class="o">=</span> <span class="k">await</span> <span class="n">batch_processor</span><span class="o">.</span><span class="n">validate_files_batch</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">files</span><span class="p">)</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;✅ בדיקת תקינות Batch התחילה!&quot;</span>

        <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📊 בדוק סטטוס&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;job_status:</span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)]]</span>
        <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">📁 קבצים: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">🆔 Job ID: &lt;code&gt;</span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2">&lt;/code&gt;&quot;</span><span class="p">,</span>
            <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">,</span>
            <span class="n">reply_markup</span><span class="o">=</span><span class="n">reply_markup</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error executing batch: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s2">&quot;❌ שגיאה בהפעלת Batch&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ConversationHandler</span><span class="o">.</span><span class="n">END</span></div>


<span class="k">async</span> <span class="k">def</span> <span class="nf">_auto_update_batch_status</span><span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="n">chat_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">message_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">batch_processor</span> <span class="kn">import</span> <span class="n">batch_processor</span>
    <span class="kn">from</span> <span class="nn">telegram.constants</span> <span class="kn">import</span> <span class="n">ParseMode</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">150</span><span class="p">):</span>  <span class="c1"># עד ~5 דקות, כל 2 שניות</span>
            <span class="n">job</span> <span class="o">=</span> <span class="n">batch_processor</span><span class="o">.</span><span class="n">get_job_status</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">job</span> <span class="ow">or</span> <span class="n">job</span><span class="o">.</span><span class="n">user_id</span> <span class="o">!=</span> <span class="n">user_id</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">summary</span> <span class="o">=</span> <span class="n">batch_processor</span><span class="o">.</span><span class="n">format_job_summary</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
            <span class="n">keyboard</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;completed&quot;</span><span class="p">:</span>
                <span class="n">keyboard</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;📋 הצג תוצאות&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;job_results:</span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
                <span class="k">await</span> <span class="n">application</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                    <span class="n">chat_id</span><span class="o">=</span><span class="n">chat_id</span><span class="p">,</span>
                    <span class="n">message_id</span><span class="o">=</span><span class="n">message_id</span><span class="p">,</span>
                    <span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;📊 &lt;b&gt;סטטוס עבודת Batch&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">🆔 &lt;code&gt;</span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">🔧 &lt;b&gt;פעולה:&lt;/b&gt; </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">operation</span><span class="si">}</span><span class="se">\n\n</span><span class="si">{</span><span class="n">summary</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">application</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span>
                    <span class="n">chat_id</span><span class="o">=</span><span class="n">chat_id</span><span class="p">,</span>
                    <span class="n">message_id</span><span class="o">=</span><span class="n">message_id</span><span class="p">,</span>
                    <span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;📊 &lt;b&gt;סטטוס עבודת Batch&lt;/b&gt;</span><span class="se">\n\n</span><span class="s2">🆔 &lt;code&gt;</span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2">&lt;/code&gt;</span><span class="se">\n</span><span class="s2">🔧 &lt;b&gt;פעולה:&lt;/b&gt; </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">operation</span><span class="si">}</span><span class="se">\n\n</span><span class="si">{</span><span class="n">summary</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">parse_mode</span><span class="o">=</span><span class="n">ParseMode</span><span class="o">.</span><span class="n">HTML</span><span class="p">,</span>
                    <span class="n">reply_markup</span><span class="o">=</span><span class="n">InlineKeyboardMarkup</span><span class="p">([[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="s2">&quot;🔄 רענן&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;job_status:</span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)]])</span>
                <span class="p">)</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Development Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>