מדריך מהיר: מנוע כללים ויזואלי
================================

.. note::
   פיצ'ר זה זמין רק למשתמשי אדמין.

מה זה?
------

מנוע הכללים הויזואלי מאפשר ליצור התראות חכמות בלי לכתוב קוד.
בונים כלל פשוט: "**אם** קורה X, **אז** עשה Y".

גישה למסך
---------

1. היכנסו ל-WebApp
2. נווטו ל: **Admin → Visual Rules** (או ``/admin/rules``)

יצירת כלל ב-3 צעדים
--------------------

**צעד 1: תנו שם לכלל**

.. code-block:: text

   שם: "התראה על שגיאות בפרודקשן"
   תיאור: "שולח הודעה כשיש שגיאה קריטית בסביבת production"

**צעד 2: הגדירו תנאים**

לחצו **"+ תנאי"** והגדירו:

+------------------+------------+--------------+
| שדה              | אופרטור    | ערך          |
+==================+============+==============+
| environment      | שווה       | production   |
+------------------+------------+--------------+
| severity         | שווה       | critical     |
+------------------+------------+--------------+

רוצים ששני התנאים יתקיימו יחד? השתמשו בקבוצת **AND**.

**צעד 3: בחרו פעולה**

לחצו **"+ פעולה"** ובחרו:

- **suppress** - להשתיק התראות (לא לשלוח)
- **send_alert** - לשלוח התראה לטלגרם
- **create_github_issue** - לפתוח Issue בגיטהאב
- **webhook** - לשלוח לשירות חיצוני

דוגמאות נפוצות
---------------

השתקת התראות מסביבת פיתוח
^^^^^^^^^^^^^^^^^^^^^^^^^^^

**מטרה:** לא לקבל התראות מ-development

+-------------+----------+-------------+
| שדה         | אופרטור  | ערך         |
+=============+==========+=============+
| environment | שווה     | development |
+-------------+----------+-------------+

**פעולה:** suppress

פתיחת Issue על שגיאות חדשות
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

**מטרה:** לפתוח Issue בגיטהאב כשמזוהה שגיאה חדשה

+---------------+----------+--------------+
| שדה           | אופרטור  | ערך          |
+===============+==========+==============+
| alert_type    | שווה     | sentry_issue |
+---------------+----------+--------------+
| is_new_error  | שווה     | True         |
+---------------+----------+--------------+

**פעולה:** create_github_issue

התראה מחוץ לשעות עבודה
^^^^^^^^^^^^^^^^^^^^^^^^^

**מטרה:** לקבל התראה רק כשאני לא במשרד (לפני 8 או אחרי 18)

השתמשו בקבוצת **OR**:

+-------------+----------+------+
| שדה         | אופרטור  | ערך  |
+=============+==========+======+
| hour_of_day | קטן מ-   | 8    |
+-------------+----------+------+
| hour_of_day | גדול מ-  | 18   |
+-------------+----------+------+

**פעולה:** send_alert

בדיקת כלל לפני שמירה
---------------------

1. לחצו על **"בדוק כלל"** 🧪
2. הזינו נתוני בדיקה ב-JSON
3. לחצו **"הרץ בדיקה"**
4. אם מופיע ✅ - הכלל עובד!

.. tip::
   הסימולטור לא שולח התראות אמיתיות - בטוח לבדוק.

אופרטורים זמינים
-----------------

+---------------+-----------------+---------------------------+
| אופרטור       | תיאור           | דוגמה                     |
+===============+=================+===========================+
| eq            | שווה            | severity = critical       |
+---------------+-----------------+---------------------------+
| ne            | לא שווה         | environment ≠ test        |
+---------------+-----------------+---------------------------+
| gt / lt       | גדול/קטן מ-     | error_rate > 0.05         |
+---------------+-----------------+---------------------------+
| contains      | מכיל טקסט       | message מכיל "timeout"    |
+---------------+-----------------+---------------------------+
| starts_with   | מתחיל ב-        | project מתחיל ב-"api-"    |
+---------------+-----------------+---------------------------+
| regex         | ביטוי רגולרי    | חיפוש מתקדם               |
+---------------+-----------------+---------------------------+
| in            | ברשימה          | severity ב-[critical,high]|
+---------------+-----------------+---------------------------+

שדות נפוצים
-----------

**שדות בסיסיים:**

- ``severity`` - רמת חומרה (info/warning/critical)
- ``environment`` - סביבה (production/staging/development)
- ``project`` - שם הפרויקט
- ``alert_type`` - סוג ההתראה

**שדות שגיאה:**

- ``is_new_error`` - האם זו שגיאה חדשה (true/false)
- ``error_message`` - טקסט השגיאה
- ``occurrence_count`` - כמה פעמים קרה

**שדות זמן:**

- ``hour_of_day`` - שעה (0-23)
- ``day_of_week`` - יום בשבוע (0=ראשון, 6=שבת)

ניהול כללים
-----------

- **הפעלה/כיבוי:** לחצו על המתג ליד הכלל
- **עריכה:** לחצו "ערוך" בטבלת הכללים
- **מחיקה:** לחצו "מחק" ואשרו

פתרון בעיות
-----------

**"הכלל לא עובד"**

- ודאו שהכלל **פעיל** (מתג ירוק)
- בדקו בסימולטור אם התנאים מתאימים

**"webhook נחסם"**

- webhooks לא יכולים לפנות לכתובות פנימיות
- השתמשו ב-URL ציבורי

**"Issue לא נפתח"**

- ודאו שמוגדר GITHUB_TOKEN עם הרשאת repo
- בדקו אם כבר קיים Issue עם אותה כותרת

קישורים
--------

- :doc:`visual-rule-engine` - תיעוד מלא
- :doc:`environment-variables` - משתני סביבה
- :doc:`alerts` - מערכת ההתראות
